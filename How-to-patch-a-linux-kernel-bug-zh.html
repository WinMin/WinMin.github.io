<!DOCTYPE html>
<html lang="EN">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>如何给 Linux 内核提交补丁：一次真实的踩坑记录 | Swing&#39;Blog 浮生若梦</title>


<meta name="description" content="Know it then hack it!">


<meta name="author" content="Swing">



<!-- Canonical -->
<link rel="canonical" href="/How-to-patch-a-linux-kernel-bug-zh.html">

<!-- Favicon -->
<link rel="icon" href="/images/favicon.ico">

<!-- RSS -->

<link rel="alternate" type="application/rss+xml" title="Swing&#39;Blog 浮生若梦" href="/atom.xml">


<!-- Open Graph -->
<meta property="og:type" content="article">
<meta property="og:title" content="如何给 Linux 内核提交补丁：一次真实的踩坑记录">
<meta property="og:url" content="/How-to-patch-a-linux-kernel-bug-zh.html">
<meta property="og:site_name" content="Swing&#39;Blog 浮生若梦">

<meta property="og:description" content="Know it then hack it!">


<!-- Twitter Card -->
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="如何给 Linux 内核提交补丁：一次真实的踩坑记录">

<meta name="twitter:description" content="Know it then hack it!">


<!-- Theme Color -->
<meta name="theme-color" content="#1d1f21">
<meta name="msapplication-TileColor" content="#1d1f21">

<!-- Stylesheets -->

<link rel="stylesheet" href="/css/style.css">


<!-- Custom Layout Variables -->

<style>
:root {
  --page-width: 60rem;
  --content-width: 1200px;
  --mobile-padding: 12px;
}
</style>

<!-- Analytics -->


<meta name="generator" content="Hexo 5.4.2"></head>
<body class="theme-dark">
  <div class="container">
    <header class="header">
  <div class="header-inner">
    <div class="header-brand">
      
        <a href="/" class="logo">
          <img src="/images/logo.png"
               width="50"
               height="50"
               alt="Swing&#39;Blog 浮生若梦">
        </a>
      
      <a href="/" class="site-title">
        Swing&#39;Blog 浮生若梦
      </a>
    </div>

    <nav class="nav">
      <button class="nav-toggle" id="nav-toggle" aria-label="Toggle navigation">
        <span class="nav-toggle-bar"></span>
        <span class="nav-toggle-bar"></span>
        <span class="nav-toggle-bar"></span>
      </button>

      <ul class="nav-menu" id="nav-menu">
        
          
          
            
            <li class="nav-item">
              <a href="/"
                 class="nav-link"
                 >
                Home
              </a>
            </li>
            
              <li class="nav-divider">|</li>
            
          
            
            <li class="nav-item">
              <a href="/about/"
                 class="nav-link"
                 >
                About
              </a>
            </li>
            
              <li class="nav-divider">|</li>
            
          
            
            <li class="nav-item">
              <a href="/archives/"
                 class="nav-link"
                 >
                Articles
              </a>
            </li>
            
              <li class="nav-divider">|</li>
            
          
            
            <li class="nav-item">
              <a href="/atom.xml"
                 class="nav-link"
                 >
                RSS
              </a>
            </li>
            
              <li class="nav-divider">|</li>
            
          
            
            <li class="nav-item">
              <a href="/categories/"
                 class="nav-link"
                 >
                Categories
              </a>
            </li>
            
              <li class="nav-divider">|</li>
            
          
            
            <li class="nav-item">
              <a href="/link"
                 class="nav-link"
                 >
                Links
              </a>
            </li>
            
          
        
      </ul>
    </nav>
  </div>
</header>


    <main class="main">
      
        <div class="page-layout">
          <article class="post">
  <header class="post-header">
  <h1 class="post-title">如何给 Linux 内核提交补丁：一次真实的踩坑记录</h1>

  <div class="post-meta">
    <span class="meta-item">
      <svg viewBox="0 0 24 24" width="14" height="14"><path fill="currentColor" d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11zM9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/></svg>
      <time datetime="2026-02-01">
        2026-02-01
      </time>
    </span>

    

    
      <span class="meta-item">
        <svg viewBox="0 0 24 24" width="14" height="14"><path fill="currentColor" d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
        
          <a href="/categories/%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91/">内核开发</a>, 
        
          <a href="/categories/%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/">安全研究</a>
        
      </span>
    
  </div>
</header>


  
    <nav class="toc">
  <h3 class="toc-title">Table of Contents</h3>
  <div class="toc-list">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-text">背景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E4%B8%80%E4%B8%8B%E5%B4%A9%E6%BA%83%E5%81%8F%E7%A7%BB"><span class="toc-text">分析一下崩溃偏移</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">第一步：环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%8B%E9%9A%86%E6%AD%A3%E7%A1%AE%E7%9A%84%E4%BB%93%E5%BA%93"><span class="toc-text">克隆正确的仓库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Git-%E9%82%AE%E4%BB%B6"><span class="toc-text">配置 Git 邮件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E7%94%A8-Mutt%EF%BC%9F"><span class="toc-text">为什么用 Mutt？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E5%86%99%E4%BF%AE%E5%A4%8D%E4%BB%A3%E7%A0%81"><span class="toc-text">第二步：写修复代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E6%B5%8B%E8%AF%95"><span class="toc-text">第三步：测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E8%87%AA%E6%B5%8B%E6%B8%85%E5%8D%95"><span class="toc-text">第四步：自测清单</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E9%A3%8E%E6%A0%BC"><span class="toc-text">代码风格</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E9%85%8D%E7%BD%AE%E7%BC%96%E8%AF%91"><span class="toc-text">多配置编译</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%B5%8B%E8%AF%95"><span class="toc-text">启动测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E4%BF%AE%E5%A4%8D"><span class="toc-text">验证修复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%91-selftests"><span class="toc-text">跑 selftests</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%BC%E5%86%99%E6%A3%80%E6%9F%A5"><span class="toc-text">拼写检查</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E6%AD%A5%EF%BC%9A%E5%86%99%E6%8F%90%E4%BA%A4%E4%BF%A1%E6%81%AF"><span class="toc-text">第五步：写提交信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%A0%E4%B8%AA%E8%A6%81%E7%82%B9"><span class="toc-text">几个要点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E6%A0%88%E6%80%8E%E4%B9%88%E5%86%99"><span class="toc-text">调用栈怎么写</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E6%AD%A5%EF%BC%9A%E7%94%9F%E6%88%90%E5%92%8C%E5%8F%91%E9%80%81%E8%A1%A5%E4%B8%81"><span class="toc-text">第六步：生成和发送补丁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E5%9D%91%EF%BC%9Asecurity-kernel-org"><span class="toc-text">一个坑：security@kernel.org</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E6%AD%A5%EF%BC%9A%E5%A4%84%E7%90%86%E5%8F%8D%E9%A6%88"><span class="toc-text">第七步：处理反馈</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E6%AD%A5%EF%BC%9A%E7%94%B3%E8%AF%B7-CVE"><span class="toc-text">第八步：申请 CVE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%88%91%E8%B8%A9%E8%BF%87%E7%9A%84%E5%9D%91"><span class="toc-text">我踩过的坑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E7%BA%BF"><span class="toc-text">时间线</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-text">小结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-text">参考资料</span></a></li></ol>
  </div>
</nav>

  

  <div class="post-content">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h1 id="如何给-Linux-内核提交补丁：一次真实的踩坑记录"><a href="#如何给-Linux-内核提交补丁：一次真实的踩坑记录" class="headerlink" title="如何给 Linux 内核提交补丁：一次真实的踩坑记录"></a>如何给 Linux 内核提交补丁：一次真实的踩坑记录</h1><p>最近给 Linux 内核提交了一个补丁，修复 <code>skbuff_fclone_cache</code> 的 usercopy 问题，过程中踩了不少坑。这篇文章记录一下整个流程，希望能帮到想给内核提补丁的朋友。</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>事情是这样的，我和@n132之前，发现了一个内核 panic，在启用 <code>CONFIG_HARDENED_USERCOPY</code> 的时候会触发。</p>
<p>问题出在 <code>skbuff_fclone_cache</code> 这个 slab 缓存创建的时候没有定义 usercopy 区域，但是 <code>skbuff_head_cache</code> 是有的。这就导致内核在尝试把 <code>sk_buff.cb</code> 的数据拷贝到用户空间的时候会 BUG()。</p>
<p>崩溃的调用链大概是这样：</p>
<ol>
<li>TCP 用 <code>alloc_skb_fclone()</code> 分配 skb</li>
<li><code>skb_clone()</code> 克隆这个 skb</li>
<li>克隆的 skb 被放到 <code>sk_error_queue</code></li>
<li>用户空间调用 <code>recvmsg(MSG_ERRQUEUE)</code> 读错误队列</li>
<li><code>sock_recv_errqueue()</code> 调用 <code>put_cmsg()</code> 拷贝数据</li>
<li>然后就炸了，<code>__check_heap_object()</code> 检查失败</li>
</ol>
<p>崩溃日志长这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">usercopy: Kernel memory exposure attempt detected from SLUB object &#39;skbuff_fclone_cache&#39; (offset 296, size 16)!</span><br><span class="line">kernel BUG at mm&#x2F;usercopy.c:102!</span><br></pre></td></tr></table></figure>

<p>这个 bug 后来被分配了 <a href="https://vulert.com/vuln-db/net--sock--fix-hardened-usercopy-panic-in-sock-recv-errqueue">CVE-2026-22977</a>。</p>
<h3 id="分析一下崩溃偏移"><a href="#分析一下崩溃偏移" class="headerlink" title="分析一下崩溃偏移"></a>分析一下崩溃偏移</h3><p>崩溃信息里说 <code>offset 296, size 16</code>，我们来算一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sizeof(struct sk_buff) &#x3D; 232</span><br><span class="line">offsetof(struct sk_buff, cb) &#x3D; 40</span><br><span class="line"></span><br><span class="line">sk_buff_fclones 里面：</span><br><span class="line">- skb1 从 0 开始</span><br><span class="line">- skb2 从 232 开始</span><br><span class="line"></span><br><span class="line">所以 skb2.cb 的偏移 &#x3D; 232 + 40 &#x3D; 272</span><br><span class="line">崩溃偏移 296 &#x3D; 272 + 24，刚好在 sock_exterr_skb.ee 里面</span><br></pre></td></tr></table></figure>

<p>这就确认了问题确实出在克隆 skb 的 <code>cb</code> 字段。</p>
<h2 id="第一步：环境准备"><a href="#第一步：环境准备" class="headerlink" title="第一步：环境准备"></a>第一步：环境准备</h2><h3 id="克隆正确的仓库"><a href="#克隆正确的仓库" class="headerlink" title="克隆正确的仓库"></a>克隆正确的仓库</h3><p>这里有个坑，<strong>不要直接克隆 Linus 的主仓库</strong>！要根据你的补丁类型选择对应的子系统仓库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 网络相关的 bug 修复，用这个：</span></span><br><span class="line">git <span class="built_in">clone</span> https://git.kernel.org/pub/scm/linux/kernel/git/netdev/net.git</span><br><span class="line"><span class="built_in">cd</span> net</span><br><span class="line"></span><br><span class="line"><span class="comment"># 网络相关的新功能，用这个：</span></span><br><span class="line">git <span class="built_in">clone</span> https://git.kernel.org/pub/scm/linux/kernel/git/netdev/net-next.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 其他通用的：</span></span><br><span class="line">git <span class="built_in">clone</span> https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>仓库</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td><code>net.git</code></td>
<td>当前版本的 bug 修复</td>
</tr>
<tr>
<td><code>net-next.git</code></td>
<td>下一版本的新功能</td>
</tr>
<tr>
<td><code>linux.git</code></td>
<td>通用开发</td>
</tr>
</tbody></table>
<p>我这个是 bug 修复，应该用 <code>net.git</code>。</p>
<h3 id="配置-Git-邮件"><a href="#配置-Git-邮件" class="headerlink" title="配置 Git 邮件"></a>配置 Git 邮件</h3><p>编辑 <code>~/.gitconfig</code>：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[user]</span></span><br><span class="line">    <span class="attr">name</span> = Weiming Shi</span><br><span class="line">    <span class="attr">email</span> = bestswngs@gmail.com</span><br><span class="line"></span><br><span class="line"><span class="section">[sendemail]</span></span><br><span class="line">    <span class="attr">smtpserver</span> = smtp.gmail.com</span><br><span class="line">    <span class="attr">smtpserverport</span> = <span class="number">587</span></span><br><span class="line">    <span class="attr">smtpencryption</span> = tls</span><br><span class="line">    <span class="attr">smtpuser</span> = bestswngs@gmail.com</span><br></pre></td></tr></table></figure>

<p>用 Gmail 的话需要去 Google 账户安全设置里生成一个应用专用密码。</p>
<h3 id="为什么用-Mutt？"><a href="#为什么用-Mutt？" class="headerlink" title="为什么用 Mutt？"></a>为什么用 Mutt？</h3><p>这里要特别说一下，<strong>千万不要用 Gmail 网页版发补丁</strong>！</p>
<p>Gmail 网页版会：</p>
<ul>
<li>把纯文本转成 HTML</li>
<li>自动换行，直接把补丁搞坏</li>
<li>把 Tab 换成空格</li>
<li>各种编码问题</li>
</ul>
<p>内核要求纯文本邮件，补丁要内联在邮件里（不是附件）。推荐的组合是：</p>
<ul>
<li><strong><code>git send-email</code></strong> 发补丁</li>
<li><strong><code>mutt</code></strong> 看维护者回复</li>
</ul>
<p>Mutt 配置 <code>~/.muttrc</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">set realname &#x3D; &quot;Weiming Shi&quot;</span><br><span class="line">set from &#x3D; &quot;bestswngs@gmail.com&quot;</span><br><span class="line">set use_from &#x3D; yes</span><br><span class="line">set envelope_from &#x3D; yes</span><br><span class="line"></span><br><span class="line">set my_user &#x3D; &quot;bestswngs@gmail.com&quot;</span><br><span class="line">set my_pass &#x3D; &quot;xxxx xxxx xxxx xxxx&quot;  # 应用专用密码</span><br><span class="line"></span><br><span class="line">set imap_user &#x3D; $my_user</span><br><span class="line">set imap_pass &#x3D; $my_pass</span><br><span class="line">set folder &#x3D; &quot;imaps:&#x2F;&#x2F;imap.gmail.com:993&quot;</span><br><span class="line">set spoolfile &#x3D; &quot;+INBOX&quot;</span><br><span class="line"></span><br><span class="line">set smtp_url &#x3D; &quot;smtps:&#x2F;&#x2F;$my_user:$my_pass@smtp.gmail.com:465&#x2F;&quot;</span><br><span class="line">set ssl_force_tls &#x3D; yes</span><br><span class="line"></span><br><span class="line">set postponed &#x3D; &quot;+[Gmail]&#x2F;Drafts&quot;</span><br><span class="line">set record &#x3D; &quot;+[Gmail]&#x2F;Sent Mail&quot;</span><br><span class="line"></span><br><span class="line">set header_cache &#x3D; ~&#x2F;.mutt&#x2F;cache&#x2F;headers</span><br><span class="line">set message_cachedir &#x3D; ~&#x2F;.mutt&#x2F;cache&#x2F;bodies</span><br><span class="line">set certificate_file &#x3D; ~&#x2F;.mutt&#x2F;certificates</span><br></pre></td></tr></table></figure>

<h2 id="第二步：写修复代码"><a href="#第二步：写修复代码" class="headerlink" title="第二步：写修复代码"></a>第二步：写修复代码</h2><p>创建工作分支：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b fix-skbuff-fclone-usercopy</span><br></pre></td></tr></table></figure>

<p>修复其实很简单，把 <code>kmem_cache_create()</code> 换成 <code>kmem_cache_create_usercopy()</code>：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">-	net_hotdata.skbuff_fclone_cache = kmem_cache_create(&quot;skbuff_fclone_cache&quot;,</span></span><br><span class="line"><span class="addition">+	net_hotdata.skbuff_fclone_cache = kmem_cache_create_usercopy(&quot;skbuff_fclone_cache&quot;,</span></span><br><span class="line"> 						sizeof(struct sk_buff_fclones),</span><br><span class="line"> 						0,</span><br><span class="line"> 						SLAB_HWCACHE_ALIGN|SLAB_PANIC,</span><br><span class="line"><span class="addition">+						offsetof(struct sk_buff, cb),</span></span><br><span class="line"><span class="addition">+						sizeof(struct sk_buff) + sizeof_field(struct sk_buff, cb),</span></span><br><span class="line"> 						NULL);</span><br></pre></td></tr></table></figure>

<h2 id="第三步：测试"><a href="#第三步：测试" class="headerlink" title="第三步：测试"></a>第三步：测试</h2><p>编译：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig  <span class="comment"># 启用 CONFIG_HARDENED_USERCOPY=y</span></span><br><span class="line">make -j$(nproc)</span><br></pre></td></tr></table></figure>

<p>测试的话推荐用 <code>virtme-ng</code>，比手动搞 initramfs 方便太多了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">sudo apt install qemu-system-x86 qemu-kvm</span><br><span class="line">pip install virtme-ng</span><br><span class="line"></span><br><span class="line"><span class="comment"># 直接启动，不用 initramfs</span></span><br><span class="line">vng --build --run</span><br><span class="line"></span><br><span class="line"><span class="comment"># 跑 PoC 验证</span></span><br><span class="line">vng --build --run -- ./poc_put_cmsg</span><br></pre></td></tr></table></figure>

<h2 id="第四步：自测清单"><a href="#第四步：自测清单" class="headerlink" title="第四步：自测清单"></a>第四步：自测清单</h2><p>发补丁之前一定要过一遍这个清单，我就是因为跳过了编译测试，结果收到了 kernel test robot 的构建失败邮件，很尴尬。</p>
<h3 id="代码风格"><a href="#代码风格" class="headerlink" title="代码风格"></a>代码风格</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./scripts/checkpatch.pl --strict 0001-your-patch.patch</span><br></pre></td></tr></table></figure>

<p>常见问题：行太长、缩进用了空格（应该用 Tab）、行尾有空白。</p>
<h3 id="多配置编译"><a href="#多配置编译" class="headerlink" title="多配置编译"></a>多配置编译</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make defconfig &amp;&amp; make -j$(nproc)</span><br><span class="line">make allyesconfig &amp;&amp; make -j$(nproc)</span><br></pre></td></tr></table></figure>

<h3 id="启动测试"><a href="#启动测试" class="headerlink" title="启动测试"></a>启动测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vng --build --run</span><br></pre></td></tr></table></figure>

<h3 id="验证修复"><a href="#验证修复" class="headerlink" title="验证修复"></a>验证修复</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./poc_put_cmsg</span><br><span class="line">dmesg | grep -i <span class="string">&quot;usercopy\|BUG\|panic&quot;</span></span><br></pre></td></tr></table></figure>

<p>打补丁前会 panic，打完应该没事了。</p>
<h3 id="跑-selftests"><a href="#跑-selftests" class="headerlink" title="跑 selftests"></a>跑 selftests</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -C tools/testing/selftests/net run_tests</span><br></pre></td></tr></table></figure>

<h3 id="拼写检查"><a href="#拼写检查" class="headerlink" title="拼写检查"></a>拼写检查</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codespell your-patch.patch</span><br></pre></td></tr></table></figure>

<h2 id="第五步：写提交信息"><a href="#第五步：写提交信息" class="headerlink" title="第五步：写提交信息"></a>第五步：写提交信息</h2><p>这是我踩坑最多的地方。</p>
<p>一个合格的提交信息长这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">net: skbuff: add usercopy region to skbuff_fclone_cache</span><br><span class="line"></span><br><span class="line">skbuff_fclone_cache was created without defining a usercopy region,</span><br><span class="line">unlike skbuff_head_cache which properly whitelists the cb[] field.</span><br><span class="line">This causes a usercopy BUG() when CONFIG_HARDENED_USERCOPY is enabled...</span><br><span class="line"></span><br><span class="line">[精简后的崩溃日志]</span><br><span class="line"></span><br><span class="line">Fix by using kmem_cache_create_usercopy() with the same cb[] region</span><br><span class="line">whitelist as skbuff_head_cache.</span><br><span class="line"></span><br><span class="line">Fixes: 6d07d1cd300f (&quot;usercopy: Restrict non-usercopy caches to size 0&quot;)</span><br><span class="line">Reported-by: Xiang Mei &lt;xmei5@asu.edu&gt;</span><br><span class="line">Signed-off-by: Weiming Shi &lt;bestswngs@gmail.com&gt;</span><br></pre></td></tr></table></figure>

<h3 id="几个要点"><a href="#几个要点" class="headerlink" title="几个要点"></a>几个要点</h3><ol>
<li><strong>标题格式</strong>：<code>子系统: 简短描述</code>，不超过 72 字符</li>
<li><strong>正文每行不超过 75 字符</strong>，这个很重要！可以用 vim 的 <code>:set cc=75</code> 画条线</li>
<li><strong>Fixes 标签</strong>：指向引入 bug 的那个提交</li>
<li><strong>Signed-off-by</strong>：你的名字和邮箱</li>
</ol>
<h3 id="调用栈怎么写"><a href="#调用栈怎么写" class="headerlink" title="调用栈怎么写"></a>调用栈怎么写</h3><p>Eric Dumazet 给我的反馈：</p>
<blockquote>
<p><em>“下次发调用栈之前，先跑一下 scripts/decode_stacktrace.sh 拿到有意义的符号。”</em></p>
</blockquote>
<p>所以要先处理一下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./scripts/decode_stacktrace.sh vmlinux &lt; raw_stack_trace.txt</span><br></pre></td></tr></table></figure>

<p>然后<strong>精简</strong>，不要把整个 dmesg 贴上去。删掉时间戳、寄存器 dump、模块列表，只保留错误信息和关键调用链：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">usercopy: Kernel memory exposure attempt detected from SLUB object</span><br><span class="line">&#39;skbuff_fclone_cache&#39; (offset 296, size 16)!</span><br><span class="line">kernel BUG at mm&#x2F;usercopy.c:102!</span><br><span class="line">Call Trace:</span><br><span class="line"> __check_heap_object</span><br><span class="line"> __check_object_size</span><br><span class="line"> put_cmsg</span><br><span class="line"> sock_recv_errqueue</span><br></pre></td></tr></table></figure>

<h2 id="第六步：生成和发送补丁"><a href="#第六步：生成和发送补丁" class="headerlink" title="第六步：生成和发送补丁"></a>第六步：生成和发送补丁</h2><p>生成补丁：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git format-patch -1 -v4 --subject-prefix=<span class="string">&quot;PATCH net&quot;</span></span><br></pre></td></tr></table></figure>

<p><code>-v4</code> 表示第 4 版。</p>
<p>检查一下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./scripts/checkpatch.pl *.patch</span><br></pre></td></tr></table></figure>

<p>找维护者：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./scripts/get_maintainer.pl net/core/skbuff.c</span><br></pre></td></tr></table></figure>

<p>发送：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git send-email \</span><br><span class="line">    --to=<span class="string">&quot;davem@davemloft.net&quot;</span> \</span><br><span class="line">    --to=<span class="string">&quot;edumazet@google.com&quot;</span> \</span><br><span class="line">    --to=<span class="string">&quot;kuba@kernel.org&quot;</span> \</span><br><span class="line">    --to=<span class="string">&quot;pabeni@redhat.com&quot;</span> \</span><br><span class="line">    --cc=<span class="string">&quot;netdev@vger.kernel.org&quot;</span> \</span><br><span class="line">    --cc=<span class="string">&quot;linux-kernel@vger.kernel.org&quot;</span> \</span><br><span class="line">    *.patch</span><br></pre></td></tr></table></figure>

<h3 id="一个坑：security-kernel-org"><a href="#一个坑：security-kernel-org" class="headerlink" title="一个坑：security@kernel.org"></a>一个坑：<code>security@kernel.org</code></h3><p>Eric Dumazet 还跟我说：</p>
<blockquote>
<p><em>“如果你已经在公开邮件列表上发了，就不要再抄送 <a href="mailto:&#115;&#x65;&#99;&#117;&#114;&#x69;&#116;&#121;&#64;&#107;&#x65;&#x72;&#x6e;&#101;&#x6c;&#x2e;&#111;&#x72;&#x67;">&#115;&#x65;&#99;&#117;&#114;&#x69;&#116;&#121;&#64;&#107;&#x65;&#x72;&#x6e;&#101;&#x6c;&#x2e;&#111;&#x72;&#x67;</a> 了，没用。”</em></p>
</blockquote>
<p>规则：</p>
<ul>
<li>私下披露 → 抄送 <code>security@kernel.org</code></li>
<li>已经公开 → 不要抄送</li>
</ul>
<h2 id="第七步：处理反馈"><a href="#第七步：处理反馈" class="headerlink" title="第七步：处理反馈"></a>第七步：处理反馈</h2><p>发完补丁会收到各种反馈：</p>
<ul>
<li><strong>Kernel Test Robot</strong>：自动构建测试，会告诉你编译有没有问题</li>
<li><strong>维护者</strong>：代码审查</li>
<li><strong>其他开发者</strong>：评论</li>
</ul>
<p>我的 v2 就收到了 robot 的构建失败报告，因为函数参数传错了。教训就是本地一定要先编译测试。</p>
<p>收到反馈后：</p>
<ul>
<li>不要在邮件里直接回复修复代码，发新版本</li>
<li>用 <code>-v3</code>、<code>-v4</code> 标记版本</li>
<li>在 <code>---</code> 下面加更新日志说明改了什么</li>
</ul>
<h2 id="第八步：申请-CVE"><a href="#第八步：申请-CVE" class="headerlink" title="第八步：申请 CVE"></a>第八步：申请 CVE</h2><p><strong>等补丁合并之后再说</strong>。</p>
<p>根据<a href="https://docs.kernel.org/process/cve.html">内核 CVE 文档</a>，未修复的问题不会分配 CVE，要等补丁进了 stable 树才行。</p>
<p>大多数情况下 CVE 会自动分配，内核 CVE 团队（Greg KH、Sasha Levin、Lee Jones）会审查每个进 stable 的补丁。如果他们觉得是安全问题就会自动分配 CVE，公告在 <a href="https://lore.kernel.org/linux-cve-announce/">linux-cve-announce</a>。</p>
<p>如果漏了，可以发邮件到 <code>cve@kernel.org</code>。注意这个地址<strong>只用于已合并的修复</strong>，未修复的安全问题发 <code>security@kernel.org</code>。</p>
<p>我这个补丁合并后被分配了 CVE-2026-22977。</p>
<h2 id="我踩过的坑"><a href="#我踩过的坑" class="headerlink" title="我踩过的坑"></a>我踩过的坑</h2><ol>
<li><strong>v1：提交信息格式全错</strong>，标题写成了 <code>Signed-off-by:</code>，离谱</li>
<li><strong>v2：漏了 From 头</strong>，<code>.gitconfig</code> 没配好</li>
<li><strong>v2：忘了抄送邮件列表</strong>，一定要跑 <code>get_maintainer.pl</code></li>
<li><strong>v3：代码写错了</strong>，偏移量算错，本地没测就发了</li>
<li><strong>v4：amend 了十几次</strong>，说明提交前应该检查更仔细</li>
<li><strong>调用栈没解码</strong>，被 Eric 提醒了</li>
<li>**不该抄送 security@**，已经公开了还抄送没意义</li>
</ol>
<h2 id="时间线"><a href="#时间线" class="headerlink" title="时间线"></a>时间线</h2><table>
<thead>
<tr>
<th>日期</th>
<th>版本</th>
<th>改动</th>
</tr>
</thead>
<tbody><tr>
<td>12月15日</td>
<td>v1</td>
<td>初次提交，格式全错</td>
</tr>
<tr>
<td>12月16日</td>
<td>v2</td>
<td>修了提交信息</td>
</tr>
<tr>
<td>12月16日</td>
<td>v3</td>
<td>加了 From 头，修了 CC/TO</td>
</tr>
<tr>
<td>12月16日</td>
<td>v4</td>
<td>修了代码</td>
</tr>
<tr>
<td>12月24日</td>
<td>v5</td>
<td>试了另一种方案</td>
</tr>
</tbody></table>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>发补丁前过一遍这个清单：</p>
<ul>
<li>克隆了正确的子系统仓库（net.git / net-next.git / linux.git）</li>
<li>代码能编译，多配置都试过</li>
<li>内核能启动，PoC 不再触发 bug</li>
<li><code>checkpatch.pl</code> 通过</li>
<li>提交信息格式对，每行 75 字符以内</li>
<li>调用栈用 <code>decode_stacktrace.sh</code> 解码过，精简过</li>
<li>有 Fixes 标签、Signed-off-by</li>
<li>用 <code>get_maintainer.pl</code> 找到了维护者</li>
<li>拼写检查过</li>
</ul>
<p>常用命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vng --build --run                              <span class="comment"># 快速测试</span></span><br><span class="line">./scripts/checkpatch.pl --strict *.patch       <span class="comment"># 风格检查</span></span><br><span class="line">./scripts/decode_stacktrace.sh vmlinux &lt; trace <span class="comment"># 解码调用栈</span></span><br><span class="line">git format-patch -1 -v2 --subject-prefix=<span class="string">&quot;PATCH net&quot;</span></span><br><span class="line">./scripts/get_maintainer.pl net/core/skbuff.c</span><br><span class="line">git send-email --to=xxx --cc=yyy *.patch</span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://www.kernel.org/doc/html/latest/process/submitting-patches.html">提交补丁文档</a></li>
<li><a href="https://www.kernel.org/doc/html/latest/process/email-clients.html">邮件客户端配置</a></li>
<li><a href="https://docs.kernel.org/process/cve.html">内核 CVE 流程</a></li>
<li><a href="https://elixir.bootlin.com/">Elixir Bootlin</a> - 带超链接的内核源码浏览</li>
<li><a href="https://lore.kernel.org/linux-cve-announce/">linux-cve-announce</a> - CVE 公告</li>
<li><a href="https://lkml.org/lkml/2025/12/20/364">我的 v2 被 robot 打回的邮件</a></li>
</ul>
<hr>
<p>最后，Eric Dumazet 在邮件里说了一句，那个时候看到这句话的时候还蛮开心的（毕竟小心翼翼搞补丁，还是半夜的时间）</p>
<blockquote>
<p><em>“Congratulations on your first linux contribution!”</em></p>
</blockquote>
<p>从发现 bug 到补丁被合并（commit <code>f9ac7befe5f1</code>），这个过程学到的东西比看任何教程都多，实践了才有体会，另外感谢 @n132手把手的教我</p>
</div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {
        var options = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);
        }</script>
</div>


  <footer class="post-footer">
  
    <div class="post-categories">
      <span class="meta-label">分类: </span>
      
        <a href="/categories/%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91/" class="category">内核开发</a>
      
        <a href="/categories/%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/" class="category">安全研究</a>
      
    </div>
  
  
    <div class="post-tags">
      <span class="meta-label">标签: </span>
      
        <a href="/tags/linux-kernel/" class="tag">linux-kernel</a>
      
        <a href="/tags/security/" class="tag">security</a>
      
        <a href="/tags/CVE-2026-22977/" class="tag">CVE-2026-22977</a>
      
        <a href="/tags/skbuff/" class="tag">skbuff</a>
      
        <a href="/tags/usercopy/" class="tag">usercopy</a>
      
    </div>
  
</footer>


  
<nav class="post-nav">
  

  
    <div class="post-nav-item next">
      <span class="post-nav-label">Next &rarr;</span>
      <a href="/TP-Link_WR841N_router_%20%20CVE-2023-50224%20and%20CVE-2025-9377.html" class="post-nav-title">
        TP-Link WR841N router  CVE-2023-50224 and CVE-2025-9377
      </a>
    </div>
  
</nav>



  
</article>

        </div>
      
    </main>

    <footer class="footer">
  <div class="footer-content">
    <div class="footer-left">
      
      <span class="copyright">
        &copy; 2024 - 2026 Swing
      </span>
    </div>

    <div class="footer-right">
      
        <span class="powered">
          Powered by Hexo <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a>
        </span>
      
      
        <span class="theme-info">
          Theme <a href="https://github.com/yourname/hexo-theme-Bloom" target="_blank" rel="noopener">Bloom</a>
        </span>
      
    </div>
  </div>

  
    <div class="footer-social">
      
        <a href="https://github.com/WinMin" class="social-link" target="_blank" rel="noopener" aria-label="GitHub">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
        </a>
      
      
        <a href="https://twitter.com/bestswngs" class="social-link" target="_blank" rel="noopener" aria-label="Twitter">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
        </a>
      
      
      
        <a href="mailto:ask@mail.exp.sh" class="social-link" aria-label="Email">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
        </a>
      
      
        <a href="/atom.xml" class="social-link" aria-label="RSS">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/></svg>
        </a>
      
    </div>
  
</footer>

  </div>

  <!-- Main Script -->

<script src="/js/main.js"></script>


<!-- Search -->


<script src="/js/search.js"></script>



<!-- Baidu Analytics -->


</body>
</html>
